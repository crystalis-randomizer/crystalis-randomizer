import { makeInput } from './backgroundattrs.js';
export class Screen {
    constructor(context, invert = false) {
        this.context = context;
        this.screen = 0;
        this.rom = context.rom;
        this.graphics = context.graphics;
        const el = this.el = document.createElement('div');
        const grid = this.grid = document.createElement('div');
        if (invert)
            el.appendChild(grid);
        el.appendChild(makeInput(context, [], {
            get: (_) => this.screen,
            set: (_, s) => {
                this.screen = s;
                this.redraw();
            },
        }));
        if (!invert)
            el.appendChild(grid);
        grid.classList.add('screen-grid');
        grid.addEventListener('drop', (ev) => this.handleDrop(ev));
        grid.addEventListener('dragstart', (ev) => this.handleDragStart(ev));
        grid.addEventListener('dragover', (ev) => ev.preventDefault());
        grid.addEventListener('click', (ev) => this.handleClick(ev));
        for (let i = 0; i < 240; i++) {
            const img = document.createElement('img');
            img.dataset['index'] = String(i);
            img.draggable = true;
            grid.appendChild(img);
        }
        (async () => {
            for await (const update of context.updates()) {
                if (update.graphics)
                    this.redraw();
            }
        })();
    }
    redraw() {
        const tiles = this.rom.screens[this.screen].tiles;
        const tileset = this.rom.tilesets[this.context.tileset];
        for (let i = 0; i < 240; i++) {
            let tile = tiles[i];
            if (tile < 0x20 && this.context.flag)
                tile = tileset.alternates[tile];
            let attr = tileset.attrs[tile];
            const pal = attr < 3 ? this.context.tilePalettes[attr] : 0x7f;
            this.grid.children[i].src =
                this.graphics.metatile(tile, this.context.tilePatterns, this.context.tileset, pal);
        }
        this.grid.style.background = this.graphics.paletteCss(this.context.tilePalettes[0]);
    }
    handleDragStart(ev) {
        const target = ev.target;
        if (!target.dataset['index'])
            return;
        const index = Number(target.dataset['index']);
        if (!ev.dataTransfer)
            throw new Error(`Expected data: ${ev}`);
        ev.dataTransfer.setData('application/json', JSON.stringify({
            'metatile': this.rom.screens[this.screen].tiles[index],
            'png': target.src,
        }));
    }
    handleClick(ev) {
        const json = this.context.selection;
        const target = ev.target;
        if (!target.dataset['index'])
            return;
        const index = Number(target.dataset['index']);
        if (ev.shiftKey) {
            this.context.selection = {
                'metatile': this.rom.screens[this.screen].tiles[index],
                'png': target.src,
            };
        }
        else if (json && json['metatile']) {
            this.rom.screens[this.screen].tiles[index] = json['metatile'];
            target.src = json['png'];
        }
    }
    handleDrop(ev) {
        const target = ev.target;
        if (!target.dataset['index'])
            return;
        const index = Number(target.dataset['index']);
        if (!ev.dataTransfer)
            throw new Error(`Expected data: ${ev}`);
        const json = JSON.parse(ev.dataTransfer.getData('application/json'));
        if ('metatile' in json) {
            this.rom.screens[this.screen].tiles[index] = json['metatile'];
            target.src = json['png'];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyZWVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2VkaXQvc2NyZWVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUkvQyxNQUFNLE9BQU8sTUFBTTtJQVVqQixZQUFxQixPQUFnQixFQUFFLFNBQWtCLEtBQUs7UUFBekMsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUZyQyxXQUFNLEdBQVcsQ0FBQyxDQUFDO1FBR2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7UUFDakMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2RCxJQUFJLE1BQU07WUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pDLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUU7WUFDcEMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTTtZQUN2QixHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBUyxFQUFFLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNoQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDaEIsQ0FBQztTQUNGLENBQUMsQ0FBQyxDQUFDO1FBQ0osSUFBSSxDQUFDLE1BQU07WUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxT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b20uanMnO1xuaW1wb3J0IHttYWtlSW5wdXR9IGZyb20gJy4vYmFja2dyb3VuZGF0dHJzLmpzJztcbmltcG9ydCB7Q29udGV4dH0gZnJvbSAnLi9jb250ZXh0LmpzJztcbmltcG9ydCB7R3JhcGhpY3N9IGZyb20gJy4vZ3JhcGhpY3MuanMnO1xuXG5leHBvcnQgY2xhc3MgU2NyZWVuIHtcbiAgLy8gU2VsZWN0aW9uIGNvbnRleHQgdy8gY3VycmVudCBzY3JlZW4vdGlsZXNldC9wYXR0ZXJucy9ldGM/XG5cbiAgcmVhZG9ubHkgZWw6IEhUTUxEaXZFbGVtZW50O1xuICByZWFkb25seSBncmlkOiBIVE1MRGl2RWxlbWVudDtcbiAgcmVhZG9ubHkgcm9tOiBSb207XG4gIHJlYWRvbmx5IGdyYXBoaWNzOiBHcmFwaGljcztcblxuICBzY3JlZW46IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgY29udGV4dDogQ29udGV4dCwgaW52ZXJ0OiBib29sZWFuID0gZmFsc2UpIHtcbiAgICB0aGlzLnJvbSA9IGNvbnRleHQucm9tO1xuICAgIHRoaXMuZ3JhcGhpY3MgPSBjb250ZXh0LmdyYXBoaWNzO1xuICAgIGNvbnN0IGVsID0gdGhpcy5lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdyaWQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBpZiAoaW52ZXJ0KSBlbC5hcHBlbmRDaGlsZChncmlkKTtcbiAgICBlbC5hcHBlbmRDaGlsZChtYWtlSW5wdXQoY29udGV4dCwgW10sIHtcbiAgICAgIGdldDogKF8pID0+IHRoaXMuc2NyZWVuLFxuICAgICAgc2V0OiAoXywgczogbnVtYmVyKSA9PiB7XG4gICAgICAgIHRoaXMuc2NyZWVuID0gcztcbiAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICAgIH0sXG4gICAgfSkpO1xuICAgIGlmICghaW52ZXJ0KSBlbC5hcHBlbmRDaGlsZChncmlkKTtcbiAgICBncmlkLmNsYXNzTGlzdC5hZGQoJ3NjcmVlbi1ncmlkJyk7XG4gICAgLy8gYWRkIGV2ZW50IGxpc3RlbmVyIGZvciBkcm9wIGV2ZW50c1xuICAgIGdyaWQuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIChldikgPT4gdGhpcy5oYW5kbGVEcm9wKGV2IGFzIERyYWdFdmVudCkpO1xuICAgIGdyaWQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgKGV2KSA9PiB0aGlzLmhhbmRsZURyYWdTdGFydChldiBhcyBEcmFnRXZlbnQpKTtcbiAgICBncmlkLmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdvdmVyJywgKGV2KSA9PiBldi5wcmV2ZW50RGVmYXVsdCgpKTtcbiAgICBncmlkLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2KSA9PiB0aGlzLmhhbmRsZUNsaWNrKGV2IGFzIE1vdXNlRXZlbnQpKTtcbiAgICAvLyBhZGQgMjQwIGNoaWxkcmVuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNDA7IGkrKykge1xuICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XG4gICAgICBpbWcuZGF0YXNldFsnaW5kZXgnXSA9IFN0cmluZyhpKTtcbiAgICAgIGltZy5kcmFnZ2FibGUgPSB0cnVlO1xuICAgICAgZ3JpZC5hcHBlbmRDaGlsZChpbWcpO1xuICAgIH1cbiAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgZm9yIGF3YWl0IChjb25zdCB1cGRhdGUgb2YgY29udGV4dC51cGRhdGVzKCkpIHtcbiAgICAgICAgaWYgKHVwZGF0ZS5ncmFwaGljcykgdGhpcy5yZWRyYXcoKTtcbiAgICAgIH1cbiAgICB9KSgpO1xuICB9XG5cbiAgcmVkcmF3KCkge1xuICAgIGNvbnN0IHRpbGVzID0gdGhpcy5yb20uc2NyZWVuc1t0aGlzLnNjcmVlbl0udGlsZXM7XG4gICAgY29uc3QgdGlsZXNldCA9IHRoaXMucm9tLnRpbGVzZXRzW3RoaXMuY29udGV4dC50aWxlc2V0XTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI0MDsgaSsrKSB7XG4gICAgICBsZXQgdGlsZSA9IHRpbGVzW2ldO1xuICAgICAgaWYgKHRpbGUgPCAweDIwICYmIHRoaXMuY29udGV4dC5mbGFnKSB0aWxlID0gdGlsZXNldC5hbHRlcm5hdGVzW3RpbGVdO1xuICAgICAgbGV0IGF0dHIgPSB0aWxlc2V0LmF0dHJzW3RpbGVdO1xuICAgICAgY29uc3QgcGFsID0gYXR0ciA8IDMgPyB0aGlzLmNvbnRleHQudGlsZVBhbGV0dGVzW2F0dHJdIDogMHg3ZjtcbiAgICAgICh0aGlzLmdyaWQuY2hpbGRyZW5baV0gYXMgSFRNTEltYWdlRWxlbWVudCkuc3JjID1cbiAgICAgICAgICB0aGlzLmdyYXBoaWNzLm1ldGF0aWxlKHRpbGUsIHRoaXMuY29udGV4dC50aWxlUGF0dGVybnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQudGlsZXNldCwgcGFsKTtcbiAgICB9XG4gICAgdGhpcy5ncmlkLnN0eWxlLmJhY2tncm91bmQgPSB0aGlzLmdyYXBoaWNzLnBhbGV0dGVDc3ModGhpcy5jb250ZXh0LnRpbGVQYWxldHRlc1swXSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZURyYWdTdGFydChldjogRHJhZ0V2ZW50KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gZXYudGFyZ2V0IGFzIEhUTUxJbWFnZUVsZW1lbnQ7XG4gICAgaWYgKCF0YXJnZXQuZGF0YXNldFsnaW5kZXgnXSkgcmV0dXJuO1xuICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKHRhcmdldC5kYXRhc2V0WydpbmRleCddKTtcbiAgICBpZiAoIWV2LmRhdGFUcmFuc2ZlcikgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBkYXRhOiAke2V2fWApO1xuICAgIGV2LmRhdGFUcmFuc2Zlci5zZXREYXRhKCdhcHBsaWNhdGlvbi9qc29uJywgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgJ21ldGF0aWxlJzogdGhpcy5yb20uc2NyZWVuc1t0aGlzLnNjcmVlbl0udGlsZXNbaW5kZXhdLFxuICAgICAgJ3BuZyc6IHRhcmdldC5zcmMsXG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVDbGljayhldjogTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGpzb246IGFueSA9IHRoaXMuY29udGV4dC5zZWxlY3Rpb247XG4gICAgY29uc3QgdGFyZ2V0ID0gZXYudGFyZ2V0IGFzIEhUTUxJbWFnZUVsZW1lbnQ7XG4gICAgaWYgKCF0YXJnZXQuZGF0YXNldFsnaW5kZXgnXSkgcmV0dXJuO1xuICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKHRhcmdldC5kYXRhc2V0WydpbmRleCddKTtcbiAgICBpZiAoZXYuc2hpZnRLZXkpIHtcbiAgICAgIHRoaXMuY29udGV4dC5zZWxlY3Rpb24gPSB7XG4gICAgICAgICdtZXRhdGlsZSc6IHRoaXMucm9tLnNjcmVlbnNbdGhpcy5zY3JlZW5dLnRpbGVzW2luZGV4XSxcbiAgICAgICAgJ3BuZyc6IHRhcmdldC5zcmMsXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAoanNvbiAmJiBqc29uWydtZXRhdGlsZSddKSB7XG4gICAgICB0aGlzLnJvbS5zY3JlZW5zW3RoaXMuc2NyZWVuXS50aWxlc1tpbmRleF0gPSBqc29uWydtZXRhdGlsZSddO1xuICAgICAgdGFyZ2V0LnNyYyA9IGpzb25bJ3BuZyddO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRHJvcChldjogRHJhZ0V2ZW50KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gZXYudGFyZ2V0IGFzIEhUTUxJbWFnZUVsZW1lbnQ7XG4gICAgaWYgKCF0YXJnZXQuZGF0YXNldFsnaW5kZXgnXSkgcmV0dXJuO1xuICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKHRhcmdldC5kYXRhc2V0WydpbmRleCddKTtcbiAgICBpZiAoIWV2LmRhdGFUcmFuc2ZlcikgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBkYXRhOiAke2V2fWApO1xuICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGV2LmRhdGFUcmFuc2Zlci5nZXREYXRhKCdhcHBsaWNhdGlvbi9qc29uJykpO1xuICAgIGlmICgnbWV0YXRpbGUnIGluIGpzb24pIHtcbiAgICAgIC8vIEZpZ3VyZSBvdXQgd2hpY2ggbWFwIHRpbGUgd2UncmUgaW4uXG4gICAgICB0aGlzLnJvbS5zY3JlZW5zW3RoaXMuc2NyZWVuXS50aWxlc1tpbmRleF0gPSBqc29uWydtZXRhdGlsZSddO1xuICAgICAgdGFyZ2V0LnNyYyA9IGpzb25bJ3BuZyddO1xuICAgIH1cbiAgfVxufVxuIl19