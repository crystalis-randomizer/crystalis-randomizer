import { Monogrid } from './monogrid.js';
import { Metalocation } from '../rom/metalocation.js';
import { CaveShuffle } from './cave.js';
import { OK } from './maze.js';
import { seq } from '../rom/util.js';
import { ScreenFix } from '../rom/screenfix.js';
export class SwampShuffle extends CaveShuffle {
    build() {
        var _a, _b, _c;
        const { h, w } = this;
        const rom = this.orig.rom;
        const g = new Monogrid(h, w);
        g.fill();
        const arenaY = h * w < 28 ? 0 : this.random.nextInt(h - 1);
        const arenaX = this.random.nextInt(w);
        const fixed = new Set();
        function del(y, x) {
            g.delete2(y, x);
            fixed.add(y * g.w + x);
        }
        function isDoor(type) {
            return !type.startsWith('edge');
        }
        fixed.add(arenaY * g.w + arenaX);
        if (arenaX)
            del(arenaY, arenaX - 1);
        if (arenaX < g.w - 1)
            del(arenaY, arenaX + 1);
        if (arenaY) {
            del(arenaY - 1, arenaX);
            if (arenaX)
                del(arenaY - 1, arenaX - 1);
            if (arenaX < g.w - 1)
                del(arenaY - 1, arenaX + 1);
        }
        for (const i of fixed) {
            g.fixed.add(i);
        }
        const edgePos = new Set();
        for (let dir = 0; dir < 4; dir++) {
            const max = dir & 1 ? h : w;
            const nums = this.random.shuffle(seq(max));
            const opp = dir & 2 ? max : 0;
            let count = (_b = (_a = this.params.edges) === null || _a === void 0 ? void 0 : _a[dir]) !== null && _b !== void 0 ? _b : 0;
            while (count && nums.length) {
                const y = dir & 1 ? nums.pop() : opp;
                const x = dir & 1 ? opp : nums.pop();
                const i = y * g.w + x;
                if (!g.data[i] || g.fixed.has(i))
                    continue;
                g.addEdge(y, x, dir);
                edgePos.add(y << 4 | x);
                count--;
            }
            if (count)
                return { ok: false, fail: `could not add all edges: ${dir} ${count}\n${g.toGrid('c').show()}\n${g.data}` };
        }
        let deleted = 0;
        const target = g.h * g.w * (this.random.next() * 0.15 + 0.4);
        for (const posDir of this.random.ishuffle(seq(g.data.length << 2))) {
            const i = posDir >>> 2;
            const dir = posDir & 3;
            if (!g.isBorder(i, dir) && g.deleteEdge(i, dir)) {
                if (++deleted >= target)
                    break;
            }
        }
        const allocd = new Set();
        const unallocd = new Set();
        const plain = [];
        const doors = [];
        let arena;
        for (const s of this.orig.tileset) {
            if (s.hasFeature('arena')) {
                arena = s;
                continue;
            }
            else if (s.hasFeature('empty')) {
                plain[0] = s;
                continue;
            }
            const edgeIndex = s.edgeIndex('s');
            if (edgeIndex == null)
                throw new Error(`bad edges`);
            const hasDoor = (_c = s.data.exits) === null || _c === void 0 ? void 0 : _c.some(e => isDoor(e.type));
            (hasDoor ? doors : plain)[edgeIndex] = s;
            (s.sid < 0 ? unallocd : allocd).add(s.sid);
        }
        if (!arena)
            throw new Error(`never found arena`);
        const consolidate = g.consolidate(this.random, allocd.size);
        const used = new Set(consolidate.map(e => plain[e].sid));
        if (!used.size)
            return { ok: false, fail: `consolidate failed` };
        const newlyUsed = [...unallocd].filter(e => used.has(e));
        const newlyUnused = [...allocd].filter(e => !used.has(e));
        if (newlyUsed.length > newlyUnused.length)
            throw new Error(`out of space`);
        if (newlyUsed.length) {
            let unusedId = -1;
            while (rom.metascreens.getById(unusedId).length)
                unusedId--;
            const origUnusedId = unusedId;
            for (let i = 0; i < newlyUsed.length; i++) {
                rom.metascreens.renumber(newlyUnused[i], unusedId);
                rom.metascreens.renumber(newlyUsed[i], newlyUnused[i]);
                unusedId = newlyUsed[i];
            }
            rom.metascreens.renumber(origUnusedId, newlyUsed[newlyUsed.length - 1]);
        }
        const meta = new Metalocation(this.orig.id, this.orig.tileset, h, w);
        for (let y = 0; y < g.h; y++) {
            for (let x = 0; x < g.w; x++) {
                const isArena = y === arenaY && x === arenaX;
                meta.set(y << 4 | x, isArena ? arena : plain[g.data[y * g.w + x]]);
            }
        }
        let doorCount = [...this.orig.exits()].filter(e => isDoor(e[1])).length;
        for (const pos of this.random.ishuffle(meta.allPos())) {
            if (!doorCount)
                break;
            if (edgePos.has(pos))
                continue;
            const x = pos & 0xf;
            const y = pos >>> 4;
            const door = doors[g.data[y * g.w + x]];
            if (!door)
                continue;
            meta.set(pos, door);
            doorCount--;
        }
        if (doorCount)
            return { ok: false, fail: `could not place all doors` };
        return OK;
    }
}
export function addSwampDoors(rom) {
    const { swamp } = rom.metatilesets;
    const $ = rom.metascreens;
    const tiles = [
        [0x03, 0xda, 0xac],
        [0x04, 0xe4, 0xaa],
        [0x05, 0xe5, 0xaa],
        [0x06, 0xe6, 0xaa],
        [0x07, 0xe7, 0xaa],
        [0x08, 0xf0, 0xaa],
        [0x09, 0xf1, 0xaa],
        [0x0a, 0xf2, 0xaa],
        [0x0b, 0xf3, 0xaa],
        [0x0c, 0xdc, 0xaa],
        [0x0d, 0xdd, 0xaa],
    ];
    for (const [tile, src, alt] of tiles) {
        swamp.getTile(tile).copyFrom(src).setAlternative(alt);
    }
    $.swampEmpty.screen.set2d(0x00, [
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xe2],
        [0xe2, 0xc8],
    ]);
    $.swampE.screen.set2d(0x4c, [
        [0x08, 0x09],
        [0x0c, 0x0b],
        [0x03, 0x03],
    ]);
    $.swampWSE.screen.set2d(0x25, [
        [, , 0x04],
        [0x08, 0x09, 0x05],
        [, 0x0a, 0x06],
        [, 0x0b, 0x07],
        [, 0x03, 0x03],
    ]);
    $.swampW.screen.set2d(0x24, [
        [0x04],
        [],
        [0x06],
        [0x07, 0x0d],
        [0x03, 0x03],
    ]);
    $.swampWS.screen.set2d(0x47, [
        [0x08, 0x09],
        [0x0c, 0x0b],
        [0x03, 0x03],
    ]);
    $.registerFix(ScreenFix.SwampDoors, 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dhbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbWF6ZS9zd2FtcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQU8sTUFBTSx3QkFBd0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxFQUFFLEVBQVUsTUFBTSxXQUFXLENBQUM7QUFDdkMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVoRCxNQUFNLE9BQU8sWUFBYSxTQUFRLFdBQVc7SUFFM0MsS0FBSzs7UUFDSCxNQUFNLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBQyxHQUFHLElBQUksQ0FBQztRQUNwQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUMxQixNQUFNLENBQUMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRVQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDaEMsU0FBUyxHQUFHLENBQUMsQ0FBUyxFQUFFLENBQVM7WUFDL0IsQ0FBQyxDQUFDLE9BQU8s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QztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztLQUNiLENBQUMsQ0FBQztJQUVILENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDNUIsQ0FBSyxBQUFKLEVBQVUsQUFBTCxFQUFPLElBQUksQ0FBQztRQUNsQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDO1FBQ2xCLENBQUssQUFBSixFQUFNLElBQUksRUFBRSxJQUFJLENBQUM7UUFDbEIsQ0FBSyxBQUFKLEVBQU0sSUFBSSxFQUFFLElBQUksQ0FBQztRQUNsQixDQUFLLEFBQUosRUFBTSxJQUFJLEVBQUUsSUFBSSxDQUFDO0tBQ25CLENBQUMsQ0FBQztJQUVILENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDMUIsQ0FBQyxJQUFJLENBQU87UUFDWixFQUFZO1FBQ1osQ0FBQyxJQUFJLENBQU87UUFDWixDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7UUFDWixDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7S0FDYixDQUFDLENBQUM7SUFFSCxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQzNCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztLQUNiLENBQUMsQ0FBQztJQUVILENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQW1CLENBQUM7QUFDM0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vbm9ncmlkIH0gZnJvbSAnLi9tb25vZ3JpZC5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgQ2F2ZVNodWZmbGUgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgT0ssIFJlc3VsdCB9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQgeyBzZXEgfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQgeyBNZXRhc2NyZWVuIH0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW4uanMnO1xuaW1wb3J0IHsgUm9tIH0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7IFNjcmVlbkZpeCB9IGZyb20gJy4uL3JvbS9zY3JlZW5maXguanMnO1xuXG5leHBvcnQgY2xhc3MgU3dhbXBTaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuXG4gIGJ1aWxkKCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3Qge2gsIHd9ID0gdGhpcztcbiAgICBjb25zdCByb20gPSB0aGlzLm9yaWcucm9tO1xuICAgIGNvbnN0IGcgPSBuZXcgTW9ub2dyaWQoaCwgdyk7XG4gICAgZy5maWxsKCk7XG4gICAgLy8gQWRkIGFyZW5hIChUT0RPIC0gY29uc2lkZXIgY29uZGl0aW9uICh0aGlzLnJhbmRvbS5uZXh0SW50KDQpKVxuICAgIGNvbnN0IGFyZW5hWSA9IGggKiB3IDwgMjggPyAwIDogdGhpcy5yYW5kb20ubmV4dEludChoIC0gMSk7XG4gICAgY29uc3QgYXJlbmFYID0gdGhpcy5yYW5kb20ubmV4dEludCh3KTtcbiAgICBjb25zdCBmaXhlZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZ1bmN0aW9uIGRlbCh5OiBudW1iZXIsIHg6IG51bWJlcikge1xuICAgICAgZy5kZWxldGUyKHksIHgpO1xuICAgICAgZml4ZWQuYWRkKHkgKiBnLncgKyB4KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gaXNEb29yKHR5cGU6IHN0cmluZykge1xuICAgICAgcmV0dXJuICF0eXBlLnN0YXJ0c1dpdGgoJ2VkZ2UnKTtcbiAgICB9XG4gICAgZml4ZWQuYWRkKGFyZW5hWSAqIGcudyArIGFyZW5hWCk7XG4gICAgaWYgKGFyZW5hWCkgZGVsKGFyZW5hWSwgYXJlbmFYIC0gMSk7XG4gICAgaWYgKGFyZW5hWCA8IGcudyAtIDEpIGRlbChhcmVuYVksIGFyZW5hWCArIDEpO1xuICAgIGlmIChhcmVuYVkpIHtcbiAgICAgIGRlbChhcmVuYVkgLSAxLCBhcmVuYVgpO1xuICAgICAgaWYgKGFyZW5hWCkgZGVsKGFyZW5hWSAtIDEsIGFyZW5hWCAtIDEpO1xuICAgICAgaWYgKGFyZW5hWCA8IGcudyAtIDEpIGRlbChhcmVuYVkgLSAxLCBhcmVuYVggKyAxKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBpIG9mIGZpeGVkKSB7XG4gICAgICBnLmZpeGVkLmFkZChpKTtcbiAgICB9XG5cbiAgICAvLyBBZGQgZWRnZSBleGl0cy5cbiAgICBjb25zdCBlZGdlUG9zID0gbmV3IFNldDxQb3M+KCk7XG4gICAgZm9yIChsZXQgZGlyID0gMDsgZGlyIDwgNDsgZGlyKyspIHtcbiAgICAgIGNvbnN0IG1heCA9IGRpciAmIDEgPyBoIDogdztcbiAgICAgIGNvbnN0IG51bXMgPSB0aGlzLnJhbmRvbS5zaHVmZmxlKHNlcShtYXgpKTtcbiAgICAgIGNvbnN0IG9wcCA9IGRpciAmIDIgPyBtYXggOiAwO1xuICAgICAgbGV0IGNvdW50ID0gdGhpcy5wYXJhbXMuZWRnZXM/LltkaXJdID8/IDA7XG4gICAgICB3aGlsZSAoY291bnQgJiYgbnVtcy5sZW5ndGgpIHtcbiAgICAgICAgY29uc3QgeSA9IGRpciAmIDEgPyBudW1zLnBvcCgpISA6IG9wcDtcbiAgICAgICAgY29uc3QgeCA9IGRpciAmIDEgPyBvcHAgOiBudW1zLnBvcCgpITtcbiAgICAgICAgY29uc3QgaSA9IHkgKiBnLncgKyB4O1xuICAgICAgICBpZiAoIWcuZGF0YVtpXSB8fCBnLmZpeGVkLmhhcyhpKSkgY29udGludWU7XG4gICAgICAgIGcuYWRkRWRnZSh5LCB4LCBkaXIpO1xuICAgICAgICBlZGdlUG9zLmFkZCh5IDw8IDQgfCB4KTtcbiAgICAgICAgY291bnQtLTtcbiAgICAgIH1cbiAgICAgIGlmIChjb3VudCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgYWRkIGFsbCBlZGdlczogJHtkaXJ9ICR7Y291bnR9XFxuJHtnLnRvR3JpZCgnYycpLnNob3coKX1cXG4ke2cuZGF0YX1gfTtcbiAgICB9XG4gICAgLy9jb25zb2xlLmxvZyhnLnRvR3JpZCgnYycpLnNob3coKSk7IC8vIFRPRE8gLSB3aHkgaXMgZWRnZSBleGl0IGRpc2FwcGVhcmluZz8hP1xuXG4gICAgLy8gRGVsZXRlIGVkZ2VzXG4gICAgLy8gTk9URTogbWF5IHdhbnQgbXVsdGlwbGUgcGFzc2VzIGJlY2F1c2UgZWFybGllciBkZWxldGVzXG4gICAgLy8gY291bGQgZW5hYmxlIGxhdGVyIGRlbGV0ZXM/XG4gICAgLy8gU2hvb3QgZm9yIGRlbGV0aW5nIGFueXdoZXJlIGZyb20gMC40KmgqdyB0byAwLjU1KmgqdyBvZiB0aGUgZWRnZXMuXG4gICAgbGV0IGRlbGV0ZWQgPSAwO1xuICAgIGNvbnN0IHRhcmdldCA9IGcuaCAqIGcudyAqICh0aGlzLnJhbmRvbS5uZXh0KCkgKiAwLjE1ICsgMC40KTtcbiAgICBmb3IgKGNvbnN0IHBvc0RpciBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShzZXEoZy5kYXRhLmxlbmd0aCA8PCAyKSkpIHtcbiAgICAgIGNvbnN0IGkgPSBwb3NEaXIgPj4+IDI7XG4gICAgICBjb25zdCBkaXIgPSBwb3NEaXIgJiAzO1xuICAgICAgaWYgKCFnLmlzQm9yZGVyKGksIGRpcikgJiYgZy5kZWxldGVFZGdlKGksIGRpcikpIHtcbiAgICAgICAgaWYgKCsrZGVsZXRlZCA+PSB0YXJnZXQpIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbnNvbGlkYXRlLiAgVE9ETyAtIHJlY29nbml6ZSBjb3JyZWN0IGNvdW50IVxuICAgIC8vIE5PVEU6IHJvbS5tb3ZlU2NyZWVucygpIGNvdWxkIGhhdmUgYmVlbiB1c2VkIHRvIG1vdmUgdGhlIHN3YW1wIHRvXG4gICAgLy8gYSBtb3JlIGZyZWUgcGxhbmUuICBJZiBzbywgd2UgZG9uJ3QgbmVlZCB0byBjb25zb2xpZGF0ZSBhdCBhbGxcbiAgICAvLyBhbmQgYWxsIHRoZSBzY3JlZW5zJyBzaWRzIHdpbGwgYmUgcG9zaXRpdmUuICBGaW5kIG91dCBob3cgbWFueVxuICAgIC8vIG5vbi1lbXB0eSwgbm9uLWFyZW5hIHNjcmVlbnMgaW4gdGhlIHRpbGVzZXQgaGF2ZSBkaWZmZXJlbnQgcG9zaXRpdmVcbiAgICAvLyBvciBuZWdhdGl2ZSBJRHMsIGFuZCBncm91cCB0aGUgbm9uLWRvb3Igb25lcyBieSBlZGdlIHByb2ZpbGUuXG4gICAgY29uc3QgYWxsb2NkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgdW5hbGxvY2QgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCBwbGFpbjogTWV0YXNjcmVlbltdID0gW107XG4gICAgY29uc3QgZG9vcnM6IE1ldGFzY3JlZW5bXSA9IFtdO1xuICAgIGxldCBhcmVuYTogTWV0YXNjcmVlbnx1bmRlZmluZWQ7XG4gICAgZm9yIChjb25zdCBzIG9mIHRoaXMub3JpZy50aWxlc2V0KSB7XG4gICAgICBpZiAocy5oYXNGZWF0dXJlKCdhcmVuYScpKSB7XG4gICAgICAgIGFyZW5hID0gcztcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2UgaWYgKHMuaGFzRmVhdHVyZSgnZW1wdHknKSkge1xuICAgICAgICBwbGFpblswXSA9IHM7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgZWRnZUluZGV4ID0gcy5lZGdlSW5kZXgoJ3MnKTtcbiAgICAgIGlmIChlZGdlSW5kZXggPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBiYWQgZWRnZXNgKTtcbiAgICAgIGNvbnN0IGhhc0Rvb3IgPSBzLmRhdGEuZXhpdHM/LnNvbWUoZSA9PiBpc0Rvb3IoZS50eXBlKSk7XG4gICAgICAoaGFzRG9vciA/IGRvb3JzIDogcGxhaW4pW2VkZ2VJbmRleF0gPSBzO1xuICAgICAgKHMuc2lkIDwgMCA/IHVuYWxsb2NkIDogYWxsb2NkKS5hZGQocy5zaWQpO1xuICAgIH1cbiAgICBpZiAoIWFyZW5hKSB0aHJvdyBuZXcgRXJyb3IoYG5ldmVyIGZvdW5kIGFyZW5hYCk7XG5cbiAgICBjb25zdCBjb25zb2xpZGF0ZSA9IGcuY29uc29saWRhdGUodGhpcy5yYW5kb20sIGFsbG9jZC5zaXplKTtcbiAgICBjb25zdCB1c2VkID0gbmV3IFNldChjb25zb2xpZGF0ZS5tYXAoZSA9PiBwbGFpbltlXS5zaWQpKTtcbiAgICBpZiAoIXVzZWQuc2l6ZSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb25zb2xpZGF0ZSBmYWlsZWRgfTtcbiAgICBjb25zdCBuZXdseVVzZWQgPSBbLi4udW5hbGxvY2RdLmZpbHRlcihlID0+IHVzZWQuaGFzKGUpKTtcbiAgICBjb25zdCBuZXdseVVudXNlZCA9IFsuLi5hbGxvY2RdLmZpbHRlcihlID0+ICF1c2VkLmhhcyhlKSk7XG4gICAgaWYgKG5ld2x5VXNlZC5sZW5ndGggPiBuZXdseVVudXNlZC5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihgb3V0IG9mIHNwYWNlYCk7XG5cbiAgICBpZiAobmV3bHlVc2VkLmxlbmd0aCkge1xuICAgICAgLy8gRmluZCBhbiBhdmFpbGFibGUgc2lkIHRvIHN3YXAgb3V0IHdpdGguICBDeWNsZSBldmVyeXRoaW5nIHRocm91Z2guXG4gICAgICBsZXQgdW51c2VkSWQgPSAtMTtcbiAgICAgIHdoaWxlIChyb20ubWV0YXNjcmVlbnMuZ2V0QnlJZCh1bnVzZWRJZCkubGVuZ3RoKSB1bnVzZWRJZC0tO1xuICAgICAgY29uc3Qgb3JpZ1VudXNlZElkID0gdW51c2VkSWQ7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5ld2x5VXNlZC5sZW5ndGg7IGkrKykge1xuICAgICAgICByb20ubWV0YXNjcmVlbnMucmVudW1iZXIobmV3bHlVbnVzZWRbaV0sIHVudXNlZElkKTtcbiAgICAgICAgcm9tLm1ldGFzY3JlZW5zLnJlbnVtYmVyKG5ld2x5VXNlZFtpXSwgbmV3bHlVbnVzZWRbaV0pO1xuICAgICAgICB1bnVzZWRJZCA9IG5ld2x5VXNlZFtpXTtcbiAgICAgIH1cbiAgICAgIHJvbS5tZXRhc2NyZWVucy5yZW51bWJlcihvcmlnVW51c2VkSWQsIG5ld2x5VXNlZFtuZXdseVVzZWQubGVuZ3RoIC0gMV0pO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldGEgPSBuZXcgTWV0YWxvY2F0aW9uKHRoaXMub3JpZy5pZCwgdGhpcy5vcmlnLnRpbGVzZXQsIGgsIHcpO1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgZy5oOyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgZy53OyB4KyspIHtcbiAgICAgICAgY29uc3QgaXNBcmVuYSA9IHkgPT09IGFyZW5hWSAmJiB4ID09PSBhcmVuYVg7XG4gICAgICAgIG1ldGEuc2V0KHkgPDwgNCB8IHgsIGlzQXJlbmEgPyBhcmVuYSA6IHBsYWluW2cuZGF0YVt5ICogZy53ICsgeF1dKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQaWNrIGEgbG9jYXRpb24gZm9yIHRoZSBkb29yKHMpLlxuICAgIGxldCBkb29yQ291bnQgPSBbLi4udGhpcy5vcmlnLmV4aXRzKCldLmZpbHRlcihlID0+IGlzRG9vcihlWzFdKSkubGVuZ3RoO1xuICAgIGZvciAoY29uc3QgcG9zIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKG1ldGEuYWxsUG9zKCkpKSB7XG4gICAgICBpZiAoIWRvb3JDb3VudCkgYnJlYWs7XG4gICAgICBpZiAoZWRnZVBvcy5oYXMocG9zKSkgY29udGludWU7XG4gICAgICBjb25zdCB4ID0gcG9zICYgMHhmO1xuICAgICAgY29uc3QgeSA9IHBvcyA+Pj4gNDtcbiAgICAgIGNvbnN0IGRvb3IgPSBkb29yc1tnLmRhdGFbeSAqIGcudyArIHhdXTtcbiAgICAgIGlmICghZG9vcikgY29udGludWU7XG4gICAgICBtZXRhLnNldChwb3MsIGRvb3IpO1xuICAgICAgZG9vckNvdW50LS07XG4gICAgfVxuICAgIGlmIChkb29yQ291bnQpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IHBsYWNlIGFsbCBkb29yc2B9O1xuICAgIHJldHVybiBPSztcbiAgfVxufVxuXG4vKiogQXBwbHkgdGhlIFNjcmVlbkZpeC5Td2FtcERvb3JzLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGFkZFN3YW1wRG9vcnMocm9tOiBSb20pIHtcbiAgY29uc3Qge3N3YW1wfSA9IHJvbS5tZXRhdGlsZXNldHM7XG4gIGNvbnN0ICQgPSByb20ubWV0YXNjcmVlbnM7XG5cbiAgLy8gTWFrZSBhIGhhbmRmdWwgb2YgcmVtb3ZhYmxlIHRpbGVzIC0gZGVmYXVsdHMgdG8gQ0xPU0VEIVxuICBjb25zdCB0aWxlcyA9IFtcbiAgICBbMHgwMywgMHhkYSwgMHhhY10sXG4gICAgWzB4MDQsIDB4ZTQsIDB4YWFdLFxuICAgIFsweDA1LCAweGU1LCAweGFhXSxcbiAgICBbMHgwNiwgMHhlNiwgMHhhYV0sXG4gICAgWzB4MDcsIDB4ZTcsIDB4YWFdLFxuICAgIFsweDA4LCAweGYwLCAweGFhXSxcbiAgICBbMHgwOSwgMHhmMSwgMHhhYV0sXG4gICAgWzB4MGEsIDB4ZjIsIDB4YWFdLFxuICAgIFsweDBiLCAweGYzLCAweGFhXSxcbiAgICBbMHgwYywgMHhkYywgMHhhYV0sXG4gICAgWzB4MGQsIDB4ZGQsIDB4YWFdLFxuICBdO1xuICAvL2NvbnN0IHNjcmVlbnMgPSBbLi4uc3dhbXBdLmZpbHRlcihzID0+IHMuc2lkID49IDApO1xuICBmb3IgKGNvbnN0IFt0aWxlLCBzcmMsIGFsdF0gb2YgdGlsZXMpIHtcbiAgICBzd2FtcC5nZXRUaWxlKHRpbGUpLmNvcHlGcm9tKHNyYykuc2V0QWx0ZXJuYXRpdmUoYWx0KTtcbiAgICAgIC8vLnJlcGxhY2VJbiguLi5zY3JlZW5zKTtcbiAgfVxuXG4gIC8vIEZpeCBhIGZldyBzY3JlZW5zLlxuICAkLnN3YW1wRW1wdHkuc2NyZWVuLnNldDJkKDB4MDAsIFsgLy8gYWRkIGxlZnQgY29sdW1uXG4gICAgWzB4YTgsIDB4Y2NdLCAvLyAwXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGE4LCAweGNjXSxcbiAgICBbMHhhOCwgMHhjY10sXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGE4LCAweGNjXSxcbiAgICBbMHhhOCwgMHhjY10sXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGE4LCAweGNjXSxcbiAgICBbMHhkMiwgMHhjY10sIC8vIDlcbiAgICBbMHhkMiwgMHhjY10sXG4gICAgWzB4ZDIsIDB4Y2NdLFxuICAgIFsweGQyLCAweGUyXSwgLy8gY1xuICAgIFsweGUyLCAweGM4XSwgLy8gZFxuICBdKTtcblxuICAkLnN3YW1wRS5zY3JlZW4uc2V0MmQoMHg0YywgWyAvLyBhZGQgb3B0aW9uYWwgZG9vclxuICAgIFsweDA4LCAweDA5XSwgLy8gZjAgZjFcbiAgICBbMHgwYywgMHgwYl0sIC8vIGRjIGYzXG4gICAgWzB4MDMsIDB4MDNdLCAvLyBkYSBkYVxuICBdKTtcblxuICAkLnN3YW1wV1NFLnNjcmVlbi5zZXQyZCgweDI1LCBbIC8vIGFkZCBhbiBvcHRpb25hbCBkb29yXG4gICAgWyAgICAsICAgICAsIDB4MDRdLCAvLyAgICAgICBlNFxuICAgIFsweDA4LCAweDA5LCAweDA1XSwgLy8gZjAgZjEgZTVcbiAgICBbICAgICwgMHgwYSwgMHgwNl0sIC8vICAgIGYyIGU2XG4gICAgWyAgICAsIDB4MGIsIDB4MDddLCAvLyAgICBmMyBlN1xuICAgIFsgICAgLCAweDAzLCAweDAzXSwgLy8gICAgZGEgZGFcbiAgXSk7XG5cbiAgJC5zd2FtcFcuc2NyZWVuLnNldDJkKDB4MjQsIFsgLy8gYWRkIG9wdGlvbmFsIGRvb3JcbiAgICBbMHgwNCAgICAgIF0sIC8vIGU0XG4gICAgWyAgICAgICAgICBdLCAvL1xuICAgIFsweDA2ICAgICAgXSwgLy8gZTZcbiAgICBbMHgwNywgMHgwZF0sIC8vIGU3IGRkXG4gICAgWzB4MDMsIDB4MDNdLCAvLyBkYSBkYVxuICBdKTtcblxuICAkLnN3YW1wV1Muc2NyZWVuLnNldDJkKDB4NDcsIFsgLy8gZXhpc3RpbmcgZG9vciBvcHRpb25hbFxuICAgIFsweDA4LCAweDA5XSwgLy8gZjAgZjFcbiAgICBbMHgwYywgMHgwYl0sIC8vIGRjIGYzXG4gICAgWzB4MDMsIDB4MDNdLCAvLyBkYSBkYVxuICBdKTtcblxuICAkLnJlZ2lzdGVyRml4KFNjcmVlbkZpeC5Td2FtcERvb3JzLCAwIC8qIHVudXNlZCBzZWVkICovKTtcbn1cbiJdfQ==