import { Entity } from './entity.js';
import { hex, readLittleEndian, seq, tuple } from './util.js';
const METASPRITE_TABLE = 0x3845c;
export class Metasprite extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.mirrored = null;
        this.pointer = METASPRITE_TABLE + (this.id << 1);
        this.base = readLittleEndian(rom.prg, this.pointer) + 0x30000;
        this.used = this.base >= 0x38000;
        if (rom.prg[this.base] === 0xff) {
            const target = readLittleEndian(rom.prg, this.base + 1);
            for (let i = 0; i < 256; i++) {
                if (readLittleEndian(rom.prg, METASPRITE_TABLE + (i << 1)) === target) {
                    this.mirrored = i;
                    break;
                }
            }
            if (this.mirrored == null) {
                throw new Error(`could not find mirrored sprite for ${hex(id)}: ${hex(target)}`);
            }
            this.size = 0;
            this.frameMask = 0;
            this.frames = 0;
            this.sprites = [];
        }
        else {
            this.mirrored = null;
            this.size = rom.prg[this.base];
            this.frameMask = rom.prg[this.base + 1];
            this.frames = this.frameMask + 1;
            this.sprites = seq(this.frames, f => {
                const a = this.base + 2 + f * 4 * this.size;
                const sprites = [];
                for (let i = 0; i < this.size; i++) {
                    if (rom.prg[a + 4 * i] === 0x80)
                        break;
                    sprites.push(tuple(rom.prg, a + 4 * i, 4));
                }
                return sprites;
            });
        }
    }
    patternBanks(offset = 0) {
        if (!this.used)
            return [];
        let ms = this;
        if (ms.mirrored) {
            ms = this.rom.metasprites[ms.mirrored];
        }
        const pats = new Set();
        for (const version of ms.sprites) {
            for (const [dx, , , pat] of version) {
                if (dx === 0x80)
                    break;
                pats.add(((pat + offset) >>> 6) & 0xff);
            }
        }
        return [...pats];
    }
    palettes() {
        if (!this.used)
            return [];
        let ms = this;
        if (ms.mirrored) {
            ms = this.rom.metasprites[ms.mirrored];
        }
        const pals = new Set();
        for (const version of ms.sprites) {
            for (const [dx, , attr] of version) {
                if (dx === 0x80)
                    break;
                pals.add(attr & 3);
            }
        }
        return [...pals];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXNwcml0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vbWV0YXNwcml0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUc1RCxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztBQUtqQyxNQUFNLE9BQU8sVUFBVyxTQUFRLE1BQU07SUFZcEMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUM5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBUmpCLGFBQVEsR0FBa0IsSUFBSSxDQUFDO1FBVTdCLElBQUksQ0FBQyxPQUFPLEdBQUcsZ0JBQWdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzlELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUM7UUFFakMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFFL0IsTUFBTSxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3hELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzVCLElBQUksZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsR0FB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QUM7UUFDMUIsSUFBSSxFQUFFLEdBQWUsSUFBSSxDQUFDO1FBQzFCLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUNmLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDeEM7UUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQy9CLEtBQUssTUFBTSxPQUFPLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRTtZQUNoQyxLQUFLLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQUFBRCxFQUFHLElBQUksQ0FBQyxJQUFJLE9BQU8sRUFBRTtnQkFDbEMsSUFBSSxFQUFFLEtBQUssSUFBSTtvQkFBRSxNQUFNO2dCQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNwQjtTQUNGO1FBQ0QsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDbkIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFbnRpdHl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7aGV4LCByZWFkTGl0dGxlRW5kaWFuLCBzZXEsIHR1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5cbmNvbnN0IE1FVEFTUFJJVEVfVEFCTEUgPSAweDM4NDVjO1xuXG4vLyBbZHgsIGR5LCBhdHRyaWJ1dGVzLCBwYXR0ZXJuIGlkXVxudHlwZSBTcHJpdGUgPSBbbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXTtcblxuZXhwb3J0IGNsYXNzIE1ldGFzcHJpdGUgZXh0ZW5kcyBFbnRpdHkge1xuXG4gIHBvaW50ZXI6IG51bWJlcjtcbiAgYmFzZTogbnVtYmVyO1xuICB1c2VkOiBib29sZWFuO1xuICBtaXJyb3JlZDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIHNpemU6IG51bWJlcjtcbiAgZnJhbWVNYXNrOiBudW1iZXI7XG4gIGZyYW1lczogbnVtYmVyO1xuICAvLyBgc2l6ZWAgc3ByaXRlcyBmb3IgZWFjaCBmcmFtZVxuICBzcHJpdGVzOiBTcHJpdGVbXVtdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG5cbiAgICB0aGlzLnBvaW50ZXIgPSBNRVRBU1BSSVRFX1RBQkxFICsgKHRoaXMuaWQgPDwgMSk7XG4gICAgdGhpcy5iYXNlID0gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCB0aGlzLnBvaW50ZXIpICsgMHgzMDAwMDtcbiAgICB0aGlzLnVzZWQgPSB0aGlzLmJhc2UgPj0gMHgzODAwMDtcblxuICAgIGlmIChyb20ucHJnW3RoaXMuYmFzZV0gPT09IDB4ZmYpIHtcbiAgICAgIC8vIGZpbmQgdGhlIElEIG9mIHRoZSBzcHJpdGUgdGhhdCdzIG1pcnJvcmVkLlxuICAgICAgY29uc3QgdGFyZ2V0ID0gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCB0aGlzLmJhc2UgKyAxKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjU2OyBpKyspIHtcbiAgICAgICAgaWYgKHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZywgTUVUQVNQUklURV9UQUJMRSArIChpIDw8IDEpKSA9PT0gdGFyZ2V0KSB7XG4gICAgICAgICAgdGhpcy5taXJyb3JlZCA9IGk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm1pcnJvcmVkID09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBjb3VsZCBub3QgZmluZCBtaXJyb3JlZCBzcHJpdGUgZm9yICR7aGV4KGlkKX06ICR7aGV4KHRhcmdldCl9YCk7XG4gICAgICB9XG4gICAgICB0aGlzLnNpemUgPSAwO1xuICAgICAgdGhpcy5mcmFtZU1hc2sgPSAwO1xuICAgICAgdGhpcy5mcmFtZXMgPSAwO1xuICAgICAgdGhpcy5zcHJpdGVzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWlycm9yZWQgPSBudWxsO1xuICAgICAgdGhpcy5zaXplID0gcm9tLnByZ1t0aGlzLmJhc2VdO1xuICAgICAgdGhpcy5mcmFtZU1hc2sgPSByb20ucHJnW3RoaXMuYmFzZSArIDFdO1xuICAgICAgdGhpcy5mcmFtZXMgPSB0aGlzLmZyYW1lTWFzayArIDE7XG5cbiAgICAgIHRoaXMuc3ByaXRlcyA9IHNlcSh0aGlzLmZyYW1lcywgZiA9PiB7XG4gICAgICAgIGNvbnN0IGEgPSB0aGlzLmJhc2UgKyAyICsgZiAqIDQgKiB0aGlzLnNpemU7XG4gICAgICAgIGNvbnN0IHNwcml0ZXM6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdW10gPSBbXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNpemU7IGkrKykge1xuICAgICAgICAgIGlmIChyb20ucHJnW2EgKyA0ICogaV0gPT09IDB4ODApIGJyZWFrO1xuICAgICAgICAgIHNwcml0ZXMucHVzaCh0dXBsZShyb20ucHJnLCBhICsgNCAqIGksIDQpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3ByaXRlcztcbiAgICAgIH0pO1xuICAgICAgLy8gTk9URTogd2hlbiByZS1lbmNvZGluZyB0aGlzLCBmaWxsIGluICQ4MCBmb3IgYWxsXG4gICAgICAvLyBtaXNzaW5nIHJvd3MgZnJvbSBub24tZmluYWwgZnJhbWVzLiAgRm9yIHRoZSBmaW5hbFxuICAgICAgLy8gZnJhbWUsIGp1c3Qgd3JpdGUgYSBzaW5nbGUgcm93IG9mICQ4MCAob3IgbWF5YmVcbiAgICAgIC8vIGV2ZW4ganVzdCBhIHNpbmdsZSBvbmUsIGlmIG9ubHkgdGhlIGZpcnN0IGlzIHVzZWQpLlxuICAgIH1cbiAgfVxuXG4gIHBhdHRlcm5CYW5rcyhvZmZzZXQgPSAwKTogbnVtYmVyW10ge1xuICAgIGlmICghdGhpcy51c2VkKSByZXR1cm4gW107XG4gICAgbGV0IG1zOiBNZXRhc3ByaXRlID0gdGhpcztcbiAgICBpZiAobXMubWlycm9yZWQpIHtcbiAgICAgIG1zID0gdGhpcy5yb20ubWV0YXNwcml0ZXNbbXMubWlycm9yZWRdO1xuICAgIH1cbiAgICBjb25zdCBwYXRzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCB2ZXJzaW9uIG9mIG1zLnNwcml0ZXMpIHtcbiAgICAgIGZvciAoY29uc3QgW2R4LCAsICwgcGF0XSBvZiB2ZXJzaW9uKSB7XG4gICAgICAgIGlmIChkeCA9PT0gMHg4MCkgYnJlYWs7XG4gICAgICAgIHBhdHMuYWRkKCgocGF0ICsgb2Zmc2V0KSA+Pj4gNikgJiAweGZmKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFsuLi5wYXRzXTtcbiAgfVxuXG4gIC8vIHJldHVybnMgYW4gYXJyYXkgb2YgWzAuLjNdXG4gIHBhbGV0dGVzKCk6IG51bWJlcltdIHtcbiAgICBpZiAoIXRoaXMudXNlZCkgcmV0dXJuIFtdO1xuICAgIGxldCBtczogTWV0YXNwcml0ZSA9IHRoaXM7XG4gICAgaWYgKG1zLm1pcnJvcmVkKSB7XG4gICAgICBtcyA9IHRoaXMucm9tLm1ldGFzcHJpdGVzW21zLm1pcnJvcmVkXTtcbiAgICB9XG4gICAgY29uc3QgcGFscyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAoY29uc3QgdmVyc2lvbiBvZiBtcy5zcHJpdGVzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtkeCwgLCBhdHRyXSBvZiB2ZXJzaW9uKSB7XG4gICAgICAgIGlmIChkeCA9PT0gMHg4MCkgYnJlYWs7XG4gICAgICAgIHBhbHMuYWRkKGF0dHIgJiAzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFsuLi5wYWxzXTtcbiAgfVxufVxuIl19