import { Entity } from './entity.js';
import { readLittleEndian } from './util.js';
import { Constraint } from './constraint.js';
export class ObjectData extends Entity {
    constructor(parent, id) {
        super(parent.rom, id);
        this.constraint = Constraint.ALL;
        parent[id] = this;
        this.used = true;
        this.name = '';
        this.base = readLittleEndian(this.rom.prg, this.pointer) + 0x10000;
        this.sfx = this.rom.prg[this.base];
        this.data = [];
        let a = this.base + 1;
        let m = 0;
        for (let i = 0; i < 32; i++) {
            if (!(i & 7)) {
                m = this.rom.prg[a++];
            }
            this.data.push(m & 0x80 ? this.rom.prg[a++] : 0);
            m <<= 1;
        }
    }
    get pointer() {
        return 0x1ac00 + (this.id << 1);
    }
    serialize() {
        const out = [this.sfx];
        for (let i = 0; i < 4; i++) {
            const k = out.length;
            out.push(0);
            for (let j = 0; j < 8; j++) {
                if (this.data[8 * i + j]) {
                    out[k] |= (0x80 >>> j);
                    out.push(this.data[8 * i + j]);
                }
            }
        }
        return out;
    }
    write() {
        const name = `Object_${this.id.toString(16).padStart(2, '0')}`;
        const a = this.rom.assembler();
        a.segment('0d');
        a.reloc(name);
        const label = a.pc();
        a.byte(...this.serialize());
        a.org(0xac00 + (this.id << 1), `${name}_Ptr`);
        a.word(label);
        if (this === this.rom.objects.blueSlime) {
            let e = this.elements;
            let b = 0;
            while (e) {
                e >>= 1;
                b++;
            }
            a.segment('1a');
            a.org(0x922d);
            a.byte(b);
        }
        return [a.module()];
    }
    get(addr) {
        return this.data[(addr - 0x300) >>> 5];
    }
    parents() {
        return [];
    }
    spawnedChild() {
        var _a;
        const hasChild = (_a = this.rom.objectActions[this.action]) === null || _a === void 0 ? void 0 : _a.data.hasChild;
        if (!hasChild)
            return undefined;
        const spawn = this.rom.adHocSpawns[this.child];
        const spawnId = spawn && spawn.objectId;
        if (spawnId == null)
            return undefined;
        return this.rom.objects[spawnId];
    }
    spawnedReplacement() {
        if (!this.replacement)
            return undefined;
        return this.rom.objects[this.replacement];
    }
    locations() {
        return this.rom.locations.filter((l) => l.used && l.spawns.some(spawn => spawn.isMonster() && spawn.monsterId === this.id));
    }
    palettes(includeChildren = false) {
        var _a, _b;
        if (this.action === 0x22)
            return [3];
        let metaspriteId = this.data[0];
        if (this.action === 0x2a)
            metaspriteId = this.data[31] | 1;
        if (this.action === 0x29)
            metaspriteId = 0x6b;
        if (this.action === 0x26)
            metaspriteId = 0x9c;
        const ms = this.rom.metasprites[metaspriteId];
        const childMs = includeChildren && this.child ?
            this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]] :
            null;
        const s = new Set([...((_a = ms === null || ms === void 0 ? void 0 : ms.palettes()) !== null && _a !== void 0 ? _a : []),
            ...((_b = childMs === null || childMs === void 0 ? void 0 : childMs.palettes()) !== null && _b !== void 0 ? _b : [])]);
        return [...s];
    }
    isVulnerable(element) {
        return !(this.elements & (1 << element));
    }
    isShadow() {
        return this.id === 0x7b || this.id === 0x8c;
    }
    get metasprite() { return METASPRITE.get(this.data); }
    set metasprite(x) { METASPRITE.set(this.data, x); }
    get speed() { return SPEED.get(this.data); }
    set speed(x) { SPEED.set(this.data, x); }
    get collisionPlane() { return COLLISION_PLANE.get(this.data); }
    set collisionPlane(x) { COLLISION_PLANE.set(this.data, x); }
    get hitbox() { return HITBOX.get(this.data); }
    set hitbox(x) { HITBOX.set(this.data, x); }
    get hp() { return HP.get(this.data); }
    set hp(x) { HP.set(this.data, x); }
    get atk() { return ATK.get(this.data); }
    set atk(x) { ATK.set(this.data, x); }
    get def() { return DEF.get(this.data); }
    set def(x) { DEF.set(this.data, x); }
    get level() { return LEVEL.get(this.data); }
    set level(x) { LEVEL.set(this.data, x); }
    get poison() { return !!POISON.get(this.data); }
    set poison(x) { POISON.set(this.data, x ? 1 : 0); }
    get child() { return CHILD.get(this.data); }
    set child(x) { CHILD.set(this.data, x); }
    get terrainSusceptibility() { return TERRAIN_SUSCEPTIBILITY.get(this.data); }
    set terrainSusceptibility(x) { TERRAIN_SUSCEPTIBILITY.set(this.data, x); }
    get immobile() { return !!IMMOBILE.get(this.data); }
    set immobile(x) { IMMOBILE.set(this.data, x ? 1 : 0); }
    get action() { return ACTION.get(this.data); }
    set action(x) { ACTION.set(this.data, x); }
    get replacement() { return REPLACEMENT.get(this.data); }
    set replacement(x) { REPLACEMENT.set(this.data, x); }
    get goldDrop() { return GOLD_DROP.get(this.data); }
    set goldDrop(x) { GOLD_DROP.set(this.data, x); }
    get elements() { return ELEMENTS.get(this.data); }
    set elements(x) { ELEMENTS.set(this.data, x); }
    get expReward() { return EXP_REWARD.get(this.data); }
    set expReward(x) { EXP_REWARD.set(this.data, x); }
    get attackType() { return ATTACK_TYPE.get(this.data); }
    set attackType(x) { ATTACK_TYPE.set(this.data, x); }
    get statusEffect() { return STATUS_EFFECT.get(this.data); }
    set statusEffect(x) { STATUS_EFFECT.set(this.data, x); }
    toString() {
        return super.toString() + (this.name ? ' ' + this.name : '');
    }
}
function prop(...spec) {
    return new Stat(...spec);
}
class Stat {
    constructor(...spec) {
        this.spec = spec;
    }
    get(data) {
        let value = 0;
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            value |= ((data[index] & mask) >>> rsh) << lsh;
        }
        return value;
    }
    set(data, value) {
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            const v = (value >>> lsh) << rsh & mask;
            data[index] = data[index] & ~mask | v;
        }
    }
}
const METASPRITE = prop([0x300]);
const SPEED = prop([0x340, 0xf]);
const COLLISION_PLANE = prop([0x3a0, 0xf0, 4]);
const HITBOX = prop([0x420, 0x40, 2], [0x3a0, 0x0f]);
const HP = prop([0x3c0]);
const ATK = prop([0x3e0]);
const DEF = prop([0x400]);
const LEVEL = prop([0x420, 0x1f]);
const POISON = prop([0x420, 0x80, 7]);
const CHILD = prop([0x440]);
const TERRAIN_SUSCEPTIBILITY = prop([0x460]);
const IMMOBILE = prop([0x4a0, 0x80, 7]);
const ACTION = prop([0x4a0, 0x7f]);
const REPLACEMENT = prop([0x4c0]);
const GOLD_DROP = prop([0x500, 0xf0, 4]);
const ELEMENTS = prop([0x500, 0xf]);
const EXP_REWARD = prop([0x520]);
const ATTACK_TYPE = prop([0x540]);
const STATUS_EFFECT = prop([0x560, 0xf]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0ZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vb2JqZWN0ZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJN0MsTUFBTSxPQUFPLFVBQVcsU0FBUSxNQUFNO0lBWXBDLFlBQVksTUFBZSxFQUFFLEVBQVU7UUFDckMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFIeEIsZUFBVSxHQUFlLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFJdEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUNuRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxDQUFDLENBQUMsQ0FB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QUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5ELElBQUksRUFBRSxLQUFhLE9BQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlDLElBQUksRUFBRSxDQUFDLENBQVMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNDLElBQUksR0FBRyxLQUFhLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksR0FBRyxDQUFDLENBQVMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdDLElBQUksR0FBRyxLQUFhLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksR0FBRyxDQUFDLENBQVMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdDLElBQUksS0FBSyxLQUFhLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BELElBQUksS0FBSyxDQUFDLENBQVMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpELElBQUksTUFBTSxLQUFjLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RCxJQUFJLE1BQU0sQ0FBQyxDQUFVLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFNUQsSUFBSSxLQUFLLEtBQWEsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsSUFBSSxLQUFLLENBQUMsQ0FBUyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakQsSUFBSSxxQkFBcUIsS0FBYSxPQUFPLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JGLElBQUkscUJBQXFCLENBQUMsQ0FBUyxJQUFJLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVsRixJQUFJLFFBQVEsS0FBYyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0QsSUFBSSxRQUFRLENBQUMsQ0FBVSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWhFLElBQUksTUFBTSxLQUFhLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksTUFBTSxDQUFDLENBQVMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5ELElBQUksV0FBVyxLQUFhLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLElBQUksV0FBVyxDQUFDLENBQVMsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdELElBQUksUUFBUSxLQUFhLE9BQU8sU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELElBQUksUUFBUSxDQUFDLENBQVMsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXhELElBQUksUUFBUSxLQUFhLE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFELElBQUksUUFBUSxDQUFDLENBQVMsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBR3ZELElBQUksU0FBUyxLQUFhLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdELElBQUksU0FBUyxDQUFDLENBQVMsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTFELElBQUksVUFBVSxLQUFhLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9ELElBQUksVUFBVSxDQUFDLENBQVMsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELElBQUksWUFBWSxLQUFhLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFD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ZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSB9IGZyb20gJy4uL2FzbS9tb2R1bGUuanMnO1xuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi9lbnRpdHkuanMnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuL2xvY2F0aW9uLmpzJztcbmltcG9ydCB7IHJlYWRMaXR0bGVFbmRpYW4gfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHsgQ29uc3RyYWludCB9IGZyb20gJy4vY29uc3RyYWludC5qcyc7XG5pbXBvcnQgdHlwZSB7IE9iamVjdHMgfSBmcm9tICcuL29iamVjdHMuanMnO1xuXG4vLyBOT1RFOiBXb3VsZCBiZSBuaWNlIHRvIGNhbGwgdGhpcyBPYmplY3QsIGJ1dCB0aGF0IHNlZW1zIGNvbmZ1c2luZy4uLlxuZXhwb3J0IGNsYXNzIE9iamVjdERhdGEgZXh0ZW5kcyBFbnRpdHkge1xuXG4gIHVzZWQ6IGJvb2xlYW47XG4gIG5hbWU6IHN0cmluZztcblxuICBiYXNlOiBudW1iZXI7XG5cbiAgc2Z4OiBudW1iZXI7XG4gIGRhdGE6IG51bWJlcltdO1xuXG4gIGNvbnN0cmFpbnQ6IENvbnN0cmFpbnQgPSBDb25zdHJhaW50LkFMTDtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IE9iamVjdHMsIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihwYXJlbnQucm9tLCBpZCk7XG4gICAgcGFyZW50W2lkXSA9IHRoaXM7XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgICB0aGlzLm5hbWUgPSAnJztcbiAgICB0aGlzLmJhc2UgPSByZWFkTGl0dGxlRW5kaWFuKHRoaXMucm9tLnByZywgdGhpcy5wb2ludGVyKSArIDB4MTAwMDA7XG4gICAgdGhpcy5zZnggPSB0aGlzLnJvbS5wcmdbdGhpcy5iYXNlXTtcbiAgICB0aGlzLmRhdGEgPSBbXTtcbiAgICBsZXQgYSA9IHRoaXMuYmFzZSArIDE7XG4gICAgbGV0IG0gPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzI7IGkrKykge1xuICAgICAgaWYgKCEoaSAmIDcpKSB7XG4gICAgICAgIG0gPSB0aGlzLnJvbS5wcmdbYSsrXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGF0YS5wdXNoKG0gJiAweDgwID8gdGhpcy5yb20ucHJnW2ErK10gOiAwKTtcbiAgICAgIG0gPDw9IDE7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHBvaW50ZXIoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gMHgxYWMwMCArICh0aGlzLmlkIDw8IDEpO1xuICB9XG5cbiAgLy8gUmV0dXJucyBhIGJ5dGUgYXJyYXkgZm9yIHRoaXMgZW50cnlcbiAgc2VyaWFsaXplKCk6IG51bWJlcltdIHtcbiAgICBjb25zdCBvdXQgPSBbdGhpcy5zZnhdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBjb25zdCBrID0gb3V0Lmxlbmd0aDtcbiAgICAgIG91dC5wdXNoKDApO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA4OyBqKyspIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YVs4ICogaSArIGpdKSB7XG4gICAgICAgICAgb3V0W2tdIHw9ICgweDgwID4+PiBqKTtcbiAgICAgICAgICBvdXQucHVzaCh0aGlzLmRhdGFbOCAqIGkgKyBqXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHdyaXRlKHRoaXM6IE9iamVjdERhdGEpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgbmFtZSA9IGBPYmplY3RfJHt0aGlzLmlkLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpfWA7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGEuc2VnbWVudCgnMGQnKTtcbiAgICBhLnJlbG9jKG5hbWUpO1xuICAgIGNvbnN0IGxhYmVsID0gYS5wYygpO1xuICAgIGEuYnl0ZSguLi50aGlzLnNlcmlhbGl6ZSgpKTtcbiAgICBhLm9yZygweGFjMDAgKyAodGhpcy5pZCA8PCAxKSwgYCR7bmFtZX1fUHRyYCk7XG4gICAgYS53b3JkKGxhYmVsKTtcblxuICAgIC8vIEhhbmRsZSBzbGltZSB0cmFuc2Zvcm1hdGlvbi4gIFdlIGFzc3VtZSBhbGwgc2xpbWVzIGFyZSBpbnZ1bG5lcmFibGVcbiAgICAvLyB0byB0aGUgc2FtZSBlbGVtZW50IChyZXNjYWxlbW9uc3RlcnMgZ3VhcmFudGVlcyB0aGlzLCBhbnl3YXkpLlxuICAgIGlmICh0aGlzID09PSB0aGlzLnJvbS5vYmplY3RzLmJsdWVTbGltZSkge1xuICAgICAgLy8gRmlndXJlIG91dCB3aGljaCBiaXQgaXMgc2V0IChlbGVtZW50cyA9IDE8PChiLTEpKVxuICAgICAgLy8gTm90ZSB0aGUgZXh0cmEgb2Zmc2V0IGlzIGR1ZSB0byAwIGJlaW5nIFwibm8gc3dvcmQgZXF1aXBwZWRcIlxuICAgICAgbGV0IGUgPSB0aGlzLmVsZW1lbnRzO1xuICAgICAgbGV0IGIgPSAwO1xuICAgICAgd2hpbGUgKGUpIHtcbiAgICAgICAgZSA+Pj0gMTtcbiAgICAgICAgYisrO1xuICAgICAgfVxuICAgICAgYS5zZWdtZW50KCcxYScpO1xuICAgICAgYS5vcmcoMHg5MjJkKTsgLy8gJDM1MjJkXG4gICAgICBhLmJ5dGUoYik7XG4gICAgfVxuXG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxuXG4gIGdldChhZGRyOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmRhdGFbKGFkZHIgLSAweDMwMCkgPj4+IDVdO1xuICB9XG5cbiAgcGFyZW50cygpOiBPYmplY3REYXRhW10ge1xuICAgIC8vIElmIHRoaXMgaXMgYSBwcm9qZWN0aWxlIHRoYXQgaXMgdGhlIHBhcmVudCBvZiBzb21lIG1vbnN0ZXIsXG4gICAgLy8gcmV0dXJuIGFuIGFycmF5IG9mIHBhcmVudHMgdGhhdCBzcGF3bmVkIGl0LlxuICAgIHJldHVybiBbXTtcbiAgICAvLyByZXR1cm4gdGhpcy5yb20ubW9uc3RlcnMuZmlsdGVyKFxuICAgIC8vICAgICAobTogT2JqZWN0RGF0YSkgPT4gbS5jaGlsZCAmJlxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb20uYWRIb2NTcGF3bnNbbS5jaGlsZF0ub2JqZWN0SWQgPT09IHRoaXMuaWQpO1xuICB9XG5cbiAgc3Bhd25lZENoaWxkKCk6IE9iamVjdERhdGF8dW5kZWZpbmVkIHtcbiAgICBjb25zdCBoYXNDaGlsZCA9IHRoaXMucm9tLm9iamVjdEFjdGlvbnNbdGhpcy5hY3Rpb25dPy5kYXRhLmhhc0NoaWxkO1xuICAgIGlmICghaGFzQ2hpbGQpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY29uc3Qgc3Bhd24gPSB0aGlzLnJvbS5hZEhvY1NwYXduc1t0aGlzLmNoaWxkXTtcbiAgICBjb25zdCBzcGF3bklkID0gc3Bhd24gJiYgc3Bhd24ub2JqZWN0SWQ7XG4gICAgaWYgKHNwYXduSWQgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICByZXR1cm4gdGhpcy5yb20ub2JqZWN0c1tzcGF3bklkXTtcbiAgfVxuXG4gIHNwYXduZWRSZXBsYWNlbWVudCgpOiBPYmplY3REYXRhfHVuZGVmaW5lZCB7XG4gICAgaWYgKCF0aGlzLnJlcGxhY2VtZW50KSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiB0aGlzLnJvbS5vYmplY3RzW3RoaXMucmVwbGFjZW1lbnRdO1xuICB9XG5cbiAgbG9jYXRpb25zKCk6IExvY2F0aW9uW10ge1xuICAgIC8vIFRPRE8gLSBoYW5kbGUgbm9uLW1vbnN0ZXIgTlBDcy5cbiAgICByZXR1cm4gdGhpcy5yb20ubG9jYXRpb25zLmZpbHRlcigobDogTG9jYXRpb24pID0+XG4gICAgICAgIGwudXNlZCAmJiBsLnNwYXducy5zb21lKHNwYXduID0+XG4gICAgICAgICAgICBzcGF3bi5pc01vbnN0ZXIoKSAmJiBzcGF3bi5tb25zdGVySWQgPT09IHRoaXMuaWQpKTtcbiAgfVxuXG4gIHBhbGV0dGVzKGluY2x1ZGVDaGlsZHJlbiA9IGZhbHNlKTogbnVtYmVyW10ge1xuICAgIC8vIE5PVEU6IHRoaXMgZ2V0cyB0aGUgd3JvbmcgcmVzdWx0IGZvciBpY2Uvc2FuZCB6b21iaWVzIGFuZCBibG9icy5cbiAgICAvLyAgLSBtYXkganVzdCBuZWVkIHRvIGd1ZXNzL2Fzc3VtZSBhbmQgZXhwZXJpbWVudD9cbiAgICAvLyAgLSB6b21iaWVzIChhY3Rpb24gMHgyMikgbG9vayBsaWtlIHNob3VsZCBqdXN0IGJlIDNcbiAgICAvLyAgLSBsYXZhbWVuL2Jsb2JzIChhY3Rpb24gMHgyOSkgYXJlIDJcbiAgICAvLyAgLSB3cmFpdGggc2hhZG93cyAoYWN0aW9uIDB4MjYpIGFyZSAzXG4gICAgaWYgKHRoaXMuYWN0aW9uID09PSAweDIyKSByZXR1cm4gWzNdOyAvLyB6b21iaWVcbiAgICBsZXQgbWV0YXNwcml0ZUlkID0gdGhpcy5kYXRhWzBdO1xuICAgIGlmICh0aGlzLmFjdGlvbiA9PT0gMHgyYSkgbWV0YXNwcml0ZUlkID0gdGhpcy5kYXRhWzMxXSB8IDE7XG4gICAgaWYgKHRoaXMuYWN0aW9uID09PSAweDI5KSBtZXRhc3ByaXRlSWQgPSAweDZiOyAvLyBibG9iXG4gICAgaWYgKHRoaXMuYWN0aW9uID09PSAweDI2KSBtZXRhc3ByaXRlSWQgPSAweDljO1xuXG4gICAgY29uc3QgbXMgPSB0aGlzLnJvbS5tZXRhc3ByaXRlc1ttZXRhc3ByaXRlSWRdO1xuICAgIGNvbnN0IGNoaWxkTXMgPVxuICAgICAgICBpbmNsdWRlQ2hpbGRyZW4gJiYgdGhpcy5jaGlsZCA/XG4gICAgICAgICAgICB0aGlzLnJvbS5tZXRhc3ByaXRlc1tcbiAgICAgICAgICAgICAgICB0aGlzLnJvbS5vYmplY3RzW1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbS5hZEhvY1NwYXduc1t0aGlzLmNoaWxkXS5vYmplY3RJZF0uZGF0YVswXV0gOlxuICAgICAgICAgICAgbnVsbDtcbiAgICBjb25zdCBzID0gbmV3IFNldChbLi4uKG1zPy5wYWxldHRlcygpID8/IFtdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgLi4uKGNoaWxkTXM/LnBhbGV0dGVzKCkgPz8gW10pXSk7XG4gICAgcmV0dXJuIFsuLi5zXTtcbiAgfVxuXG4gIC8vIDAgZm9yIHdpbmQsIDEgZm9yIGZpcmUsIDIgZm9yIHdhdGVyLCAzIGZvciB0aHVuZGVyXG4gIGlzVnVsbmVyYWJsZShlbGVtZW50OiBudW1iZXIpIHtcbiAgICByZXR1cm4gISh0aGlzLmVsZW1lbnRzICYgKDEgPDwgZWxlbWVudCkpO1xuICB9XG5cbiAgaXNTaGFkb3coKSB7XG4gICAgLy8gTk9URTogaW50ZXJuYWxseSB0aGUgZ2FtZSBjaGVja3MgdGhhdCB0aGUgbWV0YXNwcml0ZVxuICAgIC8vIGlzICRhNyAoc2VlICQzNTBmMyksIGJ1dCB3ZSdsbCBqdXN0IGhhcmRjb2RlLlxuICAgIHJldHVybiB0aGlzLmlkID09PSAweDdiIHx8IHRoaXMuaWQgPT09IDB4OGM7XG4gIH1cblxuICBnZXQgbWV0YXNwcml0ZSgpOiBudW1iZXIgeyByZXR1cm4gTUVUQVNQUklURS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgbWV0YXNwcml0ZSh4OiBudW1iZXIpIHsgTUVUQVNQUklURS5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBzcGVlZCgpOiBudW1iZXIgeyByZXR1cm4gU1BFRUQuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IHNwZWVkKHg6IG51bWJlcikgeyBTUEVFRC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBjb2xsaXNpb25QbGFuZSgpOiBudW1iZXIgeyByZXR1cm4gQ09MTElTSU9OX1BMQU5FLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBjb2xsaXNpb25QbGFuZSh4OiBudW1iZXIpIHsgQ09MTElTSU9OX1BMQU5FLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGhpdGJveCgpOiBudW1iZXIgeyByZXR1cm4gSElUQk9YLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBoaXRib3goeDogbnVtYmVyKSB7IEhJVEJPWC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBocCgpOiBudW1iZXIgeyByZXR1cm4gSFAuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGhwKHg6IG51bWJlcikgeyBIUC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBhdGsoKTogbnVtYmVyIHsgcmV0dXJuIEFUSy5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgYXRrKHg6IG51bWJlcikgeyBBVEsuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgZGVmKCk6IG51bWJlciB7IHJldHVybiBERUYuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGRlZih4OiBudW1iZXIpIHsgREVGLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGxldmVsKCk6IG51bWJlciB7IHJldHVybiBMRVZFTC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgbGV2ZWwoeDogbnVtYmVyKSB7IExFVkVMLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHBvaXNvbigpOiBib29sZWFuIHsgcmV0dXJuICEhUE9JU09OLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBwb2lzb24oeDogYm9vbGVhbikgeyBQT0lTT04uc2V0KHRoaXMuZGF0YSwgeCA/IDEgOiAwKTsgfVxuXG4gIGdldCBjaGlsZCgpOiBudW1iZXIgeyByZXR1cm4gQ0hJTEQuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGNoaWxkKHg6IG51bWJlcikgeyBDSElMRC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCB0ZXJyYWluU3VzY2VwdGliaWxpdHkoKTogbnVtYmVyIHsgcmV0dXJuIFRFUlJBSU5fU1VTQ0VQVElCSUxJVFkuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IHRlcnJhaW5TdXNjZXB0aWJpbGl0eSh4OiBudW1iZXIpIHsgVEVSUkFJTl9TVVNDRVBUSUJJTElUWS5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBpbW1vYmlsZSgpOiBib29sZWFuIHsgcmV0dXJuICEhSU1NT0JJTEUuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGltbW9iaWxlKHg6IGJvb2xlYW4pIHsgSU1NT0JJTEUuc2V0KHRoaXMuZGF0YSwgeCA/IDEgOiAwKTsgfVxuXG4gIGdldCBhY3Rpb24oKTogbnVtYmVyIHsgcmV0dXJuIEFDVElPTi5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgYWN0aW9uKHg6IG51bWJlcikgeyBBQ1RJT04uc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgcmVwbGFjZW1lbnQoKTogbnVtYmVyIHsgcmV0dXJuIFJFUExBQ0VNRU5ULmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCByZXBsYWNlbWVudCh4OiBudW1iZXIpIHsgUkVQTEFDRU1FTlQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgZ29sZERyb3AoKTogbnVtYmVyIHsgcmV0dXJuIEdPTERfRFJPUC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgZ29sZERyb3AoeDogbnVtYmVyKSB7IEdPTERfRFJPUC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBlbGVtZW50cygpOiBudW1iZXIgeyByZXR1cm4gRUxFTUVOVFMuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGVsZW1lbnRzKHg6IG51bWJlcikgeyBFTEVNRU5UUy5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIC8qKiBVbnByb2Nlc3NlZCBleHBlcmllbmNlIHJld2FyZCAoJDUyMCx4KS4gKi9cbiAgZ2V0IGV4cFJld2FyZCgpOiBudW1iZXIgeyByZXR1cm4gRVhQX1JFV0FSRC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgZXhwUmV3YXJkKHg6IG51bWJlcikgeyBFWFBfUkVXQVJELnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGF0dGFja1R5cGUoKTogbnVtYmVyIHsgcmV0dXJuIEFUVEFDS19UWVBFLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBhdHRhY2tUeXBlKHg6IG51bWJlcikgeyBBVFRBQ0tfVFlQRS5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBzdGF0dXNFZmZlY3QoKTogbnVtYmVyIHsgcmV0dXJuIFNUQVRVU19FRkZFQ1QuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IHN0YXR1c0VmZmVjdCh4OiBudW1iZXIpIHsgU1RBVFVTX0VGRkVDVC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiBzdXBlci50b1N0cmluZygpICsgKHRoaXMubmFtZSA/ICcgJyArIHRoaXMubmFtZSA6ICcnKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwcm9wKC4uLnNwZWM6IFtudW1iZXIsIG51bWJlcj8sIG51bWJlcj9dW10pIHtcbiAgcmV0dXJuIG5ldyBTdGF0KC4uLnNwZWMpO1xufVxuXG5jbGFzcyBTdGF0IHtcbiAgcmVhZG9ubHkgc3BlYzogW251bWJlciwgbnVtYmVyPywgbnVtYmVyP11bXTtcblxuICBjb25zdHJ1Y3RvciguLi5zcGVjOiBbbnVtYmVyLCBudW1iZXI/LCBudW1iZXI/XVtdKSB7XG4gICAgdGhpcy5zcGVjID0gc3BlYztcbiAgfVxuXG4gIGdldChkYXRhOiBudW1iZXJbXSkge1xuICAgIGxldCB2YWx1ZSA9IDA7XG4gICAgZm9yIChjb25zdCBbYWRkciwgbWFzayA9IDB4ZmYsIHNoaWZ0ID0gMF0gb2YgdGhpcy5zcGVjKSB7XG4gICAgICBjb25zdCBpbmRleCA9IChhZGRyIC0gMHgzMDApID4+PiA1O1xuICAgICAgY29uc3QgbHNoID0gc2hpZnQgPCAwID8gLXNoaWZ0IDogMDtcbiAgICAgIGNvbnN0IHJzaCA9IHNoaWZ0IDwgMCA/IDAgOiBzaGlmdDtcbiAgICAgIHZhbHVlIHw9ICgoZGF0YVtpbmRleF0gJiBtYXNrKSA+Pj4gcnNoKSA8PCBsc2g7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIHNldChkYXRhOiBudW1iZXJbXSwgdmFsdWU6IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgW2FkZHIsIG1hc2sgPSAweGZmLCBzaGlmdCA9IDBdIG9mIHRoaXMuc3BlYykge1xuICAgICAgY29uc3QgaW5kZXggPSAoYWRkciAtIDB4MzAwKSA+Pj4gNTtcbiAgICAgIGNvbnN0IGxzaCA9IHNoaWZ0IDwgMCA/IC1zaGlmdCA6IDA7XG4gICAgICBjb25zdCByc2ggPSBzaGlmdCA8IDAgPyAwIDogc2hpZnQ7XG4gICAgICBjb25zdCB2ID0gKHZhbHVlID4+PiBsc2gpIDw8IHJzaCAmIG1hc2s7XG4gICAgICBkYXRhW2luZGV4XSA9IGRhdGFbaW5kZXhdICYgfm1hc2sgfCB2O1xuICAgIH1cbiAgfVxufVxuXG5jb25zdCBNRVRBU1BSSVRFID0gcHJvcChbMHgzMDBdKTtcbmNvbnN0IFNQRUVEID0gcHJvcChbMHgzNDAsIDB4Zl0pO1xuY29uc3QgQ09MTElTSU9OX1BMQU5FID0gcHJvcChbMHgzYTAsIDB4ZjAsIDRdKTtcbmNvbnN0IEhJVEJPWCA9IHByb3AoWzB4NDIwLCAweDQwLCAyXSwgWzB4M2EwLCAweDBmXSk7XG5jb25zdCBIUCA9IHByb3AoWzB4M2MwXSk7XG5jb25zdCBBVEsgPSBwcm9wKFsweDNlMF0pO1xuY29uc3QgREVGID0gcHJvcChbMHg0MDBdKTtcbmNvbnN0IExFVkVMID0gcHJvcChbMHg0MjAsIDB4MWZdKTtcbmNvbnN0IFBPSVNPTiA9IHByb3AoWzB4NDIwLCAweDgwLCA3XSk7XG5jb25zdCBDSElMRCA9IHByb3AoWzB4NDQwXSk7IC8vIGFkLWhvYyBzcGF3biBpbmRleFxuY29uc3QgVEVSUkFJTl9TVVNDRVBUSUJJTElUWSA9IHByb3AoWzB4NDYwXSk7XG5jb25zdCBJTU1PQklMRSA9IHByb3AoWzB4NGEwLCAweDgwLCA3XSk7IC8vIHdpbGwgbm90IGJlIGtub2NrZWQgYmFja1xuY29uc3QgQUNUSU9OID0gcHJvcChbMHg0YTAsIDB4N2ZdKTtcbmNvbnN0IFJFUExBQ0VNRU5UID0gcHJvcChbMHg0YzBdKTtcbmNvbnN0IEdPTERfRFJPUCA9IHByb3AoWzB4NTAwLCAweGYwLCA0XSk7XG5jb25zdCBFTEVNRU5UUyA9IHByb3AoWzB4NTAwLCAweGZdKTtcbmNvbnN0IEVYUF9SRVdBUkQgPSBwcm9wKFsweDUyMF0pO1xuY29uc3QgQVRUQUNLX1RZUEUgPSBwcm9wKFsweDU0MF0pO1xuY29uc3QgU1RBVFVTX0VGRkVDVCA9IHByb3AoWzB4NTYwLCAweGZdKTtcbiJdfQ==