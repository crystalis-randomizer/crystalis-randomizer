import { Entity } from './entity.js';
import { reverseBits, seq, tuple } from './util.js';
export class Pattern extends Entity {
    constructor(rom, id, pixels) {
        super(rom, id);
        this.pixels = pixels || tuple(rom.chr, id << 4, 16);
    }
    pixelAt(y, x) {
        return (this.pixels[y | 8] >> x & 1) << 1 | (this.pixels[y] >> x & 1);
    }
    flipH() {
        return new Pattern(this.rom, -1, this.pixels.map(reverseBits));
    }
    flipV() {
        return new Pattern(this.rom, -1, seq(16, y => this.pixels[y & 8 | ~y & 7]));
    }
    flip(type) {
        let p = this;
        if (type & Flip.HORIZONTAL)
            p = p.flipH();
        if (type & Flip.VERTICAL)
            p = p.flipV();
        return p;
    }
    write() {
        const a = this.id << 4;
        this.rom.chr.subarray(a, a + 16).set(this.pixels);
        return [];
    }
}
export class Patterns {
    constructor(rom) {
        this._all = [];
        this._all = seq(rom.chr.length >> 4, i => new Pattern(rom, i));
    }
    get(page, tile_idx) {
        if (!tile_idx) {
            return this._all[page];
        }
        return this._all[page | tile_idx];
    }
    set(page, tile_idx, pixels) {
        this._all[page | tile_idx].pixels = pixels;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
Patterns.HUD_LF = parsePattern(`
    |L     ..|
    |L.    .#|
    |L.  FF.#|
    |L.  F..#|
    |LLL FF.#|
    | ...F..#|
    |    F ..|
    |    .   |
  `, { ' ': 2, 'L': 1, 'F': 1, '#': 1, '.': 3 });
Patterns.HUD_PW = parsePattern(`
    |PPP     |
    |P..P.   |
    |PPP.    |
    |P..     |
    |P.w.w.w |
    | .w.w.w |
    |  .w.w. |
    |   . .  |
  `, { ' ': 2, 'P': 1, 'w': 1, '.': 3 });
Patterns.HUD_EY = parsePattern(`
    |EEE   ..|
    |E..   .#|
    |EE Y.Y.#|
    |E..Y.Y.#|
    |EEE.Y..#|
    |... Y..#|
    |    Y...|
    |        |
  `, { ' ': 2, 'E': 1, 'Y': 1, '#': 1, '.': 3 });
Patterns.HUD_LV = parsePattern(`
    |        |
    |L       |
    |L.      |
    |L. v. v.|
    |L. v. v.|
    |LLL vv. |
    | ... v. |
    |     .  |
  `, { ' ': 2, 'L': 1, 'v': 1, '.': 3 });
Patterns.HUD_DL = parsePattern(`
    |        |
    |DD      |
    |D.D.L   |
    |D.D.L.  |
    |D.D.L.  |
    |DD. L.  |
    | .  LLL |
    |     ...|
  `, { ' ': 2, 'D': 1, 'L': 1, '.': 3 });
Patterns.HUD_MP = parsePattern(`
    |M.  M   |
    |MM.MM.  |
    |M.M.M.  |
    |M. .PPP |
    |M. .P..P|
    |    PPP.|
    |    P.. |
    |    P.  |
  `, { ' ': 2, 'M': 1, 'P': 1, '.': 3 });
Patterns.HUD_EX = parsePattern(`
    |EEE     |
    |E...    |
    |EEE     |
    |E...    |
    |EEE x.x.|
    | ... x. |
    |    x.x.|
    |     . .|
  `, { ' ': 2, 'E': 1, 'x': 1, '.': 3 });
function parsePattern(data, key) {
    const text = data.trim().replace(/^[^|]*\||\|[^|]*$/mg, '').replace(/\n/g, '');
    if (text.length !== 64)
        throw new Error(`Bad CHR tile: ${text}`);
    const arr = new Array(16).fill(0);
    for (let i = 0, c = ''; c = text.charAt(i); ++i) {
        const off = i >>> 3;
        const lo = off;
        const hi = off | 8;
        const col = ~i & 7;
        const val = key[c] || 0;
        if (val & 1) {
            arr[lo] |= 1 << col;
        }
        if (val & 2) {
            arr[hi] |= 1 << col;
        }
    }
    return arr;
}
export var Flip;
(function (Flip) {
    Flip[Flip["HORIZONTAL"] = 64] = "HORIZONTAL";
    Flip[Flip["VERTICAL"] = 128] = "VERTICAL";
})(Flip || (Flip = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vcGF0dGVybi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVsRCxNQUFNLE9BQU8sT0FBUSxTQUFRLE1BQU07SUFJakMsWUFBWSxHQUFRLEVBQUUsRUFBVSxFQUFFLE1BQWlCO1FBQ2pELEtBQUssQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFHRCxPQUFPLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQsS0FBSztRQUNILE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLO1FBQ0gsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBVTtRQUNiLElBQUksQ0FBQyxHQUFZLElBQUksQ0FBQztRQUN0QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVTtZQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDMUMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVE7WUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3hDLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELEtBQUs7UUFFSCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztDQUNGO0FBRTJCLE1BQU0sT0FBTyxRQUFRO0lBYy9DLFlBQVksR0FBUTtRQWJaLFNBQUksR0FBYyxFQUFFLENBQUM7UUFjM0IsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQWJELEdBQUcsQ0FBQyxJQUFZLEVBQUUsUUFBaUI7UUFDakMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELEdBQUcsQ0FBQyxJQUFZLEVBQUUsUUFBZ0IsRUFBRSxNQUFnQjtRQUNsRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQzdDLENBQUM7SUFNRCxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDZixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7SUFDdEMsQ0FBQzs7QUFFc0IsZUFBTSxHQUFHLFlBQVksQ0FBQzs7Ozs7Ozs7O0dBUzVDLEVBQUUsRUFBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ3RCLGVBQU0sR0FBRyxZQUFZLENBQUM7Ozs7Ozs7OztHQVM1QyxFQUFFLEVBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDZCxlQUFNLEdBQUcsWUFBWSxDQUFDOzs7Ozs7Ozs7R0FTNUMsRUFBRSxFQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDdEIsZUFBTSxHQUFHLFlBQVksQ0FBQzs7Ozs7Ozs7O0dBUzVDLEVBQUUsRUFBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUNkLGVBQU0sR0FBRyxZQUFZLENBQUM7Ozs7Ozs7OztHQVM1QyxFQUFFLEVBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDZCxlQUFNLEdBQUcsWUFBWSxDQUFDOzs7Ozs7Ozs7R0FTNUMsRUFBRSxFQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ2QsZUFBTSxHQUFHLFlBQVksQ0FBQzs7Ozs7Ozs7O0dBUzVDLEVBQUUsRUFBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUd2QyxTQUFTLFlBQVksQ0FBQyxJQUFZLEVBQUUsR0FBMkI7SUFDN0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9FLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxFQUFFO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNqRSxNQUFNLEdBQUcsR0FBYSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRTtRQUMvQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BCLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQztRQUNmLE1BQU0sRUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDbkIsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO1lBQ1gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUM7U0FDckI7UUFDRCxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7WUFDWCxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztTQUNyQjtLQUNGO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsTUFBTSxDQUFOLElBQVksSUFHWDtBQUhELFdBQVksSUFBSTtJQUNkLDRDQUFpQixDQUFBO0lBQ2pCLHlDQUFlLENBQUE7QUFDakIsQ0FBQyxFQUhXLElBQUksS0FBSixJQUFJLFFBR2YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge3JldmVyc2VCaXRzLCBzZXEsIHR1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuXG5leHBvcnQgY2xhc3MgUGF0dGVybiBleHRlbmRzIEVudGl0eSB7XG5cbiAgcGl4ZWxzOiBudW1iZXJbXTtcblxuICBjb25zdHJ1Y3Rvcihyb206IFJvbSwgaWQ6IG51bWJlciwgcGl4ZWxzPzogbnVtYmVyW10pIHtcbiAgICBzdXBlcihyb20sIGlkKTtcbiAgICB0aGlzLnBpeGVscyA9IHBpeGVscyB8fCB0dXBsZShyb20uY2hyLCBpZCA8PCA0LCAxNik7XG4gIH1cblxuICAvLyBUYWtlcyB4IGFuZCB5IGZyb20gMC4uNywgcmV0dXJucyBhIGNvbG9yIDAuLjMuXG4gIHBpeGVsQXQoeTogbnVtYmVyLCB4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiAodGhpcy5waXhlbHNbeSB8IDhdID4+IHggJiAxKSA8PCAxIHwgKHRoaXMucGl4ZWxzW3ldID4+IHggJiAxKTtcbiAgfVxuXG4gIGZsaXBIKCk6IFBhdHRlcm4ge1xuICAgIHJldHVybiBuZXcgUGF0dGVybih0aGlzLnJvbSwgLTEsIHRoaXMucGl4ZWxzLm1hcChyZXZlcnNlQml0cykpO1xuICB9XG5cbiAgZmxpcFYoKTogUGF0dGVybiB7XG4gICAgcmV0dXJuIG5ldyBQYXR0ZXJuKHRoaXMucm9tLCAtMSwgc2VxKDE2LCB5ID0+IHRoaXMucGl4ZWxzW3kgJiA4IHwgfnkgJiA3XSkpO1xuICB9XG5cbiAgZmxpcCh0eXBlOiBGbGlwKTogUGF0dGVybiB7XG4gICAgbGV0IHA6IFBhdHRlcm4gPSB0aGlzO1xuICAgIGlmICh0eXBlICYgRmxpcC5IT1JJWk9OVEFMKSBwID0gcC5mbGlwSCgpO1xuICAgIGlmICh0eXBlICYgRmxpcC5WRVJUSUNBTCkgcCA9IHAuZmxpcFYoKTtcbiAgICByZXR1cm4gcDtcbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICAvLyBUT0RPOiBpbnRlZ3JhdGUgQ0hSIGFzIGEgc2VwYXJhdGUgb3V0cHV0L29mZnNldCBpbiBsaW5rZXI/XG4gICAgY29uc3QgYSA9IHRoaXMuaWQgPDwgNDtcbiAgICB0aGlzLnJvbS5jaHIuc3ViYXJyYXkoYSwgYSArIDE2KS5zZXQodGhpcy5waXhlbHMpO1xuICAgIHJldHVybiBbXTtcbiAgfVxufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0IGNsYXNzIFBhdHRlcm5zIGltcGxlbWVudHMgSXRlcmFibGU8UGF0dGVybj4ge1xuICBwcml2YXRlIF9hbGw6IFBhdHRlcm5bXSA9IFtdO1xuXG4gIGdldChwYWdlOiBudW1iZXIsIHRpbGVfaWR4PzogbnVtYmVyKTogUGF0dGVybiB7XG4gICAgaWYgKCF0aWxlX2lkeCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2FsbFtwYWdlXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2FsbFtwYWdlIHwgdGlsZV9pZHhdO1xuICB9XG5cbiAgc2V0KHBhZ2U6IG51bWJlciwgdGlsZV9pZHg6IG51bWJlciwgcGl4ZWxzOiBudW1iZXJbXSkge1xuICAgIHRoaXMuX2FsbFtwYWdlIHwgdGlsZV9pZHhdLnBpeGVscyA9IHBpeGVscztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tKSB7XG4gICAgdGhpcy5fYWxsID0gc2VxKHJvbS5jaHIubGVuZ3RoID4+IDQsIGkgPT4gbmV3IFBhdHRlcm4ocm9tLCBpKSk7XG4gIH1cblxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWxsW1N5bWJvbC5pdGVyYXRvcl0oKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgSFVEX0xGID0gcGFyc2VQYXR0ZXJuKGBcbiAgICB8TCAgICAgLi58XG4gICAgfEwuICAgIC4jfFxuICAgIHxMLiAgRkYuI3xcbiAgICB8TC4gIEYuLiN8XG4gICAgfExMTCBGRi4jfFxuICAgIHwgLi4uRi4uI3xcbiAgICB8ICAgIEYgLi58XG4gICAgfCAgICAuICAgfFxuICBgLCB7JyAnOiAyLCAnTCc6IDEsICdGJzogMSwgJyMnOiAxLCAnLic6IDN9KTtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBIVURfUFcgPSBwYXJzZVBhdHRlcm4oYFxuICAgIHxQUFAgICAgIHxcbiAgICB8UC4uUC4gICB8XG4gICAgfFBQUC4gICAgfFxuICAgIHxQLi4gICAgIHxcbiAgICB8UC53LncudyB8XG4gICAgfCAudy53LncgfFxuICAgIHwgIC53LncuIHxcbiAgICB8ICAgLiAuICB8XG4gIGAsIHsnICc6IDIsICdQJzogMSwgJ3cnOiAxLCAnLic6IDN9KTtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBIVURfRVkgPSBwYXJzZVBhdHRlcm4oYFxuICAgIHxFRUUgICAuLnxcbiAgICB8RS4uICAgLiN8XG4gICAgfEVFIFkuWS4jfFxuICAgIHxFLi5ZLlkuI3xcbiAgICB8RUVFLlkuLiN8XG4gICAgfC4uLiBZLi4jfFxuICAgIHwgICAgWS4uLnxcbiAgICB8ICAgICAgICB8XG4gIGAsIHsnICc6IDIsICdFJzogMSwgJ1knOiAxLCAnIyc6IDEsICcuJzogM30pO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9MViA9IHBhcnNlUGF0dGVybihgXG4gICAgfCAgICAgICAgfFxuICAgIHxMICAgICAgIHxcbiAgICB8TC4gICAgICB8XG4gICAgfEwuIHYuIHYufFxuICAgIHxMLiB2LiB2LnxcbiAgICB8TExMIHZ2LiB8XG4gICAgfCAuLi4gdi4gfFxuICAgIHwgICAgIC4gIHxcbiAgYCwgeycgJzogMiwgJ0wnOiAxLCAndic6IDEsICcuJzogM30pO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9ETCA9IHBhcnNlUGF0dGVybihgXG4gICAgfCAgICAgICAgfFxuICAgIHxERCAgICAgIHxcbiAgICB8RC5ELkwgICB8XG4gICAgfEQuRC5MLiAgfFxuICAgIHxELkQuTC4gIHxcbiAgICB8REQuIEwuICB8XG4gICAgfCAuICBMTEwgfFxuICAgIHwgICAgIC4uLnxcbiAgYCwgeycgJzogMiwgJ0QnOiAxLCAnTCc6IDEsICcuJzogM30pO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9NUCA9IHBhcnNlUGF0dGVybihgXG4gICAgfE0uICBNICAgfFxuICAgIHxNTS5NTS4gIHxcbiAgICB8TS5NLk0uICB8XG4gICAgfE0uIC5QUFAgfFxuICAgIHxNLiAuUC4uUHxcbiAgICB8ICAgIFBQUC58XG4gICAgfCAgICBQLi4gfFxuICAgIHwgICAgUC4gIHxcbiAgYCwgeycgJzogMiwgJ00nOiAxLCAnUCc6IDEsICcuJzogM30pO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9FWCA9IHBhcnNlUGF0dGVybihgXG4gICAgfEVFRSAgICAgfFxuICAgIHxFLi4uICAgIHxcbiAgICB8RUVFICAgICB8XG4gICAgfEUuLi4gICAgfFxuICAgIHxFRUUgeC54LnxcbiAgICB8IC4uLiB4LiB8XG4gICAgfCAgICB4LngufFxuICAgIHwgICAgIC4gLnxcbiAgYCwgeycgJzogMiwgJ0UnOiAxLCAneCc6IDEsICcuJzogM30pO1xufVxuXG5mdW5jdGlvbiBwYXJzZVBhdHRlcm4oZGF0YTogU3RyaW5nLCBrZXk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4pOiBudW1iZXJbXSB7XG4gIGNvbnN0IHRleHQgPSBkYXRhLnRyaW0oKS5yZXBsYWNlKC9eW158XSpcXHx8XFx8W158XSokL21nLCAnJykucmVwbGFjZSgvXFxuL2csICcnKTtcbiAgaWYgKHRleHQubGVuZ3RoICE9PSA2NCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgQ0hSIHRpbGU6ICR7dGV4dH1gKTtcbiAgY29uc3QgYXJyOiBudW1iZXJbXSA9IG5ldyBBcnJheSgxNikuZmlsbCgwKTtcbiAgZm9yIChsZXQgaSA9IDAsIGMgPSAnJzsgYyA9IHRleHQuY2hhckF0KGkpOyArK2kpIHtcbiAgICBjb25zdCBvZmYgPSBpID4+PiAzO1xuICAgIGNvbnN0IGxvID0gb2ZmO1xuICAgIGNvbnN0IGhpID0gb2ZmIHwgODtcbiAgICBjb25zdCBjb2wgPSB+aSAmIDc7XG4gICAgY29uc3QgdmFsID0ga2V5W2NdIHx8IDA7XG4gICAgaWYgKHZhbCAmIDEpIHtcbiAgICAgIGFycltsb10gfD0gMSA8PCBjb2w7XG4gICAgfVxuICAgIGlmICh2YWwgJiAyKSB7XG4gICAgICBhcnJbaGldIHw9IDEgPDwgY29sO1xuICAgIH1cbiAgfVxuICByZXR1cm4gYXJyO1xufVxuXG5leHBvcnQgZW51bSBGbGlwIHtcbiAgSE9SSVpPTlRBTCA9IDB4NDAsXG4gIFZFUlRJQ0FMID0gMHg4MCxcbn1cbiJdfQ==