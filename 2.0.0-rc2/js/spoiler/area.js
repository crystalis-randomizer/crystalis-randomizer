import { LocationMap } from './locationmap.js';
import { Terrain, debugLabel } from '../logic/terrain.js';
import { hex } from '../rom/util.js';
export class Area {
    constructor(rom, world) {
        this.rom = rom;
        this.world = world;
        this.element = document.createElement('div');
        this.element.addEventListener('click', (e) => this.click(e));
        this.element.addEventListener('mousemove', (e) => this.move(e));
        this.renderArea(0);
    }
    click(e) {
        const data = LocationMap.getData(e);
        if (!data)
            return;
        let tile = this.world.tiles.get(data.tile);
        if (tile == null)
            return;
        if (tile.area === this.area) {
            const exit = tile.exit != null ? this.world.tiles.get(tile.exit) : null;
            if (exit && exit.area !== this.area) {
                tile = exit;
            }
        }
        if (tile.area && tile.area !== this.area) {
            this.renderArea(tile.area.id);
        }
    }
    move(e) {
        const data = LocationMap.getData(e);
        if (!data)
            return;
        const tile = this.world.tiles.get(data.tile);
        if (tile == null)
            return;
        const exit = tile.exit != null && !this.area.tiles.has(tile.exit);
        data.target.element.style.cursor = exit ? 'pointer' : 'default';
    }
    clear() {
        while (this.element.childNodes.length) {
            this.element.childNodes[0].remove();
        }
    }
    renderArea(index) {
        var _a;
        this.clear();
        const select = document.createElement('select');
        select.appendChild(document.createElement('option'));
        select.children[0].textContent = 'Select location';
        for (const loc of this.rom.locations) {
            if (!loc.used)
                continue;
            const area = (_a = this.world.locations[loc.id]) === null || _a === void 0 ? void 0 : _a.areas[Symbol.iterator]().next().value;
            if (area == null)
                continue;
            const option = document.createElement('option');
            option.textContent = `${hex(loc.id)} ${loc.name}`;
            option.value = String(area.id);
            select.appendChild(option);
        }
        select.addEventListener('change', () => {
            this.renderArea(Number(select.value));
        });
        this.element.appendChild(select);
        this.area = this.world.areas[index];
        const info = document.createElement('pre');
        info.textContent = `Area ${index}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${Terrain.label(this.area.terrain, this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([flag, req]) => `${flag.debug}: ${debugLabel(req, this.rom)}`))]
            .join('\n  ')}
Routes:
  ${debugLabel(this.area.routes, this.rom).split(' | ').join('\n  ')
            .replace(/[()]/g, '')}`;
        this.element.appendChild(info);
        for (const l of this.area.locations) {
            const location = this.rom.locations[l];
            const title = document.createElement('h2');
            title.textContent = location.name;
            this.element.appendChild(title);
            this.element.appendChild(this.makeLocation(this.area, location));
        }
    }
    makeLocation(area, location) {
        const map = new LocationMap(this.rom, location.id);
        map.maxWidth = 574;
        map.overlayShade(0x55000000);
        for (const a of this.world.locations[location.id].areas) {
            if (a !== area)
                map.overlayArea(a.tiles, 0xffff0000);
        }
        map.overlayArea(area.tiles, 0xff00ffff, 0);
        map.render();
        return map.element;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJlYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9zcG9pbGVyL2FyZWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBQzdDLE9BQU8sRUFBQyxPQUFPLEVBQUUsVUFBVSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFJeEQsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBUW5DLE1BQU0sT0FBTyxJQUFJO0lBS2YsWUFBcUIsR0FBUSxFQUFXLEtBQWdCO1FBQW5DLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFBVyxVQUFLLEdBQUwsS0FBSyxDQUFXO1FBQ3RELElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLENBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBYSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRUQsS0FBSyxDQUFDLENBQWE7UUFDakIsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsSUFBSTtZQUFFLE9BQU87UUFDbEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxJQUFJLElBQUks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QztRQUMzQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDYixPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUM7SUFDckIsQ0FBQztDQVFGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMb2NhdGlvbk1hcH0gZnJvbSAnLi9sb2NhdGlvbm1hcC5qcyc7XG5pbXBvcnQge1RlcnJhaW4sIGRlYnVnTGFiZWx9IGZyb20gJy4uL2xvZ2ljL3RlcnJhaW4uanMnO1xuaW1wb3J0IHtBcmVhRGF0YSwgV29ybGREYXRhfSBmcm9tICcuLi9sb2dpYy93b3JsZC5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5pbXBvcnQge2hleH0gZnJvbSAnLi4vcm9tL3V0aWwuanMnO1xuXG4vLyBCYXNpYyBpZGVhOiBhIHNpbXBsZSBjb250cm9sbGVyIHdpdGggYSBuYXZpZ2FibGUgY2FudmFzLlxuLy8gICBDaGVja3M6IFtMZWFmIEVsZGVyIOKWvV1cbi8vICAgQXJlYXM6IFsxLiBNZXphbWUgU2hyaW5lICgrIDUgb3RoZXJzKSAyMDQwIHRpbGVzIOKWvV1cbi8vICAgTG9jYXRpb25zOiBbMDAgTWV6YW1lIFNocmluZSDilr1dXG4vLyAgIE1hcCBvZiAxIG9yIG1vcmUgbG9jYXRpb25zIC4uLlxuXG5leHBvcnQgY2xhc3MgQXJlYSB7XG5cbiAgYXJlYSE6IEFyZWFEYXRhO1xuICBlbGVtZW50OiBIVE1MRGl2RWxlbWVudDtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSwgcmVhZG9ubHkgd29ybGQ6IFdvcmxkRGF0YSkge1xuICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlOiBNb3VzZUV2ZW50KSA9PiB0aGlzLmNsaWNrKGUpKTtcbiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGU6IE1vdXNlRXZlbnQpID0+IHRoaXMubW92ZShlKSk7XG4gICAgdGhpcy5yZW5kZXJBcmVhKDApO1xuICB9XG5cbiAgY2xpY2soZTogTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGRhdGEgPSBMb2NhdGlvbk1hcC5nZXREYXRhKGUpO1xuICAgIGlmICghZGF0YSkgcmV0dXJuO1xuICAgIGxldCB0aWxlID0gdGhpcy53b3JsZC50aWxlcy5nZXQoZGF0YS50aWxlKTtcbiAgICBpZiAodGlsZSA9PSBudWxsKSByZXR1cm47XG4vLyAgICAgY29uc29sZS5sb2coYFRpbGU6ICR7ZGF0YS50aWxlLnRvU3RyaW5nKDE2KS5wYWRTdGFydCg2LCAnMCcpfVxuLy8gYXJlYTogJHt0aWxlLmFyZWF9IGV4aXQ6ICR7dGlsZS5leGl0Py50b1N0cmluZygxNikucGFkU3RhcnQoNiwgJzAnKX1cbi8vIGAsIHRpbGUpO1xuICAgIGlmICh0aWxlLmFyZWEgPT09IHRoaXMuYXJlYSkge1xuICAgICAgY29uc3QgZXhpdCA9IHRpbGUuZXhpdCAhPSBudWxsID8gdGhpcy53b3JsZC50aWxlcy5nZXQodGlsZS5leGl0KSA6IG51bGw7XG4gICAgICBpZiAoZXhpdCAmJiBleGl0LmFyZWEgIT09IHRoaXMuYXJlYSkge1xuICAgICAgICB0aWxlID0gZXhpdDtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRpbGUuYXJlYSAmJiB0aWxlLmFyZWEgIT09IHRoaXMuYXJlYSkge1xuICAgICAgdGhpcy5yZW5kZXJBcmVhKHRpbGUuYXJlYS5pZCk7XG4gICAgfVxuICB9XG5cbiAgbW92ZShlOiBNb3VzZUV2ZW50KSB7XG4gICAgY29uc3QgZGF0YSA9IExvY2F0aW9uTWFwLmdldERhdGEoZSk7XG4gICAgaWYgKCFkYXRhKSByZXR1cm47XG4gICAgY29uc3QgdGlsZSA9IHRoaXMud29ybGQudGlsZXMuZ2V0KGRhdGEudGlsZSk7XG4gICAgaWYgKHRpbGUgPT0gbnVsbCkgcmV0dXJuO1xuICAgIGNvbnN0IGV4aXQgPSB0aWxlLmV4aXQgIT0gbnVsbCAmJiAhdGhpcy5hcmVhLnRpbGVzLmhhcyh0aWxlLmV4aXQpO1xuICAgIGRhdGEudGFyZ2V0LmVsZW1lbnQuc3R5bGUuY3Vyc29yID0gZXhpdCA/ICdwb2ludGVyJyA6ICdkZWZhdWx0JztcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIHdoaWxlICh0aGlzLmVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZWxlbWVudC5jaGlsZE5vZGVzWzBdLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJlbmRlckFyZWEoaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzZWxlY3QnKTtcbiAgICBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpO1xuICAgIHNlbGVjdC5jaGlsZHJlblswXS50ZXh0Q29udGVudCA9ICdTZWxlY3QgbG9jYXRpb24nO1xuICAgIGZvciAoY29uc3QgbG9jIG9mIHRoaXMucm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsb2MudXNlZCkgY29udGludWU7XG4gICAgICBjb25zdCBhcmVhID1cbiAgICAgICAgICB0aGlzLndvcmxkLmxvY2F0aW9uc1tsb2MuaWRdPy5hcmVhc1tTeW1ib2wuaXRlcmF0b3JdKCkubmV4dCgpLnZhbHVlO1xuICAgICAgaWYgKGFyZWEgPT0gbnVsbCkgY29udGludWU7XG4gICAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcbiAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IGAke2hleChsb2MuaWQpfSAke2xvYy5uYW1lfWA7XG4gICAgICBvcHRpb24udmFsdWUgPSBTdHJpbmcoYXJlYS5pZCk7XG4gICAgICBzZWxlY3QuYXBwZW5kQ2hpbGQob3B0aW9uKTtcbiAgICB9XG4gICAgc2VsZWN0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpID0+IHtcbiAgICAgIHRoaXMucmVuZGVyQXJlYShOdW1iZXIoc2VsZWN0LnZhbHVlKSk7XG4gICAgfSk7XG4gICAgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKHNlbGVjdCk7XG4gICAgdGhpcy5hcmVhID0gdGhpcy53b3JsZC5hcmVhc1tpbmRleF07XG4gICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ByZScpO1xuICAgIGluZm8udGV4dENvbnRlbnQgPSBgQXJlYSAke2luZGV4fVxuTG9jYXRpb25zOiAke3RoaXMuYXJlYS5sb2NhdGlvbnMuc2l6ZX1cblRpbGVzOiAke3RoaXMuYXJlYS50aWxlcy5zaXplfVxuVGVycmFpbjogJHtUZXJyYWluLmxhYmVsKHRoaXMuYXJlYS50ZXJyYWluLCB0aGlzLnJvbSl9XG5DaGVja3M6XG4gICR7Wy4uLm5ldyBTZXQodGhpcy5hcmVhLmNoZWNrcy5tYXAoKFtmbGFnLCByZXFdKSA9PlxuICAgICAgICAgICAgICAgICAgICAgYCR7ZmxhZy5kZWJ1Z306ICR7ZGVidWdMYWJlbChyZXEsIHRoaXMucm9tKX1gKSldXG4gICAgICAgICAgICAgICAuam9pbignXFxuICAnKX1cblJvdXRlczpcbiAgJHtkZWJ1Z0xhYmVsKHRoaXMuYXJlYS5yb3V0ZXMsIHRoaXMucm9tKS5zcGxpdCgnIHwgJykuam9pbignXFxuICAnKVxuICAgIC5yZXBsYWNlKC9bKCldL2csICcnKX1gO1xuICAgIHRoaXMuZWxlbWVudC5hcHBlbmRDaGlsZChpbmZvKTtcbiAgICBmb3IgKGNvbnN0IGwgb2YgdGhpcy5hcmVhLmxvY2F0aW9ucykge1xuICAgICAgY29uc3QgbG9jYXRpb24gPSB0aGlzLnJvbS5sb2NhdGlvbnNbbF07XG4gICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gyJyk7XG4gICAgICB0aXRsZS50ZXh0Q29udGVudCA9IGxvY2F0aW9uLm5hbWU7XG4gICAgICB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQodGl0bGUpO1xuICAgICAgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKHRoaXMubWFrZUxvY2F0aW9uKHRoaXMuYXJlYSwgbG9jYXRpb24pKTtcbiAgICB9XG4gIH1cblxuICBtYWtlTG9jYXRpb24oYXJlYTogQXJlYURhdGEsIGxvY2F0aW9uOiBMb2NhdGlvbik6IEhUTUxEaXZFbGVtZW50IHtcbiAgICBjb25zdCBtYXAgPSBuZXcgTG9jYXRpb25NYXAodGhpcy5yb20sIGxvY2F0aW9uLmlkKTtcbiAgICBtYXAubWF4V2lkdGggPSA1NzQ7XG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGxvY2F0aW9ucyBhbmQgYWRkIHllbGxvdyBib3JkZXJzLlxuICAgIG1hcC5vdmVybGF5U2hhZGUoMHg1NTAwMDAwMCk7XG4gICAgZm9yIChjb25zdCBhIG9mIHRoaXMud29ybGQubG9jYXRpb25zW2xvY2F0aW9uLmlkXS5hcmVhcykge1xuICAgICAgaWYgKGEgIT09IGFyZWEpIG1hcC5vdmVybGF5QXJlYShhLnRpbGVzLCAweGZmZmYwMDAwKTtcbiAgICB9XG4gICAgbWFwLm92ZXJsYXlBcmVhKGFyZWEudGlsZXMsIDB4ZmYwMGZmZmYsIDApO1xuICAgIG1hcC5yZW5kZXIoKTtcbiAgICByZXR1cm4gbWFwLmVsZW1lbnQ7XG4gIH1cblxuICAvLyBUT0RPIC0gY2xpY2sgaGFuZGxlcnMgZm9yIHdvcmxkLi4uP1xuICAvLyAgICAgIC0gZmllbGQgdmlzaWJpbGl0eSBpcyBhbiBpc3N1ZS4uLlxuICAvLyAgICAgIC0gdG9nZ2xlIG91dCB0byBkaWZmZXJlbnQgYXJlYSB3aGVuIGNsaWNrIG9uIGl0XG4gIC8vICAgICAgLSBsaXN0IGFsbCBjaGVja3MsIG5laWdoYm9ycz8gIChjbGljayBoYW5kbGVycyBvbiBsaXN0PylcblxuICAvLyBtb2RlIHRoYXQgb25seSBzaG93cyBhIGxvY2F0aW9uIGFuZCBubyBhcmVhcywgY2xpY2sgdG8gZmluZCBhcmVhLlxufVxuIl19