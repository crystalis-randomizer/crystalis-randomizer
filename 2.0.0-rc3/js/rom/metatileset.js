import { DefaultMap } from '../util.js';
import { featureMask } from './metascreendata.js';
export class Metatilesets {
    constructor(rom) {
        this.rom = rom;
        this._all = [];
        this.grass = this.tileset(0x80, {
            patterns: [0x00, 0x0c],
        });
        this.town = this.tileset(0x84, {});
        this.cave = this.tileset(0x88, {});
        this.dolphinCave = this.tileset(0x88, {});
        this.pyramid = this.tileset(0x8c, {});
        this.river = this.tileset(0x90, {
            animated: [0, 1],
            patterns: [0x14, 0x00],
        });
        this.sea = this.tileset(0x94, {});
        this.lime = this.tileset(0x94, {});
        this.mountain = this.tileset(0x94, {});
        this.shrine = this.tileset(0x98, {});
        this.desert = this.tileset(0x9c, {});
        this.mountainRiver = this.tileset(0x9c, {});
        this.swamp = this.tileset(0xa0, {
            consolidated: true,
        });
        this.house = this.tileset(0xa0, {});
        this.fortress = this.tileset(0xa4, {});
        this.labyrinth = this.tileset(0xa4, {});
        this.iceCave = this.tileset(0xa8, {});
        this.tower = this.tileset(0xac, {});
        for (const key in this) {
            const value = this[key];
            if (value instanceof Metatileset)
                value.name = key;
        }
    }
    tileset(id, opts) {
        const ts = new Metatileset(this.rom, id, opts);
        this._all.push(ts);
        return ts;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
export class Metatileset {
    constructor(rom, tilesetId, data) {
        this.rom = rom;
        this.tilesetId = tilesetId;
        this.data = data;
        this._screens = new Set();
        this._cache = undefined;
    }
    [Symbol.iterator]() {
        return this._screens[Symbol.iterator]();
    }
    get cache() {
        if (!this._cache)
            this._cache = new NeighborCache(this);
        return this._cache;
    }
    get tileset() {
        return this.rom.tilesets[this.tilesetId];
    }
    get empty() {
        const e = this.cache.empty;
        if (!e)
            throw new Error(`No empty screen for ${this.name}`);
        return e;
    }
    effects() {
        return this.tileset.effects();
    }
    getTile(id) {
        return this.tileset.getTile(id);
    }
    addScreen(screen) {
        this._screens.add(screen);
        screen.unsafeAddTileset(this);
        this.invalidate();
    }
    deleteScreen(screen) {
        this._screens.delete(screen);
        screen.unsafeRemoveTileset(this);
        this.invalidate();
    }
    getMetascreens(screenId) {
        var _a;
        return (_a = this.cache.fromId.get(screenId)) !== null && _a !== void 0 ? _a : [];
    }
    getExits(type) {
        return this.cache.exits.get(type);
    }
    getMetascreensFromTileString(tile) {
        return this.cache.tiles.has(tile) ? this.cache.tiles.get(tile) : [];
    }
    getScreensWithOnlyFeatures(...features) {
        let mask = 0;
        for (const feature of features) {
            mask |= featureMask[feature];
        }
        const screens = [];
        for (const s of this) {
            if (!(s.features & ~mask))
                screens.push(s);
        }
        return screens;
    }
    withMod(tile, mod) {
        const out = [];
        for (const s of this.cache.tiles.get(tile)) {
            if (s.data.mod === mod)
                out.push(s);
        }
        return out;
    }
    unreachableVariant(screen) {
        for (const s of this) {
            if (s.sid === screen.sid && s.isEmpty())
                return s;
        }
        return screen;
    }
    isBannedVertical(above, below) {
        return this.cache.bannedNeighbors[0].has(above.uid << 16 | below.uid);
    }
    isBannedHorizontal(left, right) {
        return this.cache.bannedNeighbors[1].has(left.uid << 16 | right.uid);
    }
    invalidate() {
        this._cache = undefined;
    }
}
export var Dir;
(function (Dir) {
    Dir.N = 0;
    Dir.W = 1;
    Dir.S = 2;
    Dir.E = 3;
})(Dir || (Dir = {}));
class NeighborCache {
    constructor(tileset) {
        var _a, _b;
        this.tileset = tileset;
        this.fromId = new DefaultMap(() => []);
        this.exits = new DefaultMap(() => []);
        this.tiles = new DefaultMap(() => []);
        this.bannedNeighbors = [new Set(), new Set()];
        let empty = undefined;
        for (const s of tileset) {
            if (s.sid >= 0)
                this.fromId.get(s.sid).push(s);
            if (!empty &&
                s.data.edges === '    ' &&
                s.data.placement !== 'manual' &&
                s.hasFeature('empty') &&
                !((_a = s.data.exits) === null || _a === void 0 ? void 0 : _a.length)) {
                empty = s;
            }
            for (const exit of (_b = s.data.exits) !== null && _b !== void 0 ? _b : []) {
                this.exits.get(exit.type).push(s);
            }
            const tiles = typeof s.data.tile === 'string' ? [s.data.tile] : s.data.tile;
            for (const tile of tiles !== null && tiles !== void 0 ? tiles : []) {
                this.tiles.get(tile.replace(/\|/g, '')).push(s);
            }
            if (s.hasFeature('ramp') ||
                s.hasFeature('overpass') || s.hasFeature('pit') ||
                s.isEmpty()) {
                this.banDeadEndNeighbor(s);
            }
            const ms = tileset.rom.metascreens;
            this.banDeadEndNeighbor(ms.branchNWE_wall, 1);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndNS_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndNS_stairs, 2);
        }
        this.empty = empty !== null && empty !== void 0 ? empty : tileset.rom.metascreens.caveEmpty;
    }
    banDeadEndNeighbor(s, dirs = 15) {
        var _a, _b;
        for (const t of this.tileset) {
            if (!t.hasFeature('deadend'))
                continue;
            for (let dir = 0; dir < 4; dir++) {
                const mask = 1 << dir;
                if (!(dirs & mask))
                    continue;
                if (((_a = s.data.edges) === null || _a === void 0 ? void 0 : _a[dir]) !== ' ' && ((_b = t.data.edges) === null || _b === void 0 ? void 0 : _b[dir ^ 2]) !== ' ') {
                    this.banNeighbor(s, t, dir);
                }
            }
        }
    }
    banNeighbor(s, t, dir) {
        this.bannedNeighbors[dir & 1]
            .add((dir & 2 ? s : t).uid << 16 | (dir & 2 ? t : s).uid);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXRpbGVzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL21ldGF0aWxlc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUEwQixXQUFXLEVBQ3JCLE1BQU0scUJBQXFCLENBQUM7QUFHbkQsTUFBTSxPQUFPLFlBQVk7SUFxRHZCLFlBQTZCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBbkQ3QixTQUFJLEdBQWtCLEVBQUUsQ0FBQztRQUV4QixVQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDbEMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztTQUN2QixDQUFDLENBQUM7UUFFTSxTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFHOUIsU0FBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTlCLGdCQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFckMsWUFBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUNsQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7U0FDdkIsQ0FBQyxDQUFDO1FBRU0sUUFBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTdCLFNBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxF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QUM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7b0JBQUUsU0FBUztnQkFDN0IsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSywwQ0FBRyxHQUFHLE9BQU0sR0FBRyxJQUFJLE9BQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLDBDQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU0sR0FBRyxFQUFFO29CQUNsRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7aUJBQzdCO2FBQ0Y7U0FDRjtJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsQ0FBYSxFQUFFLENBQWEsRUFBRSxHQUFXO1FBQ25ELElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQzthQUN4QixHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7Q0FRRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtNZXRhc2NyZWVufSBmcm9tICcuL21ldGFzY3JlZW4uanMnO1xuaW1wb3J0IHtNZXRhdGlsZX0gZnJvbSAnLi9tZXRhdGlsZS5qcyc7XG5pbXBvcnQge1RpbGVFZmZlY3RzfSBmcm9tICcuL3RpbGVlZmZlY3RzLmpzJztcbmltcG9ydCB7VGlsZXNldH0gZnJvbSAnLi90aWxlc2V0LmpzJztcbmltcG9ydCB7RGVmYXVsdE1hcH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5pbXBvcnQge0Nvbm5lY3Rpb25UeXBlLCBGZWF0dXJlLCBmZWF0dXJlTWFzayxcbiAgICAgICAgTWV0YXNjcmVlbkRhdGF9IGZyb20gJy4vbWV0YXNjcmVlbmRhdGEuanMnO1xuXG4vLyBOT1RFOiBNdXN0IGJlIGluaXRpYWxpemVkIEJFRk9SRSBNZXRhc2NyZWVuc1xuZXhwb3J0IGNsYXNzIE1ldGF0aWxlc2V0cyBpbXBsZW1lbnRzIEl0ZXJhYmxlPE1ldGF0aWxlc2V0PiB7XG5cbiAgcHJpdmF0ZSBfYWxsOiBNZXRhdGlsZXNldFtdID0gW107XG5cbiAgcmVhZG9ubHkgZ3Jhc3MgPSB0aGlzLnRpbGVzZXQoMHg4MCwge1xuICAgIHBhdHRlcm5zOiBbMHgwMCwgMHgwY10sXG4gIH0pO1xuXG4gIHJlYWRvbmx5IHRvd24gPSB0aGlzLnRpbGVzZXQoMHg4NCwge30pO1xuXG4gIC8vIHN1cHBvcnRzIHdhdGVyLCBidXQgaGFzIHVnbHkgd2FsbFxuICByZWFkb25seSBjYXZlID0gdGhpcy50aWxlc2V0KDB4ODgsIHt9KTtcblxuICByZWFkb25seSBkb2xwaGluQ2F2ZSA9IHRoaXMudGlsZXNldCgweDg4LCB7fSk7XG5cbiAgcmVhZG9ubHkgcHlyYW1pZCA9IHRoaXMudGlsZXNldCgweDhjLCB7fSk7XG5cbiAgcmVhZG9ubHkgcml2ZXIgPSB0aGlzLnRpbGVzZXQoMHg5MCwge1xuICAgIGFuaW1hdGVkOiBbMCwgMV0sXG4gICAgcGF0dGVybnM6IFsweDE0LCAweDAwXSwgLy8gVE9ETyAtIGFuaW1hdGVkIGNsb2JiZXJzIDJuZCBlbnRyeSBhbnl3YXlcbiAgfSk7XG5cbiAgcmVhZG9ubHkgc2VhID0gdGhpcy50aWxlc2V0KDB4OTQsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDgwLi5mZlxuXG4gIHJlYWRvbmx5IGxpbWUgPSB0aGlzLnRpbGVzZXQoMHg5NCwge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgNjAuLjdmXG5cbiAgLy8gcGFydHMgd2l0aCBcImZlYXR1cmVzXCI6IGFyY2hlcyBhbmQgaG91c2VzXG4gIHJlYWRvbmx5IG1vdW50YWluID0gdGhpcy50aWxlc2V0KDB4OTQsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDAuLjVmXG5cbiAgLy8gTk9URTogZnJlZSBzcGFjZSBmcm9tIDkwLi5mZlxuICByZWFkb25seSBzaHJpbmUgPSB0aGlzLnRpbGVzZXQoMHg5OCwge30pO1xuXG4gIHJlYWRvbmx5IGRlc2VydCA9IHRoaXMudGlsZXNldCgweDljLCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyA1MC4uZmZcblxuICAvLyB0cmFkZXMgZmVhdHVyZXMgZm9yIGNyb3NzYWJsZSByaXZlclxuICByZWFkb25seSBtb3VudGFpblJpdmVyID0gdGhpcy50aWxlc2V0KDB4OWMsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDAwLi40ZlxuXG4gIHJlYWRvbmx5IHN3YW1wID0gdGhpcy50aWxlc2V0KDB4YTAsIHtcbiAgICBjb25zb2xpZGF0ZWQ6IHRydWUsXG4gIH0pOyAvLyB0aWxlcyBhMC4uZmZcblxuICByZWFkb25seSBob3VzZSA9IHRoaXMudGlsZXNldCgweGEwLCB7fSk7IC8vIHRpbGVzIDAwLi45ZlxuXG4gIHJlYWRvbmx5IGZvcnRyZXNzID0gdGhpcy50aWxlc2V0KDB4YTQsIHt9KTtcblxuICAvLyB2YXJpYW50IG9mIHRoZSBmb3J0cmVzcyBtZXRhdGlsZXNldCwgYnV0IG1ha2VzIHVzZSBvZiB0aGUgcGFyYXBldHNcbiAgcmVhZG9ubHkgbGFieXJpbnRoID0gdGhpcy50aWxlc2V0KDB4YTQsIHt9KTtcblxuICAvLyBzYW1lIGFzIDg4LCBidXQgdHJhZGVzIHJpdmVycyBmb3IgcHJldHRpZXIgaWNlIHdhbGxcbiAgcmVhZG9ubHkgaWNlQ2F2ZSA9IHRoaXMudGlsZXNldCgweGE4LCB7fSk7XG5cbiAgcmVhZG9ubHkgdG93ZXIgPSB0aGlzLnRpbGVzZXQoMHhhYywge30pO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICAvLyBUYWcgbmFtZXMgZm9yIGRlYnVnZ2luZy4uLlxuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMgYXMgb2JqZWN0KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9ICh0aGlzIGFzIGFueSlba2V5XSBhcyB1bmtub3duO1xuICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgTWV0YXRpbGVzZXQpIHZhbHVlLm5hbWUgPSBrZXk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0aWxlc2V0KGlkOiBudW1iZXIsIG9wdHM6IE1ldGF0aWxlc2V0RGF0YSk6IE1ldGF0aWxlc2V0IHtcbiAgICBjb25zdCB0cyA9IG5ldyBNZXRhdGlsZXNldCh0aGlzLnJvbSwgaWQsIG9wdHMpO1xuICAgIHRoaXMuX2FsbC5wdXNoKHRzKTtcbiAgICByZXR1cm4gdHM7XG4gIH1cblxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWxsW1N5bWJvbC5pdGVyYXRvcl0oKTtcbiAgfVxufVxuXG4vLyBNYXBwcGluZyBmcm9tIG1ldGF0aWxlIElEIHRvIHRpbGUgcXVhZHMgYW5kIHBhbGV0dGUgbnVtYmVyLlxuZXhwb3J0IGNsYXNzIE1ldGF0aWxlc2V0IGltcGxlbWVudHMgSXRlcmFibGU8TWV0YXNjcmVlbj4ge1xuXG4gIC8vIFRPRE8gLSBtYWludGFpbiBhbiBpbnZhcmlhbnQgTWFwPHNjcmVlbi1pZCwgU2V0PE1ldGFzY3JlZW4+PixcbiAgLy8gICAgICAgIHdpbGwgbmVlZCB0byBsb2NrIGRvd24gKG1ldGEpc2NyZWVuIElEIGZpZWxkIHRvIGVuc3VyZVxuICAvLyAgICAgICAgaW52YXJpYW50IGlzIGtlcHQuXG5cbiAgLy8gVE9ETyAtIHBlcm1hbmVudGx5IGF0dGFjaCBiZWhhdmlvclxuICAvLyBTdG9yZSBtb3JlIGluZm9ybWF0aW9uLCBzdWNoIGFzIHNjcmVlbiB0eXBlcywgZWRnZSB0eXBlcywgZXRjLlxuICAvLyBOYW1lcy4uLlxuICAvLyBEb2VzIHBhbGV0dGUgaW5mbyBiZWxvbmcgaGVyZT8gIE1heWJlLi4uXG5cbiAgbmFtZT86IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBfc2NyZWVucyA9IG5ldyBTZXQ8TWV0YXNjcmVlbj4oKTtcbiAgcHJpdmF0ZSBfY2FjaGU/OiBOZWlnaGJvckNhY2hlID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tLFxuICAgICAgICAgICAgICByZWFkb25seSB0aWxlc2V0SWQ6IG51bWJlcixcbiAgICAgICAgICAgICAgcmVhZG9ubHkgZGF0YTogTWV0YXRpbGVzZXREYXRhKSB7fVxuXG4gIFtTeW1ib2wuaXRlcmF0b3JdKCkge1xuICAgIHJldHVybiB0aGlzLl9zY3JlZW5zW1N5bWJvbC5pdGVyYXRvcl0oKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNhY2hlKCk6IE5laWdoYm9yQ2FjaGUge1xuICAgIGlmICghdGhpcy5fY2FjaGUpIHRoaXMuX2NhY2hlID0gbmV3IE5laWdoYm9yQ2FjaGUodGhpcyk7XG4gICAgcmV0dXJuIHRoaXMuX2NhY2hlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHVuZGVybHlpbmcgcGh5c2ljYWwgdGlsZXNldC4gIE11bHRpcGxlIE1ldGF0aWxlc2V0c1xuICAgKiBtYXkgc2hhcmUgdGhlIHNhbWUgcGh5c2ljYWwgdGlsZXNldC5cbiAgICovXG4gIGdldCB0aWxlc2V0KCk6IFRpbGVzZXQge1xuICAgIHJldHVybiB0aGlzLnJvbS50aWxlc2V0c1t0aGlzLnRpbGVzZXRJZF07XG4gIH1cblxuICBnZXQgZW1wdHkoKTogTWV0YXNjcmVlbiB7XG4gICAgY29uc3QgZSA9IHRoaXMuY2FjaGUuZW1wdHk7XG4gICAgaWYgKCFlKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGVtcHR5IHNjcmVlbiBmb3IgJHt0aGlzLm5hbWV9YCk7XG4gICAgcmV0dXJuIGU7XG4gIH1cblxuICAvLyBUT0RPIC0gdXNlIEVNUFRZIGFzIGEgYm9yZGVyIHNxdWFyZS4uLiBhbHNvIG5lZWRcbiAgLy8gYW4gRVhJVCBib3JkZXIgc3F1YXJlPyAgSG93IHRvIGxpbmsgdGhpcyBpbnRvXG4gIC8vIFwiYWxsb3dlZFwiPyAgbmVlZHMgdG8gbGluayB0byBjaGVjayBleGl0cyBvbiBlZGdlLlxuICAvLyAgIC0gc28gc3RpbGwgcHJvYmFibHkgd2FudCBhbiBFWElUIG1ldGFzY3JlZW4/XG5cbiAgZWZmZWN0cygpOiBUaWxlRWZmZWN0cyB7XG4gICAgcmV0dXJuIHRoaXMudGlsZXNldC5lZmZlY3RzKCk7XG4gIH1cblxuICAvLyBGb3J3YXJkIHRvIHRoZSB1bmRlcmx5aW5nIFRpbGVzZXQuXG4gIGdldFRpbGUoaWQ6IG51bWJlcik6IE1ldGF0aWxlIHtcbiAgICByZXR1cm4gdGhpcy50aWxlc2V0LmdldFRpbGUoaWQpO1xuICB9XG5cbiAgYWRkU2NyZWVuKHNjcmVlbjogTWV0YXNjcmVlbikge1xuICAgIHRoaXMuX3NjcmVlbnMuYWRkKHNjcmVlbik7XG4gICAgc2NyZWVuLnVuc2FmZUFkZFRpbGVzZXQodGhpcyk7XG4gICAgdGhpcy5pbnZhbGlkYXRlKCk7XG4gIH1cblxuICBkZWxldGVTY3JlZW4oc2NyZWVuOiBNZXRhc2NyZWVuKSB7XG4gICAgdGhpcy5fc2NyZWVucy5kZWxldGUoc2NyZWVuKTtcbiAgICBzY3JlZW4udW5zYWZlUmVtb3ZlVGlsZXNldCh0aGlzKTtcbiAgICB0aGlzLmludmFsaWRhdGUoKTtcbiAgfVxuXG4gIGdldE1ldGFzY3JlZW5zKHNjcmVlbklkOiBudW1iZXIpOiBSZWFkb25seUFycmF5PE1ldGFzY3JlZW4+IHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5mcm9tSWQuZ2V0KHNjcmVlbklkKSA/PyBbXTtcbiAgfVxuXG4gIGdldEV4aXRzKHR5cGU6IENvbm5lY3Rpb25UeXBlKTogUmVhZG9ubHlBcnJheTxNZXRhc2NyZWVuPiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuZXhpdHMuZ2V0KHR5cGUpO1xuICB9XG5cbiAgZ2V0TWV0YXNjcmVlbnNGcm9tVGlsZVN0cmluZyh0aWxlOiBzdHJpbmcpOiByZWFkb25seSBNZXRhc2NyZWVuW10ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLnRpbGVzLmhhcyh0aWxlKSA/IHRoaXMuY2FjaGUudGlsZXMuZ2V0KHRpbGUpIDogW107XG4gIH1cblxuICBnZXRTY3JlZW5zV2l0aE9ubHlGZWF0dXJlcyguLi5mZWF0dXJlczogRmVhdHVyZVtdKTogTWV0YXNjcmVlbltdIHtcbiAgICBsZXQgbWFzayA9IDA7XG4gICAgZm9yIChjb25zdCBmZWF0dXJlIG9mIGZlYXR1cmVzKSB7XG4gICAgICBtYXNrIHw9IGZlYXR1cmVNYXNrW2ZlYXR1cmVdO1xuICAgIH1cbiAgICBjb25zdCBzY3JlZW5zOiBNZXRhc2NyZWVuW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcykge1xuICAgICAgaWYgKCEocy5mZWF0dXJlcyAmIH5tYXNrKSkgc2NyZWVucy5wdXNoKHMpO1xuICAgIH1cbiAgICByZXR1cm4gc2NyZWVucztcbiAgfVxuXG4gIHdpdGhNb2QodGlsZTogc3RyaW5nLCBtb2Q6IE1ldGFzY3JlZW5EYXRhWydtb2QnXSk6IE1ldGFzY3JlZW5bXSB7XG4gICAgY29uc3Qgb3V0OiBNZXRhc2NyZWVuW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5jYWNoZS50aWxlcy5nZXQodGlsZSkpIHtcbiAgICAgIGlmIChzLmRhdGEubW9kID09PSBtb2QpIG91dC5wdXNoKHMpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgdW5yZWFjaGFibGVWYXJpYW50KHNjcmVlbjogTWV0YXNjcmVlbik6IE1ldGFzY3JlZW4ge1xuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzKSB7XG4gICAgICBpZiAocy5zaWQgPT09IHNjcmVlbi5zaWQgJiYgcy5pc0VtcHR5KCkpIHJldHVybiBzO1xuICAgIH1cbiAgICByZXR1cm4gc2NyZWVuO1xuICB9XG5cbiAgaXNCYW5uZWRWZXJ0aWNhbChhYm92ZTogTWV0YXNjcmVlbiwgYmVsb3c6IE1ldGFzY3JlZW4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5iYW5uZWROZWlnaGJvcnNbMF0uaGFzKGFib3ZlLnVpZCA8PCAxNiB8IGJlbG93LnVpZCk7XG4gIH1cblxuICBpc0Jhbm5lZEhvcml6b250YWwobGVmdDogTWV0YXNjcmVlbiwgcmlnaHQ6IE1ldGFzY3JlZW4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5iYW5uZWROZWlnaGJvcnNbMV0uaGFzKGxlZnQudWlkIDw8IDE2IHwgcmlnaHQudWlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIHRoZSBuZWlnaGJvciBjYWNoZS4gIFRoaXMgaXMgbmVjZXNzYXJ5IGFueSB0aW1lIHRoZVxuICAgKiBzY3JlZW5zIGNoYW5nZS5cbiAgICovXG4gIGludmFsaWRhdGUoKSB7XG4gICAgdGhpcy5fY2FjaGUgPSB1bmRlZmluZWQ7XG4gIH1cblxuICAvLyBjaGVjayhzMTogVWlkLCBzMjogVWlkLCBkZWx0YTogbnVtYmVyKTogYm9vbGVhbiB7XG4gIC8vICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlLmFsbG93ZWRbZGVsdGEgJiAxXTsgIC8vIHZlcnRpY2FsID0gMCwgaG9yaXogPSAxXG4gIC8vICAgY29uc3QgaW5kZXggPSBkZWx0YSA+IDAgPyBzMSA8PCAxNiB8IHMyIDogczIgPDwgMTYgfCBzMTtcbiAgLy8gICByZXR1cm4gY2FjaGUuaGFzKGluZGV4KTtcbiAgLy8gfVxufVxuXG5pbnRlcmZhY2UgTWV0YXRpbGVzZXREYXRhIHtcbiAgcGF0dGVybnM/OiByZWFkb25seSBbbnVtYmVyLCBudW1iZXJdO1xuICBhbmltYXRlZD86IHJlYWRvbmx5IG51bWJlcltdO1xuICBjb25zb2xpZGF0ZWQ/OiBib29sZWFuO1xufVxuXG4vLyBjb25zdCBFTVBUWV9TRVQ6IFNldDxhbnk+ID0gbmV3IGNsYXNzIGV4dGVuZHMgU2V0IHtcbi8vICAgYWRkKCk6IHRoaXMgeyB0aHJvdyBuZXcgRXJyb3IoKTsgfVxuLy8gfVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBTcGVjaWFsaXplZCBjYWNoZSBvZiBuZWlnaGJvcnMvcmVsYXRpb25zaGlwcyBpbiBhIHRpbGVzZXQuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gXG5leHBvcnQgdHlwZSBEaXIgPSAwfDF8MnwzO1xuXG5leHBvcnQgbmFtZXNwYWNlIERpciB7XG4gIGV4cG9ydCBjb25zdCBOOiBEaXIgPSAwO1xuICBleHBvcnQgY29uc3QgVzogRGlyID0gMTtcbiAgZXhwb3J0IGNvbnN0IFM6IERpciA9IDI7XG4gIGV4cG9ydCBjb25zdCBFOiBEaXIgPSAzO1xufVxuXG5jbGFzcyBOZWlnaGJvckNhY2hlIHtcbiAgLy8gW3ZlcnRpY2FsLCBob3Jpem9udGFsXSwgaW5kZXhlZCBieSBkaXIgJiAxXG4gIC8vIHJlYWRvbmx5IGFsbG93ZWQgPSBbbmV3IFNldDxVaWRQYWlyPigpLCBuZXcgU2V0PFVpZFBhaXI+KCldIGFzIGNvbnN0O1xuICAvLyByZWFkb25seSBuZWlnaGJvcnMgPSBuZXcgRGVmYXVsdE1hcDxVaWREaXIsIFNldDxVaWQ+PigoKSA9PiBuZXcgU2V0KCkpO1xuICByZWFkb25seSBmcm9tSWQgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIE1ldGFzY3JlZW5bXT4oKCkgPT4gW10pO1xuICByZWFkb25seSBleGl0cyA9IG5ldyBEZWZhdWx0TWFwPENvbm5lY3Rpb25UeXBlLCBNZXRhc2NyZWVuW10+KCgpID0+IFtdKTtcbiAgcmVhZG9ubHkgZW1wdHk6IE1ldGFzY3JlZW47XG4gIHJlYWRvbmx5IHRpbGVzID0gbmV3IERlZmF1bHRNYXA8c3RyaW5nLCBNZXRhc2NyZWVuW10+KCgpID0+IFtdKTtcbiAgLy8gYWJvdmUgPDwgMTYgfCBiZWxvdywgbGVmdCA8PCAxNiB8IHJpZ2h0XG4gIHJlYWRvbmx5IGJhbm5lZE5laWdoYm9ycyA9IFtuZXcgU2V0PG51bWJlcj4oKSwgbmV3IFNldDxudW1iZXI+KCldO1xuICAvLyBwcml2YXRlIHJlYWRvbmx5IHRvZ2dsZXMgPSBuZXcgRGVmYXVsdE1hcDxVaWREaXIsIFNldDxVaWQ+PigoKSA9PiBuZXcgU2V0KTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSB0aWxlc2V0OiBNZXRhdGlsZXNldCkge1xuICAgIGxldCBlbXB0eTogTWV0YXNjcmVlbnx1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgZm9yIChjb25zdCBzIG9mIHRpbGVzZXQpIHtcbiAgICAgIC8vIFJlZ2lzdGVyIGluIHRoZSBmcm9tSWQgbXVsdGltYXBcbiAgICAgIGlmIChzLnNpZCA+PSAwKSB0aGlzLmZyb21JZC5nZXQocy5zaWQpLnB1c2gocyk7XG4gICAgICAvLyBDaGVjayBmb3IgZW1wdHlcbiAgICAgIGlmICghZW1wdHkgJiZcbiAgICAgICAgICBzLmRhdGEuZWRnZXMgPT09ICcgICAgJyAmJlxuICAgICAgICAgIHMuZGF0YS5wbGFjZW1lbnQgIT09ICdtYW51YWwnICYmXG4gICAgICAgICAgcy5oYXNGZWF0dXJlKCdlbXB0eScpICYmXG4gICAgICAgICAgIXMuZGF0YS5leGl0cz8ubGVuZ3RoKSB7XG4gICAgICAgIGVtcHR5ID0gcztcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgZXhpdCBvZiBzLmRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgICAgdGhpcy5leGl0cy5nZXQoZXhpdC50eXBlKS5wdXNoKHMpO1xuICAgICAgfVxuICAgICAgLy8gQWRkIHRvIHRpbGVzXG4gICAgICBjb25zdCB0aWxlcyA9XG4gICAgICAgICAgdHlwZW9mIHMuZGF0YS50aWxlID09PSAnc3RyaW5nJyA/IFtzLmRhdGEudGlsZV0gOiBzLmRhdGEudGlsZTtcbiAgICAgIGZvciAoY29uc3QgdGlsZSBvZiB0aWxlcyA/PyBbXSkge1xuICAgICAgICB0aGlzLnRpbGVzLmdldCh0aWxlLnJlcGxhY2UoL1xcfC9nLCAnJykpLnB1c2gocyk7XG4gICAgICB9XG4gICAgICAvLyBDaGVjayBmb3IgYmFubmVkIHZlcnRpY2Fsc1xuICAgICAgaWYgKC8qcy5oYXNGZWF0dXJlKCdzcGlrZXMnKSB8fCovIHMuaGFzRmVhdHVyZSgncmFtcCcpIHx8XG4gICAgICAgICAgcy5oYXNGZWF0dXJlKCdvdmVycGFzcycpIHx8IHMuaGFzRmVhdHVyZSgncGl0JykgfHxcbiAgICAgICAgICBzLmlzRW1wdHkoKSkge1xuICAgICAgICB0aGlzLmJhbkRlYWRFbmROZWlnaGJvcihzKTtcbiAgICAgIH1cbiAgICAgIC8vIEFkZCBhIGJ1bmNoIG9mIGZpeGVkIGJhbnNcbiAgICAgIGNvbnN0IG1zID0gdGlsZXNldC5yb20ubWV0YXNjcmVlbnM7XG4gICAgICB0aGlzLmJhbkRlYWRFbmROZWlnaGJvcihtcy5icmFuY2hOV0Vfd2FsbCwgMSk7XG4gICAgICB0aGlzLmJhbk5laWdoYm9yKG1zLmRlYWRFbmRTX3N0YWlycywgbXMuZGVhZEVuZE5fc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZE5TX3N0YWlycywgbXMuZGVhZEVuZE5fc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZFNfc3RhaXJzLCBtcy5kZWFkRW5kTlNfc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZE5TX3N0YWlycywgbXMuZGVhZEVuZE5TX3N0YWlycywgMik7XG4gICAgfVxuICAgIHRoaXMuZW1wdHkgPSBlbXB0eSA/PyB0aWxlc2V0LnJvbS5tZXRhc2NyZWVucy5jYXZlRW1wdHk7XG4gIH1cblxuICBiYW5EZWFkRW5kTmVpZ2hib3IoczogTWV0YXNjcmVlbiwgZGlycyA9IDE1KSB7XG4gICAgZm9yIChjb25zdCB0IG9mIHRoaXMudGlsZXNldCkge1xuICAgICAgaWYgKCF0Lmhhc0ZlYXR1cmUoJ2RlYWRlbmQnKSkgY29udGludWU7XG4gICAgICBmb3IgKGxldCBkaXIgPSAwOyBkaXIgPCA0OyBkaXIrKykge1xuICAgICAgICBjb25zdCBtYXNrID0gMSA8PCBkaXI7XG4gICAgICAgIGlmICghKGRpcnMgJiBtYXNrKSkgY29udGludWU7XG4gICAgICAgIGlmIChzLmRhdGEuZWRnZXM/LltkaXJdICE9PSAnICcgJiYgdC5kYXRhLmVkZ2VzPy5bZGlyIF4gMl0gIT09ICcgJykge1xuICAgICAgICAgIHRoaXMuYmFuTmVpZ2hib3IocywgdCwgZGlyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGJhbk5laWdoYm9yKHM6IE1ldGFzY3JlZW4sIHQ6IE1ldGFzY3JlZW4sIGRpcjogbnVtYmVyKSB7XG4gICAgdGhpcy5iYW5uZWROZWlnaGJvcnNbZGlyICYgMV1cbiAgICAgICAgLmFkZCgoZGlyICYgMiA/IHMgOiB0KS51aWQgPDwgMTYgfCAoZGlyICYgMiA/IHQgOiBzKS51aWQpO1xuICB9XG5cbiAgLy8gVE9ETyAtIHdoYXQgdG8gZG8gd2l0aCBib3JkZXJzPyE/IENhbiB3ZSB0cmVhdCB0aGVtIGxpa2UgYSBzY3JlZW4/XG4gIC8vIFRoZSBtYWluIHRoaW5nIHRoYXQgbWF0dGVycyBmb3IgYm9yZGVycyBpcyB3aGV0aGVyIGl0J3MgYW4gZWRnZSBleGl0XG4gIC8vIG9yIG5vdC4gIFdlIGNhbiBhbHJlYWR5IHRyYWNrIHRoaXMgYSBiaXQgLSB3ZSBjb3VsZCBoYXZlIGEgbGlzdCBvZlxuICAvLyBhY2NlcHRhYmxlIGVkZ2UgdHlwZXMgZm9yIGVhY2ggdGlsZXNldCAtIFwiIG5cIiBtb3N0IGxpa2VseSwgZXhjZXB0IGZvclxuICAvLyBzd2FtcCAoXCIgbnNcIj8pICBXZSBzaG91bGQgZ28gdGhydSBhbmQgbWFrZSBzdXJlIHRoZXJlJ3Mgbm8gcmV1c2Ugb2ZcbiAgLy8gZWRnZSB0eXBlcyBpbiBpbmNvbnNpc3RlbnQgd2F5cyAoZS5nLiAndicgZm9yIGJvdGggZ3Jhc3MgYW5kIGJvdW5kYXJ5KVxufVxuIl19