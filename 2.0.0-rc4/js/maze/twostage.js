import { Monogrid } from './monogrid.js';
import { CaveShuffle } from './cave.js';
import { OK } from './maze.js';
import { hex, seq } from '../rom/util.js';
export class TwoStageCaveShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.maxAttempts = 250;
    }
    initialFill() {
        let result;
        if ((result = this.initialFillEarly()), !result.ok)
            return result;
        this.initialFillLate();
        if ((result = this.connectEarlyToLate()), !result.ok)
            return result;
        this.count =
            [...this.grid.screens()]
                .filter(pos => this.grid.get(pos + 0x808)).length;
        return OK;
    }
    initialFillEarly() {
        const g = new Monogrid(this.h, this.w, this.getValidEarlyScreens());
        let attempts = 0;
        const target = this.targetEarly();
        while (attempts++ < 20 && g.size < target) {
            if (g.addPath(this.random, target))
                attempts = 0;
        }
        this.grid.data = g.toGrid(this.early).data;
        this.addAllFixed();
        return OK;
    }
    initialFillLate() {
        for (let y = 0; y < this.h; y++) {
            for (let x = 0; x < this.w; x++) {
                const c = (y << 12 | x << 4 | 0x808);
                if (!this.grid.get(c))
                    this.grid.set(c, 'c');
            }
        }
        for (let y = 0; y < this.h; y++) {
            for (let x = 0; x < this.w; x++) {
                for (const d of [8, 0x800]) {
                    const c = (y << 12 | x << 4 | 0x808);
                    const c1 = c + d;
                    const c2 = c + 2 * d;
                    if (!this.grid.isBorder(c1) && !this.grid.get(c1) &&
                        this.grid.get(c) === 'c' && this.grid.get(c2) === 'c') {
                        this.grid.set(c1, 'c');
                    }
                }
            }
        }
    }
    connectEarlyToLate() {
        for (const s of this.random.ishuffle(this.grid.screens())) {
            for (const d of [8, 0x800]) {
                const c = s | 0x808;
                const c1 = c + d;
                const c2 = c + 2 * d;
                if (this.grid.isBorder(c1) || this.grid.get(c1))
                    continue;
                this.grid.set(c1, 'c');
                const s1 = this.extract(this.grid, c - 0x808);
                const s2 = this.extract(this.grid, c2 - 0x808);
                if (!this.orig.tileset.getMetascreensFromTileString(s1).length ||
                    !this.orig.tileset.getMetascreensFromTileString(s2).length) {
                    this.grid.set(c1, '');
                }
            }
        }
        return OK;
    }
    pruneDisconnected() {
        const parts = new Set(this.grid.partition().values());
        let size = 0;
        for (const part of parts) {
            const early = [...part].some(c => this.grid.get(c) === this.early);
            if (early) {
                size += [...part].filter(c => (c & 0x808) === 0x808).length;
            }
            else {
                for (const c of part) {
                    if (this.fixed.has(c)) {
                        return { ok: false, fail: `fixed tile ${hex(c)} disconnected` };
                    }
                    this.grid.set(c, '');
                }
            }
        }
        if (size < this.params.size) {
            console.error(this.grid.show());
            return { ok: false, fail: 'too much disconnected' };
        }
        return OK;
    }
    getValidEarlyScreens() {
        if (!this.validEarlyScreens) {
            const valid = new Set();
            for (const s of this.orig.tileset) {
                const index = s.edgeIndex(this.early);
                if (index != null)
                    valid.add(index);
            }
            this.validEarlyScreens = valid;
        }
        return this.validEarlyScreens;
    }
    addEarlyFeatures() {
        var _a, _b;
        if (!this.addArenas((_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.arena) !== null && _b !== void 0 ? _b : 0)) {
            return { ok: false, fail: 'addArenas' };
        }
        let result;
        if ((result = this.pruneDisconnected()), !result.ok)
            return result;
        return super.addEarlyFeatures();
    }
}
export class SaberaPalaceShuffle extends TwoStageCaveShuffle {
    constructor() {
        super(...arguments);
        this.early = 'w';
        this.maxAttempts = 250;
    }
    targetEarly() {
        var _a;
        const target = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.wide;
        return target != null ? target + 2 + this.random.nextInt(3) : 0;
    }
    initialFillEarly() {
        var _a, _b;
        const g = new Monogrid(this.h, this.w);
        g.fill();
        const all = seq(g.data.length).slice(g.w);
        const stair = this.random.pick(all);
        if (!g.deleteEdge(stair, 1))
            return { ok: false, fail: `initial stair` };
        if (!g.deleteEdge(stair, 2))
            return { ok: false, fail: `initial stair` };
        if (!g.deleteEdge(stair, 3))
            return { ok: false, fail: `initial stair` };
        g.fixed.add(stair);
        const allSet = new Set(all);
        allSet.delete(stair);
        const arenas = [];
        for (const pos of this.random.ishuffle(allSet)) {
            function del(p) {
                if (!g.delete(p))
                    return false;
                g.fixed.add(p);
                return true;
            }
            const targetArenas = (_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.arena) !== null && _b !== void 0 ? _b : 0;
            if (arenas.length >= targetArenas)
                break;
            if (pos > g.data.length - 2 * g.w)
                continue;
            if (g.fixed.has(pos))
                continue;
            const l = !g.isBorder(pos, 1);
            const r = !g.isBorder(pos, 3);
            if (l && g.fixed.has(pos - 1))
                continue;
            if (r && g.fixed.has(pos + 1))
                continue;
            if (g.fixed.has(pos - g.w))
                continue;
            if (g.fixed.has(pos + g.w))
                continue;
            if (!(g.data[pos] & 4))
                continue;
            if (!del(pos - g.w))
                return { ok: false, fail: `initial arena` };
            if (l && !del(pos - 1))
                return { ok: false, fail: `initial arena` };
            if (r && !del(pos + 1))
                return { ok: false, fail: `initial arena` };
            const d = pos + g.w;
            if ((g.data[d] & 5) !== 5)
                return { ok: false, fail: `initial arena` };
            if (!g.deleteEdge(d, 1))
                return { ok: false, fail: `initial arena` };
            if (!g.deleteEdge(d, 3))
                return { ok: false, fail: `initial arena` };
            g.deleteEdge(d + g.w, 2);
            g.fixed.add(d);
            arenas.push(pos);
            g.fixed.add(pos);
        }
        if (!g.refine(this.random, this.targetEarly())) {
            return { ok: false, fail: `refine` };
        }
        const bad = new Set();
        for (let i = 1; i < 16; i++) {
            if (!this.getValidEarlyScreens().has(i))
                bad.add(i);
        }
        if (!g.consolidateFixed(this.random, bad)) {
            return { ok: false, fail: `consolidate` };
        }
        this.grid.data = g.toGrid('w').data;
        const set = (i, v) => {
            const x = i % g.w;
            const y = (i - x) / g.w;
            const c = (y << 12 | x << 4 | 0x808);
            this.grid.set(c, v);
            for (const d of [-0x808, -0x800, -0x7f8, -8, 0, 8, 0x7f8, 0x800, 0x808]) {
                this.fixed.add(c + d);
            }
        };
        set(stair, '>');
        for (const a of arenas) {
            set(a, 'a');
        }
        let size = 3;
        for (const s of this.grid.screens()) {
            if (this.grid.get(s + 0x808))
                size++;
        }
        this.size = size;
        return OK;
    }
    addStairs(up, down) {
        return super.addStairs(up, down ? down - 1 : 0);
    }
    addArenas() { return true; }
    connectEarlyToLate() {
        for (let y = 0; y < this.h; y++) {
            const row = y << 12 | 0x808;
            for (let x = 0; x < this.w; x++) {
                const c = (row | x << 4);
                if (this.grid.get(c) === 'a') {
                    this.grid.set(c - 0x800, 'c');
                }
            }
        }
        return OK;
    }
    preinfer() {
        const map = new Map();
        for (let i = 0; i < this.grid.data.length; i++) {
            if (this.grid.data[i] === 'w')
                map.set(this.grid.coord(i), '');
        }
        const parts = this.grid.partition(map);
        const ups = new Set();
        for (const [c, s] of parts) {
            if (this.grid.get(c) === '<')
                ups.add(s);
        }
        if (ups.size < 2)
            return { ok: false, fail: `stairs bunched` };
        return OK;
    }
    refineMetascreens(meta) {
        for (const pos of meta.allPos()) {
            const scr = meta.get(pos);
            if (scr.hasFeature('arena')) {
                meta.set(pos, meta.rom.metascreens.fortressArena_through);
            }
        }
        return OK;
    }
    refineEdges() { return true; }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHdvc3RhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbWF6ZS90d29zdGFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXpDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDeEMsT0FBTyxFQUFFLEVBQUUsRUFBVSxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQVcsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR25ELE1BQU0sT0FBZ0IsbUJBQW9CLFNBQVEsV0FBVztJQUE3RDs7UUFDRSxnQkFBVyxHQUFHLEdBQUcsQ0FBQztJQXlIcEIsQ0FBQztJQW5IQyxXQUFXO1FBQ1QsSUFBSSxNQUFvQixDQUFDO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFDbEUsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFFcEUsSUFBSSxDQUFDLEtBQUs7WUFDTixDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztpQkFDbkIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEtBQWtCLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN2RSxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRCxnQkFBZ0I7UUFDZCxNQUFNLENBQUMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQztRQUNwRSxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDakIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xDLE9BQU8sUUFBUSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLEdBQUcsTUFBTSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztnQkFBRSxRQUFRLEdBQUcsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzNDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRCxlQUFlO1FBRWIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQy9CLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBYyxDQUFDO2dCQUNsRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUM5QztTQUNGO1FBR0QsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQy9CLEtBQUssTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUU7b0JBQzFCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBYyxDQUFDO29CQUNsRCxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBYyxDQUFDO29CQUM5QixNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQWMsQ0FBQztvQkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO3dCQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEtBQUssR0FBRyxFQUFFO3dCQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7cUJBQ3hCO2lCQUNGO2FBQ0Y7U0FDRjtJQUNILENBQUM7SUFFRCxrQkFBa0I7UUFFaEIsS0FBSyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUU7WUFDekQsS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRTtnQkFDMUIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQWtCLENBQUM7Z0JBQ2pDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFjLENBQUM7Z0JBQzlCLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBYyxDQUFDO2dCQUNsQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFBRSxTQUFTO2dCQUUxRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsS0FBa0IsQ0FBQyxDQUFDO2dCQUMzRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxHQUFHLEtBQWtCLENBQUMsQ0FBQztnQkFDNUQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU07b0JBQzFELENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO29CQUM5RCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0Y7U0FDRjtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELGlCQUFpQjtRQUVmLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUN0RCxJQUFJLElBQUksR0FBRyxDQUFDLENBQUM7UUFDYixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUN4QixNQUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25FLElBQUksS0FBSyxFQUFFO2dCQUNULElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO2FBQzdEO2lCQUFNO2dCQUNMLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFO29CQUNwQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUNyQixPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDLGVBQWUsRUFBQyxDQUFDO3FCQUMvRDtvQkFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3RCO2FBQ0Y7U0FDRjtRQUNELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1lBQzNCLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sRUFBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBQyxDQUFDO1NBQ25EO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsb0JBQW9CO1FBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztZQUNoQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNqQyxNQUFNLEtBQUssR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxLQUFLLElBQUksSUFBSTtvQkFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztTQUNoQztRQUNELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ2hDLENBQUM7SUFFRCxnQkFBZ0I7O1FBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLGFBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLDBDQUFFLEtBQUssbUNBQUksQ0FBQyxDQUFDLEVBQUU7WUFDckQsT0FBTyxFQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBQyxDQUFDO1NBQ3ZDO1FBQ0QsSUFBSSxNQUFvQixDQUFBO1FBQ3hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFDbkUsT0FBTyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0NBQ0Y7QUFJRCxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsbUJBQW1CO0lBQTVEOztRQUNFLFVBQUssR0FBRyxHQUFHLENBQUM7UUFDWixnQkFBVyxHQUFHLEdBQUcsQ0FBQztJQXFKcEIsQ0FBQztJQW5KQyxXQUFXOztRQUVULE1BQU0sTUFBTSxTQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSwwQ0FBRSxJQUFJLENBQUM7UUFDMUMsT0FBTyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQTBCRCxnQkFBZ0I7O1FBQ2QsTUFBTSxDQUFDLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1QsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQUUsT0FBTyxFQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7WUFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUFFLE9BQU8sRUFBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUM1QixLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzlDLFNBQVMsR0FBRyxDQUFDLENBQVM7Z0JBQ3BCLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFBRSxPQUFPLEtBQUssQ0FBQztnQkFDL0IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2YsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBQ0QsTUFBTSxZQUFZLGVBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLDBDQUFFLEtBQUssbUNBQUksQ0FBQyxDQUFDO1lBQ3RELElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxZQUFZO2dCQUFFLE1BQU07WUFDekMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFDNUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQUUsU0FBUztZQUMvQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFBRSxTQUFTO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQUUsU0FBUztZQUN4QyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFDckMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBRSxTQUFTO1lBQ3JDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDbEUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDbkUsSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFBRSxPQUFPLEVBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUM7WUFDbkUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN6QixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFD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TSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLEVBQUU7WUFDMUIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHO2dCQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUM7UUFDRCxJQUFJLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQztZQUFFLE9BQU8sRUFBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBQyxDQUFDO1FBQzdELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQWtCO1FBQ2xDLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQy9CLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDMUIsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUMzQixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQzNEO1NBQ0Y7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRCxXQUFXLEtBQUssT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDO0NBQy9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9ub2dyaWQgfSBmcm9tICcuL21vbm9ncmlkLmpzJztcbmltcG9ydCB7IEdyaWRDb29yZCwgR3JpZEluZGV4IH0gZnJvbSAnLi9ncmlkLmpzJztcbmltcG9ydCB7IENhdmVTaHVmZmxlIH0gZnJvbSAnLi9jYXZlLmpzJztcbmltcG9ydCB7IE9LLCBSZXN1bHQgfSBmcm9tICcuL21hemUuanMnO1xuaW1wb3J0IHsgTXV0YWJsZSwgaGV4LCBzZXEgfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24gfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFR3b1N0YWdlQ2F2ZVNodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuICBhYnN0cmFjdCBlYXJseTogc3RyaW5nO1xuICB2YWxpZEVhcmx5U2NyZWVucz86IFNldDxudW1iZXI+O1xuXG4gIGFic3RyYWN0IHRhcmdldEVhcmx5KCk6IG51bWJlcjtcblxuICBpbml0aWFsRmlsbCgpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGxldCByZXN1bHQ6IFJlc3VsdDx2b2lkPjtcbiAgICBpZiAoKHJlc3VsdCA9IHRoaXMuaW5pdGlhbEZpbGxFYXJseSgpKSwgIXJlc3VsdC5vaykgcmV0dXJuIHJlc3VsdDtcbiAgICB0aGlzLmluaXRpYWxGaWxsTGF0ZSgpO1xuICAgIGlmICgocmVzdWx0ID0gdGhpcy5jb25uZWN0RWFybHlUb0xhdGUoKSksICFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgLy8gdXBkYXRlIGNvdW50XG4gICAgdGhpcy5jb3VudCA9XG4gICAgICAgIFsuLi50aGlzLmdyaWQuc2NyZWVucygpXVxuICAgICAgICAgICAgLmZpbHRlcihwb3MgPT4gdGhpcy5ncmlkLmdldChwb3MgKyAweDgwOCBhcyBHcmlkQ29vcmQpKS5sZW5ndGg7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgaW5pdGlhbEZpbGxFYXJseSgpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IGcgPSBuZXcgTW9ub2dyaWQodGhpcy5oLCB0aGlzLncsIHRoaXMuZ2V0VmFsaWRFYXJseVNjcmVlbnMoKSk7XG4gICAgbGV0IGF0dGVtcHRzID0gMDtcbiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLnRhcmdldEVhcmx5KCk7XG4gICAgd2hpbGUgKGF0dGVtcHRzKysgPCAyMCAmJiBnLnNpemUgPCB0YXJnZXQpIHtcbiAgICAgIGlmIChnLmFkZFBhdGgodGhpcy5yYW5kb20sIHRhcmdldCkpIGF0dGVtcHRzID0gMDtcbiAgICB9XG5cbiAgICB0aGlzLmdyaWQuZGF0YSA9IGcudG9HcmlkKHRoaXMuZWFybHkpLmRhdGE7XG4gICAgdGhpcy5hZGRBbGxGaXhlZCgpO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGluaXRpYWxGaWxsTGF0ZSgpIHtcbiAgICAvLyBBZGQgY2F2ZSBzY3JlZW5zIHdoZXJlIHBvc3NpYmxlXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLmg7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLnc7IHgrKykge1xuICAgICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICBpZiAoIXRoaXMuZ3JpZC5nZXQoYykpIHRoaXMuZ3JpZC5zZXQoYywgJ2MnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDb25uZWN0IGFsbCB0aGUgJ2MnIHNjcmVlbnMsIGRvbid0IGNvbm5lY3QgdG8gJ3InXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLmg7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLnc7IHgrKykge1xuICAgICAgICBmb3IgKGNvbnN0IGQgb2YgWzgsIDB4ODAwXSkge1xuICAgICAgICAgIGNvbnN0IGMgPSAoeSA8PCAxMiB8IHggPDwgNCB8IDB4ODA4KSBhcyBHcmlkQ29vcmQ7XG4gICAgICAgICAgY29uc3QgYzEgPSBjICsgZCBhcyBHcmlkQ29vcmQ7XG4gICAgICAgICAgY29uc3QgYzIgPSBjICsgMiAqIGQgYXMgR3JpZENvb3JkO1xuICAgICAgICAgIGlmICghdGhpcy5ncmlkLmlzQm9yZGVyKGMxKSAmJiAhdGhpcy5ncmlkLmdldChjMSkgJiZcbiAgICAgICAgICAgICAgdGhpcy5ncmlkLmdldChjKSA9PT0gJ2MnICYmIHRoaXMuZ3JpZC5nZXQoYzIpID09PSAnYycpIHtcbiAgICAgICAgICAgIHRoaXMuZ3JpZC5zZXQoYzEsICdjJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29ubmVjdEVhcmx5VG9MYXRlKCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgLy8gQWRkIGNvbm5lY3Rpb25zIGJldHdlZW4gbGFuZCBhbmQgd2F0ZXJcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUodGhpcy5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGZvciAoY29uc3QgZCBvZiBbOCwgMHg4MDBdKSB7XG4gICAgICAgIGNvbnN0IGMgPSBzIHwgMHg4MDggYXMgR3JpZENvb3JkO1xuICAgICAgICBjb25zdCBjMSA9IGMgKyBkIGFzIEdyaWRDb29yZDtcbiAgICAgICAgY29uc3QgYzIgPSBjICsgMiAqIGQgYXMgR3JpZENvb3JkO1xuICAgICAgICBpZiAodGhpcy5ncmlkLmlzQm9yZGVyKGMxKSB8fCB0aGlzLmdyaWQuZ2V0KGMxKSkgY29udGludWU7XG4gICAgICAgIC8vIENoZWNrIGlmIGFkZGluZyBjMSBpcyB2YWxpZFxuICAgICAgICB0aGlzLmdyaWQuc2V0KGMxLCAnYycpO1xuICAgICAgICBjb25zdCBzMSA9IHRoaXMuZXh0cmFjdCh0aGlzLmdyaWQsIGMgLSAweDgwOCBhcyBHcmlkQ29vcmQpO1xuICAgICAgICBjb25zdCBzMiA9IHRoaXMuZXh0cmFjdCh0aGlzLmdyaWQsIGMyIC0gMHg4MDggYXMgR3JpZENvb3JkKTtcbiAgICAgICAgaWYgKCF0aGlzLm9yaWcudGlsZXNldC5nZXRNZXRhc2NyZWVuc0Zyb21UaWxlU3RyaW5nKHMxKS5sZW5ndGggfHxcbiAgICAgICAgICAgICF0aGlzLm9yaWcudGlsZXNldC5nZXRNZXRhc2NyZWVuc0Zyb21UaWxlU3RyaW5nKHMyKS5sZW5ndGgpIHtcbiAgICAgICAgICB0aGlzLmdyaWQuc2V0KGMxLCAnJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgcHJ1bmVEaXNjb25uZWN0ZWQoKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBQcnVuZSBhbnl0aGluZyBub3QgYXR0YWNoZWQgdG8gcml2ZXIsIG1ha2Ugc3VyZSBpdCdzIGJpZyBlbm91Z2guXG4gICAgY29uc3QgcGFydHMgPSBuZXcgU2V0KHRoaXMuZ3JpZC5wYXJ0aXRpb24oKS52YWx1ZXMoKSk7XG4gICAgbGV0IHNpemUgPSAwO1xuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0cykge1xuICAgICAgY29uc3QgZWFybHkgPSBbLi4ucGFydF0uc29tZShjID0+IHRoaXMuZ3JpZC5nZXQoYykgPT09IHRoaXMuZWFybHkpO1xuICAgICAgaWYgKGVhcmx5KSB7XG4gICAgICAgIHNpemUgKz0gWy4uLnBhcnRdLmZpbHRlcihjID0+IChjICYgMHg4MDgpID09PSAweDgwOCkubGVuZ3RoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9yIChjb25zdCBjIG9mIHBhcnQpIHtcbiAgICAgICAgICBpZiAodGhpcy5maXhlZC5oYXMoYykpIHtcbiAgICAgICAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgZml4ZWQgdGlsZSAke2hleChjKX0gZGlzY29ubmVjdGVkYH07XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuZ3JpZC5zZXQoYywgJycpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzaXplIDwgdGhpcy5wYXJhbXMuc2l6ZSkge1xuICAgICAgY29uc29sZS5lcnJvcih0aGlzLmdyaWQuc2hvdygpKTtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiAndG9vIG11Y2ggZGlzY29ubmVjdGVkJ307XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGdldFZhbGlkRWFybHlTY3JlZW5zKCk6IFNldDxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMudmFsaWRFYXJseVNjcmVlbnMpIHtcbiAgICAgIGNvbnN0IHZhbGlkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5vcmlnLnRpbGVzZXQpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBzLmVkZ2VJbmRleCh0aGlzLmVhcmx5KTtcbiAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHZhbGlkLmFkZChpbmRleCk7XG4gICAgICB9XG4gICAgICB0aGlzLnZhbGlkRWFybHlTY3JlZW5zID0gdmFsaWQ7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnZhbGlkRWFybHlTY3JlZW5zO1xuICB9XG5cbiAgYWRkRWFybHlGZWF0dXJlcygpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGlmICghdGhpcy5hZGRBcmVuYXModGhpcy5wYXJhbXMuZmVhdHVyZXM/LmFyZW5hID8/IDApKSB7XG4gICAgICByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogJ2FkZEFyZW5hcyd9O1xuICAgIH1cbiAgICBsZXQgcmVzdWx0OiBSZXN1bHQ8dm9pZD5cbiAgICBpZiAoKHJlc3VsdCA9IHRoaXMucHJ1bmVEaXNjb25uZWN0ZWQoKSksICFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgcmV0dXJuIHN1cGVyLmFkZEVhcmx5RmVhdHVyZXMoKTtcbiAgfVxufVxuXG5cblxuZXhwb3J0IGNsYXNzIFNhYmVyYVBhbGFjZVNodWZmbGUgZXh0ZW5kcyBUd29TdGFnZUNhdmVTaHVmZmxlIHtcbiAgZWFybHkgPSAndyc7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuXG4gIHRhcmdldEVhcmx5KCkge1xuICAgIC8vIEFkZHMgKzIgYmVjYXVzZSBhcmVuYXMgbXVzdCBjb21lIGZyb20gd2lkZSBzY3JlZW5zLlxuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMucGFyYW1zLmZlYXR1cmVzPy53aWRlO1xuICAgIHJldHVybiB0YXJnZXQgIT0gbnVsbCA/IHRhcmdldCArIDIgKyB0aGlzLnJhbmRvbS5uZXh0SW50KDMpIDogMDtcbiAgfVxuXG4gIC8vIGluaXRpYWxGaWxsRWFybHkoKTogUmVzdWx0PHZvaWQ+IHtcblxuICAvLyAgIC8vIFRPRE8gLSByYW5kb20gdXBmcm9udCBsb2MgZm9yIGFyZW5hcyBhbmQgZG93bnN0YWlyLCBjb25uZWN0IHcvIHBhdGhzP1xuICAvLyAgIC8vICAgICAgLSBuZWVkIGEgbW9yZSByYW5kb20gZGlyZWN0ZWQgcGF0aC5cblxuICAvLyAgIGNvbnN0IHIgPSBzdXBlci5pbml0aWFsRmlsbEVhcmx5KCk7XG4gIC8vICAgaWYgKCFyLm9rKSByZXR1cm4gcjtcbiAgLy8gICAvLyBGaW5kIHNvbWV3aGVyZSBmb3IgdGhlIGRvd25zdGFpcnMuXG4gIC8vICAgZm9yIChjb25zdCBjIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKHRoaXMuZ3JpZC5zY3JlZW5zKCkpKSB7XG4gIC8vICAgICBjb25zdCBlID0gdGhpcy5leHRyYWN0KHRoaXMuZ3JpZCwgYyk7XG4gIC8vICAgICBpZiAoZSA9PT0gJyB3ICB3ICAgICcpIHtcbiAgLy8gICAgICAgdGhpcy5ncmlkLnNldChjICsgMHg4MDggYXMgR3JpZENvb3JkLCAnPicpO1xuICAvLyAgICAgICByZXR1cm4gT0s7XG4gIC8vICAgICB9IGVsc2UgaWYgKGMgPj4+IDEyIDwgdGhpcy5oIC0gMSAmJlxuICAvLyAgICAgICAgICAgICAgICAvIFt3IF0gd3d3ICAgLy50ZXN0KGUpICYmXG4gIC8vICAgICAgICAgICAgICAgICEvXFxTLy50ZXN0KHRoaXMuZXh0cmFjdCh0aGlzLmdyaWQsIGMgKyAweDEwMDAgYXMgR3JpZENvb3JkKSkpIHtcbiAgLy8gICAgICAgdGhpcy5ncmlkLnNldChjICsgMHgxMDA4IGFzIEdyaWRDb29yZCwgJ3cnKTtcbiAgLy8gICAgICAgdGhpcy5ncmlkLnNldChjICsgMHgxODA4IGFzIEdyaWRDb29yZCwgJz4nKTtcbiAgLy8gICAgICAgcmV0dXJuIE9LO1xuICAvLyAgICAgfVxuICAvLyAgIH1cbiAgLy8gICByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGNvdWxkIG5vdCBwbGFjZSBkb3duc3RhaXJgfTtcbiAgLy8gfVxuXG4gIGluaXRpYWxGaWxsRWFybHkoKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBnID0gbmV3IE1vbm9ncmlkKHRoaXMuaCwgdGhpcy53KTtcbiAgICBnLmZpbGwoKTtcbiAgICBjb25zdCBhbGwgPSBzZXEoZy5kYXRhLmxlbmd0aCkuc2xpY2UoZy53KTtcbiAgICBjb25zdCBzdGFpciA9IHRoaXMucmFuZG9tLnBpY2soYWxsKTtcbiAgICBpZiAoIWcuZGVsZXRlRWRnZShzdGFpciwgMSkpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBzdGFpcmB9O1xuICAgIGlmICghZy5kZWxldGVFZGdlKHN0YWlyLCAyKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIHN0YWlyYH07XG4gICAgaWYgKCFnLmRlbGV0ZUVkZ2Uoc3RhaXIsIDMpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgc3RhaXJgfTtcbiAgICBnLmZpeGVkLmFkZChzdGFpcik7XG4gICAgY29uc3QgYWxsU2V0ID0gbmV3IFNldChhbGwpO1xuICAgIGFsbFNldC5kZWxldGUoc3RhaXIpO1xuICAgIGNvbnN0IGFyZW5hczogbnVtYmVyW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHBvcyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShhbGxTZXQpKSB7XG4gICAgICBmdW5jdGlvbiBkZWwocDogbnVtYmVyKSB7XG4gICAgICAgIGlmICghZy5kZWxldGUocCkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgZy5maXhlZC5hZGQocCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdGFyZ2V0QXJlbmFzID0gdGhpcy5wYXJhbXMuZmVhdHVyZXM/LmFyZW5hID8/IDA7XG4gICAgICBpZiAoYXJlbmFzLmxlbmd0aCA+PSB0YXJnZXRBcmVuYXMpIGJyZWFrO1xuICAgICAgaWYgKHBvcyA+IGcuZGF0YS5sZW5ndGggLSAyICogZy53KSBjb250aW51ZTtcbiAgICAgIGlmIChnLmZpeGVkLmhhcyhwb3MpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGwgPSAhZy5pc0JvcmRlcihwb3MsIDEpO1xuICAgICAgY29uc3QgciA9ICFnLmlzQm9yZGVyKHBvcywgMyk7XG4gICAgICBpZiAobCAmJiBnLmZpeGVkLmhhcyhwb3MgLSAxKSkgY29udGludWU7XG4gICAgICBpZiAociAmJiBnLmZpeGVkLmhhcyhwb3MgKyAxKSkgY29udGludWU7XG4gICAgICBpZiAoZy5maXhlZC5oYXMocG9zIC0gZy53KSkgY29udGludWU7XG4gICAgICBpZiAoZy5maXhlZC5oYXMocG9zICsgZy53KSkgY29udGludWU7XG4gICAgICBpZiAoIShnLmRhdGFbcG9zXSAmIDQpKSBjb250aW51ZTtcbiAgICAgIGlmICghZGVsKHBvcyAtIGcudykpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBhcmVuYWB9O1xuICAgICAgaWYgKGwgJiYgIWRlbChwb3MgLSAxKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIGFyZW5hYH07XG4gICAgICBpZiAociAmJiAhZGVsKHBvcyArIDEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGNvbnN0IGQgPSBwb3MgKyBnLnc7XG4gICAgICBpZiAoKGcuZGF0YVtkXSAmIDUpICE9PSA1KSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGlmICghZy5kZWxldGVFZGdlKGQsIDEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGlmICghZy5kZWxldGVFZGdlKGQsIDMpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGcuZGVsZXRlRWRnZShkICsgZy53LCAyKTtcbiAgICAgIGcuZml4ZWQuYWRkKGQpO1xuICAgICAgYXJlbmFzLnB1c2gocG9zKTtcbiAgICAgIGcuZml4ZWQuYWRkKHBvcyk7XG4gICAgfVxuICAgIGlmICghZy5yZWZpbmUodGhpcy5yYW5kb20sIHRoaXMudGFyZ2V0RWFybHkoKSkpIHtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgcmVmaW5lYH07XG4gICAgfVxuICAgIGNvbnN0IGJhZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgMTY7IGkrKykge1xuICAgICAgaWYgKCF0aGlzLmdldFZhbGlkRWFybHlTY3JlZW5zKCkuaGFzKGkpKSBiYWQuYWRkKGkpO1xuICAgIH1cbiAgICBpZiAoIWcuY29uc29saWRhdGVGaXhlZCh0aGlzLnJhbmRvbSwgYmFkKSkge1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb25zb2xpZGF0ZWB9O1xuICAgIH1cbiAgICB0aGlzLmdyaWQuZGF0YSA9IGcudG9HcmlkKCd3JykuZGF0YTtcbiAgICBjb25zdCBzZXQgPSAoaTogbnVtYmVyLCB2OiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IHggPSBpICUgZy53O1xuICAgICAgY29uc3QgeSA9IChpIC0geCkgLyBnLnc7XG4gICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgdGhpcy5ncmlkLnNldChjLCB2KTtcbiAgICAgIGZvciAoY29uc3QgZCBvZiBbLTB4ODA4LCAtMHg4MDAsIC0weDdmOCwgLTgsIDAsIDgsIDB4N2Y4LCAweDgwMCwgMHg4MDhdKSB7XG4gICAgICAgIHRoaXMuZml4ZWQuYWRkKGMgKyBkIGFzIEdyaWRDb29yZCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBzZXQoc3RhaXIsICc+Jyk7XG4gICAgZm9yIChjb25zdCBhIG9mIGFyZW5hcykge1xuICAgICAgc2V0KGEsICdhJyk7XG4gICAgfVxuICAgIGxldCBzaXplID0gMztcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5ncmlkLnNjcmVlbnMoKSkge1xuICAgICAgaWYgKHRoaXMuZ3JpZC5nZXQocyArIDB4ODA4IGFzIEdyaWRDb29yZCkpIHNpemUrKztcbiAgICB9XG4gICAgKHRoaXMgYXMgTXV0YWJsZTx0aGlzPikuc2l6ZSA9IHNpemU7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkU3RhaXJzKHVwPzogbnVtYmVyLCBkb3duPzogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHN1cGVyLmFkZFN0YWlycyh1cCwgZG93biA/IGRvd24gLSAxIDogMCk7XG4gIH1cblxuICBhZGRBcmVuYXMoKSB7IHJldHVybiB0cnVlOyB9XG5cbiAgY29ubmVjdEVhcmx5VG9MYXRlKCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLmg7IHkrKykge1xuICAgICAgY29uc3Qgcm93ID0geSA8PCAxMiB8IDB4ODA4O1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLnc7IHgrKykge1xuICAgICAgICBjb25zdCBjID0gKHJvdyB8IHggPDwgNCkgYXMgR3JpZENvb3JkO1xuICAgICAgICBpZiAodGhpcy5ncmlkLmdldChjKSA9PT0gJ2EnKSB7XG4gICAgICAgICAgdGhpcy5ncmlkLnNldChjIC0gMHg4MDAgYXMgR3JpZENvb3JkLCAnYycpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIHByZWluZmVyKCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxHcmlkQ29vcmQsIHN0cmluZz4oKTtcbiAgICBmb3IgKGxldCBpID0gMCBhcyBHcmlkSW5kZXg7IGkgPCB0aGlzLmdyaWQuZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRoaXMuZ3JpZC5kYXRhW2ldID09PSAndycpIG1hcC5zZXQodGhpcy5ncmlkLmNvb3JkKGkpLCAnJyk7XG4gICAgfVxuICAgIGNvbnN0IHBhcnRzID0gdGhpcy5ncmlkLnBhcnRpdGlvbihtYXApO1xuICAgIGNvbnN0IHVwcyA9IG5ldyBTZXQ8U2V0PEdyaWRDb29yZD4+KCk7XG4gICAgZm9yIChjb25zdCBbYywgc10gb2YgcGFydHMpIHtcbiAgICAgIGlmICh0aGlzLmdyaWQuZ2V0KGMpID09PSAnPCcpIHVwcy5hZGQocyk7XG4gICAgfVxuICAgIGlmICh1cHMuc2l6ZSA8IDIpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgc3RhaXJzIGJ1bmNoZWRgfTtcbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICByZWZpbmVNZXRhc2NyZWVucyhtZXRhOiBNZXRhbG9jYXRpb24pOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGZvciAoY29uc3QgcG9zIG9mIG1ldGEuYWxsUG9zKCkpIHtcbiAgICAgIGNvbnN0IHNjciA9IG1ldGEuZ2V0KHBvcyk7XG4gICAgICBpZiAoc2NyLmhhc0ZlYXR1cmUoJ2FyZW5hJykpIHtcbiAgICAgICAgbWV0YS5zZXQocG9zLCBtZXRhLnJvbS5tZXRhc2NyZWVucy5mb3J0cmVzc0FyZW5hX3Rocm91Z2gpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICByZWZpbmVFZGdlcygpIHsgcmV0dXJuIHRydWU7IH1cbn1cbiJdfQ==