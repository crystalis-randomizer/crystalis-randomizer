class State {
    constructor(line, column, prefix, remainder, match) {
        this.line = line;
        this.column = column;
        this.prefix = prefix;
        this.remainder = remainder;
        this.match = match;
    }
}
export class Buffer {
    constructor(content, line = 0, column = 0) {
        this.content = content;
        this.line = line;
        this.column = column;
        this.prefix = '';
        this.remainder = content;
    }
    advance(s) {
        const s1 = this.remainder.substring(0, s.length);
        if (s !== s1)
            throw new Error(`Non-rooted token: '${s}' vs '${s1}'`);
        this.prefix += s;
        this.remainder = this.remainder.substring(s.length);
        const lines = s.split(/(\r\n|\n|\r)/g);
        if (lines.length > 1) {
            this.line += lines.length - 1;
            this.column = 0;
        }
        this.column += lines[lines.length - 1].length;
    }
    saveState() {
        return new State(this.line, this.column, this.prefix, this.remainder, this.lastMatch);
    }
    restoreState(state) {
        this.line = state.line;
        this.column = state.column;
        this.prefix = state.prefix;
        this.remainder = state.remainder;
        this.lastMatch = state.match;
    }
    skip(re) {
        const match = re.exec(this.remainder);
        if (!match)
            return false;
        this.advance(match[0]);
        return true;
    }
    space() { return this.skip(/^[ \t]+/); }
    newline() { return this.skip(/^(\r\n|\n|\r)/); }
    lookingAt(re) {
        if (typeof re === 'string')
            return this.remainder.startsWith(re);
        return re.test(this.remainder);
    }
    token(re) {
        let match;
        if (typeof re === 'string') {
            if (!this.remainder.startsWith(re))
                return false;
            match = [re];
        }
        else {
            match = re.exec(this.remainder);
        }
        if (!match)
            return false;
        match.line = this.line;
        match.column = this.column;
        this.lastMatch = match;
        this.advance(match[0]);
        return true;
    }
    lookBehind(re) {
        if (typeof re === 'string')
            return this.prefix.endsWith(re);
        const match = re.exec(this.prefix);
        if (!match)
            return false;
        match.line = this.line;
        match.column = this.line;
        this.lastMatch = match;
        return true;
    }
    match() {
        return this.lastMatch;
    }
    group(index = 0) {
        var _a;
        return (_a = this.lastMatch) === null || _a === void 0 ? void 0 : _a[index];
    }
    eof() {
        return !this.remainder;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2FzbS9idWZmZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsTUFBTSxLQUFLO0lBQ1QsWUFBcUIsSUFBWSxFQUNaLE1BQWMsRUFDZCxNQUFjLEVBQ2QsU0FBaUIsRUFDakIsS0FBc0I7UUFKdEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUNqQixVQUFLLEdBQUwsS0FBSyxDQUFpQjtJQUFHLENBQUM7Q0FDaEQ7QUFFRCxNQUFNLE9BQU8sTUFBTTtJQU1qQixZQUFxQixPQUFlLEVBQVMsT0FBTyxDQUFDLEVBQVMsU0FBUyxDQUFDO1FBQW5ELFlBQU8sR0FBUCxPQUFPLENBQVE7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFJO1FBQVMsV0FBTSxHQUFOLE1BQU0sQ0FBSTtRQUx4RSxXQUFNLEdBQUcsRUFBRSxDQUFDO1FBTVYsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUVPLE9BQU8sQ0FBQyxDQUFTO1FBQ3ZCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BELE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMs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QUFDLENBQUM7UUFDNUQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFlLENBQUM7UUFDakQsSUFBSSxDQUFDLEtBQUs7WUFBRSxPQUFPLEtBQUssQ0FBQztRQUN6QixLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdkIsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUs7UUFDSCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQzs7UUFDYixhQUFPLElBQUksQ0FBQyxTQUFTLDBDQUFHLEtBQUssRUFBRTtJQUNqQyxDQUFDO0lBRUQsR0FBRztRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ3pCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbInR5cGUgTWF0Y2ggPSBSZWdFeHBFeGVjQXJyYXkgJiB7bGluZTogbnVtYmVyLCBjb2x1bW46IG51bWJlcn07XG5cbmNsYXNzIFN0YXRlIHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbGluZTogbnVtYmVyLFxuICAgICAgICAgICAgICByZWFkb25seSBjb2x1bW46IG51bWJlcixcbiAgICAgICAgICAgICAgcmVhZG9ubHkgcHJlZml4OiBzdHJpbmcsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHJlbWFpbmRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICByZWFkb25seSBtYXRjaDogTWF0Y2h8dW5kZWZpbmVkKSB7fVxufVxuXG5leHBvcnQgY2xhc3MgQnVmZmVyIHtcbiAgcHJlZml4ID0gJyc7XG4gIHJlbWFpbmRlcjogc3RyaW5nO1xuXG4gIGxhc3RNYXRjaD86IE1hdGNoO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGNvbnRlbnQ6IHN0cmluZywgcHVibGljIGxpbmUgPSAwLCBwdWJsaWMgY29sdW1uID0gMCkge1xuICAgIHRoaXMucmVtYWluZGVyID0gY29udGVudDtcbiAgfVxuXG4gIHByaXZhdGUgYWR2YW5jZShzOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzMSA9IHRoaXMucmVtYWluZGVyLnN1YnN0cmluZygwLCBzLmxlbmd0aCk7XG4gICAgaWYgKHMgIT09IHMxKSB0aHJvdyBuZXcgRXJyb3IoYE5vbi1yb290ZWQgdG9rZW46ICcke3N9JyB2cyAnJHtzMX0nYCk7XG4gICAgdGhpcy5wcmVmaXggKz0gcztcbiAgICB0aGlzLnJlbWFpbmRlciA9IHRoaXMucmVtYWluZGVyLnN1YnN0cmluZyhzLmxlbmd0aCk7XG4gICAgY29uc3QgbGluZXMgPSBzLnNwbGl0KC8oXFxyXFxufFxcbnxcXHIpL2cpO1xuICAgIGlmIChsaW5lcy5sZW5ndGggPiAxKSB7XG4gICAgICB0aGlzLmxpbmUgKz0gbGluZXMubGVuZ3RoIC0gMTtcbiAgICAgIHRoaXMuY29sdW1uID0gMDtcbiAgICB9XG4gICAgdGhpcy5jb2x1bW4gKz0gbGluZXNbbGluZXMubGVuZ3RoIC0gMV0ubGVuZ3RoO1xuICB9XG5cbiAgc2F2ZVN0YXRlKCk6IFN0YXRlIHtcbiAgICByZXR1cm4gbmV3IFN0YXRlKHRoaXMubGluZSwgdGhpcy5jb2x1bW4sXG4gICAgICAgICAgICAgICAgICAgICB0aGlzLnByZWZpeCwgdGhpcy5yZW1haW5kZXIsXG4gICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RNYXRjaCk7XG4gIH1cblxuICByZXN0b3JlU3RhdGUoc3RhdGU6IFN0YXRlKSB7XG4gICAgdGhpcy5saW5lID0gc3RhdGUubGluZTtcbiAgICB0aGlzLmNvbHVtbiA9IHN0YXRlLmNvbHVtbjtcbiAgICB0aGlzLnByZWZpeCA9IHN0YXRlLnByZWZpeDtcbiAgICB0aGlzLnJlbWFpbmRlciA9IHN0YXRlLnJlbWFpbmRlcjtcbiAgICB0aGlzLmxhc3RNYXRjaCA9IHN0YXRlLm1hdGNoO1xuICB9XG5cbiAgc2tpcChyZTogUmVnRXhwKTogYm9vbGVhbiB7XG4gICAgY29uc3QgbWF0Y2ggPSByZS5leGVjKHRoaXMucmVtYWluZGVyKTtcbiAgICBpZiAoIW1hdGNoKSByZXR1cm4gZmFsc2U7XG4gICAgdGhpcy5hZHZhbmNlKG1hdGNoWzBdKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBzcGFjZSgpOiBib29sZWFuIHsgcmV0dXJuIHRoaXMuc2tpcCgvXlsgXFx0XSsvKTsgfVxuICBuZXdsaW5lKCk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5za2lwKC9eKFxcclxcbnxcXG58XFxyKS8pOyB9XG5cbiAgbG9va2luZ0F0KHJlOiBSZWdFeHB8c3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHR5cGVvZiByZSA9PT0gJ3N0cmluZycpIHJldHVybiB0aGlzLnJlbWFpbmRlci5zdGFydHNXaXRoKHJlKTtcbiAgICByZXR1cm4gcmUudGVzdCh0aGlzLnJlbWFpbmRlcik7XG4gIH1cblxuICAvLyBOT1RFOiByZSBzaG91bGQgYWx3YXlzIGJlIHJvb3RlZCB3aXRoIC9eLyBhdCB0aGUgc3RhcnQuXG4gIHRva2VuKHJlOiBSZWdFeHB8c3RyaW5nKTogYm9vbGVhbiB7XG4gICAgbGV0IG1hdGNoOiBNYXRjaHxudWxsO1xuICAgIGlmICh0eXBlb2YgcmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoIXRoaXMucmVtYWluZGVyLnN0YXJ0c1dpdGgocmUpKSByZXR1cm4gZmFsc2U7XG4gICAgICBtYXRjaCA9IFtyZV0gYXMgTWF0Y2g7XG4gICAgfSBlbHNlIHtcbiAgICAgIG1hdGNoID0gcmUuZXhlYyh0aGlzLnJlbWFpbmRlcikgYXMgTWF0Y2h8bnVsbDtcbiAgICB9XG4gICAgaWYgKCFtYXRjaCkgcmV0dXJuIGZhbHNlO1xuICAgIG1hdGNoLmxpbmUgPSB0aGlzLmxpbmU7XG4gICAgbWF0Y2guY29sdW1uID0gdGhpcy5jb2x1bW47XG4gICAgdGhpcy5sYXN0TWF0Y2ggPSBtYXRjaDtcbiAgICB0aGlzLmFkdmFuY2UobWF0Y2hbMF0pO1xuXG4vLyAgICBjb25zb2xlLmxvZyhgVE9LRU46ICR7cmV9IFwiJHttYXRjaFswXX1cImApO1xuLy90cnl7dGhyb3cgRXJyb3IoKTt9Y2F0Y2goZSl7Y29uc29sZS5sb2coZSk7fVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBsb29rQmVoaW5kKHJlOiBSZWdFeHB8c3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHR5cGVvZiByZSA9PT0gJ3N0cmluZycpIHJldHVybiB0aGlzLnByZWZpeC5lbmRzV2l0aChyZSk7XG4gICAgY29uc3QgbWF0Y2ggPSByZS5leGVjKHRoaXMucHJlZml4KSBhcyBNYXRjaHxudWxsO1xuICAgIGlmICghbWF0Y2gpIHJldHVybiBmYWxzZTtcbiAgICBtYXRjaC5saW5lID0gdGhpcy5saW5lO1xuICAgIG1hdGNoLmNvbHVtbiA9IHRoaXMubGluZTtcbiAgICB0aGlzLmxhc3RNYXRjaCA9IG1hdGNoO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgbWF0Y2goKTogTWF0Y2h8dW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5sYXN0TWF0Y2g7XG4gIH1cblxuICBncm91cChpbmRleCA9IDApOiBzdHJpbmd8dW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5sYXN0TWF0Y2g/LltpbmRleF07XG4gIH1cblxuICBlb2YoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICF0aGlzLnJlbWFpbmRlcjtcbiAgfVxufVxuIl19