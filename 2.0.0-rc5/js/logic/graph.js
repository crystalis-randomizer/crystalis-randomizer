import { Bits } from '../bits.js';
import { hex } from '../rom/util.js';
import { Keyed, ArrayMap, MutableArrayBiMap, iters, spread } from '../util.js';
import { die } from '../assert.js';
export class Graph {
    constructor(worlds) {
        var _a;
        this.worlds = worlds;
        const provided = new Set();
        const required = new Set();
        const slots = new Map();
        const items = new Map();
        for (let i = 0; i < worlds.length; i++) {
            const world = worlds[i];
            const worldId = i << 24;
            for (const [providedId, requirement] of world.requirements) {
                provided.add(worldId | providedId);
                for (const route of requirement) {
                    for (const cond of route) {
                        required.add(worldId | cond);
                    }
                }
            }
            for (const [itemId, info] of world.items) {
                items.set((worldId | itemId), info);
            }
            for (const [slotId, info] of world.slots) {
                slots.set((worldId | slotId), info);
            }
        }
        this.itemInfos = new Map(items);
        this.slotInfos = new Map(slots);
        this.progression = new Set(required);
        for (const item of items.keys())
            required.add(item);
        const common = new Set();
        const extraProvides = new Set();
        const extraRequires = new Set();
        for (const check of required) {
            (provided.has(check) ? common : extraRequires).add(check);
        }
        for (const check of provided) {
            if (!required.has(check))
                extraProvides.add(check);
        }
        this.common = common.size;
        this.slots = new ArrayMap([...common, ...extraProvides]);
        this.items = new ArrayMap([...common, ...extraRequires]);
        const graph = [];
        const unlocks = [];
        for (let i = 0; i < worlds.length; i++) {
            const worldId = i << 24;
            for (const [slot, req] of worlds[i].requirements) {
                const slotIndex = this.slots.index((worldId | slot));
                if (slotIndex == null) {
                    throw new Error(`Provided a non-slot? ${hex(slot)}`);
                }
                for (const cs of req) {
                    const is = [...cs].map(c => { var _a; return (_a = this.items.index((worldId | c))) !== null && _a !== void 0 ? _a : die(); });
                    (graph[slotIndex] || (graph[slotIndex] = [])).push(Bits.from(is));
                    for (const i of is) {
                        (unlocks[i] || (unlocks[i] = new Set())).add(slotIndex);
                    }
                }
            }
        }
        for (let i = 0; i < this.slots.length; i++) {
            if (!graph[i] || !graph[i].length) {
                const id = (_a = this.slots.get(i)) !== null && _a !== void 0 ? _a : NaN;
                const name = this.checkName(id);
                console.error(`Nothing provided $${hex(id)}: ${name} (index ${i})`);
            }
        }
        this.graph = new Keyed(graph);
        this.unlocks = new Keyed(unlocks.map(spread));
    }
    async shuffle(flagset, random, attempts = 200, progress, spoiler) {
        if (progress)
            progress.addTasks(Math.floor(attempts / 10));
        for (let attempt = 0; attempt < attempts; attempt++) {
            if (progress && (attempt % 10 === 9)) {
                progress.addCompleted(1);
                await new Promise(requestAnimationFrame);
            }
            const fill = new MutableArrayBiMap();
            this.prefill(fill, random);
            const indexFill = this.compressFill(fill);
            const items = this.itemPool(indexFill.values(), random);
            let has = Bits.from(new Set(items));
            const backtracks = Math.floor(attempt / 5);
            if (!this.fillInternal(indexFill, items, has, random, flagset, backtracks)) {
                continue;
            }
            const path = spoiler ? [] : undefined;
            const final = this.traverse(i => indexFill.get(i), Bits.of(), path);
            if (final.size !== this.slots.length) {
                const ns = (si) => `${String(si).padStart(3)} ${this.slots.get(si).toString(16).padStart(3, '0')} ${this.checkName(this.slots.get(si))}`;
                const ni = (ii) => `${String(ii).padStart(3)} ${this.items.get(ii).toString(16).padStart(3, '0')} ${this.checkName(this.items.get(ii))}`;
                const missing = new Set([...this.slots].map(x => x[0]));
                for (const slot of final)
                    missing.delete(slot);
                const missingMap = new Map();
                for (const slot of missing) {
                    missingMap.set(ns(slot), this.graph.get(slot)
                        .map(r => '\n    ' + Bits.bits(r).map(ni)
                        .join(' & ')).join(''));
                }
                console.error(`Initial fill never reached slots:\n  ${[...missingMap.keys()].sort()
                    .map(k => k + missingMap.get(k)).join('\n  ')}`);
                continue;
            }
            this.expandFill(indexFill, fill);
            const out = this.fillNonProgression(fill, flagset, random);
            if (out == null)
                continue;
            if (progress) {
                progress.addCompleted(Math.floor((attempts - attempt) / 100));
            }
            if (spoiler) {
                for (const [slot, item] of fill) {
                    const name = this.checkName(slot).replace(/^[0-9a-f]{3} /, '');
                    spoiler.addSlot(slot, name, item);
                }
                if (path) {
                    for (const [target, ...deps] of path) {
                        if (target < this.common || indexFill.has(target)) {
                            spoiler.addCheck(this.slots.get(target), deps.map(d => this.items.get(d)));
                        }
                    }
                }
            }
            return out;
        }
        return null;
    }
    fillInternal(fill, items, has, random, flagset, backsteps) {
        var _a;
        const fixed = new Set(fill.keys());
        for (let bit = items.pop(); bit != null; bit = items.pop()) {
            if (!Bits.has(has, bit))
                continue;
            const itemInfo = this.itemInfoFromIndex(bit);
            has = Bits.without(has, bit);
            const reachable = this.expandReachable(this.traverse(i => fill.get(i), has), flagset);
            random.shuffle(reachable);
            let found = false;
            const checked = new Set(fill.keys());
            for (const slot of reachable) {
                if (checked.has(slot))
                    continue;
                checked.add(slot);
                const slotInfo = this.slotInfoFromIndex(slot);
                if (!slotInfo || !this.fits(slotInfo, itemInfo, flagset))
                    continue;
                fill.set(slot, bit);
                found = true;
                break;
            }
            if (found)
                continue;
            checked.clear();
            if (backsteps-- > 0) {
                for (const slot of reachable) {
                    if (checked.has(slot) || !fill.has(slot) || fixed.has(slot))
                        continue;
                    checked.add(slot);
                    const slotInfo = this.slotInfoFromIndex(slot);
                    if (!slotInfo || !this.fits(slotInfo, itemInfo, flagset))
                        continue;
                    const previousItem = (_a = fill.replace(slot, bit)) !== null && _a !== void 0 ? _a : die();
                    has = Bits.with(has, previousItem);
                    items.push(previousItem);
                    random.shuffle(items);
                    found = true;
                    break;
                }
                if (found)
                    continue;
            }
            return false;
        }
        return true;
    }
    expandReachable(slots, flagset) {
        const out = [];
        for (const slot of slots) {
            const info = this.slotInfoFromIndex(slot);
            if (!info || flagset.preserveUniqueChecks() && !info.unique)
                continue;
            addCopies(out, slot, info.weight || 1);
        }
        return out;
    }
    itemPool(exclude, random) {
        const excludeSet = new Set(exclude);
        const arr = [];
        for (const [id, info] of this.itemInfos) {
            const index = this.items.index(id);
            if (index == null)
                continue;
            if (!this.progression.has(id))
                continue;
            if (excludeSet.has(index))
                continue;
            addCopies(arr, index, info.weight || 1);
        }
        return random.shuffle(arr);
    }
    fits(slot, item, flagset) {
        if (flagset.preserveUniqueChecks() &&
            item.unique && !slot.unique) {
            return false;
        }
        const preventLoss = item.preventLoss || slot.preventLoss;
        if (slot.lossy && item.losable && preventLoss)
            return false;
        return true;
    }
    fillNonProgression(fill, flagset, random) {
        const itemPasses = [[], [], []];
        const slotPasses = [[], []];
        for (const [itemId, info] of this.itemInfos) {
            if (fill.hasValue(itemId))
                continue;
            let index = 2;
            if (info.losable && info.preventLoss)
                index = 1;
            if (flagset.preserveUniqueChecks() && info.unique)
                index = 0;
            itemPasses[index].push(itemId);
        }
        for (const [slotId, info] of this.slotInfos) {
            if (fill.has(slotId))
                continue;
            const index = info.lossy && info.preventLoss ? 0 : 1;
            slotPasses[index].push(slotId);
        }
        for (const pass of [...itemPasses, ...slotPasses]) {
            random.shuffle(pass);
        }
        const n = (si) => this.checkName(si);
        const sc = iters.count(iters.concat(...slotPasses));
        const ic = iters.count(iters.concat(...itemPasses));
        if (ic > sc) {
            console.log(`Slots ${sc}:\n  ${[...iters.concat(...slotPasses)].map(n).join('\n  ')}`);
            console.log(`Items ${ic}:\n  ${[...iters.concat(...itemPasses)].map(n).join('\n  ')}`);
            throw new Error(`Too many items`);
        }
        for (const item of iters.concat(...itemPasses)) {
            let found = false;
            for (const slots of [...slotPasses]) {
                if (found)
                    break;
                for (let i = 0; i < slots.length; i++) {
                    if (this.fits(this.slotInfos.get(slots[i]), this.itemInfos.get(item), flagset)) {
                        fill.set(slots[i], item);
                        found = true;
                        slots.splice(i, 1);
                        break;
                    }
                }
            }
            if (!found) {
                console.log(`Slots:\n  ${[...iters.concat(...slotPasses)].map(n).join('\n  ')}`);
                console.error(`REROLL: Could not place item ${n(item)}`);
                return null;
            }
        }
        return new Map(fill);
    }
    traverse(fill, has, path) {
        has = Bits.clone(has);
        const reachable = new Set();
        const queue = new Set();
        for (let i = 0; i < this.slots.length; i++) {
            if (this.graph.get(i) == null) {
                console.dir(this);
                const id = this.slots.get(i);
                throw new Error(`Unreachable slot ${id === null || id === void 0 ? void 0 : id.toString(16)}`);
            }
            queue.add(i);
        }
        for (const n of queue) {
            queue.delete(n);
            if (reachable.has(n))
                continue;
            const needed = this.graph.get(n);
            if (needed == null)
                throw new Error(`Not in graph: ${n}`);
            for (let i = 0, len = needed.length; i < len; i++) {
                if (!Bits.containsAll(has, needed[i]))
                    continue;
                if (path)
                    path.push([n, ...Bits.bits(needed[i])]);
                reachable.add(n);
                const items = [];
                if (n < this.common)
                    items.push(n);
                const filled = fill(n);
                if (filled != null)
                    items.push(filled);
                for (const item of items) {
                    has = Bits.with(has, item);
                    for (const j of this.unlocks.get(item) || []) {
                        if (this.graph.get(j) == null) {
                            console.dir(this);
                            throw new Error(`Adding bad node ${j} from unlock ${item}`);
                        }
                        queue.add(j);
                    }
                }
                break;
            }
        }
        return reachable;
    }
    expandFill(indexFill, fill) {
        for (const [slotIndex, itemIndex] of indexFill) {
            const slotId = this.slots.get(slotIndex);
            const itemId = this.items.get(itemIndex);
            if (slotId == null || itemId == null)
                throw new Error(`missing`);
            fill.replace(slotId, itemId);
        }
    }
    compressFill(fill) {
        const indexFill = new MutableArrayBiMap();
        for (const [slotId, itemId] of fill) {
            const slotIndex = this.slots.index(slotId);
            const itemIndex = this.items.index(itemId);
            if (slotIndex == null || itemIndex == null) {
                throw new Error(`Bad slot/item: ${slotId} ${slotIndex} ${itemId} ${itemIndex}`);
            }
            indexFill.set(slotIndex, itemIndex);
        }
        return indexFill;
    }
    checkName(id) {
        return this.worlds[id >>> 24].checkName(id & 0xffffff);
    }
    prefill(fill, random) {
        for (let i = 0; i < this.worlds.length; i++) {
            const worldId = i << 24;
            const worldFill = this.worlds[i].prefill(random);
            for (const [slot, item] of worldFill) {
                fill.set((worldId | slot), (worldId | item));
            }
        }
    }
    itemInfoFromIndex(item) {
        const id = this.items.get(item);
        if (id == null)
            throw new Error(`Bad item: ${item}`);
        return this.itemInfoFromId(id);
    }
    itemInfoFromId(id) {
        const info = this.itemInfos.get(id);
        if (info == null)
            throw new Error(`Missing info: ${hex(id)}`);
        return info;
    }
    slotInfoFromIndex(slot) {
        const id = this.slots.get(slot);
        if (id == null)
            throw new Error(`Bad slot: ${slot}`);
        return this.slotInfoFromId(id);
    }
    slotInfoFromId(id) {
        const info = this.slotInfos.get(id);
        if (info != null)
            return info;
        return undefined;
    }
}
function addCopies(arr, elem, copies) {
    for (let i = 0; i < copies; i++) {
        arr.push(elem);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbG9naWMvZ3JhcGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFlBQVksQ0FBQztBQUloQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUM3RSxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBeURqQyxNQUFNLE9BQU8sS0FBSztJQW9CaEIsWUFBNkIsTUFBK0I7O1FBQS9CLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBUTFELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDbkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUNuQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUMxQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN4QixLQUFLLE1BQU0sQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRTtnQkFDMUQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUM7Z0JBQ25DLEtBQUssTUFBTSxLQUFLLElBQUksV0FBVyxFQUFFO29CQUMvQixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTt3QkFDeEIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUM7cUJBQzlCO2lCQUNGO2FBQ0Y7WUFNRCxLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRTtnQkFDeEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUMvQztZQUNELEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO2dCQUN4QyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQy9DO1NBQ0Y7UUFHRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFaEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxRQUF1QixDQUFDLENBQUM7UUFDcEQsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVwRCxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ2pDLE1BQU0sYUFBYSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDeEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUN4QyxLQUFLLE1BQU0sS0FBSyxJQUFJLFFBQVEsRUFBRTtZQUM1QixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzNEO1FBQ0QsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLEVBQUU7WUFDNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO2dCQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEQ7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLEdBQUcsYUFBYSxDQUFhLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsR0FBRyxhQUFhLENBQWEsQ0FBQyxDQUFDO1FBR3JFLE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztRQUMzQixNQUFNLE9BQU8sR0FBMEIsRUFBRSxDQUFDO1FBQzFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3RDLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDeEIsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLEVBQUU7Z0JBQ2hELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBVyxDQUFDLENBQUM7Z0JBQy9ELElBQUksU0FBUyxJQUFJLElBQUksRUFBRTtvQkFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDdEQ7Z0JBQ0QsS0FBSyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUU7b0JBQ3BCLE1BQU0sRUFBRSxHQUNKLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsd0JBQ0osSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFXLENBQUMsbUNBQUksR0FBRyxFQUFFLEdBQUEsQ0FBQyxDQUFDO29CQUNwRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xFLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFO3dCQUNsQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7cUJBQ3pEO2lCQUNGO2FBQ0Y7U0FDRjtRQUdELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBYyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2RCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRTtnQkFDakMsTUFBTSxFQUFFLFNBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLG1DQUFJLEdBQWEsQ0FBQztnQkFDOUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3JFO1NBQ0Y7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQWdCLEVBQ2hCLE1BQWMsRUFDZCxRQUFRLEdBQUcsR0FBRyxFQUNkLFFBQTBCLEVBQzFCLE9BQWlCO1FBQzdCLElBQUksUUFBUTtZQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzRCxLQUFLLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRSxPQUFPLEdBQUcsUUFBUSxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ25ELElBQUksUUFBUSxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDcEMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsTUFBTSxJQUFJLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQzFDO1lBQ0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxpQkFBaUIsRUFBa0IsQ0FBQztZQUNyRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztZQUMzQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxFQUFFO2dCQUMxRSxTQUFTO2FBQ1Y7WUFDRCxNQUFNLElBQUksR0FBeUIsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUM1RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFHcEUsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO2dCQUNwQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQWEsRUFBRSxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUNuRCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsSUFDakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQyxFQUFFLENBQUM7Z0JBQzFDLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBYSxFQUFFLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQ25ELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUNqRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBRSxDQUFDLEVBQUUsQ0FBQztnQkFDMUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4RCxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUs7b0JBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0MsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7Z0JBQzdDLEtBQUssTUFBTSxJQUFJLElBQUksT0FBTyxFQUFFO29CQUMxQixVQUFVLENBQUMsR0FBRyxDQUNWLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFDUixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUU7eUJBQ2hCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsR0FBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBaUIsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO3lCQUN6RCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDakM7Z0JBUUQsT0FBTyxDQUFDLEtBQUssQ0FBQyx3Q0FDQSxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFO3FCQUN4QixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBR3BFLFNBQVM7YUFDVjtZQUNELElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzNELElBQUksR0FBRyxJQUFJLElBQUk7Z0JBQUUsU0FBUztZQUMxQixJQUFJLFFBQVEsRUFBRTtnQkFDWixRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUMvRDtZQUNELElBQUksT0FBTyxFQUFFO2dCQUNYLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUU7b0JBRS9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDL0QsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUNuQztnQkFDRCxJQUFJLElBQUksRUFBRTtvQkFDUixLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUU7d0JBQ3BDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFtQixDQUFDLEVBQUU7NEJBQzlELE9BQU8sQ0FBQyxRQUFRLENBQ1osSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBbUIsQ0FBRSxFQUNwQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBYyxDQUFFLENBQUMsQ0FBQyxDQUFDO3lCQUNyRDtxQkFDRjtpQkFDRjthQUNGO1lBQ0QsT0FBTyxHQUFHLENBQUM7U0FDWjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLFlBQVksQ0FBQyxJQUE2QyxFQUM3QyxLQUFrQixFQUNsQixHQUFTLEVBQ1QsTUFBYyxFQUNkLE9BQWdCLEVBQ2hCLFNBQWlCOztRQUNwQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNuQyxLQUFLLElBQUksR0FBRyxHQUEwQixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxJQUFJLElBQUksRUFBRSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2pGLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7Z0JBQUUsU0FBUztZQUNsQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0MsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sU0FBUyxHQUNYLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQ3BDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDMUIsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBQ2xCLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxFQUFFO2dCQUM1QixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO29CQUFFLFNBQVM7Z0JBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUM7b0JBQUUsU0FBUztnQkFDbkUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3BCLEtBQUssR0FBRyxJQUFJLENBQUM7Z0JBQ2IsTUFBTTthQUNQO1lBQ0QsSUFBSSxLQUFLO2dCQUFFLFNBQVM7WUFDcEIsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2hCLElBQUksU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUVuQixLQUFLLE1BQU0sSUFBSSxJQUFJLFNBQVMsRUFBRTtvQkFDNUIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQzt3QkFBRSxTQUFTO29CQUN0RSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNsQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQzlDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDO3dCQUFFLFNBQVM7b0JBQ25FLE1BQU0sWUFBWSxTQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxtQ0FBSSxHQUFHLEVBQUUsQ0FBQztvQkFDdEQsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO29CQUNuQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUN6QixNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN0QixLQUFLLEdBQUcsSUFBSSxDQUFDO29CQUNiLE1BQU07aUJBQ1A7Z0JBQ0QsSUFBSSxLQUFLO29CQUFFLFNBQVM7YUFDckI7WUFNRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBR08sZUFBZSxDQUFDLEtBQTBCLEVBQzFCLE9BQWdCO1FBQ3RDLE1BQU0sR0FBRyxHQUFnQixFQUFFLENBQUM7UUFDNUIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7WUFDeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTFDLElBQUksQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTtnQkFBRSxTQUFTO1lBQ3RFLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDeEM7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFTyxRQUFRLENBQUMsT0FBNEIsRUFBRSxNQUFjO1FBQzNELE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sR0FBRyxHQUFnQixFQUFFLENBQUM7UUFDNUIsS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDdkMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFbkMsSUFBSSxLQUFLLElBQUksSUFBSTtnQkFBRSxTQUFTO1lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQUUsU0FBUztZQUN4QyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO2dCQUFFLFNBQVM7WUFDcEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQztTQUN6QztRQUNELE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBTU8sSUFBSSxDQUFDLElBQWMsRUFBRSxJQUFjLEVBQUUsT0FBZ0I7UUFDM0QsSUFBSSxPQUFPLENBQUMsb0JBQW9CLEVBQUU7WUFDOUIsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDL0IsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN6RCxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxXQUFXO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFNUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsSUFBdUMsRUFDdkMsT0FBZ0IsRUFDaEIsTUFBYztRQU0vQixNQUFNLFVBQVUsR0FBZSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFNUMsTUFBTSxVQUFVLEdBQWUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFeEMsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDM0MsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztnQkFBRSxTQUFTO1lBQ3BDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztZQUNkLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsV0FBVztnQkFBRSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2hELElBQUksT0FBTyxDQUFDLG9CQUFvQixFQUFFLElBQUksSUFBSSxDQUFDLE1BQU07Z0JBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUM3RCxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hDO1FBQ0QsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDM0MsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztnQkFBRSxTQUFTO1lBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckQsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQztRQUNELEtBQUssTUFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLFVBQVUsRUFBRSxHQUFHLFVBQVUsQ0FBQyxFQUFFO1lBQ2pELE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdEI7UUFFRCxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QyxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDcEQsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkYsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ25DO1FBQ0QsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsVUFBVSxDQUFDLEVBQUU7WUFLOUMsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBQ2xCLEtBQUssTUFBTSxLQUFLLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxFQUFFO2dCQUNuQyxJQUFJLEtBQUs7b0JBQUUsTUFBTTtnQkFDakIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3JDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUUsRUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUU7d0JBQ2pELElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUN6QixLQUFLLEdBQUcsSUFBSSxDQUFDO3dCQUNiLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO3dCQUNuQixNQUFNO3FCQUNQO2lCQUNGO2FBQ0Y7WUFDRCxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUVWLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBRWpGLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3pELE9BQU8sSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUNELE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUlELFFBQVEsQ0FBQyxJQUE4QyxFQUM5QyxHQUFTLEVBQ1QsSUFBaUI7UUFDeEIsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWEsQ0FBQztRQUN2QyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBYSxDQUFDO1FBQ25DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBYyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2RCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLEVBQUUsYUFBRixFQUFFLHVCQUFGLEVBQUUsQ0FBRSxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3pEO1lBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFjLENBQUMsQ0FBQztTQUMzQjtRQUNELEtBQUssTUFBTSxDQUFDLElBQUksS0FBSyxFQUFFO1lBQ3JCLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEIsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFBRSxTQUFTO1lBRS9CLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLElBQUksTUFBTSxJQUFJLElBQUk7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMxRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUFFLFNBQVM7Z0JBQ2hELElBQUksSUFBSTtvQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xELFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBV2pCLE1BQU0sS0FBSyxHQUFnQixFQUFFLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNO29CQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBd0IsQ0FBQyxDQUFDO2dCQUMxRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLElBQUksTUFBTSxJQUFJLElBQUk7b0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdkMsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7b0JBQ3hCLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDM0IsS0FBSyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUU7d0JBQzVDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFOzRCQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixJQUFJLEVBQUUsQ0FBQyxDQUFDO3lCQUM3RDt3QkFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNkO2lCQUNGO2dCQUNELE1BQU07YUFDUDtTQUNGO1FBVUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVELFVBQVUsQ0FBQyxTQUFrRCxFQUNsRCxJQUF1QztRQUNoRCxLQUFLLE1BQU0sQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLElBQUksU0FBUyxFQUFFO1lBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pDLElBQUksTUFBTSxJQUFJLElBQUksSUFBSSxNQUFNLElBQUksSUFBSTtnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2pFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQzlCO0lBQ0gsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUF1QztRQUVsRCxNQUFNLFNBQVMsR0FBRyxJQUFJLGlCQUFpQixFQUF3QixDQUFDO1FBQ2hFLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFDbkMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0MsSUFBSSxTQUFTLElBQUksSUFBSSxJQUFJLFNBQVMsSUFBSSxJQUFJLEVBQUU7Z0JBSTFDLE1BQU0sSUFBSSxLQUFLLENBQ1gsa0JBQWtCLE1BQU0sSUFBSSxTQUFTLElBQUksTUFBTSxJQUFJLFNBQVMsRUFBRSxDQUFDLENBQUM7YUFDckU7WUFDRCxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUNyQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxTQUFTLENBQUMsRUFBVTtRQUNsQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUF1QyxFQUFFLE1BQWM7UUFDN0QsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzNDLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDeEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDakQsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLFNBQVMsRUFBRTtnQkFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQVcsRUFBRSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQVcsQ0FBQyxDQUFDO2FBQ2xFO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsaUJBQWlCLENBQUMsSUFBZTtRQUMvQixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLEVBQUUsSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLElBQUksRUFBRSxDQUFDLENBQUM7UUFDckQsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxjQUFjLENBQUMsRUFBVTtRQUN2QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNwQyxJQUFJLElBQUksSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5RCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxJQUFlO1FBQy9CLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLElBQUksRUFBRSxJQUFJLElBQUk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNyRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELGNBQWMsQ0FBQyxFQUFVO1FBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BDLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUU5QixPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBQ0Y7QUFFRCxTQUFTLFNBQVMsQ0FBSSxHQUFRLEVBQUUsSUFBTyxFQUFFLE1BQWM7SUFDckQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ2hCO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Qml0c30gZnJvbSAnLi4vYml0cy5qcyc7XG5pbXBvcnQge0ZsYWdTZXR9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1Nwb2lsZXJ9IGZyb20gJy4uL3JvbS9zcG9pbGVyLmpzJztcbmltcG9ydCB7aGV4fSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQge0tleWVkLCBBcnJheU1hcCwgTXV0YWJsZUFycmF5QmlNYXAsIGl0ZXJzLCBzcHJlYWR9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHtkaWV9IGZyb20gJy4uL2Fzc2VydC5qcyc7XG5cbi8qKiBJbnB1dCBmb3IgdGhlIGdyYXBoLiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2NhdGlvbkxpc3Qge1xuICB3b3JsZE5hbWU6IHN0cmluZztcbiAgaXRlbXM6IFJlYWRvbmx5TWFwPG51bWJlciwgSXRlbUluZm8+O1xuICBzbG90czogUmVhZG9ubHlNYXA8bnVtYmVyLCBTbG90SW5mbz47XG4gIHJlcXVpcmVtZW50czogUmVhZG9ubHlNYXA8bnVtYmVyLCBJdGVyYWJsZTxJdGVyYWJsZTxudW1iZXI+Pj47XG4gIGNoZWNrTmFtZTogKG5vZGU6IG51bWJlcikgPT4gc3RyaW5nO1xuICBwcmVmaWxsOiAocmFuZG9tOiBSYW5kb20pID0+IE1hcDxudW1iZXIsIG51bWJlcj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSXRlbUluZm8ge1xuICAvKiogVW5pcXVlIGl0ZW1zIGNhbiBvcHRpb25hbGx5IGJlIHNodWZmbGVkIHNlcGFyYXRlbHkuICovXG4gIHVuaXF1ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBMb3NhYmxlIGl0ZW1zIGFyZSBhdCByaXNrIG9mIGJlaW5nIGxvc3QgaWYgdGhleSBhcmUgcGxhY2VkIGluIGEgbG9zc3kgc2xvdFxuICAgKiAoaS5lLiBpZiB0aGUgaW52ZW50b3J5IGlzIGZ1bGwpLlxuICAgKi9cbiAgbG9zYWJsZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBMb3NhYmxlIGl0ZW1zIG1heSBiZSBwcm90ZWN0ZWQsIG1lYW5pbmcgdGhhdCB0aGV5IHdpbGwgbm90IGJlIHBsYWNlZCBpbiBhXG4gICAqIGxvc3N5IHNsb3QuXG4gICAqL1xuICBwcmV2ZW50TG9zcz86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXZWlnaHQgZm9yIHBsYWNlbWVudC4gIEhpZ2hlciBudW1iZXJzIGFyZSBtb3JlIGxpa2VseSB0byBiZSBwbGFjZWQgZWFybGllci5cbiAgICogRGVmYXVsdCBpcyAxLiAgUG93ZXJmdWwgYW5kIGltcG9ydGFudCBpdGVtcyBzaG91bGQgYmUgZ2l2ZW4gbGFyZ2VyIHdlaWdodHNcbiAgICogdG8gbWFrZSBpdCBsZXNzIGxpa2VseSB0aGF0IHRoZXkgYWx3YXlzIGVuZCB1cCBpbiBlYXJseSBzcGhlcmVzLlxuICAgKi9cbiAgd2VpZ2h0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNsb3RJbmZvIHtcbiAgLyoqIFdoZXRoZXIgdGhlIHNsb3QgY2FuIGhvbGQgYSB1bmlxdWUgaXRlbS4gKi9cbiAgdW5pcXVlPzogYm9vbGVhbjtcbiAgLyoqIFdoZXRoZXIgbG9zYWJsZSBpdGVtcyBpbiB0aGlzIHNsb3QgYXJlIGF0IHJpc2sgb2YgYmVpbmcgbG9zdC4gKi9cbiAgbG9zc3k6IGJvb2xlYW47XG4gIC8qKiBXaGV0aGVyIHRoZSBzbG90IGlzIGRpc2FsbG93ZWQgZnJvbSBsb3NpbmcgaXRlbXMgKGUuZy4gdHJpZ2dlcnMpLiAqL1xuICBwcmV2ZW50TG9zcz86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXZWlnaHQgZm9yIHBsYWNpbmcgcHJvZ3Jlc3Npb24gaXRlbXMuICBEZWZhdWx0IGlzIDEuICBVc2VmdWwgZm9yIG1ha2luZ1xuICAgKiBkaXN0YW50IGFuZCBvdXQtb2YtdGhlIHdheSBjaGVja3MgbW9yZSB3b3J0aHdoaWxlLiAgQWx0ZXJuYXRpdmVseSwgd2VcbiAgICogY291bGQganVzdCBhdm9pZCBldmVyIHBsYWNpbmcgbWltaWNzIGluIHRoZXNlIGFyZWFzP1xuICAgKi9cbiAgd2VpZ2h0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBTbG90SW5kZXggPSBudW1iZXIgJiB7X19zbG90SW5kZXhfXzogbmV2ZXJ9O1xuZXhwb3J0IHR5cGUgSXRlbUluZGV4ID0gbnVtYmVyICYge19faXRlbUluZGV4X186IG5ldmVyfTtcbmV4cG9ydCB0eXBlIFNsb3RJZCA9IG51bWJlciAmIHtfX3Nsb3RJZF9fOiBuZXZlcn07XG5leHBvcnQgdHlwZSBJdGVtSWQgPSBudW1iZXIgJiB7X19pdGVtSWRfXzogbmV2ZXJ9O1xuXG4vKipcbiAqIEEgZ3JhcGggZGF0YSBzdHJ1Y3R1cmUuICBJbml0aWFsaXplZCB3aXRoIG9uZSBvciBtb3JlIGxvY2F0aW9uIGxpc3RzXG4gKiAoYSBzZXQgb2YgRE5GIGV4cHJlc3Npb25zIHByb3ZpZGluZyBhIGJ1bmNoIG9mIG51bWVyaWMgZmxhZ3MpLlxuICovXG5leHBvcnQgY2xhc3MgR3JhcGgge1xuXG4gIC8vcHJpdmF0ZSByZWFkb25seSByZXZlcnNlV29ybGRzOiBSZWFkb25seU1hcDxMb2NhdGlvbkxpc3QsIG51bWJlcj47XG4gIHByaXZhdGUgcmVhZG9ubHkgY29tbW9uOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2xvdHM6IEFycmF5TWFwPFNsb3RJbmRleCwgU2xvdElkPjtcbiAgcHJpdmF0ZSByZWFkb25seSBpdGVtczogQXJyYXlNYXA8SXRlbUluZGV4LCBJdGVtSWQ+O1xuICAvLyBOb3RlIHRoYXQgbm90IGV2ZXJ5IGl0ZW0gZ2V0cyBhbiBpbmRleCAtIG9ubHkgdGhvc2UgaW4gdGhlIGdyYXBoLlxuICBwcml2YXRlIHJlYWRvbmx5IHNsb3RJbmZvczogUmVhZG9ubHlNYXA8U2xvdElkLCBTbG90SW5mbz47XG4gIHByaXZhdGUgcmVhZG9ubHkgaXRlbUluZm9zOiBSZWFkb25seU1hcDxJdGVtSWQsIEl0ZW1JbmZvPjtcblxuICAvLyBJdGVtcyB0aGF0IHByb3ZpZGUgcHJvZ3Jlc3Npb24uXG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvZ3Jlc3Npb246IFNldDxJdGVtSWQ+O1xuXG4gIC8vIC8qKiBNYXBwaW5nIG9mIHByb3ZpZGVzIHRvIHRoZSBzYW1lIHJlcXVpcmVzLiAqL1xuICAvLyBwcml2YXRlIHJlYWRvbmx5IGNvbW1vbkZpbGw6IEFycmF5TWFwPFNsb3RJbmRleCwgSXRlbUluZGV4PjtcblxuICAvKiogQml0c2V0cyBrZXllZCBieSBJdGVtSW5kZXgsIHJlcHJlc2VudCBhIERORiBjb25kaXRpb24uICovXG4gIHJlYWRvbmx5IGdyYXBoOiBLZXllZDxTbG90SW5kZXgsIHJlYWRvbmx5IEJpdHNbXT47XG4gIHJlYWRvbmx5IHVubG9ja3M6IEtleWVkPEl0ZW1JbmRleCwgcmVhZG9ubHkgU2xvdEluZGV4W10+O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgd29ybGRzOiByZWFkb25seSBMb2NhdGlvbkxpc3RbXSkge1xuICAgIC8vY29uc3QgcmV2ZXJzZVdvcmxkcyA9IG5ldyBNYXA8TG9jYXRpb25MaXN0LCBudW1iZXI+KCk7XG4gICAgLy9mb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkcy5sZW5ndGg7IGkrKykge1xuICAgIC8vICByZXZlcnNlV29ybGRzLnNldCh3b3JsZHNbaV0sIGkpO1xuICAgIC8vfVxuICAgIC8vdGhpcy5yZXZlcnNlV29ybGRzID0gcmV2ZXJzZVdvcmxkcztcblxuICAgIC8vIEJ1aWxkIHVwIGEgbGlzdCBvZiBhbGwga25vd24gcHJvdmlkZXMvcmVxdWlyZXMuXG4gICAgY29uc3QgcHJvdmlkZWQgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCByZXF1aXJlZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IHNsb3RzID0gbmV3IE1hcDxTbG90SWQsIFNsb3RJbmZvPigpO1xuICAgIGNvbnN0IGl0ZW1zID0gbmV3IE1hcDxJdGVtSWQsIEl0ZW1JbmZvPigpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd29ybGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB3b3JsZCA9IHdvcmxkc1tpXTtcbiAgICAgIGNvbnN0IHdvcmxkSWQgPSBpIDw8IDI0O1xuICAgICAgZm9yIChjb25zdCBbcHJvdmlkZWRJZCwgcmVxdWlyZW1lbnRdIG9mIHdvcmxkLnJlcXVpcmVtZW50cykge1xuICAgICAgICBwcm92aWRlZC5hZGQod29ybGRJZCB8IHByb3ZpZGVkSWQpO1xuICAgICAgICBmb3IgKGNvbnN0IHJvdXRlIG9mIHJlcXVpcmVtZW50KSB7XG4gICAgICAgICAgZm9yIChjb25zdCBjb25kIG9mIHJvdXRlKSB7XG4gICAgICAgICAgICByZXF1aXJlZC5hZGQod29ybGRJZCB8IGNvbmQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSAgICAgICAgXG4gICAgICB9XG5cbiAgICAgIC8vIFByb2JhYmx5IGp1c3QgbWFrZSBhIGNvbW1vbiBpbmRleCBmaWxsIGFuZCBkbyBhIGZ1bGwgaW5kaXJlY3Rpb24/XG4gICAgICAvLyAgLSBpZiBpdCdzIGluIHRoZSBjb21tb24gZmlsbCwgdXNlIGl0LCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIHRoZVxuICAgICAgLy8gICAgaXRlbSBmaWxsP1xuXG4gICAgICBmb3IgKGNvbnN0IFtpdGVtSWQsIGluZm9dIG9mIHdvcmxkLml0ZW1zKSB7XG4gICAgICAgIGl0ZW1zLnNldCgod29ybGRJZCB8IGl0ZW1JZCkgYXMgSXRlbUlkLCBpbmZvKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgW3Nsb3RJZCwgaW5mb10gb2Ygd29ybGQuc2xvdHMpIHtcbiAgICAgICAgc2xvdHMuc2V0KCh3b3JsZElkIHwgc2xvdElkKSBhcyBTbG90SWQsIGluZm8pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvcHkgdGhlIG1hcHMgYW5kIHNhdmUgdGhlbSBiZWZvcmUgd2Ugc3RhcnQgZGVsZXRpbmcgZWxlbWVudHMuXG4gICAgdGhpcy5pdGVtSW5mb3MgPSBuZXcgTWFwKGl0ZW1zKTtcbiAgICB0aGlzLnNsb3RJbmZvcyA9IG5ldyBNYXAoc2xvdHMpO1xuXG4gICAgdGhpcy5wcm9ncmVzc2lvbiA9IG5ldyBTZXQocmVxdWlyZWQgYXMgU2V0PEl0ZW1JZD4pO1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcy5rZXlzKCkpIHJlcXVpcmVkLmFkZChpdGVtKTsgLy8gbm9uLXByb2dyZXNzaW9uIGxhc3RcblxuICAgIGNvbnN0IGNvbW1vbiA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IGV4dHJhUHJvdmlkZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCBleHRyYVJlcXVpcmVzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCBjaGVjayBvZiByZXF1aXJlZCkge1xuICAgICAgKHByb3ZpZGVkLmhhcyhjaGVjaykgPyBjb21tb24gOiBleHRyYVJlcXVpcmVzKS5hZGQoY2hlY2spO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGNoZWNrIG9mIHByb3ZpZGVkKSB7XG4gICAgICBpZiAoIXJlcXVpcmVkLmhhcyhjaGVjaykpIGV4dHJhUHJvdmlkZXMuYWRkKGNoZWNrKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbW1vbiA9IGNvbW1vbi5zaXplO1xuICAgIHRoaXMuc2xvdHMgPSBuZXcgQXJyYXlNYXAoWy4uLmNvbW1vbiwgLi4uZXh0cmFQcm92aWRlc10gYXMgU2xvdElkW10pO1xuICAgIHRoaXMuaXRlbXMgPSBuZXcgQXJyYXlNYXAoWy4uLmNvbW1vbiwgLi4uZXh0cmFSZXF1aXJlc10gYXMgSXRlbUlkW10pO1xuXG4gICAgLy8gQnVpbGQgdXAgdGhlIGdyYXBoIG5vdyB0aGF0IHdlIGhhdmUgdGhlIGFycmF5IG1hcHMuXG4gICAgY29uc3QgZ3JhcGg6IEJpdHNbXVtdID0gW107XG4gICAgY29uc3QgdW5sb2NrczogQXJyYXk8U2V0PFNsb3RJbmRleD4+ID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3b3JsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHdvcmxkSWQgPSBpIDw8IDI0O1xuICAgICAgZm9yIChjb25zdCBbc2xvdCwgcmVxXSBvZiB3b3JsZHNbaV0ucmVxdWlyZW1lbnRzKSB7XG4gICAgICAgIGNvbnN0IHNsb3RJbmRleCA9IHRoaXMuc2xvdHMuaW5kZXgoKHdvcmxkSWQgfCBzbG90KSBhcyBTbG90SWQpO1xuICAgICAgICBpZiAoc2xvdEluZGV4ID09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3ZpZGVkIGEgbm9uLXNsb3Q/ICR7aGV4KHNsb3QpfWApO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgY3Mgb2YgcmVxKSB7XG4gICAgICAgICAgY29uc3QgaXMgPVxuICAgICAgICAgICAgICBbLi4uY3NdLm1hcChjID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMuaW5kZXgoKHdvcmxkSWQgfCBjKSBhcyBJdGVtSWQpID8/IGRpZSgpKTtcbiAgICAgICAgICAoZ3JhcGhbc2xvdEluZGV4XSB8fCAoZ3JhcGhbc2xvdEluZGV4XSA9IFtdKSkucHVzaChCaXRzLmZyb20oaXMpKTtcbiAgICAgICAgICBmb3IgKGNvbnN0IGkgb2YgaXMpIHtcbiAgICAgICAgICAgICh1bmxvY2tzW2ldIHx8ICh1bmxvY2tzW2ldID0gbmV3IFNldCgpKSkuYWRkKHNsb3RJbmRleCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2FuaXR5IGNoZWNrIHRvIG1ha2Ugc3VyZSBhbGwgc2xvdHMgYXJlIHByb3ZpZGVkLlxuICAgIGZvciAobGV0IGkgPSAwIGFzIFNsb3RJbmRleDsgaSA8IHRoaXMuc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICghZ3JhcGhbaV0gfHwgIWdyYXBoW2ldLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBpZCA9IHRoaXMuc2xvdHMuZ2V0KGkpID8/IE5hTiBhcyBTbG90SWQ7XG4gICAgICAgIGNvbnN0IG5hbWUgPSB0aGlzLmNoZWNrTmFtZShpZCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYE5vdGhpbmcgcHJvdmlkZWQgJCR7aGV4KGlkKX06ICR7bmFtZX0gKGluZGV4ICR7aX0pYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZ3JhcGggPSBuZXcgS2V5ZWQoZ3JhcGgpO1xuICAgIHRoaXMudW5sb2NrcyA9IG5ldyBLZXllZCh1bmxvY2tzLm1hcChzcHJlYWQpKTtcbiAgfVxuXG4gIGFzeW5jIHNodWZmbGUoZmxhZ3NldDogRmxhZ1NldCxcbiAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICBhdHRlbXB0cyA9IDIwMCwgLy8gMFxuICAgICAgICAgICAgICAgIHByb2dyZXNzPzogUHJvZ3Jlc3NUcmFja2VyLFxuICAgICAgICAgICAgICAgIHNwb2lsZXI/OiBTcG9pbGVyKTogUHJvbWlzZTxNYXA8U2xvdElkLCBJdGVtSWQ+fG51bGw+IHtcbiAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzLmFkZFRhc2tzKE1hdGguZmxvb3IoYXR0ZW1wdHMgLyAxMCkpO1xuICAgIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgYXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgICAgaWYgKHByb2dyZXNzICYmIChhdHRlbXB0ICUgMTAgPT09IDkpKSB7XG4gICAgICAgIHByb2dyZXNzLmFkZENvbXBsZXRlZCgxKTtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVxdWVzdEFuaW1hdGlvbkZyYW1lKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZpbGwgPSBuZXcgTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+KCk7XG4gICAgICB0aGlzLnByZWZpbGwoZmlsbCwgcmFuZG9tKTtcbiAgICAgIGNvbnN0IGluZGV4RmlsbCA9IHRoaXMuY29tcHJlc3NGaWxsKGZpbGwpO1xuICAgICAgY29uc3QgaXRlbXMgPSB0aGlzLml0ZW1Qb29sKGluZGV4RmlsbC52YWx1ZXMoKSwgcmFuZG9tKTtcbiAgICAgIGxldCBoYXMgPSBCaXRzLmZyb20obmV3IFNldChpdGVtcykpO1xuICAgICAgY29uc3QgYmFja3RyYWNrcyA9IE1hdGguZmxvb3IoYXR0ZW1wdCAvIDUpO1xuICAgICAgaWYgKCF0aGlzLmZpbGxJbnRlcm5hbChpbmRleEZpbGwsIGl0ZW1zLCBoYXMsIHJhbmRvbSwgZmxhZ3NldCwgYmFja3RyYWNrcykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXRoOiBudW1iZXJbXVtdfHVuZGVmaW5lZCA9IHNwb2lsZXIgPyBbXSA6IHVuZGVmaW5lZDtcbiAgICAgIGNvbnN0IGZpbmFsID0gdGhpcy50cmF2ZXJzZShpID0+IGluZGV4RmlsbC5nZXQoaSksIEJpdHMub2YoKSwgcGF0aCk7XG4gICAgICAvLyBUT0RPIC0gZmxhZ3MgdG8gbG9vc2VuIHRoaXMgcmVxdWlyZW1lbnQgKGJlZm9yZSBsb2dnaW5nKT8/P1xuICAgICAgLy8gICAgICAtIGJ1dCBpdCdzIGFsc28gYSB1c2VmdWwgZGlhZ25vc3RpYy5cbiAgICAgIGlmIChmaW5hbC5zaXplICE9PSB0aGlzLnNsb3RzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBucyA9IChzaTogU2xvdEluZGV4KSA9PiBgJHtTdHJpbmcoc2kpLnBhZFN0YXJ0KDMpfSAke1xuICAgICAgICAgICAgdGhpcy5zbG90cy5nZXQoc2kpIS50b1N0cmluZygxNikucGFkU3RhcnQoMywgJzAnKX0gJHtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tOYW1lKHRoaXMuc2xvdHMuZ2V0KHNpKSEpfWA7XG4gICAgICAgIGNvbnN0IG5pID0gKGlpOiBJdGVtSW5kZXgpID0+IGAke1N0cmluZyhpaSkucGFkU3RhcnQoMyl9ICR7XG4gICAgICAgICAgICB0aGlzLml0ZW1zLmdldChpaSkhLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgzLCAnMCcpfSAke1xuICAgICAgICAgICAgdGhpcy5jaGVja05hbWUodGhpcy5pdGVtcy5nZXQoaWkpISl9YDtcbiAgICAgICAgY29uc3QgbWlzc2luZyA9IG5ldyBTZXQoWy4uLnRoaXMuc2xvdHNdLm1hcCh4ID0+IHhbMF0pKTtcbiAgICAgICAgZm9yIChjb25zdCBzbG90IG9mIGZpbmFsKSBtaXNzaW5nLmRlbGV0ZShzbG90KTtcbiAgICAgICAgY29uc3QgbWlzc2luZ01hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gICAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiBtaXNzaW5nKSB7XG4gICAgICAgICAgbWlzc2luZ01hcC5zZXQoXG4gICAgICAgICAgICAgIG5zKHNsb3QpLFxuICAgICAgICAgICAgICB0aGlzLmdyYXBoLmdldChzbG90KSFcbiAgICAgICAgICAgICAgICAgIC5tYXAociA9PiAnXFxuICAgICcgKyAoQml0cy5iaXRzKHIpIGFzIEl0ZW1JbmRleFtdKS5tYXAobmkpXG4gICAgICAgICAgICAgICAgICAuam9pbignICYgJykpLmpvaW4oJycpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBOT1RFOiBwYXRoW2ldWzBdIGlzIHNsb3QgaW5kZXhlcywgbm90IGl0ZW1zLCBzbyB0aGlzIGRvZXMgbm90IHdvcmsuXG4gICAgICAgIC8vIGNvbnN0IGhhcyA9XG4gICAgICAgIC8vICAgICAobmV3IFNldChwYXRoID8gcGF0aC5tYXAoaSA9PiBpWzBdKSA6IHNlcSh0aGlzLml0ZW1zLmxlbmd0aCkpKSBhc1xuICAgICAgICAvLyAgICAgICAgIFNldDxJdGVtSW5kZXg+O1xuICAgICAgICAvLyBjb25zdCBub3RIYXMgPVxuICAgICAgICAvLyAgICAgc2VxKHRoaXMuaXRlbXMubGVuZ3RoLCBpID0+IGkgYXMgSXRlbUluZGV4KS5maWx0ZXIoaSA9PiAhaGFzLmhhcyhpKSlcbiAgICAgICAgLy8gICAgICAgICAuc29ydCgoYSwgYikgPT4gYSAtIGIpLm1hcChuaSk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEluaXRpYWwgZmlsbCBuZXZlciByZWFjaGVkIHNsb3RzOlxcbiAgJHtcbiAgICAgICAgICAgICAgICAgICAgICBbLi4ubWlzc2luZ01hcC5rZXlzKCldLnNvcnQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKGsgPT4gayArIG1pc3NpbmdNYXAuZ2V0KGspISkuam9pbignXFxuICAnKX1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAvLyB9XFxuVW5hdmFpbGFibGUgaXRlbXM6XFxuICAke25vdEhhcy5qb2luKCdcXG4gICcpfWApO1xuICAgICAgICAgICAgICAgICAgICAgIC8vIGZpbmFsLCB0aGlzKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0aGlzLmV4cGFuZEZpbGwoaW5kZXhGaWxsLCBmaWxsKTtcbiAgICAgIGNvbnN0IG91dCA9IHRoaXMuZmlsbE5vblByb2dyZXNzaW9uKGZpbGwsIGZsYWdzZXQsIHJhbmRvbSk7XG4gICAgICBpZiAob3V0ID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgaWYgKHByb2dyZXNzKSB7XG4gICAgICAgIHByb2dyZXNzLmFkZENvbXBsZXRlZChNYXRoLmZsb29yKChhdHRlbXB0cyAtIGF0dGVtcHQpIC8gMTAwKSk7XG4gICAgICB9XG4gICAgICBpZiAoc3BvaWxlcikge1xuICAgICAgICBmb3IgKGNvbnN0IFtzbG90LCBpdGVtXSBvZiBmaWxsKSB7XG4gICAgICAgICAgLy8gVE9ETyAtIGNsZWFuIHRoaXMgdXAuXG4gICAgICAgICAgY29uc3QgbmFtZSA9IHRoaXMuY2hlY2tOYW1lKHNsb3QpLnJlcGxhY2UoL15bMC05YS1mXXszfSAvLCAnJyk7XG4gICAgICAgICAgc3BvaWxlci5hZGRTbG90KHNsb3QsIG5hbWUsIGl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwYXRoKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBbdGFyZ2V0LCAuLi5kZXBzXSBvZiBwYXRoKSB7XG4gICAgICAgICAgICBpZiAodGFyZ2V0IDwgdGhpcy5jb21tb24gfHwgaW5kZXhGaWxsLmhhcyh0YXJnZXQgYXMgU2xvdEluZGV4KSkge1xuICAgICAgICAgICAgICBzcG9pbGVyLmFkZENoZWNrKFxuICAgICAgICAgICAgICAgICAgdGhpcy5zbG90cy5nZXQodGFyZ2V0IGFzIFNsb3RJbmRleCkhLFxuICAgICAgICAgICAgICAgICAgZGVwcy5tYXAoZCA9PiB0aGlzLml0ZW1zLmdldChkIGFzIEl0ZW1JbmRleCkhKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb3V0O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgZmlsbEludGVybmFsKGZpbGw6IE11dGFibGVBcnJheUJpTWFwPFNsb3RJbmRleCwgSXRlbUluZGV4PixcbiAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IEl0ZW1JbmRleFtdLFxuICAgICAgICAgICAgICAgICAgICAgICBoYXM6IEJpdHMsXG4gICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbTogUmFuZG9tLFxuICAgICAgICAgICAgICAgICAgICAgICBmbGFnc2V0OiBGbGFnU2V0LFxuICAgICAgICAgICAgICAgICAgICAgICBiYWNrc3RlcHM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGZpeGVkID0gbmV3IFNldChmaWxsLmtleXMoKSk7XG4gICAgZm9yIChsZXQgYml0OiBJdGVtSW5kZXggfCB1bmRlZmluZWQgPSBpdGVtcy5wb3AoKTsgYml0ICE9IG51bGw7IGJpdCA9IGl0ZW1zLnBvcCgpKSB7XG4gICAgICBpZiAoIUJpdHMuaGFzKGhhcywgYml0KSkgY29udGludWU7IC8vIGl0ZW0gYWxyZWFkeSBwbGFjZWQ6IHNraXBcbiAgICAgIGNvbnN0IGl0ZW1JbmZvID0gdGhpcy5pdGVtSW5mb0Zyb21JbmRleChiaXQpO1xuICAgICAgaGFzID0gQml0cy53aXRob3V0KGhhcywgYml0KTtcbiAgICAgIGNvbnN0IHJlYWNoYWJsZSA9XG4gICAgICAgICAgdGhpcy5leHBhbmRSZWFjaGFibGUodGhpcy50cmF2ZXJzZShpID0+IGZpbGwuZ2V0KGkpLCBoYXMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWdzZXQpO1xuICAgICAgcmFuZG9tLnNodWZmbGUocmVhY2hhYmxlKTtcbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgY29uc3QgY2hlY2tlZCA9IG5ldyBTZXQoZmlsbC5rZXlzKCkpO1xuICAgICAgZm9yIChjb25zdCBzbG90IG9mIHJlYWNoYWJsZSkge1xuICAgICAgICBpZiAoY2hlY2tlZC5oYXMoc2xvdCkpIGNvbnRpbnVlO1xuICAgICAgICBjaGVja2VkLmFkZChzbG90KTtcbiAgICAgICAgY29uc3Qgc2xvdEluZm8gPSB0aGlzLnNsb3RJbmZvRnJvbUluZGV4KHNsb3QpO1xuICAgICAgICBpZiAoIXNsb3RJbmZvIHx8ICF0aGlzLmZpdHMoc2xvdEluZm8sIGl0ZW1JbmZvLCBmbGFnc2V0KSkgY29udGludWU7XG4gICAgICAgIGZpbGwuc2V0KHNsb3QsIGJpdCk7XG4gICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBpZiAoZm91bmQpIGNvbnRpbnVlO1xuICAgICAgY2hlY2tlZC5jbGVhcigpO1xuICAgICAgaWYgKGJhY2tzdGVwcy0tID4gMCkge1xuICAgICAgICAvLyB0YWtlIGEgYmFjay1zdGVwXG4gICAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgICBpZiAoY2hlY2tlZC5oYXMoc2xvdCkgfHwgIWZpbGwuaGFzKHNsb3QpIHx8IGZpeGVkLmhhcyhzbG90KSkgY29udGludWU7XG4gICAgICAgICAgY2hlY2tlZC5hZGQoc2xvdCk7XG4gICAgICAgICAgY29uc3Qgc2xvdEluZm8gPSB0aGlzLnNsb3RJbmZvRnJvbUluZGV4KHNsb3QpO1xuICAgICAgICAgIGlmICghc2xvdEluZm8gfHwgIXRoaXMuZml0cyhzbG90SW5mbywgaXRlbUluZm8sIGZsYWdzZXQpKSBjb250aW51ZTtcbiAgICAgICAgICBjb25zdCBwcmV2aW91c0l0ZW0gPSBmaWxsLnJlcGxhY2Uoc2xvdCwgYml0KSA/PyBkaWUoKTtcbiAgICAgICAgICBoYXMgPSBCaXRzLndpdGgoaGFzLCBwcmV2aW91c0l0ZW0pO1xuICAgICAgICAgIGl0ZW1zLnB1c2gocHJldmlvdXNJdGVtKTtcbiAgICAgICAgICByYW5kb20uc2h1ZmZsZShpdGVtcyk7XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmb3VuZCkgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBjb25zdCBucyA9IChzaTogU2xvdEluZGV4KSA9PiB0aGlzLmNoZWNrTmFtZSh0aGlzLnNsb3RzLmdldChzaSkhKTtcbiAgICAgIC8vIGNvbnN0IG5pID0gKGlpOiBJdGVtSW5kZXgpID0+IHRoaXMuY2hlY2tOYW1lKHRoaXMuaXRlbXMuZ2V0KGlpKSEpO1xuICAgICAgLy8gY29uc29sZS5sb2coYFBvb2w6XFxuICAke2l0ZW1zLm1hcChuaSkuam9pbignXFxuICAnKX1gKTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGBGaWxsOlxcbiAgJHtbLi4uZmlsbF0ubWFwKChbcyxpXSkgPT4gYCR7bnMocyl9OiAke25pKGkpfWApLmpvaW4oJ1xcbiAgJyl9YCk7XG4gICAgICAvLyBjb25zb2xlLmVycm9yKGBSRVJPTEw6IENvdWxkIG5vdCBwbGFjZSBpdGVtIGluZGV4ICR7Yml0fTogJHtuaShiaXQpfWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8vIGFkZHMgd2VpZ2h0c1xuICBwcml2YXRlIGV4cGFuZFJlYWNoYWJsZShzbG90czogSXRlcmFibGU8U2xvdEluZGV4PixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ3NldDogRmxhZ1NldCk6IFNsb3RJbmRleFtdIHtcbiAgICBjb25zdCBvdXQ6IFNsb3RJbmRleFtdID0gW107XG4gICAgZm9yIChjb25zdCBzbG90IG9mIHNsb3RzKSB7XG4gICAgICBjb25zdCBpbmZvID0gdGhpcy5zbG90SW5mb0Zyb21JbmRleChzbG90KTtcbiAgICAgIC8vIGRvbid0IGJvdGhlciB3aXRoIG5vbi11bmlxdWUgc2xvdHMgYXQgdGhpcyBzdGFnZS5cbiAgICAgIGlmICghaW5mbyB8fCBmbGFnc2V0LnByZXNlcnZlVW5pcXVlQ2hlY2tzKCkgJiYgIWluZm8udW5pcXVlKSBjb250aW51ZTtcbiAgICAgIGFkZENvcGllcyhvdXQsIHNsb3QsIGluZm8ud2VpZ2h0IHx8IDEpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgcHJpdmF0ZSBpdGVtUG9vbChleGNsdWRlOiBJdGVyYWJsZTxJdGVtSW5kZXg+LCByYW5kb206IFJhbmRvbSk6IEl0ZW1JbmRleFtdIHtcbiAgICBjb25zdCBleGNsdWRlU2V0ID0gbmV3IFNldChleGNsdWRlKTtcbiAgICBjb25zdCBhcnI6IEl0ZW1JbmRleFtdID0gW107XG4gICAgZm9yIChjb25zdCBbaWQsIGluZm9dIG9mIHRoaXMuaXRlbUluZm9zKSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuaXRlbXMuaW5kZXgoaWQpO1xuICAgICAgLy8gc2tpcCBub24tcHJvZ3Jlc3Npb24gYW5kIGFscmVhZHktcGxhY2VkIGl0ZW1zXG4gICAgICBpZiAoaW5kZXggPT0gbnVsbCkgY29udGludWU7XG4gICAgICBpZiAoIXRoaXMucHJvZ3Jlc3Npb24uaGFzKGlkKSkgY29udGludWU7XG4gICAgICBpZiAoZXhjbHVkZVNldC5oYXMoaW5kZXgpKSBjb250aW51ZTtcbiAgICAgIGFkZENvcGllcyhhcnIsIGluZGV4LCBpbmZvLndlaWdodCB8fCAxKTtcbiAgICB9XG4gICAgcmV0dXJuIHJhbmRvbS5zaHVmZmxlKGFycik7XG4gIH1cblxuICAvLyBUT0RPIC0gaW5zdGVhZCBvZiBwbHVtYmluZyB0aGUgZmxhZ3NldCB0aHJvdWdoIGhlcmUsIGNvbnNpZGVyXG4gIC8vIGJ1aWxkaW5nIGl0IGludG8gdGhlIFNsb3RJbmZvPyAgT3IgdGhlIEl0ZW1JbmZvLCBzaW5jZSBpdCdzXG4gIC8vIHBvc3NpYmxlIGZvciBhIHVuaXF1ZSBzbG90IHRvIGFjY2VwdCBhIG5vbnVuaXF1ZSBpdGVtLCBidXRcbiAgLy8gYSB1bmlxdWUgaXRlbSBtdXN0IGJlIGluIGEgdW5pcXVlIHNsb3QuLi4gc2FtZSBkaWZmZXJlbmNlXG4gIHByaXZhdGUgZml0cyhzbG90OiBTbG90SW5mbywgaXRlbTogSXRlbUluZm8sIGZsYWdzZXQ6IEZsYWdTZXQpOiBib29sZWFuIHtcbiAgICBpZiAoZmxhZ3NldC5wcmVzZXJ2ZVVuaXF1ZUNoZWNrcygpICYmXG4gICAgICAgIGl0ZW0udW5pcXVlICYmICFzbG90LnVuaXF1ZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBwcmV2ZW50TG9zcyA9IGl0ZW0ucHJldmVudExvc3MgfHwgc2xvdC5wcmV2ZW50TG9zcztcbiAgICBpZiAoc2xvdC5sb3NzeSAmJiBpdGVtLmxvc2FibGUgJiYgcHJldmVudExvc3MpIHJldHVybiBmYWxzZTtcbiAgICAvLyBUT0RPIC0gZmxhZyBmb3IgXCJwcm90ZWN0IGFsbCBsb3NhYmxlIGl0ZW1zXCJcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGZpbGxOb25Qcm9ncmVzc2lvbihmaWxsOiBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SWQsIEl0ZW1JZD4sXG4gICAgICAgICAgICAgICAgICAgICBmbGFnc2V0OiBGbGFnU2V0LFxuICAgICAgICAgICAgICAgICAgICAgcmFuZG9tOiBSYW5kb20pOiBNYXA8U2xvdElkLCBJdGVtSWQ+fG51bGwge1xuICAgIC8vIEZpZ3VyZSBvdXQgd2hhdCBzdGlsbCBuZWVkcyB0byBiZSBmaWxsZWQuICBXaWxsIGJlIG1vc3RseSBmaWxsZXJcbiAgICAvLyBpdGVtcy4gIEl0ZW1zIGFyZSBzcGxpdCBpbnRvIHRocmVlIGdyb3VwczogKDEpIGZpcnN0IGl0ZW1zIGlzIGFueVxuICAgIC8vIHVuaXF1ZXMgdGhhdCBuZWVkIHRvIGdvIGludG8gdW5pcXVlIHNsb3RzIChpLmUuIG9ubHkgaWYgYEV1YCBpc1xuICAgIC8vIHNldCksICgyKSBlYXJseSBpdGVtcyBpcyBhbnl0aGluZyB0aGF0IG5lZWRzIHNwZWNpYWwgdHJlYXRtZW50IHRvXG4gICAgLy8gcHJldmVudCBwbGFjZW1lbnQgaW4gYSBsb3NzeSBzbG90LCAoMykgb3RoZXIgaXRlbXMgaXMgZXZlcnl0aGluZyBlbHNlLlxuICAgIGNvbnN0IGl0ZW1QYXNzZXM6IEl0ZW1JZFtdW10gPSBbW10sIFtdLCBbXV07XG4gICAgLy8gU2xvdHMgYXJlIGJyb2tlbiBpbnRvIHR3byBwYXNzZXM6ICgxKSByZXN0cmljdGVkIGFuZCAoMikgdW5yZXN0cmljdGVkLlxuICAgIGNvbnN0IHNsb3RQYXNzZXM6IFNsb3RJZFtdW10gPSBbW10sIFtdXTtcblxuICAgIGZvciAoY29uc3QgW2l0ZW1JZCwgaW5mb10gb2YgdGhpcy5pdGVtSW5mb3MpIHtcbiAgICAgIGlmIChmaWxsLmhhc1ZhbHVlKGl0ZW1JZCkpIGNvbnRpbnVlO1xuICAgICAgbGV0IGluZGV4ID0gMjtcbiAgICAgIGlmIChpbmZvLmxvc2FibGUgJiYgaW5mby5wcmV2ZW50TG9zcykgaW5kZXggPSAxO1xuICAgICAgaWYgKGZsYWdzZXQucHJlc2VydmVVbmlxdWVDaGVja3MoKSAmJiBpbmZvLnVuaXF1ZSkgaW5kZXggPSAwO1xuICAgICAgaXRlbVBhc3Nlc1tpbmRleF0ucHVzaChpdGVtSWQpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtzbG90SWQsIGluZm9dIG9mIHRoaXMuc2xvdEluZm9zKSB7XG4gICAgICBpZiAoZmlsbC5oYXMoc2xvdElkKSkgY29udGludWU7XG4gICAgICBjb25zdCBpbmRleCA9IGluZm8ubG9zc3kgJiYgaW5mby5wcmV2ZW50TG9zcyA/IDAgOiAxO1xuICAgICAgc2xvdFBhc3Nlc1tpbmRleF0ucHVzaChzbG90SWQpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHBhc3Mgb2YgWy4uLml0ZW1QYXNzZXMsIC4uLnNsb3RQYXNzZXNdKSB7XG4gICAgICByYW5kb20uc2h1ZmZsZShwYXNzKTtcbiAgICB9XG5cbiAgICBjb25zdCBuID0gKHNpOiBudW1iZXIpID0+IHRoaXMuY2hlY2tOYW1lKHNpKTtcbiAgICBjb25zdCBzYyA9IGl0ZXJzLmNvdW50KGl0ZXJzLmNvbmNhdCguLi5zbG90UGFzc2VzKSk7XG4gICAgY29uc3QgaWMgPSBpdGVycy5jb3VudChpdGVycy5jb25jYXQoLi4uaXRlbVBhc3NlcykpO1xuICAgIGlmIChpYyA+IHNjKSB7XG4gICAgICBjb25zb2xlLmxvZyhgU2xvdHMgJHtzY306XFxuICAke1suLi5pdGVycy5jb25jYXQoLi4uc2xvdFBhc3NlcyldLm1hcChuKS5qb2luKCdcXG4gICcpfWApO1xuICAgICAgY29uc29sZS5sb2coYEl0ZW1zICR7aWN9OlxcbiAgJHtbLi4uaXRlcnMuY29uY2F0KC4uLml0ZW1QYXNzZXMpXS5tYXAobikuam9pbignXFxuICAnKX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVG9vIG1hbnkgaXRlbXNgKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZXJzLmNvbmNhdCguLi5pdGVtUGFzc2VzKSkge1xuICAgICAgLy8gVHJ5IHRvIHBsYWNlIHRoZSBpdGVtLCBzdGFydGluZyB3aXRoIGVhcmxpZXMgZmlyc3QuXG4gICAgICAvLyBNaW1pY3MgY29tZSBiZWZvcmUgY29uc3VtYWJsZXMgYmVjYXVzZSB0aGVyZSdzIGZld2VyIHBsYWNlcyB0aGV5IGNhbiBnby5cbiAgICAgIC8vIFNpbmNlIGtleSBzbG90cyBhcmUgYWxsb3dlZCB0byBjb250YWluIGNvbnN1bWFibGVzIChldmVuIGluIGZ1bGwgc2h1ZmZsZSksXG4gICAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSB1bmlxdWVzIGdvIGludG8gdGhvc2Ugc2xvdHMgZmlyc3QuXG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAoY29uc3Qgc2xvdHMgb2YgWy4uLnNsb3RQYXNzZXNdKSB7XG4gICAgICAgIGlmIChmb3VuZCkgYnJlYWs7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAodGhpcy5maXRzKHRoaXMuc2xvdEluZm9zLmdldChzbG90c1tpXSkhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtSW5mb3MuZ2V0KGl0ZW0pISwgZmxhZ3NldCkpIHtcbiAgICAgICAgICAgIGZpbGwuc2V0KHNsb3RzW2ldLCBpdGVtKTtcbiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgIHNsb3RzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICAvLyBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZmlsbCBleHRyYSBpdGVtICR7aXRlbX0uIFNsb3RzOiAke2Vhcmx5U2xvdHN9LCAke290aGVyU2xvdHN9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBTbG90czpcXG4gICR7Wy4uLml0ZXJzLmNvbmNhdCguLi5zbG90UGFzc2VzKV0ubWFwKG4pLmpvaW4oJ1xcbiAgJyl9YCk7XG4gICAgICAgIC8vY29uc29sZS5sb2coYEZpbGw6XFxuICAke1suLi5maWxsXS5tYXAoKFtzLGldKSA9PiBgJHtucyhzKX06ICR7bmkoaSl9YCkuam9pbignXFxuICAnKX1gKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihgUkVST0xMOiBDb3VsZCBub3QgcGxhY2UgaXRlbSAke24oaXRlbSl9YCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV3IE1hcChmaWxsKTtcbiAgfVxuXG4gIC8vIE5PVEU6IGZvciBhbiBJbmRleEZpbGwsIHRoaXMgaXMganVzdCBnZXQoKSwgYnV0IGZvclxuICAvLyBhbiBJZEZpbGwsIHdlIG5lZWQgdG8gbWFwIGl0IGJhY2sgYW5kIGZvcnRoLi4uXG4gIHRyYXZlcnNlKGZpbGw6IChzbG90OiBTbG90SW5kZXgpID0+IEl0ZW1JbmRleHx1bmRlZmluZWQsXG4gICAgICAgICAgIGhhczogQml0cyxcbiAgICAgICAgICAgcGF0aD86IG51bWJlcltdW10pOiBTZXQ8U2xvdEluZGV4PiB7XG4gICAgaGFzID0gQml0cy5jbG9uZShoYXMpO1xuICAgIGNvbnN0IHJlYWNoYWJsZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICAgIGNvbnN0IHF1ZXVlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gICAgZm9yIChsZXQgaSA9IDAgYXMgU2xvdEluZGV4OyBpIDwgdGhpcy5zbG90cy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRoaXMuZ3JhcGguZ2V0KGkpID09IG51bGwpIHtcbiAgICAgICAgY29uc29sZS5kaXIodGhpcyk7XG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5zbG90cy5nZXQoaSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWFjaGFibGUgc2xvdCAke2lkPy50b1N0cmluZygxNil9YCk7XG4gICAgICB9XG4gICAgICBxdWV1ZS5hZGQoaSBhcyBTbG90SW5kZXgpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IG4gb2YgcXVldWUpIHtcbiAgICAgIHF1ZXVlLmRlbGV0ZShuKTtcbiAgICAgIGlmIChyZWFjaGFibGUuaGFzKG4pKSBjb250aW51ZTtcbiAgICAgIC8vIGNhbiB3ZSByZWFjaCBpdD9cbiAgICAgIGNvbnN0IG5lZWRlZCA9IHRoaXMuZ3JhcGguZ2V0KG4pO1xuICAgICAgaWYgKG5lZWRlZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYE5vdCBpbiBncmFwaDogJHtufWApO1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IG5lZWRlZC5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBpZiAoIUJpdHMuY29udGFpbnNBbGwoaGFzLCBuZWVkZWRbaV0pKSBjb250aW51ZTtcbiAgICAgICAgaWYgKHBhdGgpIHBhdGgucHVzaChbbiwgLi4uQml0cy5iaXRzKG5lZWRlZFtpXSldKTtcbiAgICAgICAgcmVhY2hhYmxlLmFkZChuKTtcbiAgICAgICAgLy8gVE9ETyAtLS0gbmVlZCB0byBmaWd1cmUgb3V0IHdoYXQgdG8gZG8gaGVyZS5cbiAgICAgICAgLy8gICAgICAtLS0gZmlsbCB3b3VsZCBsaWtlIHRvIGJlIHplcm8tYmFzZWQgYnV0IGRvZXNuJ3QgbmVlZCB0byBiZS5cbiAgICAgICAgLy8gICAgICAgICAgY291bGQgdXNlIGEgc2ltcGxlIHBhaXIgb2YgTWFwcywgcG9zc2libHk/XG4gICAgICAgIC8vICAgICAgICAgIG9yIGZyb250LWxvYWQgdGhlIGl0ZW1zP1xuICAgICAgICAvLyAgIHNsb3RzOiAxeHggb3RoZXJzXG4gICAgICAgIC8vICAgaXRlbXM6IDJ4eCBvdGhlcnNcbiAgICAgICAgLy8gYnV0IHdlIHdhbnQgc2FtZSBmbGFncyB0byBoYXZlIHNhbWUgaW5kZXhcbiAgICAgICAgLy8gICBzbG90czogKGZpeGVkKSAocmVxdWlyZWQgc2xvdHMpIChleHRyYSBzbG90cylcbiAgICAgICAgLy8gICBpdGVtczogKGZpeGVkKSAocmVxdWlyZWQgc2xvdHMpIChpdGVtcylcbiAgICAgICAgLy8gaWYgbiBpcyBhIHNsb3QgdGhlbiBhZGQgdGhlIGl0ZW0gdG8gaGFzLlxuICAgICAgICBjb25zdCBpdGVtczogSXRlbUluZGV4W10gPSBbXTtcbiAgICAgICAgaWYgKG4gPCB0aGlzLmNvbW1vbikgaXRlbXMucHVzaChuIGFzIG51bWJlciBhcyBJdGVtSW5kZXgpO1xuICAgICAgICBjb25zdCBmaWxsZWQgPSBmaWxsKG4pO1xuICAgICAgICBpZiAoZmlsbGVkICE9IG51bGwpIGl0ZW1zLnB1c2goZmlsbGVkKTtcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgaXRlbSk7XG4gICAgICAgICAgZm9yIChjb25zdCBqIG9mIHRoaXMudW5sb2Nrcy5nZXQoaXRlbSkgfHwgW10pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmdyYXBoLmdldChqKSA9PSBudWxsKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZGlyKHRoaXMpO1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFkZGluZyBiYWQgbm9kZSAke2p9IGZyb20gdW5sb2NrICR7aXRlbX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHF1ZXVlLmFkZChqKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSWYgd2UgZ2V0IGVycm9ycyBhYm91dCBpbml0aWFsIGZpbGwgbmV2ZXIgZmlsbGVkIHNsb3RzLCBzZWUgd2hhdFxuICAgIC8vIGl0ZW1zIGFyZSBtaXNzaW5nIChub3RlOiByb20gaXMgZ2xvYmFsKVxuLy8gICAgIGlmKHBhdGgpY29uc29sZS5sb2cobmV3IEFycmF5KHRoaXMuaXRlbXMubGVuZ3RoKS5maWxsKDApLm1hcCgoXyxpKSA9PiBpKVxuLy8gICAgICAgICAuZmlsdGVyKGk9PiFCaXRzLmhhcyhoYXMsIGkpKS5tYXAoaSA9PiBbaSx0aGlzLml0ZW1zLmdldChpKV0pLnNvcnQoKGEsYik9PmFbMV0tYlsxXSlcbi8vICAgICAgICAgLm1hcCgoW2osaV0pID0+IGAke1N0cmluZyhqKS5wYWRTdGFydCgzKX0gJHtoZXgoaSkucGFkU3RhcnQoMywnMCcpfSAke1xuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVja05hbWUoaSl9YCkuam9pbignXFxuJykpO1xuLy8gKHdpbmRvdyBhcyBhbnkpLkZJTkFMSEFTID0gaGFzO1xuXG4gICAgcmV0dXJuIHJlYWNoYWJsZTtcbiAgfVxuXG4gIGV4cGFuZEZpbGwoaW5kZXhGaWxsOiBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SW5kZXgsIEl0ZW1JbmRleD4sXG4gICAgICAgICAgICAgZmlsbDogTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+KSB7XG4gICAgZm9yIChjb25zdCBbc2xvdEluZGV4LCBpdGVtSW5kZXhdIG9mIGluZGV4RmlsbCkge1xuICAgICAgY29uc3Qgc2xvdElkID0gdGhpcy5zbG90cy5nZXQoc2xvdEluZGV4KTtcbiAgICAgIGNvbnN0IGl0ZW1JZCA9IHRoaXMuaXRlbXMuZ2V0KGl0ZW1JbmRleCk7XG4gICAgICBpZiAoc2xvdElkID09IG51bGwgfHwgaXRlbUlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgbWlzc2luZ2ApO1xuICAgICAgZmlsbC5yZXBsYWNlKHNsb3RJZCwgaXRlbUlkKTtcbiAgICB9XG4gIH1cblxuICBjb21wcmVzc0ZpbGwoZmlsbDogTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+KTpcbiAgTXV0YWJsZUFycmF5QmlNYXA8U2xvdEluZGV4LCBJdGVtSW5kZXg+IHtcbiAgICBjb25zdCBpbmRleEZpbGwgPSBuZXcgTXV0YWJsZUFycmF5QmlNYXA8U2xvdEluZGV4LCBJdGVtSW5kZXg+KCk7XG4gICAgZm9yIChjb25zdCBbc2xvdElkLCBpdGVtSWRdIG9mIGZpbGwpIHtcbiAgICAgIGNvbnN0IHNsb3RJbmRleCA9IHRoaXMuc2xvdHMuaW5kZXgoc2xvdElkKTtcbiAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IHRoaXMuaXRlbXMuaW5kZXgoaXRlbUlkKTtcbiAgICAgIGlmIChzbG90SW5kZXggPT0gbnVsbCB8fCBpdGVtSW5kZXggPT0gbnVsbCkge1xuICAgICAgICAvLyBUT0RPIC0gdGhpcyBpcyBub3QgdW5yZWFzb25hYmxlIC0gd2UgY2FuIHByZS1maWxsIGEgc2xvdCAoYWx3YXlzXG4gICAgICAgIC8vIHRyYWNrZWQpIHdpdGggYSBub24tcHJvZ3Jlc3Npb24gaXRlbS4uLiBob3cgdG8gaGFuZGxlPyB3aGF0IHRvIG1hcFxuICAgICAgICAvLyB0bz8gIENhbiB3ZSBtYWtlIHVwIGEgZHVtbXkgaW5kZXggb3Igc29tZXRoaW5nP1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQmFkIHNsb3QvaXRlbTogJHtzbG90SWR9ICR7c2xvdEluZGV4fSAke2l0ZW1JZH0gJHtpdGVtSW5kZXh9YCk7XG4gICAgICB9XG4gICAgICBpbmRleEZpbGwuc2V0KHNsb3RJbmRleCwgaXRlbUluZGV4KTtcbiAgICB9XG4gICAgcmV0dXJuIGluZGV4RmlsbDtcbiAgfVxuXG4gIGNoZWNrTmFtZShpZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy53b3JsZHNbaWQgPj4+IDI0XS5jaGVja05hbWUoaWQgJiAweGZmZmZmZik7XG4gIH1cblxuICBwcmVmaWxsKGZpbGw6IE11dGFibGVBcnJheUJpTWFwPFNsb3RJZCwgSXRlbUlkPiwgcmFuZG9tOiBSYW5kb20pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMud29ybGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB3b3JsZElkID0gaSA8PCAyNDtcbiAgICAgIGNvbnN0IHdvcmxkRmlsbCA9IHRoaXMud29ybGRzW2ldLnByZWZpbGwocmFuZG9tKTtcbiAgICAgIGZvciAoY29uc3QgW3Nsb3QsIGl0ZW1dIG9mIHdvcmxkRmlsbCkge1xuICAgICAgICBmaWxsLnNldCgod29ybGRJZCB8IHNsb3QpIGFzIFNsb3RJZCwgKHdvcmxkSWQgfCBpdGVtKSBhcyBJdGVtSWQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGl0ZW1JbmZvRnJvbUluZGV4KGl0ZW06IEl0ZW1JbmRleCk6IEl0ZW1JbmZvIHtcbiAgICBjb25zdCBpZCA9IHRoaXMuaXRlbXMuZ2V0KGl0ZW0pO1xuICAgIGlmIChpZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBpdGVtOiAke2l0ZW19YCk7XG4gICAgcmV0dXJuIHRoaXMuaXRlbUluZm9Gcm9tSWQoaWQpO1xuICB9XG5cbiAgaXRlbUluZm9Gcm9tSWQoaWQ6IEl0ZW1JZCk6IEl0ZW1JbmZvIHtcbiAgICBjb25zdCBpbmZvID0gdGhpcy5pdGVtSW5mb3MuZ2V0KGlkKTtcbiAgICBpZiAoaW5mbyA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgaW5mbzogJHtoZXgoaWQpfWApO1xuICAgIHJldHVybiBpbmZvO1xuICB9XG5cbiAgc2xvdEluZm9Gcm9tSW5kZXgoc2xvdDogU2xvdEluZGV4KTogU2xvdEluZm98dW5kZWZpbmVkIHtcbiAgICBjb25zdCBpZCA9IHRoaXMuc2xvdHMuZ2V0KHNsb3QpO1xuICAgIGlmIChpZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzbG90OiAke3Nsb3R9YCk7XG4gICAgcmV0dXJuIHRoaXMuc2xvdEluZm9Gcm9tSWQoaWQpO1xuICB9XG5cbiAgc2xvdEluZm9Gcm9tSWQoaWQ6IFNsb3RJZCk6IFNsb3RJbmZvfHVuZGVmaW5lZCB7XG4gICAgY29uc3QgaW5mbyA9IHRoaXMuc2xvdEluZm9zLmdldChpZCk7XG4gICAgaWYgKGluZm8gIT0gbnVsbCkgcmV0dXJuIGluZm87XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGluZm86ICR7aGV4KGlkKX1gKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFkZENvcGllczxUPihhcnI6IFRbXSwgZWxlbTogVCwgY29waWVzOiBudW1iZXIpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3BpZXM7IGkrKykge1xuICAgIGFyci5wdXNoKGVsZW0pO1xuICB9XG59XG5cblxuLy8gVE9ETyAtIGNsZWFuIHRoaXMgdXBcbmludGVyZmFjZSBQcm9ncmVzc1RyYWNrZXIge1xuICBhZGRUYXNrcyh0YXNrczogbnVtYmVyKTogdm9pZDtcbiAgYWRkQ29tcGxldGVkKHRhc2tzOiBudW1iZXIpOiB2b2lkO1xufVxuIl19