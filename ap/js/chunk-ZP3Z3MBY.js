import{$ as Jt,A as go,B as Ui,C as Ki,D as ji,E as Vi,F as ne,G as j,H as Yt,I as Xi,J as bt,K as le,L as Us,M as Fe,N as Zt,O as Ks,P as Ce,Q as wt,R as we,S as Yi,T as Ye,U as js,V as ot,W as Zi,X as Ji,Y as H,Z as bo,_ as ke,a as G,aa as Qt,ba as yt,ca as Wt,d as Os,da as wo,e as W,ea as Vs,f as oe,fa as Ne,g as Xt,ga as yo,h as Dt,ha as Me,i as zs,ia as So,j as Wi,ja as Qi,k as _t,ka as Co,l as $s,la as en,m as qs,ma as tn,n as de,na as es,o as Nt,p as Oi,pa as sn,q as zi,qa as nn,r as ho,s as Hs,sa as ko,t as uo,u as mo,v as $i,w as po,x as qi,y as xo,z as Hi}from"./chunk-D3GLTBRY.js";var ts,vo,Io,ss,rn=G(()=>{vo=()=>{let n;ts=new Uint32Array(256);for(let t=0;t<256;t++){n=t;for(let e=0;e<8;e++)n=n&1?3988292384^n>>>1:n>>>1;ts[t]=n}},Io=n=>n.split("").map(t=>t.charCodeAt(0)),ss=n=>{ts||vo(),typeof n=="string"&&(n=Io(n));let t=-1;for(let e=0,s=n.length;e<s;e++)t=t>>>8^ts[(t^n[e])&255];return(t^-1)>>>0}});function on(n){return n.toLowerCase().replace(/[^a-z]/g,"")}var is,Xs,Ys,ve,he,ze,Zs,pe,Re,T,at,_,We,D,Ot,Ge,zt,Z,Oe,U,St,J,Ze,K,Je,V,$t,Qe,Ct,ce,lt,an=G(()=>{de();is=n=>"",Xs=n=>n===!0?!1:n,Ys=class{constructor(t,e){this.flag=t;this.opts=e;Ys.flags.set(t,this)}static all(){return[...this.flags.values()]}},ve=Ys;ve.flags=new Map;he=class{constructor(t,e,s,i){this.name=e;this.description=s;this.flags=i.map(r=>r instanceof ve?[r,!0]:r),t.presets.set(on(e),this)}static all(){return ze.instance||(ze.instance=new ze),[...ze.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new lt(`@${this.name}`))),this._flagString}};ze=class{constructor(){this.presets=new Map;this.Casual=new he(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[U.PreserveUniqueChecks,U.NoShuffleMimics,U.DecreaseEnemyDamage,U.GuaranteeRefresh,U.GuaranteeStartingSword,U.ExperienceScalesFaster,U.NoCommunityJokes,_.NoThunderSwordWarp,V.Shops,V.Dyna,[V.Maps,"!"],[V.WildWarp,"!"],ce.SpoilerLog]);this.Classic=new he(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[U.GuaranteeStartingSword,U.NoCommunityJokes,D.StatueGlitch,[_.NoThunderSwordWarp,"!"],[V.Maps,"!"],ce.SpoilerLog]);this.Standard=new he(this,"Standard",`
      Well-balanced, standard race flags.`,[Z.RandomizeWeaknesses,_.StoryMode,ce.SpoilerLog]);this.NoBowMode=new he(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[Z.RandomizeWeaknesses,Z.TowerRobots,K.MaxScalingInTower,_.NoBowMode,ce.SpoilerLog]);this.Advanced=new he(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[D.GhettoFlight,D.MtSabreRequirementSkip,D.StatueGlitch,[D.SwordChargeGlitch,"!"],J.Barrier,J.BattleMagic,J.GasMask,K.MaxScalingInTower,Z.RandomizeWeaknesses,Z.TowerRobots,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.UnidentifiedKeyItems,ce.SpoilerLog]);this.WildWarp=new he(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[U.GuaranteeRefresh,T.RandomizeWildWarp,Z.RandomizeWeaknesses,Z.TowerRobots,_.OrbsNotRequired,_.StoryMode,ce.SpoilerLog]);this.Mystery=new he(this,"Mystery",`
      Even the options are random.`,[[T.ShuffleAreas,"?"],[T.ShuffleHouses,"?"],[T.RandomizeMaps,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeWildWarp,"?"],[_.OrbsNotRequired,"?"],[_.NoBowMode,"?"],[_.StoryMode,"?"],[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[D.RageSkip,"?"],[D.TriggerSkip,"?"],[D.StatueGlitch,"?"],[D.GhettoFlight,"?"],[D.SwordChargeGlitch,"?"],[D.MtSabreRequirementSkip,"?"],[Ge.RandomizeMusic,"?"],[Ge.RandomizeMapColors,"?"],[Z.RandomizeWeaknesses,"?"],[Z.TowerRobots,"?"],[U.NoShuffleMimics,"?"],[U.PreserveUniqueChecks,"?"],[J.Barrier,"?"],[J.BattleMagic,"?"],[J.GasMask,"?"],[V.Dyna,"?"],[V.BonusItems,"?"],[V.Maps,"?"],ce.SpoilerLog]);this.Hardcore=new he(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[J.Barrier,J.BattleMagic,K.ExperienceScalesSlower,K.MaxScalingInTower,K.Permadeath,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.UnidentifiedKeyItems]);this.FullStupid=new he(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[J.Barrier,J.BattleMagic,K.Blackout,K.ExperienceScalesSlower,K.MaxScalingInTower,K.Permadeath,Z.RandomizeWeaknesses,Z.TowerRobots,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.ShuffleGoaFloors,T.UnidentifiedKeyItems]);this.Tournament2023=new he(this,"Tournament 2023",`
      This year's tournament flags debuts some interesting new flags for a
      unique challenge.`,[T.RandomizeTrades,T.UnidentifiedKeyItems,T.RandomizeWallElements,T.ShuffleGoaFloors,[_.StoryMode,"?"],_.OrbsNotRequired,_.NoThunderSwordWarp,D.GhettoFlight,D.StatueGlitch,D.MtSabreRequirementSkip,Z.RandomizeWeaknesses,[Z.OopsAllMimics,"?"],Z.TowerRobots,J.BattleMagic,J.Barrier,K.MaxScalingInTower,[K.ChargeShotsOnly,"?"]]);this.Tournament2022Early=new he(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[U.GuaranteeStartingSword,D.StatueGlitch,D.StatueGauntletSkip,[Z.RandomizeWeaknesses,"?"],_.OrbsNotRequired,_.StoryMode,[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new he(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[U.GuaranteeStartingSword,"?"],[D.GhettoFlight,"?"],[D.StatueGlitch,"?"],[D.MtSabreRequirementSkip,"?"],[D.StatueGauntletSkip,"?"],K.MaxScalingInTower,[K.NoBuffMedicalHerb,"?"],[Z.RandomizeWeaknesses,"?"],[Z.TowerRobots,"?"],[J.Barrier,"?"],[J.BattleMagic,"?"],_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new he(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[U.GuaranteeStartingSword,"?"],D.GhettoFlight,D.StatueGlitch,D.MtSabreRequirementSkip,D.StatueGauntletSkip,K.NoBuffMedicalHerb,K.MaxScalingInTower,[Z.RandomizeWeaknesses,"?"],[Z.TowerRobots,"?"],J.Barrier,J.BattleMagic,_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],T.ShuffleHouses,[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]])}static get(t){return this.instance||(this.instance=new ze),this.instance.presets.get(on(t))}},Zs=class{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(t,e){Zs.sections.add(this.instance||(this.instance=new this));let s=new ve(t,e);if(!t.startsWith(this.instance.prefix))throw new Error(`bad flag ${t} ${e}`);return this.instance.flags.set(t,s),s}},pe=Zs;pe.sections=new Set;Re=class extends pe{constructor(){super(...arguments);this.prefix="W";this.name="World"}},T=Re;T.RandomizeMaps=Re.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0}),T.ShuffleAreas=Re.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0}),T.ShuffleHouses=Re.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0}),T.RandomizeTrades=Re.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, and Fog
           Lamp.  Rage will expect a random sword, and Tornel will expect a
           random bracelet.`,hard:!0}),T.UnidentifiedKeyItems=Re.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0}),T.RandomizeWallElements=Re.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`}),T.ShuffleGoaFloors=Re.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."}),T.RandomizeSpriteColors=Re.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`}),T.RandomizeWildWarp=Re.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]});at=class extends pe{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}},_=at;_.StoryMode=at.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`}),_.NoBowMode=at.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`}),_.OrbsNotRequired=at.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."}),_.NoThunderSwordWarp=at.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"}),_.VanillaDolphin=at.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`});We=class extends pe{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}},D=We;D.GhettoFlight=We.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`}),D.StatueGlitch=We.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"}),D.MtSabreRequirementSkip=We.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"}),D.StatueGauntletSkip=We.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"}),D.SwordChargeGlitch=We.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"}),D.TriggerSkip=We.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"}),D.RageSkip=We.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"});Ot=class extends pe{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}},Ge=Ot;Ge.RandomizeMusic=Ot.flag("Am",{name:"Randomize background music",modes:"!",optional:Xs}),Ge.NoMusic=Ot.flag("As",{name:"No background music",optional:is}),Ge.RandomizeMapColors=Ot.flag("Ac",{name:"Randomize map colors",modes:"!",optional:Xs});zt=class extends pe{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}},Z=zt;Z.RandomizeWeaknesses=zt.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."}),Z.OopsAllMimics=zt.flag("Mg",{name:"Replace all chests with mimics",text:`Every chest is now a mimic, and killing the mimic will drop
           the real item chest. Careful when killing the mimic, if it
           drops the chest out of reach you'll need to reset the room!`,hard:!0}),Z.TowerRobots=zt.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0});Oe=class extends pe{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}},U=Oe;U.NoShuffleMimics=Oe.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."}),U.PreserveUniqueChecks=Oe.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`}),U.DecreaseEnemyDamage=Oe.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`}),U.GuaranteeStartingSword=Oe.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`}),U.GuaranteeRefresh=Oe.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`}),U.ExperienceScalesFaster=Oe.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]}),U.NoCommunityJokes=Oe.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`});St=class extends pe{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}},J=St;J.BattleMagic=St.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0}),J.MatchingSword=St.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0}),J.Barrier=St.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0}),J.GasMask=St.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0});Ze=class extends pe{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}},K=Ze;K.NoBuffMedicalHerb=Ze.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0}),K.MaxScalingInTower=Ze.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0}),K.ExperienceScalesSlower=Ze.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0}),K.ChargeShotsOnly=Ze.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0}),K.Blackout=Ze.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0}),K.Permadeath=Ze.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});Je=class extends pe{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}},V=Je;V.Dyna=Je.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`}),V.BonusItems=Je.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`}),V.Maps=Je.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"}),V.Shops=Je.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`}),V.WildWarp=Je.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"}),V.Hud=Je.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:Xs});$t=class extends pe{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}},Qe=$t;Qe.NoAutoEquip=$t.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:is}),Qe.NoControllerShortcuts=$t.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:is}),Qe.AudibleWallCues=$t.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:is});Ct=class extends pe{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}},ce=Ct;ce.SpoilerLog=Ct.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`}),ce.TrainerMode=Ct.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`}),ce.NeverDie=Ct.flag("Di",{name:"Player never dies"}),ce.NoShuffle=Ct.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`});lt=class{constructor(t="@Casual"){if(typeof t!="string"){this.flags=new Map;for(let[i,r]of t)this.set(i.flag,r);return}if(t.startsWith("@")){let i=ze.get(t.substring(1));if(!i)throw new Os(`Unknown preset: ${t}`);this.flags=new Map(i.flags);return}this.flags=new Map,t=t.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,s;for(;s=e.exec(t);){let[,i,r]=s,o=/([!?]|^)([a-z0-9]+)/g;for(;s=o.exec(r);){let[,a,l]=s;for(let c of l)this.set(i+c,a||!0)}}}filterOptional(){return new lt(new Map([...this.flags].map(([t,e])=>[t,t.opts.optional?t.opts.optional(e):e])))}filterRandom(t){function e(s,i){return i!=="?"?i:t.pick([!0,!1,...s.opts.modes||""])}return new lt(new Map([...this.flags].map(([s,i])=>[s,e(s,i)])))}toString(){let t=new W(()=>new W(()=>[]));for(let[s,i]of this.flags){if(s.flag.length!==2)throw new Error(`Bad flag ${s.flag}`);if(!i)continue;let r=t.get(s.flag[0]),o=i===!0?"":i;r.get(o).push(s.flag[1])}let e=[];for(let[s,i]of t.sortedEntries()){let r=s;for(let[o,a]of i.sortedEntries())r+=o+a.sort().join("");e.push(r)}return e.join(" ")}toggle(t){let e=ve.flags.get(t);if(!e)return console.error(`Bad flag: ${t}`),!1;let s=this.flags.get(e)||!1,i=[!1,!0,...e.opts.modes||"","?",!1],r=i.indexOf(s);if(r<0)throw new Error(`Bad current mode ${s}`);let o=i[r+1];return this.flags.set(e,o),o}set(t,e){let s=ve.flags.get(t);if(!s){console.error(`Bad flag: ${t}`);return}if(!e)this.flags.delete(s);else if(e===!0||e==="?"||s.opts.modes?.includes(e))this.flags.set(s,e);else{console.error(`Bad flag mode: ${t[0]}${e}${t.substring(1)}`);return}for(let i of s.opts.excludes||[])this.flags.delete(ve.flags.get(i))}check(t,...e){let s=t instanceof ve?t:ve.flags.get(t);return e.length||e.push(!0),e.includes(s&&this.flags.get(s)||!1)}get(t){let e=t instanceof ve?t:ve.flags.get(t);return e&&this.flags.get(e)||!1}alwaysMimics(){return this.check(Z.OopsAllMimics)}preserveUniqueChecks(){return this.check(U.PreserveUniqueChecks)}shuffleMimics(){return this.check(U.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(V.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(V.BonusItems,!1)}slowDownTornado(){return this.check(V.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(V.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(V.BonusItems,!1)||this.check(K.ChargeShotsOnly)}shuffleSpritePalettes(){return this.check(T.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(V.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(Z.TowerRobots)}shuffleMonsterElements(){return this.check(Z.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(K.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check(U.DecreaseEnemyDamage)}trainer(){return this.check(ce.TrainerMode)}neverDie(){return this.check(ce.NeverDie)}noShuffle(){return this.check(ce.NoShuffle)}chargeShotsOnly(){return this.check(K.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(V.Maps,"!")}addEastCave(){return this.check(V.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(_.VanillaDolphin,!1)}storyMode(){return this.check(_.StoryMode)}noBowMode(){return this.check(_.NoBowMode)}requireHealedDolphinToRide(){return this.check(_.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(_.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(_.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(_.OrbsNotRequired)}shuffleGoaFloors(){return this.check(T.ShuffleGoaFloors)}shuffleHouses(){return this.check(T.ShuffleHouses)}shuffleAreas(){return this.check(T.ShuffleAreas)}mayShuffleAreas(){return!this.check(T.ShuffleAreas,!1)}randomizeMaps(){return this.check(T.RandomizeMaps)}randomizeTrades(){return this.check(T.RandomizeTrades)}unidentifiedItems(){return this.check(T.UnidentifiedKeyItems)}randomizeWalls(){return this.check(T.RandomizeWallElements)}guaranteeSword(){return this.check(U.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(J.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(J.MatchingSword,!1)}guaranteeGasMask(){return this.check(J.GasMask,!1)}guaranteeBarrier(){return this.check(J.Barrier,!1)}guaranteeRefresh(){return this.check(U.GuaranteeRefresh)}communityJokes(){return this.check(U.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(D.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(D.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(D.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(V.Shops,!1)}disableStatueGlitch(){return this.check(D.StatueGlitch,!1)}disableRageSkip(){return this.check(D.RageSkip,!1)}disableTriggerGlitch(){return this.check(D.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(D.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(D.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(D.GhettoFlight)}assumeTeleportSkip(){return this.check(D.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(D.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(D.StatueGlitch)}assumeTriggerGlitch(){return this.check(D.TriggerSkip)}assumeFlightStatueSkip(){return this.check(D.StatueGauntletSkip)}assumeWildWarp(){return this.check(V.WildWarp,!0)||this.check(T.RandomizeWildWarp)}assumeRageSkip(){return this.check(D.RageSkip)}nerfWildWarp(){return this.check(V.WildWarp,!1)&&this.check(T.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(T.RandomizeWildWarp,!0)}blackoutMode(){return this.check(K.Blackout)}hardcoreMode(){return this.check(K.Permadeath)}buffDyna(){return!this.check(V.Dyna)}maxScalingInTower(){return this.check(K.MaxScalingInTower)}expScalingFactor(){return this.check(K.ExperienceScalesSlower)?.25:this.check(U.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(t){return t==="early"||this.check(Qe.NoAutoEquip,!1)}controllerShortcuts(t){return t==="early"||this.check(Qe.NoControllerShortcuts,!1)}randomizeMusic(t){return this.check(Ge.RandomizeMusic,t==="early"?"!":!0)}shuffleTilePalettes(t){return this.check(Ge.RandomizeMapColors,t==="early"?"!":!0)}noMusic(t){return t==="late"&&this.check(Ge.NoMusic)}audibleWallCues(t){return t==="late"&&this.check(Qe.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(V.Hud,!1)}hasStatTracking(){return!0}buryFlightStartSphere(){return 7}validate(){if(this.shuffleAreas()&&this.preserveUniqueChecks())throw new Os("Wa and Eu are incompatible")}}});function Ao(n){return"size"in n}var Mo,fn,ln,Ro,ns,dn,cn,To,rs,Eo,Fo,Go,Ae,Po,os=G(()=>{Mo=4656613057391769e-25,fn=2147483563-1,ln=40014,Ro=40692,ns=53668,dn=52774,cn=12211,To=3791,rs=32,Eo=1+Math.floor(fn/rs),Fo=12e-8,Go=1-Fo,Ae=class{constructor(t=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(t)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(t){this.idum=Math.max(1,Math.floor(t)),this.idum2=this.idum,this.iy=0,this.iv=new Array(rs).fill(0);for(let e=rs+7;e>=0;e--){let s=Math.floor(this.idum/ns);this.idum=ln*(this.idum-s*ns)-s*cn,this.idum<0&&(this.idum+=2147483563),e<rs&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let t=Math.floor(this.idum/ns);this.idum=ln*(this.idum-t*ns)-t*cn,this.idum<0&&(this.idum+=2147483563),t=Math.floor(this.idum2/dn),this.idum2=Ro*(this.idum2-t*dn)-t*To,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/Eo);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=fn),Math.min(Mo*this.iy,Go)}nextInt(t){return Math.floor(this.next()*t)}nextNormal(t=0,e=1,s=-1/0,i=1/0){for(;;){let r=this.z1;if(r==null){let o=Math.sqrt(-2*Math.log(this.next())),a=Po*this.next();r=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(r=t+r*e,r>=s&&r<=i)return r}}shuffle(t){for(let e=t.length;e;){let s=this.nextInt(e--);[t[e],t[s]]=[t[s],t[e]]}return t}*ishuffle(t){let e=[];if(!Array.isArray(t))if(Ao(t)){let s=t[Symbol.iterator]();for(let i=0;i<t.size;i++){let r=i+this.nextInt(t.size-i);for(;e.length<=r;)e.push(s.next().value);yield e[r],e[r]=e[i]}return}else t=[...t];if(!Array.isArray(t))throw new Error("impossible");for(let s=0;s<t.length;s++){let i=s+this.nextInt(t.length-s);yield i in e?e[i]:t[i],e[i]=s in e?e[s]:t[s]}}*ishuffleMetropolis(t,e){let s=[...t];for(let i=s.length-1;i>=0;i--){for(let r=1;r<i;r<<=1){let o=r>>>1,a=(o?this.nextInt(o):0)+o+1,l=s[i][0]-s[i-a][0];if(l<0?2*this.next()>Math.exp(l/e):2*this.next()<Math.exp(-l/e)){let d=s[i];s[i]=s[i-a],s[i-a]=d}}yield s[i][1]}}pick(t){if(!t.length)throw new Error("empty array");return t[this.nextInt(t.length)]}pickWeighted(t){if(!t.length)throw new Error("empty array");let e=0;for(let[i]of t)e+=i;let s=this.next()*e;for(let[i,r]of t){if(s<i)return r;s-=i}throw new Error("bad weights")}pickAndRemove(...t){let e=0;for(let i of t)e+=i.length;if(!e)throw new Error("empty arrays");let s=this.nextInt(e);for(let i of t){if(s<i.length)return i.splice(s,1)[0];s-=i.length}throw new Error("impossible")}bitGenerator(){let t=0,e=0;return()=>{t||(t=32,e=this.nextInt(4294967296)),t--;let s=!(e&1);return e>>>=1,s}}};Po=2*Math.PI});function hn(n){return n>>4&15|n>>8&240}function et(n,t=1){return n-t*8}function Te(n,t=1){return n+t*8}function ue(n,t=1){return n-t*2048}function se(n,t=1){return n+t*2048}var Pe,tt=G(()=>{wt();le();Pe=class{constructor(t,e){this.height=t;this.width=e;this._coords=void 0;this.data=new Array((t<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let t=[];for(let e=0;e<this.height;e++)for(let s=0;s<this.width;s++)t.push(e<<12|s<<4);return this._coords=t}index(t){return((t&248)>>3)+this.row*(t>>>11)}index2(t,e){return(this.row<<1)*t+2*e}yx(t){let e=t%this.row;return[(t-e)/this.row/2,e/2]}coord(t){let e=t%this.row;return(t-e)/this.row<<11|e<<3}get(t){return this.data[this.index(t)]}set(t,e){this.data[this.index(t)]=e}get2(t,e){return this.data[this.index2(t,e)]}set2(t,e,s){this.data[this.index2(t,e)]=s}plus(t,e,s){return t+(this.row<<1)*e+2*s}x(t){return t%this.row/2}y(t){return Math.floor(t/this.row)/2}border(t,e){let s,i;return t&1?(i=e<<12|2048,s=t&2?this.width<<4:0):(i=t&2?this.height<<12:0,s=e<<4|8),i|s}randomBorder(t,e){let s,i;if(e!=null)e&1?(i=t.nextInt(this.height)<<12|2048,s=e&2?this.width<<4:0):(i=e&2?this.height<<12:0,s=t.nextInt(this.width)<<4|8);else{let r=this.width+this.height,o=t.nextInt(r<<1)-r,a=!1;o<0&&(o=~o,a=!0),o<this.width?(s=o<<4|8,i=a?this.height<<12:0):(i=o-this.width<<12|2048,s=a?this.width<<4:0)}return i|s}oppositeBorder(t){return t&8?t^this.height<<12:t^this.width<<4}furthestBorder(t){return(this.height<<12|this.width<<4)-t}edgeCoordination(t,e){let s=0;if((t&2056)!==2056)throw new Error(`Bad tile: ${j(t)}`);for(let i of[8,-8,2048,-2048]){let r=this.get(t+i);(e?r===e:r)&&s++}return s}isBorder(t){if(t&8){if(t&2048)return!1;let e=t>>>12;return!e||e===this.height}else if(t&2048){let e=t>>>4&15;return!e||e===this.width}return!1}partition(t){let e=new Ce;for(let s=0;s<this.data.length;s+=this.row)for(let i=0;i<this.row;i++){let r=s+i,o=this.coord(r);if(!(t?.get(o)??this.data[r]))continue;e.find(o);let l=o-2048;s&&(t?.get(l)??this.data[r-this.row])&&e.union([o,l]);let c=o-8;i&&(t?.get(c)??this.data[r-1])&&e.union([o,c])}return e.map()}show(){let t=[];for(let e=0;e<this.data.length;e+=this.row){let s="";for(let i=0;i<this.row;i++)s+=this.data[e+i]||" ";t.push(s)}return t.join(`
`)}static writeGrid2d(t,e,s){let i=t.index(e);for(let r=0;r<s.length;r++){let o=s[r];for(let a=0;a<o.length;a++){let l=o[a];t.data[i+r*t.row+a]=l!==" "?l:""}}}}});var E,as,ls,$e=G(()=>{tt();le();[]=[j],E={ok:!0,value:void 0},as=class{constructor(t,e){this.rom=t;this.random=e;this.shuffles=[]}add(...t){this.shuffles.push(...t)}shuffleAll(){for(let t of this.shuffles)t.shuffle(this.random);for(let t of this.shuffles)t.meta&&t.finish();for(let t of this.rom.locations)t.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((t,e)=>(t.badness||0)-(e.badness||0)).join(`
`)}},ls=class{constructor(t,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new Pe(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=t,this.orig=t.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let t=this.pickHeight(),e=this.pickWidth(),s=this.pickSize(),i=new Pe(t,e);i.data.fill(""),Object.assign(this,{h:t,w:e,size:s,grid:i,fixed:new Set,count:0,exitMap:[]})}shuffle(t){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:t});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let t=[];for(let[e,s,i]of this.exitMap)for(let[r,o,a]of t)if(e(r,o)){t.push([s,i,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,s,i]of t){let r=this.meta.rom.locations[i[0]>>>8].meta,o=i[0]&255,a=i[1];this.meta.attach(e,r,o,s,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(t,e){let s=this.posToGrid(t);for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=s+i*2048+r*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[i*3+r])return!1}for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=s+i*2048+r*8;this.grid.set(o,e[i*3+r])}return!0}posToGrid(t,e=0){let s=t>>>4,i=t&15;return(s<<12|i<<4)+e}insertPattern(t,{top:e=0,bottom:s=0,left:i=0,right:r=0}={}){let o=t.length-1>>>1,a=t[0].length-1>>>1,l=e+s,c=i+r;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+c)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,f=this.random.nextInt(this.w-a-1-l)+i,h=d+1<<12|f+1<<4;Pe.writeGrid2d(this.grid,h,t);for(let u=12288;u<=20480;u+=2048)for(let m=48;m<=64;m+=8)this.fixed.add(h+(u|m));return{ok:!0,value:void 0}}extract(t,e,{h:s=3,w:i=3,replace:r=void 0}={}){let o=t.index(e),a="",l=o+s*t.row,{row:c}=t;for(let d=o;d<l;d+=c)for(let f=d;f<d+i;f++){if(r){let h=r.get(t.coord(f));if(h!=null){a+=h||" ";continue}}a+=t.data[f]||" "}return a}canSet(t,e){return this.canSetAll(new Map([[t,e]]))}canSetAll(t){let e=new Set;for(let s of t.keys()){if(this.fixed.has(s))return!1;let i=s&-2057,r=i>>>12,o=i>>>4&15;o<this.w&&r<this.h&&e.add(i),!(s&8)&&r<this.h&&o&&e.add(i-16),!(s&2048)&&o<this.w&&r&&e.add(i-4096),!(s&2056)&&o&&r&&e.add(i-4112)}for(let s of e){let i=this.extract(this.grid,s,{replace:t});if(!this.orig.tileset.getMetascreensFromTileString(i).length)return!1}return!0}addAllFixed(){for(let t=0;t<this.grid.data.length;t++)this.grid.data[t]&&this.fixed.add(this.grid.coord(t))}}});var I,dt,ds,Js,kt,qe=G(()=>{tt();le();Jt();$e();wt();de();[]=[j],I=class extends ls{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let s={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let i of e.rom.locations[e.id].spawns)i.isMonster()&&i.monsterId===143&&s.features.statue++;for(let i of e.allPos()){let r=e.get(i);(!r.isEmpty()||r.data.exits?.length)&&s.size++;for(let o of r.data.exits??[]){let{type:a}=o;if(a==="edge:top"){i>>>4===0&&s.edges[0]++;continue}else if(a==="edge:left"){(i&15)===0&&s.edges[1]++;continue}else if(a==="edge:bottom"){i>>>4===e.height-1&&s.edges[2]++;continue}else if(a==="edge:right"){(i&15)===e.width-1&&s.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);s.stairs[o.dir>>>1]++;continue}}}r.hasFeature("arena")&&s.features.arena++,r.hasFeature("bridge")&&s.features.bridge++,r.hasFeature("overpass")&&s.features.over++,r.hasFeature("pit")&&s.features.pit++,r.hasFeature("ramp")&&s.features.ramp++,r.hasFeature("spikes")&&s.features.spike++,r.hasFeature("underpass")&&s.features.under++,r.hasFeature("wall")&&s.features.wall++,r.hasFeature("river")&&s.features.river++,r.hasFeature("wide")&&s.features.wide++}return s.size<2&&(e.width>1||e.height>1)&&(s.size=2),s}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let s=this.inferScreens();return s.ok?(e=this.refineMetascreens(s.value),!e.ok||(e=this.checkMetascreens(s.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(s.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=s.value,E)):s}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:E):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),E}fillCave(e){for(let s=.5;s<this.h;s++)for(let i=.5;i<this.w;i++)s>1&&this.grid.set2(s-.5,i,e),i>1&&this.grid.set2(s,i-.5,e),this.grid.set2(s,i,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return E;for(let e=0;e<4;e++){let s=this.params.edges[e]||0;if(!s)continue;let i=ne(e&1?this.h:this.w,r=>this.grid.border(e,r));for(let r of this.random.ishuffle(i))if(!this.grid.get(r)&&(e&1?e===1?this.addLeftEdge(r)&&s--:this.addRightEdge(r)&&s--:e===0?this.addUpEdge(r)&&s--:this.addDownEdge(r)&&s--,!s))break;if(s)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${s} ${e}`}}return E}addUpEdge(e){let s=e+2048,i=s-8,o=i-8-8,a=s+8,c=a+8+8;if(this.grid.isBorder(i)){if(this.grid.get(i))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(c)&&this.grid.get(c))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(i,""),this.grid.set(a,""),!0}addDownEdge(e){let s=e-2048,i=s-8,r=s+8;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(i,""),this.grid.set(r,""),!0)}addLeftEdge(e){let s=e+8,i=s-2048,r=s+2048;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let s=e-8,i=s-2048,r=s+2048;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?E:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?E:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let s=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056;if(!this.isEligibleArena(r))continue;let o=this.extract(this.grid,i),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(r),s.set(r,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let s=this.grid,i=e-8,r=i-8,o=e+8,a=o+8;return!(s.get(e)!=="c"&&s.get(e)!=="w"||s.get(i)||s.get(o)||!s.isBorder(i)&&s.get(r)||!s.isBorder(o)&&s.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let s=0;for(;e;){let i=this.random.nextInt(this.h-2)+1,r=this.random.nextInt(this.w-2)+1,o=i<<12|r<<4|2056;if(this.grid.get(o)!=="c"){if(++s>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,s,i){if(!e)return!0;for(let r of this.random.ishuffle(this.grid.screens())){let o=r|2056;if(this.grid.get(o)!=="c")continue;if(i){let d=o-i,f=o+i;if(this.grid.get(d)||this.grid.get(f))continue}let a=this.extract(this.grid,r),l=a.substring(0,4)+s+a.substring(5);if(!!this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,s),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let s=0;for(;e>0;){if(++s>20)return!1;let i=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;i<e-1&&i>this.minSpikes;)this.random.next()<.2&&i--;let r=i>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);i>e-this.minSpikes&&(i>=this.h-2?i=this.h-2:i=e);let a=this.random.nextInt(this.h-i-2)+1<<12|r<<4|2056,l=a+(i-1<<12);for(let f=a-4096;i&&f<=l+4096;f+=2048)this.grid.get(f)!=="c"&&(i=0);if(!i)continue;let c=[a-8,a+8,l-8,l+8],d=this.tryClear(c);if(!!d.length){for(let f of d)this.grid.set(f,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let f=a;f<=l;f+=2048)this.fixed.add(f),this.grid.set(f,"s");e-=i,s=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let s=new Map;for(let c of e){if(this.fixed.has(c))return[];s.set(c,"")}let i=this.grid.partition(s),[r]=i.values();if(r.size===i.size)return[...e];let o=new Set,a=new Set(i.values());for(let c of this.fixed)o.add(i.get(c));if(o.size>this.maxPartitions)return[];let l=[...e];for(let c of a)o.has(c)||l.push(...c);return l}refine(){let e=new Set;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]&&e.add(this.grid.coord(i));let s=0;for(;this.count>this.size;){if(s++>50)throw new Error("refine failed: attempts");let i=0;for(let r of this.random.ishuffle([...e])){if(this.grid.isBorder(r)||!this.canRemove(this.grid.get(r))||this.fixed.has(r))continue;if(i>3)break;let o=this.grid.partition(this.removalMap(r)),[a]=o.values();if(a.size===o.size&&o.size>1)i++,e.delete(r),(r&2056)===2056&&this.count--,this.grid.set(r,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let c=[...l].filter(d=>(d&2056)==2056).length;if(c<this.size)continue;i++,e=l,this.count=c,this.grid.set(r,"");for(let[d,f]of o)f!==l&&this.grid.set(d,"")}}if(!i)return this.looseRefine?E:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return E}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let s=this.grid.partition(new Map),i=s.size,r=new Set(s.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===r)&&a.size===i-1&&(i--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++){let i=e<<12|2056|s<<4;if(this.grid.get(i))continue;let r=i-2048,o=i+2048,a=i-8,l=i+8;(this.grid.get(r)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(r,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let s=e<<12|2048;for(let i=0;i<this.w-1;i++){let r=s|i<<4|8;this.isTightLoop(r)&&this.breakTightLoop(r)}}}isTightLoop(e){for(let s=0;s<6144;s+=2048)for(let i=0;i<24;i+=8){let r=s|i;if(r!==2056&&this.grid.get(e+r)!=="c")return!1}return!0}breakTightLoop(e){let s=this.random.nextInt(65536),i=s&1?s&4096|8:s&16|2048;this.grid.set(e+i,"")}addStairs(e=0,s=0){let i=[e,s];if(!i[0]&&!i[1])return E;for(let r of this.random.ishuffle(this.grid.screens()))if(!!this.tryAddStair(r,i)&&!i[0]&&!i[1])return E;return{ok:!1,fail:"stairs"}}addEarlyStair(e,s){let i=[],r=e-8,o=e+8,a=e-2048,l=e+2048,c=[e-8,e+8];if(s==="<"){if(c.push(l),i.push([a,""]),this.grid.get(r)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return i.push([l,""],[e,"<"]),i}else s===">"&&(c.push(a),i.push([l,""]));if(c=c.filter(f=>this.grid.get(f)==="c"),!c.length)return[];let d=this.random.nextInt(c.length);for(let f=0;f<c.length;f++)f!==d&&i.push([c[f],""]);return i.push([e,s]),i}tryAddStair(e,s){if(this.fixed.has(e|2056))return!1;let i=this.extract(this.grid,e),r=s[0]&&s[1],o=s[0]+s[1],a=this.random.nextInt(o)<s[0],l=[a?0:1];r&&l.push(a?1:0);for(let c of l){let d="<>"[c],f=i.substring(0,4)+d+i.substring(5);if(this.orig.tileset.getMetascreensFromTileString(f).length)return this.grid.set(e|2056,d),s[c]--,!0}return!1}tryConnect(e,s,i,r=1){for(;r-- >0;){let o=new Map,a=e;if((e&s&2056)!==2056)throw new Error(`bad start ${j(e)} or end ${j(s)}`);for(o.set(a,i);a!==s;){let l=[];for(let u of[8,-8,2048,-2048]){let m=a+u,p=a+2*u;this.fixed.has(p)||(o.get(p)??this.grid.get(p))||this.grid.isBorder(m)||l.push(u)}if(!l.length)break;let c=(s>>12)-(a>>12),d=(s&240)-(a&240),f=new Set(l);c<0&&f.delete(2048),c>0&&f.delete(-2048),d<0&&f.delete(8),d>0&&f.delete(-8),l.push(...f,...f);let h=this.random.pick(l);o.set(a+h,i),o.set(a=a+2*h,i)}if(a===s){for(let[l,c]of o)this.grid.set(l,c),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,s=1){let i=new Ce;for(let l=0;l<this.grid.data.length;l++){let c=this.grid.coord(l);this.grid.get(c)||this.grid.isBorder(c)||(this.grid.get(Te(c))||i.union([c,Te(c)]),this.grid.get(se(c))||i.union([c,se(c)]))}let r=new W(()=>[]);for(let l of this.grid.screens()){let c=l+2056;if(!!this.grid.get(c))for(let d of[8,-8,2048,-2048]){let f=c+d;if(this.grid.isBorder(f)||this.grid.get(f))continue;let h=c+2*d;if(this.grid.get(h))continue;let u=new Map([[f,e]]),m=this.extract(this.grid,l,{replace:u});this.orig.tileset.getMetascreensFromTileString(m).length&&r.get(i.find(h)).push([f,h])}}let o=new Map;for(let l of r.values())if(!(l.length<2))for(let[c]of l)o.set(c,l);let a=[...o.values()];if(!a.length)return!1;for(;s-- >0;){let l=this.random.pick(a),[[c,d],[f,h]]=this.random.ishuffle(l);if(this.grid.set(c,e),this.grid.set(f,e),this.tryConnect(d,h,e,5))return!0;this.grid.set(c,""),this.grid.set(f,"")}return!1}tryExtrude(e,s,i=1){for(;i--;)for(let r of this.random.ishuffle(this.grid.screens())){let o=r+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,r);for(let l of this.random.ishuffle([0,1,2,3])){let c=o+kt[l],d=o+2*kt[l];if(this.grid.get(c)||this.grid.isBorder(c)||this.grid.get(d))continue;let f=Js[l],h=a.substring(0,f)+e+a.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(h).length){this.grid.set(c,e),this.grid.set(d,e);let u=this.tryContinueExtrude(e,s,d);if(u)return u;this.grid.set(d,""),this.grid.set(c,"")}}}return 0}tryContinueExtrude(e,s,i){let r=this.extract(this.grid,i-2056),o=this.orig.tileset.getMetascreensFromTileString(r).length>0;if(s===1)return o?1:0;if(o&&!this.random.nextInt(s))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=i+kt[a],c=i+2*kt[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(c))continue;let d=Js[a],f=r.substring(0,d)+e+r.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(l,e),this.grid.set(c,e);let h=this.tryContinueExtrude(e,s-1,c);if(h)return h+1;this.grid.set(c,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let s=this.orig.tileset,{attempts:i=1,char:r="c",start:o,loop:a=!1}=e;for(let l=0;l<i;l++){let c=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of c){let f=d+2056;if(!this.grid.get(f))continue;let h=this.extract(this.grid,d);for(let u of this.random.ishuffle([0,1,2,3])){let m=f+kt[u],p=f+2*kt[u];if(this.fixed.has(m)||this.fixed.has(p))continue;let x=this.grid.get(m),w=this.grid.get(p);if(x&&(w||x!==r)||this.grid.isBorder(m))continue;if(!a){let b=this.extract(this.grid,p-2056,{replace:new Map([[m,""]])});if(/\S/.test(b))continue}let g=Js[u],k=h.substring(0,g)+r+h.substring(g+1);if(s.getMetascreensFromTileString(k).length){this.count++,this.grid.set(m,r),this.grid.set(p,r);let b=this.extract(this.grid,p-2056);if(s.getMetascreensFromTileString(b).length)return 1;this.grid.set(p,w),this.grid.set(m,x),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:E}preinferSpikes(){return E}inferScreens(){let e=[];for(let r of this.grid.screens()){let o=this.extract(this.grid,r),a=this.orig.tileset.getMetascreensFromTileString(o).filter(c=>!c.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${j(r)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let s=!0,i=new ke(this.params.id,this.orig.tileset,this.h,this.w);for(let r=0;r<this.h;r++)for(let o=0;o<this.w;o++){let a=e[r*this.w+o];if(i.set(r<<4|o,a),a.isEmpty()||(s=!1),r){let l=i.get(r-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${r}${o}: ${l.name} ${a.name}`}}if(o){let l=i.get(r<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${r}${o}: ${l.name} ${a.name}`}}}return s?{ok:!1,fail:"all screens empty"}:{ok:!0,value:i}}refineMetascreens(e){let s=this.params.features?.bridge||0,i=this.params.features?.wall||0;for(let r of this.random.ishuffle(e.allPos())){let o=(r<<8|r<<4)&61680,a=this.extract(this.grid,o),l=e.get(r);if(!(this.bridges<=s&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<i&&!l.hasFeature("wall")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==s?{ok:!1,fail:`refineMeta bridges want ${s} got ${this.bridges}
${e.show()}`}:this.walls!==i?{ok:!1,fail:`refineMeta walls want ${i} got ${this.walls}
${e.show()}`}:E}tryMeta(e,s,i){for(let r of i)if(!!this.checkMeta(e,new Map([[s,r]])))return e.set(s,r),!0;return!1}checkMeta(e,s){let i=s?{with:s}:{},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let s=!1,i=!1;for(let r of e.allPos()){let o=e.get(r);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(s=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(i=!0),s&&i)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return E;let s=0;for(let i of e.allPos()){let r=e.get(i);s+=r.data.statues?.length||0}return s<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:E}},dt=class extends I{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,s=super.addEdges();if(!s.ok)return s;let i=this.params.features?.arena;if(!i)return E;let r=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&r.push(a)}if(r.length<i)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(r)){if(!i)break;let a=o-8,l=a-8,c=l-8,d=l-2048,f=l+2048,h=o+8,u=h+8,m=u+8,p=u-2048,x=u+2048;!e.isBorder(a)&&(e.isBorder(c)&&e.get(c)||e.isBorder(d)&&e.get(d)||e.isBorder(f)&&e.get(f))||!e.isBorder(h)&&(e.isBorder(m)&&e.get(m)||e.isBorder(p)&&e.get(p)||e.isBorder(x)&&e.get(x))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(h,""),e.set(u,""),this.grid.set(o,"a"),i--)}return E}addArenas(){return!0}},ds=class extends I{refineMetascreens(t){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++)this.grid.get(e<<12|s<<4|2056)==="a"&&t.set(e<<4|s,t.rom.metascreens.cryptArena_statues);return super.refineMetascreens(t)}isEligibleArena(t){return!this.grid.get(t-2048)&&super.isEligibleArena(t)}},Js=[1,3,7,5],kt=[-2048,-8,2048,8]});function cs(n,t,e=!1){let s=new ei(n,t,e),i=new Qs(t,s,e);return[s,i]}var Qs,ei,un=G(()=>{qe();tt();de();$e();Qs=class extends I{constructor(e,s,i){super(e);this.location=e;this.under=s;this.reverse=i;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,s]of oe.zip(this.under.upStairs,this.downStairs))this.meta.attach(s,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let s=16,i=0,r=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let c=l>>>4,d=l&15;s=Math.min(d,s),i=Math.max(d,i),r=Math.min(c-a,r),o=Math.max(c+a,o)}e:for(let l=0;l<10;l++){let c=[],d=this.random.nextInt(this.w-(i-s))+s,h=this.random.nextInt(this.h-(o-r))+r-r<<4+(d-s);for(let u of this.under.underBridges){let m=u+h,p=m>>>4,x=m&15,w=p<<12|x<<4|2056;if(this.grid.get(w)!=="c")continue e;c.push([w,"b"]),c.push([w-8,""]),c.push([w+8,""])}for(let u of this.under.upStairsEffective){let m=u+h,p=m>>>4,x=m&15,w=p<<12|x<<4|2056;if(this.grid.get(w)!=="c")continue e;c.push([w,this.reverse?"<":">"]),c.push([w+(this.reverse?-2048:2048),""]);let g=this.addEarlyStair(w,this.reverse?"<":">");if(!g.length)continue e;c.push(...g)}for(let[u,m]of c)m&&this.fixed.add(u),(m==="<"||m===">")&&this.downStairs.push(hn(u)),this.grid.set(u,m);return E}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,s=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,s):super.addStairs(e,s-this.under.upStairs.length)}addOverpasses(){return!0}},ei=class extends I{constructor(e,s,i){super(e);this.loc=e;this.overpass=s;this.reverse=i;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let s=this.reverse?"stair:down":"stair:up";for(let r of this.meta.allPos()){let o=this.meta.get(r);if(o.hasFeature("underpass")&&this.underBridges.push(r),o.hasFeature(s)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(r+a),this.upStairs.push(r)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let i=0;for(let[,r,[o]]of this.orig.exits())r===s&&o>>>8===this.overpass.id&&i++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,i),E}}});var ct,fs,mn=G(()=>{qe();ct=class extends I{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let i=0;i<this.h;i++)for(let r=0;r<this.w;r++){let o=i<<12|r<<4|2056;this.grid.get(o)&&e.push(o)}let s=e.filter(i=>this.tryClear([i]).length===1);if(!s.length)return{ok:!1,fail:"all critical?"};for(let i=0;i<s.length;i++)for(let r=0;r<i;r++)if(this.tryClear([s[i],s[r]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},fs=class extends ct{removeTightLoops(){}}});var He,hs,Bo,Lo,us=G(()=>{tt();de();wt();He=class{constructor(t,e,s){this.h=t;this.w=e;this.valid=s;this.fixed=new Set;this.size=0;this.data=new Uint8Array(t*e)}fill(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let s=t*this.w+e;t>0&&(this.data[s]|=1),e>0&&(this.data[s]|=2),t<this.h-1&&(this.data[s]|=4),e<this.w-1&&(this.data[s]|=8)}}isBorder(t,e){let s=t%this.w,i=(t-s)/this.w;return this.isBorder2(i,s,e)}isBorder2(t,e,s){if(s===0)return!t;if(s===1)return!e;if(s===2)return t>=this.h-1;if(s===3)return e>=this.w-1;throw new Error("bad direction")}delete2(t,e,s=t*this.w+e){if(this.fixed.has(s))return!1;let i=new Map;i.set(s,0);for(let r=0;r<4;r++){if(this.isBorder2(t,e,r))continue;let o=s+this.delta(r),a=this.data[o],l=a&~(1<<(r^2));if(a!==l){if(this.fixed.has(o))return!1;i.set(o,l)}}return this.try(i)}delete(t){let e=t%this.w,s=(t-e)/this.w;return this.delete2(s,e,t)}deleteEdge2(t,e,s,i=t*this.w+e){if(this.fixed.has(i))return!1;if(this.isBorder2(t,e,s))return this.data[i]&=~(1<<s),!0;let r=new Map,o=i+this.delta(s);return this.fixed.has(o)?!1:(r.set(i,this.data[i]&~(1<<s)),r.set(o,this.data[o]&~(1<<(s^2))),this.try(r))}deleteEdge(t,e){let s=t%this.w,i=(t-s)/this.w;return this.deleteEdge2(i,s,e,t)}refine(t,e){let s=0,i=new Set;for(let r=0;r<this.data.length;r++)this.data[r]&&s++,this.fixed.has(r)||i.add(r);for(;s>e;){let r=!1;for(let o of t.ishuffle(i)){if(s<=e)break;if(!this.data[o]){s--;continue}this.delete(o)&&(r=!0,s--)}if(!r)return!1}return!0}validate(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let s=t*this.w+e,i=this.data[s];if(t&&!(this.data[s-this.w]&4)!=!(i&1))throw new Error(`invalid above ${t}${e}`);if(e&&!(this.data[s-1]&8)!=!(i&2))throw new Error(`invalid left of ${t}${e}`)}}addEdge(t,e,s){let i=t*this.w+e;this.data[i]|=1<<s,this.isBorder2(t,e,s)||(this.data[i+this.delta(s)]|=1<<(s^2))}consolidate(t,e){let s=new zs;for(let r=0;r<this.data.length;r++)!this.fixed.has(r)&&this.data[r]&&s.add(this.data[r]);let i=1e3;for(;s.unique()>e&&--i;){let r=[...s].sort((c,d)=>d[1]-c[1]),o=r[e][1],a=new Set(r.filter(c=>c[1]<=o).map(c=>c[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[c,d]of t.pick(l))this.data[c]&&s.delete(this.data[c]),d&&s.add(d),this.data[c]=d}return i?[...s].map(r=>r[0]):[]}consolidateFixed(t,e){let s=new zs;for(let r=0;r<this.data.length;r++){let o=this.data[r];!this.fixed.has(r)&&e.has(o)&&s.add(o)}let i=1e3;for(;s.unique()&&--i;){let r=this.findEligibleConsolidates(e);if(!r.length)return!1;for(let[o,a]of t.pick(r)){let l=this.data[o];e.has(l)&&s.delete(l),e.has(a)&&s.add(a),this.data[o]=a}}return!!i}findEligibleConsolidates(t){let e=[],s=[];for(let i=0;i<this.data.length;i++){if(this.fixed.has(i))continue;let r=this.data[i];if(!!t.has(r))for(let o=0;o<4;o++){if(this.isBorder(i,o))continue;let a=this.delta(o);if(this.fixed.has(i+a))continue;let l=1<<o;if(t.has(r^l))continue;let c=1<<(o^2),d=this.data[i+a],f=new Map([[i,r^l],[i+a,d^c]]);if(!!this.check(f)&&(e.push(f),!t.has(d^c)&&t.has(d))){s.push(f);break}}}return s.length?s:e}try(t){if(!this.check(t))return!1;for(let[e,s]of t)this.data[e]=s;return!0}check(t){let e=new Ce;for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++){let r=s*this.w+i,o=t?.get(r)??this.data[r];o&&e.union([r]),s>0&&o&1&&e.union([r,r-this.w]),i>0&&o&2&&e.union([r,r-1]),s<this.h-1&&o&4&&e.union([r,r+this.w]),i<this.w-1&&o&8&&e.union([r,r+1])}return e.roots().length===1}addPath(t,e){let s,i;if(!this.size)s=t.nextInt(this.h),i=t.nextInt(this.w);else{let c=[];for(let f=0;f<this.data.length;f++)this.data[f]&&this.data[f]!==15&&c.push(f);if(!c.length)return!1;let d=t.pick(c);i=d%this.w,s=(d-i)/this.w}let r=new Map,o=s*this.w+i,a=0,l=!0;for(;;){let c=!1,d=r.get(o)??this.data[o],f=!1;for(let h of t.ishuffle([0,1,2,3])){let u=1<<h;if(d&u)continue;let m=d|u;if(this.valid&&!this.valid.has(m))continue;let p=s+Bo[h],x=i+Lo[h];if(p<0||x<0||p>=this.h||x>=this.w)continue;let w=p*this.w+x,g=r.get(w)??this.data[w],k=g|1<<(h^2);if(g){if(g===k||this.valid&&!this.valid.has(k))continue;c=!0}l=!this.valid||this.valid.has(k),r.set(o,m),r.set(w,k),i=x,s=p,o=w,f=!0;break}if(!f||c||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&t.nextInt(15)<a++)break}if(!r.size||!l)return!1;for(let[c,d]of r)this.data[c]=d;return!0}toGrid(t){let e=new Pe(this.h,this.w);for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++){let r=s*this.w+i,o=this.data[r];if(!o)continue;let a=s<<12|i<<4|2056;e.set(a,t);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let c=l&1?8:2048;e.set(l&2?a+c:a-c,t)}}return e}delta(t){return(t&2?1:-1)*(t&1?1:this.w)}show(){let t=[];for(let e=0;e<this.h;e++){let s="";for(let i=0;i<this.w;i++)s+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+i]];t.push(s)}return t.join(`
`)}},hs=class{constructor(t,e,s){this.grid=t;this._i=e*t.w+s}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(t){let e=this.grid.delta(t),s=this._i+e,i=1<<t,r=1<<(t^2);this.grid.data[this._i]|=i,this.grid.data[this._i=s]|=r}directedPath(t,e,s){for(;;){let i=this.y,r=this.x,o=[];if(e<i&&o.push(0),s<r&&o.push(1),e>i&&o.push(2),s>r&&o.push(3),!o.length)return;this.go(t.pick(o))}}},Bo=[-1,0,1,0],Lo=[0,-1,0,1]});var qt,ms,ti=G(()=>{us();qe();$e();le();qt=class extends I{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(s=>this.grid.get(s+2056)).length,E)}initialFillEarly(){let e=new He(this.h,this.w,this.getValidEarlyScreens()),s=0,i=this.targetEarly();for(;s++<20&&e.size<i;)e.addPath(this.random,i)&&(s=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),E}initialFillLate(){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++){let i=e<<12|s<<4|2056;this.grid.get(i)||this.grid.set(i,"c")}for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++)for(let i of[8,2048]){let r=e<<12|s<<4|2056,o=r+i,a=r+2*i;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(r)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let s of[8,2048]){let i=e|2056,r=i+s,o=i+2*s;if(this.grid.isBorder(r)||this.grid.get(r))continue;this.grid.set(r,"c");let a=this.extract(this.grid,i-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(r,"")}return E}pruneDisconnected(){let e=new Set(this.grid.partition().values()),s=0;for(let i of e)if([...i].some(o=>this.grid.get(o)===this.early))s+=[...i].filter(o=>(o&2056)===2056).length;else for(let o of i){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${j(o)} disconnected`};this.grid.set(o,"")}return s<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):E}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let s of this.orig.tileset){let i=s.edgeIndex(this.early);i!=null&&e.add(i)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},ms=class extends qt{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new He(this.h,this.w);e.fill();let s=ne(e.data.length).slice(e.w),i=this.random.pick(s);if(!e.deleteEdge(i,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,3))return{ok:!1,fail:"initial stair"};e.fixed.add(i);let r=new Set(s);r.delete(i);let o=[];for(let d of this.random.ishuffle(r)){let f=function(x){return e.delete(x)?(e.fixed.add(x),!0):!1},h=this.params.features?.arena??0;if(o.length>=h)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let u=!e.isBorder(d,1),m=!e.isBorder(d,3);if(u&&e.fixed.has(d-1)||m&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!f(d-e.w))return{ok:!1,fail:"initial arena"};if(u&&!f(d-1))return{ok:!1,fail:"initial arena"};if(m&&!f(d+1))return{ok:!1,fail:"initial arena"};let p=d+e.w;if((e.data[p]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(p,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(p,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(p+e.w,2),e.fixed.add(p),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,f)=>{let h=d%e.w,m=(d-h)/e.w<<12|h<<4|2056;this.grid.set(m,f);for(let p of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(m+p)};l(i,">");for(let d of o)l(d,"a");let c=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&c++;return this.size=c,E}addStairs(e,s){return super.addStairs(e,s?s-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let s=e<<12|2056;for(let i=0;i<this.w;i++){let r=s|i<<4;this.grid.get(r)==="a"&&this.grid.set(r-2048,"c")}}return E}preinfer(){let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="w"&&e.set(this.grid.coord(r),"");let s=this.grid.partition(e),i=new Set;for(let[r,o]of s)this.grid.get(r)==="<"&&i.add(o);return i.size<2?{ok:!1,fail:"stairs bunched"}:E}refineMetascreens(e){for(let s of e.allPos())e.get(s).hasFeature("arena")&&e.set(s,e.rom.metascreens.fortressArena_through);return E}refineEdges(){return!0}}});var Ue,ps,xs,si,Do,gs,bs,pn=G(()=>{qe();tt();us();$e();ti();le();de();Ue=class extends qt{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return E;let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="r"&&e.set(this.grid.coord(r),"");let s=this.grid.partition(e),i=[];for(let r=0;r<this.grid.data.length;r++)(this.grid.data[r]==="<"||this.grid.data[r]===">"||this.grid.data[r]&&this.grid.isBorder(this.grid.coord(r)))&&i.push(s.get(this.grid.coord(r)));return new Set(i).size<i.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return E}addArenas(e){if(!e)return!0;let s=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056,o=r-8,a=o-8,l=r+8,c=l+8,d=r-2048,f=r+2048;if(s.get(r)!=="c"||s.get(d)!=="c"||s.get(f)!=="c")continue;let h=s.isBorder(o)?"":this.extract(s,a-2056),u=s.isBorder(l)?"":this.extract(s,c-2056);if(!/[^ c]/.test(h+u)&&(s.isBorder(o)||(s.set(o,""),s.set(a,""),s.set(a-8,""),s.set(a-2048,""),s.set(a+2048,"")),s.isBorder(l)||(s.set(l,""),s.set(c,""),s.set(c+8,""),s.set(c-2048,""),s.set(c+2048,"")),this.fixed.add(r),this.fixed.add(d),this.fixed.add(f),s.set(r,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},ps=class extends Ue{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new He(this.h,this.w,this.getValidEarlyScreens()),s=2+this.random.nextInt(this.w-4),i=2+this.random.nextInt(this.w-4),r=new hs(e,this.h-1,i);return r.go(0),r.directedPath(this.random,1,s),r.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),E}addEdges(){let e=-1,s=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(s|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let i=s|this.random.nextInt(e)<<4,r=s|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.grid.set(r,">"),this.grid.set(r-8,""),this.grid.set(r+8,""),this.fixed.add(i),this.fixed.add(r),E}addStairs(){return E}checkMeta(e,s){let i=s?{flight:!0,with:s}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}},xs=class extends I{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new W(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let f=0;for(let h=0;h<4;h++)d.data.edges[h]==="s"&&(f|=1<<h);e.get(f).push(...d.gridTiles())}let s=1+this.random.nextInt(this.w-2),i=1+this.random.nextInt(this.h-2),r=i<<4|s,o=this.posToGrid(r,2056),a=i<this.h/2?2:0;this.insertTile(r,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){r+=Do[a],o=o+si[a];let f=a^2,h=[];for(let[m,p]of e){if(!(m&1<<f))continue;let x=m&~(1<<f);if(!(d?!x:x))for(let w of p)h.push(m)}let u;for(let m of this.random.ishuffle(h))if(!this.grid.isBorder(o+si[m])&&this.insertTile(r,this.random.pick(e.get(m)))){u=31-Math.clz32(m&~(1<<f));break}if(u==null)return{ok:!1,fail:"spikes"};a=u}let l=[];for(let d=3;d<this.h-3;d++)for(let f=1;f<this.w-1;f++)l.push(d<<12|f<<4|2056);let c=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let f of si){if(this.grid.get(d+f)!=="c")continue;this.grid.set(d,"r");let h=2056&~Math.abs(f);this.grid.set(d+h,"r"),this.grid.set(d-h,"r");let u=this.random.pick([-h,h]);this.grid.set(d+2*u,"r"),this.grid.set(d+3*u,"r"),this.grid.set(d+2*u-f,"c"),c=!0;break}if(c)break}if(!c)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return E}checkMeta(e,s){let i=s?{flight:!0,with:s}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}refine(){return E}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let s=super.refineMetascreens(e);if(!s.ok)return s;function i(a){return[...new Set(a.values())].filter(c=>{for(let d of c)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:E}},si=[-2048,-8,2048,8],Do=[-16,-1,16,1],gs=class extends Ue{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],s=0;for(let l of this.random.ishuffle(ne(this.w-2,c=>c+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let c=this.h-1<<12|l<<4|2056;if(this.grid.set(c,"c"),this.grid.set(ue(c),"c"),this.grid.set(se(c),"n"),this.fixed.add(c),this.fixed.add(ue(c)),this.fixed.add(se(c)),e.push(l),s++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let i=this.w,r=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*r+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;i<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};i+=l,s+=l}let a=this.params.size;for(;s<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};s+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let s=super.refineMetascreens(e);if(!s.ok)return s;function i(l){let c=0;for(let d of new Set(l.values()))for(let f of d)if(e.exitType(f)==="edge:bottom"){c+=d.size;break}return c}let r=i(e.traverse({noFlagged:!0})),o=i(e.traverse());if(r===o)return{ok:!1,fail:"bridge didn't matter"};let a=i(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:E}},bs=class extends Ue{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let r=0;r<this.grid.data.length;r++)if(this.grid.data[r]==="r"){e=this.grid.coord(r)-2056;break}if(e==null)throw new Error("no corner");let s=[];for(let r=0;r<this.pattern.length;r++)for(let o=1;o<this.pattern[r].length-1;o++)!((o^r)&1)||this.pattern[r][o]===" "&&s.push(e+(r<<11|o<<3));let i=this.random.shuffle([..."ccrrrrrrrr"]);for(let r of this.random.ishuffle(s)){let o=i[i.length-1];if(!(o==="c"&&[...this.extract(this.grid,r-2056)].filter(a=>a==="r").length<4)&&(this.canSet(r,o)&&this.grid.set(r,i.pop()),!i.length))break}for(let r=0;r<6;r++)this.tryAdd({char:"c"});return E}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let r=this.addStairs(...e);if(!r.ok)return r}let s=0;for(let r of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,r).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(r+8)&&(this.grid.set(r+2056,"<"),e[0]--),this.fixed.add(r+2056),++s>=2))break;let i=this.grid.partition();return new Set(i.values()).size>1?{ok:!1,fail:"orphans"}:E}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:E}checkMeta(e,s){let i=e.traverse(s?{with:s}:{}),r=[];for(let o of new Set(i.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;r.push(a)}return r.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let s=super.refineMetascreens(e);if(!s.ok)return s;function i(a){let l=0;for(let c of new Set(a.values()))for(let d of c)if(e.exitType(d)){l+=c.size;break}return l}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:E}}});function xn(n){let{swamp:t}=n.metatilesets,e=n.metascreens,s=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[i,r,o]of s)t.getTile(i).copyFrom(r).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var ws,gn=G(()=>{us();Jt();qe();$e();le();es();ws=class extends I{build(){let{h:t,w:e}=this,s=this.orig.rom,i=new He(t,e);i.fill();let r=t*e<28?0:this.random.nextInt(t-1),o=this.random.nextInt(e),a=new Set;function l(y,A){i.delete2(y,A),a.add(y*i.w+A)}function c(y){return!y.startsWith("edge")}a.add(r*i.w+o),o&&l(r,o-1),o<i.w-1&&l(r,o+1),r&&(l(r-1,o),o&&l(r-1,o-1),o<i.w-1&&l(r-1,o+1));for(let y of a)i.fixed.add(y);let d=new Set;for(let y=0;y<4;y++){let A=y&1?t:e,R=this.random.shuffle(ne(A)),L=y&2?A:0,X=this.params.edges?.[y]??0;for(;X&&R.length;){let te=y&1?R.pop():L,re=y&1?L:R.pop(),N=te*i.w+re;!i.data[N]||i.fixed.has(N)||(i.addEdge(te,re,y),d.add(te<<4|re),X--)}if(X)return{ok:!1,fail:`could not add all edges: ${y} ${X}
${i.toGrid("c").show()}
${i.data}`}}let f=0,h=i.h*i.w*(this.random.next()*.15+.4);for(let y of this.random.ishuffle(ne(i.data.length<<2))){let A=y>>>2,R=y&3;if(!i.isBorder(A,R)&&i.deleteEdge(A,R)&&++f>=h)break}let u=new Set,m=new Set,p=[],x=[],w;for(let y of this.orig.tileset){if(y.hasFeature("arena")){w=y;continue}else if(y.hasFeature("empty")){p[0]=y;continue}let A=y.edgeIndex("s");if(A==null)throw new Error("bad edges");let R=y.data.exits?.some(L=>c(L.type));(R?x:p)[A]=y,(y.sid<0?m:u).add(y.sid)}if(!w)throw new Error("never found arena");let g=i.consolidate(this.random,u.size),k=new Set(g.map(y=>p[y].sid));if(!k.size)return{ok:!1,fail:"consolidate failed"};let b=[...m].filter(y=>k.has(y)),v=[...u].filter(y=>!k.has(y));if(b.length>v.length)throw new Error("out of space");if(b.length){let y=-1;for(;s.metascreens.getById(y).length;)y--;let A=y;for(let R=0;R<b.length;R++)s.metascreens.renumber(v[R],y),s.metascreens.renumber(b[R],v[R]),y=b[R];s.metascreens.renumber(A,b[b.length-1])}let C=new ke(this.orig.id,this.orig.tileset,t,e);for(let y=0;y<i.h;y++)for(let A=0;A<i.w;A++){let R=y===r&&A===o;C.set(y<<4|A,R?w:p[i.data[y*i.w+A]])}let F=[...this.orig.exits()].filter(y=>c(y[1])).length;for(let y of this.random.ishuffle(C.allPos())){if(!F)break;if(d.has(y))continue;let A=y&15,R=y>>>4,L=x[i.data[R*i.w+A]];!L||(C.set(y,L),F--)}return F?{ok:!1,fail:"could not place all doors"}:E}}});function bn(n,t){let{metatilesets:{cave:e,fortress:s,iceCave:i,labyrinth:r,pyramid:o}}=n;n.metascreens.registerFix(14,1);{for(let l of[r,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[s,r,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[i,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);r.getTile(23).copyFrom(198).setAlternative(197),r.getTile(24).copyFrom(196).setAlternative(197)}let a=new W(()=>[]);for(let l of n.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,c]of a){let d=n.screens[l],f=c.map(m=>m.data.tilesets.labyrinth?.removeWall),[h,...u]=new Set(f.filter(m=>m!=null));if(h!=null){if(d.set2d(h,[[197,197],[208,197]]),u.length)throw new Error("bad remove");for(let m=0;m<f.length;m++)f[m]==null&&(c[m].data.tilesets.labyrinth.addWall=[h])}if(!(c.length<2)){if(c.length>2){let m=t.pick(c.filter(p=>p.data.tilesets.labyrinth?.addWall));c.splice(c.indexOf(m),1),m.remove()}for(let m of c){let p=m.data.tilesets.labyrinth?.addWall;if(p!=null){m.data.mod="block";for(let x of p)d.set2d(x,[[23,23],[24,24]])}else m.flag="always"}}}}var ys,wn=G(()=>{qe();$e();tt();es();de();ys=class extends I{initialFill(){let e=this.size+3,s=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(et(s))||this.fixed.add(et(s,2)),this.grid.isBorder(Te(s))||this.fixed.add(Te(s,2)),this.grid.set(s,">"),this.fixed.add(s),this.grid.set(ue(s),"w"),this.fixed.add(ue(s)),this.fixed.add(et(s)),this.fixed.add(Te(s));let i=this.random.nextInt(this.w)<<4|2056,r=se(i,2);if(this.grid.set(i,"<"),this.fixed.add(i),this.grid.set(se(i),"w"),this.fixed.add(se(i)),this.grid.set(r,"w"),this.fixed.add(r),this.grid.set(se(r),"w"),this.fixed.add(se(r)),this.fixed.add(et(r)),this.fixed.add(Te(r)),!this.tryConnect(ue(s,2),se(r,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<e;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return E}refine(){return E}refineEdges(){return!0}addArenas(){return!0}addStairs(){return E}refineMetascreens(e){console.log(e.show());for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++){let o=i<<4|r,a=e.get(o),l=a.edgeIndex("w");if(a.hasFeature("arena"))this.arena=o+16<<8|1;else if(l===5){if(o<16||!e.get(o-16).hasFeature("arena")){e.set(o,e.rom.metascreens.goaWideHallNS_stairs);let c=(o<<8|o<<4)&61680|2056;this.grid.set(c,"H")}}else l===1&&(this.stair=o<<8|2)}if(this.reachable=void 0,!this.checkMeta(e))return{ok:!1,fail:"initial meta check"};console.log(e.show());let s=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let i=0;i<e.width;i++)for(let r=0;r<e.height;r++){let o=r<<12|i<<4|2056,a=0;for(;r+a<e.height&&this.grid.get(o+a*4096)==="H";)a++;if(!a)continue;let l=[new Map,new Map];for(let d=0;d<a;d++)l[d&1].set(r+d<<4|i,s);let c=!1;for(let d of this.random.ishuffle(l)){if(!d.size){c=!0;continue}if(!!this.checkMeta(e,d)){for(let[f,h]of d)e.set(f,h),this.grid.set(o+4096*((f>>4)-r),"=");c=!0;break}}if(!c)return{ok:!1,fail:"could not rectify hallway"};r+=a}return super.refineMetascreens(e)}checkMeta(e,s){let i=s?{with:s}:{},r=e.traverse(i),o=r.get(this.stair);return o!==r.get(this.arena)?(console.log(`stair not connected to arena
${e.show()}`),!1):this.reachable==null?o&&o.size<r.size*.95?(console.log("too small"),!1):(this.reachable=o?.size,!0):o?.size>this.reachable*.95}}});function No(n,t){let e=t.nextInt(2)+6,s=t.nextInt(3)+2;if(e===7&&s===3)return;let{branchNWSE:i,branchNWE:r,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:c}=n.rom.metascreens,d=e<<4|s,f=o;e===7&&s===1&&(f=c),e===7&&s===5&&(f=l),n.set2d(99,[[i],[i],[i]]),n.set2d(d-16,[[r],[a],[f]]),n.moveExit(115,d)}function Wo(n){let t=n.locations.Pyramid_Draygon.meta,e=n.locations.Pyramid_Main.meta,{metascreens:{hallSE:s,deadEndW_downStair:i,wideHallNE:r,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=n;t.width=2,t.set2d(0,[[null,l],[null,a],[r,o]]),t.moveExit(32,1),e.set2d(3,[[s,i]]),e.moveExit(3,4),e.attach(4,t,1)}var Ss,yn=G(()=>{Ss=class{constructor(t){this.location=t}shuffle(t){if(this.meta)throw new Error("impossible");let e=this.location.meta;No(e,t),t.nextInt(2)&&Wo(this.location.rom);let s=[...e.exits()].filter(a=>a[1]==="stair:up"),i=[...e.exits()].filter(a=>a[1]==="stair:down");t.shuffle(s),t.shuffle(i);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?s:i).pop();e.setExit(l[0],l[1],a[2])}if(s.length!==i.length)throw new Error("length mismatch");let r=t.shuffle([...i]);for(let a=0;a<i.length;a++)i[a]===r[a]&&(t.shuffle(r),a=-1);let o=this.location.id<<8;for(let a=0;a<s.length;a++)e.setExitOneWay(s[a][0],s[a][1],[o|i[a][0],i[a][1]]),e.setExitOneWay(r[a][0],r[a][1],[o|s[a][0],s[a][1]]);this.meta=e}finish(){}}});function Sn(n,t,e){let s=new ii(n),i=new ni(t,s),r=new ri(e,i);return[s,i,r]}var ii,ni,ri,oi,Ht,Cn=G(()=>{tt();$e();qe();ii=class extends I{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let s=this.insertPattern(e,{top:1,bottom:1});if(!s.ok)return s;this.addAllFixed();for(let i=0;i<this.grid.data.length;i++){if(this.grid.data[i]!==">")continue;let r=this.grid.coord(i);this.stair=r>>>8&240|r>>>4&15}return E}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?E:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let s of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,s)===" c  c  c "){this.grid.set(s+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return E}addLateFeatures(){return E}addStairs(){return E}},ni=class extends I{constructor(e,s){super(e);this.location=e;this.upper=s;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],s=!0,i=this.upper.meta,r=this.upper.stair;if(i.get(r).isEmpty()||(r+=16,s=!1),r==null)throw new Error("no stair found");for(let b of i.allPos())i.get(b).hasFeature("overpass")&&e.push(b);this.random.shuffle(e);let o=r>>>4,a=r&15,l=a,c=o;for(let b of e){let v=b>>>4,C=b&15;o=Math.min(o,v),a=Math.min(a,C),l=Math.max(l,C),c=Math.max(c,v)}let d=c-o+1,f=l-a+1,h=o<<4|a,u=1+this.random.nextInt(this.w-f-2),p=(this.random.nextInt(this.h-d-(s?1:0))<<4|u)-h,x=(r&15)-a<f/2;r+=p;for(let b=0;b<e.length;b++)e[b]+=p;let w=s?"    <  c ":x?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(r,w)){let b=[-1,1,16,-16,15,17,-15,-17],v=!1;for(let C of this.random.ishuffle(b))if(this.insertTile(r+C,w)){r+=C,v=!0;break}if(!v)throw new Error("Could not insert stair")}this.stair=r,this.addAllFixed(),this.count=3;let g=x?1:-1,k=s?16:g;return!e.includes(r+g)&&!this.tryConnect(this.posToGrid(r+k,2056),this.posToGrid(e[0]-g,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+g,2056),this.posToGrid(e[1]+g,2056),"c",10)?E:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?E:{ok:!1,fail:"could not populate"}}refine(){return E}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let s=e+2056;if(!(this.fixed.has(s)||this.grid.get(s))&&!(this.grid.get(et(s,2))||this.grid.get(Te(s,2)))&&this.grid.get(se(s,2))==="c"&&!!this.canSetAll(new Map([[se(s),"c"],[s,"a"],[ue(s),"c"],[ue(s,2),"c"]])))return this.grid.set(se(s),"c"),this.grid.set(s,"a"),this.grid.set(ue(s),"c"),this.fixed.add(s),this.fixed.add(ue(s,2)),!0}return!1}addStairs(e=0,s=0){return super.addStairs(e-1,s)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,s=this.upper.stair,i=this.stair;s!=null&&i!=null&&this.meta.attach(i,e,s,"stair:up","stair:down")}},ri=class extends I{constructor(e,s){super(e);this.main=s}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let s of e.allPos())if(e.get(s).hasFeature("arena"))return s;throw new Error("never found arena")}initialFill(){let e=this.main.meta,s=this.findArena(e),i=this.posToGrid(s,2056);return this.grid.set(i,"a"),this.grid.set(ue(i),"c"),this.grid.set(se(i),"c"),this.fixed.add(i),this.fixed.add(se(i)),this.fixed.add(se(i,2)),E}addEdges(){let e=10,s=2+this.random.nextInt(2);for(;this.count<s&&e;)this.tryAdd()||e--;return e?E:{ok:!1,fail:"addEdges"}}refine(){return E}addLateFeatures(){return E}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let s=e.value,i=this.findArena(s),r=this.main.meta;return s.set(i+15,this.orig.tileset.unreachableVariant(r.get(i+15))),s.set(i+16,this.orig.tileset.unreachableVariant(r.get(i+16))),s.set(i+17,this.orig.tileset.unreachableVariant(r.get(i+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,s=this.findArena(this.meta);super.finishInternal(),e.setExit(s,"seamless:up",[this.meta.id<<8|s,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},oi=class extends I{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return Pe.writeGrid2d(this.grid,0,oi.PATTERN),this.count=36,E}addSpikes(){let e=this.random.nextInt(4);for(let r=1;r<10;r++)for(let o=0;o<4;o++){let a=2*o+5+r*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),r===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let s=0;for(let r of this.random.ishuffle(this.grid.screens())){if(s===3)break;let o=r|2056,a=ue(o),l=ue(o,2),c=se(o),d=se(o,2),f=et(o),h=Te(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(c)==="s"||this.grid.get(d)==="s")continue;let u=[],m=[];for(let p of[c,f,h])this.grid.get(p)==="c"&&(this.grid.get(2*p-o)==="s"?m.push(p):u.push(p));if(!(m.length>1)&&!(!u.length&&!m.length)){for(;u.length+m.length>1&&!(u.length+m.length===2&&!u.includes(c)&&!m.includes(c));){let[p]=u.splice(this.random.nextInt(u.length),1);this.grid.set(p,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),s++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return E}},Ht=oi;Ht.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "]});function kn(n,t,e){let s=n.locations;Oo(n,e);let i=new as(n,e);i.add(),i.shuffles.length||i.add(new I(s.EastCave1),new I(s.EastCave2),new I(s.EastCave3),...cs(s.SealedCave1,s.SealedCave2),new I(s.SealedCave3),new I(s.SealedCave4),new I(s.SealedCave5),new I(s.SealedCave6),new I(s.SealedCave7),new I(s.SealedCave8),new I(s.WindmillCave),new I(s.ZebuCave),new ws(s.Swamp),new I(s.MtSabreWest_Cave1),new I(s.MtSabreWest_Cave2),new I(s.MtSabreWest_Cave3),new I(s.MtSabreWest_Cave4),new I(s.MtSabreWest_Cave5),new I(s.MtSabreWest_Cave6),new ct(s.MtSabreWest_Cave7),new I(s.MtSabreNorth_Cave1),new I(s.MtSabreNorth_Cave2),new I(s.MtSabreNorth_Cave3),new I(s.MtSabreNorth_Cave4),new I(s.MtSabreNorth_Cave5),new I(s.MtSabreNorth_Cave6),new I(s.MtSabreNorth_Cave7),new I(s.MtSabreNorth_Cave8),new I(s.MtSabreNorth_Cave9),new I(s.MtSabreNorth_LeftCell2),new I(s.MtSabreNorth_SummitCave),new I(s.KirisaPlantCave1),new I(s.KirisaPlantCave2),new I(s.KirisaPlantCave3),new I(s.FogLampCave1),new I(s.FogLampCave2),new I(s.FogLampCave3),new fs(s.FogLampCaveDeadEnd),...cs(s.FogLampCave5,s.FogLampCave4,!0),...cs(s.FogLampCave7,s.FogLampCave6),new ct(s.WaterfallCave1),new I(s.WaterfallCave2),new dt(s.WaterfallCave3),new ps(s.WaterfallCave4),new Ue(s.EvilSpiritIsland2).requirePitDestination(),new ct(s.EvilSpiritIsland3),new Ue(s.EvilSpiritIsland4),new ms(s.SaberaPalace1).requirePitDestination(),new I(s.SaberaPalace2),new I(s.SaberaPalace2_West),new I(s.JoelSecretPassage),new I(s.MtHydra_Cave1),new I(s.MtHydra_Cave2),new I(s.MtHydra_Cave3),new I(s.MtHydra_Cave4),new I(s.MtHydra_Cave5),new I(s.MtHydra_Cave6),new dt(s.MtHydra_Cave7),new I(s.MtHydra_Cave8),new I(s.MtHydra_Cave9),new I(s.MtHydra_Cave10),new dt(s.Styx1).setUpEdgeType("c"),new gs(s.Styx2).requirePitDestination(),new I(s.Styx3),new bs(s.OasisCaveMain),new I(s.DesertCave1),new I(s.DesertCave2),new I(s.Pyramid_Branch),new Ss(s.Pyramid_Main),new ds(s.Crypt_Entrance),new dt(s.Crypt_Hall1).setUpEdgeType("c"),new I(s.Crypt_DeadEndLeft),new I(s.Crypt_DeadEndRight),new I(s.Crypt_Branch),new I(s.Crypt_Hall2),new ys(s.GoaFortress_Kelbesque),new Ue(s.GoaFortress_Sabera),new I(s.GoaFortress_Mado1).requirePitDestination(),new I(s.GoaFortress_Mado2),new I(s.GoaFortress_Mado3),new I(s.GoaFortress_Karmine1),new I(s.GoaFortress_Karmine2),new I(s.GoaFortress_Karmine4),new Ht(s.GoaFortress_Karmine6),...Sn(s.GoaFortress_Karmine3,s.GoaFortress_Karmine5,s.GoaFortress_Kensu),new xs(s.OasisCave_Entrance)),i.shuffleAll(),console.log(String(i))}function Oo(n,t=new Ae(1)){tn(n),xn(n),bn(n,t)}var vn=G(()=>{qe();os();un();mn();pn();gn();ti();wn();yn();es();Cn();$e()});var vt,ai,In,Gc,Mn,Ac,Pc,Rn=G(()=>{vt=typeof __VERSION__=="object"?__VERSION__:{},ai=vt.STATUS||"unstable",In=vt.VERSION||"HEAD",Gc=vt.LABEL||"HEAD",Mn=vt.HASH||"HEAD",Ac=vt.DATE||new Date,Pc=vt.PREV||""});async function Dc(n){let t=document.createElement("canvas");t.width=112,t.height=100;let e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,t.width,t.height);let s=new ImageData(new Uint8ClampedArray(n.rendered),128,128),i=await createImageBitmap(s,{resizeQuality:"pixelated"});return e.drawImage(i,0,0,16,24,24,2,16*4,24*4),t.toDataURL("image/png")}async function $o(n,t){let e=n.byteLength/16,s=8,i=0,r=document.createElement("canvas");r.width=128,r.height=128;let a=r.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(n);for(let c=0;c<e;++c){let d=c*16,f=c%16*8,h=Math.floor(c/16)*8;for(let u=0;u<s;++u){let m=l[d+u],p=l[d+u+8];for(let x=0;x<s;++x){let w=7-x,g=m>>w&1,k=(p>>w&1)<<1,b=(g|k)+i*4,v=jo[t[b]],C=(f+x)*4+(h+u)*4*128;a.data[0+C]=v[0],a.data[1+C]=v[1],a.data[2+C]=v[2],a.data[3+C]=b==0?0:255}}}return a}async function Tn(n){let t=Ki()[n],e=n.replace(/^.*[\\\/]/,"");return Ko(e,t)}function di(n){let t="",e="",s=0;for(;s<n.length;)if(n[s]==="["){++s;let i=n.indexOf("]",s),r=parseInt(n.slice(s,i),16)-1;t+=e.repeat(r),s=i+1}else e=n.slice(s,s+2),t+=e,s+=2;return t}function En(n,t){return n.match(new RegExp(".{1,"+t+"}","g"))||[]}function Fn(n){let t=En(n,2).map(e=>parseInt(e,16));return new Uint8Array(t)}function qo(n){return n.map(t=>parseInt(t,16))}function Ho(n,t,e){return 262144+n*8192+t*1024+e*16}function xe(n){return[new S(8,2,n,n+64),new S(8,3,n,n+64),new S(8,4,n,n+64),new S(8,5,n,n+64),new S(8,6,n,n+64)]}function An(n,t){return n.length===t.length&&n.every((e,s)=>e===t[s])}function Uo(n){let t=new Map,e=Array.from(new Uint8Array(Fn(di(n.get("MetaSprites")||"")))),s=parseInt(n.get("VarSpriteGridX")||"64"),i=parseInt(n.get("VarSpriteGridY")||"64"),r;for(let o=0;r=n.get(`MetaSprite${o}`)?.trim();o++){let a=Gn.get(r);if(!a){console.warn(`Missing mapping for ${r}`);continue}let l=[],c=o*64*4;for(;!An(e.slice(c,c+4),[255,255,255,255]);){let u=e.slice(c,c+4);u[3]-=s,u[0]-=i;let m=[u[3],u[0],u[2],u[1]];l.push(m),c+=4}let[d,f]=a,h=t.get(d)||new Map;h.set(f,l),t.set(d,h)}return t}async function Ko(n,t){let e=new Map(t.replace(/\r\n/g,`
`).split(`
`).filter(l=>l.includes("=")).map(l=>l.split("=")).map(l=>[l[0],l[1]])),s=e.get("Palette")||"",i=qo(En(di(s).slice(0,32),2)),r=Array.from(new Uint8Array(Fn(di(e.get("CHRMain")||"")))),o=Uo(e),a=await $o(new Uint8ClampedArray(r),i);return new li(n,r,i,o,Array.from(new Uint8Array(a.data)))}var S,li,ci,st,Cs,Ke,Gn,jo,Pn=G(()=>{Vi();le();S=class{constructor(t,e,s,i){this.page=t;this.bank=e;this.tile=s;this.pputile=i}},li=class{constructor(t="",e=[],s=[],i=new Map,r=[]){this.filename=t,this.chrdata=e,this.palette=s,this.metasprites=i,this.rendered=r}};ci=class{constructor(t,e,s,i){this.name=t,this.converter=e,this.nssdata=s,this.description=i}static async init(t,e,s,i){let r=await s;return new ci(t,e,r,i)}static applyPatch(t,e,s){let i=s?262144:0,r=!1,o=Ke.getChr(t.converter);for(let[l,c]of o)for(let d of c)for(let f=0;f<16;++f)e[Ho(d.page,d.bank,d.tile)+f+i]=t.nssdata.chrdata[l*16+f];for(let[l,c]of Ke.getPalette(t.converter))for(let d of c)switch(l){case"color0":e[d]=t.nssdata.palette[0];break;case"color1":e[d]=t.nssdata.palette[1];break;case"color2":e[d]=t.nssdata.palette[2];break;case"color3":e[d]=t.nssdata.palette[3];break;case"sprite_palette":e[d+i]=0;break}let a=230492;for(let[l,[c,d]]of Ke.getMetasprite(t.converter)){let f=Yt(e,a+(c<<1))+196608,h=e[f],m=e[f+1]+1;if(d>m){console.warn(`Custom metasprite ${l} with the id ${c}
          and frame number ${d} greater than the vanilla frame count: ${m}`),r=!0;continue}let p=e.subarray(f+2+d*h*4),x=t.nssdata.metasprites.get(c).get(d),w=0;for(;w/4<h&&!An(Array.from(p.subarray(w,w+4)),[128,128,128,128]);)w+=4;if(x.length!=w/4){console.warn(`Custom metasprite ${l} with the id ${c}
          and frame number ${d} does not equal the vanilla sprite size: ${x.length} != ${w/4}`),r=!0;continue}for(let g=0;g<x.length;++g)p[g*4+0]=x[g][0],p[g*4+1]=x[g][1],p[g*4+2]=x[g][2]|p[g*4+2]&4,p[g*4+3]=o.get(x[g][3])[0].pputile}return r}},st=ci;st.isCustom=t=>t.name!="Simea";Cs=class{constructor(){this.mapping=new Map;this.mapping.set("simea",new Map([["Simea",st.init("Simea","simea",Tn("Simea.nss"),"The original main character of Crystalis")],["Mesia",st.init("Mesia","simea",Tn("Mesia.nss"),"Secondary protagonist Mesia takes the spotlight!")]]))}static get(t){return this.instance||(this.instance=new Cs),this.instance.mapping.get(t)}},Ke=class{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.metaspriteMapping=new Map;this.chrMapping.set("simea",this.generateSimeaMapping()),this.paletteMapping.set("simea",this.generateSimeaPalette()),this.metaspriteMapping.set("simea",Gn)}static getChr(t){return this.instance||(this.instance=new Ke),this.instance.chrMapping.get(t)}static getPalette(t){return this.instance||(this.instance=new Ke),this.instance.paletteMapping.get(t)}static getMetasprite(t){return this.instance||(this.instance=new Ke),this.instance.metaspriteMapping.get(t)}generateSimeaPalette(){let t=new Map,e=[27888,254120];return t.set("color0",e.map(s=>s+0)),t.set("color1",e.map(s=>s+1)),t.set("color2",e.map(s=>s+2)),t.set("color3",e.map(s=>s+3)),t.set("sprite_palette",[245844]),t}generateSimeaMapping(){let t=new Map;t.set(0,[new S(8,0,26,26)]),t.set(1,[new S(8,0,27,27)]),t.set(16,[new S(8,0,0,0)]),t.set(17,[new S(8,0,1,1)]),t.set(32,[new S(8,0,32,32)]),t.set(33,[new S(8,0,33,33)]),t.set(2,[new S(8,0,28,28)]),t.set(3,[new S(8,0,29,29)]),t.set(18,[new S(8,0,2,2)]),t.set(19,[new S(8,0,3,3)]),t.set(20,[new S(8,0,4,4)]),t.set(21,[new S(8,0,5,5)]),t.set(34,[new S(8,0,34,34)]),t.set(35,[new S(8,0,35,35)]),t.set(36,[new S(8,0,36,36)]),t.set(37,[new S(8,0,37,37)]),t.set(6,[new S(8,0,30,30)]),t.set(7,[new S(8,0,31,31)]),t.set(22,[new S(8,0,6,6)]),t.set(23,[new S(8,0,7,7)]),t.set(38,[new S(8,0,38,38)]),t.set(39,[new S(8,0,39,39)]),t.set(64,[new S(8,0,20,20)]),t.set(65,[new S(8,0,21,21)]),t.set(80,[new S(8,0,52,52)]),t.set(81,[new S(8,0,53,53)]),t.set(50,[new S(8,0,60,60)]),t.set(51,[new S(8,0,61,61)]),t.set(66,[new S(8,0,24,24)]),t.set(67,[new S(8,0,25,25)]),t.set(82,[new S(8,0,56,56)]),t.set(68,[new S(8,0,22,22)]),t.set(69,[new S(8,0,23,23)]),t.set(84,[new S(8,0,54,54)]),t.set(112,[new S(8,0,14,14)]),t.set(113,[new S(8,0,15,15)]),t.set(128,[new S(8,0,46,46)]),t.set(129,[new S(8,0,47,47)]),t.set(114,[new S(8,0,18,18)]),t.set(115,[new S(8,0,19,19)]),t.set(130,[new S(8,0,48,48)]),t.set(131,[new S(8,0,51,51)]),t.set(116,[new S(8,0,16,16)]),t.set(117,[new S(8,0,17,17)]),t.set(133,[new S(8,0,49,49)]),t.set(160,[new S(8,0,8,8)]),t.set(161,[new S(8,0,9,9)]),t.set(176,[new S(8,0,40,40)]),t.set(146,[new S(8,0,58,58)]),t.set(147,[new S(8,0,59,59)]),t.set(162,[new S(8,0,12,12)]),t.set(163,[new S(8,0,13,13)]),t.set(178,[new S(8,0,44,44)]),t.set(179,[new S(8,0,45,45)]),t.set(164,[new S(8,0,10,10)]),t.set(165,[new S(8,0,11,11)]),t.set(181,[new S(8,0,43,43)]);let e=new Map(t),s=256;for(let[i,r]of e){let o=i+s,a=r.map(l=>new S(l.page,l.bank+1,l.tile,l.pputile));t.set(o,a)}return t.set(192,[new S(11,4,0,0)]),t.set(193,[new S(11,4,1,1)]),t.set(208,[new S(11,4,2,2)]),t.set(209,[new S(11,4,3,3)]),t.set(224,[new S(11,4,4,4)]),t.set(225,[new S(11,4,5,5)]),t.set(194,[new S(11,4,36,36)]),t.set(195,[new S(11,4,37,37)]),t.set(210,[new S(11,4,6,6)]),t.set(211,[new S(11,4,7,7)]),t.set(226,[new S(11,4,38,38)]),t.set(227,[new S(11,4,39,39)]),t.set(196,[new S(11,4,32,32)]),t.set(197,[new S(11,4,33,33)]),t.set(212,[new S(11,4,34,34)]),t.set(213,[new S(11,4,35,35)]),t.set(214,[new S(11,4,20,20)]),t.set(215,[new S(11,4,21,21)]),t.set(230,[new S(11,4,22,22)]),t.set(231,[new S(11,4,23,23)]),t.set(54,[new S(11,4,12,12)]),t.set(55,[new S(11,4,13,13)]),t.set(70,[new S(11,4,50,50)]),t.set(71,[new S(11,4,51,51)]),t.set(86,[new S(11,4,46,46)]),t.set(87,[new S(11,4,47,47)]),t.set(180,[new S(11,4,54,54)]),t.set(181,[new S(11,4,55,55)]),t.set(228,[new S(11,4,56,56)]),t.set(229,[new S(11,4,57,57)]),t.set(198,[new S(11,4,58,58)]),t.set(199,[new S(11,4,59,59)]),t.set(102,[new S(11,4,18,18)]),t.set(103,[new S(11,4,19,19)]),t.set(118,[new S(11,4,8,8)]),t.set(119,[new S(11,4,9,9)]),t.set(134,[new S(11,4,40,40)]),t.set(135,[new S(11,4,41,41)]),t.set(150,[new S(11,4,44,44)]),t.set(151,[new S(11,4,45,45)]),t.set(166,[new S(11,4,10,10)]),t.set(167,[new S(11,4,11,11)]),t.set(182,[new S(11,4,42,42)]),t.set(183,[new S(11,4,43,43)]),t.set(240,xe(16)),t.set(241,xe(17)),t.set(242,xe(18)),t.set(243,xe(19)),t.set(244,xe(20)),t.set(245,xe(21)),t.set(246,xe(22)),t.set(247,xe(23)),t.set(248,[new S(8,4,237,237)]),t.set(249,xe(25)),t.set(250,xe(26)),t.set(252,xe(48)),t.set(253,xe(49)),t.set(254,xe(50)),t.set(255,xe(51)),t}};Gn=new Map([["Up 1",[0,1]],["Up 2",[0,0]],["Right 1",[1,1]],["Right 2",[1,0]],["Down 1",[2,1]],["Down 2",[2,0]],["Stab Up 1",[4,2]],["Stab Up 2",[4,1]],["Stab Up 3",[4,0]],["Stab Right 1",[5,2]],["Stab Right 2",[5,1]],["Stab Right 3",[5,0]],["Stab Down 1",[6,2]],["Stab Down 2",[6,1]],["Stab Down 3",[6,0]],["Arm Right 1",[9,1]],["Arm Right 2",[9,0]],["Shield Up 1",[12,1]],["Shield Up 2",[12,0]],["Shield Right 1",[13,1]],["Shield Right 2",[13,0]],["Shield Down 1",[14,1]],["Shield Down 2",[14,0]],["Shield Stab Up 1",[16,2]],["Shield Stab Up 2",[16,1]],["Shield Stab Up 3",[16,0]],["Shield Stab Right 1",[17,2]],["Shield Stab Right 2",[17,1]],["Shield Stab Right 3",[17,0]],["Shield Stab Down 1",[18,2]],["Shield Stab Down 2",[18,1]],["Shield Stab Down 3",[18,0]],["Sword Get 1",[184,1]],["Sword Get 2",[184,0]],["Death 1",[188,3]],["Death 2",[188,2]],["Death 3",[188,1]],["Death 4",[188,0]],["Death Last",[189,0]],["Telepathy Intro 1",[204,1]],["Telepathy Intro 2",[204,0]],["Telepathy 1",[205,1]],["Telepathy 2",[205,0]]]);jo=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]]});function ui(n,t,e){return new fi(t,e).smudge(n)}function*Vo(n){let t=0;for(;t<n.length;){let e=n.indexOf(`
`,t)+1||n.length;yield n.substring(t,e),t=e}}function Xo(n,t,e,s){let i=s,[r,o]=n.disasm(t[e])||["brk","imp"],a=n.argLen(o);return i||(a>0&&(i=t[e+1]),a>1&&(i=i|t[e+2]<<8)),r+(a?" "+n.format(o,i):"")}function Yo(n,t,e){let s=n[t];if(e===":w")return s|=n[t+1]<<8,`($${Ln(s,4)})`;if(/:\d+/.test(e)){let i=parseInt(e.substring(1)),r='"';for(let o=0;o<i;o++){let a=String.fromCharCode(n[t+o]);'"\\'.includes(a)&&(a="\\"+a),r+=a}return r+='"',r}else return e===":d"?String(s):e===":b"?`%${s.toString(2).padStart(8,"0")}`:`$${Ln(s,2)}`}function Ln(n,t=2){return n.toString(16).padStart(t,"0")}var Bn,fi,hi,ft,It,Dn=G(()=>{Oi();mo();(t=>{function n(e,s=Nt.P02){return i=>Promise.resolve(ui(i,s,e))}t.forKnownPrg=n})(Bn||(Bn={}));fi=class{constructor(t,e){this.cpu=t;this.prg=e}smudge(t){let e="";for(let s of Vo(t))e+=this.smudgeLine(s);return e}smudgeLine(t){let e=/^([^;]*?)<@([0-9a-f]+)(?: (.*?))?@>(.*\n?)$/i.exec(t);if(e){let[,i,r,o,a]=e,l=parseInt(r,16),c=Xo(this.cpu,this.prg,l,o);return i+c+a}let s="";for(;;){let i=/^([^;]*?)\[@([0-9a-f]+)(:[0-9]+|:[wdb])?@\](.*\n?)/i.exec(t);if(!i){s+=t;break}let[,r,o,a,l]=i;t=l,s+=r;let c=parseInt(o,16);s+=Yo(this.prg,c,a)}return s}};hi=class{constructor(t){this.plain=t}fix(t,e,s){}format(t,e){return this.plain}},ft=class extends hi{constructor(e){super("");this.fix=e}static set(e){return new ft(s=>s.set(e))}},It=ft;It.push=new ft(e=>e.push()),It.alt=new ft(e=>e.alt()),It.pop=new ft(e=>e.pop()),It.merge=new ft(e=>e.merge())});var Q,_n=G(()=>{Q={of:(...n)=>{let t=0n;for(let e of n)t|=1n<<BigInt(e);return t},from:n=>{let t=0n;for(let e of n)t|=1n<<BigInt(e);return t},containsAll:(n,t)=>!(t&~n),with:(n,t)=>n|1n<<BigInt(t),without:(n,t)=>n&~(1n<<BigInt(t)),has:(n,t)=>!!(n&1n<<BigInt(t)),bits:n=>{let t=[],e=0;for(;n;){let s=Number(n&0xffffffffn),i=32;for(;s;){let r=Math.clz32(s)+1;i-=r,s<<=r,r===32&&(s=0),t.push(e|i)}n>>=32n,e+=32}return t},clone:n=>n,empty:n=>!n,difference:(n,t)=>n&~t,union:(n,t)=>n|t}});var Zo,Jo,ks,Nn=G(()=>{_n();os();le();de();Zt();Zo=2,Jo=2,ks=class{constructor(t){this.worlds=t;this.lastFailure="";let e=new Set,s=new Set,i=new Map,r=new Map;for(let f=0;f<t.length;f++){let h=t[f],u=f<<24;for(let[m,p]of h.requirements){e.add(u|m);for(let x of p)for(let w of x)s.add(u|w)}for(let[m,p]of h.items)r.set(u|m,p);for(let[m,p]of h.slots)i.set(u|m,p)}this.itemInfos=new Map(r),this.slotInfos=new Map(i),this.progression=new Set(s);for(let f of r.keys())s.add(f);let o=new Set,a=new Set,l=new Set;for(let f of s)(e.has(f)?o:l).add(f);for(let f of e)s.has(f)||a.add(f);this.common=o.size,this.slots=new $s([...o,...a]),this.items=new $s([...o,...l]);let c=[],d=[];for(let f=0;f<t.length;f++){let h=f<<24;for(let[u,m]of t[f].requirements){let p=this.slots.index(h|u);if(p==null)throw new Error(`Provided a non-slot? ${j(u)}`);for(let x of m){let w=[...x].map(g=>this.items.index(h|g)??Fe());(c[p]||(c[p]=[])).push(Q.from(w));for(let g of w)(d[g]||(d[g]=new Set)).add(p)}}}for(let f=0;f<this.slots.length;f++)if(!c[f]||!c[f].length){let h=this.slots.get(f)??NaN,u=this.checkName(h);console.error(`Nothing provided $${j(h)}: ${u} (index ${f})`)}this.graph=new _t(c),this.unlocks=new _t(d.map(Xt))}computeWeights(t=new Ae,e=1){let s=Array.from({length:this.items.length},()=>0),i=Array.from({length:this.slots.length},()=>0),r=[];for(let[o,a]of this.items)a>=512&&a<640&&this.progression.has(a)&&r.push(o);for(let o=0;o<e;o++){let a=t.shuffle([...r]),l=Q.of(),c=this.traverse(()=>{},l),d=0;for(let f of a){d++,l=Q.with(l,f);let h=this.traverse(()=>{},l),u=0;for(let m of h)c.has(m)||(i[m]+=d,u++);s[f]+=u,c=h}}return{items:new _t(s.map(o=>o/e)),slots:new _t(i.map(o=>o/e))}}reportWeights(){let t=this.computeWeights(new Ae,10),e=t.items.map((r,o)=>[o,r]),s=t.slots.map((r,o)=>[o,r]);function i(r){let o=globalThis.rom;return(r&-256)===512&&o&&o.items[r&255]?o.items[r&255].messageName:`$${r.toString(16).padStart(2,"0")}`}e.sort((r,o)=>o[1]-r[1]),s.sort((r,o)=>o[1]-r[1]);for(let[r,o]of e){let a=this.items.get(r);!this.itemInfos.has(a)||!this.progression.has(a)||console.log(`Item ${i(a)}: ${o}`)}for(let[r,o]of s){let a=this.slots.get(r);!this.slotInfos.has(a)||console.log(`Slot ${this.checkName(a)}: ${o}`)}}async shuffle(t,e,s=200,i,r){globalThis.graph=this,i&&i.addTasks(Math.floor(s/10));let o=this.computeWeights(e,1);e:for(let a=0;a<s;a++){this.lastFailure="",i&&a%10===9&&(i.addCompleted(1),await new Promise(requestAnimationFrame));let l=new qs;this.prefill(l,e);let c=this.compressFill(l),d=[...e.ishuffleMetropolis(this.itemPool(c.values(),o),Jo)].reverse(),f=Q.from(new Set(d)),h=Math.floor(a/5);if(!this.fillInternal(c,d,f,e,o,t,h))continue;let u=r?[]:void 0,m=this.traverse(g=>c.get(g),Q.of(),u),p=this.analyzeSpheres(g=>c.get(g)),x=t.buryFlightStartSphere()-a/4;for(let[g,,k]of p)if(g===584&&k<x)continue e;if(m.size!==this.slots.length){let g=C=>`${String(C).padStart(3)} ${this.slots.get(C).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(C))}`,k=C=>`${String(C).padStart(3)} ${this.items.get(C).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(C))}`,b=new Set([...this.slots].map(C=>C[0]));for(let C of m)b.delete(C);let v=new Map;for(let C of b)v.set(g(C),this.graph.get(C).map(F=>`
    `+Q.bits(F).map(k).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...v.keys()].sort().map(C=>C+v.get(C)).join(`
  `)}`),this.lastFailure="unreachable slots?";continue}this.expandFill(c,l);let w=this.fillNonProgression(l,t,e);if(w!=null){if(i&&i.addCompleted(Math.floor((s-a)/100)),r){for(let[g,k]of l){let b=this.checkName(g).replace(/^[0-9a-f]{3} /,"");r.addSlot(g,b,k)}if(u)for(let[g,...k]of u)(g<this.common||c.has(g))&&r.addCheck(this.slots.get(g),k.map(b=>this.items.get(b)))}return w}}throw new Error(`Shuffle failed: ${this.lastFailure||"unknown error"}`)}fillInternal(t,e,s,i,r,o,a){let l=new Set(t.keys());for(let c=e.pop();c!=null;c=e.pop()){if(!Q.has(s,c))continue;let d=this.itemInfoFromIndex(c);s=Q.without(s,c);let f=[...this.traverse(m=>t.get(m),s)].map(m=>[r.slots.get(m)||0,m]),h=!1,u=new Set(t.keys());for(let m of i.ishuffleMetropolis(f,(Zo+a)*(a+1))){if(u.has(m))continue;u.add(m);let p=this.slotInfoFromIndex(m);if(!(!p||o.preserveUniqueChecks()&&!p.unique||!this.fits(p,d,o))){t.set(m,c),h=!0;break}}if(!h){if(u.clear(),a-- >0){for(let m of i.ishuffleMetropolis(f,100)){if(u.has(m)||!t.has(m)||l.has(m))continue;u.add(m);let p=this.slotInfoFromIndex(m);if(!p||!this.fits(p,d,o))continue;let x=t.replace(m,c)??Fe();s=Q.with(s,x),e.push(x),i.shuffle(e),h=!0;break}if(h)continue}return this.lastFailure=`could not place ${this.checkName(this.items.get(c))}, ${e.filter(m=>Q.has(s,m)).length} remaining`,!1}}return!0}itemPool(t,e){let s=new Set(t),i=[];for(let[r]of this.itemInfos){let o=this.items.index(r);o!=null&&(!this.progression.has(r)||s.has(o)||i.push([e.items.get(o)||0,o]))}return i}fits(t,e,s){if(s.preserveUniqueChecks()&&e.unique&&!t.unique||(e.unique||e.preventLoss)&&t.broken)return!1;let i=e.preventLoss||t.preventLoss;return!(t.lossy&&e.losable&&i)}fillNonProgression(t,e,s){let i=[[],[],[]],r=[[],[]];for(let[c,d]of this.itemInfos){if(t.hasValue(c))continue;let f=2;d.losable&&d.preventLoss&&(f=1),e.preserveUniqueChecks()&&d.unique&&(f=0),i[f].push(c)}for(let[c,d]of this.slotInfos){if(t.has(c))continue;let f=d.lossy&&d.preventLoss?0:1;r[f].push(c)}for(let c of[...i,...r])s.shuffle(c);let o=c=>this.checkName(c),a=oe.count(oe.concat(...r)),l=oe.count(oe.concat(...i));if(l>a)throw console.log(`Slots ${a}:
  ${[...oe.concat(...r)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...oe.concat(...i)].map(o).join(`
  `)}`),new Error("Too many items");for(let c of oe.concat(...i)){let d=!1;for(let f of[...r]){if(d)break;for(let h=0;h<f.length;h++)if(this.fits(this.slotInfos.get(f[h]),this.itemInfos.get(c),e)){t.set(f[h],c),d=!0,f.splice(h,1);break}}if(!d)return console.log(`Slots:
  ${[...oe.concat(...r)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(c)}`),this.lastFailure=`could not place non-progression ${o(c)}`,null}return new Map(t)}traverse(t,e,s){e=Q.clone(e);let i=new Set,r=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}r.add(o)}for(let o of r){if(r.delete(o),i.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,c=a.length;l<c;l++){if(!Q.containsAll(e,a[l]))continue;s&&s.push([o,...Q.bits(a[l])]),i.add(o);let d=[];o<this.common&&d.push(o);let f=t(o);f!=null&&d.push(f);for(let h of d){e=Q.with(e,h);for(let u of this.unlocks.get(h)||[]){if(this.graph.get(u)==null)throw console.dir(this),new Error(`Adding bad node ${u} from unlock ${h}`);r.add(u)}}break}}return i}analyzeSpheres2(t){let e=Q.of(),s=0,i=Q.of(),r=[],o=new Set(Array.from({length:this.slots.length},(a,l)=>l));do{let a=new Set(o);i=Q.of();for(let l of a){let c=this.graph.get(l);for(let d=0,f=c.length;d<f;d++){if(!Q.containsAll(e,c[d]))continue;o.delete(l);let h=[];l<this.common&&h.push(l);let u=t(l);u!=null&&h.push(u);for(let m of h){let p=this.items.get(m);if(p!=null&&p>=512&&p<640)r.push([this.itemNameFromIndex(m),s,this.checkName(this.slots.get(l))]),i=Q.with(i,m);else{e=Q.with(e,m);for(let x of this.unlocks.get(m)||[])o.has(x)&&a.add(x)}}break}}e=Q.union(e,i),Q.empty(i)||s++}while(o.size);return r}analyzeSpheres(t){let e=Q.of(),s=0,i=[];for(;;){let r=this.traverse(()=>{},e),o=!1;for(let a of r){let l=t(a);if(l==null||Q.has(e,l))continue;e=Q.with(e,l),o=!0;let c=this.items.get(l);c!=null&&c>=512&&c<640&&i.push([c,this.itemNameFromIndex(l),s,this.checkName(this.slots.get(a))])}if(!o)break;s++}return i}expandFill(t,e){for(let[s,i]of t){let r=this.slots.get(s),o=this.items.get(i);if(r==null||o==null)throw new Error("missing");e.replace(r,o)}}compressFill(t){let e=new qs;for(let[s,i]of t){let r=this.slots.index(s),o=this.items.index(i);if(r==null||o==null)throw new Error(`Bad slot/item: ${s} ${r} ${i} ${o}`);e.set(r,o)}return e}checkName(t){return this.worlds[t>>>24].checkName(t&16777215)}itemNameFromIndex(t){if(t<this.common)return this.checkName(this.slots.get(t));let e=this.items.get(t);return!e||(e&-256)!==512?"$"+j(e):globalThis.rom.items[e&255]?.messageName||"$"+j(e)}prefill(t,e){for(let s=0;s<this.worlds.length;s++){let i=s<<24,r=this.worlds[s].prefill(e);for(let[o,a]of r)t.set(i|o,i|a)}}itemInfoFromIndex(t){let e=this.items.get(t);if(e==null)throw new Error(`Bad item: ${t}`);return this.itemInfoFromId(e)}itemInfoFromId(t){let e=this.itemInfos.get(t);if(e==null)throw new Error(`Missing info: ${j(t)}`);return e}slotInfoFromIndex(t){let e=this.slots.get(t);if(e==null)throw new Error(`Bad slot: ${t}`);return this.slotInfoFromId(e)}slotInfoFromId(t){let e=this.slotInfos.get(t);if(e!=null)return e}}});function Wn(n){return n<128?n:n-256}var vs,Qo,On=G(()=>{Zt();le();vs=class{constructor(t,e,s,i=1){this.rom=t;this._width=s,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=s,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Fe(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=ne(i,()=>new Uint32Array(s*e)),this.data=this.layers[0];for(let r=0;r<256;r++)for(let o=0;o<4;o++){let a=Qo[t.palettes[r].color(o)];this.palettes[r<<2|o]=a|4278190080}}useLayer(t){this.data=this.layers[t]||Fe(`Bad layer: ${t}`)}resizeWidth(t,e){let s=new Uint32Array(e*this._height),i=Math.min(e,this._width);for(let r=0;r<this._height;r++)s.subarray(r*e,r+e+i).set(t.subarray(r*this._width,r*this._width+i));return s}resizeHeight(t,e){let s=new Uint32Array(this._width*e),i=this._width*Math.min(e,this._height);return s.subarray(0,i).set(t.subarray(0,i)),s}get width(){return this._width}set width(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],t);this._width=t,this.canvas.width=t}get height(){return this._height}set height(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],t);this._height=t,this.canvas.height=t}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(t){this.data.fill(t)}clear(t){let e=t!=null?this.palettes[t<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let s=1;s<this.layers.length;s++)this.layers[s].fill(0)}toDataUrl(t=!1){return this.canvas.toDataURL("image/png")}render(){let t=this.canvas,e=this.ctx;for(let s=0;s<this.layers.length;s++){s&&(t=document.createElement("canvas"),t.width=this.canvas.width,t.height=this.canvas.height,e=t.getContext("2d")||Fe());let i=new Uint8Array(this.layers[s].buffer),r=e.getImageData(0,0,this._width,this._height);r.data.set(i),e.putImageData(r,0,0),s&&this.ctx.drawImage(t,0,0)}}rect(t,e,s,i,r){let o=Math.max(0,t),a=Math.max(0,e),l=Math.min(this._height,t+s),c=Math.min(this._width,e+i);for(t=o;t<l;t++)for(e=a;e<c;e++)this.data[t*this._width+e]=r}tile(t,e,s,i){if(e<0||t<0||e+8>=this._width||t+8>=this._height)return;let r=this.rom.patterns.get(s).flip(i<<6);for(let o=0;o<8;o++){let a=r.pixels[8|o]<<1,l=r.pixels[o];for(let c=7;c>=0;c--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(t+o)*this._width+e+c]=this.palettes[i&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,t),this._maxY=Math.max(this._maxY,t+8)}metatile(t,e,s,i,r=0){let o=this.rom.locations[i],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[r&7]);let l=[...o.tilePalettes,127],c=this.rom.tilesets[o.tileset],d=l[c.attrs[s]];for(let f=0;f<2;f++)for(let h=0;h<2;h++){let u=c.tiles[f<<1|h][s],m=a[u&128?1:0]<<6|u&127,p=e+(h<<3),x=t+(f<<3);this.tile(x,p,m,d<<2)}}metasprite(t,e,s,i,r=0,o=0){let a=this.rom.locations[i],l=this.rom.metasprites[s],c=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],f=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],f=!0),!l||!l.used)return;let h=o&l.frameMask;for(let[u,m,p,x]of l.sprites[h]){if(u==128)break;u=Wn(u),m=Wn(m),x=x+r&255;let w=c[x>>6],g=d[p&3]+176&255,k=w<<6|x&63;f&&(u=-8-u,p^=64),this.tile(t+m,e+u,k,g<<2|p>>6)}}text(t,e,s,i=18){for(let r=0;r<s.length;r++)this.tile(t,e+8*r,s.charCodeAt(r)|3840,i<<2)}},Qo=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0]});function $(n){return n}var Is=G(()=>{(e=>{function n({id:s},{x:i,y:r}){let o=i>>>8,a=i>>>4&15,l=r>>>8,c=r>>>4&15;return s<<16|l<<12|o<<8|c<<4|a}e.from=n;function t(s,i,r){let o=s;if(i){let a=(o&240)+(i<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(r){let a=(o&15)+r;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=t})($||($={}))});var zn,it,$n=G(()=>{On();Is();zn=Symbol("[LocationMap data]"),it=class extends vs{constructor(e,s=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let i=e.locations[s];this.width=(i.used?i.width:1)*256,this.height=(i.used?i.height:1)*240,this.location=i;let r=o=>{let a=o.offsetX,l=o.offsetY,c=o.target;for(;c&&c!==this.element;)c=c.parentElement;if(!c)return;let d=a>>8,f=Math.floor(l/240),h=a-256*d>>4,u=l-240*f>>4,p=this.location.id<<16|f<<12|d<<8|u<<4|h;it.setData(o,{tile:p,target:this})};this.element.addEventListener("mousemove",r),this.element.addEventListener("mousedown",r),this.element.addEventListener("mouseup",r),this.element.addEventListener("click",r),this.redraw()}static getData(e){return e[zn]}static setData(e,s){e[zn]=s}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,s=(1-e)*50;this.element.style.transform=`translate(-${s}%,-${s}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,s,i){for(let r of e){if(r>>>16!==this.location.id)continue;let o=r>>>12&15,a=r>>>8&15,l=r>>>4&15,c=r&15,d=240*o+16*l,f=256*a+16*c;i!=null&&(this.useLayer(3),this.rect(d-1,f-1,18,18,0)),this.useLayer(1),e.has($.add(r,-1,0))||this.rect(d-1,f-1,2,18,s),e.has($.add(r,0,-1))||this.rect(d-1,f-1,18,2,s),e.has($.add(r,1,0))||this.rect(d+15,f-1,2,18,s),e.has($.add(r,0,1))||this.rect(d-1,f+15,18,2,s)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let s=0;s<this.location.width;s++){let i=this.location.screens[e][s];this.drawScreen(this.rom.screens[i],e,s)}this.useLayer(2);for(let e of this.location.spawns){let s=0,{x:i,y:r}=e;r-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;i+=8,r+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(s+=64),o!=null&&this.metasprite(r,i,o,this.location.id,s)}this.render()}drawScreen(e,s,i){let r=s*240,o=i*256,a=this.rom.tilesets[this.location.tileset],l,c=!1;for(let d of this.location.flags)if(d.xs===i&&d.ys===s){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(c=!0);break}for(let d=0;d<240;d+=16)for(let f=0;f<16;f++){let h=e.tiles[d|f];h<32&&(this.flags.has(l)||c)&&(h=a.alternates[h]),this.metatile(r+d,o+f*16,h,this.location.id,0)}}}});function qn(n,t){if(n.size<t.size)return!1;for(let e of t)if(!n.has(e))return!1;return!0}var P,Ms,Be,mi=G(()=>{de();(d=>{function n(...f){return[[].concat(...f.map(([h])=>h))]}d.and=n;function t(...f){let h=[];for(let u of f){if(u===d.OPEN)return d.OPEN;u!==d.CLOSED&&h.push(...s(u))}return h.length?h:d.CLOSED}d.or=t;function e(f,h){if(f===d.OPEN)return s(h);if(h===d.OPEN)return s(f);if(f===d.CLOSED||h===d.CLOSED)return d.CLOSED;let u=new c;for(let m of f)for(let p of h)u.addList([...m,...p]);return s(u)}d.meet=e;function s(f){return f instanceof c?[...oe.map(f,h=>[...h])]:f}d.freeze=s;function i(f){return f instanceof c?f.label():f.map(h=>h.join("&")).join("|")}d.label=i;function r(f){let h=f[Symbol.iterator](),{value:u,done:m}=h.next();if(m||!h.next().done)return!1;let p=u[Symbol.iterator]();return Boolean(p.next().done)}d.isOpen=r;function o(f){let h=f[Symbol.iterator]();return Boolean(h.next().done)}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class c{constructor(h){this.self=h;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(h,u){for(let m of u)if(Array.isArray(m))throw new Error;if(u.has(this.self)||this.map.has(h))return!1;for(let[m,p]of this.map){if(qn(u,p))return!1;qn(p,u)&&this.map.delete(m)}return this.map.set(h,u),!0}addRoute(h){return this.addInternal(h[Ms],h.deps)}addAll(h){for(let u of h)this.addList(u)}addList(h){let u=[...new Set(h)].sort(),m=new Set(u);this.addInternal(u.join("&"),m)}restrict(h){let u=[...this.map.values()];this.map.clear();for(let m of u)for(let p of h)this.addList([...m,...p])}label(){return[this.map.keys()].join("|")}}d.Builder=c})(P||(P={}));Ms=Symbol("depsLabel"),Be=class{constructor(t,e){this.target=t;let s=[...new Set(e)].sort();this.deps=new Set(s),this[Ms]=s.join("&"),this.label=`${this.target}:${this[Ms]}`}};Ms});function ea(n,t){let e=P.OPEN,s,i=4;return t&q.DOLPHIN&&t&q.FLY?(t&q.SLOPE&&(s=n.flags.ClimbWaterfall.r),e=[[n.flags.CurrentlyRidingDolphin.c],[n.flags.Flight.c]]):(t&q.SLOPE9?s=n.flags.ClimbSlope9.r:t&q.SLOPE8?s=n.flags.ClimbSlope8.r:t&q.SLOPE&&(s=n.flags.ClimbSlope10.r),t&q.FLY&&(e=n.flags.Flight.r)),t&q.SWAMP&&(e=e.map(r=>[n.flags.TravelSwamp.c,...r])),t&q.PAIN&&(e=e.map(r=>[n.flags.CrossPain.c,...r])),t&q.BARRIER&&(e=e.map(r=>[n.flags.ShootingStatue.c,...r]),s=n.flags.ShootingStatueSouth.r,i=1),new Ts(e,s,i)}function Hn(n){let t=[];for(let e=0;e<n.exit.length;e++)for(let s=0;s<4;s++)n.exit[e][0]&1<<s&&(t[s]=e);for(let e=0;e<4;e++)if(t[e]==null)throw new Error(`Bad terrain: ${n.exit.map(s=>s[0]).join(",")}`);return t}function Ie(n,t){let e=[...n],s=e.map(i=>oe.isEmpty(i)?"open":[...i].map(r=>t.flags[r]?.debug).join(" & ")).join(") | (");return e.length>1?`(${s})`:e.length?s:"never"}var Rs,q,pi,ht,Ts,xi,gi,bi,wi,ta,yi,Si=G(()=>{de();mi();Rs=class{constructor(t){this.rom=t;this.tiles=new W(t=>ea(this.rom,t));this.bosses=new W(t=>new xi(t));this.statues=new Map;this.flags=new W(t=>new W(e=>new W(s=>new wi(t,e,s))));this.meets=new W(t=>new W(e=>new yi(t,e)));this._seamless=new W(t=>new pi(t))}tile(t){return t&4?void 0:this.tiles.get(t)}boss(t,e){return e?this.rage||(this.rage=new bi(t,this.rom.flags.RageSkip.id)):this.bosses.get(t)}statue(t){let e=P.label(t),s=this.statues.get(e);return s||this.statues.set(e,s=new gi(t)),s}flag(t,e,s){return t||(t=ta),this.flags.get(t).get(e).get(s)}meet(t,e){return this.meets.get(t).get(e)}seamless(t){return this._seamless.get(t)}label(t,e){return t.label?t.label(e):"Terrain"}};(f=>{f.FLY=2,f.BLOCKED=4,f.SLOPE=32,f.PAIN=128,f.BITS=166,f.SWAMP=256,f.BARRIER=512,f.SLOPE8=1024,f.SLOPE9=2048,f.DOLPHIN=4096;function d(h,u){return h.label?.(u)??"Terrain"}f.label=d})(q||(q={}));pi=class{constructor(t){this._delegate=t;this.enter=t.enter,this.exit=t.exit}label(t){return`Seamless(${q.label(this._delegate,t)})`}},ht=class{constructor(t,e=P.OPEN){this.enter=t;this.exit=[[15,e]]}get kind(){return"Simple"}label(t){let e=[];return P.isOpen(this.enter)||e.push(`enter = ${Ie(this.enter,t)}`),P.isOpen(this.exit[0][1])||e.push(`exit = ${Ie(this.exit[0][1],t)}`),`${this.kind}(${e.join(", ")})`}},Ts=class{constructor(t,e,s=4){this.enter=t;this.exit=e?[[15&~s,e],[s,P.OPEN]]:[[15,P.OPEN]]}get kind(){return"South"}label(t){if(this.exit.length===1)return ht.prototype.label.call(this,t);let e=[];return P.isOpen(this.enter)||e.push(`enter = ${Ie(this.enter,t)}`),P.isOpen(this.exit[0][1])||e.push(`other = ${Ie(this.exit[0][1],t)}`),P.isOpen(this.exit[1][1])||e.push(`south = ${Ie(this.exit[1][1],t)}`),`${this.kind}(${e.join(", ")})`}};xi=class extends ht{constructor(e){super(P.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},gi=class extends Ts{constructor(e){super(P.OPEN,e);this._req=e}get kind(){return"Statue"}},bi=class{constructor(t,e){this._rageFlag=t;this._rageSkipFlag=e;this.enter=P.OPEN;this.exit=[[11,[[t],[e]]],[4,P.OPEN]]}label(){return"Rage"}},wi=class extends ht{constructor(t,e,s){if(t.exit.length!==1||s.exit.length!==1)throw console.error(t,s),new Error("bad flag");let i=[[e]],r=e>=0?P.meet(s.enter,i):s.enter,o=e>=0?P.meet(s.exit[0][1],i):s.exit[0][1];super(P.or(t.enter,r),P.or(t.exit[0][1],o))}get kind(){return"Flag"}},ta=new ht(P.CLOSED,P.CLOSED);yi=class{constructor(t,e){this.left=t;this.right=e;let s=Hn(t),i=Hn(e),r=new Set,o=[];for(let a=0;a<4;a++)r.add(s[a]<<2|i[a]);for(let a of r){let[l,c]=t.exit[a>>2],[d,f]=e.exit[a&3];o.push([l&d,P.meet(c,f)])}this.enter=P.meet(t.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(t){if(this.exit.length===1)return ht.prototype.label.call(this,t);let e=[];P.isOpen(this.enter)||e.push(`enter = ${Ie(this.enter,t)}`);for(let[s,i]of this.exit){let r=[s&1?"N":"",s&2?"W":"",s&4?"S":"",s&8?"E":""].join("");e.push(`exit${r} = ${Ie(i,t)}`)}return`${this.kind}(${e.join(", ")})`}};q.debugLabel=Ie;typeof window=="object"&&(window.debugLabel=Ie)});var Es,Un=G(()=>{$n();Si();le();Es=class{constructor(t,e){this.rom=t;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",s=>this.click(s)),this.element.addEventListener("mousemove",s=>this.move(s)),this.renderArea(0)}click(t){let e=it.getData(t);if(!e)return;let s=this.world.tiles.get(e.tile);if(s!=null){if(s.area===this.area){let i=s.exit!=null?this.world.tiles.get(s.exit):null;i&&i.area!==this.area&&(s=i)}s.area&&s.area!==this.area&&this.renderArea(s.area.id)}}move(t){let e=it.getData(t);if(!e)return;let s=this.world.tiles.get(e.tile);if(s==null)return;let i=s.exit!=null&&!this.area.tiles.has(s.exit);e.target.element.style.cursor=i?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(t){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let i of this.rom.locations){if(!i.used)continue;let r=this.world.locations[i.id]?.areas[Symbol.iterator]().next().value;if(r==null)continue;let o=document.createElement("option");o.textContent=`${j(i.id)} ${i.name}`,o.value=String(r.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[t];let s=document.createElement("pre");s.textContent=`Area ${t}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${q.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([i,r])=>`${i.debug}: ${Ie(r,this.rom)}`))].join(`
  `)}
Routes:
  ${Ie(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(s);for(let i of this.area.locations){let r=this.rom.locations[i],o=document.createElement("h2");o.textContent=r.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,r))}}makeLocation(t,e){let s=new it(this.rom,e.id);s.maxWidth=574,s.overlayShade(1426063360);for(let i of this.world.locations[e.id].areas)i!==t&&s.overlayArea(i.tiles,4294901760);return s.overlayArea(t.tiles,4278255615,0),s.render(),s.element}}});var Ut,Kn=G(()=>{(o=>{function n(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=n;function t(){return[0,1,2,3]}o.all=t,o.North=0,o.West=1,o.South=2,o.East=3})(Ut||(Ut={}))});var Ee,jn=G(()=>{Is();(i=>{function n(r,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let c of[-16,0]){let d=a+c;for(let f of[-16,0]){let h=l+f;yield $.from(r,{x:d,y:h})}}}}}i.trigger=n;function t(r,...o){let a=new Set,l=[...r];for(let[c,d]of o)for(let f of l)a.add($.add(f,c,d));return a}i.adjust=t;function e(r){let o=[];for(let a=0;a<240;a++)o.push(r&-256|a);return o}i.screen=e;function s(r,...o){let a=new Set,l=[...r];for(let c of o)for(let d of l)a.add(d&65535|c.id<<16);return a}i.atLocation=s})(Ee||(Ee={}))});function ut(n){return n}var Vn=G(()=>{(e=>{e.from=(s,i)=>typeof s=="number"||!i?Number(s)>>>8:s.id<<8|i.y>>>8<<4|i.x>>>8;function t(s){return s>>>8}e.fromTile=t})(ut||(ut={}))});function ge(n){return n}var Xn=G(()=>{(e=>{function n(s,i){return s*(1<<24)+i}e.of=n;function t(s){return[Math.floor(s/(1<<24)),s%(1<<24)]}e.split=t})(ge||(ge={}))});var Yn=G(()=>{});function mt(...n){return[n.map(t=>t.id)]}function Le(...n){return n.map(t=>[t.id])}var Fs,Zn,Qn=G(()=>{Un();Zt();Ks();le();wt();de();Kn();jn();mi();Vn();Si();Is();Xn();Yn();js();[]=[j],Fs=class{constructor(t,e,s=!1){this.rom=t;this.flagset=e;this.tracker=s;this.terrainFactory=new Rs(this.rom);this.terrains=new Map;this.checks=new W(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new W(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new Ce;this.neighbors=new W(()=>0);this.routes=new W(()=>new P.Builder);this.routeEdges=new W(()=>new Dt);this.requirementMap=new W(t=>new P.Builder(t));this.limeTreeEntranceLocation=-1;this.chestRequirement=P.OPEN;if(e.alwaysMimics()){let r=[t.flags.SwordOfWind,t.flags.SwordOfFire,t.flags.SwordOfWater,t.flags.SwordOfThunder].filter((o,a)=>t.objects.mimic.elements&1<<a);this.chestRequirement=Le(...r)}for(let i of t.items)for(let r of i.itemUseData)r.kind==="expect"?this.itemUses.get(r.want).push([i,r]):r.kind==="location"&&this.itemUses.get(~r.want).push([i,r]);this.aliases=new Map([[t.flags.ChangeAkahana,t.flags.Change],[t.flags.ChangeSoldier,t.flags.Change],[t.flags.ChangeStom,t.flags.Change],[t.flags.ChangeWoman,t.flags.Change],[t.flags.ParalyzedKensuInDanceHall,t.flags.Paralysis],[t.flags.ParalyzedKensuInTavern,t.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let i of t.locations)this.processLocation(i);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:t,MezameShrine:e,Oak:s,Shyron_ToolShop:i},flags:{AbleToRideDolphin:r,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:c,Barrier:d,BlizzardBracelet:f,BowOfMoon:h,BowOfSun:u,BreakStone:m,BreakIce:p,BreakIron:x,BrokenStatue:w,BuyHealing:g,BuyWarp:k,ClimbWaterfall:b,ClimbSlope8:v,ClimbSlope9:C,ClimbSlope10:F,CrossPain:y,CurrentlyRidingDolphin:A,Flight:R,FlameBracelet:L,FormBridge:X,GasMask:te,GlowingLamp:re,InjuredDolphin:N,LeadingChild:z,LeatherBoots:M,Money:fe,OpenedCrypt:De,RabbitBoots:O,Refresh:ae,RepairedStatue:me,RescuedChild:nt,ShellFlute:rt,ShieldRing:je,ShootingStatue:ie,ShootingStatueSouth:Ve,StomSkip:Ds,StormBracelet:_s,Sword:Kt,SwordOfFire:Tt,SwordOfThunder:Et,SwordOfWater:Xe,SwordOfWind:B,TornadoBracelet:Ns,TravelSwamp:_e,TriggerSkip:xt,UsedBowOfMoon:Y,UsedBowOfSun:Se,WildWarp:gt},items:{MedicalHerb:jt,WarpBoots:oo}}=this.rom,ee=this.entrance(e),ao=this.entrance(s);this.addCheck([ee],mt(h,u),[De.id]),this.addCheck([ee],h.r,[Y.id]),this.addCheck([ee],u.r,[Se.id]),this.addCheck([ee],mt(r,rt),[A.id]),this.addCheck([ao],mt(z),[nt.id]),this.addItemCheck([ee],mt(re,w),me.id,{lossy:!0,unique:!0});for(let be of this.rom.shops){if(be.location===t.id||be.location===i.id||!be.used||be.type!==1)continue;let Bt=[be.location<<16|136];for(let Lt of be.contents)Lt===jt.id?this.addCheck(Bt,fe.r,[g.id]):Lt===oo.id&&this.addCheck(Bt,fe.r,[k.id])}let Ft=B.r,Gt=Tt.r,At=Xe.r,Pt=Et.r;if(!this.flagset.orbsOptional()){let be=Le(c,Ns),Bt=Le(o,L),Lt=Le(l,f),co=Le(a,_s);if(Ft=P.meet(Ft,be),Gt=P.meet(Gt,Bt),At=P.meet(At,Lt),Pt=P.meet(Pt,co),this.flagset.assumeSwordChargeGlitch()){let Vt=function(Ni){return fo.map(Ws=>Ws[0]===Ni.c?Ws:[Ni.c,...Ws])},fo=P.or(Ft,Gt,At,Pt);Ft=Vt(B),Gt=Vt(Tt),At=Vt(Xe),Pt=Vt(Et)}}this.addCheck([ee],Ft,[m.id]),this.addCheck([ee],Gt,[p.id]),this.addCheck([ee],At,[X.id]),this.addCheck([ee],Pt,[x.id]),this.addCheck([ee],Le(B,Tt,Xe,Et),[Kt.id]),this.addCheck([ee],R.r,[b.id,F.id]),this.addCheck([ee],Le(R,O),[v.id]),this.addCheck([ee],Le(R,O),[C.id]),this.addCheck([ee],d.r,[ie.id,Ve.id]),this.addCheck([ee],te.r,[_e.id]);let lo=this.flagset.changeGasMaskToHazmatSuit()?te:M;if(this.addCheck([ee],Le(R,O,lo),[y.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([ee],M.r,[v.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([ee],mt(A,O),[b.id]),this.flagset.fogLampNotRequired()){let be=this.flagset.requireHealedDolphinToRide();this.addCheck([ee],be?N.r:[[]],[r.id])}if(this.flagset.guaranteeBarrier()||this.addCheck([ee],[[fe.c,g.c],[fe.c,je.c],[fe.c,ae.c]],[ie.id,Ve.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([ee],[[fe.c,R.c]],[ie.id]),this.flagset.guaranteeGasMask()||this.addCheck([ee],[[fe.c,g.c],[fe.c,ae.c]],[_e.id,y.id]),this.flagset.assumeWildWarp()&&this.addCheck([ee],P.OPEN,[gt.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([ee],P.OPEN,[xt.id]),this.addCheck([ee],xt.r,[y.id,v.id,C.id])),this.flagset.chargeShotsOnly())for(let be of this.rom.townWarp.locations)(this.rom.locations[be].entrances[0].y&255)<88&&this.addCheck([this.entrance(be)],k.r,[Ds.id])}addExtraRoutes(){let{flags:{BuyWarp:t,SwordOfThunder:e,Teleport:s,WildWarp:i},locations:{MezameShrine:r}}=this.rom;if(this.addRoute(new Be(this.entrance(r),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new Be(this.entrance(o[0],o[1]&31),[e.c,t.c])),this.addRoute(new Be(this.entrance(o[0],o[1]&31),[e.c,s.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Fe("bad entrance");for(let c of l.enter)this.addRoute(new Be(a,[i.c,...c]))}}consolidateChecks(){for(let[t,e]of this.checks){let s=this.tiles.find(t);if(t!==s){for(let i of e)this.checks.get(s).add(i);this.checks.delete(t)}}}buildRequirementMap(){for(let[e,s]of this.checks)for(let{checks:i,requirement:r}of s)for(let o of i){let a=this.requirementMap.get(o);for(let l of r)for(let c of this.routes.get(e)||[])a.addList([...l,...c])}if(!Zn)return;let t=[];for(let[e,s]of this.requirementMap){let i=r=>this.rom.flags[r].name;for(let r of s)t.push(`${i(e)}: ${[...r].map(i).join(" & ")}
`)}t.sort((e,s)=>e<s?-1:e>s?1:0),console.log(t.join(""))}getLocationList(t="Crystalis"){let e=Zn?s=>s.debug:s=>s.name;return{worldName:t,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:s=>e(this.rom.flags[s]),prefill:s=>{let{Crystalis:i,MesiaInTower:r,LeafElder:o}=this.rom.flags,a=new Map([[r.id,i.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|s.nextInt(4)),a}}}processLocation(t){!t.used||(this.processLocationTiles(t),this.processLocationSpawns(t),this.processLocationItemUses(t))}unionNeighbors(){for(let[t,e]of this.terrains){let s=$.add(t,0,1);this.terrains.get(s)===e&&this.tiles.union([t,s]);let i=$.add(t,1,0);this.terrains.get(i)===e&&this.tiles.union([t,i])}}addAllRoutes(){this.addExtraRoutes();for(let[t,e]of this.neighbors){let[s,i]=ge.split(t),r=this.terrains.get(s),o=this.terrains.get(i);if(!r||!o)throw new Error(`missing terrain ${j(r?s:i)}`);for(let[a,l]of r.exit)if(!!(a&e))for(let c of l)for(let d of o.enter)this.addRoute(new Be(i,[...c,...d]),s)}if(typeof document=="object"){let t=document.getElementById("debug");t&&t.appendChild(new Es(this.rom,this.getWorldData()).element)}}getWorldData(){let t=0,e=new W(()=>({})),s=ne(256,()=>({areas:new Set,tiles:new Set})),i=[];for(let r of this.tiles.sets()){let o=this.tiles.find(oe.first(r)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?P.freeze(this.routes.get(o)):[];if(!l.length)continue;let c={checks:[],id:t++,locations:new Set,routes:l,terrain:a,tiles:new Set};i.push(c);for(let d of r){let f=d>>>16;c.locations.add(f),c.tiles.add(d),s[f].areas.add(c),s[f].tiles.add(d),e.get(d).area=c}}for(let[r,o]of this.exits)e.has(r)&&(e.get(r).exit=o);for(let[r,o]of this.checks){let a=e.get(r).area;if(!!a)for(let{checks:l,requirement:c}of o)for(let d of l){let f=this.rom.flags[d]||Fe();a.checks.push([f,c])}}return{tiles:e,areas:i,locations:s}}addRoute(t,e){if(e!=null){this.routeEdges.get(e).add(t);for(let a of this.routes.get(e))this.addRoute(new Be(t.target,[...a,...t.deps]));return}let s=new Dt,i=new Dt,r=t;s.add(r);let o=s[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;i.add(a),s.delete(a);let c=new Dt,d=a.target;if(this.routes.get(d).addRoute(a))for(let h of this.routeEdges.get(d))c.add(new Be(h.target,[...a.deps,...h.deps]));for(let h of c)i.has(h)||(s.delete(h),s.add(h))}}recordExits(){for(let[t,e]of this.exits)this.exitSet.add(ge.of(this.tiles.find(t),this.tiles.find(e)));for(let t of this.exitSet){let[e,s]=ge.split(t);if(this.terrains.get(e)!==this.terrains.get(s))continue;let i=ge.of(s,e);this.exitSet.has(i)&&(this.tiles.union([e,s]),this.exitSet.delete(t),this.exitSet.delete(i))}}buildNeighbors(){for(let[t,e]of this.terrains){if(!e)continue;let s=$.add(t,1,0),i=this.terrains.get(s);i&&i!==e&&this.handleAdjacentNeighbors(t,s,Ut.North);let r=$.add(t,0,1),o=this.terrains.get(r);o&&o!==e&&this.handleAdjacentNeighbors(t,r,Ut.West)}for(let t of this.exitSet){let[e,s]=ge.split(t);if(!this.terrains.has(e)||!this.terrains.has(s))continue;let i=ge.of(this.tiles.find(e),this.tiles.find(s));this.neighbors.set(i,this.neighbors.get(i)|1)}}handleAdjacentNeighbors(t,e,s){let i=this.tiles.find(t),r=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=ge.of(r,i);this.neighbors.set(o,this.neighbors.get(o)|1<<s)}if(!this.seamlessExits.has(t)){let o=s^2,a=ge.of(i,r);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(t){let e=new Map,s=new Set,i=(t.id&248)===88;for(let c of t.spawns)if(c.isWall())e.set(ut.from(t,c),c.id&3);else if(c.isMonster()&&c.id===63){let d=ut.from(t,c)<<8|c.yt<<4;for(let f=4;f<=11;f++)for(let h=-3;h<=3;h++)s.add($.add(d,h,f))}let r=this.rom.tilesets[t.tileset],o=this.rom.tileEffects[t.tileEffects-179],a=c=>{let d=t.screens[(c&61440)>>>12][(c&3840)>>>8];return o.effects[this.rom.screens[d].tiles[c&255]]},l=(c,d,f)=>{if(c&=q.BITS,t.id===26&&(c|=q.SWAMP),(t.id===96||t.id===104)&&(c|=q.DOLPHIN),t.id===100&&(d&61680)<4144&&(c|=q.DOLPHIN),f&&(c|=q.BARRIER),!(c&q.DOLPHIN)&&c&q.SLOPE){let h=d,u=0;for(;a(h)&q.SLOPE;)h=$.add(h,1,0),u++;u<6?c&=~q.SLOPE:u<9?c|=q.SLOPE8:u<10&&(c|=q.SLOPE9)}if(c&q.PAIN){for(let h of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a($.add(d,...h))&(q.PAIN|q.FLY))){c&=~q.PAIN;break}}return this.terrainFactory.tile(c)};for(let c=0,d=t.height;c<d;c++){let f=t.screens[c],h=t.id<<8|c<<4;for(let u=0,m=t.width;u<m;u++){let p=this.rom.screens[f[u]],x=h|u,w=x&255,g=e.get(x),k=i?this.rom.flags.AlwaysTrue.id:g!=null?this.wallCapability(g):t.flags.find(C=>C.screen===w)?.flag,b=t.pits.find(C=>C.fromScreen===x);b&&this.exits.set(x<<8|136,b.toScreen<<8|136);let v=this.rom.flags[k]?.logic??{};for(let C=0;C<240;C++){let F=x<<8|C,y=p.tiles[C];v.assumeTrue&&y<32&&(y=r.alternates[y]);let A=t.isShop()?0:o.effects[y],R=s.has(F),L=l(A,F,R);if(y<32&&r.alternates[y]!==y&&k!=null&&!v.assumeTrue&&!v.assumeFalse){let X=l(o.effects[r.alternates[y]],F,R);X&&(L=this.terrainFactory.flag(L,v.track?k:-1,X))}L&&this.terrains.set(F,L)}}}for(let c of t.exits){let{dest:d,entrance:f}=c,h=$.from(t,c),u;if(c.isSeamless()){u=h&65535|d<<16;let m=$.from(t,c);this.seamlessExits.add(m);let p=this.terrains.get(m);p&&this.terrains.set(m,this.terrainFactory.seamless(p))}else u=this.entrance(this.rom.locations[d],f&31);this.exits.set(h,u),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[f].y>160&&(this.limeTreeEntranceLocation=t.id)}}processLocationSpawns(t){for(let e of t.spawns)e.isTrigger()?this.processTrigger(t,e):e.isNpc()?this.processNpc(t,e):e.isBoss()?this.processBoss(t,e):e.isChest()?this.processChest(t,e):e.isMonster()?this.processMonster(t,e):e.type===3&&e.id===224&&this.processKeyUse(Ee.screen($.from(t,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(t,e){let s=this.rom.trigger(e.id);if(!s)throw new Error(`Missing trigger ${e.id.toString(16)}`);let i=this.filterRequirements(s.conditions),r=this.filterAntiRequirements(s.conditions),o=$.from(t,e),a=Ee.trigger(t,e),l=[];for(let c of s.flags){let d=this.flag(c);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,i,l),s.message.action){case 25:s.id===134&&!this.flagset.assumeRabbitSkip()?a=Ee.adjust(a,[0,-1],[0,1]):s.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=Ee.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(r=P.or(r,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(r));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,i);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,i,s.id);break;case 24:{let c=this.flagset.chargeShotsOnly()?P.meet(i,this.rom.flags.StomSkip.r):i;this.addItemCheck(a,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,i,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,t,i);break;case 27:t===this.rom.locations.Portoa_PalaceEntrance&&(a=Ee.adjust(a,[-2,0]),r=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,t,r);break}for(let[c,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([$.from(t,e)],P.OPEN,c,d)}processNpc(t,e){let s=this.rom.npcs[e.id];if(!s||!s.used)throw new Error(`Unknown npc: ${j(e.id)}`);let i=s.spawnConditions.get(t.id)||[],r=this.filterRequirements(i),o=$.from(t,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,f]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,r,d,f);if(s===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,r),s.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(i),s===this.rom.npcs.Rage?(a=Ee.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=Ee.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):s===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=P.or(this.rom.flags.MesiaRecording.r,mt(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):s===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(s===this.rom.npcs.FortuneTeller&&(a=Ee.adjust(a,[0,0],[2,0])),P.isClosed(r))return;let[[...l]]=r;for(let d of s.globalDialogs){let f=this.flag(~d.condition),h=this.flag(d.condition);if(f?.logic.assumeFalse||h?.logic.assumeTrue)return;f?.logic.track&&l.push(f.id)}let c=s.localDialogs.get(t.id)??s.localDialogs.get(-1)??[];for(let d of c){let f=[...l],h=this.flag(d.condition),u=this.flag(~d.condition);if(h?.logic.track&&f.push(h.id),!h?.logic.assumeFalse&&!u?.logic.assumeTrue&&this.processDialog(a,s,f,d),h?.logic.assumeTrue||u?.logic.assumeFalse)break;u?.logic.track&&l.push(u.id)}}processDialog(t,e,s,i){this.addCheckFromFlags(t,[s],i.flags);let r={lossy:!0,unique:!0};switch(i.message.action){case 8:this.processKeyUse(t,[s]);break;case 20:this.addItemCheck(t,[s],this.rom.flags.SlimedKensu.id,r);break;case 16:this.addItemCheck(t,[s],this.rom.flags.AsinaInBackRoom.id,r);break;case 17:this.addItemCheck(t,[s],256|e.data[1],r);break;case 3:this.addItemCheck(t,[s],256|e.data[0],r);break;case 10:let o=this.flagset.alwaysMimics()?[[...s,this.rom.flags.Sword.c]]:[s];this.addItemCheck(t,o,256|e.data[0],r);break;case 9:let a=e.data[1];a!==255&&this.addItemCheck(t,[s],256|a,r);break;case 25:this.addItemCheck(t,[s],this.rom.flags.AkahanaFluteOfLimeTradein.id,r);break;case 26:this.addItemCheck(t,[s],this.rom.flags.Rage.id,r);break;case 27:break}}processLocationItemUses(t){for(let[e,s]of this.itemUses.get(~t.id))this.processItemUse([this.entrance(t)],P.OPEN,e,s)}handleMovingGuard(t,e,s){if(this.flagset.assumeStatueGlitch())return;let i=[];for(let r of e.spawns.slice(0,2))if(r.isNpc()&&this.rom.npcs[r.id].isParalyzable()){i.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&i.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(t,this.terrainFactory.statue([...s,...i].map(Xt)))}handleBoat(t,e,s){let i=this.walkableNeighbor(t);if(i==null)throw new Error("Could not find walkable neighbor.");let r=t>>8&240|t>>4&15,o=t>>4&240|t&15,a;for(let h of e.exits)h.yt===r&&h.xt<o&&(a=h);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let c=l.entrances[a.entrance],d=$.from(l,c),f=d;for(;;){f=$.add(f,0,-1);let h=this.walkableNeighbor(f);if(h!=null){let u={enter:P.freeze(s),exit:[[15,P.OPEN]]};this.addTerrain([i],u),this.exits.set(i,h),this.exitSet.add(ge.of(i,h)),this.exits.set(d,h),this.exitSet.add(ge.of(d,h)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(t,e,s){let i=this.itemGrant(s),r=256|i;if(i==null)throw new Error(`missing item grant for ${s.toString(16)}`);let o=s>=128;this.addItemCheck(t,e,r,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(t,e){for(let s of t){let i=this.terrains.get(s);i!=null&&this.terrains.set(s,this.terrainFactory.meet(i,e))}}addCheck(t,e,s){if(P.isClosed(e))return;let i={requirement:P.freeze(e),checks:s};for(let r of t)!this.terrains.has(r)||this.checks.get(r).add(i)}addItemCheck(t,e,s,i){this.addCheck(t,e,[s]),this.slots.set(s,i);let r=this.rom.itemGets[this.rom.slots[s&255]],o=this.rom.items[r.itemId],a=o?.unique,l=r.isLosable(),c=a||o===this.rom.items.OpelStatue;this.items.set(512|r.id,{unique:a,losable:l,preventLoss:c})}addCheckFromFlags(t,e,s){let i=[];for(let r of s){let o=this.flag(r);o?.logic.track&&i.push(o.id)}i.length&&this.addCheck(t,e,i)}walkableNeighbor(t){if(this.isWalkable(t))return t;for(let e of[-1,1]){let s=$.add(t,e,0),i=$.add(t,0,e);if(this.isWalkable(s))return s;if(this.isWalkable(i))return i}}isWalkable(t){return!(this.getEffects(t)&q.BITS)}ensurePassable(t){return this.isWalkable(t)?t:this.walkableNeighbor(t)??t}getEffects(t){let e=this.rom.locations[t>>>16],s=this.rom.tileEffects[e.tileEffects-179].effects,i=e.screens[(t&61440)>>>12][(t&3840)>>>8];return s[this.rom.screens[i].tiles[t&255]]}processBoss(t,e){let{bosses:s}=this.rom,{Rage:i,StatueOfSun:r,StatueOfMoon:o}=s,a=e.id===201,l=e.id===202,c=e.id===195,d=c?i:a?o:l?r:s.fromLocation(t.id),f=$.from(t,e);if(!d||!d.flag)throw new Error(`Bad boss at ${t.name}`);let h=f&-256,u=this.terrainFactory.boss(d.flag.id,c),m=ne(240,p=>h|p);this.addTerrain(m,u),!a&&!l&&this.addBossCheck(m,d)}addBossCheck(t,e,s=P.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let i=P.meet(s,this.bossRequirements(e));e===this.rom.bosses.Draygon2?this.addCheck(t,i,[e.flag.id]):this.addItemCheck(t,i,e.flag.id,{lossy:!1,unique:!0})}processChest(t,e){if(this.rom.slots[e.id]>=112)return;let s=256|e.id,i=this.rom.slots[e.id];if(i>=112)return;let r=this.rom.items[i],o=this.flagset.preserveUniqueChecks()?!!r?.unique:!0;this.addItemCheck([$.from(t,e)],this.chestRequirement,s,{lossy:!1,unique:o})}processMonster(t,e){let s=this.rom.objects[e.monsterId];if(!(s instanceof Ye))return;let{Money:i,RageSkip:r,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:c,SwordOfThunder:d}=this.rom.flags;if(t.id===this.limeTreeEntranceLocation&&s.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(t)],P.OPEN,[r.id]),!s.goldDrop)return;let f=[$.from(t,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(f,o.r,[i.id]);return}let h=[a,l,c,d].filter((u,m)=>s.elements&1<<m);this.addCheck(f,Le(...h),[i.id])}processItemUse(t,e,s,i){t=new Set([...t].map(a=>this.walkableNeighbor(a)??a));let r=[[512|s.id]];s.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&r[0].push(this.rom.flags.Change.c),s===this.rom.items.MedicalHerb&&(r[0][0]=this.rom.flags.BuyHealing.c);let o=P.meet(e,r);switch(this.addCheckFromFlags(t,o,i.flags),i.message.action){case 16:this.processKeyUse(t,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(t,o,s.id);break;case 2:this.addItemCheck(t,o,256|this.rom.npcs[i.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(t,e){let[s,...i]=new Set([...t].map(a=>ut.from(a)));if(s==null||i.length)throw new Error("Expected one screen");let o=this.rom.locations[s>>>8].flags.find(a=>a.screen===(s&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(t,e,[o.flag])}bossRequirements(t){if(t===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=t.object,s=new P.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())s.addAll(this.rom.flags.Sword.r);else{let r=this.flagset.guaranteeSwordMagic()?t.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&s.addAll(this.swordRequirement(a,r))}let i=[];if(t.npc!=null&&t.location!=null){let r=t.npc.spawns(this.rom.locations[t.location]);i.push(...this.filterRequirements(r)[0])}return t===this.rom.bosses.Insect?i.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):t===this.rom.bosses.Draygon2&&i.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&i.push(this.rom.flags.Refresh.c),s.restrict([i]),P.freeze(s)}swordRequirement(t,e){let s=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][t];if(e===1)return s.r;let i=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][t];return e===3?mt(s,...i):i.map(r=>[s.c,r.c])}itemGrant(t){for(let[e,s]of this.rom.itemGets.actionGrants)if(e===t)return s;throw new Error(`Could not find item grant ${t.toString(16)}`)}filterRequirements(t){let e=[];for(let s of t)if(s<0){if(this.flag(~s)?.logic?.assumeTrue)return P.CLOSED}else{let i=this.flag(s);if(i?.logic.assumeFalse)return P.CLOSED;i?.logic.track&&e.push(i.id)}return[e]}filterAntiRequirements(t){let e=[];for(let s of t)if(s>=0){if(this.flag(~s)?.logic?.assumeFalse)return P.OPEN}else{let i=this.flag(~s);if(i?.logic.assumeTrue)return P.OPEN;i?.logic.track&&e.push([i.id])}return e}flag(t){let e=t,s=this.rom.flags[e];return this.aliases.get(s)??s}entrance(t,e=0){return typeof t=="number"&&(t=this.rom.locations[t]),this.tiles.find($.from(t,t.entrances[e]))}wallCapability(t){switch(t){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${t}`)}}};Zn=!1});function er(n){if(!n.compressedMapData){n.compressedMapData=!0;for(let t=0;t<3;t++)n.metascreens.renumber(256|t,320|t),delete n.screens[256|t]}}function tr(n){if(!n.compressedMapData)throw new Error("Must compress first");let{grass:t,town:e,cave:s,dolphinCave:i,pyramid:r,river:o,sea:a,lime:l,mountain:c,shrine:d,desert:f,mountainRiver:h,swamp:u,house:m,fortress:p,labyrinth:x,iceCave:w,tower:g}=n.metatilesets;n.moveScreens([u],4),n.moveScreens([m],4),n.moveScreens([e],4),n.moveScreens([l],4),n.moveScreens([d],4),n.moveScreens([g],4),n.moveScreens([c,h],4),n.moveScreens([s,r,p,x,w],5);let[]=[a,i,t,o,f]}var sr=G(()=>{yt();[]=[Qt]});function ir(n,t){let o=n.objects[159],a=n.objects[127],l=n.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((f,h)=>l.data[h]=f),l.data[3]=a.data[3];let c=new Set([127-80,141-80]),d=new Set([126-80,159-80]);for(let f of n.locations){if(!f.pits.length)continue;let h=t.nextInt(3)<1;for(let u of f.spawns)!u.isMonster()||(d.has(u.id)&&(u.id=(h?159:126)-80),c.has(u.id)&&(u.id=(h?141:127)-80))}}var nr=G(()=>{});function ye(n,t,...e){let s=t,i=0,r;for(;(r=e[i++])!=null;)if(typeof r=="number")n[s++]=r;else if(typeof r=="string")for(let o of r)n[s++]=o.charCodeAt(0);else throw new Error("bad data")}function rr(n){n[107924]=255,n[118213]=168,n[106870]=255,n[108620]=255,n[120899]=160,n[122987]&=7,n[122991]&=7,n[122995]&=7,n[122999]&=7,n[123003]&=7,n[123012]&=7,n[123035]&=7,n[123065]&=7,n[123141]=47,n[123511]=0,n[123750]=64,n[123761]=0,n[123783]=0,n[123793]=0,ye(n,106856,51,51),ye(n,107662,51,51),n[105393]=112,n[105397]=113,n[105079]=114,n[105963]=115,n[106565]=116,n[106721]=117,n[106725]=118,n[106729]=119,n[108037]=120,n[107457]=121,n[107461]=122,n[107465]=123,ye(n,123063,192,0),ye(n,123690,192,0),ye(n,123696,192,0),ye(n,123702,192,0),ye(n,123104,192,0),ye(n,123110,192,0),n[116739]=0,ye(n,116749,162,179),n[109190]=254,ye(n,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);let t=230492,e=167,s=154,i=35043+196608,r=Yt(n,t+(e<<1))+196608,o=n.slice(r,r+10);ye(n,t+(s<<1),i&255,i>>8&255),o[4]|=3,o[8]|=3,ye(n,i,...o);let a=112259,l=112653;n[a+2]=s,n[l+2]=s,n[a+18]=s,n[a+19]=s,n[l+18]=s,n[l+19]=s,n[217335]=s,ye(n,157038,"Simea",16,0,"     ",16,0)}function or(n,t){Fa(n),aa(n),ra(n),oa(n),la(n,t),za(n),$a(n),Wa(n),ca(n),fa(n),pa(n),da(n),va(n),xa(n),La(n,t),Pa(n),t.requireHealedDolphinToRide()&&wa(n),t.saharaRabbitsRequireTelepathy()&&ya(n),ka(n,t),ga(n,t),ba(n),t.teleportOnThunderSword()?(Sa(n),n.townWarp.thunderSwordWarp=[n.locations.Shyron.id,65]):Ca(n),ua(n),t.fogLampNotRequired()&&ma(n,t),Ga(n),Aa(n),Ia(n),Ma(n,t),t.disableRabbitSkip()&&Ra(n),t.disableFlightStatueSkip()&&Ta(n),Ba(n,t),ha(n),t.chargeShotsOnly()&&Da(n),t.orbsOptional()&&_a(n),t.noBowMode()&&Na(n),Ea(n),t.hardcoreMode()&&qa(n),t.shouldUpdateHud()&&(na(n),n.writeMonsterNames=!0),t.shouldColorSwordElements()&&ia(n),t.hasStatTracking()&&sa(n),Ha(n),Oa(n)}function sa(n){for(let b=0;b<4;b++)n.patterns.set(5376,41+b,Me.BLANK_TILES[b]);if(n.prg[143082]===40)return;n.prg[143082]=40;let s=143364,i=144132,r=128-1;for(let b=s;b<i;b++)n.prg[b]>=41&&n.prg[b]<=45&&(n.prg[b]+=r);let o=42,a=160;for(let b=s;b<i;b+=192)n.prg[b+a]=o;let l=new Map([[66,a]]),c=142469,d=142546;for(let b=c;b<d;b++)l.has(n.prg[b])&&(n.prg[b]=l.get(n.prg[b]));for(let b=s;b<i;b+=192)for(let v=123;v<=127;v++)n.prg[b+v]==o+r&&(n.prg[b+v]=o);let f=3,h=2,u=144376,m=144440;for(let b=u;b<m;b++){let v=n.prg[b];for(let C=0;C<8;C+=2){let F=f<<C,y=h<<C;(v&F)==F&&(v=v&(255^3<<C)|y)}n.prg[b]=v}let p=144440,x=4*f,w=[15,48,15,17];for(let b=0;b<w.length;b++)n.prg[p+x+b]=w[b];n.prg[p+h*4+3]=8;let g=145114,k=145222;for(let b=g;b<k;b+=4)n.prg[b]+=128}function ia(n){function t(e,s){for(let i=0;i<=10;i++){if(i===8)continue;let r=n.patterns.get(i|e),o=[...r.pixels];for(let a=0;a<r.pixels.length;a++)r.pixels[a]=o[a^8],a>>>3===s&&(r.pixels[a]|=o[a])}}t(4240),t(4304),t(4368),t(4432),t(4496)}function na(n){n.patterns.set(3584,0,Me.HUD_LF),n.patterns.set(3584,1,Me.HUD_PW),n.patterns.set(3584,2,Me.HUD_EY),n.patterns.set(3584,3,Me.HUD_LV),n.patterns.set(3584,4,Me.HUD_DL),n.patterns.set(3584,5,Me.HUD_MP),n.patterns.set(3584,6,Me.HUD_EX),n.patterns.set(3584,26,Me.HUD_CLOSE_LEFT),n.patterns.set(3584,27,Me.HUD_CLOSE_RIGHT)}function ra(n){n.items.GlowingLamp.itemUseData[0].message.action=11}function oa(n){let t=n.nextFreeTrigger("mezame");t.used=!0,t.conditions=[~n.flags.AlwaysTrue.id],t.message=Wt.of({action:4}),t.flags=[n.flags.AlwaysTrue.id],n.locations.MezameShrine.spawns.push(H.of({tile:136,type:2,id:t.id}))}function aa(n){let t=new Set([129,139,144,153,166,167,168,169,170,171,172,n.allocatedTriggers.get("zombie warp")]);for(let e of n.locations)!e.used||(e.spawns=e.spawns.filter(s=>!s.isTrigger()||!t.has(s.id)))}function la(n,t){if(n.objects[16].atk=3,n.objects[17].atk=6,n.objects[18].atk=8,n.objects[24].atk=3,n.objects[19].atk=5,n.objects[25].atk=5,n.objects[23].atk=7,n.objects[26].atk=7,n.objects[20].atk=3,n.objects[21].atk=6,n.objects[22].atk=8,n.objects[28].atk=3,n.objects[29].atk=3,n.objects[30].atk=5,n.objects[27].atk=7,n.objects[31].atk=7,t.slowDownTornado()){let e=n.objects[18];e.speed=7,e.data[12]=96}}function da(n){let t=n.trigger(160);t.used=!0,t.conditions=[],t.flags=[],t.message=Wt.of({part:0,index:0,action:21}),n.objects[94].data[13]=254,n.items.InsectFlute.itemUseData[0].flags=[n.flags.UsedInsectFlute.id]}function ca(n){n.items.OpelStatue.selectedItemValue=0}function fa(n){for(let t of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])n.patterns.set(t<<6,e,n.patterns.get(94<<6,e).pixels);n.objects[12].metasprite=169}function ha(n){for(let t in[4,5,8,9])n.tileEffects[188-179].effects[t]=24,n.tileEffects[181-179].effects[t]=24}function ua(n){let{tiles:t}=n.screens[161];t[40]=159,t[55]=35,t[56]=35,t[57]=33,t[71]=141,t[72]=143,t[86]=153,t[87]=154,t[88]=140}function ma(n,t){let{flags:{AlwaysTrue:e,InjuredDolphin:s,FogLamp:i,KensuInCabin:r,ReturnedFogLamp:o},items:{ShellFlute:a},locations:{BoatHouse:l,Portoa_FishermanHouse:c},npcs:d}=n,f=t.requireHealedDolphinToRide();a.itemUseData[0].want=f?s.id:e.id,d.KensuInCabin.data[0]=103,d.KensuInCabin.localDialogs.get(-1)[0].message.action=10,d.KensuInCabin.localDialogs.get(-1)[0].flags=[],d.KensuInCabin.spawnConditions.set(l.id,[o.id,~r.id]),d.Fisherman.spawnConditions.set(c.id,[i.id]),n.itemGets[100].flags=[],n.itemGets[103].copyFrom(n.itemGets[100])}function pa(n){for(let t of n.locations)for(let e of t.spawns)e.isChest()&&(e.timed=!1)}function xa(n){let t=n.locations;t.GoaFortress_Kelbesque.spawns[0].x-=16,t.GoaFortress_Zebu.spawns.splice(1,1),t.GoaFortress_Tornel.spawns.splice(2,1),t.GoaFortress_Asina.spawns.splice(2,1),t.GoaFortress_Kensu.spawns.splice(3,1),t.GoaFortress_Kensu.spawns.splice(1,1)}function ga(n,t){let{items:{AlarmFlute:e},flags:{TalkedToZebuStudent:s,ZebuStudent:i},locations:{MezameShrine:r,Leaf_StudentHouse:o,WaterfallCave4:a,ZebuCave:l},npcs:{WindmillGuard:c,Zebu:d}}=n;if(n.itemGets[49].inventoryRowStart=32,e.unique=!0,e.basePrice=0,t.zebuStudentGivesItem())c.data[1]=49;else{c.data[1]=255;let u=c.dialog(o)[0];u.condition=~s.id,u.flags.push(s.id),Ci(d.spawns(l),i.id,s.id),r.spawns.push(H.of({screen:0,tile:155,type:2,id:49})),r.spawns.push(H.of({screen:0,tile:149,type:2,id:73})),i.unsafeRename("Mezame Right Chest"),n.flags[329].unsafeRename("Mezame Left Chest"),n.itemGets[73].itemId=n.items.MedicalHerb.id}let f=[[33,.72],[31,.9]],h=0;for(let u of n.shops)if(u.type===1)for(let m=0,p=u.contents.length;m<p;m++){if(u.contents[m]!==49)continue;let[x,w]=f[h++%f.length];u.contents[m]=x,n.shopDataTablesAddress&&(u.prices[m]=Math.round(u.prices[m]*w))}n.itemGets[91].itemId=29,a.spawn(25).id=16}function ba(n){let{flags:{Karmine:t,Mado1:e},npcs:{Brokahana:s}}=n,i=Wi(s.localDialogs.get(-1))[0];if(i.condition!==~t.id)throw new Error(`Bad brokahana condition: ${i.condition}`);i.condition=~e.id}function wa(n){let{flags:{InjuredDolphin:t,ShellFlute:e},npcs:{Fisherman:s,FishermanDaughter:i}}=n;s.spawnConditions.set(214,[e.id,t.id]);let r=i.localDialogs.get(-1);r.unshift(r[0].clone()),r[0].condition=~t.id,r[1].condition=~e.id}function ya(n){let{flags:{Telepathy:t},npcs:{Deo:e,SaharaBunny:s}}=n;s.globalDialogs.push(Vs.of(~t.id,[26,18])),e.globalDialogs.push(Vs.of(~t.id,[26,19]))}function Sa(n){let{flags:{WarpShyron:t}}=n;n.itemGets[3].flags.push(t.id)}function Ca(n){n.itemGets[3].acquisitionAction.action=22}function ka(n,t){if(t.leatherBootsGiveSpeed()){let e=n.items[47];if(e.menuName="Speed Boots",e.messageName="Speed Boots",t.changeGasMaskToHazmatSuit()){let s=n.items[41];s.menuName="Hazmat Suit",s.messageName="Hazmat Suit"}}for(let e=5;e<12;e+=2)n.items[e].menuName=n.items[e].menuName.replace("Ball","Orb"),n.items[e].messageName=n.items[e].messageName.replace("Ball","Orb")}function va(n){let{flags:{BallOfWind:t,TornadoBracelet:e},npcs:{Tornel:s}}=n,i=s.localDialogs.get(33),r=[i[0],i[2],i[2].clone(),i[1]];r[1].condition=~e.id,r[2].condition=~t.id,r[3].condition=-1,s.localDialogs.set(33,r)}function Ia(n){let{CordelPlainEast:t,KirisaMeadow:e,UndergroundChannel:s}=n.locations;for(let i of[t,e,s])for(let r of i.spawns)r.isChest()&&(r.data[2]|=32)}function Ma(n,t){let{CordelPlainEast:e,CordelPlainWest:s}=n.locations;for(let i of e.spawns)(i.isChest()||t.disableTeleportSkip()&&i.isTrigger())&&s.spawns.push(i.clone())}function Ra(n){for(let t of n.locations.MtSabreNorth_Main.spawns)t.isTrigger()&&t.id===134&&t.x===1856&&(t.x+=16,t.y+=16)}function Ta(n){let t=n.hitboxes[n.objects.guardianStatueMissile.hitbox],e=n.hitboxes[6];n.objects.guardianStatueMissile.hitbox=e.id,e.x0=t.x0-6,e.w=t.w+12,e.y0=t.y0-2,e.h=t.h+4}function Ea(n){n.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function Fa(n){let{flags:{WarpZombie:t},locations:{ZombieTown:e}}=n;n.flags.insertZombieWarpFlag();let s=n.messages.parts[33][0];s.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let i=n.nextFreeTrigger("zombie warp");i.used=!0,i.conditions=[],i.message=Wt.of({}),i.flags=[t.id];for(let r of e.spawns)r.isTrigger()&&r.id===138&&(r.id=i.id);if(n.townWarp.locations.splice(7,0,e.id),n.townWarp.locations.pop()!==255)throw new Error("unexpected")}function Ga(n){let{flags:{CurrentlyRidingDolphin:t},locations:{AngrySea:e,EvilSpiritIsland1:s}}=n;n.trigger(138).conditions=[~t.id],n.messages.parts[29][16].text=`This cave ceiling is too
low to fly in.`,ar(e.spawns,i=>i.isTrigger()&&i.id===138),s.spawns.push(H.of({x:88,y:160,type:2,id:138}))}function Aa(n){let t=n.nextFreeTrigger("channel item");t.used=!0,t.conditions=[n.flags.CurrentlyRidingDolphin.id,~n.flags.UndergroundChannelUnderwaterChest.id];let e=n.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",t.message=Wt.of({part:e.part,index:e.id,action:15});let s=n.locations.UndergroundChannel.spawns.find(i=>i.isChest());s.data[2]=2,s.yt++,s.id=t.id,n.itemGets.actionGrants.set(t.id,59)}function Pa(n){let e=n.npcs[13].localDialogs.get(53)[0];e.message.action=23}function Ba(n,t){let e=n.locations.LimeTreeLake,s=n.screens[n.metascreens.limeTreeLake.sid];if(t.disableRageSkip()){s.set2d(32,s.get2d(0,143)),s.set2d(42,s.get2d(58,1)),s.set2d(16,s.get2d(32,4)),s.set2d(26,s.get2d(42,5)),s.set2d(27,s.get2d(0,16));for(let r of e.spawns)r.tile+=32;let i=n.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(r=>r+32)}else s.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function La(n,t){let{locations:{BoatHouse:e,Brynmaer:s,Crypt_Draygon2:i,Joel_Shed:r,Leaf_ElderHouse:o,MtSabreNorth_SummitCave:a,MtSabreWest_Upper:l,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:d,Portoa_AsinaRoom:f,Portoa_FortuneTeller:h,Shyron_Temple:u,StomHouse:m,Swan_DanceHall:p,Swan_Tavern:x,WindmillCave:w,WaterfallCave4:g,WaterfallValleyNorth:k,ZebuCave:b,ZombieTown_HouseBasement:v},items:{GlowingLamp:C,KeyToPrison:F,LovePendant:y,StatueOfOnyx:A},npcs:{Akahana:R,AkahanaInBrynmaer:L,Asina:X,AztecaInShyron:te,Clark:re,Draygon:N,FortuneTeller:z,Kensu:M,KensuInCabin:fe,KensuInSwan:De,LeafElder:O,LeafRabbit:ae,OakChild:me,OakElder:nt,OakMother:rt,PortoaPalaceFrontGuard:je,PortoaQueen:ie,PortoaThroneRoomBackDoorGuard:Ve,Rage:Ds,Stom:_s,StonedAkahana:Kt,Tornel:Tt,WindmillGuard:Et,Zebu:Xe},flags:B}=n;M.localDialogs.delete(x.id),De.link(M.id),De.used=!0,De.data=[...M.data],M.data[0]=C.id,p.spawns.find(Y=>Y.isNpc()&&Y.id===M.id).id=De.id,y.itemUseData[0].want=256|De.id,Kt.linkDialog(R.id),L.used=!0,L.link(R.id),L.data=[...R.data],s.spawns.find(Y=>Y.isNpc()&&Y.id===R.id).id=L.id,A.itemUseData[0].want=256|L.id,O.dialog(o).splice(0,0,...O.dialog(o).splice(2,1)),ae.dialog()[2].condition=B.RescuedLeafElder.id,ae.dialog()[2].flags.push(B.TalkedToLeafRabbit.id),ae.dialog()[3].flags.push(B.TalkedToLeafRabbit.id),Et.spawns(w)[1]=~B.WindmillGuardAlarmFluteTradein.id,Mt(R.spawns(g),~B.BehindWhirlpool.id),Mt(Kt.spawns(g),~B.BehindWhirlpool.id);function Ns(Y){Y.reverse();for(let Se=0;Se<Y.length;Se++){let gt=Y[Se+1];Y[Se].condition=gt?~gt.condition:-1}}for(let Y=0;Y<4;Y++){let Se=nt.dialog()[Y];Se.condition!==n.flags.OakElder.id&&(Se.message.action=3)}(()=>{let[Y,Se,gt,jt]=rt.dialog();jt.condition=~B.RescuedChild.id,Se.condition=-1,rt.dialog().splice(0,4,jt,gt,Y,Se)})();for(let Y of[32,33,34,124,125])Ns(n.npcs[Y].dialog());me.dialog().unshift(...me.dialog().splice(1,1)),Ve.spawnConditions.set(c.id,[~B.QueenNotInThroneRoom.id,~B.MesiaRecording.id]),je.dialog()[1].condition=B.MesiaRecording.id,ie.dialog()[3].condition=B.SwordOfWater.id,ie.dialog()[3].message.action=3,ie.dialog()[4].flags.push(B.PortoaQueenGoingAway.id),ie.spawns(c)[1]=~B.MesiaRecording.id,ie.spawns(f)[0]=B.MesiaRecording.id,ie.dialog()[1].condition=B.MesiaRecording.id,z.spawns(h)[1]=~B.MesiaRecording.id,re.spawnConditions.set(v.id,[~B.Clark.id]),re.spawnConditions.set(r.id,[B.Clark.id]),Xe.localDialogs.set(b.id,[Ne.of(~B.TalkedToZebuInCave.id,[0,26],[B.TalkedToZebuInCave.id]),Ne.of(B.LeafVillagersRescued.id,[0,29]),Ne.of(B.LeafAbduction.id,[0,28]),Ne.of(B.ZebuAtWindmill.id,[0,29]),Ne.of(B.UsedWindmillKey.id,[0,27,3]),Ne.of(-1,[0,29])]),Mt(Xe.spawns(b),~B.BehindWhirlpool.id),Tt.spawnConditions.delete(l.id),_s.spawnConditions.delete(m.id),Mt(X.spawns(f),~B.CalmedAngrySea.id);let _e=n.npcs[52];_e.spawnConditions.set(c.id,[B.MesiaRecording.id,~B.PortoaQueen.id]),_e.localDialogs.set(d.id,_e.localDialogs.get(-1)),_e.data[0]=n.items.FluteOfLime.id;let xt=n.messages.alloc();xt.text="The queen left this for you.",_e.localDialogs.set(c.id,[Ne.of(~B.PortoaQueen.id,[xt.part,xt.id,3]),Ne.of(-1,[10,14])]),c.spawns.push(H.of({yt:3,xt:12,type:1,patternBank:1,id:_e.id})),ie.localDialogs.set(f.id,ie.dialog().splice(0,2)),ie.localDialogs.set(c.id,ie.dialog()),ie.localDialogs.delete(-1),fe.spawnConditions.set(e.id,[~B.AbleToRideDolphin.id,B.ReturnedFogLamp.id]),fe.dialog()[0].message.action=2,te.spawns(u).push(~B.ShyronMassacre.id),n.trigger(130).conditions.push(~B.ShyronMassacre.id),n.bossKills.kensuLighthouse.data2[0]=0,Ds.dialog()[0].condition=B.SwordOfWater.id,N.spawnConditions.set(i.id,[~B.Draygon2.id]),Xe.dialog(u).unshift(...Xe.dialog(u).splice(1,1)),n.trigger(128).conditions=[~B.ShyronMassacre.id,B.TalkedToZebuInShyron.id,B.SwordOfThunder.id],n.trigger(129).conditions=[],t.barrierRequiresCalmSea()&&n.trigger(132).conditions.push(B.CalmedAngrySea.id),n.trigger(140).conditions.push(B.TalkedToZebuInCave.id),n.trigger(141).used=!1;for(let Y of a.spawns)Y.isTrigger()&&Y.id===141&&(Y.id=178);ar(k.spawns,Y=>Y.isTrigger()&&Y.id===141),n.trigger(178).conditions.push(B.Kelbesque1.id),n.trigger(178).flags.push(~B.LeafVillagersCurrentlyAbducted.id,~B.LeafElderCurrentlyAbducted.id,B.LeafVillagersRescued.id),n.trigger(140).conditions.push(~B.Kelbesque1.id),n.trigger(134).conditions.push(~B.Kelbesque1.id),Mt(F.itemUseData[0].flags,~B.LeafVillagersCurrentlyAbducted.id),Mt(F.itemUseData[0].flags,B.LeafVillagersRescued.id),Ci(n.trigger(187).conditions,~B.Rage.id,~B.MesiaRecording.id)}function Da(n){for(let t of[8,9,39])n.objects[t].collisionPlane=0}function _a(n){for(let t of[16,20,24,29])n.objects[t].terrainSusceptibility&=-5,n.objects[t].level=2}function Na(n){let{flags:{UsedBowOfTruth:t},locations:{Crypt_Draygon2:e,MezameShrine:s}}=n,i;for(let r of s.spawns)r.isTrigger()&&r.tile===136&&(i=n.trigger(r.id));if(!i)throw new Error("Could not find start trigger");i.flags.push(t.id),n.tileEffects[185-179].effects[88]=0,s.meta.setExit(0,"door",[e.meta.id<<8|16,"edge:bottom"])}function Wa(n){n.objects[51].elements=15}function Oa(n){if(!n.patterns.get(5312,21).pixels.every(d=>d===0))return;let e=66<<6,s=new Map([[28,21],[29,22],[30,23],[31,24],[58,25],[59,26],[60,27],[61,28],[62,29],[63,30]]);s.forEach((d,f)=>{n.patterns.set(5312,d,n.patterns.get(e,f).pixels)});let i=108<<6;[[3,28],[4,29],[5,30],[6,31],[51,58],[52,59],[53,60],[54,61],[55,62]].forEach(d=>{let f=n.patterns.get(i,d[0]).pixels;for(let h=0;h<5;++h)n.patterns.set(e+(h<<6),d[1],f)});let o=128,a=170;n.metasprites[a].sprites.forEach(d=>{d.forEach(f=>{f[0]!=o&&(f[3]=f[3]-131+64+28)})});let l=144;for(let d=0;d<n.metasprites[l].sprites.length;d++)for(let f=0;f<n.metasprites[l].sprites[d].length;f++){let h=n.metasprites[l].sprites[d][f];h[0]!=o&&(n.metasprites[l].sprites[d][f][3]=h[3]-179+58)}let c=203;n.metasprites[c].sprites.forEach(d=>{for(let f=0;f<d.length;f++){let h=d[f];if(h[0]!=o){let u=s.get(h[3]&63);h[3]=64+u}}})}function za(n){n.tileEffects[181-179].effects[116]=6,n.tileEffects[182-179].effects[70]=6}function $a(n){for(let t of n.objects)t instanceof Ye&&(t.isProjectile()||t.isBoss()||t.isFlyer()||t!==n.objects.mimic&&(t.terrainSusceptibility|=3))}function Ci(n,t,e){for(let s=0;s<n.length;s++)if(n[s]===t){n[s]=e;return}throw new Error(`Could not find ${t} in ${n.join(",")}`)}function qa(n){for(let t of n.locations)t.checkpoint=t.saveable=!1}function Ha(n){Ci(n.wildWarp.locations,100,105)}function Mt(n,t){let e=n.indexOf(t);if(e<0)throw new Error(`Could not find element ${t} in ${n}`);n.splice(e,1)}function ar(n,t){let e=n.findIndex(t);if(e<0)throw new Error(`Could not find element in ${n}`);n.splice(e,1)}var lr=G(()=>{yt();wo();yo();Ks();le();de();js();So();le();[]=[j]});function dr(n,t,e,s){if(!t.randomizeTrades())return;let{items:{StatueOfOnyx:i,FogLamp:r,LovePendant:o,KirisaPlant:a,IvoryStatue:l},locations:{Swan_DanceHall:c,PortoaPalace_ThroneRoom:d},npcs:{KensuInSwan:f}}=n,h=new Map,u=[[i,0,"Akahana"],[r,0,"Fisherman"],[o,0,"Kensu"],[a,0,"Aryllis"],[l,0,"Slimed Kensu"]],m=u.map(([w,g,k])=>{if(w.trades.indexOf(g)<0||g>=w.itemUseData.length)throw new Error(`not a trade: ${w} ${g}`);return[w.itemUseData[g],w.id,k]});if(s){let w=new Array;for(let[g]of u){let k=s.tradeInMap.get(g.messageName),b=m.findIndex(([v,C,F])=>F==k);w.push(m[b])}w.reverse(),m=w}else e.shuffle(m);for(let[w,g]of u){let[k,b,v]=m.pop();w.itemUseData[g]=k,n.spoiler&&n.spoiler.addTrade(w.id,w.messageName,v),k.want===356&&t.fogLampNotRequired()&&([...n.npcs[100].spawnConditions.values()][0][0]=512|w.id),h.set(b,w.id)}n.itemGets.actionGrants=new Map([...n.itemGets.actionGrants].map(([w,g])=>[h.get(w)??w,g]));let p;s?p=n.items[s.rageId]:p=n.items[e.nextInt(4)],n.npcs[195].localDialogs.get(-1)[0].condition=512|p.id,n.spoiler&&n.spoiler.addTrade(p.id,p.messageName,"Rage"),n.npcs.PortoaQueen.dialog(d)[1].condition=512|p.id;let x;s?x=n.items[s.tornelId]:x=n.items[e.nextInt(4)*2+6];for(let w of n.npcs[95].localDialogs.values())for(let g=2;g<w.length;g++)if(w[g].message.action===3){w[g-2].condition=~(512|x.id-1),w[g-1].condition=~(512|x.id),n.spoiler&&n.spoiler.addTrade(x.id,x.messageName,"Tornel");break}f.dialog(c)[0].message.mid="13:00"}function cr(n){let t=new Map;for(let e of n.items)for(let s of e.trades)t.set(e.itemUseData[s].want&255,e.id);return t}var ki=G(()=>{});function hr(n,t){let{flags:{AkahanaStatueOfOnyxTradein:e,AsinaInBackRoom:s,BehindWhirlpool:i,KensuInSwan:r,MtSabreNorthSummit:o,MtSabreWestTornel:a,PortoaQueen:l,Rage:c,RepairedStatue:d,SlimedKensu:f,StomFightReward:h,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:m},npcs:{AkahanaInBrynmaer:p,Aryllis:x,Fisherman:w,PortoaQueen:g},locations:{PortoaPalace_ThroneRoom:k}}=n;M("03:06",",","");let b=cr(n);function v(O){let ae=b.get(O.id);if(!ae)throw new Error(`No trade-in for ${O.name}`);return n.items[ae]}if(t?.fromArchipelago){N("00:1b"),M("00:1b","[41:Refresh]","APItem"),M("02:02","[29:Gas Mask]","APItem"),N("03:01"),M("03:01","[43:Telepathy]","APItem"),M("05:0a","[44:Teleport]","APItem"),M("0a:0c","[28:Flute of Lime]","APItem"),N("0b:01"),M("0b:01","[45:Recover]","APItem"),N("0b:01"),N("1d:12"),M("0b:01","[46:Barrier]","APItem"),M("1d:12","[46:Barrier]","APItem"),t.lime_hint==""?M("0d:00","that a [35:Fog Lamp] was","there was treasure"):M("0d:00","[35:Fog Lamp]",t.lime_hint.substring(0,18)),M("0e:03","[09:Ball of Water]","APItem"),N("13:02"),M("13:02","[47:Change]","APItem"),M("18:07","teach","give"),M("18:07","[48:Flight]","APItem"),N("1c:10"),M("1c:10","[42:Paralysis]","APItem"),M("20:06","Statue of Gold","APItem");let O=n.allocatedTriggers.get("channel item");O!=null&&M(n.trigger(O).message.mid,"[3b:Love Pendant]","APItem")}else{m.item.isMagic()||N("00:1b"),M("00:1b","[41:Refresh]",z(m.item)),M("02:02","[29:Gas Mask]",z(e)),h.item.isMagic()||N("03:01"),M("03:01","[43:Telepathy]",z(h)),M("05:0a","[44:Teleport]",z(a)),M("0a:0c","[28:Flute of Lime]",z(l)),s.item.isMagic()||N("0b:01"),M("0b:01","[45:Recover]",z(s)),i.item.isMagic()||(N("0b:01"),N("1d:12")),M("0b:01","[46:Barrier]",z(i)),M("1d:12","[46:Barrier]",z(i));let O=fe(79,78,77,76,71,70,69,68,75,74,73,72);O?M("0d:00","[35:Fog Lamp]",z(O)):M("0d:00","that a [35:Fog Lamp] was","there was treasure"),M("0e:03","[09:Ball of Water]",z(c)),r.item.isMagic()||N("13:02"),M("13:02","[47:Change]",z(r)),f.item.isMagic()||M("18:07","teach","give"),M("18:07","[48:Flight]",z(f)),o.item.isMagic()||N("1c:10"),M("1c:10","[42:Paralysis]",z(o)),M("20:06","Statue of Gold",z(d));let ae=n.allocatedTriggers.get("channel item");ae!=null&&M(n.trigger(ae).message.mid,"[3b:Love Pendant]",z(u))}let C=v(p);M("02:01","an unusual statue",fr(C)),M("02:02","a statue",`the ${Gs(C)}`);let F=ja(n);M("03:01","[06:Tornado Bracelet]",z(F)),M("05:0a","[06:Tornado Bracelet]",z(F));let y=v(w);M("09:01","[35:Fog Lamp]",z(y)),M("09:04","[35:Fog Lamp]",z(y)),M("09:05","[35:Fog Lamp]",z(y)),M("09:06","lamp",Gs(y));let A=g.dialog(k)[1].condition;M("0a:0d","[02:Sword of Water]",z(A));let R=n.npcs.Rage.dialog()[0].condition;M("0e:03","[02:Sword of Water]",z(R)),M("10:0c","that's","is"),M("10:0c",/, is in the\+lighthouse/,"");let L=v(x);M("12:05","[3c:Kirisa Plant]",z(L)),M("12:10","the plant",`the ${Gs(L)}`),M("12:10","[3c:Kirisa Plant]",z(L));let X=`Our illustrious chief seeks ${fr(L)}.`;M("12:09",/[^]*/,X),M("12:0a",/[^]*/,X);let te=v(n.npcs.KensuInSwan);M("13:02","[3b:Love Pendant]",z(te)),M("13:00","pendant",Gs(te));let re=v(n.npcs.SlimedKensu);M("18:06","[3d:Ivory Statue]",z(re)),M("18:07","[3d:Ivory Statue]",z(re)),M("18:06","It's in a room","{0b:Karmine} is");{let O=n.messages.alloc();n.trigger(134).message.mid=O.mid,O.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",n.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function N(O){M(O,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function z(O){return typeof O=="number"?O=n.items[n.itemGets[O&255].itemId]:O instanceof Qi||(O=O.item),`[${j(O.id)}:${O.messageName}]`}function M(O,ae,me){let[nt,rt]=O.split(":").map(ie=>parseInt(ie,16)),je=n.messages.parts[nt][rt];je.text=je.text.replace(ae,me)}function fe(...O){let ae=[me=>Ua.has(me),me=>Ka.has(me),me=>De(me).unique];for(let me of ae)for(let nt of O){let je=[...n.locations[nt].spawns].reverse();for(let ie of je){if(!ie.isChest())continue;let Ve=n.slots[ie.id];if(Ve<=72&&me(Ve))return n.items[Ve]}}}function De(O){let ae=n.itemGets[O];return n.items[ae.itemId]}}function ja(n){let{Tornel:t}=n.npcs;for(let e of t.localDialogs.values())for(let s=2;s<e.length;s++){let i=~e[s].condition;if(i>516&&i<=524&&!(i&1))return n.items[i&255]}return n.items.TornadoBracelet}function fr(n){let t=n.rom.items;switch(n){case t.StatueOfOnyx:return"an unusual statue";case t.FluteOfLime:return"a rare instrument";case t.FogLamp:return"a brilliant lamp";case t.LovePendant:return"a beautiful charm";case t.KirisaPlant:return"a fragrant plant";case t.IvoryStatue:return"an exotic statue"}return Us(),"a valuable item"}function Gs(n){let t=n.rom.items;switch(n){case t.StatueOfOnyx:return"statue";case t.FluteOfLime:return"instrument";case t.FogLamp:return"lamp";case t.LovePendant:return"pendant";case t.KirisaPlant:return"plant";case t.IvoryStatue:return"statue"}return Us(),"item"}var Ua,Ka,ur=G(()=>{Co();le();ki();Zt();Ua=new Set([62,63,64]),Ka=new Set([0,1,2,3,65,66,67,68,69,70,71,72])});function pr(n){let{locations:{Portoa:t,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:s,UndergroundChannel:i,WaterfallCave2:r,WaterfallCave3:o}}=n;vi(s,"edge:bottom",183,t),vi(e,"door",146,i),vi(r,"stair:up",191,o),Xa(n)}function vi(n,t,e,s){let[i,...r]=[...n.meta.exits()].filter(([,x])=>x===t);if(!i)throw new Error(`Could not find ${t} in ${n}`);if(r.length)throw new Error(`Ambiguous ${t} in ${n}`);let[o,a]=i[2],l=o>>>8;if(l===s.id)return;let c=o&255,d=n.rom.locations[l],h=d.meta.get(c).data.exits.find(x=>x.type===a);if(!h)throw new Error(`Bad entrance in ${d}`);let u=((h.entrance&61440)>>>8|(h.entrance&240)>>>4)+Va[h.dir];d.spawns.length>17&&d.spawns.pop();let m=s.spawns.findIndex(x=>x.isTrigger()&&x.id===e),p=m>=0?s.spawns.splice(m,1)[0]:H.of({type:2,id:e});p.xt=(c&15)<<4|u&15,p.yt=c&240|u>>>4,d.spawns.push(p)}function Xa(n){let{locations:{MtSabreNorth_Main:t,ValleyOfWind:e}}=n;for(let s of mr(e,17)){let i=n.locations[s>>>8],r=s&255;As(i,r,n.flags.OpenedSealedCave)}for(let s of mr(t,4)){let i=n.locations[s>>>8];if(i.data.fixed||i.spawns.length>15)continue;let r=s&255;As(i,r,n.flags.OpenedPrison);let o=i.meta.get(r).findExitByType("cave").entrance,a=H.of({screen:r,coord:o,type:2,id:173});if(i.spawns.push(a),i.spawns.length>15)continue;let l=H.of({screen:r,coord:o-4112,type:4,id:44});i.spawns.splice(1,0,l)}}function mr(n,t){let e=new Set([n,n.id<<8|t]),s=new Set;for(let r of n.meta.exits())r[0]===t&&(r[1]==="cave"||r[1]==="gate")&&s.add(r[2]);let i=[];for(let r of s){if(e.has(r[0]))continue;let o=n.rom.locations[r[0]>>>8],a=r[0]&255;if(!o.meta.customFlags.has(a)){if(r[1]==="cave"||r[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?i.push(r[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||s.add(l[2])}}}return i}function As(n,t,e,s){e?n.meta.customFlags.set(t,e):n.meta.customFlags.delete(t),!s&&(n===n.rom.locations.CordelPlainEast?As(n.rom.locations.CordelPlainWest,t,e,!0):n===n.rom.locations.CordelPlainWest&&As(n.rom.locations.CordelPlainEast,t,e,!0))}var Va,xr=G(()=>{yt();Va=[16,0,0,0]});function gr(n){Ya(n)}function Ya(n){let{locations:{AngrySea:t},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:s,beachCave:i,beachExitN:r,boatChannel:o}}=n;e.spawnScripts=[];let a=new Set(ne(16,l=>l));for(let l=0;l<t.entrances.length;l++){let c=t.entrances[l],d=t.meta.get(c.screen),f;if(d===o){if(t.meta.get(c.screen-1)!==s)throw new Error(`Bad boatChannel entrance ${c}`);c=ot.of({screen:c.screen-1,tile:0}),d=s}d===s?f={entrance:ot.of({screen:c.screen-17,coord:47336}),movement:5}:d===i?f={entrance:ot.of({screen:c.screen,coord:59400}),movement:8}:d===r&&(f={entrance:ot.of({screen:c.screen,coord:55544}),movement:9}),f&&(a.delete(l),e.spawnScripts[l]=f)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:ot.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:ot.of({x:424,y:120}),movement:7}}var br=G(()=>{yt();le()});function yr(n){let t=new Set;for(let e of n.locations)for(let s of e.pits??[])t.add(s.dest<<8|s.toScreen);for(let e of t){let s=n.locations[e>>8],i=e&255,r=s.exits.filter(d=>d.screen===i),o=s.entrances.filter(d=>d.screen===i),a=new Map(r.map(d=>[d.tile,d])),l=new Ce;for(let d of a.keys())for(let f of wr)a.has(d+f)&&l.union([d,d+f]);let c=l.map();for(let d of o)for(let f of wr){let h=c.get(d.tile+f);for(let u of h??[]){let m=a.get(u),p=Zi.of({screen:e&255,tile:u+f,dest:m.dest,entrance:m.entrance});s.exits.push(p)}}}}var wr,Sr=G(()=>{wt();yt();wr=[1,-1,16,-16]});function Cr(n,t,e){let s=0,i=-1,r=[...n.townWarp.locations].filter(c=>c!==255);e?.thunderWarp&&r.indexOf(e.thunderWarp)>=0?(s=e.thunderWarp,i=r.indexOf(e.thunderWarp)):(i=t.nextInt(r.length),s=r[i],console.log(`Using random Thunder Warp: ${s}`));let o=64;(s===n.locations.Shyron.id||s===n.locations.Shyron_Temple.id)&&(o=65),n.townWarp.thunderSwordWarp=[s,o];let a=768-r.length+i,l=n.itemGets[3].flags;for(let c=0;c<l.length;c++)if(l[c]===765){l[c]=a;return}l.push(a)}var kr=G(()=>{});function vr(n,t,e,s){let i=new Set(ne(256,a=>a).filter(a=>a in n.objects));for(let[a]of pt)i.delete(a);for(let[a,l]of pt)for(let c of i)n.objects[a].base===n.objects[c].base&&(pt.set(c,l),i.delete(a));for(let a of[200,249,250])n.objects[a].attackType=a>240?254:255,n.objects[a].statusEffect=0;n.objects[125].elements|=8;let r=new Set([87,94,104,125,136,139,144,147,151,155,158,165]),o=new Set([80,83,95,105]);for(let[a,{sdef:l,swrd:c,hits:d,satk:f,dgld:h,sexp:u}]of pt){let m=n.objects[a].data,p=r.has(a)?1:0;if(m[2]|=128,m[6]=d,m[7]=f,m[8]=l|c<<4,m[16]=m[16]&15|h<<4,m[17]=u,p?t.shuffleBossElements():t.shuffleMonsterElements()){if(p&&s?.bossWeaknesses.has(a))n.objects[a].elements=s.bossWeaknesses.get(a);else if(!o.has(a)){let x=[...n.objects[a].elements.toString(2).padStart(4,"0")];e.shuffle(x),n.objects[a].elements=Number.parseInt(x.join(""),2)}}}if(t.shuffleMonsterElements()){let a=e.nextInt(4);for(let l of o)n.objects[l].elements=1<<a}}var pt,Ii=G(()=>{le();pt=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([n,t,e,s=0,i=0,r=0,o=0,a=0,l=0])=>[n,{id:n,type:t,name:e,sdef:s,swrd:i,hits:r,satk:o,dgld:a,sexp:l}]))});function Za(n){let t=n[0];t.set2d(113,[[t.rom.metascreens.deadEndE_upStair],[t.rom.metascreens.caveEmpty]]),t.moveExits([129,"stair:down",113,"stair:up"]),n[1]=113,n[2]="stair:up"}function Ja(n,t){let e=n[0],s=e.rom.metascreens;e.set2d(32,[[s.caveEmpty,s.hallNS],[s.deadEndE_upStair,s.hallNW]]),e.replaceMonsters(t),e.moveExits([48,"stair:down",48,"stair:up"]),n[2]="stair:up"}function Qa(n){let t=n[0],e=t.rom.metascreens;t.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),t.moveExits([2,"stair:down",1,"stair:up"]),n[1]=1,n[2]="stair:up"}function Mi(n){let t=n[0],e=t.rom.metascreens;t.width<2&&(t.width=2),t.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),t.moveExits([0,"stair:up",1,"stair:down"]),n[1]=1,n[2]="stair:down"}function Ri(n,t){n[3](n,t),n[3]=void 0}function Ir(n,t,e){let s=n.locations,i=[0,1,2,3];e?.goa_floors?i=e.goa_floors.map(f=>f[0]):t.shuffle(i);let r=[[s.GoaFortress_Kelbesque.meta,131,"stair:down"],[s.GoaFortress_Sabera.meta,129,"stair:down",Za],[s.GoaFortress_Mado1.meta,114,"stair:down"],[s.GoaFortress_Karmine1.meta,48,"stair:down",Ja]],o=[[s.GoaFortress_Zebu.meta,0,"stair:up",Mi],[s.GoaFortress_Tornel.meta,0,"stair:up",Mi],[s.GoaFortress_Asina.meta,0,"stair:up",Mi],[s.GoaFortress_Kensu.meta,2,"stair:down",Qa]],a=[[s.GoaFortress_Entrance.meta,0,"edge:top"]],l=[],c=!0,d=a[0];for(let f of i){let u=c||r[f][3]||a[a.length-1][3]?t.pick([!1,!0]):!0;e?.goa_floors&&(u=e.goa_floors[a.length-1][1]);let m=u?o[f]:r[f];l.push(m),c!==(m[2]==="stair:down")&&(m[3]?Ri(m,t):Ri(d,t)),a.push(d=u?r[f]:o[f]),c=d[2]==="stair:up"}c&&Ri(d,t),l.push([s.GoaFortress_Exit.meta,1,"stair:up"]);for(let f=0;f<a.length;f++)a[f][0].attach(a[f][1],l[f][0],l[f][1],a[f][2],l[f][2])}var Mr=G(()=>{});function Tr(n,t,e){let{locations:{Crypt_Hall1:s,Goa:i,GoaFortress_Exit:r,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:c}}=n,d=new Set([i.id,o.id]),f=new Set([a.data.id,l.data.id,c.data.id]);if(t.shuffleAreas())for(let k of[i,r,o,s])k.data.houseType="palace";let h=new W(()=>[]),u=new W(()=>[]),m=new W(()=>new Set);for(let k of n.locations){if(!k.used||k.data.houseType==null)continue;let b;for(let[v,C,F]of k.meta.exits()){let y=(v&240)<<4|k.meta.get(v).findExitByType(C).entrance>>>8;(!b||y>b[3])&&(b=[v,C,F,y])}for(let[v,C,F]of[b]){let y={type:k.data.houseType,inside:[k.id<<8|v,C],outside:F},A=F[0];u.get(A).push(y),h.get(k.data.houseType).push(y);let R=n.locations[A>>>8].screens[A>>>4&15][A&15];m.get(R).add(A)}}let p=new Map,x=new Map;for(let[k,b]of e.ishuffle(m))b.size>=2||f.has(k)?x.set(k,b):p.set(k,b);let w=new Set,g=h.get("inn");for(let[,k]of[...x,...p]){let b=new Map,v=!0;for(let C of k){for(let F of u.get(C)){let y=v&&Rr.has(F.type)?[...Rr].map(M=>h.get(M)):[h.get(b.get(F.outside[1])??F.type)];y=y.filter(M=>M.length),F.type==="palace"&&d.has(F.outside[0]>>>8)&&(y=y.map(M=>M.filter(fe=>!d.has(fe.inside[0]>>>8))));let A=[...k].every(M=>!w.has(M>>>8));!A&&y.length>1?y=y.filter(M=>M!==g):A&&y.some(M=>M===g)&&(y=[g]);let R=e.pickAndRemove(...y);if(R.type==="inn")for(let M of k)w.add(M>>>8);if(b.set(F.outside[1],R.type),n.spoiler&&n.spoiler.addHouse(R.inside[0]>>>8,F.outside[0]>>>8),ke.connect(n,F.outside,R.inside),!v||Ti.get(F.type)===Ti.get(R.type))continue;let L=n.locations[F.outside[0]>>>8];if(L.meta.tileset!==n.metatilesets.town)continue;let X=ke.findExitTiles(n,F.outside);if(X.length>1)continue;let te=X[0]-32;(X[0]&240)<32&&(te-=3856);let re=te>>8,N=te&255,z=Ti.get(R.type)??(L.meta.get(re).data.tallHouses?.includes(N)?tl:el);n.screens[L.screens[re>>4][re&15]].tiles[N]=z}v=!1}}}var el,tl,Ti,sl,Rr,Er=G(()=>{Jt();de();el=6,tl=33,Ti=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),sl=new Set(["inn","armor","tool","pawn"]),Rr=new Set([...sl,"house","tavern"])});function Fr(n,t,e){let s=[],i=[];for(let r of n.locations)for(let o of r.spawns)if(o.isChest()){let a=n.slots[o.id];if(a>=112&&i.push(o.id),t.preserveUniqueChecks()){let l=n.itemGets[a];if(n.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;s.push(o.id)}e.shuffle(s),n.slots.setMimicCount(i.length),[...oe.zip(i,s,(r,o)=>n.slots.swap(r,o))]}var Gr=G(()=>{de()});function Ar(n,t){for(let e of n.locations)(e.id&248)!==88&&e.meta.replaceMonsters(t)}var Pr=G(()=>{});function*Ei(n,t){yield t;let e=t.spawnedReplacement();e&&(yield*Ei(n,e));let s=t.spawnedChild();s&&(yield*Ei(n,s)),t.id===80&&(yield n.objects.largeBlueSlime),t.id===83&&(yield n.objects.largeRedSlime)}var Ps,Br=G(()=>{de();Yi();Ps=class{constructor(t){this.rom=t;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new W(()=>[]);for(let s of t.locations)if(!!s.used)for(let i=0;i<s.spawns.length;i++){let r=s.spawns[i];!r.used||(r.isMonster()?e.get(r.monsterId).push([s,i,r]):(r.isNpc()||r.isBoss())&&e.get(~r.id).push([s,i,r]))}for(let[s,i]of e)if(s<0){let r=t.npcs[~s],o=[r.data[3]];if(!t.metasprites[o[0]])throw new Error(`bad NPC: ${~s}`);r.data[2]===208&&o.push(192);let l=r.data[2]<128?r.data[2]&112:0,c=this.computeConstraint(o,i,!0,l);~s===95&&(c=c.ignorePalette()),this.npcConstraints.set(~s,c)}else{let r=we.ALL,o=this.rom.objects[s];for(let a of Ei(t,o)){let c=t.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(c(a),i,a.id===s,a.data[1]),f=r.meet(d);if(!f)throw new Error(`Bad meet for ${s} with ${a.id}`);if(f&&(r=f),a.data[4]&2){let h=this.computeConstraint([a.data[20]],i,!1,a.data[1]),u=r.meet(h);if(!u)throw new Error(`Bad meet for ${s} bonus ${a.id}`);r=u}}this.monsterConstraints.set(o.id,r),o.constraint=r}}getMonsterConstraint(t,e){let s=this.monsterConstraints.get(e)||we.NONE;return(t&88)===88||!this.rom.objects[e].goldDrop?s:s.meet(we.COIN)||we.NONE}getNpcConstraint(t,e){let s=this.npcConstraints.get(e)||we.NONE;return t===30&&e===96?s.meet(we.STOM_FIGHT):t===160&&e===201?s.meet(we.GUARDIAN_STATUE):s}shufflePalettes(t){let e=[...this.allSpritePalettes];for(let[s,i]of this.monsterConstraints)this.monsterConstraints.set(s,i.shufflePalette(t,e));for(let[s,i]of this.npcConstraints)this.npcConstraints.set(s,i.shufflePalette(t,e))}configure(t,e){if(!e.used)return;let s=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):void 0;if(e.isChest()&&(e.patternBank=0),!!s){if(s.shift===3||s.float.length>=2)throw new Error("don't know what to do with two floats");if(!s.float.length)e.patternBank=Number(s.shift===2);else if(s.float[0].has(t.spritePatterns[0]))e.patternBank=0;else if(s.float[0].has(t.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(t,e,s,i=0){let r=new Set,o=new Set;for(let c of t.map(d=>this.rom.metasprites[d])){for(let d of c.palettes())o.add(d);for(let d of c.patternBanks(i))r.add(d)}s=s&&r.size==1&&[...r][0]===2;let a=new Map;for(let[c,,d]of e)a.set(d.patternBank&&s?~c.id:c.id,d);let l;for(let[c,d]of a){let f=this.rom.locations[c<0?~c:c];for(let u of o)u>1&&this.allSpritePalettes.add(f.spritePalettes[u-2]);let h=we.fromSpawn(o,r,f,d,s);l=l?l.join(h):h,!s&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}}});function Dr(n,t,e,s){let i=new Ps(n);t.shuffleSpritePalettes()&&i.shufflePalettes(e);let r={},o=new Gi(t,r);for(let a of n.locations)a.used&&o.populate(a);o.shuffle(e,i,s)}var Gi,Fi,il,Lr,_r=G(()=>{Yi();Br();js();Ii();Gi=class{constructor(t,e){this.flags=t;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(t){let{maxFlyers:e=0,nonFlyers:s={},skip:i=!1,tower:r=!1,fixedSlots:o={},...a}=Lr[t.id]||{};for(let h of Object.keys(a))throw new Error(`Unexpected property '${h}' in MONSTER_ADJUSTMENTS[${t.id}]`);let l=i===!0||!this.flags.shuffleTowerMonsters()&&r||!t.spritePatterns||!t.spritePalettes,c=[],d=[],f=12;for(let h of l?[]:t.spawns){if(++f,!h.used||!h.isMonster())continue;let u=h.monsterId;if(!pt.has(u)||pt.get(u).type!=="m")continue;let m=t.rom.objects[u];if(!(m instanceof Ye))continue;let p=h.patternBank,x=t.spritePatterns[p],w=m.palettes(!0),g=w.includes(2)?t.spritePalettes[0]:void 0,k=w.includes(3)?t.spritePalettes[1]:void 0;c.push({id:u,pat:x,pal2:g,pal3:k,patBank:p}),(this.report[`start-${u.toString(16)}`]=this.report[`start-${u.toString(16)}`]||[]).push("$"+t.id.toString(16)),d.push(f)}(!c.length||i)&&(d=[]),this.locations.push({location:t,slots:d}),this.monsters.push(...c)}shuffle(t,e,s){let i=e.rom;if(this.report["pre-shuffle locations"]=this.locations.map(r=>r.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(r=>r.id),t.shuffle(this.locations),t.shuffle(this.monsters),s)for(let r=0;r<this.locations.length;r++){let{location:o,slots:a}=this.locations[r];if(o&&o.id==66){this.locations.splice(r,1),this.locations.splice(0,0,{location:o,slots:a});break}}for(this.report["post-shuffle locations"]=this.locations.map(r=>r.location.id),this.report["post-shuffle monsters"]=this.monsters.map(r=>r.id);this.locations.length;){let{location:r,slots:o}=this.locations.pop(),a=this.report["$"+r.id.toString(16).padStart(2,"0")]=[],{maxFlyers:l=0,nonFlyers:c={},tower:d=!1}=Lr[r.id]||{};if(d)continue;let f=l,h=we.forLocation(r.id);r.bossId()!=null;for(let x of r.spawns)if(!(x.isChest()&&!x.isInvisible()))if(x.isNpc()||x.isBoss()){let w=e.getNpcConstraint(r.id,x.id);h=h.meet(w,!0),x.isNpc()&&(x.id===107||x.id===104)&&(h=h.meet(we.KENSU_CHEST,!0))}else if(x.isMonster()&&!(i.objects[x.monsterId]instanceof Ye)){let w=e.getMonsterConstraint(r.id,x.monsterId);h=h.meet(w,!0)}else x.isShootingWall(r)&&(h=h.meet(we.SHOOTING_WALL,!0));a.push(`Initial pass: ${h.fixed.map(x=>x.size<1/0?"["+[...x].join(", ")+"]":"all")}`);let u=new Map,m=x=>{let w=i.objects[x.id];if(w.monsterClass){let R=u.get(w.monsterClass);if(R!=null&&R!==x.id)return!1}let g=Fi.has(x.id),k=il.has(x.id);if(g){if(!f)return!1;--f}let b=e.getMonsterConstraint(r.id,x.id),v=h.tryMeet(b);if(!v&&h.pal2.size<1/0&&h.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(v=h.tryMeet(b,!0)),!v)return!1;let C;if(p){let R=i.objects[x.id];if(!(R instanceof Ye))throw new Error(`non-monster: ${R}`);if(C=p(R),C==null)return!1}a.push(`  Adding ${x.id.toString(16)}: ${JSON.stringify(v)}`),h=v,w.monsterClass&&u.set(w.monsterClass,x.id);let F=0;if(g||k){for(let R=0;R<o.length;R++)if(o[R]in c){F=R;break}}else for(let R=0;R<o.length;R++)if(!(o[R]in c)){F=R;break}(this.report[`mon-${x.id.toString(16)}`]=this.report[`mon-${x.id.toString(16)}`]||[]).push("$"+r.id.toString(16));let y=o[F],A=r.spawns[y-13];return g?(A.data[0]=253,A.data[1]=255):p?(A.screen=C>>>8,A.tile=C&255):y in c&&(A.y+=c[y][0]*16,A.x+=c[y][1]*16),A.monsterId=x.id,a.push(`    slot ${y.toString(16)}: ${A}`),o.splice(F,1),!0},p=r.monstersMoved||o.length&&this.flags.randomizeMaps()?r.monsterPlacer(t):null;if(f&&o.length)for(let x=0;x<(s&&r.id==66?this.monsters.length:Math.min(40,this.monsters.length));x++)Fi.has(this.monsters[x].id)&&m(this.monsters[x])&&this.monsters.splice(x,1);for(let x=0;x<this.monsters.length&&o.length;x++)if(m(this.monsters[x])){let[w]=this.monsters.splice(x,1);Fi.has(w.id)||this.used.push(w),x--}for(let x=0;x<this.used.length&&o.length;x++)m(this.used[x])&&(this.used.push(...this.used.splice(x,1)),x--);if(h.fix(r,t),o.length){console.error(`Failed to fill location ${r.id.toString(16)} ${r.name}: ${o.length} remaining`);for(let x of o){let w=r.spawns[x-13];w.x=w.y=0,w.id=176,w.data[0]=254}}for(let x of r.spawns)e.configure(r,x)}}},Fi=new Set([89,92,110,111,129,138,163,196]),il=new Set([85,93,124,188,193]),Lr={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}}});function Pi(n,t,e){new Ai(n,t,e).shuffle()}var Ai,Nr=G(()=>{de();Ai=class{constructor(t,e,s){this.rom=t;this.flags=e;this.random=s}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let t=new W(()=>[]);for(let s of this.rom.locations)!s.tilePalettes.some(i=>i!==154)||t.get(s.colorGroup).push(s);let e=[new Map,new Map];for(let s of t.values())for(let i of s)for(let r=0;r<2;r++)for(let o=0;o<2;o++){let a=e[r].get(i.tilePatterns[o]);a||e[r].set(i.tilePatterns[o],a=new Set),a.add(i.tilePalettes[r])}for(let s of t.values()){let i=s[0],r=[new Set,new Set];for(let l=0;l<2;l++)r[l]=new Set([...e[l].get(i.tilePatterns[0]),...e[l].get(i.tilePatterns[1])]);let o=this.random.pick([...r[0]]),a=this.random.pick([...r[1]]);for(let l of s)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}}});function Rt(n,t){t.eastCave?nl(n,t.eastCave):t.classicLimeTreeToLeaf&&rl(n),ol(n),al(n),cl(n),fl(n),ll(n)}function nl(n,t){let{locations:{EastCave1:e,EastCave2:s,EastCave3:i,SealedCave1:r,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:c,branchNWSE:d,branchNWS:f,branchWSE:h,caveEmpty:u,deadEndE:m,deadEndE_downStair:p,deadEndE_upStair:x,deadEndN_stairs:w,deadEndS:g,deadEndS_stairs:k,deadEndW:b,deadEndW_downStair:v,hallNE:C,hallNS:F,hallNW:y,hallSE:A,hallWS:R,hallWE:L,hallNS_entrance:X,hallNS_ramp:te,hallNS_wall:re}}=n;n.locations.allocate(e),n.locations.allocate(s),t.exit2&&n.locations.allocate(i);for(let N of[e,s,i])N.bgm=N.originalBgm=23,N.entrances=[],N.exits=[],N.pits=[],N.spawns=[],N.flags=[],N.width=N.height=1,N.screens=[[128]],N.tilePalettes=[26,27,5],N.originalTilePalettes=[26,27,5],N.tileset=136,N.tileEffects=181,N.tilePatterns=[20,2],N.spritePatterns=[...r.spritePatterns],N.spritePalettes=[...r.spritePalettes];e.meta=new ke(e.id,n.metatilesets.cave,5,5),e.meta.set2d(0,[[m,R,u,A,b],[u,F,A,y,u],[A,d,f,u,u],[F,te,C,L,R],[X,C,b,x,y]]),s.meta=new ke(s.id,n.metatilesets.cave,5,5),s.meta.set2d(0,[[m,R,g,u,g],[u,F,F,u,F],[u,l,c,h,y],[u,te,u,C,R],[m,y,u,u,w]]),o.meta.set2d(51,[[a]]),n.tileEffects[0].effects[192]=0,e.meta.attach(67,s.meta,68),e.meta.attach(64,o.meta,51),t.exit1&&(e.meta.set2d(4,[[v]]),Wr(e,4,t.exit1)),t.exit2&&(i.meta=new ke(i.id,n.metatilesets.cave,3,1),i.meta.set2d(0,[[k],[re],[X]]),i.spawns.push(H.from([24,7,35,0])),i.flags.push(Ji.of({screen:16,flag:n.flags.alloc(512)})),s.meta.set2d(64,[[p]]),s.meta.attach(64,i.meta,0),Wr(i,32,t.exit2)),e.spawns.push(H.of({screen:33,tile:135,timed:!0,id:2}),H.of({screen:18,tile:136,timed:!1,id:2}),H.of({screen:19,tile:137,timed:!0,id:2}),H.of({screen:50,tile:104,timed:!1,id:2}),H.of({screen:65,tile:136,timed:!0,id:2}),H.of({screen:51,tile:152,timed:!0,id:2}),H.of({screen:3,tile:136,timed:!0,id:2})),s.spawns.push(H.of({screen:1,tile:136,timed:!0,id:2}),H.of({screen:17,tile:72,timed:!1,id:2}),H.of({screen:18,tile:119,timed:!0,id:2}),H.of({screen:20,tile:40,timed:!1,id:2}),H.of({screen:35,tile:133,timed:!0,id:2}),H.of({screen:49,tile:136,timed:!0,id:2}),H.of({screen:51,tile:138,timed:!1,id:2}),H.of({screen:52,tile:152,timed:!0,id:2}),H.of({screen:65,tile:130,timed:!0,id:2}),H.of({y:272,x:1144,type:2,id:89}),H.of({y:112,x:264,type:2,id:124})),n.slots.swap(49,89)}function Wr(n,t,e){let{locations:{CordelPlainEast:s,CordelPlainWest:i,Desert2:r,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:c,boundaryN_trees:d,boundaryW_cave:f,cornerNE:h,cornerNW:u,cornerSE:m,cornerSE_cave:p,cornerSW:x}}=n.rom,w,g;switch(e){case"lime":w=a,g=16,w.resizeScreens(0,1,0,0),w.meta.spliceColumns(0,1,2,[[u,d],[f,c],[x,m]]);break;case"cordel":let k=[[f,c],[x,m]];w=s,g=85,w.meta.set2d(85,k),i.meta.set2d(85,k);break;case"goa":w=o,g=17,w.meta.set2d(1,[[u,h],[f,l]]);break;case"desert":w=r,g=83,w.meta.set2d(83,[[p]]);break}n.meta.attach(t,w.meta,g)}function rl(n){let{locations:{ValleyOfWind:t,LimeTreeValley:e},metascreens:{exitE:s,exitW_southwest:i,overworldEmpty_alt:r}}=n;t.meta.set2d(84,[[s]]),e.meta.set2d(16,[[i],[r]]),t.meta.attach(84,e.meta,16)}function ol(n){let{TowerEntrance:t,Crypt_Teleporter:e}=n.locations;e.meta.attach(0,t.meta,0,"teleporter","teleporter")}function al(n){let{flags:{OpenedSwanGate:t},locations:{SwanGate:e},npcs:{SoldierGuard:s}}=n;e.spawns.push(H.of({xt:10,yt:2,type:1,id:45}),H.of({xt:11,yt:2,type:1,id:45})),s.localDialogs.get(e.id)[0].flags.push(t.id)}function ll(n){dl(n.locations.SaberaPalace2_West,n.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function dl(n,t,...e){n.rom.locations.allocate(n,t),n.bgm=t.bgm,n.entrances=[],n.exits=[],n.pits=[],n.spawns=[],n.flags=[],n.width=n.height=1,n.screens=[[128]],n.tilePalettes=bt(t.tilePalettes),n.originalTilePalettes=bt(t.originalTilePalettes),n.tileset=t.tileset,n.tileEffects=t.tileEffects,n.tilePatterns=bt(t.tilePatterns),n.spritePatterns=bt(t.spritePatterns),n.spritePalettes=bt(t.spritePalettes);let i=0,r=0;for(let a of e)i=Math.max(i,(a>>>4)+1),r=Math.max(r,(a&15)+1);n.meta=new ke(n.id,t.meta.tileset,i,r);for(let a of e)n.meta.set(a,t.meta.get(a)),t.meta.set(a,t.meta.tileset.empty);let o=new Set(e);n.flags=t.flags.filter(a=>o.has(a.screen)),t.flags=t.flags.filter(a=>!o.has(a.screen)),n.spawns=t.spawns.filter(a=>o.has(a.screen)),t.spawns=t.spawns.filter(a=>!o.has(a.screen)),t.meta.moveExitsAndPitsTo(n.meta)}function cl(n){let t=n.locations.GoaFortress_Kensu.meta;for(let[e,s]of t.exits())e<16||s.startsWith("seamless")||t.deleteExit(e,s)}function fl(n){n.locations.ZebuCave.spawns.find(t=>t.isTrigger()).yt+=3}var Or=G(()=>{bo();Jt();le();(t=>{function n(e,s,i){let r={};if(e.addEastCave()){r.eastCave={};let o=["cordel","lime","goa","desert"];if(i)r.eastCave.exit1=o[i.gbcCaveExits[0]],r.eastCave.exit2=o[i.gbcCaveExits[1]];else{let a=s.nextInt(4);[r.eastCave.exit1]=o.splice(a,1),r.eastCave.exit2=s.pick(o)}}else e.connectLimeTreeToLeaf()&&(r.classicLimeTreeToLeaf=!0);return r}t.generateOptions=n})(Rt||(Rt={}))});var zr=G(()=>{});function $r(n,t,e,s){if(!t.unidentifiedItems())return;let i=(...d)=>d.map(f=>n.items[f]),r=i(50,51,52),o=i(39,40,49,54),a=i(53,57),l=i(37,56,58,61),c=i(62,63,64);for(let[d,[...f]]of[[r,hl],[o,ul],[a,ml],[l,pl],[c,xl]]){let h=(t.communityJokes()?f:f.filter(m=>m.startsWith("!"))).map(m=>m.replace(/^!/,""));e.shuffle(h);let u=e.shuffle([0,1,2,3]);for(let m of d){let p="";s?.keyItemNames.has(m.messageName)?p=s.keyItemNames.get(m.messageName):p=h.pop(),n.spoiler&&n.spoiler.addUnidentifiedItem(m.id,m.messageName,p),m.menuName=m.messageName=p,m.palette=u.pop()}}}var hl,ul,ml,pl,xl,gl,bl,wl,qr=G(()=>{hl=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Unidentified Key","Piano Key","Encryption Key","Private Key","Public Key","Secret Key","Cipher Key","Key Card","Keyboard","Any Key","Ctrl Key","Escape Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Major Key","Minor Key","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Cookie","Turkey","Monkey","Donkey","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key","Sticks Key","Key to my Heart","Aqui","Map Key","Key Stone"],ul=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","Deku Pipes","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power","Otamatone","Melodica","Vuvuzela","Didgeridoo","Dragonzord Flute","Whoopie Cushion"],ml=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Unidentified Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Halogen Bulb","Incandescent Bulb","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Streetlight","Flashlight","Search Light","LED","Nightlight","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Candle","Red Candle","Blue Candle","Gas Stove","Fireplace","Campfire","Bonfire","Tanning Bed","Bug Zapper","CRT","Disco Ball","The Clapper","Merton","Gaddlight","Shroomlight","Froglight","Glowstone","Redstone Lamp","PrismarineLantern","Soul Campire"],pl=["!Random Statue","!Rusty Statue","!Forbidden Statue","Unidentified Idol","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Great Sphynx","Olmec Head","Shakoki Dogu","Moai","Venus de Milo","David","The Thinker","Winged Victory","Terracotta Statue","Gargoyle","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","Tornel Statue","CodeGorilla Trophy","SirArchibald Model","ClaireDiviner Idol"],xl=["!Random Bow","Unidentified Bow","Crossbow","Arbalest","Autocrossbow","Long Bow","Compound Bow","Recurve Bow","Golden Bow","Silver Arrows","Ice Arrows","Fire Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Burnham","Bo Dallas","Bo Derek","Bo Diddley","Bo Jackson","Bo Schembechler","Beau Bridges","David Bowie","Bojangles","Bodacious","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn","Cupid's Bow","Bow No!","Slingshot"],gl=["Black Lotus","GympieGympie Leaf","The Beast's Rose","Dryad's Leaf","WALL-E's Plant"],bl=["Spike Choker","Dog Collar","Pearl Necklace","Heart of the Ocean","Auryn","Melisandre's Ruby","Boleyn 'B'","Satine's Necklace"],wl=["Specs","Reading Glasses","Night Vision","Sunglasses","Swimming Goggles"],[]=[gl,bl,wl]});function Hr(n,t,e){!t.communityJokes()||(kl(n,t,e),Il(n,e),Ml(n,e))}function kl(n,t,e){if(t.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let s=e.next()<.05?n.items:[n.items[e.nextInt(72)]];for(let i of s){if(!i)continue;let r=yl.get(i.messageName)||[],o=Math.floor(e.nextInt(3*r.length+1)/3);o<r.length?i.messageName=i.menuName=r[o]:i.messageName===i.menuName&&(i.messageName=i.menuName=Bi(i.messageName,e))}}function Bi(n,t){let e=n.split(""),s=t.nextInt(e.length-1);return e[s]===" "||e[s+1]===" "?n:(e[s].toUpperCase()===e[s]?e.splice(s+1,1):[e[s],e[s+1]]=[e[s+1],e[s]],e.join(""))}function Ur(n,t){for(let e of n.messages.parts)for(let s of e)s.text=t(s.text);n.messages.personNames=n.messages.personNames.map(t),vl(n,t)}function Bs(n,t){return e=>e.includes(n)?e.split(n).join(t):e}function vl(n,t){for(let e of n.objects)e.displayName&&(e.displayName=t(e.displayName))}function Il(n,t){let e=n.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let s=[...Sl].flatMap(([l,c])=>["",...c,...c].map(d=>[l,d])),[i,r]=t.pick(s),o=r||Bi(i,t);if(o===i)return;let a=Bs(i,o);(o==="Stom"||o==="Mado")&&(a=l=>l.includes("Stom")?Bs("Stom","Mado")(l):l.includes("Mado")?Bs("Mado","Stom")(l):l),Ur(n,a)}function Ml(n,t){for(let e=0;e<10;e++){let[s,i]=t.pick([...Cl]),o=t.pick(["",...i,...i,...i])||Bi(s,t);o!==s&&Ur(n,Bs(s,o))}}var yl,Sl,Cl,Kr=G(()=>{yl=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer","Sword of Friar"]],["Sword of Water",["Horde of Otters","Cane of Byrna"]],["Sword of Thunder",["Sorg of Chunker"]],["Tornado Bracelet",["Vornado Bracelet","Roarnado Bracelet"]],["Flame Bracelet",["Fame Bracelet","Bomb Ring"]],["Blizzard Bracelet",["Snowflake Ring","Gizzard Bracelet","Lizzard Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Sun",["Bow of Bun","Bow of Pun","Solar Bow"]],["Bow of Moon",["Bow of Noon","Bow of Lune","Lunar Bow"]],["Bow of Truth",["Bow of Strewth","Bow of Tooth","Bow of Grueth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute","Ivy Statue"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump","Shimmering Lamp"]],["Key to Stxy",["Key to Styx","Styx Key","Key to Sticks"]],["Insect Flute",["Bug Flute","Bug Whistle","Cockroach Flute","Mosquito Flute","Bug Summoner"]],["Flute of Lime",["Flute of Grime","Flute of Lemon","Flute of Rhyme"]],["Iron Necklace",["I Ron Necklace","Rusty Necklace"]],["Shield Ring",["Sho Ring","Barrier Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Pocket Cucco","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go","Exit"]],["Change",["Changeify","Transform","Disguise","Morph"]],["Barrier",["Barrierize","Protect","Wall","Shield","Shell"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),Sl=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Ninja Cannonball","Steve","Stom"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve","Mado"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),Cl=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mimic",["Chompy","Gozen","The Gozenator"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac","TASBot","SkyNet"]],["Vampire",["Captain Telefrag","Count Dracula"]]])});function jr(n){let{locations:t}=n,{CordelPlainEast:e,CordelPlainWest:s,WaterfallValleyNorth:i,WaterfallValleySouth:r,MezameShrine:o,MtSabreWest_Cave1:a}=t;e.meta.reconcileExits(s.meta);for(let l of i.meta.allPos()){let c=i.meta.get(l),d=r.meta.get(l);c.isEmpty()&&!d.isEmpty()?i.meta.set(l,d):d.isEmpty()&&!c.isEmpty()&&r.meta.set(l,c)}for(let l of t)!l.used||(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of t)!l.used||l!==a&&(l.meta.write(),l===s&&a.used&&a.meta.write())}var Vr=G(()=>{});function Xr(n,t){return t>=112?"Mimic":n.items[n.itemGets[t].itemId].messageName}var Ls,Li,Di,Yr=G(()=>{Ls=class{constructor(t){this.rom=t;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(t,e){this.route.push(new Li(this,t,e))}addSlot(t,e,s){this.slots[t&255]=new Di(this.rom,t&255,e,s&255)}addMaze(t,e,s){this.mazes.push({id:t,name:e,maze:s})}addTrade(t,e,s){this.trades.push({itemId:t,item:e,npc:s})}addUnidentifiedItem(t,e,s){this.unidentifiedItems.push({itemId:t,oldName:e,newName:s})}addWall(t,e,s){this.walls.push({location:t,oldElement:e,newElement:s})}addWildWarp(t,e){this.wildWarps.push({id:t,name:e})}addHouse(t,e){this.houses.push({houseId:t,townId:e,house:this.rom.locations[t].name,town:this.rom.locations[e].name})}formatCondition(t){return this.rom.flags[t]?.name}formatConditionList(t){let e=[];for(let s of t){let i=this.rom.flags[s];i?.logic.track&&e.push(i.name)}return e.join(", ")}},Li=class{constructor(t,e,s){this.spoiler=t;this.condition=e;this.deps=s}toString(){let t=0;return(this.condition&-128)===256&&(t=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${t?` (${this.spoiler.formatCondition(t)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},Di=class{constructor(t,e,s,i){this.slot=e;this.slotName=s;this.item=i;this.itemName=Xr(t,i),this.originalItem=Xr(t,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}}});function Rl(n,[t,e,[s,i]]){let r=Zr.get(e)||_i.get(Zr.get(i)),o=!1,a=n.id.toString(16),l=(n.id<<8|t).toString(16)+" "+e,c=n.rom.locations[s>>>8],d=s&255,f=s.toString(16)+" "+i,h=c.id.toString(16),u={loc:c,pos:d,type:i,area:h,key:f,reverse:null,origRev:null,get conn(){return _i.get(r)},set conn(p){r=_i.get(p)},get shuffle(){return o},set shuffle(p){if(p&&!r)throw new Error("shuffle without conn");o=p}},m={loc:n,pos:t,type:e,key:l,reverse:u,area:a,origRev:u,get conn(){return r},set conn(p){r=p},get shuffle(){return o},set shuffle(p){if(p&&!r)throw new Error("shuffle without conn");o=p}};return u.reverse=u.origRev=m,m}function Jr(n,t){return typeof t=="string"?n.type===t:typeof t=="number"?n.pos===t:t instanceof Qt?n.reverse.loc===t:t.every(e=>Jr(n,e))}function Qr(n,t,e){if(!t.shuffleAreas())return;let{locations:s}=n,i=new Map,r=new W(()=>[]);for(let g of n.locations)for(let k of g.meta.exits()){if(g===s.CordelPlainEast&&(k[0]&15)<5||g===s.CordelPlainWest&&(k[0]&15)>4||g.isTower())continue;let b=Rl(g,k);if(b.loc!==s.Portoa_FortuneTeller&&b.reverse.loc!==s.Portoa_FortuneTeller&&!i.has(b.key)){if(i.has(b.reverse.key))throw new Error(`Inconsistent exits: ${b.key} | ${b.reverse.key}`);i.set(b.key,b),i.set(b.reverse.key,b.reverse),r.get(b.loc).push(b),r.get(b.reverse.loc).push(b.reverse)}}function o(g,...k){let b=[];for(let v of r.get(g))for(let C of k)if(Jr(v,C)){b.push(v);break}return b}for(let g of o(s.ValleyOfWind,"door","windmill"))g.area="windmill";for(let g of o(s.AngrySea,100))g.area="lighthouse";o(s.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(g,...k){for(let b of o(g,...k))b.shuffle=!0}function l(...g){let k=new Set(g);for(let b of g)for(let v of r.get(b))k.has(v.reverse.loc)||(v.shuffle=!0)}if(l(s.Leaf_OutsideStart),a(s.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(s.WindmillCave),l(s.EastCave1,s.EastCave2,s.EastCave3),l(s.ZebuCave,s.MtSabreWest_Cave1),l(s.CordelPlainWest,s.CordelPlainEast),l(s.WaterfallValleyNorth,s.WaterfallValleySouth),l(s.KirisaMeadow),l(s.LimeTreeLake),a(s.Portoa_FishermanIsland,"edge:right"),a(s.PortoaPalace_ThroneRoom,"door"),a(s.Joel,"edge:bottom"),l(s.JoelSecretPassage),a(s.EvilSpiritIsland1,"stair:up"),a(s.ZombieTown,"cave"),a(s.AngrySea,"edge:top"),l(s.SwanGate),a(s.GoaValley,"edge:left"),l(s.Desert1),l(s.GoaFortressBasement),l(s.DesertCave1),l(s.SaharaOutsideCave),l(s.DesertCave2),a(s.Desert2,"stair:down"),!t.shuffleHouses()){let g=[[s.ZombieTown,"fortress"],[s.MtHydra,"gate"],[s.Desert2,"fortress"],[s.Goa,"edge:top"],[s.Portoa,"fortress"],[s.Shyron,"fortress"],[s.GoaValley,"fortress"],[s.OasisCave_Entrance,"stair:up"],[s.MtHydra_OutsideShyron,"gate"],[s.Crypt_Entrance,"crypt"]];for(let[k,b]of g){let[v]=o(k,b);v.conn="F",v.shuffle=!0}}{let[g]=o(s.Oak,"edge:bottom");g.conn="X",g.shuffle=!0}let c=new Ce;for(let g of i.values())g.shuffle||c.union([g.area,g.reverse.area]);let d=new W(()=>[]);for(let g of i.values())!g.shuffle||d.get(g.area=c.find(g.area)).push(g);let f=r.get(s.MezameShrine)[0].area;function h(){let g=new Set,k=new Map,b=[];for(let C of[f,...d.keys()]){if(g.has(C))continue;let F=new Set([C]),y=[];for(let A of F){g.add(A);for(let R of d.get(A))k.set(R,b.length),y.push(R),!(R.oneWay||g.has(R.reverse.area))&&F.add(R.reverse.area)}b.push(y)}let v=0;for(let C=1;C<b.length;C++)b[C].length<b[v].length&&(v=C);return[b.length,k,b[v]]}let u=new W(()=>[]);for(let g of i.values())!g.shuffle||!g.conn||u.get(g.conn).push(g);for(let g of"NWCF"){let k=u.get(g),b=e.shuffle([...k]).map(v=>v.reverse);for(let v=0;v<b.length;v++){let C=k[v],F=b[v];[C.reverse,F.reverse]=[F,C]}}let m=0,[p,x,w]=h();for(;m-- >0||p>1;){let g=e.pick(w),k=u.get(g.conn);if(p>1){let F=x.get(g);k=k.filter(y=>x.get(y)!==F)}let b=e.pick(k),v=g.reverse,C=b.reverse;g.reverse=C,C.reverse=g,b.reverse=v,v.reverse=b,[p,x,w]=h()}for(let g of i.values()){if(g.reverse!==g.origRev){let k=function(b){return`${b.loc.name} ${b.type}(${b.pos.toString(16)})`};console.log(`${k(g)}  =>  ${k(g.reverse)}  (was ${k(g.origRev)})`)}g.loc.meta.attach(g.pos,g.reverse.loc.meta,g.reverse.pos,g.type,g.reverse.type)}}var Zr,_i,eo=G(()=>{yt();de();wt();Zr=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),_i=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]])});function to(n){for(let t of n.locations){let e=new Set;for(let s of t.spawns)if(!!s.isTrigger()&&e.has(s.coord))throw new Error(`Overlapping triggers on ${t} at ${s.coord.toString(16)}`)}}var so=G(()=>{});function Ou(n){return n?/^[0-9a-f]{1,8}$/i.test(n)?Number.parseInt(n,16):ss(n):Ae.newSeed()}function Tl(n,t,e){let s={_ALLOW_TELEPORT_OUT_OF_BOSS:n.hardcoreMode()&&n.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:n.audibleWallCues(t),_AUTO_EQUIP_BRACELET:n.autoEquipBracelet(t),_ARCHIPELAGO:e?.fromArchipelago==!0,_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:n.buffDeosPendant(),_BUFF_DYNA:n.buffDyna(),_CHARGE_SHOT_ONLY:n.chargeShotsOnly(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:n.controllerShortcuts(t),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:n.disableShopGlitch(),_DISABLE_STATUE_GLITCH:n.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:n.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:n.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:n.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:ro,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:n.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:n.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:n.maxScalingInTower(),_MONEY_AT_START:n.shuffleHouses()||n.shuffleAreas(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:n.neverDie(),_NORMALIZE_SHOP_PRICES:n.shuffleShops(),_OOPS_ALL_MIMICS:n.alwaysMimics(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:n.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_RANDOM_WILD_WARP_COUNT:n.randomizeWildWarp(),_REQUIRE_HEALED_DOLPHIN_TO_RIDE:n.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:n.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:n.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:n.teleportOnThunderSword(),_TINK_MODE:!n.guaranteeMatchingSword(),_TRAINER:n.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:n.unidentifiedItems(),_ENEMY_HP:n.shouldUpdateHud(),_UPDATE_HUD:n.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:n.zebuStudentGivesItem()};return Object.keys(s).filter(i=>s[i]).map(i=>`.define ${i} ${s[i]}
`).join("")}function El(n,t){for(let e of t)st.applyPatch(e,n,!0)}async function zu(n,t,e,s,i,r,o){let a=16+(n[6]&4?512:0)+(n[4]<<14)+(n[5]<<13);if(n.length>a&&(n=n.slice(0,a)),ro&&n.length<524288){if(n.length<524288){let m=new Uint8Array(n.length+262144);m.subarray(0,262160).set(n.subarray(0,262160)),m.subarray(524304).set(n.subarray(262160)),m[4]<<=1,n=m}let u=n.subarray(16);u.subarray(507904,524288).set(u.subarray(245760,262144))}let l=n.slice(16);if(rr(n.subarray(16)),typeof t!="number")throw new Error("Bad seed");let c=ss(t.toString(16).padStart(8,"0")+String(e.filterOptional()))>>>0,d=new Ae(c),f=[],h=e.mayShuffleAreas()?12:5;for(let u=0;u<h;u++)try{return await Fl(n,e,t,d,r,o,s,i,l)}catch(m){if(m.name==="UsageError")throw m;f.push(m),console.error(`Attempt ${u+1} failed: ${m.stack}`)}throw new Error(`Shuffle failed: ${f.map(u=>u.stack).join(`

`)}`)}async function Fl(n,t,e,s,i,r,o,a,l){let c=String(t),d=t.filterRandom(s);d.validate();let f=new nn(n),h=String(d);f.flags.defrag(),er(f),tr(f),typeof globalThis=="object"&&(globalThis.rom=f),f.spoiler=new Ls(f),i&&(i.spoiler=f.spoiler),h!==c&&(f.spoiler.flags=h),or(f,d),en(f),Rt(f,Rt.generateOptions(d,s,a)),f.scalingLevels=48,d.shuffleShops()&&Al(f,d,s,a),d.shuffleGoaFloors()&&Ir(f,s,a),Pl(f),Bl(f,d,s,a),ir(f,s),a?f.wildWarp.locations=a.wildwarps:d.randomizeWildWarp()&&Dl(f,d,s),d.nerfWildWarp()&&f.wildWarp.locations.fill(0),d.randomizeThunderTeleport()&&Cr(f,s,a),vr(f,d,s,a),$r(f,d,s,a),Hr(f,d,s),dr(f,d,s,a),d.shuffleHouses()&&Tr(f,d,s),d.shuffleAreas()&&Qr(f,d,s),pr(f),d.randomizeMaps()&&kn(f,d,s),jr(f),Ar(f,s),d.shuffleMimics()&&Fr(f,d,s),d.shuffleMonsters()&&Dr(f,d,s,a?.fromArchipelago==!0);let u=new Fs(f,d),m=new ks([u.getLocationList()]);if(!d.noShuffle()&&!a?.fromArchipelago){let b=await m.shuffle(d,s,void 0,r,f.spoiler);if(b){for(let[v,C]of b)f.slots[v&255]=C&255;f.slots.setCheckCount(b.size)}else throw new Error("Shuffle failed")}d.shuffleShops()&&$l(f,d.bargainHunting()?s:void 0),d.buffMedicalHerb()&&(f.items.MedicalHerb.value=80,f.items.FruitOfPower.value=56),d.storyMode()&&Wl(f),d.blackoutMode()&&Nl(f),Gl(f,d,s),hr(f,a),gr(f),to(f),d.buffDyna()&&_l(f,d),d.trainer()&&(f.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),d.randomizeMusic("early")&&no(f,d,s),d.shuffleTilePalettes("early")&&Pi(f,d,s),zl(f,d),s.shuffle(f.randomNumbers.values);async function p(b){let v=Tl(d,b,a),C=new $i(Nt.P02,{overwriteMode:"forbid"}),F=new Hi;F.enter(zi.concat(new Hs(v,"flags.s"),...Ui().map(({filename:L,contents:X})=>new Hs(ui(X,Nt.P02,l),L,{lineContinuations:!0}))));let y=new qi(F,C);C.tokens(y);let A=ji(),R=[];for(let L of A.labels)C.definedSymbol(L.name)||((R.length!==L.segments.length||R.some((X,te)=>X!==L.segments[te]))&&C.segment(...R=L.segments),C.org(L.org),C.label(L.name));for(let L of A.refs){let X=L.offset+(L.offset>=245760?262144:0);if(!C.isWritten(X))if((R.length!==L.segments.length||R.some((te,re)=>te!==L.segments[re]))&&C.segment(...R=L.segments),C.org(L.org),L.bytes===1)C.byte(L.expr);else if(L.bytes===2)C.word(L.expr);else throw new Error(`bad bytes: ${L.bytes}`)}return C.module()}f.messages.compress();let x=n.slice(16);f.modules.set(io,await p("early")),f.writeData(x),f.modules.set(io,await p("late"));let w=o?.some(b=>st.isCustom(b))||!1,g=Ol(n,e,c,x,w,a);d.randomizeMusic("late")&&no(f,d,s),d.noMusic("late")&&Ll(f),d.shuffleTilePalettes("late")&&Pi(f,d,s),yr(f),f.writeData();let k=o||[];return El(n.subarray(16),k),[n,g]}function Gl(n,t,e){let{}={rom:n,flags:t,random:e},s=n.messages.parts[1][2];s.text=`
      You've found
       an APItem!
`,n.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,n.messages.parts[0][14].text="It's dangerous to go alone! Take this.",n.messages.parts[0][14].fixText()}function Al(n,t,e,s){let i={[0]:{contents:[],shops:[]},[1]:{contents:[],shops:[]}};for(let r of n.shops)if(!(!r.used||r.location===255))if(s&&r.type===1){r.contents=[];let o=s.shopInventories.get(r.location);for(let a of o)r.contents.push(a);r.contents.sort((a,l)=>a-l)}else{let o=i[r.type];o&&(o.contents.push(...r.contents.filter(a=>a!==255)),o.shops.push(r),r.contents=[])}for(let r of Object.values(i)){let o=null,a=[...r.contents];for(e.shuffle(a);a.length;){(!o||!o.length)&&(o&&a.shift(),o=[...r.shops,...r.shops,...r.shops,...r.shops],e.shuffle(o));let l=a[0],c=o[0];c.contents.length<4&&!c.contents.includes(l)&&(c.contents.push(l),a.shift()),o.shift()}}for(let r of Object.values(i))for(let o of r.shops){for(;o.contents.length<4;)o.contents.push(255);o.contents.sort((a,l)=>a-l)}}function Pl(n){for(let t of n.locations)if(!!t.used){for(let e of t.spawns)if(e.isWall()){let s=e.id&15;e.id=s|s<<4;let i=e.isShootingWall(t);e.data[2]=i?51:35}}}function Bl(n,t,e,s){if(!t.randomizeWalls())return;let i=[[5,56],[17],[106],[20]];function r(a){return a.data[2]&32?a.id>>>4&3:a.id&3}let o=new W(()=>[]);for(let a of n.locations)o.get(a.data.area).push(a);for(let a of o.entries()){let l=a[0],c=a[1],d=0;s?.wallMap.has(l.name)?d=s.wallMap.get(l.name):d=e.nextInt(4);let f=e.pick(i[d]),h=!1;for(let u of c)for(let m of u.spawns)if(m.isWall()){let p=r(m);if(p===2)continue;if(p===3){let x=0;s?.wallMap.has(u.name)?x=s.wallMap.get(u.name):s?m.xt==23&&s.wallMap.has("Goa Fortress - Sabera Item")?x=s.wallMap.get("Goa Fortress - Sabera Item"):s.wallMap.has("Goa Fortress - Sabera Boss")?x=s.wallMap.get("Goa Fortress - Sabera Boss"):(console.warn(`We have shuffle data but can't find ${m.id} at ${u.name} in wallMap`),console.warn("Falling back to standard wall randomization."),x=e.nextInt(4)):x=e.nextInt(4),n.spoiler&&n.spoiler.addWall(u.name,p,x),m.data[2]|=32,m.id=48|x}else!h&&n.spoiler&&(n.spoiler.addWall(u.data.area.name,p,d),h=!0),m.data[2]|=32,m.id=p<<4|d,u.tilePalettes[2]=f}}}function Ll(n){for(let t of[...n.locations,...n.bosses.musics])t.bgm=0}function no(n,t,e){let s=new W(()=>[]),i=new Set;for(let a of n.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;i.add(a.bgm),s.get(l).push(a)}for(let a of n.bosses.musics)s.set(a,[a]),i.add(a.bgm);let r=[...i],o=new Set;for(let a of s.values()){let l=e.pick(r);for(let c of a)c.bgm=l,o.add(c)}}function Dl(n,t,e){let s=[];for(let o of n.locations)o&&o.used&&o.id&&!o.isShop()&&o!==n.locations.EvilSpiritIsland1&&o!==n.locations.UndergroundChannel&&(o.id&248)!==88&&o!==n.locations.Crypt_Draygon2&&o!==n.locations.Crypt_Teleporter&&o!==n.locations.MesiaShrine&&o!==n.locations.LimeTreeLake&&s.push(o);e.shuffle(s),n.wildWarp.locations=[];let i=4,r=e.nextInt(16-i)+i;for(let o of[...s.slice(0,r)])n.wildWarp.locations.push(o.id),n.spoiler&&n.spoiler.addWildWarp(o.id,o.name);n.wildWarp.locations.push(0)}function _l(n,t){n.objects[184].collisionPlane=1,n.objects[184].immobile=!0,n.objects[185].collisionPlane=1,n.objects[185].immobile=!0,n.objects[51].collisionPlane=2,n.adHocSpawns[40].slotRangeLower=28,n.adHocSpawns[41].slotRangeUpper=28,n.adHocSpawns[42].slotRangeUpper=28}function Nl(n){let t=new Set([n.metatilesets.cave.tilesetId,n.metatilesets.fortress.tilesetId,n.metatilesets.iceCave.tilesetId,n.metatilesets.labyrinth.tilesetId,n.metatilesets.pyramid.tilesetId]);for(let e of n.locations)t.has(e.tileset)&&e.tilePalettes.fill(154)}function Ol(n,t,e,s,i,r){let o=ss(s),a=o.toString(16).padStart(8,"0").toUpperCase(),l=ai==="unstable"?Mn.substring(0,7).padStart(7,"0").toUpperCase()+"     ":In.substring(0,12).padEnd(12," "),c=t.toString(16).padStart(8,"0").toUpperCase(),d=(u,...m)=>{u+=16;for(let p of m)if(typeof p=="string")for(let x of p)n[u++]=x.charCodeAt(0);else if(typeof p=="number")n[u++]=p;else throw new Error(`Bad value: ${p}`)},f=(u,m)=>{let p=[];for(let x=0;x<u.length||x<m.length;x++)p.push(u[x]||" "),p.push(m[x]||" ");return p.join("")};d(161743,f("  VERSION     SEED      ",`  ${l}${c}`));let h;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");h=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),d(161791,f(e.substring(0,23),e.substring(23))),h&&d(161839,f(h.substring(0,23),h.substring(23))),i&&d(161923,126),d(161925,f(a.substring(0,4),a.substring(4))),r?.fromArchipelago?d(153365,"ARCHIPELAGO"):d(153366,"RANDOMIZER"),ai==="unstable"&&d(153404,"BETA"),o}function zl(n,t){t.decreaseEnemyDamage()&&n.scaling.setPhpFormula(e=>16+6*e),n.scaling.setExpScalingFactor(t.expScalingFactor()),t.disableShopGlitch()?n.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:n.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],n.items.CarapaceShield.defense=n.items.TannedHide.defense=3,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=9,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=13,n.items.PsychoArmor.defense=n.items.PsychoShield.defense=20,n.items.CeramicSuit.defense=n.items.BattleShield.defense=32,n.items.CarapaceShield.defense=n.items.TannedHide.defense=2,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=10,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=14,n.items.BattleArmor.defense=24}var ro,io,Wl,$l,ql,Hl=G(()=>{po();Oi();xo();Dn();ho();go();uo();rn();an();Nn();Qn();sr();nr();lr();ur();xr();br();Sr();kr();Ii();Mr();Er();vn();Gr();Pr();_r();Nr();ki();Or();zr();qr();Kr();Vr();os();ko();es();Ks();Yr();le();Vi();de();Rn();eo();so();Pn();ro=!0,io=sn("asm");({}={watchArray:Xi});Wl=n=>{let t=[n.flags.Kelbesque1.id,n.flags.Sabera1.id,n.flags.Mado1.id,n.flags.Kelbesque2.id,n.flags.Sabera2.id,n.flags.Mado2.id,n.flags.Karmine.id,n.flags.Draygon1.id,n.flags.SwordOfWind.id,n.flags.SwordOfFire.id,n.flags.SwordOfWater.id,n.flags.SwordOfThunder.id];n.npcs[203].spawnConditions.get(166).push(...t)};$l=(n,t)=>{for(let s of n.shops)if(s.type!==3)for(let i=0,r=s.prices.length;i<r;i++)s.contents[i]<128?s.prices[i]=t?t.nextNormal(1,.3,.5,1.5):1:s.type!==2?s.prices[i]=0:s.prices[i]=t?t.nextNormal(1,.5,.375,1.625):1;let e=ne(48,s=>s);n.shops.rescale=!0,n.shops.toolShopScaling=e.map(s=>Math.round(8*2**(s/10))),n.shops.armorShopScaling=e.map(s=>Math.round(8*2**((47-s)/12)));for(let s=13;s<39;s++)n.items[s].basePrice=ql[s]},ql={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300},[]=[j]});export{ss as a,rn as b,he as c,pe as d,lt as e,an as f,os as g,Oo as h,vn as i,ai as j,In as k,Gc as l,Mn as m,Ac as n,Pc as o,Rn as p,Dc as q,st as r,Cs as s,Ko as t,Pn as u,Ou as v,zu as w,Hl as x};
