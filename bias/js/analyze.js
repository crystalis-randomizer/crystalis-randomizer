#!/usr/bin/env -S node -r esm --inspect 
import './build_info.js';
import { EXPECTED_CRC32 } from './rom.js';
import { FlagSet, Preset } from './flagset.js';
import { crc32 } from './crc32.js';
import * as fs from 'fs';
import * as patch from './patch.js';
import { UsageError } from './util.js';
import { NodeReader } from './nodereader.js';
import * as version from './version.js';
import { disableAsserts } from './assert.js';
const main = async (...args) => {
    let flags = '@Standard';
    let count = 1;
    let seed = '';
    let output = '%n_%c';
    let force = false;
    while (args[0] && args[0].startsWith('--')) {
        let arg = args.shift().substring(2);
        let value = undefined;
        const eq = arg.indexOf('=');
        if (eq >= 0) {
            value = arg.substring(eq + 1);
            arg = arg.substring(0, eq);
        }
        else {
            value = args.shift();
        }
        if (arg == 'flags' && value) {
            flags = value;
        }
        else if (arg == 'preset' && value) {
            flags = '@' + value.replace(/ /g, '');
        }
        else if (arg == 'output' && value) {
            output = value;
        }
        else if (arg == 'count' && value) {
            count = Number(value);
        }
        else if (arg == 'force') {
            force = true;
            disableAsserts();
            if (value != null)
                args.unshift(value);
        }
        else if (arg == 'version' || arg == '-v') {
            console.log(version.VERSION);
            process.exit(0);
        }
        else if (arg == 'list-presets') {
            for (const { name } of Preset.all()) {
                console.log(name.replace(/ /g, ''));
            }
            process.exit(0);
        }
        else {
            console.error(`Bad argument: ${arg}`);
        }
    }
    if (count > 1) {
        if (seed)
            fail('Cannot specify both --count and --seed');
        if (!/%[sc]/.test(output)) {
            fail('--output must have a %c or %s placeholder when --count is given');
        }
    }
    const flagset = new FlagSet(flags);
    const rom = new Uint8Array(fs.readFileSync(args[0]).buffer);
    if (crc32(rom) != EXPECTED_CRC32) {
        console.error(`WARNING: Bad CRC for input rom: ${crc32(rom).toString(16)}`);
        if (!force)
            fail('Run with --force to proceed anyway');
        console.error('Proceeding anyway');
    }
    const sphereAnalysis = globalThis.sphereAnalysis = new Map();
    await Promise.all(new Array(count).fill(0).map(async () => {
        const s = patch.parseSeed(seed);
        console.log(`Seed: ${s.toString(16)}`);
        const orig = rom.slice();
        await patch.shuffle(orig, s, flagset, new NodeReader());
    }));
    for (const [item, hist] of sphereAnalysis) {
        console.log(`\n${item}`);
        const max = hist.reduce((a, b) => Math.max(a, b), 0);
        const scale = Math.min(1, 80 / max);
        let first = true;
        for (let i = 0; i < hist.length; i++) {
            if (!hist[i] && first)
                continue;
            first = false;
            const lines = scale * hist[i];
            const frac = lines % 1;
            console.log(`${String(i).padStart(2, ' ')}|${'*'.repeat(Math.floor(lines))}${frac > 0.5 ? '.' : ''}`);
        }
    }
};
function fail(message) {
    console.error(message);
    throw process.exit(2);
}
process.on('unhandledRejection', (error) => {
    console.error(typeof error === 'string' ?
        error :
        error instanceof UsageError ? error.message : error.stack);
    process.exit(1);
});
const asyncMain = async () => {
    try {
        await main(...process.argv.slice(2));
    }
    catch (error) {
        if (error instanceof UsageError) {
            console.error(error.message);
            console.error(`Try passing --help for documentation.`);
            process.exit(1);
        }
        throw error;
    }
};
asyncMain().then(() => process.exit(0));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5hbHl6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy9hbmFseXplLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxPQUFPLGlCQUFpQixDQUFDO0FBRXpCLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDeEMsT0FBTyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDN0MsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFlBQVksQ0FBQztBQUNqQyxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEtBQUssS0FBSyxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQWMsQ0FBQztBQUN4QyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBSTNDLE1BQU0sSUFBSSxHQUFHLEtBQUssRUFBRSxHQUFHLElBQWMsRUFBRSxFQUFFO0lBQ3ZDLElBQUksS0FBSyxHQUFHLFdBQVcsQ0FBQztJQUN4QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDZCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7SUFDZCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUM7SUFDckIsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ2xCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDMUMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLEtBQUssR0FBRyxTQUFTLENBQUM7UUFDdEIsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDWCxLQUFLLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDOUIsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQzVCO2FBQU07WUFDTCxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3RCO1FBQ0QsSUFBSSxHQUFHLElBQUksT0FBTyxJQUFJLEtBQUssRUFBRTtZQUMzQixLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQ2Y7YUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLElBQUksS0FBSyxFQUFFO1lBQ25DLEtBQUssR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDdkM7YUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLElBQUksS0FBSyxFQUFFO1lBQ25DLE1BQU0sR0FBRyxLQUFLLENBQUM7U0FDaEI7YUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLElBQUksS0FBSyxFQUFFO1lBQ2xDLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdkI7YUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLEVBQUU7WUFDekIsS0FBSyxHQUFHLElBQUksQ0FBQztZQUNiLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLElBQUksS0FBSyxJQUFJLElBQUk7Z0JBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN4QzthQUFNLElBQUksR0FBRyxJQUFJLFNBQVMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakI7YUFBTSxJQUFJLEdBQUcsSUFBSSxjQUFjLEVBQUU7WUFFaEMsS0FBSyxNQUFNLEVBQUMsSUFBSSxFQUFDLElBQUksTUFBTSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDckM7WUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2pCO2FBQU07WUFDTCxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZDO0tBQ0Y7SUFFRCxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7UUFDYixJQUFJLElBQUk7WUFBRSxJQUFJLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN6QixJQUFJLENBQUMsaUVBQWlFLENBQUMsQ0FBQztTQUN6RTtLQUNGO0lBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsTUFBTSxHQUFHLEdBQUcsSUFBSSxVQUFVLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1RCxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxjQUFjLEVBQUU7UUFDaEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDNUUsSUFBSSxDQUFDLEtBQUs7WUFBRSxJQUFJLENBQUMsb0NBQW9DLENBQUMsQ0FBQztRQUN2RCxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7S0FDcEM7SUFFRCxNQUFNLGNBQWMsR0FBSSxVQUFrQixDQUFDLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztJQUN4RixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUN4RCxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDekIsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ0osS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLGNBQWMsRUFBRTtRQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQztRQUN6QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUNqQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUs7Z0JBQUUsU0FBUztZQUNoQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBQ2QsTUFBTSxLQUFLLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsSUFDakMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ2xFO0tBQ0Y7QUFDSCxDQUFDLENBQUM7QUFFRixTQUFTLElBQUksQ0FBQyxPQUFlO0lBQzNCLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkIsTUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxPQUFPLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUMsS0FBVSxFQUFFLEVBQUU7SUFDOUMsT0FBTyxDQUFDLEtBQUssQ0FDVCxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQztRQUN2QixLQUFLLENBQUMsQ0FBQztRQUNQLEtBQUssWUFBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxTQUFTLEdBQ1gsS0FBSyxJQUFJLEVBQUU7SUFDYixJQUFJO1FBQ0YsTUFBTSxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3RDO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxJQUFJLEtBQUssWUFBWSxVQUFVLEVBQUU7WUFDL0IsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0IsT0FBTyxDQUFDLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO1lBQ3ZELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakI7UUFDRCxNQUFNLEtBQUssQ0FBQztLQUNiO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IC1TIG5vZGUgLXIgZXNtIC0taW5zcGVjdCBcblxuaW1wb3J0ICcuL2J1aWxkX2luZm8uanMnOyAvLyBzaWRlIGVmZmVjdCBnbG9iYWwgc2V0IChhZmZlY3RzIHZlcnNpb24gbW9kdWxlKVxuXG5pbXBvcnQge0VYUEVDVEVEX0NSQzMyfSBmcm9tICcuL3JvbS5qcyc7XG5pbXBvcnQge0ZsYWdTZXQsIFByZXNldH0gZnJvbSAnLi9mbGFnc2V0LmpzJztcbmltcG9ydCB7Y3JjMzJ9IGZyb20gJy4vY3JjMzIuanMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0Y2ggZnJvbSAnLi9wYXRjaC5qcyc7XG5pbXBvcnQge1VzYWdlRXJyb3J9IGZyb20gJy4vdXRpbC5qcyc7XG5pbXBvcnQge05vZGVSZWFkZXJ9IGZyb20gJy4vbm9kZXJlYWRlci5qcyc7XG5pbXBvcnQgKiBhcyB2ZXJzaW9uIGZyb20gJy4vdmVyc2lvbi5qcyc7XG5pbXBvcnQge2Rpc2FibGVBc3NlcnRzfSBmcm9tICcuL2Fzc2VydC5qcyc7XG5cbi8vIFVzYWdlOiBub2RlIGFuYWx5emUuanMgWy0tZmxhZ3M9PEZMQUdTPl0gcm9tLm5lc1xuXG5jb25zdCBtYWluID0gYXN5bmMgKC4uLmFyZ3M6IHN0cmluZ1tdKSA9PiB7XG4gIGxldCBmbGFncyA9ICdAU3RhbmRhcmQnO1xuICBsZXQgY291bnQgPSAxO1xuICBsZXQgc2VlZCA9ICcnO1xuICBsZXQgb3V0cHV0ID0gJyVuXyVjJztcbiAgbGV0IGZvcmNlID0gZmFsc2U7XG4gIHdoaWxlIChhcmdzWzBdICYmIGFyZ3NbMF0uc3RhcnRzV2l0aCgnLS0nKSkge1xuICAgIGxldCBhcmcgPSBhcmdzLnNoaWZ0KCkhLnN1YnN0cmluZygyKTtcbiAgICBsZXQgdmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgY29uc3QgZXEgPSBhcmcuaW5kZXhPZignPScpO1xuICAgIGlmIChlcSA+PSAwKSB7XG4gICAgICB2YWx1ZSA9IGFyZy5zdWJzdHJpbmcoZXEgKyAxKTtcbiAgICAgIGFyZyA9IGFyZy5zdWJzdHJpbmcoMCwgZXEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YWx1ZSA9IGFyZ3Muc2hpZnQoKTtcbiAgICB9XG4gICAgaWYgKGFyZyA9PSAnZmxhZ3MnICYmIHZhbHVlKSB7XG4gICAgICBmbGFncyA9IHZhbHVlO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICdwcmVzZXQnICYmIHZhbHVlKSB7XG4gICAgICBmbGFncyA9ICdAJyArIHZhbHVlLnJlcGxhY2UoLyAvZywgJycpO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICdvdXRwdXQnICYmIHZhbHVlKSB7XG4gICAgICBvdXRwdXQgPSB2YWx1ZTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnY291bnQnICYmIHZhbHVlKSB7XG4gICAgICBjb3VudCA9IE51bWJlcih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ2ZvcmNlJykge1xuICAgICAgZm9yY2UgPSB0cnVlO1xuICAgICAgZGlzYWJsZUFzc2VydHMoKTtcbiAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSBhcmdzLnVuc2hpZnQodmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICd2ZXJzaW9uJyB8fCBhcmcgPT0gJy12Jykge1xuICAgICAgY29uc29sZS5sb2codmVyc2lvbi5WRVJTSU9OKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnbGlzdC1wcmVzZXRzJykge1xuICAgICAgLy8gdW5kb2N1bWVudGVkIGZsYWdcbiAgICAgIGZvciAoY29uc3Qge25hbWV9IG9mIFByZXNldC5hbGwoKSkge1xuICAgICAgICBjb25zb2xlLmxvZyhuYW1lLnJlcGxhY2UoLyAvZywgJycpKTtcbiAgICAgIH1cbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihgQmFkIGFyZ3VtZW50OiAke2FyZ31gKTtcbiAgICB9XG4gIH1cblxuICBpZiAoY291bnQgPiAxKSB7XG4gICAgaWYgKHNlZWQpIGZhaWwoJ0Nhbm5vdCBzcGVjaWZ5IGJvdGggLS1jb3VudCBhbmQgLS1zZWVkJyk7XG4gICAgaWYgKCEvJVtzY10vLnRlc3Qob3V0cHV0KSkge1xuICAgICAgZmFpbCgnLS1vdXRwdXQgbXVzdCBoYXZlIGEgJWMgb3IgJXMgcGxhY2Vob2xkZXIgd2hlbiAtLWNvdW50IGlzIGdpdmVuJyk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgZmxhZ3NldCA9IG5ldyBGbGFnU2V0KGZsYWdzKTtcbiAgY29uc3Qgcm9tID0gbmV3IFVpbnQ4QXJyYXkoZnMucmVhZEZpbGVTeW5jKGFyZ3NbMF0pLmJ1ZmZlcik7XG4gIGlmIChjcmMzMihyb20pICE9IEVYUEVDVEVEX0NSQzMyKSB7XG4gICAgY29uc29sZS5lcnJvcihgV0FSTklORzogQmFkIENSQyBmb3IgaW5wdXQgcm9tOiAke2NyYzMyKHJvbSkudG9TdHJpbmcoMTYpfWApO1xuICAgIGlmICghZm9yY2UpIGZhaWwoJ1J1biB3aXRoIC0tZm9yY2UgdG8gcHJvY2VlZCBhbnl3YXknKTtcbiAgICBjb25zb2xlLmVycm9yKCdQcm9jZWVkaW5nIGFueXdheScpO1xuICB9XG5cbiAgY29uc3Qgc3BoZXJlQW5hbHlzaXMgPSAoZ2xvYmFsVGhpcyBhcyBhbnkpLnNwaGVyZUFuYWx5c2lzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcltdPigpO1xuICBhd2FpdCBQcm9taXNlLmFsbChuZXcgQXJyYXkoY291bnQpLmZpbGwoMCkubWFwKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzID0gcGF0Y2gucGFyc2VTZWVkKHNlZWQpO1xuICAgIGNvbnNvbGUubG9nKGBTZWVkOiAke3MudG9TdHJpbmcoMTYpfWApO1xuICAgIGNvbnN0IG9yaWcgPSByb20uc2xpY2UoKTtcbiAgICBhd2FpdCBwYXRjaC5zaHVmZmxlKG9yaWcsIHMsIGZsYWdzZXQsIG5ldyBOb2RlUmVhZGVyKCkpO1xuICB9KSk7XG4gIGZvciAoY29uc3QgW2l0ZW0sIGhpc3RdIG9mIHNwaGVyZUFuYWx5c2lzKSB7XG4gICAgY29uc29sZS5sb2coYFxcbiR7aXRlbX1gKTtcbiAgICBjb25zdCBtYXggPSBoaXN0LnJlZHVjZSgoYSwgYikgPT4gTWF0aC5tYXgoYSwgYiksIDApO1xuICAgIGNvbnN0IHNjYWxlID0gTWF0aC5taW4oMSwgODAgLyBtYXgpO1xuICAgIGxldCBmaXJzdCA9IHRydWU7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoIWhpc3RbaV0gJiYgZmlyc3QpIGNvbnRpbnVlO1xuICAgICAgZmlyc3QgPSBmYWxzZTtcbiAgICAgIGNvbnN0IGxpbmVzID0gc2NhbGUgKiBoaXN0W2ldO1xuICAgICAgY29uc3QgZnJhYyA9IGxpbmVzICUgMTtcbiAgICAgIGNvbnNvbGUubG9nKGAke1N0cmluZyhpKS5wYWRTdGFydCgyLCAnICcpfXwke1xuICAgICAgICAgICAgICAnKicucmVwZWF0KE1hdGguZmxvb3IobGluZXMpKX0ke2ZyYWMgPiAwLjUgPyAnLicgOiAnJ31gKTtcbiAgICB9XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGZhaWwobWVzc2FnZTogc3RyaW5nKTogbmV2ZXIge1xuICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICB0aHJvdyBwcm9jZXNzLmV4aXQoMik7XG59XG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChlcnJvcjogYW55KSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoXG4gICAgICB0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnID9cbiAgICAgICAgICBlcnJvciA6XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLnN0YWNrKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG5cbmNvbnN0IGFzeW5jTWFpbiA9XG4gICAgYXN5bmMgKCkgPT4ge1xuICB0cnkge1xuICAgIGF3YWl0IG1haW4oLi4ucHJvY2Vzcy5hcmd2LnNsaWNlKDIpKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgY29uc29sZS5lcnJvcihgVHJ5IHBhc3NpbmcgLS1oZWxwIGZvciBkb2N1bWVudGF0aW9uLmApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5hc3luY01haW4oKS50aGVuKCgpID0+IHByb2Nlc3MuZXhpdCgwKSk7XG4iXX0=