import { Entity } from './entity.js';
import { readLittleEndian } from './util.js';
import { Constraint } from './constraint.js';
export class ObjectData extends Entity {
    constructor(parent, id) {
        super(parent.rom, id);
        this.constraint = Constraint.ALL;
        parent[id] = this;
        this.used = true;
        this.name = '';
        this.base = readLittleEndian(this.rom.prg, this.pointer) + 0x10000;
        this.sfx = this.rom.prg[this.base];
        this.data = [];
        let a = this.base + 1;
        let m = 0;
        for (let i = 0; i < 32; i++) {
            if (!(i & 7)) {
                m = this.rom.prg[a++];
            }
            this.data.push(m & 0x80 ? this.rom.prg[a++] : 0);
            m <<= 1;
        }
    }
    get pointer() {
        return 0x1ac00 + (this.id << 1);
    }
    serialize() {
        const out = [this.sfx];
        for (let i = 0; i < 4; i++) {
            const k = out.length;
            out.push(0);
            for (let j = 0; j < 8; j++) {
                if (this.data[8 * i + j]) {
                    out[k] |= (0x80 >>> j);
                    out.push(this.data[8 * i + j]);
                }
            }
        }
        return out;
    }
    write() {
        const name = `Object_${this.id.toString(16).padStart(2, '0')}`;
        const a = this.rom.assembler();
        a.segment('0d');
        a.reloc(name);
        const label = a.pc();
        a.byte(...this.serialize());
        a.org(0xac00 + (this.id << 1), `${name}_Ptr`);
        a.word(label);
        if (this === this.rom.objects.blueSlime) {
            let e = this.elements;
            let b = 0;
            while (e) {
                e >>= 1;
                b++;
            }
            a.segment('1a');
            a.org(0x922d);
            a.byte(b);
        }
        a.segment('3c');
        a.org(0x8000 + (this.id << 5), `${name}_Str`);
        let objName = this.name.substring(0, 27);
        a.byte(...objName);
        a.byte(0x9b);
        a.byte(...Array(28 - (objName.length + 1)).fill(0x1c));
        return [a.module()];
    }
    get(addr) {
        return this.data[(addr - 0x300) >>> 5];
    }
    parents() {
        return [];
    }
    spawnedChild() {
        var _a;
        const hasChild = (_a = this.rom.objectActions[this.action]) === null || _a === void 0 ? void 0 : _a.data.hasChild;
        if (!hasChild)
            return undefined;
        const spawn = this.rom.adHocSpawns[this.child];
        const spawnId = spawn && spawn.objectId;
        if (spawnId == null)
            return undefined;
        return this.rom.objects[spawnId];
    }
    spawnedReplacement() {
        if (!this.replacement)
            return undefined;
        return this.rom.objects[this.replacement];
    }
    locations() {
        return this.rom.locations.filter((l) => l.used && l.spawns.some(spawn => spawn.isMonster() && spawn.monsterId === this.id));
    }
    palettes(includeChildren = false) {
        var _a, _b;
        if (this.action === 0x22)
            return [3];
        let metaspriteId = this.data[0];
        if (this.action === 0x2a)
            metaspriteId = this.data[31] | 1;
        if (this.action === 0x29)
            metaspriteId = 0x6b;
        if (this.action === 0x26)
            metaspriteId = 0x9c;
        const ms = this.rom.metasprites[metaspriteId];
        const childMs = includeChildren && this.child ?
            this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]] :
            null;
        const s = new Set([...((_a = ms === null || ms === void 0 ? void 0 : ms.palettes()) !== null && _a !== void 0 ? _a : []),
            ...((_b = childMs === null || childMs === void 0 ? void 0 : childMs.palettes()) !== null && _b !== void 0 ? _b : [])]);
        return [...s];
    }
    isVulnerable(element) {
        return !(this.elements & (1 << element));
    }
    isShadow() {
        return this.id === 0x7b || this.id === 0x8c;
    }
    get metasprite() { return METASPRITE.get(this.data); }
    set metasprite(x) { METASPRITE.set(this.data, x); }
    get speed() { return SPEED.get(this.data); }
    set speed(x) { SPEED.set(this.data, x); }
    get collisionPlane() { return COLLISION_PLANE.get(this.data); }
    set collisionPlane(x) { COLLISION_PLANE.set(this.data, x); }
    get hitbox() { return HITBOX.get(this.data); }
    set hitbox(x) { HITBOX.set(this.data, x); }
    get hp() { return HP.get(this.data); }
    set hp(x) { HP.set(this.data, x); }
    get atk() { return ATK.get(this.data); }
    set atk(x) { ATK.set(this.data, x); }
    get def() { return DEF.get(this.data); }
    set def(x) { DEF.set(this.data, x); }
    get level() { return LEVEL.get(this.data); }
    set level(x) { LEVEL.set(this.data, x); }
    get poison() { return !!POISON.get(this.data); }
    set poison(x) { POISON.set(this.data, x ? 1 : 0); }
    get child() { return CHILD.get(this.data); }
    set child(x) { CHILD.set(this.data, x); }
    get terrainSusceptibility() { return TERRAIN_SUSCEPTIBILITY.get(this.data); }
    set terrainSusceptibility(x) { TERRAIN_SUSCEPTIBILITY.set(this.data, x); }
    get immobile() { return !!IMMOBILE.get(this.data); }
    set immobile(x) { IMMOBILE.set(this.data, x ? 1 : 0); }
    get action() { return ACTION.get(this.data); }
    set action(x) { ACTION.set(this.data, x); }
    get replacement() { return REPLACEMENT.get(this.data); }
    set replacement(x) { REPLACEMENT.set(this.data, x); }
    get goldDrop() { return GOLD_DROP.get(this.data); }
    set goldDrop(x) { GOLD_DROP.set(this.data, x); }
    get elements() { return ELEMENTS.get(this.data); }
    set elements(x) { ELEMENTS.set(this.data, x); }
    get expReward() { return EXP_REWARD.get(this.data); }
    set expReward(x) { EXP_REWARD.set(this.data, x); }
    get attackType() { return ATTACK_TYPE.get(this.data); }
    set attackType(x) { ATTACK_TYPE.set(this.data, x); }
    get statusEffect() { return STATUS_EFFECT.get(this.data); }
    set statusEffect(x) { STATUS_EFFECT.set(this.data, x); }
    toString() {
        return super.toString() + (this.name ? ' ' + this.name : '');
    }
}
function prop(...spec) {
    return new Stat(...spec);
}
class Stat {
    constructor(...spec) {
        this.spec = spec;
    }
    get(data) {
        let value = 0;
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            value |= ((data[index] & mask) >>> rsh) << lsh;
        }
        return value;
    }
    set(data, value) {
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            const v = (value >>> lsh) << rsh & mask;
            data[index] = data[index] & ~mask | v;
        }
    }
}
const METASPRITE = prop([0x300]);
const SPEED = prop([0x340, 0xf]);
const COLLISION_PLANE = prop([0x3a0, 0xf0, 4]);
const HITBOX = prop([0x420, 0x40, 2], [0x3a0, 0x0f]);
const HP = prop([0x3c0]);
const ATK = prop([0x3e0]);
const DEF = prop([0x400]);
const LEVEL = prop([0x420, 0x1f]);
const POISON = prop([0x420, 0x80, 7]);
const CHILD = prop([0x440]);
const TERRAIN_SUSCEPTIBILITY = prop([0x460]);
const IMMOBILE = prop([0x4a0, 0x80, 7]);
const ACTION = prop([0x4a0, 0x7f]);
const REPLACEMENT = prop([0x4c0]);
const GOLD_DROP = prop([0x500, 0xf0, 4]);
const ELEMENTS = prop([0x500, 0xf]);
const EXP_REWARD = prop([0x520]);
const ATTACK_TYPE = prop([0x540]);
const STATUS_EFFECT = prop([0x560, 0xf]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0ZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vb2JqZWN0ZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJN0MsTUFBTSxPQUFPLFVBQVcsU0FBUSxNQUFNO0lBWXBDLFlBQVksTUFBZSxFQUFFLEVBQVU7UUFDckMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFIeEIsZUFBVSxHQUFlLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFJdEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUNuRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxDQUFDLENBQUMsQ0FB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QUFDLENBQUMsQ0FBQztJQUNwRCxJQUFJLEtBQUssQ0FBQyxDQUFTLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVqRCxJQUFJLGNBQWMsS0FBYSxPQUFPLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RSxJQUFJLGNBQWMsQ0FBQyxDQUFTLElBQUksZUFBZSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVwRSxJQUFJLE1BQU0sS0FBYSxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLE1BQU0sQ0FBQyxDQUFTLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVuRCxJQUFJLEVBQUUsS0FBYSxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5QyxJQUFJLEVBQUUsQ0FBQyxDQUFTLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUzQyxJQUFJLEdBQUcsS0FBYSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxJQUFJLEdBQUcsQ0FBQyxDQUFTLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU3QyxJQUFJLEdBQUcsS0FBYSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxJQUFJLEdBQUcsQ0FBQyxDQUFTLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU3QyxJQUFJLEtBQUssS0FBYSxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwRCxJQUFJLEtBQUssQ0FBQyxDQUFTLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVqRCxJQUFJLE1BQU0sS0FBYyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekQsSUFBSSxNQUFNLENBQUMsQ0FBVSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELElBQUksS0FBSyxLQUFhLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BELElBQUksS0FBSyxDQUFDLENBQVMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpELElBQUkscUJBQXFCLEtBQWEsT0FBTyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyRixJQUFJLHFCQUFxQixDQUFDLENBQVMsSUFBSSxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFbEYsSUFBSSxRQUFRLEtBQWMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdELElBQUksUUFBUSxDQUFDLENBQVUsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVoRSxJQUFJLE1BQU0sS0FBYSxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLE1BQU0sQ0FBQyxDQUFTLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVuRCxJQUFJLFdBQVcsS0FBYSxPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRSxJQUFJLFdBQVcsQ0FBQyxDQUFTLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU3RCxJQUFJLFFBQVEsS0FBYSxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMzRCxJQUFJLFFBQVEsQ0FBQyxDQUFTLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV4RCxJQUFJLFFBQVEsS0FBYSxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRCxJQUFJLFFBQVEsQ0FBQyxDQUFTLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUd2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RyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNuQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQ2xDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNwQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDbEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2R1bGUgfSBmcm9tICcuLi9hc20vbW9kdWxlLmpzJztcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnLi9sb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyByZWFkTGl0dGxlRW5kaWFuIH0gZnJvbSAnLi91dGlsLmpzJztcbmltcG9ydCB7IENvbnN0cmFpbnQgfSBmcm9tICcuL2NvbnN0cmFpbnQuanMnO1xuaW1wb3J0IHR5cGUgeyBPYmplY3RzIH0gZnJvbSAnLi9vYmplY3RzLmpzJztcblxuLy8gTk9URTogV291bGQgYmUgbmljZSB0byBjYWxsIHRoaXMgT2JqZWN0LCBidXQgdGhhdCBzZWVtcyBjb25mdXNpbmcuLi5cbmV4cG9ydCBjbGFzcyBPYmplY3REYXRhIGV4dGVuZHMgRW50aXR5IHtcblxuICB1c2VkOiBib29sZWFuO1xuICBuYW1lOiBzdHJpbmc7XG5cbiAgYmFzZTogbnVtYmVyO1xuXG4gIHNmeDogbnVtYmVyO1xuICBkYXRhOiBudW1iZXJbXTtcblxuICBjb25zdHJhaW50OiBDb25zdHJhaW50ID0gQ29uc3RyYWludC5BTEw7XG5cbiAgY29uc3RydWN0b3IocGFyZW50OiBPYmplY3RzLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocGFyZW50LnJvbSwgaWQpO1xuICAgIHBhcmVudFtpZF0gPSB0aGlzO1xuICAgIHRoaXMudXNlZCA9IHRydWU7XG4gICAgdGhpcy5uYW1lID0gJyc7XG4gICAgdGhpcy5iYXNlID0gcmVhZExpdHRsZUVuZGlhbih0aGlzLnJvbS5wcmcsIHRoaXMucG9pbnRlcikgKyAweDEwMDAwO1xuICAgIHRoaXMuc2Z4ID0gdGhpcy5yb20ucHJnW3RoaXMuYmFzZV07XG4gICAgdGhpcy5kYXRhID0gW107XG4gICAgbGV0IGEgPSB0aGlzLmJhc2UgKyAxO1xuICAgIGxldCBtID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMyOyBpKyspIHtcbiAgICAgIGlmICghKGkgJiA3KSkge1xuICAgICAgICBtID0gdGhpcy5yb20ucHJnW2ErK107XG4gICAgICB9XG4gICAgICB0aGlzLmRhdGEucHVzaChtICYgMHg4MCA/IHRoaXMucm9tLnByZ1thKytdIDogMCk7XG4gICAgICBtIDw8PSAxO1xuICAgIH1cbiAgfVxuXG4gIGdldCBwb2ludGVyKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIDB4MWFjMDAgKyAodGhpcy5pZCA8PCAxKTtcbiAgfVxuXG4gIC8vIFJldHVybnMgYSBieXRlIGFycmF5IGZvciB0aGlzIGVudHJ5XG4gIHNlcmlhbGl6ZSgpOiBudW1iZXJbXSB7XG4gICAgY29uc3Qgb3V0ID0gW3RoaXMuc2Z4XTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgY29uc3QgayA9IG91dC5sZW5ndGg7XG4gICAgICBvdXQucHVzaCgwKTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgODsgaisrKSB7XG4gICAgICAgIGlmICh0aGlzLmRhdGFbOCAqIGkgKyBqXSkge1xuICAgICAgICAgIG91dFtrXSB8PSAoMHg4MCA+Pj4gaik7XG4gICAgICAgICAgb3V0LnB1c2godGhpcy5kYXRhWzggKiBpICsgal0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB3cml0ZSh0aGlzOiBPYmplY3REYXRhKTogTW9kdWxlW10ge1xuICAgIGNvbnN0IG5hbWUgPSBgT2JqZWN0XyR7dGhpcy5pZC50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKX1gO1xuICAgIGNvbnN0IGEgPSB0aGlzLnJvbS5hc3NlbWJsZXIoKTtcbiAgICBhLnNlZ21lbnQoJzBkJyk7XG4gICAgYS5yZWxvYyhuYW1lKTtcbiAgICBjb25zdCBsYWJlbCA9IGEucGMoKTtcbiAgICBhLmJ5dGUoLi4udGhpcy5zZXJpYWxpemUoKSk7XG4gICAgYS5vcmcoMHhhYzAwICsgKHRoaXMuaWQgPDwgMSksIGAke25hbWV9X1B0cmApO1xuICAgIGEud29yZChsYWJlbCk7XG5cbiAgICAvLyBIYW5kbGUgc2xpbWUgdHJhbnNmb3JtYXRpb24uICBXZSBhc3N1bWUgYWxsIHNsaW1lcyBhcmUgaW52dWxuZXJhYmxlXG4gICAgLy8gdG8gdGhlIHNhbWUgZWxlbWVudCAocmVzY2FsZW1vbnN0ZXJzIGd1YXJhbnRlZXMgdGhpcywgYW55d2F5KS5cbiAgICBpZiAodGhpcyA9PT0gdGhpcy5yb20ub2JqZWN0cy5ibHVlU2xpbWUpIHtcbiAgICAgIC8vIEZpZ3VyZSBvdXQgd2hpY2ggYml0IGlzIHNldCAoZWxlbWVudHMgPSAxPDwoYi0xKSlcbiAgICAgIC8vIE5vdGUgdGhlIGV4dHJhIG9mZnNldCBpcyBkdWUgdG8gMCBiZWluZyBcIm5vIHN3b3JkIGVxdWlwcGVkXCJcbiAgICAgIGxldCBlID0gdGhpcy5lbGVtZW50cztcbiAgICAgIGxldCBiID0gMDtcbiAgICAgIHdoaWxlIChlKSB7XG4gICAgICAgIGUgPj49IDE7XG4gICAgICAgIGIrKztcbiAgICAgIH1cbiAgICAgIGEuc2VnbWVudCgnMWEnKTtcbiAgICAgIGEub3JnKDB4OTIyZCk7IC8vICQzNTIyZFxuICAgICAgYS5ieXRlKGIpO1xuICAgIH1cblxuICAgIC8vIEFkZCB0aGUgbmFtZSBvZiB0aGUgb2JqZWN0IHRvIHRoZSByb20gaW4gYSBzcGFyZSBiYW5rXG4gICAgYS5zZWdtZW50KCczYycpO1xuICAgIGEub3JnKDB4ODAwMCArICh0aGlzLmlkIDw8IDUpLCBgJHtuYW1lfV9TdHJgKTtcbiAgICBsZXQgb2JqTmFtZSA9IHRoaXMubmFtZS5zdWJzdHJpbmcoMCwyNyk7XG4gICAgYS5ieXRlKC4uLm9iak5hbWUpO1xuICAgIGEuYnl0ZSgweDliKTsgLy8gQ2xvc2luZyBicmFja2V0IGZvciByaWdodCBzaWRlIFtcbiAgICAvLyBmaWxsIHRoZSByZXN0IG9mIHRoZSBuYW1lIHdpdGggdGhlIHNwYWNlciB0aWxlIHNvIGl0IGxvb2tzIGxpa2UgJ05BTUVbPT09PSdcbiAgICBhLmJ5dGUoLi4uQXJyYXkoMjggLSAob2JqTmFtZS5sZW5ndGggKyAxKSkuZmlsbCgweDFjKSk7XG5cbiAgICByZXR1cm4gW2EubW9kdWxlKCldO1xuICB9XG5cbiAgZ2V0KGFkZHI6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVsoYWRkciAtIDB4MzAwKSA+Pj4gNV07XG4gIH1cblxuICBwYXJlbnRzKCk6IE9iamVjdERhdGFbXSB7XG4gICAgLy8gSWYgdGhpcyBpcyBhIHByb2plY3RpbGUgdGhhdCBpcyB0aGUgcGFyZW50IG9mIHNvbWUgbW9uc3RlcixcbiAgICAvLyByZXR1cm4gYW4gYXJyYXkgb2YgcGFyZW50cyB0aGF0IHNwYXduZWQgaXQuXG4gICAgcmV0dXJuIFtdO1xuICAgIC8vIHJldHVybiB0aGlzLnJvbS5tb25zdGVycy5maWx0ZXIoXG4gICAgLy8gICAgIChtOiBPYmplY3REYXRhKSA9PiBtLmNoaWxkICYmXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbS5hZEhvY1NwYXduc1ttLmNoaWxkXS5vYmplY3RJZCA9PT0gdGhpcy5pZCk7XG4gIH1cblxuICBzcGF3bmVkQ2hpbGQoKTogT2JqZWN0RGF0YXx1bmRlZmluZWQge1xuICAgIGNvbnN0IGhhc0NoaWxkID0gdGhpcy5yb20ub2JqZWN0QWN0aW9uc1t0aGlzLmFjdGlvbl0/LmRhdGEuaGFzQ2hpbGQ7XG4gICAgaWYgKCFoYXNDaGlsZCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBjb25zdCBzcGF3biA9IHRoaXMucm9tLmFkSG9jU3Bhd25zW3RoaXMuY2hpbGRdO1xuICAgIGNvbnN0IHNwYXduSWQgPSBzcGF3biAmJiBzcGF3bi5vYmplY3RJZDtcbiAgICBpZiAoc3Bhd25JZCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiB0aGlzLnJvbS5vYmplY3RzW3NwYXduSWRdO1xuICB9XG5cbiAgc3Bhd25lZFJlcGxhY2VtZW50KCk6IE9iamVjdERhdGF8dW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMucmVwbGFjZW1lbnQpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIHRoaXMucm9tLm9iamVjdHNbdGhpcy5yZXBsYWNlbWVudF07XG4gIH1cblxuICBsb2NhdGlvbnMoKTogTG9jYXRpb25bXSB7XG4gICAgLy8gVE9ETyAtIGhhbmRsZSBub24tbW9uc3RlciBOUENzLlxuICAgIHJldHVybiB0aGlzLnJvbS5sb2NhdGlvbnMuZmlsdGVyKChsOiBMb2NhdGlvbikgPT5cbiAgICAgICAgbC51c2VkICYmIGwuc3Bhd25zLnNvbWUoc3Bhd24gPT5cbiAgICAgICAgICAgIHNwYXduLmlzTW9uc3RlcigpICYmIHNwYXduLm1vbnN0ZXJJZCA9PT0gdGhpcy5pZCkpO1xuICB9XG5cbiAgcGFsZXR0ZXMoaW5jbHVkZUNoaWxkcmVuID0gZmFsc2UpOiBudW1iZXJbXSB7XG4gICAgLy8gTk9URTogdGhpcyBnZXRzIHRoZSB3cm9uZyByZXN1bHQgZm9yIGljZS9zYW5kIHpvbWJpZXMgYW5kIGJsb2JzLlxuICAgIC8vICAtIG1heSBqdXN0IG5lZWQgdG8gZ3Vlc3MvYXNzdW1lIGFuZCBleHBlcmltZW50P1xuICAgIC8vICAtIHpvbWJpZXMgKGFjdGlvbiAweDIyKSBsb29rIGxpa2Ugc2hvdWxkIGp1c3QgYmUgM1xuICAgIC8vICAtIGxhdmFtZW4vYmxvYnMgKGFjdGlvbiAweDI5KSBhcmUgMlxuICAgIC8vICAtIHdyYWl0aCBzaGFkb3dzIChhY3Rpb24gMHgyNikgYXJlIDNcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjIpIHJldHVybiBbM107IC8vIHpvbWJpZVxuICAgIGxldCBtZXRhc3ByaXRlSWQgPSB0aGlzLmRhdGFbMF07XG4gICAgaWYgKHRoaXMuYWN0aW9uID09PSAweDJhKSBtZXRhc3ByaXRlSWQgPSB0aGlzLmRhdGFbMzFdIHwgMTtcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjkpIG1ldGFzcHJpdGVJZCA9IDB4NmI7IC8vIGJsb2JcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjYpIG1ldGFzcHJpdGVJZCA9IDB4OWM7XG5cbiAgICBjb25zdCBtcyA9IHRoaXMucm9tLm1ldGFzcHJpdGVzW21ldGFzcHJpdGVJZF07XG4gICAgY29uc3QgY2hpbGRNcyA9XG4gICAgICAgIGluY2x1ZGVDaGlsZHJlbiAmJiB0aGlzLmNoaWxkID9cbiAgICAgICAgICAgIHRoaXMucm9tLm1ldGFzcHJpdGVzW1xuICAgICAgICAgICAgICAgIHRoaXMucm9tLm9iamVjdHNbXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm9tLmFkSG9jU3Bhd25zW3RoaXMuY2hpbGRdLm9iamVjdElkXS5kYXRhWzBdXSA6XG4gICAgICAgICAgICBudWxsO1xuICAgIGNvbnN0IHMgPSBuZXcgU2V0KFsuLi4obXM/LnBhbGV0dGVzKCkgPz8gW10pLFxuICAgICAgICAgICAgICAgICAgICAgICAuLi4oY2hpbGRNcz8ucGFsZXR0ZXMoKSA/PyBbXSldKTtcbiAgICByZXR1cm4gWy4uLnNdO1xuICB9XG5cbiAgLy8gMCBmb3Igd2luZCwgMSBmb3IgZmlyZSwgMiBmb3Igd2F0ZXIsIDMgZm9yIHRodW5kZXJcbiAgaXNWdWxuZXJhYmxlKGVsZW1lbnQ6IG51bWJlcikge1xuICAgIHJldHVybiAhKHRoaXMuZWxlbWVudHMgJiAoMSA8PCBlbGVtZW50KSk7XG4gIH1cblxuICBpc1NoYWRvdygpIHtcbiAgICAvLyBOT1RFOiBpbnRlcm5hbGx5IHRoZSBnYW1lIGNoZWNrcyB0aGF0IHRoZSBtZXRhc3ByaXRlXG4gICAgLy8gaXMgJGE3IChzZWUgJDM1MGYzKSwgYnV0IHdlJ2xsIGp1c3QgaGFyZGNvZGUuXG4gICAgcmV0dXJuIHRoaXMuaWQgPT09IDB4N2IgfHwgdGhpcy5pZCA9PT0gMHg4YztcbiAgfVxuXG4gIGdldCBtZXRhc3ByaXRlKCk6IG51bWJlciB7IHJldHVybiBNRVRBU1BSSVRFLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBtZXRhc3ByaXRlKHg6IG51bWJlcikgeyBNRVRBU1BSSVRFLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHNwZWVkKCk6IG51bWJlciB7IHJldHVybiBTUEVFRC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgc3BlZWQoeDogbnVtYmVyKSB7IFNQRUVELnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGNvbGxpc2lvblBsYW5lKCk6IG51bWJlciB7IHJldHVybiBDT0xMSVNJT05fUExBTkUuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGNvbGxpc2lvblBsYW5lKHg6IG51bWJlcikgeyBDT0xMSVNJT05fUExBTkUuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgaGl0Ym94KCk6IG51bWJlciB7IHJldHVybiBISVRCT1guZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGhpdGJveCh4OiBudW1iZXIpIHsgSElUQk9YLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGhwKCk6IG51bWJlciB7IHJldHVybiBIUC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgaHAoeDogbnVtYmVyKSB7IEhQLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGF0aygpOiBudW1iZXIgeyByZXR1cm4gQVRLLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBhdGsoeDogbnVtYmVyKSB7IEFUSy5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBkZWYoKTogbnVtYmVyIHsgcmV0dXJuIERFRi5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgZGVmKHg6IG51bWJlcikgeyBERUYuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgbGV2ZWwoKTogbnVtYmVyIHsgcmV0dXJuIExFVkVMLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBsZXZlbCh4OiBudW1iZXIpIHsgTEVWRUwuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgcG9pc29uKCk6IGJvb2xlYW4geyByZXR1cm4gISFQT0lTT04uZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IHBvaXNvbih4OiBib29sZWFuKSB7IFBPSVNPTi5zZXQodGhpcy5kYXRhLCB4ID8gMSA6IDApOyB9XG5cbiAgZ2V0IGNoaWxkKCk6IG51bWJlciB7IHJldHVybiBDSElMRC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgY2hpbGQoeDogbnVtYmVyKSB7IENISUxELnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHRlcnJhaW5TdXNjZXB0aWJpbGl0eSgpOiBudW1iZXIgeyByZXR1cm4gVEVSUkFJTl9TVVNDRVBUSUJJTElUWS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgdGVycmFpblN1c2NlcHRpYmlsaXR5KHg6IG51bWJlcikgeyBURVJSQUlOX1NVU0NFUFRJQklMSVRZLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGltbW9iaWxlKCk6IGJvb2xlYW4geyByZXR1cm4gISFJTU1PQklMRS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgaW1tb2JpbGUoeDogYm9vbGVhbikgeyBJTU1PQklMRS5zZXQodGhpcy5kYXRhLCB4ID8gMSA6IDApOyB9XG5cbiAgZ2V0IGFjdGlvbigpOiBudW1iZXIgeyByZXR1cm4gQUNUSU9OLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBhY3Rpb24oeDogbnVtYmVyKSB7IEFDVElPTi5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCByZXBsYWNlbWVudCgpOiBudW1iZXIgeyByZXR1cm4gUkVQTEFDRU1FTlQuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IHJlcGxhY2VtZW50KHg6IG51bWJlcikgeyBSRVBMQUNFTUVOVC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBnb2xkRHJvcCgpOiBudW1iZXIgeyByZXR1cm4gR09MRF9EUk9QLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBnb2xkRHJvcCh4OiBudW1iZXIpIHsgR09MRF9EUk9QLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGVsZW1lbnRzKCk6IG51bWJlciB7IHJldHVybiBFTEVNRU5UUy5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgZWxlbWVudHMoeDogbnVtYmVyKSB7IEVMRU1FTlRTLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgLyoqIFVucHJvY2Vzc2VkIGV4cGVyaWVuY2UgcmV3YXJkICgkNTIwLHgpLiAqL1xuICBnZXQgZXhwUmV3YXJkKCk6IG51bWJlciB7IHJldHVybiBFWFBfUkVXQVJELmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBleHBSZXdhcmQoeDogbnVtYmVyKSB7IEVYUF9SRVdBUkQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgYXR0YWNrVHlwZSgpOiBudW1iZXIgeyByZXR1cm4gQVRUQUNLX1RZUEUuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGF0dGFja1R5cGUoeDogbnVtYmVyKSB7IEFUVEFDS19UWVBFLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHN0YXR1c0VmZmVjdCgpOiBudW1iZXIgeyByZXR1cm4gU1RBVFVTX0VGRkVDVC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgc3RhdHVzRWZmZWN0KHg6IG51bWJlcikgeyBTVEFUVVNfRUZGRUNULnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHN1cGVyLnRvU3RyaW5nKCkgKyAodGhpcy5uYW1lID8gJyAnICsgdGhpcy5uYW1lIDogJycpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHByb3AoLi4uc3BlYzogW251bWJlciwgbnVtYmVyPywgbnVtYmVyP11bXSkge1xuICByZXR1cm4gbmV3IFN0YXQoLi4uc3BlYyk7XG59XG5cbmNsYXNzIFN0YXQge1xuICByZWFkb25seSBzcGVjOiBbbnVtYmVyLCBudW1iZXI/LCBudW1iZXI/XVtdO1xuXG4gIGNvbnN0cnVjdG9yKC4uLnNwZWM6IFtudW1iZXIsIG51bWJlcj8sIG51bWJlcj9dW10pIHtcbiAgICB0aGlzLnNwZWMgPSBzcGVjO1xuICB9XG5cbiAgZ2V0KGRhdGE6IG51bWJlcltdKSB7XG4gICAgbGV0IHZhbHVlID0gMDtcbiAgICBmb3IgKGNvbnN0IFthZGRyLCBtYXNrID0gMHhmZiwgc2hpZnQgPSAwXSBvZiB0aGlzLnNwZWMpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gKGFkZHIgLSAweDMwMCkgPj4+IDU7XG4gICAgICBjb25zdCBsc2ggPSBzaGlmdCA8IDAgPyAtc2hpZnQgOiAwO1xuICAgICAgY29uc3QgcnNoID0gc2hpZnQgPCAwID8gMCA6IHNoaWZ0O1xuICAgICAgdmFsdWUgfD0gKChkYXRhW2luZGV4XSAmIG1hc2spID4+PiByc2gpIDw8IGxzaDtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgc2V0KGRhdGE6IG51bWJlcltdLCB2YWx1ZTogbnVtYmVyKSB7XG4gICAgZm9yIChjb25zdCBbYWRkciwgbWFzayA9IDB4ZmYsIHNoaWZ0ID0gMF0gb2YgdGhpcy5zcGVjKSB7XG4gICAgICBjb25zdCBpbmRleCA9IChhZGRyIC0gMHgzMDApID4+PiA1O1xuICAgICAgY29uc3QgbHNoID0gc2hpZnQgPCAwID8gLXNoaWZ0IDogMDtcbiAgICAgIGNvbnN0IHJzaCA9IHNoaWZ0IDwgMCA/IDAgOiBzaGlmdDtcbiAgICAgIGNvbnN0IHYgPSAodmFsdWUgPj4+IGxzaCkgPDwgcnNoICYgbWFzaztcbiAgICAgIGRhdGFbaW5kZXhdID0gZGF0YVtpbmRleF0gJiB+bWFzayB8IHY7XG4gICAgfVxuICB9XG59XG5cbmNvbnN0IE1FVEFTUFJJVEUgPSBwcm9wKFsweDMwMF0pO1xuY29uc3QgU1BFRUQgPSBwcm9wKFsweDM0MCwgMHhmXSk7XG5jb25zdCBDT0xMSVNJT05fUExBTkUgPSBwcm9wKFsweDNhMCwgMHhmMCwgNF0pO1xuY29uc3QgSElUQk9YID0gcHJvcChbMHg0MjAsIDB4NDAsIDJdLCBbMHgzYTAsIDB4MGZdKTtcbmNvbnN0IEhQID0gcHJvcChbMHgzYzBdKTtcbmNvbnN0IEFUSyA9IHByb3AoWzB4M2UwXSk7XG5jb25zdCBERUYgPSBwcm9wKFsweDQwMF0pO1xuY29uc3QgTEVWRUwgPSBwcm9wKFsweDQyMCwgMHgxZl0pO1xuY29uc3QgUE9JU09OID0gcHJvcChbMHg0MjAsIDB4ODAsIDddKTtcbmNvbnN0IENISUxEID0gcHJvcChbMHg0NDBdKTsgLy8gYWQtaG9jIHNwYXduIGluZGV4XG5jb25zdCBURVJSQUlOX1NVU0NFUFRJQklMSVRZID0gcHJvcChbMHg0NjBdKTtcbmNvbnN0IElNTU9CSUxFID0gcHJvcChbMHg0YTAsIDB4ODAsIDddKTsgLy8gd2lsbCBub3QgYmUga25vY2tlZCBiYWNrXG5jb25zdCBBQ1RJT04gPSBwcm9wKFsweDRhMCwgMHg3Zl0pO1xuY29uc3QgUkVQTEFDRU1FTlQgPSBwcm9wKFsweDRjMF0pO1xuY29uc3QgR09MRF9EUk9QID0gcHJvcChbMHg1MDAsIDB4ZjAsIDRdKTtcbmNvbnN0IEVMRU1FTlRTID0gcHJvcChbMHg1MDAsIDB4Zl0pO1xuY29uc3QgRVhQX1JFV0FSRCA9IHByb3AoWzB4NTIwXSk7XG5jb25zdCBBVFRBQ0tfVFlQRSA9IHByb3AoWzB4NTQwXSk7XG5jb25zdCBTVEFUVVNfRUZGRUNUID0gcHJvcChbMHg1NjAsIDB4Zl0pO1xuIl19