import { MessageId } from './messageid.js';
import { Segment, free, readBigEndian, readLittleEndian, seq, tuple } from './util.js';
const { $0e, $fe, $ff } = Segment;
export var Sage;
(function (Sage) {
    Sage[Sage["TORNEL"] = 0] = "TORNEL";
    Sage[Sage["ZEBU"] = 1] = "ZEBU";
    Sage[Sage["ASINA"] = 2] = "ASINA";
    Sage[Sage["KENSU"] = 3] = "KENSU";
})(Sage || (Sage = {}));
export var DefaultMessage;
(function (DefaultMessage) {
    DefaultMessage[DefaultMessage["INSUFFICIENT_MAGIC"] = 0] = "INSUFFICIENT_MAGIC";
    DefaultMessage[DefaultMessage["FREE_MAGIC"] = 1] = "FREE_MAGIC";
    DefaultMessage[DefaultMessage["IGNORED"] = 2] = "IGNORED";
    DefaultMessage[DefaultMessage["DEFAULT"] = 3] = "DEFAULT";
})(DefaultMessage || (DefaultMessage = {}));
const RESULT_TABLE = 0x1c22f;
const VANILLA_LEVELS_TABLE = 0x1c213;
const VANILLA_LOCATION_TABLE = 0x1d8f4;
const VANILLA_MAIN_TABLE = 0x1d9f4;
const VANILLA_DEFAULTS_TABLE = 0x1da2c;
export class Telepathy {
    constructor(rom) {
        this.rom = rom;
        this.sages = seq(4, i => new SageData(this, i));
        this.resultTable = tuple(rom.prg, RESULT_TABLE, 64);
        if (rom.telepathyTablesAddress) {
            this.groupsByLocation = [];
            this.minimumLevels = [];
        }
        else {
            this.groupsByLocation = tuple(rom.prg, VANILLA_LOCATION_TABLE, 256);
            this.minimumLevels = tuple(rom.prg, VANILLA_LEVELS_TABLE, 7);
        }
    }
    write() {
        let table = this.rom.telepathyTablesAddress;
        const a = this.rom.assembler();
        a.segment($0e.name, $fe.name, $ff.name);
        if (table) {
            free(a, $0e, 0x98f4, 0x9b00);
            const mainTable = this.sages.map((sage, i) => {
                a.reloc(`Telepathy_Sage_${i}`);
                const pc = a.pc();
                a.byte(...sage.messageGroups[0].bytes());
                return pc;
            });
            a.org(0x822f, 'Telepathy_ResultTable');
            a.byte(...this.resultTable.map(x => x < 4 ? x : x >>> 1));
            a.reloc('TelepathyTable');
            a.export('TelepathyTable');
            a.label('TelepathyTable');
            a.word(...mainTable);
            for (let j = 1; j < 4; j++) {
                for (let i = 0; i < 4; i++) {
                    a.byte(...this.sages[i].defaultMessages[j].data);
                }
            }
        }
        else {
            free(a, $0e, 0x9a4c, 0x9b00);
            a.org(0x822f, 'Telepathy_ResultTable');
            a.byte(...this.resultTable);
            a.org(0x8213, 'Telepathy_LevelsTable');
            a.byte(...this.minimumLevels);
            a.org(0x98f4, 'Telepathy_LocationTable');
            a.byte(...this.groupsByLocation);
            a.org(0x9a2c, 'Telepathy_VanillaDefaultsTable');
            for (let j = 0; j < 4; j++) {
                for (let i = 0; i < 4; i++) {
                    const sage = this.sages[i];
                    a.byte(...sage.defaultMessages[j].data);
                }
            }
            const mainTable = [];
            for (let i = 0; i < 4; i++) {
                const sage = this.sages[i];
                for (let j = 0, len = sage.messageGroups.length; j < len; j++) {
                    a.reloc(`Telepathy_Sage_${i}_Group_${j}`);
                    mainTable[4 * j + i] = a.pc();
                    a.byte(...sage.messageGroups[j].bytes());
                }
            }
            a.org(0x99f4, 'Telepathy_VanillaMainTable');
            a.word(...mainTable);
        }
        return [a.module()];
    }
}
export class SageData {
    constructor(telepathy, sage) {
        this.telepathy = telepathy;
        this.sage = sage;
        const rom = telepathy.rom;
        let defs;
        let main;
        let count;
        if (rom.telepathyTablesAddress) {
            main = defs = rom.telepathyTablesAddress + 2 * sage;
            count = 1;
        }
        else {
            defs = VANILLA_DEFAULTS_TABLE + 2 * sage;
            main = VANILLA_MAIN_TABLE + 2 * sage;
            count = 7;
        }
        this.defaultMessages = seq(4, i => MessageId.from(rom.prg, defs + 8 * i));
        this.messageGroups = seq(count, i => TelepathyMessageGroup.from(rom.prg, main + 8 * i));
    }
}
export class TelepathyMessageGroup {
    constructor(messages) {
        this.messages = messages;
    }
    bytes() {
        const bytes = [];
        for (let i = 0, len = this.messages.length; i < len; i++) {
            const [f, m1, m2] = this.messages[i];
            let word = f >= 0 ? f : 0x2000 | ~f;
            if (i === len - 1)
                word |= 0x8000;
            if (m2)
                word |= 0x4000;
            bytes.push(word >>= 8, word & 0xff, ...m1.data, ...(m2 ? m2.data : []));
        }
        return bytes;
    }
    static from(data, address) {
        const group = new TelepathyMessageGroup([]);
        address = readLittleEndian(data, address) + 0x14000;
        let word = 0;
        while (!(word & 0x8000)) {
            word = readBigEndian(data, address);
            address += 2;
            let flag = word & 0x1fff;
            if (word & 0x2000)
                flag = ~flag;
            const message = [flag, MessageId.from(data, address)];
            address += 2;
            if (word & 0x4000) {
                message.push(MessageId.from(data, address));
                address += 2;
            }
            group.messages.push(message);
        }
        return group;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZXBhdGh5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS90ZWxlcGF0aHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3pDLE9BQU8sRUFBTyxPQUFPLEVBQUUsSUFBSSxFQUNuQixhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUV0RSxNQUFNLEVBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7QUFFaEMsTUFBTSxDQUFOLElBQVksSUFLWDtBQUxELFdBQVksSUFBSTtJQUNkLG1DQUFVLENBQUE7SUFDViwrQkFBVSxDQUFBO0lBQ1YsaUNBQVUsQ0FBQTtJQUNWLGlDQUFVLENBQUE7QUFDWixDQUFDLEVBTFcsSUFBSSxLQUFKLElBQUksUUFLZjtBQUVELE1BQU0sQ0FBTixJQUFZLGNBU1g7QUFURCxXQUFZLGNBQWM7SUFFeEIsK0VBQXNCLENBQUE7SUFFdEIsK0RBQXNCLENBQUE7SUFFdEIseURBQXNCLENBQUE7SUFFdEIseURBQXNCLENBQUE7QUFDeEIsQ0FBQyxFQVRXLGNBQWMsS0FBZCxjQUFjLFFBU3pCO0FBRUQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDO0FBUTdCLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDO0FBQ3JDLE1BQU0sc0JBQXNCLEdBQUcsT0FBTyxDQUFDO0FBQ3ZDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDO0FBQ25DLE1BQU0sc0JBQXNCLEdBQUcsT0FBTyxDQUFDO0FBRXZDLE1BQU0sT0FBTyxTQUFTO0lBUXBCLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElB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bmltcG9ydCB7TW9kdWxlfSBmcm9tICcuLi9hc20vbW9kdWxlLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtNZXNzYWdlSWR9IGZyb20gJy4vbWVzc2FnZWlkLmpzJztcbmltcG9ydCB7RGF0YSwgU2VnbWVudCwgZnJlZSxcbiAgICAgICAgcmVhZEJpZ0VuZGlhbiwgcmVhZExpdHRsZUVuZGlhbiwgc2VxLCB0dXBsZX0gZnJvbSAnLi91dGlsLmpzJztcblxuY29uc3QgeyQwZSwgJGZlLCAkZmZ9ID0gU2VnbWVudDtcblxuZXhwb3J0IGVudW0gU2FnZSB7XG4gIFRPUk5FTCA9IDAsXG4gIFpFQlUgICA9IDEsXG4gIEFTSU5BICA9IDIsXG4gIEtFTlNVICA9IDMsXG59XG5cbmV4cG9ydCBlbnVtIERlZmF1bHRNZXNzYWdlIHtcbiAgLy8gcHJvYmFibHkgdW51c2VkXG4gIElOU1VGRklDSUVOVF9NQUdJQyA9IDAsXG4gIC8vIG1lc3NhZ2UgZm9yIHJlc3RvcmluZyBNUFxuICBGUkVFX01BR0lDICAgICAgICAgPSAxLFxuICAvLyBzYWdlcyBpZ25vcmluZyB0aGUgcGxheWVyXG4gIElHTk9SRUQgICAgICAgICAgICA9IDIsXG4gIC8vIG5vIGluZm9ybWF0aW9uIChvciB1bmRlcmxldmVsZWQpXG4gIERFRkFVTFQgICAgICAgICAgICA9IDMsXG59XG5cbmNvbnN0IFJFU1VMVF9UQUJMRSA9IDB4MWMyMmY7XG5cbi8vIFRoZXNlIHRhYmxlcyBtYXkgYmUgbW92ZWQgaW4gdGhlIHJhbmRvbWl6ZWQgdmVyc2lvbi4gIFRoZSBsb2NhdGlvbnNcbi8vIGFuZCBsZXZlbHMgdGFibGVzIGFyZSBub3QgcmVsZXZhbnQsIHNvIHRoZXkncmUgcmVtb3ZlZCwgYWxvbmcgd2l0aFxuLy8gdGhlIHJlc3VsdC1tYXAgdGFibGUsIHdoaWNoIHdlIHNpbXBseSBhcHBseSBpbi1wbGFjZSB0byB0aGUgcmVzdWx0XG4vLyB0YWJsZSAod2hpY2ggaXMgbm90IG1vdmVkKS4gIEV2ZXJ5dGhpbmcgZWxzZSBpcyBjcnVuY2hlZCBkb3duIHRvXG4vLyBqdXN0IHRoZSBkZWZhdWx0cyB0YWJsZSwgYnkgcmVkdWNpbmcgdGhlIG1haW4gdGFibGUgaW50byBhIHNpbmdsZVxuLy8gbWVzc2FlIGdyb3VwIGFuZCBjcmFtbWluZyBpdCBpbnRvIHRoZSB1bnVzZWQgMCBzbG90LlxuY29uc3QgVkFOSUxMQV9MRVZFTFNfVEFCTEUgPSAweDFjMjEzO1xuY29uc3QgVkFOSUxMQV9MT0NBVElPTl9UQUJMRSA9IDB4MWQ4ZjQ7XG5jb25zdCBWQU5JTExBX01BSU5fVEFCTEUgPSAweDFkOWY0O1xuY29uc3QgVkFOSUxMQV9ERUZBVUxUU19UQUJMRSA9IDB4MWRhMmM7XG5cbmV4cG9ydCBjbGFzcyBUZWxlcGF0aHkge1xuXG4gIC8vIEluZGV4ZWQgYnkgU2FnZVxuICBzYWdlczogU2FnZURhdGFbXTtcbiAgZ3JvdXBzQnlMb2NhdGlvbjogbnVtYmVyW107XG4gIG1pbmltdW1MZXZlbHM6IG51bWJlcltdO1xuICByZXN1bHRUYWJsZTogbnVtYmVyW107XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICB0aGlzLnNhZ2VzID0gc2VxKDQsIGkgPT4gbmV3IFNhZ2VEYXRhKHRoaXMsIGkpKTtcbiAgICB0aGlzLnJlc3VsdFRhYmxlID0gdHVwbGUocm9tLnByZywgUkVTVUxUX1RBQkxFLCA2NCk7XG4gICAgaWYgKHJvbS50ZWxlcGF0aHlUYWJsZXNBZGRyZXNzKSB7XG4gICAgICB0aGlzLmdyb3Vwc0J5TG9jYXRpb24gPSBbXTtcbiAgICAgIHRoaXMubWluaW11bUxldmVscyA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmdyb3Vwc0J5TG9jYXRpb24gPSB0dXBsZShyb20ucHJnLCBWQU5JTExBX0xPQ0FUSU9OX1RBQkxFLCAyNTYpO1xuICAgICAgdGhpcy5taW5pbXVtTGV2ZWxzID0gdHVwbGUocm9tLnByZywgVkFOSUxMQV9MRVZFTFNfVEFCTEUsIDcpO1xuICAgIH1cbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBsZXQgdGFibGUgPSB0aGlzLnJvbS50ZWxlcGF0aHlUYWJsZXNBZGRyZXNzO1xuICAgIGNvbnN0IGEgPSB0aGlzLnJvbS5hc3NlbWJsZXIoKTtcbiAgICBhLnNlZ21lbnQoJDBlLm5hbWUsICRmZS5uYW1lLCAkZmYubmFtZSk7XG4gICAgaWYgKHRhYmxlKSB7IC8vIFRPRE8gLSB0aGlzIGlzIGFsd2F5cyBmYWxzeT8hP1xuICAgICAgZnJlZShhLCAkMGUsIDB4OThmNCwgMHg5YjAwKTtcbiAgICAgIC8vIHRlbGVwYXRoeSBub3JtYWxpemVkLCB3cml0ZSB0byBuZXcgbG9jYXRpb25cbiAgICAgIC8vIGFsc28sIGNydW5jaCBkb3duIHRoZSByZXN1bHRzLlxuXG4gICAgICBjb25zdCBtYWluVGFibGUgPSB0aGlzLnNhZ2VzLm1hcCgoc2FnZSwgaSkgPT4ge1xuICAgICAgICBhLnJlbG9jKGBUZWxlcGF0aHlfU2FnZV8ke2l9YCk7XG4gICAgICAgIGNvbnN0IHBjID0gYS5wYygpO1xuICAgICAgICBhLmJ5dGUoLi4uc2FnZS5tZXNzYWdlR3JvdXBzWzBdLmJ5dGVzKCkpO1xuICAgICAgICByZXR1cm4gcGM7XG4gICAgICB9KTtcblxuICAgICAgYS5vcmcoMHg4MjJmLCAnVGVsZXBhdGh5X1Jlc3VsdFRhYmxlJyk7XG4gICAgICBhLmJ5dGUoLi4udGhpcy5yZXN1bHRUYWJsZS5tYXAoeCA9PiB4IDwgNCA/IHggOiB4ID4+PiAxKSk7XG5cbiAgICAgIGEucmVsb2MoJ1RlbGVwYXRoeVRhYmxlJyk7XG4gICAgICBhLmV4cG9ydCgnVGVsZXBhdGh5VGFibGUnKTtcbiAgICAgIGEubGFiZWwoJ1RlbGVwYXRoeVRhYmxlJyk7XG4gICAgICBhLndvcmQoLi4ubWFpblRhYmxlKTtcbiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgNDsgaisrKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKC4uLnRoaXMuc2FnZXNbaV0uZGVmYXVsdE1lc3NhZ2VzW2pdLmRhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZyZWUoYSwgJDBlLCAweDlhNGMsIDB4OWIwMCk7XG4gICAgICBhLm9yZygweDgyMmYsICdUZWxlcGF0aHlfUmVzdWx0VGFibGUnKTtcbiAgICAgIGEuYnl0ZSguLi50aGlzLnJlc3VsdFRhYmxlKTtcbiAgICAgIGEub3JnKDB4ODIxMywgJ1RlbGVwYXRoeV9MZXZlbHNUYWJsZScpO1xuICAgICAgYS5ieXRlKC4uLnRoaXMubWluaW11bUxldmVscyk7XG4gICAgICBhLm9yZygweDk4ZjQsICdUZWxlcGF0aHlfTG9jYXRpb25UYWJsZScpO1xuICAgICAgYS5ieXRlKC4uLnRoaXMuZ3JvdXBzQnlMb2NhdGlvbik7XG5cbiAgICAgIGEub3JnKDB4OWEyYywgJ1RlbGVwYXRoeV9WYW5pbGxhRGVmYXVsdHNUYWJsZScpO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyBqKyspIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBjb25zdCBzYWdlID0gdGhpcy5zYWdlc1tpXTtcbiAgICAgICAgICBhLmJ5dGUoLi4uc2FnZS5kZWZhdWx0TWVzc2FnZXNbal0uZGF0YSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IG1haW5UYWJsZTogRXhwcltdID0gW107XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICBjb25zdCBzYWdlID0gdGhpcy5zYWdlc1tpXTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDAsIGxlbiA9IHNhZ2UubWVzc2FnZUdyb3Vwcy5sZW5ndGg7IGogPCBsZW47IGorKykge1xuICAgICAgICAgIGEucmVsb2MoYFRlbGVwYXRoeV9TYWdlXyR7aX1fR3JvdXBfJHtqfWApO1xuICAgICAgICAgIG1haW5UYWJsZVs0ICogaiArIGldID0gYS5wYygpO1xuICAgICAgICAgIGEuYnl0ZSguLi5zYWdlLm1lc3NhZ2VHcm91cHNbal0uYnl0ZXMoKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGEub3JnKDB4OTlmNCwgJ1RlbGVwYXRoeV9WYW5pbGxhTWFpblRhYmxlJyk7XG4gICAgICBhLndvcmQoLi4ubWFpblRhYmxlKTtcbiAgICB9XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2FnZURhdGEge1xuXG4gIC8vIEluZGV4ZWQgYnkgRGVmYXVsdE1lc3NhZ2VcbiAgZGVmYXVsdE1lc3NhZ2VzOiBNZXNzYWdlSWRbXTtcbiAgbWVzc2FnZUdyb3VwczogVGVsZXBhdGh5TWVzc2FnZUdyb3VwW107XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgdGVsZXBhdGh5OiBUZWxlcGF0aHksIHJlYWRvbmx5IHNhZ2U6IFNhZ2UpIHtcbiAgICBjb25zdCByb20gPSB0ZWxlcGF0aHkucm9tO1xuICAgIGxldCBkZWZzOiBudW1iZXI7XG4gICAgbGV0IG1haW46IG51bWJlcjtcbiAgICBsZXQgY291bnQ6IG51bWJlcjtcbiAgICBpZiAocm9tLnRlbGVwYXRoeVRhYmxlc0FkZHJlc3MpIHtcbiAgICAgIG1haW4gPSBkZWZzID0gcm9tLnRlbGVwYXRoeVRhYmxlc0FkZHJlc3MgKyAyICogc2FnZTtcbiAgICAgIGNvdW50ID0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVmcyA9IFZBTklMTEFfREVGQVVMVFNfVEFCTEUgKyAyICogc2FnZTtcbiAgICAgIG1haW4gPSBWQU5JTExBX01BSU5fVEFCTEUgKyAyICogc2FnZTtcbiAgICAgIGNvdW50ID0gNztcbiAgICB9XG4gICAgdGhpcy5kZWZhdWx0TWVzc2FnZXMgPSBzZXEoNCwgaSA9PiBNZXNzYWdlSWQuZnJvbShyb20ucHJnLCBkZWZzICsgOCAqIGkpKTtcbiAgICB0aGlzLm1lc3NhZ2VHcm91cHMgPSBzZXEoY291bnQsIGkgPT4gVGVsZXBhdGh5TWVzc2FnZUdyb3VwLmZyb20ocm9tLnByZywgbWFpbiArIDggKiBpKSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRlbGVwYXRoeU1lc3NhZ2VHcm91cCB7XG5cbiAgY29uc3RydWN0b3IocHVibGljIG1lc3NhZ2VzOiBbbnVtYmVyLCBNZXNzYWdlSWQsIE1lc3NhZ2VJZD9dW10pIHt9XG5cbiAgYnl0ZXMoKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IGJ5dGVzOiBudW1iZXJbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0aGlzLm1lc3NhZ2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjb25zdCBbZiwgbTEsIG0yXSA9IHRoaXMubWVzc2FnZXNbaV07XG4gICAgICBsZXQgd29yZCA9IGYgPj0gMCA/IGYgOiAweDIwMDAgfCB+ZjtcbiAgICAgIGlmIChpID09PSBsZW4gLSAxKSB3b3JkIHw9IDB4ODAwMDtcbiAgICAgIGlmIChtMikgd29yZCB8PSAweDQwMDA7XG4gICAgICBieXRlcy5wdXNoKHdvcmQgPj49IDgsIHdvcmQgJiAweGZmLCAuLi5tMS5kYXRhLCAuLi4obTIgPyBtMi5kYXRhIDogW10pKTtcbiAgICB9XG4gICAgcmV0dXJuIGJ5dGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb20oZGF0YTogRGF0YTxudW1iZXI+LCBhZGRyZXNzOiBudW1iZXIpOiBUZWxlcGF0aHlNZXNzYWdlR3JvdXAge1xuICAgIC8vIGFkZHJlc3MgcG9pbnRzIHRvIGRhdGEgdGFibGUgcG9pbnRlci5cbiAgICAvLyBmcm9tIHRoZXJlIHdlIHJlYWQgYWx0ZXJuYXRpbmcgZmxhZ3MgYW5kIG1lc3NhZ2UgSURzLlxuICAgIGNvbnN0IGdyb3VwID0gbmV3IFRlbGVwYXRoeU1lc3NhZ2VHcm91cChbXSk7XG4gICAgYWRkcmVzcyA9IHJlYWRMaXR0bGVFbmRpYW4oZGF0YSwgYWRkcmVzcykgKyAweDE0MDAwO1xuICAgIGxldCB3b3JkID0gMDtcbiAgICB3aGlsZSAoISh3b3JkICYgMHg4MDAwKSkge1xuICAgICAgd29yZCA9IHJlYWRCaWdFbmRpYW4oZGF0YSwgYWRkcmVzcyk7XG4gICAgICBhZGRyZXNzICs9IDI7XG4gICAgICBsZXQgZmxhZyA9IHdvcmQgJiAweDFmZmY7XG4gICAgICBpZiAod29yZCAmIDB4MjAwMCkgZmxhZyA9IH5mbGFnO1xuICAgICAgY29uc3QgbWVzc2FnZTogW251bWJlciwgTWVzc2FnZUlkLCBNZXNzYWdlSWQ/XSA9XG4gICAgICAgICAgW2ZsYWcsIE1lc3NhZ2VJZC5mcm9tKGRhdGEsIGFkZHJlc3MpXTtcbiAgICAgIGFkZHJlc3MgKz0gMjtcbiAgICAgIGlmICh3b3JkICYgMHg0MDAwKSB7XG4gICAgICAgIG1lc3NhZ2UucHVzaChNZXNzYWdlSWQuZnJvbShkYXRhLCBhZGRyZXNzKSk7XG4gICAgICAgIGFkZHJlc3MgKz0gMjtcbiAgICAgIH1cbiAgICAgIGdyb3VwLm1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7XG4gICAgfVxuICAgIHJldHVybiBncm91cDtcbiAgfVxufVxuIl19