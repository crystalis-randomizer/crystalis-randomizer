import { Entity } from './entity.js';
import { MessageId } from './messageid.js';
import { addr, hex, readBigEndian } from './util.js';
const UNUSED_TRIGGERS = new Set([
    0x83, 0x87, 0x88, 0x89, 0x8f, 0x93, 0x96, 0x98, 0x9b, 0x9c, 0x9d, 0x9e, 0x9f,
    0xaa, 0xb3, 0xb5, 0xb9, 0xbe, 0xc0,
]);
export class Trigger extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.used = !UNUSED_TRIGGERS.has(id);
        this.pointer = 0x1e17a + ((id & 0x7f) << 1);
        this.base = addr(rom.prg, this.pointer, 0x14000);
        this.conditions = [];
        this.message = MessageId.of({});
        this.flags = [];
        let word;
        let i = this.base;
        do {
            word = readBigEndian(rom.prg, i);
            const flag = word & 0x0fff;
            this.conditions.push(word & 0x2000 ? ~flag : flag);
            i += 2;
        } while (!(word & 0x8000));
        this.message = MessageId.from(rom.prg, i);
        do {
            i += 2;
            word = readBigEndian(rom.prg, i);
            const flag = word & 0x0fff;
            this.flags.push(word & 0x8000 ? ~flag : flag);
        } while (!(word & 0x4000));
    }
    bytes() {
        const bytes = [];
        if (!this.conditions.length)
            this.conditions.push(~0);
        for (let i = 0; i < this.conditions.length; i++) {
            let word = this.conditions[i];
            if (word < 0)
                word = ~word | 0x2000;
            if (i === this.conditions.length - 1)
                word = word | 0x8000;
            bytes.push(word >>> 8, word & 0xff);
        }
        bytes.push(...this.message.data);
        if (!this.flags.length)
            this.flags.push(~0);
        for (let i = 0; i < this.flags.length; i++) {
            let word = this.flags[i];
            if (word < 0)
                word = ~word | 0x8000;
            if (i === this.flags.length - 1)
                word = word | 0x4000;
            bytes.push(word >>> 8, word & 0xff);
        }
        return bytes;
    }
    write() {
        if (!this.used)
            return [];
        const a = this.rom.assembler();
        const name = `Trigger_${hex(this.id)}`;
        a.segment('0f');
        a.reloc(name);
        const addr = a.pc();
        a.byte(...this.bytes());
        a.org(0xa17a + 2 * (this.id & 0x7f), name + '_Ptr');
        a.word(addr);
        return [a.module()];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpZ2dlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vdHJpZ2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6QyxPQUFPLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFbkQsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDOUIsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtJQUNsRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUk7Q0FFN0MsQ0FBQyxDQUFDO0FBTUgsTUFBTSxPQUFPLE9BQVEsU0FBUSxNQUFNO0lBYWpDLFlBQVksR0FBUSxFQUFFLEVBQVU7UUFHOUIsS0FBSyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFP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S0FBSyxDQUFDLElBQUksQ0FBRSxJQUFJLEtBQUssQ0FBQyxFQUFFLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztTQUN0QztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQy9CLE1BQU0sSUFBSSxHQUFHLFdBQVcsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNkLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNwQixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFDcEQsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNiLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUd0QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge01lc3NhZ2VJZH0gZnJvbSAnLi9tZXNzYWdlaWQuanMnO1xuaW1wb3J0IHthZGRyLCBoZXgsIHJlYWRCaWdFbmRpYW59IGZyb20gJy4vdXRpbC5qcyc7XG5cbmNvbnN0IFVOVVNFRF9UUklHR0VSUyA9IG5ldyBTZXQoW1xuICAweDgzLCAweDg3LCAweDg4LCAweDg5LCAweDhmLCAweDkzLCAweDk2LCAweDk4LCAweDliLCAweDljLCAweDlkLCAweDllLCAweDlmLFxuICAvKjB4YTAsKi8gMHhhYSwgMHhiMywgMHhiNSwgMHhiOSwgMHhiZSwgMHhjMCwgLy8gYzIgaXMgbGFzdCBvbmVcbiAgLy8gTk9URTogYjMgaXMgb25seSB1bnVzZWQgYWZ0ZXIgZGV0ZXJtaW5pc3RpYyBwcmUtcGFyc2UgZGVsZXRlcyBpdC5cbl0pO1xuXG5leHBvcnQgbmFtZXNwYWNlIFRyaWdnZXIge1xuICBleHBvcnQgdHlwZSBDdXN0b20gPSAnbWV6YW1lJ3wnem9tYmllIHdhcnAnO1xufVxuXG5leHBvcnQgY2xhc3MgVHJpZ2dlciBleHRlbmRzIEVudGl0eSB7XG5cbiAgdXNlZDogYm9vbGVhbjtcbiAgcG9pbnRlcjogbnVtYmVyO1xuICBiYXNlOiBudW1iZXI7XG5cbiAgLy8gTGlzdCBvZiBmbGFncyB0byBjaGVjazogcG9zaXRpdmUgbWVhbnMgXCJtdXN0IGJlIHNldFwiXG4gIGNvbmRpdGlvbnM6IG51bWJlcltdO1xuICAvLyBNZXNzYWdlIHNob3duLCBhY3Rpb24gcnVuXG4gIG1lc3NhZ2U6IE1lc3NhZ2VJZDtcbiAgLy8gTGlzdCBvZiBmbGFncyB0byBzZXQvY2xlYXI6IHBvc2l0aXZlIG1lYW5zIHRvIHNldCBpdC5cbiAgZmxhZ3M6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgLy8gVE9ETyAtIGNvbnNpZGVyIHB1bGxpbmcgdGhpcyBvdXQgaW50byBzdGF0aWMgZnJvbUJ5dGVzKCkgbWV0aG9kP1xuICAgIC8vICAgICAgICAtIHN0aWxsIG5lZWQvd2FudCB0aGUgUm9tIHJlZmVyZW5jZSBpbiB0aGF0IGNhc2U/ICBubyBpZD9cbiAgICBzdXBlcihyb20sIGlkKTtcbiAgICB0aGlzLnVzZWQgPSAhVU5VU0VEX1RSSUdHRVJTLmhhcyhpZCk7IC8vIG5lZWQgdG8gc2V0IG1hbnVhbGx5XG4gICAgdGhpcy5wb2ludGVyID0gMHgxZTE3YSArICgoaWQgJiAweDdmKSA8PCAxKTtcbiAgICB0aGlzLmJhc2UgPSBhZGRyKHJvbS5wcmcsIHRoaXMucG9pbnRlciwgMHgxNDAwMCk7XG4gICAgdGhpcy5jb25kaXRpb25zID0gW107XG4gICAgdGhpcy5tZXNzYWdlID0gTWVzc2FnZUlkLm9mKHt9KTtcbiAgICB0aGlzLmZsYWdzID0gW107XG4gICAgbGV0IHdvcmQ7XG4gICAgbGV0IGkgPSB0aGlzLmJhc2U7XG4gICAgZG8ge1xuICAgICAgLy8gTk9URTogdGhpcyBieXRlIG9yZGVyIGlzIGludmVyc2UgZnJvbSBub3JtYWwuXG4gICAgICB3b3JkID0gcmVhZEJpZ0VuZGlhbihyb20ucHJnLCBpKTtcbiAgICAgIGNvbnN0IGZsYWcgPSB3b3JkICYgMHgwZmZmO1xuICAgICAgdGhpcy5jb25kaXRpb25zLnB1c2god29yZCAmIDB4MjAwMCA/IH5mbGFnIDogZmxhZyk7XG4gICAgICBpICs9IDI7XG4gICAgfSB3aGlsZSAoISh3b3JkICYgMHg4MDAwKSk7XG4gICAgdGhpcy5tZXNzYWdlID0gTWVzc2FnZUlkLmZyb20ocm9tLnByZywgaSk7XG4gICAgZG8ge1xuICAgICAgaSArPSAyO1xuICAgICAgd29yZCA9IHJlYWRCaWdFbmRpYW4ocm9tLnByZywgaSk7XG4gICAgICBjb25zdCBmbGFnID0gd29yZCAmIDB4MGZmZjtcbiAgICAgIHRoaXMuZmxhZ3MucHVzaCh3b3JkICYgMHg4MDAwID8gfmZsYWcgOiBmbGFnKTtcbiAgICB9IHdoaWxlICghKHdvcmQgJiAweDQwMDApKTtcbiAgICAvLyBjb25zb2xlLmxvZyhgVHJpZ2dlciAkJHt0aGlzLmlkLnRvU3RyaW5nKDE2KX06IGJ5dGVzOiAkJHtcbiAgICAvLyAgICAgICAgICAgICAgdGhpcy5ieXRlcygpLm1hcCh4PT54LnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLDApKS5qb2luKCcgJyl9YCk7XG4gIH1cblxuICBieXRlcygpOiBudW1iZXJbXSB7XG4gICAgY29uc3QgYnl0ZXMgPSBbXTtcbiAgICBpZiAoIXRoaXMuY29uZGl0aW9ucy5sZW5ndGgpIHRoaXMuY29uZGl0aW9ucy5wdXNoKH4wKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29uZGl0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHdvcmQgPSB0aGlzLmNvbmRpdGlvbnNbaV07XG4gICAgICBpZiAod29yZCA8IDApIHdvcmQgPSB+d29yZCB8IDB4MjAwMDtcbiAgICAgIGlmIChpID09PSB0aGlzLmNvbmRpdGlvbnMubGVuZ3RoIC0gMSkgd29yZCA9IHdvcmQgfCAweDgwMDA7XG4gICAgICBieXRlcy5wdXNoKHdvcmQgPj4+IDgsIHdvcmQgJiAweGZmKTtcbiAgICB9XG4gICAgYnl0ZXMucHVzaCguLi50aGlzLm1lc3NhZ2UuZGF0YSk7XG4gICAgaWYgKCF0aGlzLmZsYWdzLmxlbmd0aCkgdGhpcy5mbGFncy5wdXNoKH4wKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmxhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCB3b3JkID0gdGhpcy5mbGFnc1tpXTtcbiAgICAgIGlmICh3b3JkIDwgMCkgd29yZCA9IH53b3JkIHwgMHg4MDAwO1xuICAgICAgaWYgKGkgPT09IHRoaXMuZmxhZ3MubGVuZ3RoIC0gMSkgd29yZCA9IHdvcmQgfCAweDQwMDA7XG4gICAgICBieXRlcy5wdXNoKCB3b3JkID4+PiA4LCB3b3JkICYgMHhmZik7XG4gICAgfVxuICAgIHJldHVybiBieXRlcztcbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBpZiAoIXRoaXMudXNlZCkgcmV0dXJuIFtdO1xuICAgIGNvbnN0IGEgPSB0aGlzLnJvbS5hc3NlbWJsZXIoKTtcbiAgICBjb25zdCBuYW1lID0gYFRyaWdnZXJfJHtoZXgodGhpcy5pZCl9YDtcbiAgICBhLnNlZ21lbnQoJzBmJyk7XG4gICAgYS5yZWxvYyhuYW1lKTtcbiAgICBjb25zdCBhZGRyID0gYS5wYygpO1xuICAgIGEuYnl0ZSguLi50aGlzLmJ5dGVzKCkpO1xuICAgIGEub3JnKDB4YTE3YSArIDIgKiAodGhpcy5pZCAmIDB4N2YpLCBuYW1lICsgJ19QdHInKTtcbiAgICBhLndvcmQoYWRkcik7XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgICAgIC8vIFRPRE8gLSBuZWVkIHRvIGhpdCB0ZWxlcGF0aHksIG5wYyBzcGF3bnMsIGRpYWxvZ3MsIGl0ZW1nZXRcbiAgICAgIC8vIChjaGVja2JlbG93Ym9zcykgYXMgd2VsbCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoaXMhXG4gIH1cbn1cbiJdfQ==