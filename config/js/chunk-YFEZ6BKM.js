import{$ as wt,A as us,B as hs,C as ms,D as ae,E as re,F as en,G as ps,H as yt,I as ce,J as ir,K as Be,L as tn,M as or,N as _e,O as St,P as Ce,Q as gs,R as et,S as ar,T as lt,U as xs,V as bs,W as V,X as ta,Y as Ae,Z as nn,_ as lr,a as er,aa as zt,b as H,ba as na,c as le,ca as dr,d as Zt,da as Ke,e as Bt,ea as ra,f as tr,fa as Le,g as is,ga as sa,h as Wt,ha as ys,i as nr,ia,j as rr,ja as Ss,ka as ws,l as de,la as rn,m as Ht,n as os,na as Es,o as as,oa as Ts,p as Yo,q as sr,qa as oa,r as Jo,s as Xo,t as ls,u as Qo,v as ds,w as Zo,x as cs,y as ea,z as fs}from"./chunk-2QNVB4DA.js";import{b as v}from"./chunk-PIDEUWOP.js";var sn,aa,la,on,Cs=v(()=>{aa=()=>{let s;sn=new Uint32Array(256);for(let t=0;t<256;t++){s=t;for(let e=0;e<8;e++)s=s&1?3988292384^s>>>1:s>>>1;sn[t]=s}},la=s=>s.split("").map(t=>t.charCodeAt(0)),on=s=>{sn||aa(),typeof s=="string"&&(s=la(s));let t=-1;for(let e=0,n=s.length;e<n;e++)t=t>>>8^sn[(t^s[e])&255];return(t^-1)>>>0}});function Rs(s){let t={};return s[1]!=null&&(t.alias=s[1]),s[2]!=null&&(t.default=s[2]),s[3]!=null&&(t.preset=s[3]),s[4]!=null&&(t.generatorOnly=s[4]),s[5]!=null&&(t.unscriptable=s[5]),s[6]!=null&&(t.range=s[6]),s[7]!=null&&(t.key=s[7]),s[8]!=null&&(t.hidden=s[8]),s[9]!=null&&(t.group=s[9]),t}function Ms(s){let t={};return s[1]!=null&&(t.alias=s[1]),t}function Et(s){return s.replace(/[^a-z0-9]/ig,"").toLowerCase()}var Is=v(()=>{});function an(s,t=[],e=0){if(typeof s=="boolean"&&(s=Number(s)),!Number.isSafeInteger(s))throw new Error(`not an int: ${s}`);do{let n=s%128;s=Math.floor(s/128),s&&(n|=128),t[e instanceof Tt?e.getAndIncrement():e++]=n}while(s);return t}function ln(s,t=0){let e=0,n=1,r;do r=s[t instanceof Tt?t.getAndIncrement():t++],e+=(r&127)*n,n*=128;while(r!=null&&r&128);return e}var Tt,ks=v(()=>{Tt=class{constructor(t=0){this.index=t}getAndIncrement(){return this.index++}get(){return this.index}advance(t){this.index+=t}}});function vs(s){let t=[];for(let e of s){let n=e.id*8+e.type;an(n,t,t.length),e.type===2?(an(e.data.length,t,t.length),t.push(...e.data)):e.type===0?an(e.data,t,t.length):(Os.setFloat32(0,e.data,!0),t.push(Ct[0],Ct[1],Ct[2],Ct[3]))}return Uint8Array.from(t)}function Ns(s){let t=[],e=new Tt;for(;e.get()<s.length;){let n=ln(s,e),r=n&7,i=(n-r)/8,o;if(r===0)o=ln(s,e);else if(r===2){let a=ln(s,e),l=e.get();o=s.subarray(l,l+a),e.advance(a)}else{let a=e.get();Ct.set(s.subarray(a,a+4)),o=Os.getFloat32(0,!0),e.advance(4)}t.push({id:i,type:r,data:o})}return t}function ye(s,t,e,n){return s.descriptor=new cn(e,t,s,n),s}function Se(s,t,e,n,r){let i=new qt(s,r,t,e,n);t.descriptor=i,e.messageCtor=t;for(let o of i.fieldsById.values())t[o.name]=o}function da(s){return s instanceof qt||s instanceof cn}function dn(s,t,e){let n=ua.get(t);if(n)return n instanceof Vt&&e.range?n.withRange(e.range):n;let r=t.split("."),i=s.resolve(r[0]);for(let o of r.slice(1)){if(!(i instanceof qt))throw new Error("not a namespace");if(i=i.nested.get(o),!i)throw new Error(`unknown type: ${t}`)}if(!da(i))throw new Error(`not a type: ${t}`);return i}var Ct,Os,_s,As,z,Ut,he,me,qt,cr,cn,fr,Rt,ur,hr,mr,Vt,fn,pr,gr,ca,fa,ua,un,hn=v(()=>{Is();ks();Ct=new Uint8Array(8),Os=new DataView(Ct.buffer),_s=new TextDecoder,As=new TextEncoder,z=class s{constructor(t){this.script=t}static fromRecord(t){return new s(_s.decode(t.data).substring(1))}toRecord(t){let e=As.encode("="+this.script);return{id:t,data:e,type:2}}};Ut=class{constructor(t,e,n=e?.presetMap??new Map){this.name=t;this.parent=e;this.presetMap=n;this.nested=new Map;e&&e.nested.set(t,this)}resolve(t){let e=this.nested.get(t);if(e)return e;if(!this.parent)throw new Error(`unknown type: ${t}`);return this.parent.resolve(t)}},he=class{constructor(){new.target.descriptor.initInstance(this)}toBinary(){return this.constructor.descriptor.toBinary(this)}toJson(){return this.constructor.descriptor.toJson(this)}static finish(){this.descriptor.finish();for(let t of this.descriptor.fieldsById.values())this[t.name]=t}},me=class{constructor(){this.messageCtor=this.constructor.messageCtor;this.descriptor=this.messageCtor.descriptor}toBinary(){return this.messageCtor.descriptor.toBinary(this)}static fromBinary(t){let e=new this;return this.messageCtor.descriptor.mergeBinary(e,t),e}toJson(){return this.descriptor.toJson(this)}static fromJson(t){let e=new this;return this.messageCtor.descriptor.mergeJson(e,t),e}generate(t){return this.descriptor.generate(this,t)}};qt=class s extends Ut{constructor(e,n,r,i,o){super(e,o);this.messageCtor=r;this.generatorCtor=i;this.scriptable=!1;let a=new Map,l=new Map;for(let[c,d]of Object.entries(n.fields||{})){let f=Rt.of(c,d,this);a.set(f.id,f),l.set(Et(c),f);for(let u of f.options.alias||[])l.set(Et(u),f)}this.fieldsById=a,this.fieldsByCanonicalizedName=l}get groups(){if(this._groups==null){let e=new Map;for(let n of this.fieldsById.values()){let r=n.group;if(r==null)continue;let i=e.get(r[0]);i==null&&e.set(r[0],i=[this.fieldsById.get(r[0])]),i.push(n)}this._groups=[...e.values()]}return this._groups}initInstance(e){for(let n of this.fieldsById.values())e instanceof this.messageCtor&&n.options.generatorOnly||(e[n.name]=n.init())}mergeBinary(e,n){for(let r of Ns(n)){let i=this.fieldsById.get(r.id);if(!i)throw new Error("unknown field");e instanceof this.messageCtor&&i.options.generatorOnly||(e[i.name]=i.isScriptRecord(r)?z.fromRecord(r):i.append(e[i.name]??i.init(),i.type.fromRecord(r)))}}toBinary(e){let n=[],r=[...this.fieldsById.keys()].sort((i,o)=>i-o);for(let i of r){let o=this.fieldsById.get(i),a=e[o.name];for(let l of o.entries(a))n.push(l instanceof z?l.toRecord(o.id):o.type.toRecord(o.id,l))}return vs(n)}fromRecord(e){if(e.type!==2)throw new Error("unexpected type");let n=new this.generatorCtor;return this.mergeBinary(n,e.data),n}toRecord(e,n){return{id:e,type:2,data:this.toBinary(n)}}fromJson(e){let n=new this.generatorCtor;return this.mergeJson(n,e),n}mergeJson(e,n){if(typeof n!="object"||!n)throw new Error("bad object");for(let[r,i]of Object.entries(n)){let o=this.fieldsByCanonicalizedName.get(Et(r));if(!o)throw new Error(`unknown field: ${r}`);e[o.name]=o.isScriptJson(i)?new z(i.substring(1)):o.fromJson(i)}}toJson(e){let n={};for(let r of this.fieldsByCanonicalizedName.values()){let i=e[r.name];n[r.name]=i instanceof z?"="+i.script:r.toJson(i)}return n}generate(e,n,r){let i=e||{},o=new this.messageCtor,a=this.fieldsByCanonicalizedName.get("scripts"),l=this.fieldsByCanonicalizedName.get("presets");if(a&&Array.isArray(i.scripts))for(let f of i.scripts)n.evaluate(f,a);if(l&&Array.isArray(i.presets))for(let f of i.presets)n.addPreset(f);let c=new Set;for(let[f,...u]of this.groups){c.add(f.name);let h=n.getPreset(f)??f.init();if(h=i[f.name]??h,h!=null&&(h instanceof z&&(h=n.evaluate(h.script,f)),!!h))for(let m of u){c.add(m.name);let g=m.group[1];g instanceof z&&(g=n.evaluate(g.script,m)),o[m.name]=g}}let d=this.fieldsByCanonicalizedName.get("options");if(d&&!r){if(!(d.type instanceof s))throw new Error("bad options field");if(d.isRepeated()||d.isMap())throw new Error("bad options field");let f=i[d.name];r=o[d.name]=d.type.generate(f,n.newEvaluator())}for(let f of this.fieldsById.values()){if(c.has(f.name)||f.name==="options")continue;let u=r?.[f.name];if(o[f.name]=n.getPreset(f)??f.init(),!(f.name==="scripts"||f.name==="presets"))if(f.isRepeated()){let h=i[f.name];if(h==null)continue;if(!Array.isArray(h))throw new Error("bad value");for(let m of h)m instanceof z&&(m=n.evaluate(m.script,f)),f.type instanceof s&&(m=f.type.generate(m,n)),m!=null&&o[f.name].push(m)}else if(f.isMap()){let h=i[f.name];if(h==null)continue;if(!(h instanceof Map))throw new Error("bad value");for(let[m,g]of h){m instanceof z&&(m=n.evaluate(m.script,f)),g instanceof z&&(g=n.evaluate(g.script,f));let x=f.type.valueType;g&&x instanceof s&&(g=x.generate(g,n)),!(m==null||g==null)&&o[f.name].set(m,g)}}else{let h=i[f.name]??u;f.type instanceof s&&(h=f.type.generate(h,n,u)),h instanceof z&&(h=n.evaluate(h.script,f)),h!=null&&(o[f.name]=h)}}return o}};cr=class{constructor(t,e){this.keyType=t;this.valueType=e;this.scriptable=!1;this.name=`map<${t.name}, ${e.name}>`}fromRecord(t){if(t.type!==2)throw new Error("unexpected type");let e=Ns(t.data),n=[];for(let r of e)r.id===1?n[0]=this.keyType.fromRecord(r):r.id===2&&(n[1]=this.valueType.fromRecord(r));if(n[0]==null)throw new Error("missing key");if(n[1]==null)throw new Error("missing value");return n}toRecord(t,e){let n=[this.keyType.toRecord(1,e[0]),this.valueType.toRecord(2,e[1])];return{id:t,data:vs(n),type:2}}fromJson(t){if(!Array.isArray(t))throw new Error("bad map entry");if(t.length!==2)throw new Error("bad map entry");return[this.keyType.fromJson(t[0]),this.valueType.fromJson(t[1])]}toJson(t){return[this.keyType.toJson(t[0]),this.valueType.toJson(t[1])]}},cn=class{constructor(t,e,n,r){this.name=t;this.obj=e;this.parent=r;this.scriptable=!0;r.nested.set(t,this);let i=new Map,o=new Map,a=[];for(let[l,c]of Object.entries(n)){let d=e.comments?.[c]||"",f=e.valuesOptions?.[c]||{},u=new fr(l,c,d,Ms(f));for(let h of[l,...u.aliases]){let m=Et(h);if(i.has(m))throw new Error(`duplicate alias: ${h}`);i.set(m,u)}o.set(c,u),a.push(u)}this.valuesByCanonicalName=i,this.valuesById=o,this.values=a}fromRecord(t){if(t.type!==0)throw new Error(`unexpected type for ${this.name}: ${t.type}`);return t.data}toRecord(t,e){return{id:t,data:e,type:0}}fromJson(t){if(typeof t=="number")return t;if(typeof t!="string")throw new Error("bad enum value");if(/^\d+$/.test(t))return Number(t);let e=Et(t),n=this.valuesByCanonicalName.get(e);if(n==null)throw new Error(`unknown enum value: ${t}`);return n.value}toJson(t){let e=this.valuesById.get(t);if(!e)throw new Error(`unknown enum value: ${t}`);return e.name}pick(t){return this.values[Math.floor(t()*this.values.length)].value}},fr=class{constructor(t,e,n,r){this.name=t;this.value=e;this.comment=n;this.options=r;this.aliases=r.alias||[]}},Rt=class{constructor(t,e,n){this.name=t;this.parent=n;this._type=void 0;this._group=void 0;this._presets=void 0;this._default=void 0;let r=this.options=Rs(e.options||{});this.id=e.id,this.range=r.range,this.typeName=e.type,this.keyTypeName=e.keyType}static of(t,e,n){return e.rule==="repeated"?new hr(t,e,n):e.keyType?new mr(t,e,n):new ur(t,e,n)}get type(){return this._type??(this._type=this.makeType())}get group(){return this._group===void 0&&(this._group=this.options.group?[this.options.group[0],this.fromJson(this.options.group[1])]:null),this._group}get preset(){if(this._presets===void 0){this._presets={};for(let[t,e]of Object.entries(this.options.preset||{})){this.isScriptable()&&typeof e=="string"&&e[0]==="="?this._presets[t]=new z(e.substring(1)):this._presets[t]=this.fromJson(e);let n=this.parent.presetMap.get(Number(t));n!=null&&(this._presets[n]=this._presets[t])}}return this._presets}get default(){if(this._default!==void 0)return this._default;let t=this.options.default;return t==null?this._default=null:this.isScriptable()&&typeof t=="string"&&t[0]==="="?this._default=new z(t.substring(1)):this._default=this.fromJson(t)}isScriptable(){return this.type.scriptable&&!this.options.unscriptable}isScriptRecord(t){return this.isScriptable()&&t.type===2&&t.data[0]===61}isScriptJson(t){return this.isScriptable()&&typeof t=="string"&&t[0]==="="}isRepeated(){return!1}isMap(){return!1}pick(t){if(!this.isScriptable())throw new Error("not scriptable");if(!this.type.pick)throw new Error(`=? not allowed on ${this.name}`);return this.type.pick(t)}},ur=class extends Rt{makeType(){return dn(this.parent,this.typeName,this.options)}init(){return null}append(t,e){return e}entries(t){return t!=null?[t]:[]}fromJson(t){return this.type.fromJson(t)}toJson(t){return t!=null?this.type.toJson(t):void 0}},hr=class extends Rt{makeType(){return dn(this.parent,this.typeName,this.options)}init(){return[]}append(t,e){return t.push(e),t}entries(t){return t??[]}fromJson(t){return t==null?[]:(Array.isArray(t)||(t=[t]),t.map(e=>this.type.fromJson(e)))}toJson(t){if(t?.length)return t.map(e=>this.type.toJson(e))}isRepeated(){return!0}},mr=class extends Rt{makeType(){if(!this.keyTypeName)throw new Error("missing key type");return new cr(dn(this.parent,this.keyTypeName,{}),dn(this.parent,this.typeName,this.options))}init(){return new Map}append(t,e){return t.set(...e),t}entries(t){return t?.entries()??[]}fromJson(t){if(t==null)return new Map;if(typeof t!="object")throw new Error("bad map");let e=Array.isArray(t)?t:Object.entries(t);return new Map(e.map(n=>this.type.fromJson(n)))}toJson(t){if(!t?.size)return;let e={};for(let n of t.entries()){let[r,i]=this.type.toJson(n);e[r]=i}return e}isMap(){return!0}isScriptable(){return!1}},Vt=class{constructor(t){this.range=t;this.scriptable=!0}clamp(t){return Math.max(this.range[0],Math.min(t,this.range[1]))}fromRecord(t){if(t.type!==this.recordType)throw new Error("unexpected type");return this.clamp(t.data)}toRecord(t,e){return{id:t,data:this.clamp(e),type:this.recordType}}fromJson(t){let e=Number(t);if(isNaN(e))throw new Error(`bad number: ${t}`);return this.clamp(e)}toJson(t){return t}withRange(t){return new this.constructor([this.clamp(t[0]),this.clamp(t[1])])}},fn=class extends Vt{constructor(e=[0,4294967295]){super(e);this.name="uint32";this.recordType=0}clamp(e){return super.clamp(Math.round(e))}pick(e){if(!Number.isFinite(this.range[0])||!Number.isFinite(this.range[1]))throw new Error("=? not allowed without range");let n=e();return Math.floor((this.range[1]+1)*n+this.range[0]*(1-n))}},pr=class extends fn{constructor(e=[-2147483648,2147483647]){super(e);this.name="int32"}fromRecord(e){let n=super.fromRecord(e);return n%2?(1-n)/2:n/2}toRecord(e,n){return super.toRecord(e,2*Math.abs(n)+ +(n<0))}},gr=class extends Vt{constructor(e=[-1/0,1/0]){super(e);this.name="float";this.recordType=5}pick(e){if(!Number.isFinite(this.range[0])||!Number.isFinite(this.range[1]))throw new Error("=? not allowed without range");let n=e();return this.range[1]*n+this.range[0]*(1-n)}},ca={name:"bool",scriptable:!0,fromRecord(s){if(s.type!==0)throw new Error("unexpected type");return!!s.data},toRecord(s,t){return{id:s,data:t?1:0,type:0}},fromJson(s){if(typeof s=="boolean")return s;if(typeof s=="string"&&(s=s.toLowerCase()),s==="true")return!0;if(s==="false")return!1;throw new Error(`bad boolean: ${s}`)},toJson(s){return s},pick(s){return s()<.5}},fa={name:"string",scriptable:!0,fromRecord(s){if(s.type!==2)throw new Error("unexpected type");return _s.decode(s.data)},toRecord(s,t){return{id:s,data:As.encode(t),type:2}},fromJson(s){return String(s)},toJson(s){return s}},ua=new Map([["uint32",new fn],["int32",new pr],["bool",ca],["float",new gr],["string",fa]]),un=class s{constructor(t){this.presetDescriptor=t;this.presets=[]}evaluate(t,e){throw new Error("scripts not allowed")}addPreset(t){if(t instanceof z&&(t=this.evaluate(t.script)),typeof t=="string")try{let e=this.presetDescriptor.fromJson(t);this.presets.push(e);return}catch{}else if(typeof t=="boolean")throw new Error(`bad preset: ${t}`);t&&this.presets.push(t)}getPreset(t){for(let n of this.presets){let r=this.getValueForPreset(t,n);if(r!=null)return r}let e=t.options.default;if(e!=null)return t.fromJson(e)}getValueForPreset(t,e){if(typeof e!="number")return;let n=t.preset[e];return n instanceof z&&(n=this.evaluate(n.script,t)),n}newEvaluator(){return new s(this.presetDescriptor)}}});var ha,mn,Xd,R,Kt,Qd,Zd,Ls=v(()=>{hn();ha=new Map([[1,"vanilla"],[2,"casual"],[3,"classic"],[4,"advanced"],[5,"mystery"],[47,"hardcore"],[48,"fullStupid"],[49,"fullVanilla"],[124,"tournament2023"],[125,"tournament2022Early"],[126,"tournament2022Mid"],[127,"tournament2022Finals"]]),mn=new Ut("root",null,ha),Xd=ye({LEAF_ELDER:0,OAK_ELDER:1,WATERFALL_CAVE_SWORD_OF_WATER_CHEST:2,STXY_LEFT_UPPER_SWORD_OF_THUNDER_CHEST:3,MESIA_IN_TOWER:4,SEALED_CAVE_BALL_OF_WIND_CHEST:5,MT_SABRE_WEST_TORNADO_BRACELET_CHEST:6,GIANT_INSECT:7,KELBESQUE1:8,RAGE:9,ARYLLIS_BASEMENT_CHEST:10,MADO1:11,STORM_BRACELET_CHEST:12,WATERFALL_CAVE_RIVER_LEFT_CHEST:16,MADO2:18,STXY_RIGHT_MIDDLE_CHEST:20,BATTLE_ARMOR_CHEST:27,DRAYGON1:28,SEALED_CAVE_SMALL_ROOM_BACK_CHEST:29,SEALED_CAVE_BIG_ROOM_NORTHEAST_CHEST:30,FOG_LAMP_CAVE_FRONT_CHEST:31,MT_HYDRA_RIGHT_CHEST:32,SABERA_UPSTAIRS_LEFT_CHEST:33,EVIL_SPIRIT_ISLAND_LOWER_CHEST:34,SABERA2:35,SEALED_CAVE_SMALL_ROOM_FRONT_CHEST:36,CORDEL_GRASS:37,KELBESQUE2:38,OAK_MOTHER:39,PORTOA_QUEEN:40,AKAHANA_STATUE_OF_ONYX_TRADEIN:41,OASIS_CAVE_FORTRESS_BASEMENT_CHEST:42,BROKAHANA:43,EVIL_SPIRIT_ISLAND_RIVER_LEFT_CHEST:44,DEO:45,VAMPIRE1:46,OASIS_CAVE_NORTHWEST_CHEST:47,AKAHANA_FLUTE_OF_LIME_TRADEIN:48,ZEBU_STUDENT:49,WINDMILL_GUARD_ALARM_FLUTE_TRADEIN:50,MT_SABRE_NORTH_BACK_OF_PRISON_CHEST:51,ZEBU_IN_SHYRON:52,FOG_LAMP_CAVE_BACK_CHEST:53,INJURED_DOLPHIN:54,CLARK:55,SABERA1:56,KENSU_IN_LIGHTHOUSE:57,REPAIRED_STATUE:58,UNDERGROUND_CHANNEL_UNDERWATER_CHEST:59,KIRISA_MEADOW:60,KARMINE:61,ARYLLIS:62,MT_HYDRA_SUMMIT_CHEST:63,AZTECA_IN_PYRAMID:64,ZEBU_AT_WINDMILL:65,MT_SABRE_NORTH_SUMMIT:66,STOM_FIGHT_REWARD:67,MT_SABRE_WEST_TORNEL:68,ASINA_IN_BACK_ROOM:69,BEHIND_WHIRLPOOL:70,KENSU_IN_SWAN:71,SLIMED_KENSU:72,MEZAME_SHRINE_LEFT_CHEST:73,SEALED_CAVE_BIG_ROOM_SOUTHWEST_CHEST:80,MT_SABRE_WEST_RIGHT_CHEST:82,MT_SABRE_NORTH_MIDDLE_CHEST:83,FORTRESS_MADO_HELLWAY_CHEST:84,SABERA_UPSTAIRS_RIGHT_CHEST:85,MT_HYDRA_FAR_LEFT_CHEST:86,STXY_LEFT_LOWER_CHEST:87,KARMINE_BASEMENT_LOWER_MIDDLE_CHEST:88,EAST_CAVE_NORTHEAST_CHEST:89,OASIS_CAVE_ENTRANCE_ACROSS_RIVER_CHEST:90,EVIL_SPIRIT_ISLAND_EXIT_CHEST:92,FORTRESS_SABERA_MIDDLE_CHEST:93,MT_SABRE_NORTH_UNDER_BRIDGE_CHEST:94,KIRISA_PLANT_CAVE_CHEST:95,FORTRESS_MADO_UPPER_NORTH_CHEST:96,VAMPIRE2:97,FORTRESS_SABERA_NORTHWEST_CHEST:98,FORTRESS_MADO_LOWER_CENTER_NORTH_CHEST:99,OASIS_CAVE_NEAR_ENTRANCE_CHEST:100,MT_HYDRA_LEFT_RIGHT_CHEST:101,FORTRESS_SABERA_SOUTHEAST_CHEST:102,KENSU_IN_CABIN:103,MT_SABRE_WEST_NEAR_TORNEL_CHEST:105,MT_SABRE_WEST_LEFT_CHEST:106,FORTRESS_MADO_UPPER_BEHIND_WALL_CHEST:107,PYRAMID_CHEST:108,CRYPT_RIGHT_CHEST:109,KARMINE_BASEMENT_LOWER_LEFT_CHEST:110,FORTRESS_MADO_LOWER_SOUTHEAST_CHEST:111,FOG_LAMP_CAVE_MIDDLE_NORTH_MIMIC:112,FOG_LAMP_CAVE_MIDDLE_SOUTHWEST_MIMIC:113,WATERFALL_CAVE_FRONT_MIMIC:114,EVIL_SPIRIT_ISLAND_RIVER_RIGHT_MIMIC:115,MT_HYDRA_FINAL_CAVE_MIMIC:116,STXY_LEFT_NORTH_MIMIC:117,STXY_RIGHT_NORTH_MIMIC:118,STXY_RIGHT_SOUTH_MIMIC:119,CRYPT_LEFT_PIT_MIMIC:120,KARMINE_BASEMENT_UPPER_MIDDLE_MIMIC:121,KARMINE_BASEMENT_UPPER_RIGHT_MIMIC:122,KARMINE_BASEMENT_LOWER_RIGHT_MIMIC:123,EAST_CAVE_NORTHWEST_MIMIC:124},{valuesOptions:{3:{1:["STYX_LEFT_UPPER_SWORD_OF_THUNDER_CHEST"]},20:{1:["STYX_RIGHT_MIDDLE_CHEST"]},49:{1:["MEZAME_SHRINE_RIGHT_CHEST"]},87:{1:["STYX_LEFT_LOWER_CHEST"]},117:{1:["STYX_LEFT_NORTH_MIMIC"]},118:{1:["STYX_RIGHT_NORTH_MIMIC"]},119:{1:["STYX_RIGHT_SOUTH_MIMIC"]}},comments:{}},"CheckName",mn),R=class extends he{},Kt=class extends me{};Se("Config",R,Kt,mn,{fields:{version:{type:"uint32",id:1,options:{4:!0,5:!0},comment:"NOTE: must be exactly 1 for the filled message"},hideConfig:{type:"bool",id:2,options:{2:!1,4:!0,5:!0},comment:`If this is set then the randomizer will not display the exact options.
The only way to unset it is to reset the entire config to empty.  We
will ask for confirmation before proceeding.`},race:{type:"bool",id:3,options:{2:!1,5:!0},comment:'Indicates that this is a "race rom": prevents pulling the spoiler log.'},seed:{type:"uint32",id:4,options:{5:!0},comment:`Force a seed??? Allows deterministically specifying the output
with just a single file`},crowdControl:{type:"bool",id:7,options:{2:!1,5:!0}},coop:{type:"bool",id:8,options:{2:!1,5:!0}},placement:{type:"Placement",id:9},items:{type:"Items",id:10},quality:{type:"Quality",id:11},triggers:{type:"Triggers",id:12},maps:{type:"Maps",id:13},enemies:{type:"Enemies",id:14},towns:{type:"Towns",id:15},glitches:{type:"Glitches",id:16},fun:{type:"Fun",id:17},debug:{type:"Debug",id:18},options:{type:"Options",id:19,comment:`NOTE: This message is removed before impacting the seed.  We will
generally persist this message via local storage, so that it's applied
consistently regardless of clicking links.`},presets:{rule:"repeated",type:"string",id:31,options:{1:["preset"],4:!0},comment:`presets may be either builtin (specified via field options) or else
user-defined.  We allow preset scripts, so that builtins may refer
to script variables.  If a preset element is empty, it is skipped,
allowing \`preset: =(random()<0.5 ? "vanilla" : "")\` to work.
Preset scripts are evaluated in their own independent environment,
so that they can refer to script vars but not affect the outer env.
Presets are evaluated in order, before any other fields, and set an
initial value for a handful of fields, which may be overridden by
an explicit value or else by a later preset.  User-supplies presets
must be of the form \`name#1234ef\` where the hash is computed from the
contents of the preset, which is uploaded as a full config and saved
in the preset manager.  Users can set up a preset and then export a
URL (or a file) to share for others to import it.  Preset configs
may be hidden so that they cannot be inspected.`},scripts:{rule:"repeated",type:"string",id:30,options:{1:["script"],4:!0,5:!0},comment:`(maybe-conditional) assignment expressions, e.g.
x = rand()
x < 0.5 && this.initialInventory += fluteOfLime
we parse the expression and iterate through to find which actually
affect what, and whether the relevant fields are affected for the
UI's sake.  In particular,`}},comment:`Config message type.  Note that we will actually instantiate _two_
different Config objects: one for flags (called "config") and the
other for options (called "options").  The options contains _only_
optional fields and is not included in the seed or checksum, and it
gets its own namespace for scripts so that optional choices don't
allow observing any relevant variables.  The flags object may
contain optional fields, in which case they take precedence over
the options fields, but it may not include optional fields marked
as "must allow".

TODO - what about options presets??  probably want to remove...`});(A=>{class s extends he{}A.Accessibility=s;class t extends me{}A.AccessibilityGenerator=t,Se("Accessibility",s,t,A.descriptor,{fields:{audibleWallCues:{type:"bool",id:1,options:{2:!1,5:!0},comment:`NOTE: these are always optional and can never be marked as required.
todo - quick soft reset?`},disableMusic:{type:"bool",id:2,options:{2:!1,5:!0}}}});class e extends he{}A.Debug=e;class n extends me{}A.DebugGenerator=n,Se("Debug",e,n,A.descriptor,{fields:{trainer:{type:"bool",id:1,options:{2:!1}},neverDie:{type:"bool",id:2,options:{2:!1}},checkFlag0:{type:"bool",id:3,options:{2:!0}}}});class r extends he{}A.Enemies=r;class i extends me{}A.EnemiesGenerator=i,Se("Enemies",r,i,A.descriptor,{fields:{itemsFromMimics:{type:"float",id:2,options:{2:0,3:{5:"=rand() * 3 - 1.5",124:1},6:[0,1]},comment:"Proportion of items that need to be won by defeating a mimic."},removeLevelMinimums:{type:"bool",id:3,options:{2:!0,3:{49:!1}},comment:"Whether to remove the level minimums required to damage enemies."},rescaleEnemies:{type:"bool",id:4,options:{2:!0,3:{49:!1}},comment:`Whether to use the scaling level when spawning enemies.  Without
this, late-game enemies will be challenging or (with level minimums)
impossible to defeat in the early game, and early-game enemies will
be trivial and pointless in the late game.`},randomizeEnemies:{type:"Randomization",id:5,options:{2:1,3:{1:0}},comment:"Whether to randomize enemy spawns."},enemyWeaknesses:{type:"Randomization",id:6,options:{2:2,3:{1:0,2:0,3:0,5:"=?",125:"=?",126:"=?",127:"=?"}},comment:`Whether to randomize enemy weaknesses.  In SHUFFLE mode, enemies will
retain the same number of weaknesses, whereas in RANDOM mode, each
will get a completely random combination.  This option does not affect
tetrarchs, which always have only a single weakness.`},changeWeaknessCount:{type:"bool",id:19,options:{2:!1},comment:`Whether normal enemies can change their number of weaknesses.  If this is
false then any given enemy will have the same number of weaknesses.  If
it's true, then the number of weaknesses may change.`},allowDraygonImmunity:{type:"bool",id:20,options:{2:!1},comment:"Whether to allow Draygon1 and Draygon2 to have any immunities."},allowRobotImmunity:{type:"bool",id:21,options:{2:!1},comment:"Whether to allow robots to have any immunities."},tetrarchWeaknesses:{type:"Randomization",id:7,options:{2:2,3:{1:0}},comment:`Whether to randomize tetrarch weaknesses.  In SHUFFLE mode, weaknesses
will be swapped between the 7 bosses, keeping two wind, two fire, two
water, and one thunder; in RANDOM mode, each tetrarch will get a random
weakness independent of all the other selections.`},paletteSwap:{type:"bool",id:8,options:{2:!1,3:{5:"=?",125:"=?",126:"=?",127:"=?"}},comment:`Whether to palette swap enemies.  Note that this cannot be made optional
because palette swapping affects which enemies can be spawned together
on the same map (without palette swapping, only same-colored enemies can
be together, whereas with swapping, the selection is much greater).`},robotsOutsideTower:{type:"float",id:9,options:{2:.05,3:{2:0,3:0,5:"=randn()/15"},6:[0,1]},comment:`How often tower robots can be found outside the tower.  A value of 0 means
no robots can appear, while a value of 1 means that all enemies will be
robots ("oops all robots").  In-between values indicate the probability of
any location spawning a robot.`},maxScalingInTower:{type:"bool",id:10,options:{2:!1,3:{4:!0,5:"=?",47:!0,48:!0,124:!0,126:!0,127:!0}},comment:`Whether to use max scaling for all damage calculations while in the tower
rather than whatever the current scaling level happens to be.`},buffDyna:{type:"bool",id:11,options:{2:!0,3:{1:!1,2:!1,5:"=rand()<.7"}},comment:"Whether to buff the dyna enemies.  This is a separate option from max-scaling."},tinkMode:{type:"GlitchMode",id:12,options:{2:0}},expScalingFactor:{type:"float",id:13,options:{2:1,3:{2:2.5,47:.25,48:.25},6:[.25,4]}},initialEnemyDamageScalingFactor:{type:"float",id:15,options:{2:1,3:{2:.33},6:[.25,4]},comment:`Scaling factor to apply to enemy damage at the start of the game.
Note that at full scaling, this is _not_ the relevant factor.  We
adjust the scaling rate to catch up with the unmodified values by
the endgame.`},randomizeFlyerSpawns:{type:"bool",id:17,options:{2:!0,3:{1:!1}},comment:`Whether to randomize where flyers spawn on the map.  This is important
for the Rage Skip glitch, which requires damage-boosting off of a flyer
from the right angle.  If this is disabled and Rage Skip is in-logic,
then it might be very difficult to pull off the skip.`},permadeath:{type:"bool",id:18,options:{2:!1,3:{47:!0,48:!0}},comment:"Death is permanent. Save/load/continue are all disabled."},fixCoinSprites:{type:"bool",id:32,options:{2:!0,3:{49:!1}},comment:`Replace all coin sprites with the same one (TODO: different per page?)
NOTE: Disabling this with enemies shuffled will lead to glitched graphics,
and may also prevent other changes if the freed-up metasprite slot is
needed for something else.`}}});class o extends he{}A.Fun=o;class a extends me{}A.FunGenerator=a,Se("Fun",o,a,A.descriptor,{fields:{paletteSwapBackgrounds:{type:"bool",id:1,options:{2:!1},comment:`modes: none, full, shuffle???
- version that just swaps existing palettes?`},randomizeMusic:{type:"bool",id:2,options:{2:!1}},communityJokes:{type:"float",id:3,options:{2:.1,3:{1:0,2:0,3:0}}}}}),A.GlitchMode=ye({FORBID:0,REQUIRE:1,ALLOW:2},{comments:{0:"Glitch is not possible",1:"Glitch is allowed and required in logic",2:"Glitch is allowed but hidden from logic"}},"GlitchMode",A.descriptor);class c extends he{}A.Glitches=c;class d extends me{}A.GlitchesGenerator=d,Se("Glitches",c,d,A.descriptor,{fields:{shopGlitch:{type:"GlitchMode",id:1,options:{2:0,3:{1:2,5:"=rand()<.2?'ALLOW':'FORBID'"}},comment:`Whether to allow players to "steal" items from shops by buffering a
purchase immediately after a left/right input, which allows to buy
an item for the price of its neighbor (which may be free if there is
no neighbor).  Requiring this glitch in-logic doesn't have a large
effect, but could lead to logic that expects the player to steal healing
items in order to make a "hell-run" through the swamp.`},statueGlitch:{type:"GlitchMode",id:2,options:{2:0,3:{1:2,3:1,4:1,5:"=?",124:1,125:1,126:"=?",127:1}}},swordChargeGlitch:{type:"GlitchMode",id:3,options:{2:0,3:{1:2,4:2,5:"=?"}}},teleportSkip:{type:"GlitchMode",id:4,options:{2:0,3:{1:2,4:1,5:"=?",124:1,126:"=?",127:1}}},rabbitSkip:{type:"GlitchMode",id:5,options:{2:0,3:{1:2,4:1,5:"=?",124:1,126:"=?",127:1}}},rageSkip:{type:"GlitchMode",id:6,options:{2:0,3:{1:2,5:"=?"}}},triggerSkip:{type:"GlitchMode",id:7,options:{2:0,3:{1:2,5:"=?"}}},flightStatueSkip:{type:"GlitchMode",id:8,options:{2:0,3:{1:2,5:"=?",125:1,126:"=?",127:1}}},ghettoFlight:{type:"GlitchMode",id:9,options:{2:0,3:{1:2,4:1,5:"=?",124:1,126:"=?",127:1}}},requireLongTriggerSkip:{type:"bool",id:10,options:{2:!1}},allowWarpBootsReuse:{type:"bool",id:11,options:{2:!1,3:{1:!0}}}}});class f extends he{}A.Items=f;class u extends me{}A.ItemsGenerator=u,Se("Items",f,u,A.descriptor,{fields:{unidentifiedItems:{type:"bool",id:1,options:{2:!1,3:{4:!0,5:"=?",47:!0,48:!0,124:!0,125:!0,126:!0,127:!0}},comment:"TODO - should this go somewhere else?"},swordLevelForWalls:{type:"uint32",id:2,options:{2:1,3:{1:2,2:2,3:2,5:"3*rand()"},6:[1,3]},comment:"Sword shot level required to break walls."},chargeShotOnlyMode:{type:"bool",id:64,options:{2:!1,3:{124:!0}},comment:`A collection of options that work well together: nerfs stabs to not work,
charges while walking (faster with rabbit boots), and changes warrior
ring to "turret mode" when standing still.`},noStabs:{type:"bool",id:4,options:{2:!1,9:[64,!0]},comment:`Nerf sword so that stabbing doesn't hit enemies.  This should
be turned on with other modifications, like charge while walking.`},chargeSpeed:{type:"uint32",id:5,options:{2:7,6:[1,8]},comment:`0: disabled, 1: 4 sec/tick, 2: 2 sec/tick, 3: 1 sec/tick, 4: 2 tick/sec,
5: 4 tick/sec, 6: 8 tick/sec, 7: 15 tick/sec, 8: 30 tick/sec
The normal charge speed, on a logarithmic scale:`},chargeWhileWalkingSpeed:{type:"uint32",id:6,options:{2:0,6:[0,8],9:[64,7]},comment:`Enable sword charging while walking without any items equipped.
This is recommended when charge_shots_only is enabled.`},chargeWithItemSpeed:{type:"uint32",id:7,options:{2:7,6:[1,8],9:[64,8]},comment:`Charge speed while equipped item (rabbit boots and/or charge ring) and
standing still.`},chargeWhileWalkingWithItemSpeed:{type:"uint32",id:8,options:{2:7,6:[0,8],9:[64,8]},comment:"Charge speed while walking w/ charge boost item."},warriorRingTurret:{type:"bool",id:9,options:{2:!1,9:[64,!0]},comment:'Turns warrior ring into "turret mode".  TODO - parameters???'},warriorRingTurretDelay:{type:"uint32",id:10,options:{2:30,6:[0,255]},comment:"Frame delay before entering turret mode."},warriorRingTurretFreeShotFrequency:{type:"uint32",id:11,options:{2:3,6:[1,255]},comment:`Frequency of "free" shots during turret delay.
For value N, every Nth stab will be a shot.`},medicalHerbHeal:{type:"uint32",id:12,options:{2:80,3:{1:32,126:32,127:32},6:[0,255]},comment:"Specifies the medical herb heal amount."},fruitOfPowerMp:{type:"uint32",id:13,options:{2:56,3:{1:32,126:32,127:32},6:[0,255]},comment:"Specifies the fruit of power MP recover amount."},magicRingMp:{type:"uint32",id:14,options:{2:255,6:[0,255]},comment:"Specifies the magic ring MP recover amount."},deosPendantMpRestoreSpeed:{type:"uint32",id:15,options:{2:3,6:[1,8]},comment:`MP restore rate for Deo's Pendant
0: disabled, 1: 4 sec/MP, 2: 2 sec/MP, 3: 1 sec/MP, 4: 2 MP/sec,
5: 4 MP/sec, 6: 8 MP/sec, 7: 15 MP/sec, 8: 30 MP/sec`},deosPendantMpRestoreWhileWalkingSpeed:{type:"uint32",id:16,options:{2:3,3:{1:0},6:[0,8]},comment:"Buffs Deo's Pendant to restore MP while walking, at this speed."},hazmatSuit:{type:"bool",id:17,options:{2:!0,3:{1:!1},9:[32,!1]},comment:`Combines Leather Boots and Gas Mas into a new Hazmat Suit item,
which protects from both swamp and desert/spike terrain.
This marks Leather Boots as the preferred item to replace.`},addSpeedBoots:{type:"bool",id:18,options:{2:!0,3:{1:!1},9:[32,!1]},comment:`Adds Speed Boots, replacing the most preferred item.  If there is
no preferred replacement item, then replaces a random item?`},rabbitBootsChargeWhileWalking:{type:"bool",id:20,options:{2:!0,3:{1:!1},9:[32,!1]},comment:`Buffs Rabbit Boots to also charge sword while walking.
TODO - we can maybe make this a separate item instead?`},adjustTornadoSpeed:{type:"int32",id:22,options:{2:-1,3:{1:0},6:[-3,2]},comment:"Adjusts the Tornado Bracelet magic speed from the default."},nerfFlightStab:{type:"bool",id:23,options:{2:!0,3:{1:!1}},comment:`Nerf sword to not hit enemies while flying (since the player
is invincible, it makes flight even more OP).`},ceramicShieldPreventsParalysis:{type:"bool",id:24,options:{2:!0,3:{1:!1},9:[32,!1]},comment:"Whether ceramic shield should be buffed to prevent paralysis."},sacredShieldPreventsCurse:{type:"bool",id:25,options:{2:!0,3:{1:!1},9:[32,!1]},comment:"Whether sacred shield should be buffed to prevent nuper."},psychoArmorHealSpeed:{type:"uint32",id:26,options:{2:5,6:[1,8]},comment:`HP restore rate for Deo's Pendant
0: none, 1: 4 sec/HP, 2: 2 sec/HP, 3: 1 sec/HP, 4: 2 HP/sec,
5: 4 HP/sec, 6: 8 HP/sec, 7: 15 HP/sec, 8: 30 HP/sec`},psychoArmorHealWhileWalkingSpeed:{type:"uint32",id:27,options:{2:0,6:[0,8]},comment:"Buffs Psycho Armor to restore HP while walking, at the given rate."},balancedArmorDefense:{type:"bool",id:28,options:{2:!0,3:{1:!1}},comment:`Whether the armor/shield defense values should be a balanced
progression with ceramic suit and battle shield (the last ones
with no special powers) having the max defense.  If this is true
then we adjust all the armor tiers to have a smooth progression
for the first 5 (3, 6, 9, 13, 18), max out at tier 6 (32), and
then drop down to 18..20 for the top two tiers since they have
other special abilities.  If this is false then we leave the
defense values as their vanilla amounts.`},capArmorDefenseByLevel:{type:"uint32",id:29,options:{2:3,3:{1:0},6:[0,5]},comment:`If nonzero, cap the maximum armor defense at this multiplier
times the player level.`},armorDefense:{keyType:"uint32",type:"uint32",id:48,options:{7:"ItemName"},comment:"Specify specific defense values for each armor/shield."},warpFromAnywhere:{type:"bool",id:30,options:{2:!0,3:{49:!1}},comment:`is this an item property (i.e. teleport/warp boots) or a map property?
- move to "rules"?  next to pity mp, etc?`},zombieWarp:{type:"bool",id:31,options:{2:!0,3:{49:!1}}},vanillaBonusItems:{type:"bool",id:32,options:{2:!1},comment:"This is mainly transitional for migration from FlagSet."}}});class h extends he{}A.Maps=h;class m extends me{}A.MapsGenerator=m,Se("Maps",h,m,A.descriptor,{fields:{mezameChests:{type:"uint32",id:1,options:{2:0,3:{5:"=?"},6:[0,2]}},addEastCave:{type:"bool",id:3,options:{2:!0,3:{1:!1,2:!1,3:!1,5:"=rand()<.8"}}},addEastCaveNortheastExit:{type:"bool",id:4,options:{2:!0,3:{1:!1,5:"=rand()<.7"}}},addEastCaveSouthwestExit:{type:"bool",id:5,options:{2:!0,3:{1:!1,5:"=rand()<.7"}}},addWindLimePassage:{type:"bool",id:6,options:{2:!1,3:{2:!0,3:!0,5:"=rand()<.3"}}},reversibleSwanGate:{type:"bool",id:7,options:{2:!0,3:{1:!1}}},blackout:{type:"bool",id:8,options:{2:!1,3:{48:!0}}},wildWarpInLogic:{type:"bool",id:32,options:{2:!0,3:{2:!1}}},wildWarp:{type:"WildWarp",id:13,options:{2:0,3:{1:1,5:"=rand(3)"}}},wildWarpCount:{type:"uint32",id:14,options:{2:16,3:{1:16,5:"=?"},6:[2,16]},comment:"NOTE: Only used if wild warp is RANDOM"},wildWarpLocations:{rule:"repeated",type:"LocationName",id:15,comment:"NOTE: Only used if wild warp is FIXED"},wallElements:{type:"Randomization",id:16,options:{2:2,3:{1:0,4:2,5:"=?",47:2,48:2}},comment:`How to randomize wall elements.
NOTE: Using "SHUFFLE" here will have the effect of never making
ember walls for the water sword, and will favor rock walls.`},dungeonMaps:{type:"bool",id:17,options:{2:!1,3:{4:!0,5:"=rand()<.3",47:!0,48:!0}},comment:"How to randomize dungeon maps."},shuffleHouseEntrances:{type:"float",id:18,options:{2:0,3:{4:"=rand() * 2",5:"=rand() * 3 - 1.5",47:"=rand() * 2",48:1},6:[0,1]},comment:`Likelihood of randomizing any given house entrance.
A value of 0 means no entrances are shuffled, while a value
of 1 will shuffle all entrances.  In-between values will
retain a fraction of the original entrances.`},shuffleAreaConnections:{type:"float",id:19,options:{2:0,3:{4:"=rand() * 2",5:"=rand() * 3 - 1.5",47:"=rand() * 2",48:1},6:[0,1]},comment:`Likelihood of randomizing any given connection between areas.
A value of 0 means no connections are shuffled, while a value
of 1 will shuffle all connections.  In-between values will
retain a fraction of the original connections.`},shuffleGoaFloorConnections:{type:"bool",id:20,options:{2:!1,3:{5:"=?",47:!0,48:!0}},comment:`Whether to shuffle the connections between floors in Draygonia
Fortress.`},reverseGoaFloorDirections:{type:"bool",id:21,options:{2:!0,3:{5:"=?"}},comment:`Whether the direction of Draygonia Fortress floors may be reversed.
Only applies when "shuffle_goa_floor_connections" is enabled.`}}}),(X=>X.WildWarp=ye({MEZAME:0,VANILLA:1,RANDOM:2,FIXED:3},{comments:{0:"Wild warp goes to Mezame only",1:"Wild warp locations are the same as vanilla",2:"Wild warp locations are randomized",3:"Wild warp locations given by the list, fixed in sibling field"}},"WildWarp",A.Maps.descriptor))(h=A.Maps||={});class g extends he{}A.Options=g;class x extends me{}A.OptionsGenerator=x,Se("Options",g,x,A.descriptor,{fields:{accessibility:{type:"Accessibility",id:1},quality:{type:"Quality",id:11},fun:{type:"Fun",id:17},scripts:{rule:"repeated",type:"string",id:30,options:{1:["script"],4:!0,5:!0},comment:`NOTE: Options has its own namespace to prevent observing any top-level
config variables.`}},comment:`This is mostly repeats from the top-level Config object.  These fields
act as a fall-back when the top-level one is not specified.  Any Scripts
in this message are evaluated with a _different_ random number generator
so as not to impact the main config.  Fields nested in this message are
mutually exclusive with fields nested under the main Config.  The choice
of which field to set should be controlled by a "lock" icon in the UI.`});class y extends he{}A.Placement=y;class p extends me{}A.PlacementGenerator=p,Se("Placement",y,p,A.descriptor,{fields:{algorithm:{type:"Algorithm",id:1,options:{2:1,3:{1:0}},comment:"Which algorithm to use."},checkBeta:{type:"float",id:2,options:{2:.25,6:[-10,10]},comment:`The "inverse temperature" to use when pre-sorting the list of
checks.  If this is zero, then the checks won't be sorted at all.
The larger this number is, the more likely "deeper" checks are
to be filled earlier.  If this is negative, then "shallower"
checks will be filled first.  This is multiplied by the delta in
average progression item count, which tends to range from 1..40.`},itemBeta:{type:"float",id:3,options:{2:.25,6:[-10,10]},comment:`The "inverse temperature" to use when pre-sorting the list of
progression items.  If this is zero, then the items won't be
sorted at all.  The larger this number is, the more likely
"powerful" items are to be placed first, where "power" is
measured in terms of how many checks the item tends to unlock,
on average.  Can be negative, in which case powerful items will
tend to be placed later.  This is multiplied by the delta in
average number of checks unlocked, which tends to range from
1..10 or so.`},checkDistributionWeight:{type:"float",id:4,options:{2:2,6:[-10,10]},comment:`If nonzero, then multiple checks in the same area will be
separated during the check sort.  The checks will be shuffled
and successive checks after the first in each area will be
penalized by this amount, in units of progression item count.`},mimics:{type:"Randomization",id:5,options:{2:1,3:{1:0,2:0,5:"=?"}},comment:`How to deal with mimics.  If VANILLA, then mimics will be left where
they are.  If SHUFFLE, then they'll be swapped with other chests, but
the total number of mimics will stay the same.  If RANDOM, then the
number of mimics may change, in which case some consumables may be
swapped in/out (even if the \`consumables\` field is not RANDOM as well).`},mimicCount:{type:"uint32",id:6,options:{2:13,3:{5:"=?"},6:[0,15]},comment:`Number of mimics to shuffle into the chest pool.  This only has
any effect if mimics are not vanilla.  If mimics are randomized
(rather than shuffled) then this biases the mimic probability, rather
than directly setting the number of mimics.`},shuffleMimicsWithKeyItems:{type:"bool",id:7,options:{2:!0,3:{5:"=?"}},comment:`Whether mimics are shuffled in with key items.  If false, then mimics
will only be eligible to go into consumable chests.  This has no effect
if mimics are vanilla.`},consumables:{type:"Randomization",id:8,options:{2:1,3:{1:0,5:"=?"}},comment:`How to deal with consumables.  If VANILLA, then consumables will not
be shuffled at all.  If SHUFFLE, then the distribution of consumables
will be retained as much as possible.  If RANDOM, then consumables
will be picked with the same proportion as the vanilla, but will not
be constrained to exactly the same numbers (so there could be more or
fewer of each, including opel statues).`},shuffleConsumablesWithKeyItems:{type:"bool",id:9,options:{2:!0,3:{2:!1,5:"=rand()<0.8"}},comment:`Whether consumables and key items are shuffled together into the same
pool.  If this is false, then key item will only be found from key
item checks (including all boss rewards).`},earlySword:{type:"bool",id:13,options:{2:!1,3:{2:!0,3:!0,125:!0,126:!0}},comment:"Whether to guarantee a sword in the earliest possible check."},ensureGasMaskBeforeSwamp:{type:"bool",id:14,options:{2:!0,3:{4:!1,5:"=?"}},comment:`Ensures the logic provides the gas mask (or hazmat suit, as
appropriate) before requiring going into the swamp.  If this is
false, then any source of healing is considered sufficient.`},ensureGasMaskBeforeInsect:{type:"bool",id:15,options:{2:!0},comment:`Ensures the logic provides the gas mask (or hazmat suit, as
appropriate) before requiring to fight the insect.  If this is
false, then any source of healing is considered sufficient.
Note that this is significantly more challenging than
\`ensure_gas_mask_before_swamp\` since it may require an entire
boss fight while draining health.  It is not included by default
in any standard presets.`},ensureBarrierBeforeStatues:{type:"bool",id:16,options:{2:!0,3:{4:!1,5:"=?",47:!1,48:!1,124:!1,126:"=?",127:!1}},comment:`Ensures the logic provides barrier before requiring to walk
through the shooting statue guantlets.  If this is false, then
any source of healing is considered sufficient.`},ensureRefreshBeforeBosses:{type:"bool",id:17,options:{2:!1,3:{2:!0}},comment:`Ensures the logic provides refresh before requiring to fight
any bosses.`},ensureMinimumSwordLevelBeforeTetrarchs:{type:"uint32",id:18,options:{2:2,3:{2:3,4:1,5:"3*rand()",47:1,48:1,124:1,126:"3*rand()",127:1},6:[1,3]},comment:`Ensures the logic provides a minimum sword level before requiring
boss fights with the tetrarchs.  Note that Karmine and Draygon
max out at requiring level 2, even if this is set to 3.`},ensureOffensiveUpgradeBeforeTetrarchs:{type:"bool",id:19,options:{2:!0,3:{4:!1,5:"=?",47:!1,48:!1,124:!1,126:"=?",127:!1}},comment:`Ensures the logic provides any sort of offensive upgrade before
requiring a boss fight with a tetrarch.  This is satisfied by
any of {power ring, warrior ring, matching bracelet}.`},disableSafetyChecks:{type:"bool",id:20,options:{2:!1},comment:`Disables logical safety checks.  This allows the seed to roll
even if the logic doesnt think it's possible.  Unfortunately,
there's not really an in-between where it tries to at least
minimize the breakage.  This is mostly useful for testing and
should probably not be enabled if you like completing seeds.`}}}),(X=>X.Algorithm=ye({VANILLA:0,ASSUMED_FILL:1},{comment:"Options for which algorithm to use to place items.",comments:{0:"Vanilla - don't actually rearrange the items at all.",1:`Assumed fill, with optional temperature-based sorting.
This is the default algorithm.`}},"Algorithm",A.Placement.descriptor))(y=A.Placement||={}),A.Preset=ye({VANILLA:1,CASUAL:2,CLASSIC:3,ADVANCED:4,MYSTERY:5,HARDCORE:47,FULL_STUPID:48,FULL_VANILLA:49,TOURNAMENT_2023:124,TOURNAMENT_2022_EARLY:125,TOURNAMENT_2022_MID:126,TOURNAMENT_2022_FINALS:127},{comment:`UI: Given the list of presets, we change the defaults for non-configured
options, so it's easy to see what's what.  When presets are scripted, we
need to distinguish between unset and set because we don't know the default.
Treat similar to a pick/script, with a special UI for the control.`,comments:{1:`Minimal modifications to the game, particularly around item and enemy
placement logic.  This makes all randomizations "opt-in", but preserves
a handful of quality-of-life improvements.  To remove these remaining
improvements, use the "full vanilla" preset as well.`,2:`Basic flags for a relatively easy playthrough. This is a good place to start.
Ds Ecdrstux Rt Vds!mw`,3:`Provides a relatively quick playthough with a reasonable amount of
challenge. Similar to older versions of the randomizer.
Ds Ecs Gs R!t V!m`,4:`A balanced randomization with quite a bit more difficulty.
Ds Gfns!c Ht Met Nbgw Ros Waehmtu`,5:"Even the options are random.",47:"Not for the faint of heart.  Good luck.",48:`Only a few noble fools have ever completed this. Be sure to record this
because pics or it didn't happen.
Hhtxz Met Nbw Ros Waeghmtu`,49:"Extended version of vanilla preset, which removes as many quality-of-life",124:`This year's tournament flags debuts some interesting new flags for a
unique challenge.
Gfns Ht?c Met?g Nbw Rot?s Wegtu`,125:`Lots of potential complexity, but within reason. Requires all
swords and bosses, as well as a few glitches, but guarantees a
starting sword.
Es Ggs M?e Ros?dt W?egstu`,126:`Some additional challenges compared to the early rounds: some
additional mystery flags and glitches, as well as max
difficulty scaling in the tower.
E?s G?fgns Ht?m M?et N?bw Rs?dot W?egstu`,127:`Many of the more difficult mystery flags from the mid rounds
are now always on, plus entrance shuffle.
E?s Gfgns Hmt M?et Nbw Rs?dot Wh?egstu`}},"Preset",A.descriptor);class b extends he{}A.Quality=b;class T extends me{}A.QualityGenerator=T,Se("Quality",b,T,A.descriptor,{fields:{autoEquipBracelet:{type:"bool",id:1,options:{2:!0,3:{49:!1}}},quickSwapSword:{type:"bool",id:2,options:{2:!0,3:{49:!1}}},quickWildWarp:{type:"bool",id:3,options:{2:!0,3:{49:!1}}},colorSwordByElement:{type:"bool",id:4,options:{2:!0,3:{49:!1}}},updateHud:{type:"bool",id:5,options:{2:!0,3:{49:!1}}},enemyHpInHud:{type:"bool",id:6,options:{2:!0,3:{49:!1}}},fixScreenShake:{type:"bool",id:7,options:{2:!0,3:{49:!1}},comment:"Fixes the screen-shake effect from missed IRQ timing"},fixBlizzardDespawn:{type:"bool",id:8,options:{2:!0,3:{49:!1}},comment:"Despawns blizzard shots before trying to shoot new ones"},fixOpelStatue:{type:"bool",id:9,options:{2:!0,3:{49:!1}},comment:"Fix opel statues to work even if not equipped"},fixSwordMagicMp:{type:"bool",id:10,options:{2:!0,3:{49:!1}},comment:"Allow using sword magic even if it would drop MP to exactly zero"},fixVampireSpeed:{type:"bool",id:11,options:{2:!0,3:{49:!1}},comment:"Fix Vampire 2's teleport speed to not blow up at very low HP"},statTracking:{type:"bool",id:12,options:{2:!0,3:{49:!1}},comment:"Whether to track statistics, including when various key items were found"}}}),A.Randomization=ye({VANILLA:0,SHUFFLE:1,RANDOM:2},{valuesOptions:{0:{1:["false"]},1:{1:["true"]}},comments:{}},"Randomization",A.descriptor);class I extends he{}A.Towns=I;class S extends me{}A.TownsGenerator=S,Se("Towns",I,S,A.descriptor,{fields:{shopContents:{type:"Randomization",id:1,options:{2:1,3:{1:0,2:0}},comment:`What items show up in shops (both armor and tool).  If SHUFFLE, then the
same set of items will be available in shops, but they will be exchanged
randomly between the shops.  If RANDOM, then the items will be randomized
independently from each other.  This may mean that some armors are not
available in shops at all.`},rescalePrices:{type:"bool",id:2,options:{2:!0,3:{1:!1}}},priceVariation:{type:"float",id:3,options:{2:.5,3:{1:0},6:[0,1]}},shuffleTrades:{type:"bool",id:4,options:{2:!1,3:{4:!0,5:"=?",47:!0,48:!0,124:!0,125:"=?",126:"=?",127:"=?"}},comment:"Whether trade-in requirements should be shuffled around."}},comment:"Options corresponding to towns."});class O extends he{}A.Triggers=O;class L extends me{}A.TriggersGenerator=L,Se("Triggers",O,L,A.descriptor,{fields:{whirlpoolItemRequiresCalmSea:{type:"bool",id:1,options:{2:!0,3:{1:!1}}},zebuStudentGivesItem:{type:"bool",id:2,options:{2:!0,3:{1:!1}}},rideDolphin:{type:"RideDolphin",id:3,options:{2:3,9:[7,2]}},spawnFisherman:{type:"SpawnFisherman",id:4,options:{2:4,9:[7,2]}},spawnBeachKensu:{type:"SpawnBeachKensu",id:5,options:{2:2,9:[7,1]}},beachKensuGivesItem:{type:"bool",id:6,options:{2:!0,9:[7,!1]},comment:`Whether Kensu gives an item (repurposed $67) and disappears when talking
with him.`},vanillaDolphin:{type:"bool",id:7,options:{2:!1,3:{1:!0,5:"=?",125:"=?",126:"=?",127:"=?"}},comment:"Flags group for returning to the original vanilla dolphin interactions."},deoRequiresTelepathy:{type:"bool",id:8,options:{2:!0,3:{1:!1}}},draygon2RequiresAllSwords:{type:"bool",id:9,options:{2:!1,3:{5:"=?"}},comment:`If this is set, Draygon 2 will _not_ spawn unless the player has
found all four swords.  This was previously part of "story mode",
but has been split out into a separate option.`},draygon2RequiresAllBosses:{type:"bool",id:10,options:{2:!0,3:{1:!1,2:!1,3:!1,5:"=?",124:"=?"}},comment:`If this is set, Draygon 2 will _not_ spawn unless the player has
defeated all other major bosses first (specifically, both forms of
Kelbesque, Sabera, and Mado, plus Karmine and Draygon 1).  This was
previously bundled together with "draygon2 requires all swords" and
called "story mode", but has been split into a separate option.`},draygon2SpawnsWithoutBowOfTruth:{type:"bool",id:11,options:{2:!1,3:{5:"=rand()<.2"},9:[13,!0]},comment:`If this is set, Draygon 2 will spawn in his final form immediately
upon entering his screen.  The Bow of Truth becomes a no-use item.`},draygon2PortalAtStart:{type:"bool",id:12,options:{2:!1,3:{5:"=rand()<.2"},9:[13,!0]},comment:`If this is set, the Mezame cryotube becomes a doorway directly to
Draygon 2.  The door is two-way, meaning that it does not provide
access to the two chests buried in the crypt (they still require
the Bows of Sun and Moon to access the normal way).`},noBowMode:{type:"bool",id:13,options:{2:!1,3:{5:"=?"}}},thunderSwordWarp:{type:"ThunderSwordWarp",id:14,options:{2:2,3:{1:1,2:0,3:1,5:"=?",124:0,125:"=?",126:"=?",127:"=?"}},comment:"What happens when the player picks up the Sword of Thunder."},thunderSwordWarpLocation:{type:"LocationName",id:15,options:{2:140,3:{1:242}},comment:"The fixed location to warp to when the player gets the Sword of Thunder.\nThis has no effect unless `thunder_sword_warp` is set to `FIXED`."},thunderSwordWarpItem:{type:"ThunderSwordWarpItem",id:16,options:{2:0},comment:"How to randomize the item that triggers the thunder sword warp."},thunderSwordWarpItemFixed:{type:"ItemName",id:17,options:{2:3},comment:"Item that triggers the warp.  This has no effect unless\n`thunder_sword_item_item` is set to `FIXED`."}}}),(P=>(P.RideDolphin=ye({NOTHING:1,BEACH_KENSU:2,HEALED_DOLPHIN:3},{comment:"What is required for the shell flute to successfully summon the dolphin?",comments:{1:"No additional requirement beyond having shell flute",2:"Player must talk to Kensu in the beach hut (vanilla)",3:"Player must heal the dolphin in the underground channel (default)"}},"RideDolphin",A.Triggers.descriptor),P.SpawnBeachKensu=ye({NOTHING:1,BOAT:2,SHELL_FLUTE:3},{comment:"What is required for Kensu to spawn in the beach house?",comments:{1:"Kensu always spawns (vanilla)",2:"Kensu only spawns after turning in the fog lamp (default)",3:"Kensu only spawns after player has the shell flute"}},"SpawnBeachKensu",A.Triggers.descriptor),P.SpawnFisherman=ye({NOTHING:1,SHELL_FLUTE:2,HEALED_DOLPHIN:3,FOG_LAMP:4},{comment:"What is required for the fisherman to spawn?",comments:{1:"No additional requirement, he always spawns",2:"Fisherman spawns after finding the specific shell flute item (vanilla)",3:"Fisherman spawns after healing the dolphin",4:"Fisherman spawns after finding the fog lamp that he wants (default)"}},"SpawnFisherman",A.Triggers.descriptor),P.ThunderSwordWarp=ye({NONE:0,FIXED:1,RANDOM_TOWN:2},{comments:{}},"ThunderSwordWarp",A.Triggers.descriptor),P.ThunderSwordWarpItem=ye({FIXED:0,SWORD:1,UNIQUE:2,RANDOM:3},{comments:{}},"ThunderSwordWarpItem",A.Triggers.descriptor)))(O=A.Triggers||={})})(R||={});Qd=ye({SWORD_OF_WIND:0,SWORD_OF_FIRE:1,SWORD_OF_WATER:2,SWORD_OF_THUNDER:3,CRYSTALIS:4,BALL_OF_WIND:5,TORNADO_BRACELET:6,BALL_OF_FIRE:7,FLAME_BRACELET:8,BALL_OF_WATER:9,BLIZZARD_BRACELET:10,BALL_OF_THUNDER:11,STORM_BRACELET:12,CARAPACE_SHIELD:13,BRONZE_SHIELD:14,PLATINUM_SHIELD:15,MIRRORED_SHIELD:16,CERAMIC_SHIELD:17,SACRED_SHIELD:18,BATTLE_SHIELD:19,PSYCHO_SHIELD:20,TANNED_HIDE:21,LEATHER_ARMOR:22,BRONZE_ARMOR:23,PLATINUM_ARMOR:24,SOLDIER_SUIT:25,CERAMIC_SUIT:26,BATTLE_ARMOR:27,PSYCHO_ARMOR:28,MEDICAL_HERB:29,ANTIDOTE:30,LYSIS_PLANT:31,FRUIT_OF_LIME:32,FRUIT_OF_POWER:33,MAGIC_RING:34,FRUIT_OF_REPUN:35,WARP_BOOTS:36,STATUE_OF_ONYX:37,OPEL_STATUE:38,INSECT_FLUTE:39,FLUTE_OF_LIME:40,GAS_MASK:41,POWER_RING:42,WARRIOR_RING:43,IRON_NECKLACE:44,DEOS_PENDANT:45,RABBIT_BOOTS:46,LEATHER_BOOTS:47,SHIELD_RING:48,ALARM_FLUTE:49,WINDMILL_KEY:50,KEY_TO_PRISON:51,KEY_TO_STYX:52,FOG_LAMP:53,SHELL_FLUTE:54,EYE_GLASSES:55,BROKEN_STATUE:56,GLOWING_LAMP:57,STATUE_OF_GOLD:58,LOVE_PENDANT:59,KIRISA_PLANT:60,IVORY_STATUE:61,BOW_OF_MOON:62,BOW_OF_SUN:63,BOW_OF_TRUTH:64,REFRESH:65,PARALYSIS:66,TELEPATHY:67,TELEPORT:68,RECOVER:69,BARRIER:70,CHANGE:71,FLIGHT:72},{valuesOptions:{5:{1:["ORB_OF_WIND"]},7:{1:["ORB_OF_FIRE"]},9:{1:["ORB_OF_WATER"]},11:{1:["ORB_OF_THUNDER"]},41:{1:["HAZMAT_SUIT"]}},comments:{}},"ItemName",mn),Zd=ye({MEZAME_SHRINE:0,LEAF__OUTSIDE_START:1,LEAF:2,VALLEY_OF_WIND:3,SEALED_CAVE_1:4,SEALED_CAVE_2:5,SEALED_CAVE_3:6,SEALED_CAVE_4:7,SEALED_CAVE_5:8,SEALED_CAVE_6:9,SEALED_CAVE_7:10,SEALED_CAVE_8:12,WINDMILL_CAVE:14,WINDMILL:15,ZEBU_CAVE:16,MT_SABRE_WEST__CAVE_1:17,CORDEL_PLAINS_WEST:20,CORDEL_PLAINS_EAST:21,BRYNMAER:24,OUTSIDE_STOM_HOUSE:25,SWAMP:26,AMAZONES:27,OAK:28,STOM_HOUSE:30,MT_SABRE_WEST__LOWER:32,MT_SABRE_WEST__UPPER:33,MT_SABRE_WEST__CAVE_2:34,MT_SABRE_WEST__CAVE_3:35,MT_SABRE_WEST__CAVE_4:36,MT_SABRE_WEST__CAVE_5:37,MT_SABRE_WEST__CAVE_6:38,MT_SABRE_WEST__CAVE_7:39,MT_SABRE_NORTH__MAIN:40,MT_SABRE_NORTH__MIDDLE:41,MT_SABRE_NORTH__CAVE_1:42,MT_SABRE_NORTH__CAVE_2:43,MT_SABRE_NORTH__CAVE_3:44,MT_SABRE_NORTH__CAVE_4:45,MT_SABRE_NORTH__CAVE_5:46,MT_SABRE_NORTH__CAVE_6:47,MT_SABRE_NORTH__LEFT_CELL:48,MT_SABRE_NORTH__PRISON_KEY_HALL:49,MT_SABRE_NORTH__RIGHT_CELL:50,MT_SABRE_NORTH__CAVE_7:51,MT_SABRE_NORTH__CAVE_8:52,MT_SABRE_NORTH__SUMMIT_CAVE:53,MT_SABRE_NORTH__ENTRANCE_CAVE:56,MT_SABRE_NORTH__CAVE_5A:57,NADARE__INN:60,NADARE__TOOL_SHOP:61,NADARE__BACK_ROOM:62,WATERFALL_VALLEY_NORTH:64,WATERFALL_VALLEY_SOUTH:65,LIME_TREE_VALLEY:66,LIME_TREE_LAKE:67,KIRISA_PLANT_CAVE_1:68,KIRISA_PLANT_CAVE_2:69,KIRISA_PLANT_CAVE_3:70,KIRISA_MEADOW:71,FOG_LAMP_CAVE_1:72,FOG_LAMP_CAVE_2:73,FOG_LAMP_CAVE_3:74,FOG_LAMP_CAVE_DEAD_END:75,FOG_LAMP_CAVE_4:76,FOG_LAMP_CAVE_5:77,FOG_LAMP_CAVE_6:78,FOG_LAMP_CAVE_7:79,PORTOA:80,PORTOA__FISHERMAN_ISLAND:81,MESIA_SHRINE:82,WATERFALL_CAVE_1:84,WATERFALL_CAVE_2:85,WATERFALL_CAVE_3:86,WATERFALL_CAVE_4:87,TOWER__ENTRANCE:88,TOWER_1:89,TOWER_2:90,TOWER_3:91,TOWER__OUTSIDE_MESIA:92,TOWER__OUTSIDE_DYNA:93,TOWER__MESIA:94,TOWER__DYNA:95,ANGRY_SEA:96,CABIN:97,JOEL__LIGHTHOUSE:98,UNDERGROUND_CHANNEL:100,ZOMBIE_TOWN:101,EVIL_SPIRIT_ISLAND_1:104,EVIL_SPIRIT_ISLAND_2:105,EVIL_SPIRIT_ISLAND_3:106,EVIL_SPIRIT_ISLAND_4:107,SABERA_PALACE_1:108,SABERA_PALACE_2:109,SABERA_PALACE_3:110,JOEL__SECRET_PASSAGE:112,JOEL:113,SWAN:114,SWAN__GATE:115,GOA_VALLEY:120,MT_HYDRA:124,MT_HYDRA__CAVE_1:125,MT_HYDRA__OUTSIDE_SHYRON:126,MT_HYDRA__CAVE_2:127,MT_HYDRA__CAVE_3:128,MT_HYDRA__CAVE_4:129,MT_HYDRA__CAVE_5:130,MT_HYDRA__CAVE_6:131,MT_HYDRA__CAVE_7:132,MT_HYDRA__CAVE_8:133,MT_HYDRA__CAVE_9:134,MT_HYDRA__CAVE_10:135,STYX_1:136,STYX_2:137,STYX_3:138,SHYRON:140,GOA:142,GOA_FORTRESS__OASIS_ENTRANCE:143,DESERT_1:144,OASIS_CAVE__MAIN:145,DESERT_CAVE_1:146,SAHARA:147,SAHARA__OUTSIDE_CAVE:148,DESERT_CAVE_2:149,SAHARA_MEADOW:150,DESERT_2:152,PYRAMID__ENTRANCE:156,PYRAMID__BRANCH:157,PYRAMID__MAIN:158,PYRAMID__DRAYGON:159,CRYPT__ENTRANCE:160,CRYPT__HALL_1:161,CRYPT__BRANCH:162,CRYPT__DEAD_END_LEFT:163,CRYPT__DEAD_END_RIGHT:164,CRYPT__HALL_2:165,CRYPT__DRAYGON_REVISITED:166,CRYPT__TELEPORTER:167,GOA_FORTRESS__ENTRANCE:168,GOA_FORTRESS__KELBESQUE:169,GOA_FORTRESS__ZEBU:170,GOA_FORTRESS__SABERA:171,GOA_FORTRESS__TORNEL:172,GOA_FORTRESS__MADO_1:173,GOA_FORTRESS__MADO_2:174,GOA_FORTRESS__MADO_3:175,GOA_FORTRESS__KARMINE_1:176,GOA_FORTRESS__KARMINE_2:177,GOA_FORTRESS__KARMINE_3:178,GOA_FORTRESS__KARMINE_4:179,GOA_FORTRESS__KARMINE_5:180,GOA_FORTRESS__KARMINE_6:181,GOA_FORTRESS__KARMINE_7:182,GOA_FORTRESS__EXIT:183,OASIS_CAVE__ENTRANCE:184,GOA_FORTRESS__ASINA:185,GOA_FORTRESS__KENSU:186,GOA__HOUSE:187,GOA__INN:188,GOA__TOOL_SHOP:190,GOA__TAVERN:191,LEAF__ELDER_HOUSE:192,LEAF__RABBIT_HUT:193,LEAF__INN:194,LEAF__TOOL_SHOP:195,LEAF__ITEM_SHOP:196,LEAF__STUDENT_HOUSE:197,BRYNMAER__TAVERN:198,BRYNMAER__PAWN_SHOP:199,BRYNMAER__INN:200,BRYNMAER__ARMOR_SHOP:201,BRYNMAER__ITEM_SHOP:203,OAK__ELDER_HOUSE:205,OAK__MOTHER_HOUSE:206,OAK__TOOL_SHOP:207,OAK__INN:208,AMAZONES__INN:209,AMAZONES__ITEM_SHOP:210,AMAZONES__ARMOR_SHOP:211,AMAZONES__ELDER:212,NADARE:213,PORTOA__FISHERMAN_HOUSE:214,PORTOA__PALACE_ENTRANCE:215,PORTOA__FORTUNE_TELLER:216,PORTOA__PAWN_SHOP:217,PORTOA__ARMOR_SHOP:218,PORTOA__INN:220,PORTOA__TOOL_SHOP:221,PORTOA__PALACE_LEFT:222,PORTOA__PALACE_THRONE_ROOM:223,PORTOA__PALACE_RIGHT:224,PORTOA__ASINA_ROOM:225,AMAZONES__ELDER_DOWNSTAIRS:226,JOEL__ELDER_HOUSE:227,JOEL__SHED:228,JOEL__TOOL_SHOP:229,JOEL__INN:231,ZOMBIE_TOWN__HOUSE:232,ZOMBIE_TOWN__HOUSE_BASEMENT:233,SWAN__TOOL_SHOP:235,SWAN__STOM_HUT:236,SWAN__INN:237,SWAN__ARMOR_SHOP:238,SWAN__TAVERN:239,SWAN__PAWN_SHOP:240,SWAN__DANCE_HALL:241,SHYRON__TEMPLE:242,SHYRON__TRAINING_HALL:243,SHYRON__HOSPITAL:244,SHYRON__ARMOR_SHOP:245,SHYRON__TOOL_SHOP:246,SHYRON__INN:247,SAHARA__INN:248,SAHARA__TOOL_SHOP:249,SAHARA__ELDER_HOUSE:250,SAHARA__PAWN_SHOP:251},{comment:"Name of locations",comments:{0:`TODO - matching against these is tricky
- "__" means some sort of extra punctuation?`,1:"outside the cave"}},"LocationName",mn)});var $e=v(()=>{Ls()});var xr,br,we,ma,tt,pa,ga,xa,Gs=v(()=>{xr=class{add(t,e,n){if(typeof arguments[0]!="string")for(let r in arguments[0])this.add(r,arguments[0][r],arguments[1]);else(Array.isArray(t)?t:[t]).forEach(function(r){this[r]=this[r]||[],e&&this[r][n?"unshift":"push"](e)},this)}run(t,e){this[t]=this[t]||[],this[t].forEach(function(n){n.call(e&&e.context?e.context:e,e)})}},br=class{constructor(t){this.jsep=t,this.registered={}}register(...t){t.forEach(e=>{if(typeof e!="object"||!e.name||!e.init)throw new Error("Invalid JSEP plugin format");this.registered[e.name]||(e.init(this.jsep),this.registered[e.name]=e)})}},we=class s{static get version(){return"1.3.9"}static toString(){return"JavaScript Expression Parser (JSEP) v"+s.version}static addUnaryOp(t){return s.max_unop_len=Math.max(t.length,s.max_unop_len),s.unary_ops[t]=1,s}static addBinaryOp(t,e,n){return s.max_binop_len=Math.max(t.length,s.max_binop_len),s.binary_ops[t]=e,n?s.right_associative.add(t):s.right_associative.delete(t),s}static addIdentifierChar(t){return s.additional_identifier_chars.add(t),s}static addLiteral(t,e){return s.literals[t]=e,s}static removeUnaryOp(t){return delete s.unary_ops[t],t.length===s.max_unop_len&&(s.max_unop_len=s.getMaxKeyLen(s.unary_ops)),s}static removeAllUnaryOps(){return s.unary_ops={},s.max_unop_len=0,s}static removeIdentifierChar(t){return s.additional_identifier_chars.delete(t),s}static removeBinaryOp(t){return delete s.binary_ops[t],t.length===s.max_binop_len&&(s.max_binop_len=s.getMaxKeyLen(s.binary_ops)),s.right_associative.delete(t),s}static removeAllBinaryOps(){return s.binary_ops={},s.max_binop_len=0,s}static removeLiteral(t){return delete s.literals[t],s}static removeAllLiterals(){return s.literals={},s}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(t){this.expr=t,this.index=0}static parse(t){return new s(t).parse()}static getMaxKeyLen(t){return Math.max(0,...Object.keys(t).map(e=>e.length))}static isDecimalDigit(t){return t>=48&&t<=57}static binaryPrecedence(t){return s.binary_ops[t]||0}static isIdentifierStart(t){return t>=65&&t<=90||t>=97&&t<=122||t>=128&&!s.binary_ops[String.fromCharCode(t)]||s.additional_identifier_chars.has(String.fromCharCode(t))}static isIdentifierPart(t){return s.isIdentifierStart(t)||s.isDecimalDigit(t)}throwError(t){let e=new Error(t+" at character "+this.index);throw e.index=this.index,e.description=t,e}runHook(t,e){if(s.hooks[t]){let n={context:this,node:e};return s.hooks.run(t,n),n.node}return e}searchHook(t){if(s.hooks[t]){let e={context:this};return s.hooks[t].find(function(n){return n.call(e.context,e),e.node}),e.node}}gobbleSpaces(){let t=this.code;for(;t===s.SPACE_CODE||t===s.TAB_CODE||t===s.LF_CODE||t===s.CR_CODE;)t=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let t=this.gobbleExpressions(),e=t.length===1?t[0]:{type:s.COMPOUND,body:t};return this.runHook("after-all",e)}gobbleExpressions(t){let e=[],n,r;for(;this.index<this.expr.length;)if(n=this.code,n===s.SEMCOL_CODE||n===s.COMMA_CODE)this.index++;else if(r=this.gobbleExpression())e.push(r);else if(this.index<this.expr.length){if(n===t)break;this.throwError('Unexpected "'+this.char+'"')}return e}gobbleExpression(){let t=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",t)}gobbleBinaryOp(){this.gobbleSpaces();let t=this.expr.substr(this.index,s.max_binop_len),e=t.length;for(;e>0;){if(s.binary_ops.hasOwnProperty(t)&&(!s.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!s.isIdentifierPart(this.expr.charCodeAt(this.index+t.length))))return this.index+=e,t;t=t.substr(0,--e)}return!1}gobbleBinaryExpression(){let t,e,n,r,i,o,a,l,c;if(o=this.gobbleToken(),!o||(e=this.gobbleBinaryOp(),!e))return o;for(i={value:e,prec:s.binaryPrecedence(e),right_a:s.right_associative.has(e)},a=this.gobbleToken(),a||this.throwError("Expected expression after "+e),r=[o,i,a];e=this.gobbleBinaryOp();){if(n=s.binaryPrecedence(e),n===0){this.index-=e.length;break}i={value:e,prec:n,right_a:s.right_associative.has(e)},c=e;let d=f=>i.right_a&&f.right_a?n>f.prec:n<=f.prec;for(;r.length>2&&d(r[r.length-2]);)a=r.pop(),e=r.pop().value,o=r.pop(),t={type:s.BINARY_EXP,operator:e,left:o,right:a},r.push(t);t=this.gobbleToken(),t||this.throwError("Expected expression after "+c),r.push(i,t)}for(l=r.length-1,t=r[l];l>1;)t={type:s.BINARY_EXP,operator:r[l-1].value,left:r[l-2],right:t},l-=2;return t}gobbleToken(){let t,e,n,r;if(this.gobbleSpaces(),r=this.searchHook("gobble-token"),r)return this.runHook("after-token",r);if(t=this.code,s.isDecimalDigit(t)||t===s.PERIOD_CODE)return this.gobbleNumericLiteral();if(t===s.SQUOTE_CODE||t===s.DQUOTE_CODE)r=this.gobbleStringLiteral();else if(t===s.OBRACK_CODE)r=this.gobbleArray();else{for(e=this.expr.substr(this.index,s.max_unop_len),n=e.length;n>0;){if(s.unary_ops.hasOwnProperty(e)&&(!s.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!s.isIdentifierPart(this.expr.charCodeAt(this.index+e.length)))){this.index+=n;let i=this.gobbleToken();return i||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:s.UNARY_EXP,operator:e,argument:i,prefix:!0})}e=e.substr(0,--n)}s.isIdentifierStart(t)?(r=this.gobbleIdentifier(),s.literals.hasOwnProperty(r.name)?r={type:s.LITERAL,value:s.literals[r.name],raw:r.name}:r.name===s.this_str&&(r={type:s.THIS_EXP})):t===s.OPAREN_CODE&&(r=this.gobbleGroup())}return r?(r=this.gobbleTokenProperty(r),this.runHook("after-token",r)):this.runHook("after-token",!1)}gobbleTokenProperty(t){this.gobbleSpaces();let e=this.code;for(;e===s.PERIOD_CODE||e===s.OBRACK_CODE||e===s.OPAREN_CODE||e===s.QUMARK_CODE;){let n;if(e===s.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==s.PERIOD_CODE)break;n=!0,this.index+=2,this.gobbleSpaces(),e=this.code}this.index++,e===s.OBRACK_CODE?(t={type:s.MEMBER_EXP,computed:!0,object:t,property:this.gobbleExpression()},t.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),e=this.code,e!==s.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):e===s.OPAREN_CODE?t={type:s.CALL_EXP,arguments:this.gobbleArguments(s.CPAREN_CODE),callee:t}:(e===s.PERIOD_CODE||n)&&(n&&this.index--,this.gobbleSpaces(),t={type:s.MEMBER_EXP,computed:!1,object:t,property:this.gobbleIdentifier()}),n&&(t.optional=!0),this.gobbleSpaces(),e=this.code}return t}gobbleNumericLiteral(){let t="",e,n;for(;s.isDecimalDigit(this.code);)t+=this.expr.charAt(this.index++);if(this.code===s.PERIOD_CODE)for(t+=this.expr.charAt(this.index++);s.isDecimalDigit(this.code);)t+=this.expr.charAt(this.index++);if(e=this.char,e==="e"||e==="E"){for(t+=this.expr.charAt(this.index++),e=this.char,(e==="+"||e==="-")&&(t+=this.expr.charAt(this.index++));s.isDecimalDigit(this.code);)t+=this.expr.charAt(this.index++);s.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+t+this.char+")")}return n=this.code,s.isIdentifierStart(n)?this.throwError("Variable names cannot start with a number ("+t+this.char+")"):(n===s.PERIOD_CODE||t.length===1&&t.charCodeAt(0)===s.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:s.LITERAL,value:parseFloat(t),raw:t}}gobbleStringLiteral(){let t="",e=this.index,n=this.expr.charAt(this.index++),r=!1;for(;this.index<this.expr.length;){let i=this.expr.charAt(this.index++);if(i===n){r=!0;break}else if(i==="\\")switch(i=this.expr.charAt(this.index++),i){case"n":t+=`
`;break;case"r":t+="\r";break;case"t":t+="	";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v";break;default:t+=i}else t+=i}return r||this.throwError('Unclosed quote after "'+t+'"'),{type:s.LITERAL,value:t,raw:this.expr.substring(e,this.index)}}gobbleIdentifier(){let t=this.code,e=this.index;for(s.isIdentifierStart(t)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(t=this.code,s.isIdentifierPart(t));)this.index++;return{type:s.IDENTIFIER,name:this.expr.slice(e,this.index)}}gobbleArguments(t){let e=[],n=!1,r=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let i=this.code;if(i===t){n=!0,this.index++,t===s.CPAREN_CODE&&r&&r>=e.length&&this.throwError("Unexpected token "+String.fromCharCode(t));break}else if(i===s.COMMA_CODE){if(this.index++,r++,r!==e.length){if(t===s.CPAREN_CODE)this.throwError("Unexpected token ,");else if(t===s.CBRACK_CODE)for(let o=e.length;o<r;o++)e.push(null)}}else if(e.length!==r&&r!==0)this.throwError("Expected comma");else{let o=this.gobbleExpression();(!o||o.type===s.COMPOUND)&&this.throwError("Expected comma"),e.push(o)}}return n||this.throwError("Expected "+String.fromCharCode(t)),e}gobbleGroup(){this.index++;let t=this.gobbleExpressions(s.CPAREN_CODE);if(this.code===s.CPAREN_CODE)return this.index++,t.length===1?t[0]:t.length?{type:s.SEQUENCE_EXP,expressions:t}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:s.ARRAY_EXP,elements:this.gobbleArguments(s.CBRACK_CODE)}}},ma=new xr;Object.assign(we,{hooks:ma,plugins:new br(we),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},right_associative:new Set,additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});we.max_unop_len=we.getMaxKeyLen(we.unary_ops);we.max_binop_len=we.getMaxKeyLen(we.binary_ops);tt=s=>new we(s).parse(),pa=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(we).filter(s=>!pa.includes(s)&&tt[s]===void 0).forEach(s=>{tt[s]=we[s]});tt.Jsep=we;ga="ConditionalExpression",xa={name:"ternary",init(s){s.hooks.add("after-expression",function(e){if(e.node&&this.code===s.QUMARK_CODE){this.index++;let n=e.node,r=this.gobbleExpression();if(r||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===s.COLON_CODE){this.index++;let i=this.gobbleExpression();if(i||this.throwError("Expected expression"),e.node={type:ga,test:n,consequent:r,alternate:i},n.operator&&s.binary_ops[n.operator]<=.9){let o=n;for(;o.right.operator&&s.binary_ops[o.right.operator]<=.9;)o=o.right;e.node.test=o.right,o.right=e.node,e.node=n}}else this.throwError("Expected :")}})}};tt.plugins.register(xa)});var dt,Fs=v(()=>{dt={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|="]),updateOperators:[43,45],assignmentPrecedence:.9,init(s){let t=[s.IDENTIFIER,s.MEMBER_EXP];dt.assignmentOperators.forEach(n=>s.addBinaryOp(n,dt.assignmentPrecedence,!0)),s.hooks.add("gobble-token",function(r){let i=this.code;dt.updateOperators.some(o=>o===i&&o===this.expr.charCodeAt(this.index+1))&&(this.index+=2,r.node={type:"UpdateExpression",operator:i===43?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!r.node.argument||!t.includes(r.node.argument.type))&&this.throwError(`Unexpected ${r.node.operator}`))}),s.hooks.add("after-token",function(r){if(r.node){let i=this.code;dt.updateOperators.some(o=>o===i&&o===this.expr.charCodeAt(this.index+1))&&(t.includes(r.node.type)||this.throwError(`Unexpected ${r.node.operator}`),this.index+=2,r.node={type:"UpdateExpression",operator:i===43?"++":"--",argument:r.node,prefix:!1})}}),s.hooks.add("after-expression",function(r){r.node&&e(r.node)});function e(n){dt.assignmentOperators.has(n.operator)?(n.type="AssignmentExpression",e(n.left),e(n.right)):n.operator||Object.values(n).forEach(r=>{r&&typeof r=="object"&&e(r)})}}}});function ya(s){return ba.has(s)}function oe(s){if(typeof s!="number")throw new Error(`expected number, got ${typeof s}`);return s}var pn,ba,Sa,Ds=v(()=>{Gs();Fs();hn();$e();tt.plugins.register(dt);tt.addBinaryOp("**",11,!0);pn=class s extends un{constructor(e){super(R.Preset.descriptor);this.random=e;this.values=new Map}newEvaluator(){return new s(this.random.child())}evaluate(e,n){return e==="?"?n.pick(()=>this.random.next()):n.type.fromJson(this.evalTree(tt.parse(e),n.name==="scripts"))}evalTree(e,n){switch(e.type){case"Literal":if(!Sa.has(typeof e.value))throw new Error(`unsupported literal type: ${typeof e.value}`);return e.value;case"Identifier":if(this.values.has(e.name))return this.values.get(e.name);throw new Error(`unknown variable: ${e.name}`);case"BinaryExpression":{let r=this.evalTree(e.left,n),i=this.evalTree(e.right,n);switch(e.operator){case"+":return oe(r)+oe(i);case"-":return oe(r)-oe(i);case"*":return oe(r)*oe(i);case"**":return oe(r)**oe(i);case"/":return oe(r)/oe(i);case"%":return oe(r)%oe(i);case"==":return r===i;case"!=":return r!==i;case"<":return oe(r)<oe(i);case"<=":return oe(r)<=oe(i);case">":return oe(r)>oe(i);case">=":return oe(r)>=oe(i);default:throw new Error(`unknown operator: ${e.operator}`)}}case"LogicalExpression":{let r=this.evalTree(e.left,n);switch(e.operator){case"&&":return r&&this.evalTree(e.right,n);case"||":return r||this.evalTree(e.right,n);default:throw new Error(`unknown operator: ${e.operator}`)}}case"UnaryExpression":{let r=this.evalTree(e.argument,n);switch(e.operator){case"-":return-oe(r);case"!":return!r;default:throw new Error(`unknown operator: ${e.operator}`)}}case"ConditionalExpression":return this.evalTree(e.test,n)?this.evalTree(e.consequent,n):this.evalTree(e.alternate,n);case"CallExpression":{if(e.callee.type!=="Identifier")throw new Error(`expected simple name, got ${e.callee.type}`);let r=e.callee.name;if(r==="rand"){if(e.arguments.length===0)return this.random.next();if(e.arguments.length===1)return this.random.nextInt(Number(this.evalTree(e.arguments[0],n)));if(e.arguments.length===2){let i=Number(this.evalTree(e.arguments[0],n)),o=Number(this.evalTree(e.arguments[1],n));return i+this.random.nextInt(o-i+1)}throw new Error("rand() takes 0 to 2 arguments")}else if(r==="randn"){if(e.arguments.length)throw new Error("randn() takes 0 arguments");return this.random.nextNormal()}else if(ya(r)){let i=Math[r],o=e.arguments.map(a=>Number(this.evalTree(a,n)));return i.apply(null,o)}else throw new Error(`unknown function: ${r}`)}case"AssignmentExpression":{if(!n)throw new Error("assignment in non-mutable context");if(e.operator!=="=")throw new Error(`unknown operator: ${e.operator}`);let r=this.evalTree(e.right,n);return this.values.set(e.left.name,r),r}default:throw new Error(`unknown node type: ${e.type}`)}}},ba=new Set(["abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","cbrt","expm1","clz32","cos","cosh","exp","floor","hypot","log","log1p","log2","log10","max","min","pow","round","sign","sin","sinh","sqrt","tan","tanh","trunc"]);Sa=new Set(["boolean","number","string"])});function Ps(s){return s.toLowerCase().replace(/[^a-z0-9]/g,"")}var gn,yr,Ge,fe,ct,Re,M,B,G,ve,j,J,Y,q,Q,nt,pe,xn,Bs=v(()=>{de();$e();hn();Ds();gn=s=>"",yr=s=>s===!0?!1:s,Ge=class s{constructor(t,e){this.flag=t;this.opts=e;s.flags.set(t,this)}static{this.flags=new Map}static all(){return[...this.flags.values()]}},fe=class{constructor(t,e,n,r){this.name=e;this.description=n;this.flags=r.map(i=>i instanceof Ge?[i,!0]:i),t.presets.set(Ps(e),this)}static all(){return ct.instance||(ct.instance=new ct),[...ct.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new xn(`@${this.name}`))),this._flagString}};ct=class s{constructor(){this.presets=new Map;this.Casual=new fe(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[J.PreserveUniqueChecks,J.NoShuffleMimics,J.DecreaseEnemyDamage,J.GuaranteeRefresh,J.GuaranteeStartingSword,J.ExperienceScalesFaster,J.NoCommunityJokes,B.NoThunderSwordWarp,Q.Shops,Q.Dyna,[Q.Maps,"!"],pe.SpoilerLog]);this.Classic=new fe(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[J.GuaranteeStartingSword,J.NoCommunityJokes,G.StatueGlitch,[B.NoThunderSwordWarp,"!"],[Q.Maps,"!"],pe.SpoilerLog]);this.Standard=new fe(this,"Standard",`
      Well-balanced, standard race flags.`,[j.RandomizeWeaknesses,B.StoryMode,pe.SpoilerLog]);this.NoBowMode=new fe(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[j.RandomizeWeaknesses,j.TowerRobots,q.MaxScalingInTower,B.NoBowMode,pe.SpoilerLog]);this.Advanced=new fe(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[G.GhettoFlight,G.MtSabreRequirementSkip,G.StatueGlitch,[G.SwordChargeGlitch,"!"],Y.Barrier,Y.BattleMagic,Y.GasMask,q.MaxScalingInTower,j.RandomizeWeaknesses,j.TowerRobots,B.OrbsNotRequired,B.StoryMode,M.RandomizeMaps,M.ShuffleAreas,M.ShuffleHouses,M.RandomizeTrades,M.RandomizeWallElements,M.UnidentifiedKeyItems,pe.SpoilerLog]);this.WildWarp=new fe(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[J.GuaranteeRefresh,M.RandomizeWildWarp,j.RandomizeWeaknesses,j.TowerRobots,B.OrbsNotRequired,B.StoryMode,pe.SpoilerLog]);this.Mystery=new fe(this,"Mystery",`
      Even the options are random.`,[[M.ShuffleAreas,"?"],[M.ShuffleHouses,"?"],[M.RandomizeMaps,"?"],[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"],[M.RandomizeWallElements,"?"],[M.ShuffleGoaFloors,"?"],[M.RandomizeSpriteColors,"?"],[M.RandomizeWildWarp,"?"],[B.OrbsNotRequired,"?"],[B.NoBowMode,"?"],[B.StoryMode,"?"],[B.VanillaDolphin,"?"],[B.NoThunderSwordWarp,"?"],[G.RageSkip,"?"],[G.TriggerSkip,"?"],[G.StatueGlitch,"?"],[G.GhettoFlight,"?"],[G.SwordChargeGlitch,"?"],[G.MtSabreRequirementSkip,"?"],[ve.RandomizeMusic,"?"],[ve.RandomizeMapColors,"?"],[j.RandomizeWeaknesses,"?"],[j.TowerRobots,"?"],[J.NoShuffleMimics,"?"],[J.PreserveUniqueChecks,"?"],[Y.Barrier,"?"],[Y.BattleMagic,"?"],[Y.GasMask,"?"],[Q.Dyna,"?"],[Q.BonusItems,"?"],[Q.Maps,"?"],pe.SpoilerLog]);this.Hardcore=new fe(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[Y.Barrier,Y.BattleMagic,q.ExperienceScalesSlower,q.MaxScalingInTower,q.Permadeath,B.OrbsNotRequired,B.StoryMode,M.RandomizeMaps,M.ShuffleAreas,M.ShuffleHouses,M.RandomizeTrades,M.RandomizeWallElements,M.UnidentifiedKeyItems]);this.Wha=new fe(this,"Wha!?",`
      Wh and Wa - the two flags that give this flagset it's name - shuffle all 
      the houses, overworld connections, and cave connections in the game. 
      Stumbling out of Mezame Shrine directly into the Desert may leave you 
      saying "Wha?!"`,[M.ShuffleAreas,M.ShuffleHouses,[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"],[M.RandomizeWallElements,"?"],M.ShuffleGoaFloors,M.RandomizeSpriteColors,B.StoryMode,B.OrbsNotRequired,G.GhettoFlight,G.StatueGlitch,G.MtSabreRequirementSkip,G.StatueGauntletSkip,[G.SwordChargeGlitch,"!"],[j.RandomizeWeaknesses,"?"],Y.BattleMagic,q.MaxScalingInTower]);this.Wham=new fe(this,"Wham!",`
      This flagset takes everything from the "Wha?!" flagset, and adds only one 
      flag: Wm. Don't be fooled, however: adding randomized maps will definitely
      throw a wrench in things. The complicated logic and routing may feel like
      a punch to the gut - "Wham!"`,[M.RandomizeMaps,M.ShuffleAreas,M.ShuffleHouses,[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"],[M.RandomizeWallElements,"?"],M.ShuffleGoaFloors,M.RandomizeSpriteColors,B.StoryMode,B.OrbsNotRequired,G.GhettoFlight,G.StatueGlitch,G.MtSabreRequirementSkip,G.StatueGauntletSkip,[G.SwordChargeGlitch,"!"],[j.RandomizeWeaknesses,"?"],Y.BattleMagic,q.MaxScalingInTower]);this.FullStupid=new fe(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[Y.Barrier,Y.BattleMagic,q.Blackout,q.ExperienceScalesSlower,q.MaxScalingInTower,q.Permadeath,j.RandomizeWeaknesses,j.TowerRobots,B.OrbsNotRequired,B.StoryMode,M.RandomizeMaps,M.ShuffleAreas,M.ShuffleHouses,M.RandomizeTrades,M.RandomizeWallElements,M.ShuffleGoaFloors,M.UnidentifiedKeyItems]);this.Tournament2024=new fe(this,"Tournament 2024",`
      2024's tournament flags have an emphasis on the randomized
      wild warp flag. This leads to a much wider variety of early
      game plays, and lots of interesting potential routing
      options for clever players.`,[M.RandomizeTrades,[M.UnidentifiedKeyItems,"?"],M.RandomizeWallElements,M.ShuffleGoaFloors,M.RandomizeSpriteColors,M.RandomizeWildWarp,B.StoryMode,B.OrbsNotRequired,B.VanillaDolphin,G.GhettoFlight,G.StatueGlitch,G.MtSabreRequirementSkip,G.StatueGauntletSkip,G.SwordChargeGlitch,ve.RandomizeMusic,ve.RandomizeMapColors,j.RandomizeWeaknesses,j.TowerRobots,Y.BattleMagic,Y.Barrier,Y.GasMask,q.MaxScalingInTower,Q.Maps,Q.Shops]);this.Tournament2023=new fe(this,"Tournament 2023",`
      2023's tournament flags debuted some interesting new flags for a
      unique challenge.`,[M.RandomizeTrades,M.UnidentifiedKeyItems,M.RandomizeWallElements,M.ShuffleGoaFloors,[B.StoryMode,"?"],B.OrbsNotRequired,B.NoThunderSwordWarp,G.GhettoFlight,G.StatueGlitch,G.MtSabreRequirementSkip,j.RandomizeWeaknesses,[j.OopsAllMimics,"?"],j.TowerRobots,Y.BattleMagic,Y.Barrier,q.MaxScalingInTower,[q.ChargeShotsOnly,"?"]]);this.Tournament2022Early=new fe(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[J.GuaranteeStartingSword,G.StatueGlitch,G.StatueGauntletSkip,[j.RandomizeWeaknesses,"?"],B.OrbsNotRequired,B.StoryMode,[B.VanillaDolphin,"?"],[B.NoThunderSwordWarp,"?"],[M.RandomizeWallElements,"?"],[M.ShuffleGoaFloors,"?"],[M.RandomizeSpriteColors,"?"],[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new fe(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[J.GuaranteeStartingSword,"?"],[G.GhettoFlight,"?"],[G.StatueGlitch,"?"],[G.MtSabreRequirementSkip,"?"],[G.StatueGauntletSkip,"?"],q.MaxScalingInTower,[q.NoBuffMedicalHerb,"?"],[j.RandomizeWeaknesses,"?"],[j.TowerRobots,"?"],[Y.Barrier,"?"],[Y.BattleMagic,"?"],B.StoryMode,[B.VanillaDolphin,"?"],[B.OrbsNotRequired,"?"],[B.NoThunderSwordWarp,"?"],[M.RandomizeWallElements,"?"],[M.ShuffleGoaFloors,"?"],[M.RandomizeSpriteColors,"?"],[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new fe(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[J.GuaranteeStartingSword,"?"],G.GhettoFlight,G.StatueGlitch,G.MtSabreRequirementSkip,G.StatueGauntletSkip,q.NoBuffMedicalHerb,q.MaxScalingInTower,[j.RandomizeWeaknesses,"?"],[j.TowerRobots,"?"],Y.Barrier,Y.BattleMagic,B.StoryMode,[B.VanillaDolphin,"?"],[B.OrbsNotRequired,"?"],[B.NoThunderSwordWarp,"?"],M.ShuffleHouses,[M.RandomizeWallElements,"?"],[M.ShuffleGoaFloors,"?"],[M.RandomizeSpriteColors,"?"],[M.RandomizeTrades,"?"],[M.UnidentifiedKeyItems,"?"]])}static get(t){return this.instance||(this.instance=new s),this.instance.presets.get(Ps(t))}},Re=class s{constructor(){this.flags=new Map}static{this.sections=new Set}static all(){return[...this.sections]}static flag(t,e){s.sections.add(this.instance||(this.instance=new this));let n=new Ge(t,e);if(!t.startsWith(this.instance.prefix))throw new Error(`bad flag ${t} ${e}`);return this.instance.flags.set(t,n),n}},M=class s extends Re{constructor(){super(...arguments);this.prefix="W";this.name="World"}static{this.RandomizeMaps=s.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0})}static{this.ShuffleAreas=s.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0})}static{this.ShuffleHouses=s.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0})}static{this.RandomizeTrades=s.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, and Fog
           Lamp.  Rage will expect a random sword, and Tornel will expect a
           random bracelet.`,hard:!0})}static{this.UnidentifiedKeyItems=s.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0})}static{this.RandomizeWallElements=s.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`})}static{this.ShuffleGoaFloors=s.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."})}static{this.RandomizeSpriteColors=s.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`})}static{this.RandomizeWildWarp=s.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 4-15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]})}},B=class s extends Re{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}static{this.StoryMode=s.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`})}static{this.NoBowMode=s.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`})}static{this.OrbsNotRequired=s.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."})}static{this.NoThunderSwordWarp=s.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"})}static{this.VanillaDolphin=s.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`})}},G=class s extends Re{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}static{this.GhettoFlight=s.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`})}static{this.StatueGlitch=s.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"})}static{this.MtSabreRequirementSkip=s.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"})}static{this.StatueGauntletSkip=s.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"})}static{this.SwordChargeGlitch=s.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"})}static{this.TriggerSkip=s.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"})}static{this.RageSkip=s.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"})}},ve=class s extends Re{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}static{this.RandomizeMusic=s.flag("Am",{name:"Randomize background music",modes:"!",optional:yr})}static{this.NoMusic=s.flag("As",{name:"No background music",optional:gn})}static{this.RandomizeMapColors=s.flag("Ac",{name:"Randomize map colors",modes:"!",optional:yr})}},j=class s extends Re{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}static{this.RandomizeWeaknesses=s.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."})}static{this.OopsAllMimics=s.flag("Mg",{name:"Replace all chests with mimics",text:`Every chest is now a mimic, and killing the mimic will drop
           the real item chest. Careful when killing the mimic, if it
           drops the chest out of reach you'll need to reset the room!`,hard:!0})}static{this.TowerRobots=s.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0})}},J=class s extends Re{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}static{this.NoShuffleMimics=s.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."})}static{this.PreserveUniqueChecks=s.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`})}static{this.DecreaseEnemyDamage=s.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`})}static{this.GuaranteeStartingSword=s.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`})}static{this.GuaranteeRefresh=s.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`})}static{this.ExperienceScalesFaster=s.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]})}static{this.NoCommunityJokes=s.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`})}},Y=class s extends Re{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}static{this.BattleMagic=s.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0})}static{this.MatchingSword=s.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0})}static{this.Barrier=s.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0})}static{this.GasMask=s.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0})}},q=class s extends Re{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}static{this.NoBuffMedicalHerb=s.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0})}static{this.MaxScalingInTower=s.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0})}static{this.ExperienceScalesSlower=s.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0})}static{this.ChargeShotsOnly=s.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0})}static{this.Blackout=s.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0})}static{this.Permadeath=s.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0})}},Q=class s extends Re{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}static{this.Dyna=s.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`})}static{this.BonusItems=s.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`})}static{this.Maps=s.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"})}static{this.Shops=s.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`})}static{this.WildWarp=s.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"})}static{this.Hud=s.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:yr})}},nt=class s extends Re{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}static{this.NoAutoEquip=s.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:gn})}static{this.NoControllerShortcuts=s.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:gn})}static{this.AudibleWallCues=s.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:gn})}},pe=class s extends Re{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}static{this.SpoilerLog=s.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`})}static{this.TrainerMode=s.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`})}static{this.NeverDie=s.flag("Di",{name:"Player never dies"})}static{this.NoShuffle=s.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`})}},xn=class s{constructor(t="@Casual"){this._config=void 0;this._gen=void 0;if(typeof t!="string"){this.flags=new Map;for(let[r,i]of t)this.set(r.flag,i);return}if(t.startsWith("@")){let r=ct.get(t.substring(1));if(!r)throw new er(`Unknown preset: ${t}`);this.flags=new Map(r.flags);return}this.flags=new Map,t=t.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,n;for(;n=e.exec(t);){let[,r,i]=n,o=/([!?]|^)([a-z0-9]+)/g;for(;n=o.exec(i);){let[,a,l]=n;for(let c of l)this.set(r+c,a||!0)}}}get config(){if(this._config)return this._config;let t={next:()=>0,nextInt:()=>0,nextNormal:()=>0,child:()=>t},e=new pn(t);return this._config=this.configGen.generate(e)}get configGen(){if(this._gen)return this._gen;let t=new Kt,e=()=>t.placement||(t.placement=new R.PlacementGenerator),n=()=>t.items||(t.items=new R.ItemsGenerator),r=p=>p.quality||(p.quality=new R.QualityGenerator),i=()=>t.options||(t.options=new R.OptionsGenerator),o=()=>t.triggers||(t.triggers=new R.TriggersGenerator),a=()=>t.maps||(t.maps=new R.MapsGenerator),l=()=>t.enemies||(t.enemies=new R.EnemiesGenerator),c=()=>t.towns||(t.towns=new R.TownsGenerator),d=()=>t.glitches||(t.glitches=new R.GlitchesGenerator),f=p=>p.fun||(p.fun=new R.FunGenerator),u=()=>i().accessibility||(i().accessibility=new R.AccessibilityGenerator),h=()=>t.debug||(t.debug=new R.DebugGenerator),m=()=>t.scripts||(t.scripts=[]),{Randomization:g}=R,x=(p,w,b)=>{let T=this.flags.get(p)??!1;b[String(T)]!=null&&w(b[String(T)])},y=new z("?");switch(x(M.RandomizeMaps,p=>a().dungeonMaps=p,{"?":R.Maps.dungeonMaps.preset.mystery,true:!0}),x(M.ShuffleAreas,p=>a().shuffleAreaConnections=p,{"?":R.Maps.shuffleAreaConnections.preset.mystery,true:1}),x(M.ShuffleHouses,p=>a().shuffleHouseEntrances=p,{"?":R.Maps.shuffleHouseEntrances.preset.mystery,true:1}),x(M.RandomizeTrades,p=>c().shuffleTrades=p,{"?":R.Towns.shuffleTrades.preset.mystery,true:!0}),x(M.UnidentifiedKeyItems,p=>n().unidentifiedItems=p,{"?":R.Items.unidentifiedItems.preset.mystery,true:!0}),x(M.RandomizeWallElements,p=>a().wallElements=p,{"?":R.Maps.wallElements.preset.mystery,true:g.RANDOM}),x(M.ShuffleGoaFloors,p=>a().shuffleGoaFloorConnections=p,{"?":R.Maps.shuffleGoaFloorConnections.preset.mystery,true:!0}),x(M.RandomizeSpriteColors,p=>l().paletteSwap=p,{"?":R.Enemies.paletteSwap.preset.mystery,true:!0}),x(M.RandomizeWildWarp,p=>a().wildWarp=p,{"?":R.Maps.wildWarp.preset.mystery,true:R.Maps.WildWarp.RANDOM}),x(B.StoryMode,p=>o().draygon2RequiresAllBosses=p,{"?":R.Triggers.draygon2RequiresAllBosses.preset.mystery,false:!1}),x(B.NoBowMode,p=>o().noBowMode=p,{"?":R.Triggers.noBowMode.preset.mystery,true:!0}),x(B.OrbsNotRequired,p=>n().swordLevelForWalls=p,{"?":new z("rand(1,2)"),false:2}),x(B.NoThunderSwordWarp,p=>o().thunderSwordWarp=p,{"?":R.Triggers.thunderSwordWarp.preset.mystery,"!":R.Triggers.ThunderSwordWarp.FIXED,true:R.Triggers.ThunderSwordWarp.NONE}),x(B.VanillaDolphin,p=>o().vanillaDolphin=p,{"?":R.Triggers.vanillaDolphin.preset.mystery,true:!0}),x(G.GhettoFlight,p=>d().ghettoFlight=p,{"?":new z("rand(1,2)"),true:R.GlitchMode.REQUIRE}),x(G.StatueGlitch,p=>d().statueGlitch=p,{"?":R.Glitches.statueGlitch.preset.mystery,"!":R.GlitchMode.ALLOW,true:R.GlitchMode.REQUIRE}),this.flags.get(G.MtSabreRequirementSkip)){case!0:d().rabbitSkip=d().teleportSkip=R.GlitchMode.REQUIRE;break;case"?":m().push("mtSabreSkip=rand(0,2)"),d().rabbitSkip=d().teleportSkip=new z("mtSabreSkip");break;case"!":d().rabbitSkip=d().teleportSkip=R.GlitchMode.ALLOW;break}switch(x(G.StatueGauntletSkip,p=>d().flightStatueSkip=p,{"?":R.Glitches.flightStatueSkip.preset.mystery,"!":R.GlitchMode.ALLOW,true:R.GlitchMode.REQUIRE}),x(G.SwordChargeGlitch,p=>d().swordChargeGlitch=p,{"?":R.Glitches.swordChargeGlitch.preset.mystery,"!":R.GlitchMode.ALLOW,true:R.GlitchMode.REQUIRE}),x(G.TriggerSkip,p=>d().triggerSkip=p,{"?":R.Glitches.triggerSkip.preset.mystery,"!":R.GlitchMode.ALLOW,true:R.GlitchMode.REQUIRE}),x(G.RageSkip,p=>d().rageSkip=p,{"?":R.Glitches.rageSkip.preset.mystery,"!":R.GlitchMode.ALLOW,true:R.GlitchMode.REQUIRE}),x(ve.RandomizeMusic,([p,w])=>f(p()).randomizeMusic=w,{"?":[i,y],"!":[()=>t,!0],true:[i,!0]}),x(ve.NoMusic,p=>u().disableMusic=p,{true:!0}),x(ve.RandomizeMapColors,([p,w])=>f(p()).paletteSwapBackgrounds=w,{"?":[i,y],"!":[()=>t,!0],true:[i,!0]}),x(j.RandomizeWeaknesses,p=>l().enemyWeaknesses=p,{"?":R.Enemies.enemyWeaknesses.preset.mystery,true:g.SHUFFLE}),x(j.OopsAllMimics,p=>l().itemsFromMimics=p,{"?":new z("rand(2)"),true:1}),x(j.TowerRobots,p=>l().robotsOutsideTower=p,{"?":R.Enemies.robotsOutsideTower.preset.mystery,true:.08}),x(J.NoShuffleMimics,p=>e().mimics=p,{"?":new z("rand(2)"),false:g.VANILLA}),x(J.PreserveUniqueChecks,p=>e().shuffleMimicsWithKeyItems=p,{"?":y,true:!1}),x(J.DecreaseEnemyDamage,p=>l().initialEnemyDamageScalingFactor=p,{"?":new z("(rand(2)*2)/3"),true:.33}),x(J.GuaranteeStartingSword,p=>e().earlySword=p,{"?":y,true:!0}),x(J.GuaranteeRefresh,p=>e().ensureRefreshBeforeBosses=p,{"?":y,true:!0}),x(J.ExperienceScalesFaster,p=>l().expScalingFactor=p,{"?":new z("1+rand(2)*1.5"),true:2.5}),x(J.NoCommunityJokes,p=>f(i()).communityJokes=p,{"?":y,false:0,true:R.Fun.communityJokes.default}),x(Y.BattleMagic,p=>e().ensureMinimumSwordLevelBeforeTetrarchs=p,{"?":new z("1+2*rand(1)"),true:3,false:1}),x(Y.MatchingSword,p=>l().tinkMode=p,{"?":new z("rand()*2"),true:R.GlitchMode.ALLOW}),x(Y.Barrier,p=>e().ensureBarrierBeforeStatues=p,{"?":R.Placement.ensureBarrierBeforeStatues.preset.mystery,true:!0}),x(Y.GasMask,p=>e().ensureGasMaskBeforeSwamp=p,{"?":R.Placement.ensureGasMaskBeforeSwamp.preset.mystery,true:!0}),x(q.NoBuffMedicalHerb,([p,w])=>{n().medicalHerbHeal=p,n().fruitOfPowerMp=w},{"?":[new z("rand(2)*48+32"),new z("rand(2)*24+32")],true:[32,32]}),x(q.MaxScalingInTower,p=>l().maxScalingInTower=p,{"?":R.Enemies.maxScalingInTower.preset.mystery,true:!0}),x(q.ExperienceScalesSlower,p=>l().expScalingFactor=p,{"?":new z("(rand(2)*3+1)/4"),true:1.5}),x(q.ChargeShotsOnly,p=>n().chargeShotOnlyMode=p,{"?":y,true:!0}),x(q.Blackout,p=>a().blackout=p,{"?":y,true:!0}),x(q.Permadeath,p=>l().permadeath=p,{"?":y,true:!0}),x(Q.Dyna,p=>l().buffDyna=p,{"?":R.Enemies.buffDyna.preset.mystery,false:!1}),x(Q.BonusItems,p=>n().vanillaBonusItems=p,{"?":y,true:!0}),x(Q.Maps,p=>[a().addEastCave,a().addWindLimePassage]=p,{"?":[R.Maps.addEastCave.preset.mystery,R.Maps.addEastCave.preset.mystery],"!":[!1,!0],true:[!1,!1]}),this.get(Q.Shops)){case"?":m().push("vanillaShops=rand(2)"),d().shopGlitch=new z("vanillaShops*2"),c().shopContents=new z("1-vanillaShops"),c().rescalePrices=new z("!vanillaShops"),c().priceVariation=new z(".5-vanillaShops/2");break;case!0:d().shopGlitch=R.GlitchMode.ALLOW,c().shopContents=R.Randomization.VANILLA,c().rescalePrices=!1,c().priceVariation=0;break}return x(Q.WildWarp,p=>[a().wildWarp,a().wildWarpInLogic]=p,{"?":[new z("rand(2)"),y],"!":[R.Maps.WildWarp.VANILLA,!1],true:[R.Maps.WildWarp.VANILLA,!0]}),x(Q.Hud,([p,w])=>r(p()).updateHud=w,{"?":[i,y],"!":[()=>t,!1],true:[i,!1]}),x(nt.NoAutoEquip,p=>r(i()).autoEquipBracelet=p,{"?":y,true:!1}),x(nt.NoControllerShortcuts,p=>r(i()).quickSwapSword=r(i()).quickWildWarp=p,{"?":y,true:!1}),x(nt.AudibleWallCues,p=>u().audibleWallCues=p,{true:!0}),this.check(pe.SpoilerLog,!1)&&(t.race=!0),this.check(pe.TrainerMode,!0)&&(h().trainer=!0),this.check(pe.NeverDie,!0)&&(h().neverDie=!0),this.check(pe.NoShuffle,!0)&&(e().algorithm=R.Placement.Algorithm.VANILLA),this._gen=t}filterOptional(){return new s(new Map([...this.flags].map(([t,e])=>[t,t.opts.optional?t.opts.optional(e):e])))}filterRandom(t){function e(n,r){return r!=="?"?r:t.pick([!0,!1,...n.opts.modes||""])}return new s(new Map([...this.flags].map(([n,r])=>[n,e(n,r)])))}toString(){let t=new H(()=>new H(()=>[]));for(let[n,r]of this.flags){if(n.flag.length!==2)throw new Error(`Bad flag ${n.flag}`);if(!r)continue;let i=t.get(n.flag[0]),o=r===!0?"":r;i.get(o).push(n.flag[1])}let e=[];for(let[n,r]of t.sortedEntries()){let i=n;for(let[o,a]of r.sortedEntries())i+=o+a.sort().join("");e.push(i)}return e.join(" ")}toggle(t){let e=Ge.flags.get(t);if(!e)return console.error(`Bad flag: ${t}`),!1;let n=this.flags.get(e)||!1,r=[!1,!0,...e.opts.modes||"","?",!1],i=r.indexOf(n);if(i<0)throw new Error(`Bad current mode ${n}`);let o=r[i+1];return this.flags.set(e,o),this._config=void 0,o}set(t,e){let n=Ge.flags.get(t);if(!n){console.error(`Bad flag: ${t}`);return}if(this._config=void 0,!e)this.flags.delete(n);else if(e===!0||e==="?"||n.opts.modes?.includes(e))this.flags.set(n,e);else{console.error(`Bad flag mode: ${t[0]}${e}${t.substring(1)}`);return}for(let r of n.opts.excludes||[])this.flags.delete(Ge.flags.get(r))}check(t,...e){let n=t instanceof Ge?t:Ge.flags.get(t);return e.length||e.push(!0),e.includes(n&&this.flags.get(n)||!1)}get(t){let e=t instanceof Ge?t:Ge.flags.get(t);return e&&this.flags.get(e)||!1}alwaysMimics(){return this.check(j.OopsAllMimics)}preserveUniqueChecks(){return this.check(J.PreserveUniqueChecks)}shuffleMimics(){return this.check(J.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(Q.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(Q.BonusItems,!1)}slowDownTornado(){return this.check(Q.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(Q.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(Q.BonusItems,!1)||this.check(q.ChargeShotsOnly)}shuffleSpritePalettes(){return this.check(M.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(Q.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(j.TowerRobots)}shuffleMonsterElements(){return this.check(j.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(q.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check(J.DecreaseEnemyDamage)}trainer(){return this.check(pe.TrainerMode)}neverDie(){return this.check(pe.NeverDie)}noShuffle(){return this.check(pe.NoShuffle)}chargeShotsOnly(){return this.check(q.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(Q.Maps,"!")}addEastCave(){return this.check(Q.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(B.VanillaDolphin,!1)}storyMode(){return this.check(B.StoryMode)}noBowMode(){return this.check(B.NoBowMode)}requireHealedDolphinToRide(){return this.check(B.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(B.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(B.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(B.OrbsNotRequired)}shuffleGoaFloors(){return this.check(M.ShuffleGoaFloors)}shuffleHouses(){return this.check(M.ShuffleHouses)}shuffleAreas(){return this.check(M.ShuffleAreas)}mayShuffleAreas(){return!this.check(M.ShuffleAreas,!1)}randomizeMaps(){return this.check(M.RandomizeMaps)}randomizeTrades(){return this.check(M.RandomizeTrades)}unidentifiedItems(){return this.check(M.UnidentifiedKeyItems)}randomizeWalls(){return this.check(M.RandomizeWallElements)}guaranteeSword(){return this.check(J.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(Y.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(Y.MatchingSword,!1)}guaranteeGasMask(){return this.check(Y.GasMask,!1)}guaranteeBarrier(){return this.check(Y.Barrier,!1)}guaranteeRefresh(){return this.check(J.GuaranteeRefresh)}communityJokes(){return this.check(J.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(G.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(G.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(G.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(Q.Shops,!1)}disableStatueGlitch(){return this.check(G.StatueGlitch,!1)}disableRageSkip(){return this.check(G.RageSkip,!1)}disableTriggerGlitch(){return this.check(G.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(G.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(G.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(G.GhettoFlight)}assumeTeleportSkip(){return this.check(G.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(G.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(G.StatueGlitch)}assumeTriggerGlitch(){return this.check(G.TriggerSkip)}assumeFlightStatueSkip(){return this.check(G.StatueGauntletSkip)}assumeWildWarp(){return this.check(Q.WildWarp,!0)||this.check(M.RandomizeWildWarp)}assumeRageSkip(){return this.check(G.RageSkip)}nerfWildWarp(){return this.check(Q.WildWarp,!1)&&this.check(M.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(M.RandomizeWildWarp,!0)}blackoutMode(){return this.check(q.Blackout)}hardcoreMode(){return this.check(q.Permadeath)}buffDyna(){return!this.check(Q.Dyna)}maxScalingInTower(){return this.check(q.MaxScalingInTower)}expScalingFactor(){return this.check(q.ExperienceScalesSlower)?.25:this.check(J.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(t){return t==="early"||this.check(nt.NoAutoEquip,!1)}controllerShortcuts(t){return t==="early"||this.check(nt.NoControllerShortcuts,!1)}randomizeMusic(t){return this.check(ve.RandomizeMusic,t==="early"?"!":!0)}shuffleTilePalettes(t){return this.check(ve.RandomizeMapColors,t==="early"?"!":!0)}noMusic(t){return t==="late"&&this.check(ve.NoMusic)}audibleWallCues(t){return t==="late"&&this.check(nt.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(Q.Hud,!1)}hasStatTracking(){return!0}buryFlightStartSphere(){return 7}validate(){if(this.shuffleAreas()&&this.preserveUniqueChecks())throw new er("Wa and Eu are incompatible")}}});function Ia(s){return"size"in s}var wa,Us,Ws,Ea,bn,Hs,zs,Ta,yn,Ca,Ra,Ma,We,ka,Sn=v(()=>{wa=4656613057391769e-25,Us=2147483562,Ws=40014,Ea=40692,bn=53668,Hs=52774,zs=12211,Ta=3791,yn=32,Ca=1+Math.floor(Us/yn),Ra=12e-8,Ma=1-Ra,We=class s{constructor(t=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(t)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(t){this.idum=Math.max(1,Math.floor(t)),this.idum2=this.idum,this.iy=0,this.iv=new Array(yn).fill(0);for(let e=yn+7;e>=0;e--){let n=Math.floor(this.idum/bn);this.idum=Ws*(this.idum-n*bn)-n*zs,this.idum<0&&(this.idum+=2147483563),e<yn&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let t=Math.floor(this.idum/bn);this.idum=Ws*(this.idum-t*bn)-t*zs,this.idum<0&&(this.idum+=2147483563),t=Math.floor(this.idum2/Hs),this.idum2=Ea*(this.idum2-t*Hs)-t*Ta,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/Ca);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=Us),Math.min(wa*this.iy,Ma)}nextInt(t){return Math.floor(this.next()*t)}nextNormal(t=0,e=1,n=-1/0,r=1/0){for(;;){let i=this.z1;if(i==null){let o=Math.sqrt(-2*Math.log(this.next())),a=ka*this.next();i=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(i=t+i*e,i>=n&&i<=r)return i}}child(){let t=this.nextInt(4294967296),e=this.nextInt(4294967296);return new s(t^e)}shuffle(t){for(let e=t.length;e;){let n=this.nextInt(e--);[t[e],t[n]]=[t[n],t[e]]}return t}*ishuffle(t){let e=[];if(!Array.isArray(t))if(Ia(t)){let n=t[Symbol.iterator]();for(let r=0;r<t.size;r++){let i=r+this.nextInt(t.size-r);for(;e.length<=i;)e.push(n.next().value);yield e[i],e[i]=e[r]}return}else t=[...t];if(!Array.isArray(t))throw new Error("impossible");for(let n=0;n<t.length;n++){let r=n+this.nextInt(t.length-n);yield r in e?e[r]:t[r],e[r]=n in e?e[n]:t[n]}}*ishuffleMetropolis(t,e){let n=[...t];for(let r=n.length-1;r>=0;r--){for(let i=1;i<r;i<<=1){let o=i>>>1,a=(o?this.nextInt(o):0)+o+1,l=n[r][0]-n[r-a][0];if(l<0?2*this.next()>Math.exp(l/e):2*this.next()<Math.exp(-l/e)){let d=n[r];n[r]=n[r-a],n[r-a]=d}}yield n[r][1]}}pick(t){if(!t.length)throw new Error("empty array");return t[this.nextInt(t.length)]}pickWeighted(t){if(!t.length)throw new Error("empty array");let e=0;for(let[r]of t)e+=r;let n=this.next()*e;for(let[r,i]of t){if(n<r)return i;n-=r}throw new Error("bad weights")}pickAndRemove(...t){let e=0;for(let r of t)e+=r.length;if(!e)throw new Error("empty arrays");let n=this.nextInt(e);for(let r of t){if(n<r.length)return r.splice(n,1)[0];n-=r.length}throw new Error("impossible")}bitGenerator(){let t=0,e=0;return()=>{t||(t=32,e=this.nextInt(4294967296)),t--;let n=!(e&1);return e>>>=1,n}}};ka=2*Math.PI});function qs(s){return s>>4&15|s>>8&240}function rt(s,t=1){return s-t*8}function Fe(s,t=1){return s+t*8}function ge(s,t=1){return s-t*2048}function ie(s,t=1){return s+t*2048}var He,st=v(()=>{St();ce();He=class{constructor(t,e){this.height=t;this.width=e;this._coords=void 0;this.data=new Array((t<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let t=[];for(let e=0;e<this.height;e++)for(let n=0;n<this.width;n++)t.push(e<<12|n<<4);return this._coords=t}index(t){return((t&248)>>3)+this.row*(t>>>11)}index2(t,e){return(this.row<<1)*t+2*e}yx(t){let e=t%this.row;return[(t-e)/this.row/2,e/2]}coord(t){let e=t%this.row;return(t-e)/this.row<<11|e<<3}get(t){return this.data[this.index(t)]}set(t,e){this.data[this.index(t)]=e}get2(t,e){return this.data[this.index2(t,e)]}set2(t,e,n){this.data[this.index2(t,e)]=n}plus(t,e,n){return t+(this.row<<1)*e+2*n}x(t){return t%this.row/2}y(t){return Math.floor(t/this.row)/2}border(t,e){let n,r;return t&1?(r=e<<12|2048,n=t&2?this.width<<4:0):(r=t&2?this.height<<12:0,n=e<<4|8),r|n}randomBorder(t,e){let n,r;if(e!=null)e&1?(r=t.nextInt(this.height)<<12|2048,n=e&2?this.width<<4:0):(r=e&2?this.height<<12:0,n=t.nextInt(this.width)<<4|8);else{let i=this.width+this.height,o=t.nextInt(i<<1)-i,a=!1;o<0&&(o=~o,a=!0),o<this.width?(n=o<<4|8,r=a?this.height<<12:0):(r=o-this.width<<12|2048,n=a?this.width<<4:0)}return r|n}oppositeBorder(t){return t&8?t^this.height<<12:t^this.width<<4}furthestBorder(t){return(this.height<<12|this.width<<4)-t}edgeCoordination(t,e){let n=0;if((t&2056)!==2056)throw new Error(`Bad tile: ${re(t)}`);for(let r of[8,-8,2048,-2048]){let i=this.get(t+r);(e?i===e:i)&&n++}return n}isBorder(t){if(t&8){if(t&2048)return!1;let e=t>>>12;return!e||e===this.height}else if(t&2048){let e=t>>>4&15;return!e||e===this.width}return!1}partition(t){let e=new _e;for(let n=0;n<this.data.length;n+=this.row)for(let r=0;r<this.row;r++){let i=n+r,o=this.coord(i);if(!(t?.get(o)??this.data[i]))continue;e.find(o);let l=o-2048;n&&(t?.get(l)??this.data[i-this.row])&&e.union([o,l]);let c=o-8;r&&(t?.get(c)??this.data[i-1])&&e.union([o,c])}return e.map()}show(){let t=[];for(let e=0;e<this.data.length;e+=this.row){let n="";for(let r=0;r<this.row;r++)n+=this.data[e+r]||" ";t.push(n)}return t.join(`
`)}static writeGrid2d(t,e,n){let r=t.index(e);for(let i=0;i<n.length;i++){let o=n[i];for(let a=0;a<o.length;a++){let l=o[a];t.data[r+i*t.row+a]=l!==" "?l:""}}}}});var N,wn,En,je=v(()=>{st();ce();N={ok:!0,value:void 0},wn=class{constructor(t,e){this.rom=t;this.random=e;this.shuffles=[]}add(...t){this.shuffles.push(...t)}shuffleAll(){for(let t of this.shuffles)t.shuffle(this.random);for(let t of this.shuffles)t.meta&&t.finish();for(let t of this.rom.locations)t.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((t,e)=>(t.badness||0)-(e.badness||0)).join(`
`)}},En=class{constructor(t,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new He(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=t,this.orig=t.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let t=this.pickHeight(),e=this.pickWidth(),n=this.pickSize(),r=new He(t,e);r.data.fill(""),Object.assign(this,{h:t,w:e,size:n,grid:r,fixed:new Set,count:0,exitMap:[]})}shuffle(t){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:t});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let t=[];for(let[e,n,r]of this.exitMap)for(let[i,o,a]of t)if(e(i,o)){t.push([n,r,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,n,r]of t){let i=this.meta.rom.locations[r[0]>>>8].meta,o=r[0]&255,a=r[1];this.meta.attach(e,i,o,n,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(t,e){let n=this.posToGrid(t);for(let r=0;r<3;r++)for(let i=0;i<3;i++){let o=n+r*2048+i*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[r*3+i])return!1}for(let r=0;r<3;r++)for(let i=0;i<3;i++){let o=n+r*2048+i*8;this.grid.set(o,e[r*3+i])}return!0}posToGrid(t,e=0){let n=t>>>4,r=t&15;return(n<<12|r<<4)+e}insertPattern(t,{top:e=0,bottom:n=0,left:r=0,right:i=0}={}){let o=t.length-1>>>1,a=t[0].length-1>>>1,l=e+n,c=r+i;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+c)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,f=this.random.nextInt(this.w-a-1-l)+r,u=d+1<<12|f+1<<4;He.writeGrid2d(this.grid,u,t);for(let h=12288;h<=20480;h+=2048)for(let m=48;m<=64;m+=8)this.fixed.add(u+(h|m));return{ok:!0,value:void 0}}extract(t,e,{h:n=3,w:r=3,replace:i=void 0}={}){let o=t.index(e),a="",l=o+n*t.row,{row:c}=t;for(let d=o;d<l;d+=c)for(let f=d;f<d+r;f++){if(i){let u=i.get(t.coord(f));if(u!=null){a+=u||" ";continue}}a+=t.data[f]||" "}return a}canSet(t,e){return this.canSetAll(new Map([[t,e]]))}canSetAll(t){let e=new Set;for(let n of t.keys()){if(this.fixed.has(n))return!1;let r=n&-2057,i=r>>>12,o=r>>>4&15;o<this.w&&i<this.h&&e.add(r),!(n&8)&&i<this.h&&o&&e.add(r-16),!(n&2048)&&o<this.w&&i&&e.add(r-4096),!(n&2056)&&o&&i&&e.add(r-4112)}for(let n of e){let r=this.extract(this.grid,n,{replace:t});if(!this.orig.tileset.getMetascreensFromTileString(r).length)return!1}return!0}addAllFixed(){for(let t=0;t<this.grid.data.length;t++)this.grid.data[t]&&this.fixed.add(this.grid.coord(t))}}});var k,ft,Tn,Sr,Mt,Ye=v(()=>{st();ce();nn();je();St();de();k=class extends En{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let n={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let r of e.rom.locations[e.id].spawns)r.isMonster()&&r.monsterId===143&&n.features.statue++;for(let r of e.allPos()){let i=e.get(r);(!i.isEmpty()||i.data.exits?.length)&&n.size++;for(let o of i.data.exits??[]){let{type:a}=o;if(a==="edge:top"){r>>>4||n.edges[0]++;continue}else if(a==="edge:left"){r&15||n.edges[1]++;continue}else if(a==="edge:bottom"){r>>>4===e.height-1&&n.edges[2]++;continue}else if(a==="edge:right"){(r&15)===e.width-1&&n.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);n.stairs[o.dir>>>1]++;continue}}}i.hasFeature("arena")&&n.features.arena++,i.hasFeature("bridge")&&n.features.bridge++,i.hasFeature("overpass")&&n.features.over++,i.hasFeature("pit")&&n.features.pit++,i.hasFeature("ramp")&&n.features.ramp++,i.hasFeature("spikes")&&n.features.spike++,i.hasFeature("underpass")&&n.features.under++,i.hasFeature("wall")&&n.features.wall++,i.hasFeature("river")&&n.features.river++,i.hasFeature("wide")&&n.features.wide++}return n.size<2&&(e.width>1||e.height>1)&&(n.size=2),n}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let n=this.inferScreens();return n.ok?(e=this.refineMetascreens(n.value),!e.ok||(e=this.checkMetascreens(n.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(n.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=n.value,N)):n}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:N):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),N}fillCave(e){for(let n=.5;n<this.h;n++)for(let r=.5;r<this.w;r++)n>1&&this.grid.set2(n-.5,r,e),r>1&&this.grid.set2(n,r-.5,e),this.grid.set2(n,r,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return N;for(let e=0;e<4;e++){let n=this.params.edges[e]||0;if(!n)continue;let r=ae(e&1?this.h:this.w,i=>this.grid.border(e,i));for(let i of this.random.ishuffle(r))if(!this.grid.get(i)&&(e&1?e===1?this.addLeftEdge(i)&&n--:this.addRightEdge(i)&&n--:e===0?this.addUpEdge(i)&&n--:this.addDownEdge(i)&&n--,!n))break;if(n)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${n} ${e}`}}return N}addUpEdge(e){let n=e+2048,r=n-8,o=r-8-8,a=n+8,c=a+8+8;if(this.grid.isBorder(r)){if(this.grid.get(r))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(c)&&this.grid.get(c))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(r,""),this.grid.set(a,""),!0}addDownEdge(e){let n=e-2048,r=n-8,i=n+8;return!this.grid.get(n)||this.grid.isBorder(r)&&this.grid.get(r)||this.grid.isBorder(i)&&this.grid.get(i)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(r,""),this.grid.set(i,""),!0)}addLeftEdge(e){let n=e+8,r=n-2048,i=n+2048;return!this.grid.get(n)||this.grid.isBorder(r)&&this.grid.get(r)||this.grid.isBorder(i)&&this.grid.get(i)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let n=e-8,r=n-2048,i=n+2048;return!this.grid.get(n)||this.grid.isBorder(r)&&this.grid.get(r)||this.grid.isBorder(i)&&this.grid.get(i)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?N:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?N:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let n=this.grid;for(let r of this.random.ishuffle(this.grid.screens())){let i=r|2056;if(!this.isEligibleArena(i))continue;let o=this.extract(this.grid,r),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(i),n.set(i,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let n=this.grid,r=e-8,i=r-8,o=e+8,a=o+8;return!(n.get(e)!=="c"&&n.get(e)!=="w"||n.get(r)||n.get(o)||!n.isBorder(r)&&n.get(i)||!n.isBorder(o)&&n.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let n=0;for(;e;){let r=this.random.nextInt(this.h-2)+1,i=this.random.nextInt(this.w-2)+1,o=r<<12|i<<4|2056;if(this.grid.get(o)!=="c"){if(++n>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,n,r){if(!e)return!0;for(let i of this.random.ishuffle(this.grid.screens())){let o=i|2056;if(this.grid.get(o)!=="c")continue;if(r){let d=o-r,f=o+r;if(this.grid.get(d)||this.grid.get(f))continue}let a=this.extract(this.grid,i),l=a.substring(0,4)+n+a.substring(5);if(this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,n),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let n=0;for(;e>0;){if(++n>20)return!1;let r=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;r<e-1&&r>this.minSpikes;)this.random.next()<.2&&r--;let i=r>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);r>e-this.minSpikes&&(r>=this.h-2?r=this.h-2:r=e);let a=this.random.nextInt(this.h-r-2)+1<<12|i<<4|2056,l=a+(r-1<<12);for(let f=a-4096;r&&f<=l+4096;f+=2048)this.grid.get(f)!=="c"&&(r=0);if(!r)continue;let c=[a-8,a+8,l-8,l+8],d=this.tryClear(c);if(d.length){for(let f of d)this.grid.set(f,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let f=a;f<=l;f+=2048)this.fixed.add(f),this.grid.set(f,"s");e-=r,n=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let n=new Map;for(let c of e){if(this.fixed.has(c))return[];n.set(c,"")}let r=this.grid.partition(n),[i]=r.values();if(i.size===r.size)return[...e];let o=new Set,a=new Set(r.values());for(let c of this.fixed)o.add(r.get(c));if(o.size>this.maxPartitions)return[];let l=[...e];for(let c of a)o.has(c)||l.push(...c);return l}refine(){let e=new Set;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]&&e.add(this.grid.coord(r));let n=0;for(;this.count>this.size;){if(n++>50)throw new Error("refine failed: attempts");let r=0;for(let i of this.random.ishuffle([...e])){if(this.grid.isBorder(i)||!this.canRemove(this.grid.get(i))||this.fixed.has(i))continue;if(r>3)break;let o=this.grid.partition(this.removalMap(i)),[a]=o.values();if(a.size===o.size&&o.size>1)r++,e.delete(i),(i&2056)===2056&&this.count--,this.grid.set(i,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let c=[...l].filter(d=>(d&2056)==2056).length;if(c<this.size)continue;r++,e=l,this.count=c,this.grid.set(i,"");for(let[d,f]of o)f!==l&&this.grid.set(d,"")}}if(!r)return this.looseRefine?N:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return N}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let n=this.grid.partition(new Map),r=n.size,i=new Set(n.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===i)&&a.size===r-1&&(r--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let n=0;n<this.w;n++){let r=e<<12|2056|n<<4;if(this.grid.get(r))continue;let i=r-2048,o=r+2048,a=r-8,l=r+8;(this.grid.get(i)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(i,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let n=e<<12|2048;for(let r=0;r<this.w-1;r++){let i=n|r<<4|8;this.isTightLoop(i)&&this.breakTightLoop(i)}}}isTightLoop(e){for(let n=0;n<6144;n+=2048)for(let r=0;r<24;r+=8){let i=n|r;if(i!==2056&&this.grid.get(e+i)!=="c")return!1}return!0}breakTightLoop(e){let n=this.random.nextInt(65536),r=n&1?n&4096|8:n&16|2048;this.grid.set(e+r,"")}addStairs(e=0,n=0){let r=[e,n];if(!r[0]&&!r[1])return N;for(let i of this.random.ishuffle(this.grid.screens()))if(this.tryAddStair(i,r)&&!r[0]&&!r[1])return N;return{ok:!1,fail:"stairs"}}addEarlyStair(e,n){let r=[],i=e-8,o=e+8,a=e-2048,l=e+2048,c=[e-8,e+8];if(n==="<"){if(c.push(l),r.push([a,""]),this.grid.get(i)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return r.push([l,""],[e,"<"]),r}else n===">"&&(c.push(a),r.push([l,""]));if(c=c.filter(f=>this.grid.get(f)==="c"),!c.length)return[];let d=this.random.nextInt(c.length);for(let f=0;f<c.length;f++)f!==d&&r.push([c[f],""]);return r.push([e,n]),r}tryAddStair(e,n){if(this.fixed.has(e|2056))return!1;let r=this.extract(this.grid,e),i=n[0]&&n[1],o=n[0]+n[1],a=this.random.nextInt(o)<n[0],l=[a?0:1];i&&l.push(a?1:0);for(let c of l){let d="<>"[c],f=r.substring(0,4)+d+r.substring(5);if(this.orig.tileset.getMetascreensFromTileString(f).length)return this.grid.set(e|2056,d),n[c]--,!0}return!1}tryConnect(e,n,r,i=1){for(;i-- >0;){let o=new Map,a=e;if((e&n&2056)!==2056)throw new Error(`bad start ${re(e)} or end ${re(n)}`);for(o.set(a,r);a!==n;){let l=[];for(let h of[8,-8,2048,-2048]){let m=a+h,g=a+2*h;this.fixed.has(g)||(o.get(g)??this.grid.get(g))||this.grid.isBorder(m)||l.push(h)}if(!l.length)break;let c=(n>>12)-(a>>12),d=(n&240)-(a&240),f=new Set(l);c<0&&f.delete(2048),c>0&&f.delete(-2048),d<0&&f.delete(8),d>0&&f.delete(-8),l.push(...f,...f);let u=this.random.pick(l);o.set(a+u,r),o.set(a=a+2*u,r)}if(a===n){for(let[l,c]of o)this.grid.set(l,c),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,n=1){let r=new _e;for(let l=0;l<this.grid.data.length;l++){let c=this.grid.coord(l);this.grid.get(c)||this.grid.isBorder(c)||(this.grid.get(Fe(c))||r.union([c,Fe(c)]),this.grid.get(ie(c))||r.union([c,ie(c)]))}let i=new H(()=>[]);for(let l of this.grid.screens()){let c=l+2056;if(this.grid.get(c))for(let d of[8,-8,2048,-2048]){let f=c+d;if(this.grid.isBorder(f)||this.grid.get(f))continue;let u=c+2*d;if(this.grid.get(u))continue;let h=new Map([[f,e]]),m=this.extract(this.grid,l,{replace:h});this.orig.tileset.getMetascreensFromTileString(m).length&&i.get(r.find(u)).push([f,u])}}let o=new Map;for(let l of i.values())if(!(l.length<2))for(let[c]of l)o.set(c,l);let a=[...o.values()];if(!a.length)return!1;for(;n-- >0;){let l=this.random.pick(a),[[c,d],[f,u]]=this.random.ishuffle(l);if(this.grid.set(c,e),this.grid.set(f,e),this.tryConnect(d,u,e,5))return!0;this.grid.set(c,""),this.grid.set(f,"")}return!1}tryExtrude(e,n,r=1){for(;r--;)for(let i of this.random.ishuffle(this.grid.screens())){let o=i+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,i);for(let l of this.random.ishuffle([0,1,2,3])){let c=o+Mt[l],d=o+2*Mt[l];if(this.grid.get(c)||this.grid.isBorder(c)||this.grid.get(d))continue;let f=Sr[l],u=a.substring(0,f)+e+a.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(u).length){this.grid.set(c,e),this.grid.set(d,e);let h=this.tryContinueExtrude(e,n,d);if(h)return h;this.grid.set(d,""),this.grid.set(c,"")}}}return 0}tryContinueExtrude(e,n,r){let i=this.extract(this.grid,r-2056),o=this.orig.tileset.getMetascreensFromTileString(i).length>0;if(n===1)return o?1:0;if(o&&!this.random.nextInt(n))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=r+Mt[a],c=r+2*Mt[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(c))continue;let d=Sr[a],f=i.substring(0,d)+e+i.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(l,e),this.grid.set(c,e);let u=this.tryContinueExtrude(e,n-1,c);if(u)return u+1;this.grid.set(c,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let n=this.orig.tileset,{attempts:r=1,char:i="c",start:o,loop:a=!1}=e;for(let l=0;l<r;l++){let c=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of c){let f=d+2056;if(!this.grid.get(f))continue;let u=this.extract(this.grid,d);for(let h of this.random.ishuffle([0,1,2,3])){let m=f+Mt[h],g=f+2*Mt[h];if(this.fixed.has(m)||this.fixed.has(g))continue;let x=this.grid.get(m),y=this.grid.get(g);if(x&&(y||x!==i)||this.grid.isBorder(m))continue;if(!a){let b=this.extract(this.grid,g-2056,{replace:new Map([[m,""]])});if(/\S/.test(b))continue}let p=Sr[h],w=u.substring(0,p)+i+u.substring(p+1);if(n.getMetascreensFromTileString(w).length){this.count++,this.grid.set(m,i),this.grid.set(g,i);let b=this.extract(this.grid,g-2056);if(n.getMetascreensFromTileString(b).length)return 1;this.grid.set(g,y),this.grid.set(m,x),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:N}preinferSpikes(){return N}inferScreens(){let e=[];for(let i of this.grid.screens()){let o=this.extract(this.grid,i),a=this.orig.tileset.getMetascreensFromTileString(o).filter(c=>!c.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${re(i)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let n=!0,r=new Ae(this.params.id,this.orig.tileset,this.h,this.w);for(let i=0;i<this.h;i++)for(let o=0;o<this.w;o++){let a=e[i*this.w+o];if(r.set(i<<4|o,a),a.isEmpty()||(n=!1),i){let l=r.get(i-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${i}${o}: ${l.name} ${a.name}`}}if(o){let l=r.get(i<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${i}${o}: ${l.name} ${a.name}`}}}return n?{ok:!1,fail:"all screens empty"}:{ok:!0,value:r}}refineMetascreens(e){let n=this.params.features?.bridge||0,r=this.params.features?.wall||0;for(let i of this.random.ishuffle(e.allPos())){let o=(i<<8|i<<4)&61680,a=this.extract(this.grid,o),l=e.get(i);if(!(this.bridges<=n&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,i,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,i,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<r&&!l.hasFeature("wall")&&this.tryMeta(e,i,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==n?{ok:!1,fail:`refineMeta bridges want ${n} got ${this.bridges}
${e.show()}`}:this.walls!==r?{ok:!1,fail:`refineMeta walls want ${r} got ${this.walls}
${e.show()}`}:N}tryMeta(e,n,r){for(let i of r)if(this.checkMeta(e,new Map([[n,i]])))return e.set(n,i),!0;return!1}checkMeta(e,n){let r=n?{with:n}:{},i=e.traverse(r);return new Set(i.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let n=!1,r=!1;for(let i of e.allPos()){let o=e.get(i);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(n=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(r=!0),n&&r)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return N;let n=0;for(let r of e.allPos()){let i=e.get(r);n+=i.data.statues?.length||0}return n<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:N}},ft=class extends k{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,n=super.addEdges();if(!n.ok)return n;let r=this.params.features?.arena;if(!r)return N;let i=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&i.push(a)}if(i.length<r)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(i)){if(!r)break;let a=o-8,l=a-8,c=l-8,d=l-2048,f=l+2048,u=o+8,h=u+8,m=h+8,g=h-2048,x=h+2048;!e.isBorder(a)&&(e.isBorder(c)&&e.get(c)||e.isBorder(d)&&e.get(d)||e.isBorder(f)&&e.get(f))||!e.isBorder(u)&&(e.isBorder(m)&&e.get(m)||e.isBorder(g)&&e.get(g)||e.isBorder(x)&&e.get(x))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(u,""),e.set(h,""),this.grid.set(o,"a"),r--)}return N}addArenas(){return!0}},Tn=class extends k{refineMetascreens(t){for(let e=0;e<this.h;e++)for(let n=0;n<this.w;n++)this.grid.get(e<<12|n<<4|2056)==="a"&&t.set(e<<4|n,t.rom.metascreens.cryptArena_statues);return super.refineMetascreens(t)}isEligibleArena(t){return!this.grid.get(t-2048)&&super.isEligibleArena(t)}},Sr=[1,3,7,5],Mt=[-2048,-8,2048,8]});function Cn(s,t,e=!1){let n=new Er(s,t,e),r=new wr(t,n,e);return[n,r]}var wr,Er,Vs=v(()=>{Ye();st();de();je();wr=class extends k{constructor(e,n,r){super(e);this.location=e;this.under=n;this.reverse=r;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,n]of le.zip(this.under.upStairs,this.downStairs))this.meta.attach(n,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let n=16,r=0,i=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let c=l>>>4,d=l&15;n=Math.min(d,n),r=Math.max(d,r),i=Math.min(c-a,i),o=Math.max(c+a,o)}e:for(let l=0;l<10;l++){let c=[],d=this.random.nextInt(this.w-(r-n))+n,u=this.random.nextInt(this.h-(o-i))+i-i<<4+(d-n);for(let h of this.under.underBridges){let m=h+u,g=m>>>4,x=m&15,y=g<<12|x<<4|2056;if(this.grid.get(y)!=="c")continue e;c.push([y,"b"]),c.push([y-8,""]),c.push([y+8,""])}for(let h of this.under.upStairsEffective){let m=h+u,g=m>>>4,x=m&15,y=g<<12|x<<4|2056;if(this.grid.get(y)!=="c")continue e;c.push([y,this.reverse?"<":">"]),c.push([y+(this.reverse?-2048:2048),""]);let p=this.addEarlyStair(y,this.reverse?"<":">");if(!p.length)continue e;c.push(...p)}for(let[h,m]of c)m&&this.fixed.add(h),(m==="<"||m===">")&&this.downStairs.push(qs(h)),this.grid.set(h,m);return N}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,n=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,n):super.addStairs(e,n-this.under.upStairs.length)}addOverpasses(){return!0}},Er=class extends k{constructor(e,n,r){super(e);this.loc=e;this.overpass=n;this.reverse=r;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let n=this.reverse?"stair:down":"stair:up";for(let i of this.meta.allPos()){let o=this.meta.get(i);if(o.hasFeature("underpass")&&this.underBridges.push(i),o.hasFeature(n)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(i+a),this.upStairs.push(i)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let r=0;for(let[,i,[o]]of this.orig.exits())i===n&&o>>>8===this.overpass.id&&r++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,r),N}}});var ut,Rn,Ks=v(()=>{Ye();ut=class extends k{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let r=0;r<this.h;r++)for(let i=0;i<this.w;i++){let o=r<<12|i<<4|2056;this.grid.get(o)&&e.push(o)}let n=e.filter(r=>this.tryClear([r]).length===1);if(!n.length)return{ok:!1,fail:"all critical?"};for(let r=0;r<n.length;r++)for(let i=0;i<r;i++)if(this.tryClear([n[r],n[i]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},Rn=class extends ut{removeTightLoops(){}}});var Je,Mn,Oa,_a,In=v(()=>{st();de();St();Je=class{constructor(t,e,n){this.h=t;this.w=e;this.valid=n;this.fixed=new Set;this.size=0;this.data=new Uint8Array(t*e)}fill(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let n=t*this.w+e;t>0&&(this.data[n]|=1),e>0&&(this.data[n]|=2),t<this.h-1&&(this.data[n]|=4),e<this.w-1&&(this.data[n]|=8)}}isBorder(t,e){let n=t%this.w,r=(t-n)/this.w;return this.isBorder2(r,n,e)}isBorder2(t,e,n){if(n===0)return!t;if(n===1)return!e;if(n===2)return t>=this.h-1;if(n===3)return e>=this.w-1;throw new Error("bad direction")}delete2(t,e,n=t*this.w+e){if(this.fixed.has(n))return!1;let r=new Map;r.set(n,0);for(let i=0;i<4;i++){if(this.isBorder2(t,e,i))continue;let o=n+this.delta(i),a=this.data[o],l=a&~(1<<(i^2));if(a!==l){if(this.fixed.has(o))return!1;r.set(o,l)}}return this.try(r)}delete(t){let e=t%this.w,n=(t-e)/this.w;return this.delete2(n,e,t)}deleteEdge2(t,e,n,r=t*this.w+e){if(this.fixed.has(r))return!1;if(this.isBorder2(t,e,n))return this.data[r]&=~(1<<n),!0;let i=new Map,o=r+this.delta(n);return this.fixed.has(o)?!1:(i.set(r,this.data[r]&~(1<<n)),i.set(o,this.data[o]&~(1<<(n^2))),this.try(i))}deleteEdge(t,e){let n=t%this.w,r=(t-n)/this.w;return this.deleteEdge2(r,n,e,t)}refine(t,e){let n=0,r=new Set;for(let i=0;i<this.data.length;i++)this.data[i]&&n++,this.fixed.has(i)||r.add(i);for(;n>e;){let i=!1;for(let o of t.ishuffle(r)){if(n<=e)break;if(!this.data[o]){n--;continue}this.delete(o)&&(i=!0,n--)}if(!i)return!1}return!0}validate(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let n=t*this.w+e,r=this.data[n];if(t&&!(this.data[n-this.w]&4)!=!(r&1))throw new Error(`invalid above ${t}${e}`);if(e&&!(this.data[n-1]&8)!=!(r&2))throw new Error(`invalid left of ${t}${e}`)}}addEdge(t,e,n){let r=t*this.w+e;this.data[r]|=1<<n,this.isBorder2(t,e,n)||(this.data[r+this.delta(n)]|=1<<(n^2))}consolidate(t,e){let n=new tr;for(let i=0;i<this.data.length;i++)!this.fixed.has(i)&&this.data[i]&&n.add(this.data[i]);let r=1e3;for(;n.unique()>e&&--r;){let i=[...n].sort((c,d)=>d[1]-c[1]),o=i[e][1],a=new Set(i.filter(c=>c[1]<=o).map(c=>c[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[c,d]of t.pick(l))this.data[c]&&n.delete(this.data[c]),d&&n.add(d),this.data[c]=d}return r?[...n].map(i=>i[0]):[]}consolidateFixed(t,e){let n=new tr;for(let i=0;i<this.data.length;i++){let o=this.data[i];!this.fixed.has(i)&&e.has(o)&&n.add(o)}let r=1e3;for(;n.unique()&&--r;){let i=this.findEligibleConsolidates(e);if(!i.length)return!1;for(let[o,a]of t.pick(i)){let l=this.data[o];e.has(l)&&n.delete(l),e.has(a)&&n.add(a),this.data[o]=a}}return!!r}findEligibleConsolidates(t){let e=[],n=[];for(let r=0;r<this.data.length;r++){if(this.fixed.has(r))continue;let i=this.data[r];if(t.has(i))for(let o=0;o<4;o++){if(this.isBorder(r,o))continue;let a=this.delta(o);if(this.fixed.has(r+a))continue;let l=1<<o;if(t.has(i^l))continue;let c=1<<(o^2),d=this.data[r+a],f=new Map([[r,i^l],[r+a,d^c]]);if(this.check(f)&&(e.push(f),!t.has(d^c)&&t.has(d))){n.push(f);break}}}return n.length?n:e}try(t){if(!this.check(t))return!1;for(let[e,n]of t)this.data[e]=n;return!0}check(t){let e=new _e;for(let n=0;n<this.h;n++)for(let r=0;r<this.w;r++){let i=n*this.w+r,o=t?.get(i)??this.data[i];o&&e.union([i]),n>0&&o&1&&e.union([i,i-this.w]),r>0&&o&2&&e.union([i,i-1]),n<this.h-1&&o&4&&e.union([i,i+this.w]),r<this.w-1&&o&8&&e.union([i,i+1])}return e.roots().length===1}addPath(t,e){let n,r;if(!this.size)n=t.nextInt(this.h),r=t.nextInt(this.w);else{let c=[];for(let f=0;f<this.data.length;f++)this.data[f]&&this.data[f]!==15&&c.push(f);if(!c.length)return!1;let d=t.pick(c);r=d%this.w,n=(d-r)/this.w}let i=new Map,o=n*this.w+r,a=0,l=!0;for(;;){let c=!1,d=i.get(o)??this.data[o],f=!1;for(let u of t.ishuffle([0,1,2,3])){let h=1<<u;if(d&h)continue;let m=d|h;if(this.valid&&!this.valid.has(m))continue;let g=n+Oa[u],x=r+_a[u];if(g<0||x<0||g>=this.h||x>=this.w)continue;let y=g*this.w+x,p=i.get(y)??this.data[y],w=p|1<<(u^2);if(p){if(p===w||this.valid&&!this.valid.has(w))continue;c=!0}l=!this.valid||this.valid.has(w),i.set(o,m),i.set(y,w),r=x,n=g,o=y,f=!0;break}if(!f||c||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&t.nextInt(15)<a++)break}if(!i.size||!l)return!1;for(let[c,d]of i)this.data[c]=d;return!0}toGrid(t){let e=new He(this.h,this.w);for(let n=0;n<this.h;n++)for(let r=0;r<this.w;r++){let i=n*this.w+r,o=this.data[i];if(!o)continue;let a=n<<12|r<<4|2056;e.set(a,t);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let c=l&1?8:2048;e.set(l&2?a+c:a-c,t)}}return e}delta(t){return(t&2?1:-1)*(t&1?1:this.w)}show(){let t=[];for(let e=0;e<this.h;e++){let n="";for(let r=0;r<this.w;r++)n+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+r]];t.push(n)}return t.join(`
`)}},Mn=class{constructor(t,e,n){this.grid=t;this._i=e*t.w+n}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(t){let e=this.grid.delta(t),n=this._i+e,r=1<<t,i=1<<(t^2);this.grid.data[this._i]|=r,this.grid.data[this._i=n]|=i}directedPath(t,e,n){for(;;){let r=this.y,i=this.x,o=[];if(e<r&&o.push(0),n<i&&o.push(1),e>r&&o.push(2),n>i&&o.push(3),!o.length)return;this.go(t.pick(o))}}},Oa=[-1,0,1,0],_a=[0,-1,0,1]});var $t,kn,Tr=v(()=>{In();Ye();je();ce();$t=class extends k{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(n=>this.grid.get(n+2056)).length,N)}initialFillEarly(){let e=new Je(this.h,this.w,this.getValidEarlyScreens()),n=0,r=this.targetEarly();for(;n++<20&&e.size<r;)e.addPath(this.random,r)&&(n=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),N}initialFillLate(){for(let e=0;e<this.h;e++)for(let n=0;n<this.w;n++){let r=e<<12|n<<4|2056;this.grid.get(r)||this.grid.set(r,"c")}for(let e=0;e<this.h;e++)for(let n=0;n<this.w;n++)for(let r of[8,2048]){let i=e<<12|n<<4|2056,o=i+r,a=i+2*r;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(i)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let n of[8,2048]){let r=e|2056,i=r+n,o=r+2*n;if(this.grid.isBorder(i)||this.grid.get(i))continue;this.grid.set(i,"c");let a=this.extract(this.grid,r-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(i,"")}return N}pruneDisconnected(){let e=new Set(this.grid.partition().values()),n=0;for(let r of e)if([...r].some(o=>this.grid.get(o)===this.early))n+=[...r].filter(o=>(o&2056)===2056).length;else for(let o of r){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${re(o)} disconnected`};this.grid.set(o,"")}return n<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):N}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let n of this.orig.tileset){let r=n.edgeIndex(this.early);r!=null&&e.add(r)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},kn=class extends $t{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new Je(this.h,this.w);e.fill();let n=ae(e.data.length).slice(e.w),r=this.random.pick(n);if(!e.deleteEdge(r,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(r,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(r,3))return{ok:!1,fail:"initial stair"};e.fixed.add(r);let i=new Set(n);i.delete(r);let o=[];for(let d of this.random.ishuffle(i)){let f=function(x){return e.delete(x)?(e.fixed.add(x),!0):!1},u=this.params.features?.arena??0;if(o.length>=u)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let h=!e.isBorder(d,1),m=!e.isBorder(d,3);if(h&&e.fixed.has(d-1)||m&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!f(d-e.w))return{ok:!1,fail:"initial arena"};if(h&&!f(d-1))return{ok:!1,fail:"initial arena"};if(m&&!f(d+1))return{ok:!1,fail:"initial arena"};let g=d+e.w;if((e.data[g]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(g,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(g,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(g+e.w,2),e.fixed.add(g),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,f)=>{let u=d%e.w,m=(d-u)/e.w<<12|u<<4|2056;this.grid.set(m,f);for(let g of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(m+g)};l(r,">");for(let d of o)l(d,"a");let c=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&c++;return this.size=c,N}addStairs(e,n){return super.addStairs(e,n?n-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let n=e<<12|2056;for(let r=0;r<this.w;r++){let i=n|r<<4;this.grid.get(i)==="a"&&this.grid.set(i-2048,"c")}}return N}preinfer(){let e=new Map;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]==="w"&&e.set(this.grid.coord(i),"");let n=this.grid.partition(e),r=new Set;for(let[i,o]of n)this.grid.get(i)==="<"&&r.add(o);return r.size<2?{ok:!1,fail:"stairs bunched"}:N}refineMetascreens(e){for(let n of e.allPos())e.get(n).hasFeature("arena")&&e.set(n,e.rom.metascreens.fortressArena_through);return N}refineEdges(){return!0}}});var Xe,On,_n,Cr,Aa,An,vn,$s=v(()=>{Ye();st();In();je();Tr();ce();de();Xe=class extends $t{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return N;let e=new Map;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]==="r"&&e.set(this.grid.coord(i),"");let n=this.grid.partition(e),r=[];for(let i=0;i<this.grid.data.length;i++)(this.grid.data[i]==="<"||this.grid.data[i]===">"||this.grid.data[i]&&this.grid.isBorder(this.grid.coord(i)))&&r.push(n.get(this.grid.coord(i)));return new Set(r).size<r.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return N}addArenas(e){if(!e)return!0;let n=this.grid;for(let r of this.random.ishuffle(this.grid.screens())){let i=r|2056,o=i-8,a=o-8,l=i+8,c=l+8,d=i-2048,f=i+2048;if(n.get(i)!=="c"||n.get(d)!=="c"||n.get(f)!=="c")continue;let u=n.isBorder(o)?"":this.extract(n,a-2056),h=n.isBorder(l)?"":this.extract(n,c-2056);if(!/[^ c]/.test(u+h)&&(n.isBorder(o)||(n.set(o,""),n.set(a,""),n.set(a-8,""),n.set(a-2048,""),n.set(a+2048,"")),n.isBorder(l)||(n.set(l,""),n.set(c,""),n.set(c+8,""),n.set(c-2048,""),n.set(c+2048,"")),this.fixed.add(i),this.fixed.add(d),this.fixed.add(f),n.set(i,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},On=class extends Xe{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new Je(this.h,this.w,this.getValidEarlyScreens()),n=2+this.random.nextInt(this.w-4),r=2+this.random.nextInt(this.w-4),i=new Mn(e,this.h-1,r);return i.go(0),i.directedPath(this.random,1,n),i.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),N}addEdges(){let e=-1,n=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(n|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let r=n|this.random.nextInt(e)<<4,i=n|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(r,">"),this.grid.set(r-8,""),this.grid.set(r+8,""),this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.fixed.add(r),this.fixed.add(i),N}addStairs(){return N}checkMeta(e,n){let r=n?{flight:!0,with:n}:{flight:!0},i=e.traverse(r);return new Set(i.values()).size===this.maxPartitions}},_n=class extends k{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new H(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let f=0;for(let u=0;u<4;u++)d.data.edges[u]==="s"&&(f|=1<<u);e.get(f).push(...d.gridTiles())}let n=1+this.random.nextInt(this.w-2),r=1+this.random.nextInt(this.h-2),i=r<<4|n,o=this.posToGrid(i,2056),a=r<this.h/2?2:0;this.insertTile(i,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){i+=Aa[a],o=o+Cr[a];let f=a^2,u=[];for(let[m,g]of e){if(!(m&1<<f))continue;let x=m&~(1<<f);if(!(d?!x:x))for(let y of g)u.push(m)}let h;for(let m of this.random.ishuffle(u))if(!this.grid.isBorder(o+Cr[m])&&this.insertTile(i,this.random.pick(e.get(m)))){h=31-Math.clz32(m&~(1<<f));break}if(h==null)return{ok:!1,fail:"spikes"};a=h}let l=[];for(let d=3;d<this.h-3;d++)for(let f=1;f<this.w-1;f++)l.push(d<<12|f<<4|2056);let c=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let f of Cr){if(this.grid.get(d+f)!=="c")continue;this.grid.set(d,"r");let u=2056&~Math.abs(f);this.grid.set(d+u,"r"),this.grid.set(d-u,"r");let h=this.random.pick([-u,u]);this.grid.set(d+2*h,"r"),this.grid.set(d+3*h,"r"),this.grid.set(d+2*h-f,"c"),c=!0;break}if(c)break}if(!c)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return N}checkMeta(e,n){let r=n?{flight:!0,with:n}:{flight:!0},i=e.traverse(r);return new Set(i.values()).size===this.maxPartitions}refine(){return N}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let n=super.refineMetascreens(e);if(!n.ok)return n;function r(a){return[...new Set(a.values())].filter(c=>{for(let d of c)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let i=r(e.traverse()),o=r(e.traverse({flight:!0}));return i===o?{ok:!1,fail:"flight not required"}:N}},Cr=[-2048,-8,2048,8],Aa=[-16,-1,16,1],An=class extends Xe{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],n=0;for(let l of this.random.ishuffle(ae(this.w-2,c=>c+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let c=this.h-1<<12|l<<4|2056;if(this.grid.set(c,"c"),this.grid.set(ge(c),"c"),this.grid.set(ie(c),"n"),this.fixed.add(c),this.fixed.add(ge(c)),this.fixed.add(ie(c)),e.push(l),n++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let r=this.w,i=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*i+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;r<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};r+=l,n+=l}let a=this.params.size;for(;n<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};n+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let n=super.refineMetascreens(e);if(!n.ok)return n;function r(l){let c=0;for(let d of new Set(l.values()))for(let f of d)if(e.exitType(f)==="edge:bottom"){c+=d.size;break}return c}let i=r(e.traverse({noFlagged:!0})),o=r(e.traverse());if(i===o)return{ok:!1,fail:"bridge didn't matter"};let a=r(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:N}},vn=class extends Xe{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let i=0;i<this.grid.data.length;i++)if(this.grid.data[i]==="r"){e=this.grid.coord(i)-2056;break}if(e==null)throw new Error("no corner");let n=[];for(let i=0;i<this.pattern.length;i++)for(let o=1;o<this.pattern[i].length-1;o++)(o^i)&1&&this.pattern[i][o]===" "&&n.push(e+(i<<11|o<<3));let r=this.random.shuffle([..."ccrrrrrrrr"]);for(let i of this.random.ishuffle(n)){let o=r[r.length-1];if(!(o==="c"&&[...this.extract(this.grid,i-2056)].filter(a=>a==="r").length<4)&&(this.canSet(i,o)&&this.grid.set(i,r.pop()),!r.length))break}for(let i=0;i<6;i++)this.tryAdd({char:"c"});return N}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let i=this.addStairs(...e);if(!i.ok)return i}let n=0;for(let i of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,i).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(i+8)&&(this.grid.set(i+2056,"<"),e[0]--),this.fixed.add(i+2056),++n>=2))break;let r=this.grid.partition();return new Set(r.values()).size>1?{ok:!1,fail:"orphans"}:N}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:N}checkMeta(e,n){let r=e.traverse(n?{with:n}:{}),i=[];for(let o of new Set(r.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;i.push(a)}return i.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let n=super.refineMetascreens(e);if(!n.ok)return n;function r(a){let l=0;for(let c of new Set(a.values()))for(let d of c)if(e.exitType(d)){l+=c.size;break}return l}let i=r(e.traverse()),o=r(e.traverse({flight:!0}));return i===o?{ok:!1,fail:"flight not required"}:N}}});function js(s){let{swamp:t}=s.metatilesets,e=s.metascreens,n=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[r,i,o]of n)t.getTile(r).copyFrom(i).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var Nn,Ys=v(()=>{In();nn();Ye();je();ce();rn();Nn=class extends k{build(){let{h:t,w:e}=this,n=this.orig.rom,r=new Je(t,e);r.fill();let i=t*e<28?0:this.random.nextInt(t-1),o=this.random.nextInt(e),a=new Set;function l(S,O){r.delete2(S,O),a.add(S*r.w+O)}function c(S){return!S.startsWith("edge")}a.add(i*r.w+o),o&&l(i,o-1),o<r.w-1&&l(i,o+1),i&&(l(i-1,o),o&&l(i-1,o-1),o<r.w-1&&l(i-1,o+1));for(let S of a)r.fixed.add(S);let d=new Set;for(let S=0;S<4;S++){let O=S&1?t:e,L=this.random.shuffle(ae(O)),A=S&2?O:0,_=this.params.edges?.[S]??0;for(;_&&L.length;){let X=S&1?L.pop():A,se=S&1?A:L.pop(),U=X*r.w+se;!r.data[U]||r.fixed.has(U)||(r.addEdge(X,se,S),d.add(X<<4|se),_--)}if(_)return{ok:!1,fail:`could not add all edges: ${S} ${_}
${r.toGrid("c").show()}
${r.data}`}}let f=0,u=r.h*r.w*(this.random.next()*.15+.4);for(let S of this.random.ishuffle(ae(r.data.length<<2))){let O=S>>>2,L=S&3;if(!r.isBorder(O,L)&&r.deleteEdge(O,L)&&++f>=u)break}let h=new Set,m=new Set,g=[],x=[],y;for(let S of this.orig.tileset){if(S.hasFeature("arena")){y=S;continue}else if(S.hasFeature("empty")){g[0]=S;continue}let O=S.edgeIndex("s");if(O==null)throw new Error("bad edges");let L=S.data.exits?.some(A=>c(A.type));(L?x:g)[O]=S,(S.sid<0?m:h).add(S.sid)}if(!y)throw new Error("never found arena");let p=r.consolidate(this.random,h.size),w=new Set(p.map(S=>g[S].sid));if(!w.size)return{ok:!1,fail:"consolidate failed"};let b=[...m].filter(S=>w.has(S)),T=[...h].filter(S=>!w.has(S));if(b.length>T.length)throw new Error("out of space");if(b.length){let S=-1;for(;n.metascreens.getById(S).length;)S--;let O=S;for(let L=0;L<b.length;L++)n.metascreens.renumber(T[L],S),n.metascreens.renumber(b[L],T[L]),S=b[L];n.metascreens.renumber(O,b[b.length-1])}let C=new Ae(this.orig.id,this.orig.tileset,t,e);for(let S=0;S<r.h;S++)for(let O=0;O<r.w;O++){let L=S===i&&O===o;C.set(S<<4|O,L?y:g[r.data[S*r.w+O]])}let I=[...this.orig.exits()].filter(S=>c(S[1])).length;for(let S of this.random.ishuffle(C.allPos())){if(!I)break;if(d.has(S))continue;let O=S&15,L=S>>>4,A=x[r.data[L*r.w+O]];A&&(C.set(S,A),I--)}return I?{ok:!1,fail:"could not place all doors"}:N}}});function Js(s,t){let{metatilesets:{cave:e,fortress:n,iceCave:r,labyrinth:i,pyramid:o}}=s;s.metascreens.registerFix(14,1);{for(let l of[i,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[n,i,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[r,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);i.getTile(23).copyFrom(198).setAlternative(197),i.getTile(24).copyFrom(196).setAlternative(197)}let a=new H(()=>[]);for(let l of s.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,c]of a){let d=s.screens[l],f=c.map(m=>m.data.tilesets.labyrinth?.removeWall),[u,...h]=new Set(f.filter(m=>m!=null));if(u!=null){if(d.set2d(u,[[197,197],[208,197]]),h.length)throw new Error("bad remove");for(let m=0;m<f.length;m++)f[m]==null&&(c[m].data.tilesets.labyrinth.addWall=[u])}if(!(c.length<2)){if(c.length>2){let m=t.pick(c.filter(g=>g.data.tilesets.labyrinth?.addWall));c.splice(c.indexOf(m),1),m.remove()}for(let m of c){let g=m.data.tilesets.labyrinth?.addWall;if(g!=null){m.data.mod="block";for(let x of g)d.set2d(x,[[23,23],[24,24]])}else m.flag="always"}}}}var Ln,Xs=v(()=>{Ye();je();st();rn();de();Ln=class extends k{initialFill(){let t=this.size+3,e=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(rt(e))||this.fixed.add(rt(e,2)),this.grid.isBorder(Fe(e))||this.fixed.add(Fe(e,2)),this.grid.set(e,">"),this.fixed.add(e),this.grid.set(ge(e),"w"),this.fixed.add(ge(e)),this.fixed.add(rt(e)),this.fixed.add(Fe(e));let n=this.random.nextInt(this.w)<<4|2056,r=ie(n,2);if(this.grid.set(n,"<"),this.fixed.add(n),this.grid.set(ie(n),"w"),this.fixed.add(ie(n)),this.grid.set(r,"w"),this.fixed.add(r),this.grid.set(ie(r),"w"),this.fixed.add(ie(r)),this.fixed.add(rt(r)),this.fixed.add(Fe(r)),!this.tryConnect(ge(e,2),ie(r,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<t;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return N}refine(){return N}refineEdges(){return!0}addArenas(){return!0}addStairs(){return N}refineMetascreens(t){console.log(t.show());for(let n=0;n<t.height;n++)for(let r=0;r<t.width;r++){let i=n<<4|r,o=t.get(i),a=o.edgeIndex("w");if(o.hasFeature("arena"))this.arena=i+16<<8|1;else if(a===5){if(i<16||!t.get(i-16).hasFeature("arena")){t.set(i,t.rom.metascreens.goaWideHallNS_stairs);let l=(i<<8|i<<4)&61680|2056;this.grid.set(l,"H")}}else a===1&&(this.stair=i<<8|2)}if(this.reachable=void 0,!this.checkMeta(t))return{ok:!1,fail:"initial meta check"};console.log(t.show());let e=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let n=0;n<t.width;n++)for(let r=0;r<t.height;r++){let i=r<<12|n<<4|2056,o=0;for(;r+o<t.height&&this.grid.get(i+o*4096)==="H";)o++;if(!o)continue;let a=[new Map,new Map];for(let c=0;c<o;c++)a[c&1].set(r+c<<4|n,e);let l=!1;for(let c of this.random.ishuffle(a)){if(!c.size){l=!0;continue}if(this.checkMeta(t,c)){for(let[d,f]of c)t.set(d,f),this.grid.set(i+4096*((d>>4)-r),"=");l=!0;break}}if(!l)return{ok:!1,fail:"could not rectify hallway"};r+=o}return super.refineMetascreens(t)}checkMeta(t,e){let n=e?{with:e}:{},r=t.traverse(n),i=r.get(this.stair);return i!==r.get(this.arena)?(console.log(`stair not connected to arena
${t.show()}`),!1):this.reachable==null?i&&i.size<r.size*.95?(console.log("too small"),!1):(this.reachable=i?.size,!0):i?.size>this.reachable*.95}}});function Na(s,t){let e=t.nextInt(2)+6,n=t.nextInt(3)+2;if(e===7&&n===3)return;let{branchNWSE:r,branchNWE:i,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:c}=s.rom.metascreens,d=e<<4|n,f=o;e===7&&n===1&&(f=c),e===7&&n===5&&(f=l),s.set2d(99,[[r],[r],[r]]),s.set2d(d-16,[[i],[a],[f]]),s.moveExit(115,d)}function La(s){let t=s.locations.Pyramid_Draygon.meta,e=s.locations.Pyramid_Main.meta,{metascreens:{hallSE:n,deadEndW_downStair:r,wideHallNE:i,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=s;t.width=2,t.set2d(0,[[null,l],[null,a],[i,o]]),t.moveExit(32,1),e.set2d(3,[[n,r]]),e.moveExit(3,4),e.attach(4,t,1)}var Gn,Qs=v(()=>{Gn=class{constructor(t){this.location=t}shuffle(t){if(this.meta)throw new Error("impossible");let e=this.location.meta;Na(e,t),t.nextInt(2)&&La(this.location.rom);let n=[...e.exits()].filter(a=>a[1]==="stair:up"),r=[...e.exits()].filter(a=>a[1]==="stair:down");t.shuffle(n),t.shuffle(r);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?n:r).pop();e.setExit(l[0],l[1],a[2])}if(n.length!==r.length)throw new Error("length mismatch");let i=t.shuffle([...r]);for(let a=0;a<r.length;a++)r[a]===i[a]&&(t.shuffle(i),a=-1);let o=this.location.id<<8;for(let a=0;a<n.length;a++)e.setExitOneWay(n[a][0],n[a][1],[o|r[a][0],r[a][1]]),e.setExitOneWay(i[a][0],i[a][1],[o|n[a][0],n[a][1]]);this.meta=e}finish(){}}});function Zs(s,t,e){let n=new Rr(s),r=new Mr(t,n),i=new Ir(e,r);return[n,r,i]}var Rr,Mr,Ir,Fn,ei=v(()=>{st();je();Ye();Rr=class extends k{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let n=this.insertPattern(e,{top:1,bottom:1});if(!n.ok)return n;this.addAllFixed();for(let r=0;r<this.grid.data.length;r++){if(this.grid.data[r]!==">")continue;let i=this.grid.coord(r);this.stair=i>>>8&240|i>>>4&15}return N}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?N:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let n of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,n)===" c  c  c "){this.grid.set(n+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return N}addLateFeatures(){return N}addStairs(){return N}},Mr=class extends k{constructor(e,n){super(e);this.location=e;this.upper=n;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],n=!0,r=this.upper.meta,i=this.upper.stair;if(r.get(i).isEmpty()||(i+=16,n=!1),i==null)throw new Error("no stair found");for(let b of r.allPos())r.get(b).hasFeature("overpass")&&e.push(b);this.random.shuffle(e);let o=i>>>4,a=i&15,l=a,c=o;for(let b of e){let T=b>>>4,C=b&15;o=Math.min(o,T),a=Math.min(a,C),l=Math.max(l,C),c=Math.max(c,T)}let d=c-o+1,f=l-a+1,u=o<<4|a,h=1+this.random.nextInt(this.w-f-2),g=(this.random.nextInt(this.h-d-(n?1:0))<<4|h)-u,x=(i&15)-a<f/2;i+=g;for(let b=0;b<e.length;b++)e[b]+=g;let y=n?"    <  c ":x?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(i,y)){let b=[-1,1,16,-16,15,17,-15,-17],T=!1;for(let C of this.random.ishuffle(b))if(this.insertTile(i+C,y)){i+=C,T=!0;break}if(!T)throw new Error("Could not insert stair")}this.stair=i,this.addAllFixed(),this.count=3;let p=x?1:-1,w=n?16:p;return!e.includes(i+p)&&!this.tryConnect(this.posToGrid(i+w,2056),this.posToGrid(e[0]-p,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+p,2056),this.posToGrid(e[1]+p,2056),"c",10)?N:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?N:{ok:!1,fail:"could not populate"}}refine(){return N}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let n=e+2056;if(!(this.fixed.has(n)||this.grid.get(n))&&!(this.grid.get(rt(n,2))||this.grid.get(Fe(n,2)))&&this.grid.get(ie(n,2))==="c"&&this.canSetAll(new Map([[ie(n),"c"],[n,"a"],[ge(n),"c"],[ge(n,2),"c"]])))return this.grid.set(ie(n),"c"),this.grid.set(n,"a"),this.grid.set(ge(n),"c"),this.fixed.add(n),this.fixed.add(ge(n,2)),!0}return!1}addStairs(e=0,n=0){return super.addStairs(e-1,n)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,n=this.upper.stair,r=this.stair;n!=null&&r!=null&&this.meta.attach(r,e,n,"stair:up","stair:down")}},Ir=class extends k{constructor(e,n){super(e);this.main=n}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let n of e.allPos())if(e.get(n).hasFeature("arena"))return n;throw new Error("never found arena")}initialFill(){let e=this.main.meta,n=this.findArena(e),r=this.posToGrid(n,2056);return this.grid.set(r,"a"),this.grid.set(ge(r),"c"),this.grid.set(ie(r),"c"),this.fixed.add(r),this.fixed.add(ie(r)),this.fixed.add(ie(r,2)),N}addEdges(){let e=10,n=2+this.random.nextInt(2);for(;this.count<n&&e;)this.tryAdd()||e--;return e?N:{ok:!1,fail:"addEdges"}}refine(){return N}addLateFeatures(){return N}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let n=e.value,r=this.findArena(n),i=this.main.meta;return n.set(r+15,this.orig.tileset.unreachableVariant(i.get(r+15))),n.set(r+16,this.orig.tileset.unreachableVariant(i.get(r+16))),n.set(r+17,this.orig.tileset.unreachableVariant(i.get(r+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,n=this.findArena(this.meta);super.finishInternal(),e.setExit(n,"seamless:up",[this.meta.id<<8|n,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},Fn=class s extends k{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return He.writeGrid2d(this.grid,0,s.PATTERN),this.count=36,N}addSpikes(){let e=this.random.nextInt(4);for(let i=1;i<10;i++)for(let o=0;o<4;o++){let a=2*o+5+i*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),i===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let n=0;for(let i of this.random.ishuffle(this.grid.screens())){if(n===3)break;let o=i|2056,a=ge(o),l=ge(o,2),c=ie(o),d=ie(o,2),f=rt(o),u=Fe(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(c)==="s"||this.grid.get(d)==="s")continue;let h=[],m=[];for(let g of[c,f,u])this.grid.get(g)==="c"&&(this.grid.get(2*g-o)==="s"?m.push(g):h.push(g));if(!(m.length>1)&&!(!h.length&&!m.length)){for(;h.length+m.length>1&&!(h.length+m.length===2&&!h.includes(c)&&!m.includes(c));){let[g]=h.splice(this.random.nextInt(h.length),1);this.grid.set(g,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),n++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return N}static{this.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "]}}});function ti(s,t,e){let n=s.locations;Ga(s,e);let r=new wn(s,e);r.add(),r.shuffles.length||r.add(new k(n.EastCave1),new k(n.EastCave2),new k(n.EastCave3),...Cn(n.SealedCave1,n.SealedCave2),new k(n.SealedCave3),new k(n.SealedCave4),new k(n.SealedCave5),new k(n.SealedCave6),new k(n.SealedCave7),new k(n.SealedCave8),new k(n.WindmillCave),new k(n.ZebuCave),new Nn(n.Swamp),new k(n.MtSabreWest_Cave1),new k(n.MtSabreWest_Cave2),new k(n.MtSabreWest_Cave3),new k(n.MtSabreWest_Cave4),new k(n.MtSabreWest_Cave5),new k(n.MtSabreWest_Cave6),new ut(n.MtSabreWest_Cave7),new k(n.MtSabreNorth_Cave1),new k(n.MtSabreNorth_Cave2),new k(n.MtSabreNorth_Cave3),new k(n.MtSabreNorth_Cave4),new k(n.MtSabreNorth_Cave5),new k(n.MtSabreNorth_Cave6),new k(n.MtSabreNorth_Cave7),new k(n.MtSabreNorth_Cave8),new k(n.MtSabreNorth_Cave9),new k(n.MtSabreNorth_LeftCell2),new k(n.MtSabreNorth_SummitCave),new k(n.KirisaPlantCave1),new k(n.KirisaPlantCave2),new k(n.KirisaPlantCave3),new k(n.FogLampCave1),new k(n.FogLampCave2),new k(n.FogLampCave3),new Rn(n.FogLampCaveDeadEnd),...Cn(n.FogLampCave5,n.FogLampCave4,!0),...Cn(n.FogLampCave7,n.FogLampCave6),new ut(n.WaterfallCave1),new k(n.WaterfallCave2),new ft(n.WaterfallCave3),new On(n.WaterfallCave4),new Xe(n.EvilSpiritIsland2).requirePitDestination(),new ut(n.EvilSpiritIsland3),new Xe(n.EvilSpiritIsland4),new kn(n.SaberaPalace1).requirePitDestination(),new k(n.SaberaPalace2),new k(n.SaberaPalace2_West),new k(n.JoelSecretPassage),new k(n.MtHydra_Cave1),new k(n.MtHydra_Cave2),new k(n.MtHydra_Cave3),new k(n.MtHydra_Cave4),new k(n.MtHydra_Cave5),new k(n.MtHydra_Cave6),new ft(n.MtHydra_Cave7),new k(n.MtHydra_Cave8),new k(n.MtHydra_Cave9),new k(n.MtHydra_Cave10),new ft(n.Styx1).setUpEdgeType("c"),new An(n.Styx2).requirePitDestination(),new k(n.Styx3),new vn(n.OasisCaveMain),new k(n.DesertCave1),new k(n.DesertCave2),new k(n.Pyramid_Branch),new Gn(n.Pyramid_Main),new Tn(n.Crypt_Entrance),new ft(n.Crypt_Hall1).setUpEdgeType("c"),new k(n.Crypt_DeadEndLeft),new k(n.Crypt_DeadEndRight),new k(n.Crypt_Branch),new k(n.Crypt_Hall2),new Ln(n.GoaFortress_Kelbesque),new Xe(n.GoaFortress_Sabera),new k(n.GoaFortress_Mado1).requirePitDestination(),new k(n.GoaFortress_Mado2),new k(n.GoaFortress_Mado3),new k(n.GoaFortress_Karmine1),new k(n.GoaFortress_Karmine2),new k(n.GoaFortress_Karmine4),new Fn(n.GoaFortress_Karmine6),...Zs(n.GoaFortress_Karmine3,n.GoaFortress_Karmine5,n.GoaFortress_Kensu),new _n(n.OasisCave_Entrance)),r.shuffleAll(),console.log(String(r))}function Ga(s,t=new We(1)){ws(s),js(s),Js(s,t)}var ni=v(()=>{Ye();Sn();Vs();Ks();$s();Ys();Tr();Xs();Qs();rn();ei();je()});var It,kr,ri,nu,si,ru,su,ii=v(()=>{It=typeof __VERSION__=="object"?__VERSION__:{},kr=It.STATUS||"unstable",ri=It.VERSION||"HEAD",nu=It.LABEL||"HEAD",si=It.HASH||"HEAD",ru=It.DATE||new Date,su=It.PREV||""});async function au(s){let t=document.createElement("canvas");t.width=112,t.height=100;let e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,t.width,t.height);let n=new ImageData(new Uint8ClampedArray(s.rendered),128,128),r=await createImageBitmap(n,{resizeQuality:"pixelated"});return e.drawImage(r,0,0,16,24,24,2,16*4,24*4),t.toDataURL("image/png")}async function Da(s,t){let e=s.byteLength/16,n=8,r=0,i=document.createElement("canvas");i.width=128,i.height=128;let a=i.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(s);for(let c=0;c<e;++c){let d=c*16,f=c%16*8,u=Math.floor(c/16)*8;for(let h=0;h<n;++h){let m=l[d+h],g=l[d+h+8];for(let x=0;x<n;++x){let y=7-x,p=m>>y&1,w=(g>>y&1)<<1,b=(p|w)+r*4,T=za[t[b]],C=(f+x)*4+(u+h)*4*128;a.data[0+C]=T[0],a.data[1+C]=T[1],a.data[2+C]=T[2],a.data[3+C]=b==0?0:255}}}return a}async function ai(s){let t=us()[s],e=s.replace(/^.*[\\\/]/,"");return Ha(e,t)}function _r(s){let t="",e="",n=0;for(;n<s.length;)if(s[n]==="["){++n;let r=s.indexOf("]",n),i=parseInt(s.slice(n,r),16)-1;t+=e.repeat(i),n=r+1}else e=s.slice(n,n+2),t+=e,n+=2;return t}function li(s,t){return s.match(new RegExp(".{1,"+t+"}","g"))||[]}function di(s){let t=li(s,2).map(e=>parseInt(e,16));return new Uint8Array(t)}function Pa(s){return s.map(t=>parseInt(t,16))}function Ba(s,t,e){return 262144+s*8192+t*1024+e*16}function Ee(s){return[new E(8,2,s,s+64),new E(8,3,s,s+64),new E(8,4,s,s+64),new E(8,5,s,s+64),new E(8,6,s,s+64)]}function fi(s,t){return s.length===t.length&&s.every((e,n)=>e===t[n])}function Wa(s){let t=new Map,e=Array.from(new Uint8Array(di(_r(s.get("MetaSprites")||"")))),n=parseInt(s.get("VarSpriteGridX")||"64"),r=parseInt(s.get("VarSpriteGridY")||"64"),i;for(let o=0;i=s.get(`MetaSprite${o}`)?.trim();o++){let a=ci.get(i);if(!a){console.warn(`Missing mapping for ${i}`);continue}let l=[],c=o*64*4;for(;!fi(e.slice(c,c+4),[255,255,255,255]);){let h=e.slice(c,c+4);h[3]-=n,h[0]-=r;let m=[h[3],h[0],h[2],h[1]];l.push(m),c+=4}let[d,f]=a,u=t.get(d)||new Map;u.set(f,l),t.set(d,u)}return t}async function Ha(s,t){let e=new Map(t.replace(/\r\n/g,`
`).split(`
`).filter(l=>l.includes("=")).map(l=>l.split("=")).map(l=>[l[0],l[1]])),n=e.get("Palette")||"",r=Pa(li(_r(n).slice(0,32),2)),i=Array.from(new Uint8Array(di(_r(e.get("CHRMain")||"")))),o=Wa(e),a=await Da(new Uint8ClampedArray(i),r);return new Or(s,i,r,o,Array.from(new Uint8Array(a.data)))}var E,Or,ht,oi,jt,ci,za,ui=v(()=>{ms();ce();E=class{constructor(t,e,n,r){this.page=t;this.bank=e;this.tile=n;this.pputile=r}},Or=class{constructor(t="",e=[],n=[],r=new Map,i=[]){this.filename=t,this.chrdata=e,this.palette=n,this.metasprites=r,this.rendered=i}};ht=class s{constructor(t,e,n,r){this.name=t,this.converter=e,this.nssdata=n,this.description=r}static async init(t,e,n,r){let i=await n;return new s(t,e,i,r)}static{this.isCustom=t=>t.name!="Simea"}static applyPatch(t,e,n){let r=n?262144:0,i=!1,o=jt.getChr(t.converter);for(let[l,c]of o)for(let d of c)for(let f=0;f<16;++f)e[Ba(d.page,d.bank,d.tile)+f+r]=t.nssdata.chrdata[l*16+f];for(let[l,c]of jt.getPalette(t.converter))for(let d of c)switch(l){case"color0":e[d]=t.nssdata.palette[0];break;case"color1":e[d]=t.nssdata.palette[1];break;case"color2":e[d]=t.nssdata.palette[2];break;case"color3":e[d]=t.nssdata.palette[3];break;case"sprite_palette":e[d+r]=0;break}let a=230492;for(let[l,[c,d]]of jt.getMetasprite(t.converter)){let f=en(e,a+(c<<1))+196608,u=e[f],m=e[f+1]+1;if(d>m){console.warn(`Custom metasprite ${l} with the id ${c}
          and frame number ${d} greater than the vanilla frame count: ${m}`),i=!0;continue}let g=e.subarray(f+2+d*u*4),x=t.nssdata.metasprites.get(c).get(d),y=0;for(;y/4<u&&!fi(Array.from(g.subarray(y,y+4)),[128,128,128,128]);)y+=4;if(x.length!=y/4){console.warn(`Custom metasprite ${l} with the id ${c}
          and frame number ${d} does not equal the vanilla sprite size: ${x.length} != ${y/4}`),i=!0;continue}for(let p=0;p<x.length;++p)g[p*4+0]=x[p][0],g[p*4+1]=x[p][1],g[p*4+2]=x[p][2]|g[p*4+2]&4,g[p*4+3]=o.get(x[p][3])[0].pputile}return i}},oi=class s{constructor(){this.mapping=new Map;this.mapping.set("simea",new Map([["Simea",ht.init("Simea","simea",ai("Simea.nss"),"The original main character of Crystalis")],["Mesia",ht.init("Mesia","simea",ai("Mesia.nss"),"Secondary protagonist Mesia takes the spotlight!")]]))}static get(t){return this.instance||(this.instance=new s),this.instance.mapping.get(t)}},jt=class s{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.metaspriteMapping=new Map;this.chrMapping.set("simea",this.generateSimeaMapping()),this.paletteMapping.set("simea",this.generateSimeaPalette()),this.metaspriteMapping.set("simea",ci)}static getChr(t){return this.instance||(this.instance=new s),this.instance.chrMapping.get(t)}static getPalette(t){return this.instance||(this.instance=new s),this.instance.paletteMapping.get(t)}static getMetasprite(t){return this.instance||(this.instance=new s),this.instance.metaspriteMapping.get(t)}generateSimeaPalette(){let t=new Map,e=[27888,254120];return t.set("color0",e.map(n=>n+0)),t.set("color1",e.map(n=>n+1)),t.set("color2",e.map(n=>n+2)),t.set("color3",e.map(n=>n+3)),t.set("sprite_palette",[245844]),t}generateSimeaMapping(){let t=new Map;t.set(0,[new E(8,0,26,26)]),t.set(1,[new E(8,0,27,27)]),t.set(16,[new E(8,0,0,0)]),t.set(17,[new E(8,0,1,1)]),t.set(32,[new E(8,0,32,32)]),t.set(33,[new E(8,0,33,33)]),t.set(2,[new E(8,0,28,28)]),t.set(3,[new E(8,0,29,29)]),t.set(18,[new E(8,0,2,2)]),t.set(19,[new E(8,0,3,3)]),t.set(20,[new E(8,0,4,4)]),t.set(21,[new E(8,0,5,5)]),t.set(34,[new E(8,0,34,34)]),t.set(35,[new E(8,0,35,35)]),t.set(36,[new E(8,0,36,36)]),t.set(37,[new E(8,0,37,37)]),t.set(6,[new E(8,0,30,30)]),t.set(7,[new E(8,0,31,31)]),t.set(22,[new E(8,0,6,6)]),t.set(23,[new E(8,0,7,7)]),t.set(38,[new E(8,0,38,38)]),t.set(39,[new E(8,0,39,39)]),t.set(64,[new E(8,0,20,20)]),t.set(65,[new E(8,0,21,21)]),t.set(80,[new E(8,0,52,52)]),t.set(81,[new E(8,0,53,53)]),t.set(50,[new E(8,0,60,60)]),t.set(51,[new E(8,0,61,61)]),t.set(66,[new E(8,0,24,24)]),t.set(67,[new E(8,0,25,25)]),t.set(82,[new E(8,0,56,56)]),t.set(68,[new E(8,0,22,22)]),t.set(69,[new E(8,0,23,23)]),t.set(84,[new E(8,0,54,54)]),t.set(112,[new E(8,0,14,14)]),t.set(113,[new E(8,0,15,15)]),t.set(128,[new E(8,0,46,46)]),t.set(129,[new E(8,0,47,47)]),t.set(114,[new E(8,0,18,18)]),t.set(115,[new E(8,0,19,19)]),t.set(130,[new E(8,0,48,48)]),t.set(131,[new E(8,0,51,51)]),t.set(116,[new E(8,0,16,16)]),t.set(117,[new E(8,0,17,17)]),t.set(133,[new E(8,0,49,49)]),t.set(160,[new E(8,0,8,8)]),t.set(161,[new E(8,0,9,9)]),t.set(176,[new E(8,0,40,40)]),t.set(146,[new E(8,0,58,58)]),t.set(147,[new E(8,0,59,59)]),t.set(162,[new E(8,0,12,12)]),t.set(163,[new E(8,0,13,13)]),t.set(178,[new E(8,0,44,44)]),t.set(179,[new E(8,0,45,45)]),t.set(164,[new E(8,0,10,10)]),t.set(165,[new E(8,0,11,11)]),t.set(181,[new E(8,0,43,43)]);let e=new Map(t),n=256;for(let[r,i]of e){let o=r+n,a=i.map(l=>new E(l.page,l.bank+1,l.tile,l.pputile));t.set(o,a)}return t.set(192,[new E(11,4,0,0)]),t.set(193,[new E(11,4,1,1)]),t.set(208,[new E(11,4,2,2)]),t.set(209,[new E(11,4,3,3)]),t.set(224,[new E(11,4,4,4)]),t.set(225,[new E(11,4,5,5)]),t.set(194,[new E(11,4,36,36)]),t.set(195,[new E(11,4,37,37)]),t.set(210,[new E(11,4,6,6)]),t.set(211,[new E(11,4,7,7)]),t.set(226,[new E(11,4,38,38)]),t.set(227,[new E(11,4,39,39)]),t.set(196,[new E(11,4,32,32)]),t.set(197,[new E(11,4,33,33)]),t.set(212,[new E(11,4,34,34)]),t.set(213,[new E(11,4,35,35)]),t.set(214,[new E(11,4,20,20)]),t.set(215,[new E(11,4,21,21)]),t.set(230,[new E(11,4,22,22)]),t.set(231,[new E(11,4,23,23)]),t.set(54,[new E(11,4,12,12)]),t.set(55,[new E(11,4,13,13)]),t.set(70,[new E(11,4,50,50)]),t.set(71,[new E(11,4,51,51)]),t.set(86,[new E(11,4,46,46)]),t.set(87,[new E(11,4,47,47)]),t.set(180,[new E(11,4,54,54)]),t.set(181,[new E(11,4,55,55)]),t.set(228,[new E(11,4,56,56)]),t.set(229,[new E(11,4,57,57)]),t.set(198,[new E(11,4,58,58)]),t.set(199,[new E(11,4,59,59)]),t.set(102,[new E(11,4,18,18)]),t.set(103,[new E(11,4,19,19)]),t.set(118,[new E(11,4,8,8)]),t.set(119,[new E(11,4,9,9)]),t.set(134,[new E(11,4,40,40)]),t.set(135,[new E(11,4,41,41)]),t.set(150,[new E(11,4,44,44)]),t.set(151,[new E(11,4,45,45)]),t.set(166,[new E(11,4,10,10)]),t.set(167,[new E(11,4,11,11)]),t.set(182,[new E(11,4,42,42)]),t.set(183,[new E(11,4,43,43)]),t.set(240,Ee(16)),t.set(241,Ee(17)),t.set(242,Ee(18)),t.set(243,Ee(19)),t.set(244,Ee(20)),t.set(245,Ee(21)),t.set(246,Ee(22)),t.set(247,Ee(23)),t.set(248,[new E(8,4,237,237)]),t.set(249,Ee(25)),t.set(250,Ee(26)),t.set(252,Ee(48)),t.set(253,Ee(49)),t.set(254,Ee(50)),t.set(255,Ee(51)),t}};ci=new Map([["Up 1",[0,1]],["Up 2",[0,0]],["Right 1",[1,1]],["Right 2",[1,0]],["Down 1",[2,1]],["Down 2",[2,0]],["Stab Up 1",[4,2]],["Stab Up 2",[4,1]],["Stab Up 3",[4,0]],["Stab Right 1",[5,2]],["Stab Right 2",[5,1]],["Stab Right 3",[5,0]],["Stab Down 1",[6,2]],["Stab Down 2",[6,1]],["Stab Down 3",[6,0]],["Arm Right 1",[9,1]],["Arm Right 2",[9,0]],["Shield Up 1",[12,1]],["Shield Up 2",[12,0]],["Shield Right 1",[13,1]],["Shield Right 2",[13,0]],["Shield Down 1",[14,1]],["Shield Down 2",[14,0]],["Shield Stab Up 1",[16,2]],["Shield Stab Up 2",[16,1]],["Shield Stab Up 3",[16,0]],["Shield Stab Right 1",[17,2]],["Shield Stab Right 2",[17,1]],["Shield Stab Right 3",[17,0]],["Shield Stab Down 1",[18,2]],["Shield Stab Down 2",[18,1]],["Shield Stab Down 3",[18,0]],["Sword Get 1",[184,1]],["Sword Get 2",[184,0]],["Death 1",[188,3]],["Death 2",[188,2]],["Death 3",[188,1]],["Death 4",[188,0]],["Death Last",[189,0]],["Telepathy Intro 1",[204,1]],["Telepathy Intro 2",[204,0]],["Telepathy 1",[205,1]],["Telepathy 2",[205,0]]]);za=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]]});function Nr(s,t,e){return new Ar(t,e).smudge(s)}function*qa(s){let t=0;for(;t<s.length;){let e=s.indexOf(`
`,t)+1||s.length;yield s.substring(t,e),t=e}}function Va(s,t,e,n){let r=n,[i,o]=s.disasm(t[e])||["brk","imp"],a=s.argLen(o);return r||(a>0&&(r=t[e+1]),a>1&&(r=r|t[e+2]<<8)),i+(a?" "+s.format(o,r):"")}function Ka(s,t,e){let n=s[t];if(e===":w")return n|=s[t+1]<<8,`($${mi(n,4)})`;if(/:\d+/.test(e)){let r=parseInt(e.substring(1)),i='"';for(let o=0;o<r;o++){let a=String.fromCharCode(s[t+o]);'"\\'.includes(a)&&(a="\\"+a),i+=a}return i+='"',i}else return e===":d"?String(n):e===":b"?`%${n.toString(2).padStart(8,"0")}`:`$${mi(n,2)}`}function mi(s,t=2){return s.toString(16).padStart(t,"0")}var Ua,Ar,vr,hi,pi=v(()=>{os();Xo();(t=>{function s(e,n=Ht.P02){return r=>Promise.resolve(Nr(r,n,e))}t.forKnownPrg=s})(Ua||={});Ar=class{constructor(t,e){this.cpu=t;this.prg=e}smudge(t){let e="";for(let n of qa(t))e+=this.smudgeLine(n);return e}smudgeLine(t){let e=/^([^;]*?)<@([0-9a-f]+)(?: (.*?))?@>(.*\n?)$/i.exec(t);if(e){let[,r,i,o,a]=e,l=parseInt(i,16),c=Va(this.cpu,this.prg,l,o);return r+c+a}let n="";for(;;){let r=/^([^;]*?)\[@([0-9a-f]+)(:[0-9]+|:[wdb])?@\](.*\n?)/i.exec(t);if(!r){n+=t;break}let[,i,o,a,l]=r;t=l,n+=i;let c=parseInt(o,16);n+=Ka(this.prg,c,a)}return n}};vr=class{constructor(t){this.plain=t}fix(t,e,n){}format(t,e){return this.plain}},hi=class s extends vr{constructor(e){super("");this.fix=e}static set(e){return new s(n=>n.set(e))}static{this.push=new s(e=>e.push())}static{this.alt=new s(e=>e.alt())}static{this.pop=new s(e=>e.pop())}static{this.merge=new s(e=>e.merge())}}});var te,gi=v(()=>{te={of:(...s)=>{let t=0n;for(let e of s)t|=1n<<BigInt(e);return t},from:s=>{let t=0n;for(let e of s)t|=1n<<BigInt(e);return t},containsAll:(s,t)=>!(t&~s),with:(s,t)=>s|1n<<BigInt(t),without:(s,t)=>s&~(1n<<BigInt(t)),has:(s,t)=>!!(s&1n<<BigInt(t)),bits:s=>{let t=[],e=0;for(;s;){let n=Number(s&0xffffffffn),r=32;for(;n;){let i=Math.clz32(n)+1;r-=i,n<<=i,i===32&&(n=0),t.push(e|r)}s>>=32n,e+=32}return t},clone:s=>s,empty:s=>!s,difference:(s,t)=>s&~t,union:(s,t)=>s|t}});var $a,ja,Dn,xi=v(()=>{gi();Sn();ce();de();tn();$a=2,ja=2,Dn=class{constructor(t){this.worlds=t;this.lastFailure="";let e=new Set,n=new Set,r=new Map,i=new Map;for(let f=0;f<t.length;f++){let u=t[f],h=f<<24;for(let[m,g]of u.requirements){e.add(h|m);for(let x of g)for(let y of x)n.add(h|y)}for(let[m,g]of u.items)i.set(h|m,g);for(let[m,g]of u.slots)r.set(h|m,g)}this.itemInfos=new Map(i),this.slotInfos=new Map(r),this.progression=new Set(n);for(let f of i.keys())n.add(f);let o=new Set,a=new Set,l=new Set;for(let f of n)(e.has(f)?o:l).add(f);for(let f of e)n.has(f)||a.add(f);this.common=o.size,this.slots=new nr([...o,...a]),this.items=new nr([...o,...l]);let c=[],d=[];for(let f=0;f<t.length;f++){let u=f<<24;for(let[h,m]of t[f].requirements){let g=this.slots.index(u|h);if(g==null)throw new Error(`Provided a non-slot? ${re(h)}`);for(let x of m){let y=[...x].map(p=>this.items.index(u|p)??Be());(c[g]||(c[g]=[])).push(te.from(y));for(let p of y)(d[p]||(d[p]=new Set)).add(g)}}}for(let f=0;f<this.slots.length;f++)if(!c[f]||!c[f].length){let u=this.slots.get(f)??NaN,h=this.checkName(u);console.error(`Nothing provided $${re(u)}: ${h} (index ${f})`)}this.graph=new Wt(c),this.unlocks=new Wt(d.map(Zt))}computeWeights(t=new We,e=1){let n=Array.from({length:this.items.length},()=>0),r=Array.from({length:this.slots.length},()=>0),i=[];for(let[o,a]of this.items)a>=512&&a<640&&this.progression.has(a)&&i.push(o);for(let o=0;o<e;o++){let a=t.shuffle([...i]),l=te.of(),c=this.traverse(()=>{},l),d=0;for(let f of a){d++,l=te.with(l,f);let u=this.traverse(()=>{},l),h=0;for(let m of u)c.has(m)||(r[m]+=d,h++);n[f]+=h,c=u}}return{items:new Wt(n.map(o=>o/e)),slots:new Wt(r.map(o=>o/e))}}reportWeights(){let t=this.computeWeights(new We,10),e=t.items.map((i,o)=>[o,i]),n=t.slots.map((i,o)=>[o,i]);function r(i){let o=globalThis.rom;return(i&-256)===512&&o&&o.items[i&255]?o.items[i&255].messageName:`$${i.toString(16).padStart(2,"0")}`}e.sort((i,o)=>o[1]-i[1]),n.sort((i,o)=>o[1]-i[1]);for(let[i,o]of e){let a=this.items.get(i);this.itemInfos.has(a)&&this.progression.has(a)&&console.log(`Item ${r(a)}: ${o}`)}for(let[i,o]of n){let a=this.slots.get(i);this.slotInfos.has(a)&&console.log(`Slot ${this.checkName(a)}: ${o}`)}}async shuffle(t,e,n=200,r,i){globalThis.graph=this,r&&r.addTasks(Math.floor(n/10));let o=this.computeWeights(e,1);e:for(let a=0;a<n;a++){this.lastFailure="",r&&a%10===9&&(r.addCompleted(1),await new Promise(requestAnimationFrame));let l=new rr;this.prefill(l,e);let c=this.compressFill(l),d=[...e.ishuffleMetropolis(this.itemPool(c.values(),o),ja)].reverse(),f=te.from(new Set(d)),u=Math.floor(a/5);if(!this.fillInternal(c,d,f,e,o,t,u))continue;let h=i?[]:void 0,m=this.traverse(p=>c.get(p),te.of(),h),g=this.analyzeSpheres(p=>c.get(p)),x=t.buryFlightStartSphere()-a/4;for(let[p,,w]of g)if(p===584&&w<x)continue e;if(m.size!==this.slots.length){let p=C=>`${String(C).padStart(3)} ${this.slots.get(C).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(C))}`,w=C=>`${String(C).padStart(3)} ${this.items.get(C).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(C))}`,b=new Set([...this.slots].map(C=>C[0]));for(let C of m)b.delete(C);let T=new Map;for(let C of b)T.set(p(C),this.graph.get(C).map(I=>`
    `+te.bits(I).map(w).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...T.keys()].sort().map(C=>C+T.get(C)).join(`
  `)}`),this.lastFailure="unreachable slots?";continue}this.expandFill(c,l);let y=this.fillNonProgression(l,t,e);if(y!=null){if(r&&r.addCompleted(Math.floor((n-a)/100)),i){for(let[p,w]of l){let b=this.checkName(p).replace(/^[0-9a-f]{3} /,"");i.addSlot(p,b,w)}if(h)for(let[p,...w]of h)(p<this.common||c.has(p))&&i.addCheck(this.slots.get(p),w.map(b=>this.items.get(b)))}return y}}throw new Error(`Shuffle failed: ${this.lastFailure||"unknown error"}`)}fillInternal(t,e,n,r,i,o,a){let l=new Set(t.keys());for(let c=e.pop();c!=null;c=e.pop()){if(!te.has(n,c))continue;let d=this.itemInfoFromIndex(c);n=te.without(n,c);let f=[...this.traverse(m=>t.get(m),n)].map(m=>[i.slots.get(m)||0,m]),u=!1,h=new Set(t.keys());for(let m of r.ishuffleMetropolis(f,($a+a)*(a+1))){if(h.has(m))continue;h.add(m);let g=this.slotInfoFromIndex(m);if(!(!g||o.preserveUniqueChecks()&&!g.unique||!this.fits(g,d,o))){t.set(m,c),u=!0;break}}if(!u){if(h.clear(),a-- >0){for(let m of r.ishuffleMetropolis(f,100)){if(h.has(m)||!t.has(m)||l.has(m))continue;h.add(m);let g=this.slotInfoFromIndex(m);if(!g||!this.fits(g,d,o))continue;let x=t.replace(m,c)??Be();n=te.with(n,x),e.push(x),r.shuffle(e),u=!0;break}if(u)continue}return this.lastFailure=`could not place ${this.checkName(this.items.get(c))}, ${e.filter(m=>te.has(n,m)).length} remaining`,!1}}return!0}itemPool(t,e){let n=new Set(t),r=[];for(let[i]of this.itemInfos){let o=this.items.index(i);o!=null&&this.progression.has(i)&&(n.has(o)||r.push([e.items.get(o)||0,o]))}return r}fits(t,e,n){if(n.preserveUniqueChecks()&&e.unique&&!t.unique||(e.unique||e.preventLoss)&&t.broken)return!1;let r=e.preventLoss||t.preventLoss;return!(t.lossy&&e.losable&&r)}fillNonProgression(t,e,n){let r=[[],[],[]],i=[[],[]];for(let[c,d]of this.itemInfos){if(t.hasValue(c))continue;let f=2;d.losable&&d.preventLoss&&(f=1),e.preserveUniqueChecks()&&d.unique&&(f=0),r[f].push(c)}for(let[c,d]of this.slotInfos){if(t.has(c))continue;let f=d.lossy&&d.preventLoss?0:1;i[f].push(c)}for(let c of[...r,...i])n.shuffle(c);let o=c=>this.checkName(c),a=le.count(le.concat(...i)),l=le.count(le.concat(...r));if(l>a)throw console.log(`Slots ${a}:
  ${[...le.concat(...i)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...le.concat(...r)].map(o).join(`
  `)}`),new Error("Too many items");for(let c of le.concat(...r)){let d=!1;for(let f of[...i]){if(d)break;for(let u=0;u<f.length;u++)if(this.fits(this.slotInfos.get(f[u]),this.itemInfos.get(c),e)){t.set(f[u],c),d=!0,f.splice(u,1);break}}if(!d)return console.log(`Slots:
  ${[...le.concat(...i)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(c)}`),this.lastFailure=`could not place non-progression ${o(c)}`,null}return new Map(t)}traverse(t,e,n){e=te.clone(e);let r=new Set,i=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}i.add(o)}for(let o of i){if(i.delete(o),r.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,c=a.length;l<c;l++){if(!te.containsAll(e,a[l]))continue;n&&n.push([o,...te.bits(a[l])]),r.add(o);let d=[];o<this.common&&d.push(o);let f=t(o);f!=null&&d.push(f);for(let u of d){e=te.with(e,u);for(let h of this.unlocks.get(u)||[]){if(this.graph.get(h)==null)throw console.dir(this),new Error(`Adding bad node ${h} from unlock ${u}`);i.add(h)}}break}}return r}analyzeSpheres2(t){let e=te.of(),n=0,r=te.of(),i=[],o=new Set(Array.from({length:this.slots.length},(a,l)=>l));do{let a=new Set(o);r=te.of();for(let l of a){let c=this.graph.get(l);for(let d=0,f=c.length;d<f;d++){if(!te.containsAll(e,c[d]))continue;o.delete(l);let u=[];l<this.common&&u.push(l);let h=t(l);h!=null&&u.push(h);for(let m of u){let g=this.items.get(m);if(g!=null&&g>=512&&g<640)i.push([this.itemNameFromIndex(m),n,this.checkName(this.slots.get(l))]),r=te.with(r,m);else{e=te.with(e,m);for(let x of this.unlocks.get(m)||[])o.has(x)&&a.add(x)}}break}}e=te.union(e,r),te.empty(r)||n++}while(o.size);return i}analyzeSpheres(t){let e=te.of(),n=0,r=[];for(;;){let i=this.traverse(()=>{},e),o=!1;for(let a of i){let l=t(a);if(l==null||te.has(e,l))continue;e=te.with(e,l),o=!0;let c=this.items.get(l);c!=null&&c>=512&&c<640&&r.push([c,this.itemNameFromIndex(l),n,this.checkName(this.slots.get(a))])}if(!o)break;n++}return r}expandFill(t,e){for(let[n,r]of t){let i=this.slots.get(n),o=this.items.get(r);if(i==null||o==null)throw new Error("missing");e.replace(i,o)}}compressFill(t){let e=new rr;for(let[n,r]of t){let i=this.slots.index(n),o=this.items.index(r);if(i==null||o==null)throw new Error(`Bad slot/item: ${n} ${i} ${r} ${o}`);e.set(i,o)}return e}checkName(t){return this.worlds[t>>>24].checkName(t&16777215)}itemNameFromIndex(t){if(t<this.common)return this.checkName(this.slots.get(t));let e=this.items.get(t);return!e||(e&-256)!==512?"$"+re(e):globalThis.rom.items[e&255]?.messageName||"$"+re(e)}prefill(t,e){for(let n=0;n<this.worlds.length;n++){let r=n<<24,i=this.worlds[n].prefill(e);for(let[o,a]of i)t.set(r|o,r|a)}}itemInfoFromIndex(t){let e=this.items.get(t);if(e==null)throw new Error(`Bad item: ${t}`);return this.itemInfoFromId(e)}itemInfoFromId(t){let e=this.itemInfos.get(t);if(e==null)throw new Error(`Missing info: ${re(t)}`);return e}slotInfoFromIndex(t){let e=this.slots.get(t);if(e==null)throw new Error(`Bad slot: ${t}`);return this.slotInfoFromId(e)}slotInfoFromId(t){let e=this.slotInfos.get(t);if(e!=null)return e}}});function bi(s){return s<128?s:s-256}var Pn,Ya,yi=v(()=>{tn();ce();Pn=class{constructor(t,e,n,r=1){this.rom=t;this._width=n,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=n,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Be(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=ae(r,()=>new Uint32Array(n*e)),this.data=this.layers[0];for(let i=0;i<256;i++)for(let o=0;o<4;o++){let a=Ya[t.palettes[i].color(o)];this.palettes[i<<2|o]=a|4278190080}}useLayer(t){this.data=this.layers[t]||Be(`Bad layer: ${t}`)}resizeWidth(t,e){let n=new Uint32Array(e*this._height),r=Math.min(e,this._width);for(let i=0;i<this._height;i++)n.subarray(i*e,i+e+r).set(t.subarray(i*this._width,i*this._width+r));return n}resizeHeight(t,e){let n=new Uint32Array(this._width*e),r=this._width*Math.min(e,this._height);return n.subarray(0,r).set(t.subarray(0,r)),n}get width(){return this._width}set width(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],t);this._width=t,this.canvas.width=t}get height(){return this._height}set height(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],t);this._height=t,this.canvas.height=t}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(t){this.data.fill(t)}clear(t){let e=t!=null?this.palettes[t<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let n=1;n<this.layers.length;n++)this.layers[n].fill(0)}toDataUrl(t=!1){return this.canvas.toDataURL("image/png")}render(){let t=this.canvas,e=this.ctx;for(let n=0;n<this.layers.length;n++){n&&(t=document.createElement("canvas"),t.width=this.canvas.width,t.height=this.canvas.height,e=t.getContext("2d")||Be());let r=new Uint8Array(this.layers[n].buffer),i=e.getImageData(0,0,this._width,this._height);i.data.set(r),e.putImageData(i,0,0),n&&this.ctx.drawImage(t,0,0)}}rect(t,e,n,r,i){let o=Math.max(0,t),a=Math.max(0,e),l=Math.min(this._height,t+n),c=Math.min(this._width,e+r);for(t=o;t<l;t++)for(e=a;e<c;e++)this.data[t*this._width+e]=i}tile(t,e,n,r){if(e<0||t<0||e+8>=this._width||t+8>=this._height)return;let i=this.rom.patterns.get(n).flip(r<<6);for(let o=0;o<8;o++){let a=i.pixels[8|o]<<1,l=i.pixels[o];for(let c=7;c>=0;c--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(t+o)*this._width+e+c]=this.palettes[r&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,t),this._maxY=Math.max(this._maxY,t+8)}metatile(t,e,n,r,i=0){let o=this.rom.locations[r],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[i&7]);let l=[...o.tilePalettes,127],c=this.rom.tilesets[o.tileset],d=l[c.attrs[n]];for(let f=0;f<2;f++)for(let u=0;u<2;u++){let h=c.tiles[f<<1|u][n],m=a[h&128?1:0]<<6|h&127,g=e+(u<<3),x=t+(f<<3);this.tile(x,g,m,d<<2)}}metasprite(t,e,n,r,i=0,o=0){let a=this.rom.locations[r],l=this.rom.metasprites[n],c=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],f=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],f=!0),!l||!l.used)return;let u=o&l.frameMask;for(let[h,m,g,x]of l.sprites[u]){if(h==128)break;h=bi(h),m=bi(m),x=x+i&255;let y=c[x>>6],p=d[g&3]+176&255,w=y<<6|x&63;f&&(h=-8-h,g^=64),this.tile(t+m,e+h,w,p<<2|g>>6)}}text(t,e,n,r=18){for(let i=0;i<n.length;i++)this.tile(t,e+8*i,n.charCodeAt(i)|3840,r<<2)}},Ya=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0]});function K(s){return s}var Bn=v(()=>{(e=>{function s({id:n},{x:r,y:i}){let o=r>>>8,a=r>>>4&15,l=i>>>8,c=i>>>4&15;return n<<16|l<<12|o<<8|c<<4|a}e.from=s;function t(n,r,i){let o=n;if(r){let a=(o&240)+(r<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(i){let a=(o&15)+i;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=t})(K||={})});var Si,kt,wi=v(()=>{yi();Bn();Si=Symbol("[LocationMap data]"),kt=class s extends Pn{constructor(e,n=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let r=e.locations[n];this.width=(r.used?r.width:1)*256,this.height=(r.used?r.height:1)*240,this.location=r;let i=o=>{let a=o.offsetX,l=o.offsetY,c=o.target;for(;c&&c!==this.element;)c=c.parentElement;if(!c)return;let d=a>>8,f=Math.floor(l/240),u=a-256*d>>4,h=l-240*f>>4,g=this.location.id<<16|f<<12|d<<8|h<<4|u;s.setData(o,{tile:g,target:this})};this.element.addEventListener("mousemove",i),this.element.addEventListener("mousedown",i),this.element.addEventListener("mouseup",i),this.element.addEventListener("click",i),this.redraw()}static getData(e){return e[Si]}static setData(e,n){e[Si]=n}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,n=(1-e)*50;this.element.style.transform=`translate(-${n}%,-${n}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,n,r){for(let i of e){if(i>>>16!==this.location.id)continue;let o=i>>>12&15,a=i>>>8&15,l=i>>>4&15,c=i&15,d=240*o+16*l,f=256*a+16*c;r!=null&&(this.useLayer(3),this.rect(d-1,f-1,18,18,0)),this.useLayer(1),e.has(K.add(i,-1,0))||this.rect(d-1,f-1,2,18,n),e.has(K.add(i,0,-1))||this.rect(d-1,f-1,18,2,n),e.has(K.add(i,1,0))||this.rect(d+15,f-1,2,18,n),e.has(K.add(i,0,1))||this.rect(d-1,f+15,18,2,n)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let n=0;n<this.location.width;n++){let r=this.location.screens[e][n];this.drawScreen(this.rom.screens[r],e,n)}this.useLayer(2);for(let e of this.location.spawns){let n=0,{x:r,y:i}=e;i-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;r+=8,i+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(n+=64),o!=null&&this.metasprite(i,r,o,this.location.id,n)}this.render()}drawScreen(e,n,r){let i=n*240,o=r*256,a=this.rom.tilesets[this.location.tileset],l,c=!1;for(let d of this.location.flags)if(d.xs===r&&d.ys===n){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(c=!0);break}for(let d=0;d<240;d+=16)for(let f=0;f<16;f++){let u=e.tiles[d|f];u<32&&(this.flags.has(l)||c)&&(u=a.alternates[u]),this.metatile(i+d,o+f*16,u,this.location.id,0)}}}});function Ei(s,t){if(s.size<t.size)return!1;for(let e of t)if(!s.has(e))return!1;return!0}var D,Wn,ze,Lr=v(()=>{de();(d=>{function s(...f){return[[].concat(...f.map(([u])=>u))]}d.and=s;function t(...f){let u=[];for(let h of f){if(h===d.OPEN)return d.OPEN;h!==d.CLOSED&&u.push(...n(h))}return u.length?u:d.CLOSED}d.or=t;function e(f,u){if(f===d.OPEN)return n(u);if(u===d.OPEN)return n(f);if(f===d.CLOSED||u===d.CLOSED)return d.CLOSED;let h=new c;for(let m of f)for(let g of u)h.addList([...m,...g]);return n(h)}d.meet=e;function n(f){return f instanceof c?[...le.map(f,u=>[...u])]:f}d.freeze=n;function r(f){return f instanceof c?f.label():f.map(u=>u.join("&")).join("|")}d.label=r;function i(f){let u=f[Symbol.iterator](),{value:h,done:m}=u.next();return m||!u.next().done?!1:!!h[Symbol.iterator]().next().done}d.isOpen=i;function o(f){return!!f[Symbol.iterator]().next().done}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class c{constructor(u){this.self=u;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(u,h){for(let m of h)if(Array.isArray(m))throw new Error;if(h.has(this.self)||this.map.has(u))return!1;for(let[m,g]of this.map){if(Ei(h,g))return!1;Ei(g,h)&&this.map.delete(m)}return this.map.set(u,h),!0}addRoute(u){return this.addInternal(u[Wn],u.deps)}addAll(u){for(let h of u)this.addList(h)}addList(u){let h=[...new Set(u)].sort(),m=new Set(h);this.addInternal(h.join("&"),m)}restrict(u){let h=[...this.map.values()];this.map.clear();for(let m of h)for(let g of u)this.addList([...m,...g])}label(){return[this.map.keys()].join("|")}}d.Builder=c})(D||={});Wn=Symbol("depsLabel");Wn;ze=class{constructor(t,e){this.target=t;let n=[...new Set(e)].sort();this.deps=new Set(n),this[Wn]=n.join("&"),this.label=`${this.target}:${this[Wn]}`}}});function Ja(s,t){let e=D.OPEN,n,r=4;return t&$.DOLPHIN&&t&$.FLY?(t&$.SLOPE&&(n=s.flags.ClimbWaterfall.r),e=[[s.flags.CurrentlyRidingDolphin.c],[s.flags.Flight.c]]):(t&$.SLOPE9?n=s.flags.ClimbSlope9.r:t&$.SLOPE8?n=s.flags.ClimbSlope8.r:t&$.SLOPE&&(n=s.flags.ClimbSlope10.r),t&$.FLY&&(e=s.flags.Flight.r)),t&$.SWAMP&&(e=e.map(i=>[s.flags.TravelSwamp.c,...i])),t&$.PAIN&&(e=e.map(i=>[s.flags.CrossPain.c,...i])),t&$.BARRIER&&(e=e.map(i=>[s.flags.ShootingStatue.c,...i]),n=s.flags.ShootingStatueSouth.r,r=1),new zn(e,n,r)}function Ti(s){let t=[];for(let e=0;e<s.exit.length;e++)for(let n=0;n<4;n++)s.exit[e][0]&1<<n&&(t[n]=e);for(let e=0;e<4;e++)if(t[e]==null)throw new Error(`Bad terrain: ${s.exit.map(n=>n[0]).join(",")}`);return t}function Ne(s,t){let e=[...s],n=e.map(r=>le.isEmpty(r)?"open":[...r].map(i=>t.flags[i]?.debug).join(" & ")).join(") | (");return e.length>1?`(${n})`:e.length?n:"never"}var Hn,$,Gr,mt,zn,Fr,Dr,Pr,Br,Xa,Wr,Hr=v(()=>{de();Lr();Hn=class{constructor(t){this.rom=t;this.tiles=new H(t=>Ja(this.rom,t));this.bosses=new H(t=>new Fr(t));this.statues=new Map;this.flags=new H(t=>new H(e=>new H(n=>new Br(t,e,n))));this.meets=new H(t=>new H(e=>new Wr(t,e)));this._seamless=new H(t=>new Gr(t))}tile(t){return t&4?void 0:this.tiles.get(t)}boss(t,e){return e?this.rage||(this.rage=new Pr(t,this.rom.flags.RageSkip.id)):this.bosses.get(t)}statue(t){let e=D.label(t),n=this.statues.get(e);return n||this.statues.set(e,n=new Dr(t)),n}flag(t,e,n){return t||(t=Xa),this.flags.get(t).get(e).get(n)}meet(t,e){return this.meets.get(t).get(e)}seamless(t){return this._seamless.get(t)}label(t,e){return t.label?t.label(e):"Terrain"}};(f=>{f.FLY=2,f.BLOCKED=4,f.SLOPE=32,f.PAIN=128,f.BITS=166,f.SWAMP=256,f.BARRIER=512,f.SLOPE8=1024,f.SLOPE9=2048,f.DOLPHIN=4096;function d(u,h){return u.label?.(h)??"Terrain"}f.label=d})($||={});Gr=class{constructor(t){this._delegate=t;this.enter=t.enter,this.exit=t.exit}label(t){return`Seamless(${$.label(this._delegate,t)})`}},mt=class{constructor(t,e=D.OPEN){this.enter=t;this.exit=[[15,e]]}get kind(){return"Simple"}label(t){let e=[];return D.isOpen(this.enter)||e.push(`enter = ${Ne(this.enter,t)}`),D.isOpen(this.exit[0][1])||e.push(`exit = ${Ne(this.exit[0][1],t)}`),`${this.kind}(${e.join(", ")})`}},zn=class{constructor(t,e,n=4){this.enter=t;this.exit=e?[[15&~n,e],[n,D.OPEN]]:[[15,D.OPEN]]}get kind(){return"South"}label(t){if(this.exit.length===1)return mt.prototype.label.call(this,t);let e=[];return D.isOpen(this.enter)||e.push(`enter = ${Ne(this.enter,t)}`),D.isOpen(this.exit[0][1])||e.push(`other = ${Ne(this.exit[0][1],t)}`),D.isOpen(this.exit[1][1])||e.push(`south = ${Ne(this.exit[1][1],t)}`),`${this.kind}(${e.join(", ")})`}};Fr=class extends mt{constructor(e){super(D.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},Dr=class extends zn{constructor(e){super(D.OPEN,e);this._req=e}get kind(){return"Statue"}},Pr=class{constructor(t,e){this._rageFlag=t;this._rageSkipFlag=e;this.enter=D.OPEN;this.exit=[[11,[[t],[e]]],[4,D.OPEN]]}label(){return"Rage"}},Br=class extends mt{constructor(t,e,n){if(t.exit.length!==1||n.exit.length!==1)throw console.error(t,n),new Error("bad flag");let r=[[e]],i=e>=0?D.meet(n.enter,r):n.enter,o=e>=0?D.meet(n.exit[0][1],r):n.exit[0][1];super(D.or(t.enter,i),D.or(t.exit[0][1],o))}get kind(){return"Flag"}},Xa=new mt(D.CLOSED,D.CLOSED);Wr=class{constructor(t,e){this.left=t;this.right=e;let n=Ti(t),r=Ti(e),i=new Set,o=[];for(let a=0;a<4;a++)i.add(n[a]<<2|r[a]);for(let a of i){let[l,c]=t.exit[a>>2],[d,f]=e.exit[a&3];o.push([l&d,D.meet(c,f)])}this.enter=D.meet(t.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(t){if(this.exit.length===1)return mt.prototype.label.call(this,t);let e=[];D.isOpen(this.enter)||e.push(`enter = ${Ne(this.enter,t)}`);for(let[n,r]of this.exit){let i=[n&1?"N":"",n&2?"W":"",n&4?"S":"",n&8?"E":""].join("");e.push(`exit${i} = ${Ne(r,t)}`)}return`${this.kind}(${e.join(", ")})`}};$.debugLabel=Ne;typeof window=="object"&&(window.debugLabel=Ne)});var Un,Ci=v(()=>{wi();Hr();ce();Un=class{constructor(t,e){this.rom=t;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",n=>this.click(n)),this.element.addEventListener("mousemove",n=>this.move(n)),this.renderArea(0)}click(t){let e=kt.getData(t);if(!e)return;let n=this.world.tiles.get(e.tile);if(n!=null){if(n.area===this.area){let r=n.exit!=null?this.world.tiles.get(n.exit):null;r&&r.area!==this.area&&(n=r)}n.area&&n.area!==this.area&&this.renderArea(n.area.id)}}move(t){let e=kt.getData(t);if(!e)return;let n=this.world.tiles.get(e.tile);if(n==null)return;let r=n.exit!=null&&!this.area.tiles.has(n.exit);e.target.element.style.cursor=r?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(t){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let r of this.rom.locations){if(!r.used)continue;let i=this.world.locations[r.id]?.areas[Symbol.iterator]().next().value;if(i==null)continue;let o=document.createElement("option");o.textContent=`${re(r.id)} ${r.name}`,o.value=String(i.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[t];let n=document.createElement("pre");n.textContent=`Area ${t}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${$.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([r,i])=>`${r.debug}: ${Ne(i,this.rom)}`))].join(`
  `)}
Routes:
  ${Ne(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(n);for(let r of this.area.locations){let i=this.rom.locations[r],o=document.createElement("h2");o.textContent=i.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,i))}}makeLocation(t,e){let n=new kt(this.rom,e.id);n.maxWidth=574,n.overlayShade(1426063360);for(let r of this.world.locations[e.id].areas)r!==t&&n.overlayArea(r.tiles,4294901760);return n.overlayArea(t.tiles,4278255615,0),n.render(),n.element}}});var qn,Ri=v(()=>{(o=>{function s(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=s;function t(){return[0,1,2,3]}o.all=t,o.North=0,o.West=1,o.South=2,o.East=3})(qn||={})});var Ue,Mi=v(()=>{Bn();(r=>{function s(i,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let c of[-16,0]){let d=a+c;for(let f of[-16,0]){let u=l+f;yield K.from(i,{x:d,y:u})}}}}}r.trigger=s;function t(i,...o){let a=new Set,l=[...i];for(let[c,d]of o)for(let f of l)a.add(K.add(f,c,d));return a}r.adjust=t;function e(i){let o=[];for(let a=0;a<240;a++)o.push(i&-256|a);return o}r.screen=e;function n(i,...o){let a=new Set,l=[...i];for(let c of o)for(let d of l)a.add(d&65535|c.id<<16);return a}r.atLocation=n})(Ue||={})});function Ot(s){return s}var Ii=v(()=>{(e=>{e.from=(n,r)=>typeof n=="number"||!r?Number(n)>>>8:n.id<<8|r.y>>>8<<4|r.x>>>8;function t(n){return n>>>8}e.fromTile=t})(Ot||={})});function Me(s){return s}var ki=v(()=>{(e=>{function s(n,r){return n*(1<<24)+r}e.of=s;function t(n){return[Math.floor(n/(1<<24)),n%(1<<24)]}e.split=t})(Me||={})});var Oi=v(()=>{});function pt(...s){return[s.map(t=>t.id)]}function qe(...s){return s.map(t=>[t.id])}var Vn,_i,vi=v(()=>{Ci();tn();or();ce();St();de();Ri();Mi();Lr();Ii();Hr();Bn();ki();Oi();ar();Vn=class{constructor(t,e,n=!1){this.rom=t;this.flagset=e;this.tracker=n;this.terrainFactory=new Hn(this.rom);this.terrains=new Map;this.checks=new H(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new H(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new _e;this.neighbors=new H(()=>0);this.routes=new H(()=>new D.Builder);this.routeEdges=new H(()=>new Bt);this.requirementMap=new H(t=>new D.Builder(t));this.limeTreeEntranceLocation=-1;this.chestRequirement=D.OPEN;if(e.alwaysMimics()){let i=[t.flags.SwordOfWind,t.flags.SwordOfFire,t.flags.SwordOfWater,t.flags.SwordOfThunder].filter((o,a)=>t.objects.mimic.elements&1<<a);this.chestRequirement=qe(...i)}for(let r of t.items)for(let i of r.itemUseData)i.kind==="expect"?this.itemUses.get(i.want).push([r,i]):i.kind==="location"&&this.itemUses.get(~i.want).push([r,i]);this.aliases=new Map([[t.flags.ChangeAkahana,t.flags.Change],[t.flags.ChangeSoldier,t.flags.Change],[t.flags.ChangeStom,t.flags.Change],[t.flags.ChangeWoman,t.flags.Change],[t.flags.ParalyzedKensuInDanceHall,t.flags.Paralysis],[t.flags.ParalyzedKensuInTavern,t.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let r of t.locations)this.processLocation(r);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:t,MezameShrine:e,Oak:n,Shyron_ToolShop:r},flags:{AbleToRideDolphin:i,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:c,Barrier:d,BlizzardBracelet:f,BowOfMoon:u,BowOfSun:h,BreakStone:m,BreakIce:g,BreakIron:x,BrokenStatue:y,BuyHealing:p,BuyWarp:w,ClimbWaterfall:b,ClimbSlope8:T,ClimbSlope9:C,ClimbSlope10:I,CrossPain:S,CurrentlyRidingDolphin:O,Flight:L,FlameBracelet:A,FormBridge:_,GasMask:X,GlowingLamp:se,InjuredDolphin:U,LeadingChild:xe,LeatherBoots:P,Money:F,OpenedCrypt:gt,RabbitBoots:De,Refresh:Z,RepairedStatue:ke,RescuedChild:be,ShellFlute:ot,ShieldRing:ue,ShootingStatue:Pe,ShootingStatueSouth:Ve,StomSkip:at,StormBracelet:Jt,Sword:Qn,SwordOfFire:At,SwordOfThunder:Qe,SwordOfWater:W,SwordOfWind:vt,TornadoBracelet:Ze,TravelSwamp:xt,TriggerSkip:ee,UsedBowOfMoon:Oe,UsedBowOfSun:bt,WildWarp:Xt},items:{MedicalHerb:Uo,WarpBoots:qo}}=this.rom,ne=this.entrance(e),Vo=this.entrance(n);this.addCheck([ne],pt(u,h),[gt.id]),this.addCheck([ne],u.r,[Oe.id]),this.addCheck([ne],h.r,[bt.id]),this.addCheck([ne],pt(i,ot),[O.id]),this.addCheck([Vo],pt(xe),[be.id]),this.addItemCheck([ne],pt(se,y),ke.id,{lossy:!0,unique:!0});for(let Te of this.rom.shops){if(Te.location===t.id||Te.location===r.id||!Te.used||Te.type!==1)continue;let Dt=[Te.location<<16|136];for(let Pt of Te.contents)Pt===Uo.id?this.addCheck(Dt,F.r,[p.id]):Pt===qo.id&&this.addCheck(Dt,F.r,[w.id])}let Nt=vt.r,Lt=At.r,Gt=W.r,Ft=Qe.r;if(!this.flagset.orbsOptional()){let Te=qe(c,Ze),Dt=qe(o,A),Pt=qe(l,f),$o=qe(a,Jt);if(Nt=D.meet(Nt,Te),Lt=D.meet(Lt,Dt),Gt=D.meet(Gt,Pt),Ft=D.meet(Ft,$o),this.flagset.assumeSwordChargeGlitch()){let Qt=function(ss){return jo.map(Zn=>Zn[0]===ss.c?Zn:[ss.c,...Zn])},jo=D.or(Nt,Lt,Gt,Ft);Nt=Qt(vt),Lt=Qt(At),Gt=Qt(W),Ft=Qt(Qe)}}this.addCheck([ne],Nt,[m.id]),this.addCheck([ne],Lt,[g.id]),this.addCheck([ne],Gt,[_.id]),this.addCheck([ne],Ft,[x.id]),this.addCheck([ne],qe(vt,At,W,Qe),[Qn.id]),this.addCheck([ne],L.r,[b.id,I.id]),this.addCheck([ne],qe(L,De),[T.id]),this.addCheck([ne],qe(L,De),[C.id]),this.addCheck([ne],d.r,[Pe.id,Ve.id]),this.addCheck([ne],X.r,[xt.id]);let Ko=this.flagset.changeGasMaskToHazmatSuit()?X:P;if(this.addCheck([ne],qe(L,De,Ko),[S.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([ne],P.r,[T.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([ne],pt(O,De),[b.id]),this.flagset.fogLampNotRequired()){let Te=this.flagset.requireHealedDolphinToRide();this.addCheck([ne],Te?U.r:[[]],[i.id])}if(this.flagset.guaranteeBarrier()||this.addCheck([ne],[[F.c,p.c],[F.c,ue.c],[F.c,Z.c]],[Pe.id,Ve.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([ne],[[F.c,L.c]],[Pe.id]),this.flagset.guaranteeGasMask()||this.addCheck([ne],[[F.c,p.c],[F.c,Z.c]],[xt.id,S.id]),this.flagset.assumeWildWarp()&&this.addCheck([ne],D.OPEN,[Xt.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([ne],D.OPEN,[ee.id]),this.addCheck([ne],ee.r,[S.id,T.id,C.id])),this.flagset.chargeShotsOnly())for(let Te of this.rom.townWarp.locations)(this.rom.locations[Te].entrances[0].y&255)<88&&this.addCheck([this.entrance(Te)],w.r,[at.id])}addExtraRoutes(){let{flags:{BuyWarp:t,SwordOfThunder:e,Teleport:n,WildWarp:r},locations:{MezameShrine:i}}=this.rom;if(this.addRoute(new ze(this.entrance(i),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new ze(this.entrance(o[0],o[1]&31),[e.c,t.c])),this.addRoute(new ze(this.entrance(o[0],o[1]&31),[e.c,n.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Be("bad entrance");for(let c of l.enter)this.addRoute(new ze(a,[r.c,...c]))}}consolidateChecks(){for(let[t,e]of this.checks){let n=this.tiles.find(t);if(t!==n){for(let r of e)this.checks.get(n).add(r);this.checks.delete(t)}}}buildRequirementMap(){for(let[e,n]of this.checks)for(let{checks:r,requirement:i}of n)for(let o of r){let a=this.requirementMap.get(o);for(let l of i)for(let c of this.routes.get(e)||[])a.addList([...l,...c])}if(!_i)return;let t=[];for(let[e,n]of this.requirementMap){let r=i=>this.rom.flags[i].name;for(let i of n)t.push(`${r(e)}: ${[...i].map(r).join(" & ")}
`)}t.sort((e,n)=>e<n?-1:e>n?1:0),console.log(t.join(""))}getLocationList(t="Crystalis"){let e=_i?n=>n.debug:n=>n.name;return{worldName:t,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:n=>e(this.rom.flags[n]),prefill:n=>{let{Crystalis:r,MesiaInTower:i,LeafElder:o}=this.rom.flags,a=new Map([[i.id,r.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|n.nextInt(4)),a}}}processLocation(t){t.used&&(this.processLocationTiles(t),this.processLocationSpawns(t),this.processLocationItemUses(t))}unionNeighbors(){for(let[t,e]of this.terrains){let n=K.add(t,0,1);this.terrains.get(n)===e&&this.tiles.union([t,n]);let r=K.add(t,1,0);this.terrains.get(r)===e&&this.tiles.union([t,r])}}addAllRoutes(){this.addExtraRoutes();for(let[t,e]of this.neighbors){let[n,r]=Me.split(t),i=this.terrains.get(n),o=this.terrains.get(r);if(!i||!o)throw new Error(`missing terrain ${re(i?n:r)}`);for(let[a,l]of i.exit)if(a&e)for(let c of l)for(let d of o.enter)this.addRoute(new ze(r,[...c,...d]),n)}if(typeof document=="object"){let t=document.getElementById("debug");t&&t.appendChild(new Un(this.rom,this.getWorldData()).element)}}getWorldData(){let t=0,e=new H(()=>({})),n=ae(256,()=>({areas:new Set,tiles:new Set})),r=[];for(let i of this.tiles.sets()){let o=this.tiles.find(le.first(i)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?D.freeze(this.routes.get(o)):[];if(!l.length)continue;let c={checks:[],id:t++,locations:new Set,routes:l,terrain:a,tiles:new Set};r.push(c);for(let d of i){let f=d>>>16;c.locations.add(f),c.tiles.add(d),n[f].areas.add(c),n[f].tiles.add(d),e.get(d).area=c}}for(let[i,o]of this.exits)e.has(i)&&(e.get(i).exit=o);for(let[i,o]of this.checks){let a=e.get(i).area;if(a)for(let{checks:l,requirement:c}of o)for(let d of l){let f=this.rom.flags[d]||Be();a.checks.push([f,c])}}return{tiles:e,areas:r,locations:n}}addRoute(t,e){if(e!=null){this.routeEdges.get(e).add(t);for(let a of this.routes.get(e))this.addRoute(new ze(t.target,[...a,...t.deps]));return}let n=new Bt,r=new Bt,i=t;n.add(i);let o=n[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;r.add(a),n.delete(a);let c=new Bt,d=a.target;if(this.routes.get(d).addRoute(a))for(let u of this.routeEdges.get(d))c.add(new ze(u.target,[...a.deps,...u.deps]));for(let u of c)r.has(u)||(n.delete(u),n.add(u))}}recordExits(){for(let[t,e]of this.exits)this.exitSet.add(Me.of(this.tiles.find(t),this.tiles.find(e)));for(let t of this.exitSet){let[e,n]=Me.split(t);if(this.terrains.get(e)!==this.terrains.get(n))continue;let r=Me.of(n,e);this.exitSet.has(r)&&(this.tiles.union([e,n]),this.exitSet.delete(t),this.exitSet.delete(r))}}buildNeighbors(){for(let[t,e]of this.terrains){if(!e)continue;let n=K.add(t,1,0),r=this.terrains.get(n);r&&r!==e&&this.handleAdjacentNeighbors(t,n,qn.North);let i=K.add(t,0,1),o=this.terrains.get(i);o&&o!==e&&this.handleAdjacentNeighbors(t,i,qn.West)}for(let t of this.exitSet){let[e,n]=Me.split(t);if(!this.terrains.has(e)||!this.terrains.has(n))continue;let r=Me.of(this.tiles.find(e),this.tiles.find(n));this.neighbors.set(r,this.neighbors.get(r)|1)}}handleAdjacentNeighbors(t,e,n){let r=this.tiles.find(t),i=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=Me.of(i,r);this.neighbors.set(o,this.neighbors.get(o)|1<<n)}if(!this.seamlessExits.has(t)){let o=n^2,a=Me.of(r,i);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(t){let e=new Map,n=new Set,r=(t.id&248)===88;for(let c of t.spawns)if(c.isWall())e.set(Ot.from(t,c),c.id&3);else if(c.isMonster()&&c.id===63){let d=Ot.from(t,c)<<8|c.yt<<4;for(let f=4;f<=11;f++)for(let u=-3;u<=3;u++)n.add(K.add(d,u,f))}let i=this.rom.tilesets[t.tileset],o=this.rom.tileEffects[t.tileEffects-179],a=c=>{let d=t.screens[(c&61440)>>>12][(c&3840)>>>8];return o.effects[this.rom.screens[d].tiles[c&255]]},l=(c,d,f)=>{if(c&=$.BITS,t.id===26&&(c|=$.SWAMP),(t.id===96||t.id===104)&&(c|=$.DOLPHIN),t.id===100&&(d&61680)<4144&&(c|=$.DOLPHIN),f&&(c|=$.BARRIER),!(c&$.DOLPHIN)&&c&$.SLOPE){let u=d,h=0;for(;a(u)&$.SLOPE;)u=K.add(u,1,0),h++;h<6?c&=~$.SLOPE:h<9?c|=$.SLOPE8:h<10&&(c|=$.SLOPE9)}if(c&$.PAIN){for(let u of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a(K.add(d,...u))&($.PAIN|$.FLY))){c&=~$.PAIN;break}}return this.terrainFactory.tile(c)};for(let c=0,d=t.height;c<d;c++){let f=t.screens[c],u=t.id<<8|c<<4;for(let h=0,m=t.width;h<m;h++){let g=this.rom.screens[f[h]],x=u|h,y=x&255,p=e.get(x),w=r?this.rom.flags.AlwaysTrue.id:p!=null?this.wallCapability(p):t.flags.find(C=>C.screen===y)?.flag,b=t.pits.find(C=>C.fromScreen===x);b&&this.exits.set(x<<8|136,b.toScreen<<8|136);let T=this.rom.flags[w]?.logic??{};for(let C=0;C<240;C++){let I=x<<8|C,S=g.tiles[C];T.assumeTrue&&S<32&&(S=i.alternates[S]);let O=t.isShop()?0:o.effects[S],L=n.has(I),A=l(O,I,L);if(S<32&&i.alternates[S]!==S&&w!=null&&!T.assumeTrue&&!T.assumeFalse){let _=l(o.effects[i.alternates[S]],I,L);_&&(A=this.terrainFactory.flag(A,T.track?w:-1,_))}A&&this.terrains.set(I,A)}}}for(let c of t.exits){let{dest:d,entrance:f}=c,u=K.from(t,c),h;if(c.isSeamless()){h=u&65535|d<<16;let m=K.from(t,c);this.seamlessExits.add(m);let g=this.terrains.get(m);g&&this.terrains.set(m,this.terrainFactory.seamless(g))}else h=this.entrance(this.rom.locations[d],f&31);this.exits.set(u,h),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[f].y>160&&(this.limeTreeEntranceLocation=t.id)}}processLocationSpawns(t){for(let e of t.spawns)e.isTrigger()?this.processTrigger(t,e):e.isNpc()?this.processNpc(t,e):e.isBoss()?this.processBoss(t,e):e.isChest()?this.processChest(t,e):e.isMonster()?this.processMonster(t,e):e.type===3&&e.id===224&&this.processKeyUse(Ue.screen(K.from(t,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(t,e){let n=this.rom.trigger(e.id);if(!n)throw new Error(`Missing trigger ${e.id.toString(16)}`);let r=this.filterRequirements(n.conditions),i=this.filterAntiRequirements(n.conditions),o=K.from(t,e),a=Ue.trigger(t,e),l=[];for(let c of n.flags){let d=this.flag(c);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,r,l),n.message.action){case 25:n.id===134&&!this.flagset.assumeRabbitSkip()?a=Ue.adjust(a,[0,-1],[0,1]):n.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=Ue.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(i=D.or(i,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(i));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,r);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,r,n.id);break;case 24:{let c=this.flagset.chargeShotsOnly()?D.meet(r,this.rom.flags.StomSkip.r):r;this.addItemCheck(a,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,r,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,t,r);break;case 27:t===this.rom.locations.Portoa_PalaceEntrance&&(a=Ue.adjust(a,[-2,0]),i=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,t,i);break}for(let[c,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([K.from(t,e)],D.OPEN,c,d)}processNpc(t,e){let n=this.rom.npcs[e.id];if(!n||!n.used)throw new Error(`Unknown npc: ${re(e.id)}`);let r=n.spawnConditions.get(t.id)||[],i=this.filterRequirements(r),o=K.from(t,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,f]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,i,d,f);if(n===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,i),n.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(r),n===this.rom.npcs.Rage?(a=Ue.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=Ue.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):n===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=D.or(this.rom.flags.MesiaRecording.r,pt(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):n===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(n===this.rom.npcs.FortuneTeller&&(a=Ue.adjust(a,[0,0],[2,0])),D.isClosed(i))return;let[[...l]]=i;for(let d of n.globalDialogs){let f=this.flag(~d.condition),u=this.flag(d.condition);if(f?.logic.assumeFalse||u?.logic.assumeTrue)return;f?.logic.track&&l.push(f.id)}let c=n.localDialogs.get(t.id)??n.localDialogs.get(-1)??[];for(let d of c){let f=[...l],u=this.flag(d.condition),h=this.flag(~d.condition);if(u?.logic.track&&f.push(u.id),!u?.logic.assumeFalse&&!h?.logic.assumeTrue&&this.processDialog(a,n,f,d),u?.logic.assumeTrue||h?.logic.assumeFalse)break;h?.logic.track&&l.push(h.id)}}processDialog(t,e,n,r){this.addCheckFromFlags(t,[n],r.flags);let i={lossy:!0,unique:!0};switch(r.message.action){case 8:this.processKeyUse(t,[n]);break;case 20:this.addItemCheck(t,[n],this.rom.flags.SlimedKensu.id,i);break;case 16:this.addItemCheck(t,[n],this.rom.flags.AsinaInBackRoom.id,i);break;case 17:this.addItemCheck(t,[n],256|e.data[1],i);break;case 3:this.addItemCheck(t,[n],256|e.data[0],i);break;case 10:let o=this.flagset.alwaysMimics()?[[...n,this.rom.flags.Sword.c]]:[n];this.addItemCheck(t,o,256|e.data[0],i);break;case 9:let a=e.data[1];a!==255&&this.addItemCheck(t,[n],256|a,i);break;case 25:this.addItemCheck(t,[n],this.rom.flags.AkahanaFluteOfLimeTradein.id,i);break;case 26:this.addItemCheck(t,[n],this.rom.flags.Rage.id,i);break;case 27:break}}processLocationItemUses(t){for(let[e,n]of this.itemUses.get(~t.id))this.processItemUse([this.entrance(t)],D.OPEN,e,n)}handleMovingGuard(t,e,n){if(this.flagset.assumeStatueGlitch())return;let r=[];for(let i of e.spawns.slice(0,2))if(i.isNpc()&&this.rom.npcs[i.id].isParalyzable()){r.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&r.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(t,this.terrainFactory.statue([...n,...r].map(Zt)))}handleBoat(t,e,n){let r=this.walkableNeighbor(t);if(r==null)throw new Error("Could not find walkable neighbor.");let i=t>>8&240|t>>4&15,o=t>>4&240|t&15,a;for(let u of e.exits)u.yt===i&&u.xt<o&&(a=u);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let c=l.entrances[a.entrance],d=K.from(l,c),f=d;for(;;){f=K.add(f,0,-1);let u=this.walkableNeighbor(f);if(u!=null){let h={enter:D.freeze(n),exit:[[15,D.OPEN]]};this.addTerrain([r],h),this.exits.set(r,u),this.exitSet.add(Me.of(r,u)),this.exits.set(d,u),this.exitSet.add(Me.of(d,u)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(t,e,n){let r=this.itemGrant(n),i=256|r;if(r==null)throw new Error(`missing item grant for ${n.toString(16)}`);let o=n>=128;this.addItemCheck(t,e,i,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(t,e){for(let n of t){let r=this.terrains.get(n);r!=null&&this.terrains.set(n,this.terrainFactory.meet(r,e))}}addCheck(t,e,n){if(D.isClosed(e))return;let r={requirement:D.freeze(e),checks:n};for(let i of t)this.terrains.has(i)&&this.checks.get(i).add(r)}addItemCheck(t,e,n,r){this.addCheck(t,e,[n]),this.slots.set(n,r);let i=this.rom.itemGets[this.rom.slots[n&255]],o=this.rom.items[i.itemId],a=o?.unique,l=i.isLosable(),c=a||o===this.rom.items.OpelStatue;this.items.set(512|i.id,{unique:a,losable:l,preventLoss:c})}addCheckFromFlags(t,e,n){let r=[];for(let i of n){let o=this.flag(i);o?.logic.track&&r.push(o.id)}r.length&&this.addCheck(t,e,r)}walkableNeighbor(t){if(this.isWalkable(t))return t;for(let e of[-1,1]){let n=K.add(t,e,0),r=K.add(t,0,e);if(this.isWalkable(n))return n;if(this.isWalkable(r))return r}}isWalkable(t){return!(this.getEffects(t)&$.BITS)}ensurePassable(t){return this.isWalkable(t)?t:this.walkableNeighbor(t)??t}getEffects(t){let e=this.rom.locations[t>>>16],n=this.rom.tileEffects[e.tileEffects-179].effects,r=e.screens[(t&61440)>>>12][(t&3840)>>>8];return n[this.rom.screens[r].tiles[t&255]]}processBoss(t,e){let{bosses:n}=this.rom,{Rage:r,StatueOfSun:i,StatueOfMoon:o}=n,a=e.id===201,l=e.id===202,c=e.id===195,d=c?r:a?o:l?i:n.fromLocation(t.id),f=K.from(t,e);if(!d||!d.flag)throw new Error(`Bad boss at ${t.name}`);let u=f&-256,h=this.terrainFactory.boss(d.flag.id,c),m=ae(240,g=>u|g);this.addTerrain(m,h),!a&&!l&&this.addBossCheck(m,d)}addBossCheck(t,e,n=D.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let r=D.meet(n,this.bossRequirements(e));e===this.rom.bosses.Draygon2?this.addCheck(t,r,[e.flag.id]):this.addItemCheck(t,r,e.flag.id,{lossy:!1,unique:!0})}processChest(t,e){if(this.rom.slots[e.id]>=112)return;let n=256|e.id,r=this.rom.slots[e.id];if(r>=112)return;let i=this.rom.items[r],o=this.flagset.preserveUniqueChecks()?!!i?.unique:!0;this.addItemCheck([K.from(t,e)],this.chestRequirement,n,{lossy:!1,unique:o})}processMonster(t,e){let n=this.rom.objects[e.monsterId];if(!(n instanceof et))return;let{Money:r,RageSkip:i,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:c,SwordOfThunder:d}=this.rom.flags;if(t.id===this.limeTreeEntranceLocation&&n.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(t)],D.OPEN,[i.id]),!n.goldDrop)return;let f=[K.from(t,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(f,o.r,[r.id]);return}let u=[a,l,c,d].filter((h,m)=>n.elements&1<<m);this.addCheck(f,qe(...u),[r.id])}processItemUse(t,e,n,r){t=new Set([...t].map(a=>this.walkableNeighbor(a)??a));let i=[[512|n.id]];n.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&i[0].push(this.rom.flags.Change.c),n===this.rom.items.MedicalHerb&&(i[0][0]=this.rom.flags.BuyHealing.c);let o=D.meet(e,i);switch(this.addCheckFromFlags(t,o,r.flags),r.message.action){case 16:this.processKeyUse(t,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(t,o,n.id);break;case 2:this.addItemCheck(t,o,256|this.rom.npcs[r.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(t,e){let[n,...r]=new Set([...t].map(a=>Ot.from(a)));if(n==null||r.length)throw new Error("Expected one screen");let o=this.rom.locations[n>>>8].flags.find(a=>a.screen===(n&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(t,e,[o.flag])}bossRequirements(t){if(t===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=t.object,n=new D.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())n.addAll(this.rom.flags.Sword.r);else{let i=this.flagset.guaranteeSwordMagic()?t.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&n.addAll(this.swordRequirement(a,i))}let r=[];if(t.npc!=null&&t.location!=null){let i=t.npc.spawns(this.rom.locations[t.location]);r.push(...this.filterRequirements(i)[0])}return t===this.rom.bosses.Insect?r.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):t===this.rom.bosses.Draygon2&&r.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&r.push(this.rom.flags.Refresh.c),n.restrict([r]),D.freeze(n)}swordRequirement(t,e){let n=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][t];if(e===1)return n.r;let r=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][t];return e===3?pt(n,...r):r.map(i=>[n.c,i.c])}itemGrant(t){for(let[e,n]of this.rom.itemGets.actionGrants)if(e===t)return n;throw new Error(`Could not find item grant ${t.toString(16)}`)}filterRequirements(t){let e=[];for(let n of t)if(n<0){if(this.flag(~n)?.logic?.assumeTrue)return D.CLOSED}else{let r=this.flag(n);if(r?.logic.assumeFalse)return D.CLOSED;r?.logic.track&&e.push(r.id)}return[e]}filterAntiRequirements(t){let e=[];for(let n of t)if(n>=0){if(this.flag(~n)?.logic?.assumeFalse)return D.OPEN}else{let r=this.flag(~n);if(r?.logic.assumeTrue)return D.OPEN;r?.logic.track&&e.push([r.id])}return e}flag(t){let e=t,n=this.rom.flags[e];return this.aliases.get(n)??n}entrance(t,e=0){return typeof t=="number"&&(t=this.rom.locations[t]),this.tiles.find(K.from(t,t.entrances[e]))}wallCapability(t){switch(t){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${t}`)}}};_i=!1});function Ni(s){if(!s.compressedMapData){s.compressedMapData=!0;for(let t=0;t<3;t++)s.metascreens.renumber(256|t,320|t),delete s.screens[256|t]}}function Li(s){if(!s.compressedMapData)throw new Error("Must compress first");let{grass:t,town:e,cave:n,dolphinCave:r,pyramid:i,river:o,sea:a,lime:l,mountain:c,shrine:d,desert:f,mountainRiver:u,swamp:h,house:m,fortress:g,labyrinth:x,iceCave:y,tower:p}=s.metatilesets;s.moveScreens([h],4),s.moveScreens([m],4),s.moveScreens([e],4),s.moveScreens([l],4),s.moveScreens([d],4),s.moveScreens([p],4),s.moveScreens([c,u],4),s.moveScreens([n,i,g,x,y],5);let[]=[a,r,t,o,f]}var Gi=v(()=>{wt()});function Fi(s,t){let o=s.objects[159],a=s.objects[127],l=s.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((f,u)=>l.data[u]=f),l.data[3]=a.data[3];let c=new Set([47,61]),d=new Set([46,79]);for(let f of s.locations){if(!f.pits.length)continue;let u=t.nextInt(3)<1;for(let h of f.spawns)h.isMonster()&&(d.has(h.id)&&(h.id=(u?159:126)-80),c.has(h.id)&&(h.id=(u?141:127)-80))}}var Di=v(()=>{});function Ie(s,t,...e){let n=t,r=0,i;for(;(i=e[r++])!=null;)if(typeof i=="number")s[n++]=i;else if(typeof i=="string")for(let o of i)s[n++]=o.charCodeAt(0);else throw new Error("bad data")}function Pi(s){s[107924]=255,s[118213]=168,s[106870]=255,s[108620]=255,s[120899]=160,s[122987]&=7,s[122991]&=7,s[122995]&=7,s[122999]&=7,s[123003]&=7,s[123012]&=7,s[123035]&=7,s[123065]&=7,s[123141]=47,s[123511]=0,s[123750]=64,s[123761]=0,s[123783]=0,s[123793]=0,Ie(s,106856,51,51),Ie(s,107662,51,51),s[105393]=112,s[105397]=113,s[105079]=114,s[105963]=115,s[106565]=116,s[106721]=117,s[106725]=118,s[106729]=119,s[108037]=120,s[107457]=121,s[107461]=122,s[107465]=123,Ie(s,123063,192,0),Ie(s,123690,192,0),Ie(s,123696,192,0),Ie(s,123702,192,0),Ie(s,123104,192,0),Ie(s,123110,192,0),s[116739]=0,Ie(s,116749,162,179),s[109190]=254,Ie(s,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);let t=230492,e=167,n=154,r=231651,i=en(s,t+(e<<1))+196608,o=s.slice(i,i+10);Ie(s,t+(n<<1),r&255,r>>8&255),o[4]|=3,o[8]|=3,Ie(s,r,...o);let a=112259,l=112653;s[a+2]=n,s[l+2]=n,s[a+18]=n,s[a+19]=n,s[l+18]=n,s[l+19]=n,s[217335]=n,Ie(s,157038,"Simea",16,0,"     ",16,0)}function Bi(s){let{config:t,rom:e}=s;Tl(e),rl(e),tl(e),nl(e),sl(s),Ll(e),Gl(e),vl(e),ol(e),al(e),fl(e),il(e),xl(e),ul(e),kl(s),Ml(e),t.triggers.deoRequiresTelepathy&&pl(e),gl(s),hl(s),ml(e),dl(e),cl(s),Cl(e),Rl(e),bl(e),yl(s),t.glitches.rabbitSkip===Kn&&Sl(e),t.glitches.flightStatueSkip===Kn&&wl(e),Il(s),ll(e),t.items.noStabs&&Ol(e),_l(s),Al(s),El(e),t.enemies.permadeath&&Fl(e),t.quality.updateHud&&(el(e),e.writeMonsterNames=!!t.quality.enemyHpInHud),t.quality.colorSwordByElement&&Za(e),t.quality.statTracking&&Qa(e),Dl(e),Nl(e)}function Qa(s){for(let b=0;b<4;b++)s.patterns.set(5376,41+b,Le.BLANK_TILES[b]);if(s.prg[143082]===40)return;s.prg[143082]=40;let n=143364,r=144132,i=127;for(let b=n;b<r;b++)s.prg[b]>=41&&s.prg[b]<=45&&(s.prg[b]+=i);let o=42,a=160;for(let b=n;b<r;b+=192)s.prg[b+a]=o;let l=new Map([[66,a]]),c=142469,d=142546;for(let b=c;b<d;b++)l.has(s.prg[b])&&(s.prg[b]=l.get(s.prg[b]));for(let b=n;b<r;b+=192)for(let T=123;T<=127;T++)s.prg[b+T]==o+i&&(s.prg[b+T]=o);let f=3,u=2,h=144376,m=144440;for(let b=h;b<m;b++){let T=s.prg[b];for(let C=0;C<8;C+=2){let I=f<<C,S=u<<C;(T&I)==I&&(T=T&(255^3<<C)|S)}s.prg[b]=T}let g=144440,x=4*f,y=[15,48,15,17];for(let b=0;b<y.length;b++)s.prg[g+x+b]=y[b];s.prg[g+u*4+3]=8;let p=145114,w=145222;for(let b=p;b<w;b+=4)s.prg[b]+=128}function Za(s){function t(e,n){for(let r=0;r<=10;r++){if(r===8)continue;let i=s.patterns.get(r|e),o=[...i.pixels];for(let a=0;a<i.pixels.length;a++)i.pixels[a]=o[a^8],a>>>3===n&&(i.pixels[a]|=o[a])}}t(4240),t(4304),t(4368),t(4432),t(4496)}function el(s){s.patterns.set(3584,0,Le.HUD_LF),s.patterns.set(3584,1,Le.HUD_PW),s.patterns.set(3584,2,Le.HUD_EY),s.patterns.set(3584,3,Le.HUD_LV),s.patterns.set(3584,4,Le.HUD_DL),s.patterns.set(3584,5,Le.HUD_MP),s.patterns.set(3584,6,Le.HUD_EX),s.patterns.set(3584,26,Le.HUD_CLOSE_LEFT),s.patterns.set(3584,27,Le.HUD_CLOSE_RIGHT)}function tl(s){s.items.GlowingLamp.itemUseData[0].message.action=11}function nl(s){let t=s.nextFreeTrigger("mezame");t.used=!0,t.conditions=[~s.flags.AlwaysTrue.id],t.message=zt.of({action:4}),t.flags=[s.flags.AlwaysTrue.id],s.locations.MezameShrine.spawns.push(V.of({tile:136,type:2,id:t.id}))}function rl(s){let t=new Set([129,139,144,153,166,167,168,169,170,171,172,s.allocatedTriggers.get("zombie warp")]);for(let e of s.locations)e.used&&(e.spawns=e.spawns.filter(n=>!n.isTrigger()||!t.has(n.id)))}function sl(s){let{rom:t,config:e}=s;if(t.objects[16].atk=3,t.objects[17].atk=6,t.objects[18].atk=8,t.objects[24].atk=3,t.objects[19].atk=5,t.objects[25].atk=5,t.objects[23].atk=7,t.objects[26].atk=7,t.objects[20].atk=3,t.objects[21].atk=6,t.objects[22].atk=8,t.objects[28].atk=3,t.objects[29].atk=3,t.objects[30].atk=5,t.objects[27].atk=7,t.objects[31].atk=7,e.items.adjustTornadoSpeed){let n=e.items.adjustTornadoSpeed,r=t.objects[18];r.speed+=n,r.data[12]*=1-n*.2}}function il(s){let t=s.trigger(160);t.used=!0,t.conditions=[],t.flags=[],t.message=zt.of({part:0,index:0,action:21}),s.objects[94].data[13]=254,s.items.InsectFlute.itemUseData[0].flags=[s.flags.UsedInsectFlute.id]}function ol(s){s.items.OpelStatue.selectedItemValue=0}function al(s){for(let t of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])s.patterns.set(t<<6,e,s.patterns.get(6016,e).pixels);s.objects[12].metasprite=169}function ll(s){for(let t in[4,5,8,9])s.tileEffects[9].effects[t]=24,s.tileEffects[2].effects[t]=24}function dl(s){let{tiles:t}=s.screens[161];t[40]=159,t[55]=35,t[56]=35,t[57]=33,t[71]=141,t[72]=143,t[86]=153,t[87]=154,t[88]=140}function cl(s){let{rom:t,config:e}=s,{flags:{AbleToRideDolphin:n,AlwaysTrue:r,FogLamp:i,InjuredDolphin:o,KensuInCabin:a,ReturnedFogLamp:l,ShellFlute:c},items:{ShellFlute:d},locations:{BoatHouse:f,Portoa_FishermanHouse:u},npcs:{Fisherman:h,FishermanDaughter:m,KensuInCabin:g}}=t,{beachKensuGivesItem:x,rideDolphin:y,spawnBeachKensu:p,spawnFisherman:w}=e.triggers,{RideDolphin:b,SpawnBeachKensu:T,SpawnFisherman:C}=R.Triggers,I=[];y===b.BEACH_KENSU?(I.push(~n.id),g.dialog()[0].message.action=2):(g.localDialogs.get(-1)[0].flags=[],t.flags.free(n.id),y===b.HEALED_DOLPHIN?d.itemUseData[0].want=o.id:d.itemUseData[0].want=r.id);let S=[];w===C.FOG_LAMP?S.push(i.id):w===C.SHELL_FLUTE?S.push(c.id):w===C.HEALED_DOLPHIN&&S.push(o.id),h.spawnConditions.set(u.id,S);{let O=m.localDialogs.get(-1),L=O.shift();for(let A of S){let _=L.clone();_.condition=~A,O.unshift(_)}}p===T.BOAT?I.push(l.id):p===T.SHELL_FLUTE&&I.push(c.id),x&&(g.data[0]=103,g.dialog()[0].message.action=10,t.itemGets[100].flags=[],t.itemGets[103].copyFrom(t.itemGets[100]),I.push(~a.id)),g.spawnConditions.set(f.id,I)}function fl(s){for(let t of s.locations)for(let e of t.spawns)e.isChest()&&(e.timed=!1)}function ul(s){let t=s.locations;t.GoaFortress_Kelbesque.spawns[0].x-=16,t.GoaFortress_Zebu.spawns.splice(1,1),t.GoaFortress_Tornel.spawns.splice(2,1),t.GoaFortress_Asina.spawns.splice(2,1),t.GoaFortress_Kensu.spawns.splice(3,1),t.GoaFortress_Kensu.spawns.splice(1,1)}function hl(s){let{config:t,rom:e}=s,{items:{AlarmFlute:n},flags:{TalkedToZebuStudent:r,ZebuStudent:i},locations:{MezameShrine:o,Leaf_StudentHouse:a,WaterfallCave4:l,ZebuCave:c},npcs:{WindmillGuard:d,Zebu:f}}=e;if(e.itemGets[49].inventoryRowStart=32,n.unique=!0,n.basePrice=0,t.triggers.zebuStudentGivesItem)d.data[1]=49;else{d.data[1]=255;let m=d.dialog(a)[0];m.condition=~r.id,m.flags.push(r.id),zr(f.spawns(c),i.id,r.id),o.spawns.push(V.of({screen:0,tile:155,type:2,id:49})),o.spawns.push(V.of({screen:0,tile:149,type:2,id:73})),i.unsafeRename("Mezame Right Chest"),e.flags[329].unsafeRename("Mezame Left Chest"),e.itemGets[73].itemId=e.items.MedicalHerb.id}let u=[[33,.72],[31,.9]],h=0;for(let m of e.shops)if(m.type===1)for(let g=0,x=m.contents.length;g<x;g++){if(m.contents[g]!==49)continue;let[y,p]=u[h++%u.length];m.contents[g]=y,e.shopDataTablesAddress&&(m.prices[g]=Math.round(m.prices[g]*p))}e.itemGets[91].itemId=29,l.spawn(25).id=16}function ml(s){let{flags:{Karmine:t,Mado1:e},npcs:{Brokahana:n}}=s,r=is(n.localDialogs.get(-1))[0];if(r.condition!==~t.id)throw new Error(`Bad brokahana condition: ${r.condition}`);r.condition=~e.id}function pl(s){let{flags:{Telepathy:t},npcs:{Deo:e,SaharaBunny:n}}=s;n.globalDialogs.push(dr.of(~t.id,[26,18])),e.globalDialogs.push(dr.of(~t.id,[26,19]))}function gl(s){let{config:t,rom:e}=s;if(t.items.addSpeedBoots){let n=e.items[47];if(n.menuName="Speed Boots",n.messageName="Speed Boots",t.items.hazmatSuit){let r=e.items[41];r.menuName="Hazmat Suit",r.messageName="Hazmat Suit"}}for(let n=5;n<12;n+=2)e.items[n].menuName=e.items[n].menuName.replace("Ball","Orb"),e.items[n].messageName=e.items[n].messageName.replace("Ball","Orb")}function xl(s){let{flags:{BallOfWind:t,TornadoBracelet:e},npcs:{Tornel:n}}=s,r=n.localDialogs.get(33),i=[r[0],r[2],r[2].clone(),r[1]];i[1].condition=~e.id,i[2].condition=~t.id,i[3].condition=-1,n.localDialogs.set(33,i)}function bl(s){let{CordelPlainEast:t,KirisaMeadow:e,UndergroundChannel:n}=s.locations;for(let r of[t,e,n])for(let i of r.spawns)i.isChest()&&(i.data[2]|=32)}function yl(s){let{config:t,rom:e}=s,{CordelPlainEast:n,CordelPlainWest:r}=e.locations,i=t.glitches.teleportSkip===Kn;for(let o of n.spawns)(o.isChest()||i&&o.isTrigger())&&r.spawns.push(o.clone())}function Sl(s){for(let t of s.locations.MtSabreNorth_Main.spawns)t.isTrigger()&&t.id===134&&t.x===1856&&(t.x+=16,t.y+=16)}function wl(s){let t=s.hitboxes[s.objects.guardianStatueMissile.hitbox],e=s.hitboxes[6];s.objects.guardianStatueMissile.hitbox=e.id,e.x0=t.x0-6,e.w=t.w+12,e.y0=t.y0-2,e.h=t.h+4}function El(s){s.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function Tl(s){let{flags:{WarpZombie:t},locations:{ZombieTown:e}}=s;s.flags.insertZombieWarpFlag();let n=s.messages.parts[33][0];n.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let r=s.nextFreeTrigger("zombie warp");r.used=!0,r.conditions=[],r.message=zt.of({}),r.flags=[t.id];for(let i of e.spawns)i.isTrigger()&&i.id===138&&(i.id=r.id);if(s.townWarp.locations.splice(7,0,e.id),s.townWarp.locations.pop()!==255)throw new Error("unexpected")}function Cl(s){let{flags:{CurrentlyRidingDolphin:t},locations:{AngrySea:e,EvilSpiritIsland1:n}}=s;s.trigger(138).conditions=[~t.id],s.messages.parts[29][16].text=`This cave ceiling is too
low to fly in.`,Wi(e.spawns,r=>r.isTrigger()&&r.id===138),n.spawns.push(V.of({x:88,y:160,type:2,id:138}))}function Rl(s){let t=s.nextFreeTrigger("channel item");t.used=!0,t.conditions=[s.flags.CurrentlyRidingDolphin.id,~s.flags.UndergroundChannelUnderwaterChest.id];let e=s.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",t.message=zt.of({part:e.part,index:e.id,action:15});let n=s.locations.UndergroundChannel.spawns.find(r=>r.isChest());n.data[2]=2,n.yt++,n.id=t.id,s.itemGets.actionGrants.set(t.id,59)}function Ml(s){let e=s.npcs[13].localDialogs.get(53)[0];e.message.action=23}function Il(s){let{config:t,rom:e}=s,n=e.locations.LimeTreeLake,r=e.screens[e.metascreens.limeTreeLake.sid];if(t.glitches.rageSkip===Kn){r.set2d(32,r.get2d(0,143)),r.set2d(42,r.get2d(58,1)),r.set2d(16,r.get2d(32,4)),r.set2d(26,r.get2d(42,5)),r.set2d(27,r.get2d(0,16));for(let o of n.spawns)o.tile+=32;let i=e.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(o=>o+32)}else r.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function kl(s){let{config:t,rom:e}=s,{locations:{Brynmaer:n,Crypt_Draygon2:r,Joel_Shed:i,Leaf_ElderHouse:o,MtSabreNorth_SummitCave:a,MtSabreWest_Upper:l,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:d,Portoa_AsinaRoom:f,Portoa_FortuneTeller:u,Shyron_Temple:h,StomHouse:m,Swan_DanceHall:g,Swan_Tavern:x,WindmillCave:y,WaterfallCave4:p,WaterfallValleyNorth:w,ZebuCave:b,ZombieTown_HouseBasement:T},items:{GlowingLamp:C,KeyToPrison:I,LovePendant:S,StatueOfOnyx:O},npcs:{Akahana:L,AkahanaInBrynmaer:A,Asina:_,AztecaInShyron:X,Clark:se,Draygon:U,FortuneTeller:xe,Kensu:P,KensuInSwan:F,LeafElder:gt,LeafRabbit:De,OakChild:Z,OakElder:ke,OakMother:be,PortoaPalaceFrontGuard:ot,PortoaQueen:ue,PortoaThroneRoomBackDoorGuard:Pe,Rage:Ve,Stom:at,StonedAkahana:Jt,Tornel:Qn,WindmillGuard:At,Zebu:Qe},flags:W}=e;P.localDialogs.delete(x.id),F.link(P.id),F.used=!0,F.data=[...P.data],P.data[0]=C.id,g.spawns.find(ee=>ee.isNpc()&&ee.id===P.id).id=F.id,S.itemUseData[0].want=256|F.id,Jt.linkDialog(L.id),A.used=!0,A.link(L.id),A.data=[...L.data],n.spawns.find(ee=>ee.isNpc()&&ee.id===L.id).id=A.id,O.itemUseData[0].want=256|A.id,gt.dialog(o).splice(0,0,...gt.dialog(o).splice(2,1)),De.dialog()[2].condition=W.RescuedLeafElder.id,De.dialog()[2].flags.push(W.TalkedToLeafRabbit.id),De.dialog()[3].flags.push(W.TalkedToLeafRabbit.id),At.spawns(y)[1]=~W.WindmillGuardAlarmFluteTradein.id,_t(L.spawns(p),~W.BehindWhirlpool.id),_t(Jt.spawns(p),~W.BehindWhirlpool.id);function vt(ee){ee.reverse();for(let Oe=0;Oe<ee.length;Oe++){let bt=ee[Oe+1];ee[Oe].condition=bt?~bt.condition:-1}}for(let ee=0;ee<4;ee++){let Oe=ke.dialog()[ee];Oe.condition!==e.flags.OakElder.id&&(Oe.message.action=3)}(()=>{let[ee,Oe,bt,Xt]=be.dialog();Xt.condition=~W.RescuedChild.id,Oe.condition=-1,be.dialog().splice(0,4,Xt,bt,ee,Oe)})();for(let ee of[32,33,34,124,125])vt(e.npcs[ee].dialog());Z.dialog().unshift(...Z.dialog().splice(1,1)),Pe.spawnConditions.set(c.id,[~W.QueenNotInThroneRoom.id,~W.MesiaRecording.id]),ot.dialog()[1].condition=W.MesiaRecording.id,ue.dialog()[3].condition=W.SwordOfWater.id,ue.dialog()[3].message.action=3,ue.dialog()[4].flags.push(W.PortoaQueenGoingAway.id),ue.spawns(c)[1]=~W.MesiaRecording.id,ue.spawns(f)[0]=W.MesiaRecording.id,ue.dialog()[1].condition=W.MesiaRecording.id,xe.spawns(u)[1]=~W.MesiaRecording.id,se.spawnConditions.set(T.id,[~W.Clark.id]),se.spawnConditions.set(i.id,[W.Clark.id]),Qe.localDialogs.set(b.id,[Ke.of(~W.TalkedToZebuInCave.id,[0,26],[W.TalkedToZebuInCave.id]),Ke.of(W.LeafVillagersRescued.id,[0,29]),Ke.of(W.LeafAbduction.id,[0,28]),Ke.of(W.ZebuAtWindmill.id,[0,29]),Ke.of(W.UsedWindmillKey.id,[0,27,3]),Ke.of(-1,[0,29])]),_t(Qe.spawns(b),~W.BehindWhirlpool.id),Qn.spawnConditions.delete(l.id),at.spawnConditions.delete(m.id),_t(_.spawns(f),~W.CalmedAngrySea.id);let Ze=e.npcs[52];Ze.spawnConditions.set(c.id,[W.MesiaRecording.id,~W.PortoaQueen.id]),Ze.localDialogs.set(d.id,Ze.localDialogs.get(-1)),Ze.data[0]=e.items.FluteOfLime.id;let xt=e.messages.alloc();xt.text="The queen left this for you.",Ze.localDialogs.set(c.id,[Ke.of(~W.PortoaQueen.id,[xt.part,xt.id,3]),Ke.of(-1,[10,14])]),c.spawns.push(V.of({yt:3,xt:12,type:1,patternBank:1,id:Ze.id})),ue.localDialogs.set(f.id,ue.dialog().splice(0,2)),ue.localDialogs.set(c.id,ue.dialog()),ue.localDialogs.delete(-1),X.spawns(h).push(~W.ShyronMassacre.id),e.trigger(130).conditions.push(~W.ShyronMassacre.id),e.bossKills.kensuLighthouse.data2[0]=0,Ve.dialog()[0].condition=W.SwordOfWater.id,U.spawnConditions.set(r.id,[~W.Draygon2.id]),Qe.dialog(h).unshift(...Qe.dialog(h).splice(1,1)),e.trigger(128).conditions=[~W.ShyronMassacre.id,W.TalkedToZebuInShyron.id,W.SwordOfThunder.id],e.trigger(129).conditions=[],t.triggers.whirlpoolItemRequiresCalmSea&&e.trigger(132).conditions.push(W.CalmedAngrySea.id),e.trigger(140).conditions.push(W.TalkedToZebuInCave.id),e.trigger(141).used=!1;for(let ee of a.spawns)ee.isTrigger()&&ee.id===141&&(ee.id=178);Wi(w.spawns,ee=>ee.isTrigger()&&ee.id===141),e.trigger(178).conditions.push(W.Kelbesque1.id),e.trigger(178).flags.push(~W.LeafVillagersCurrentlyAbducted.id,~W.LeafElderCurrentlyAbducted.id,W.LeafVillagersRescued.id),e.trigger(140).conditions.push(~W.Kelbesque1.id),e.trigger(134).conditions.push(~W.Kelbesque1.id),_t(I.itemUseData[0].flags,~W.LeafVillagersCurrentlyAbducted.id),_t(I.itemUseData[0].flags,W.LeafVillagersRescued.id),zr(e.trigger(187).conditions,~W.Rage.id,~W.MesiaRecording.id)}function Ol(s){for(let t of[8,9,39])s.objects[t].collisionPlane=0}function _l(s){let{config:{items:{swordLevelForWalls:t}},rom:e}=s;if(t===1)for(let n of[16,20,24,29])e.objects[n].terrainSusceptibility&=-5,e.objects[n].level=2;else if(t===3)for(let n of[17,19,21,25,30])e.objects[n].level=1}function Al(s){let{rom:t,config:{triggers:{draygon2SpawnsWithoutBowOfTruth:e,draygon2PortalAtStart:n,draygon2RequiresAllBosses:r,draygon2RequiresAllSwords:i}}}=s,{flags:{Draygon1:o,Karmine:a,Kelbesque1:l,Kelbesque2:c,Mado1:d,Mado2:f,Sabera1:u,Sabera2:h,SwordOfFire:m,SwordOfThunder:g,SwordOfWater:x,SwordOfWind:y,UsedBowOfTruth:p},locations:{Crypt_Draygon2:w,MezameShrine:b},npcs:{Draygon:T}}=t,C;if(e){for(let S of b.spawns)S.isTrigger()&&S.tile===136&&(C=t.trigger(S.id));if(!C)throw new Error("Could not find start trigger");C.flags.push(p.id)}n&&(t.tileEffects[6].effects[88]=0,b.meta.setExit(0,"door",[w.meta.id<<8|16,"edge:bottom"]));let I=T.spawnConditions.get(w.id);r&&I.push(l.id,u.id,d.id,c.id,h.id,f.id,a.id,o.id),i&&I.push(y.id,m.id,x.id,g.id)}function vl(s){s.objects[51].elements=15}function Nl(s){if(!s.patterns.get(5312,21).pixels.every(d=>d===0))return;let e=4224,n=new Map([[28,21],[29,22],[30,23],[31,24],[58,25],[59,26],[60,27],[61,28],[62,29],[63,30]]);n.forEach((d,f)=>{s.patterns.set(5312,d,s.patterns.get(e,f).pixels)});let r=6912;[[3,28],[4,29],[5,30],[6,31],[51,58],[52,59],[53,60],[54,61],[55,62]].forEach(d=>{let f=s.patterns.get(r,d[0]).pixels;for(let u=0;u<5;++u)s.patterns.set(e+(u<<6),d[1],f)});let o=128;s.metasprites[170].sprites.forEach(d=>{d.forEach(f=>{f[0]!=o&&(f[3]=f[3]-131+64+28)})});let l=144;for(let d=0;d<s.metasprites[l].sprites.length;d++)for(let f=0;f<s.metasprites[l].sprites[d].length;f++){let u=s.metasprites[l].sprites[d][f];u[0]!=o&&(s.metasprites[l].sprites[d][f][3]=u[3]-179+58)}s.metasprites[203].sprites.forEach(d=>{for(let f=0;f<d.length;f++){let u=d[f];if(u[0]!=o){let h=n.get(u[3]&63);u[3]=64+h}}})}function Ll(s){s.tileEffects[2].effects[116]=6,s.tileEffects[3].effects[70]=6}function Gl(s){for(let t of s.objects)t instanceof et&&(t.isProjectile()||t.isBoss()||t.isFlyer()||t!==s.objects.mimic&&(t.terrainSusceptibility|=3))}function zr(s,t,e){for(let n=0;n<s.length;n++)if(s[n]===t){s[n]=e;return}throw new Error(`Could not find ${t} in ${s.join(",")}`)}function Fl(s){for(let t of s.locations)t.checkpoint=t.saveable=!1}function Dl(s){zr(s.wildWarp.locations,100,105)}function _t(s,t){let e=s.indexOf(t);if(e<0)throw new Error(`Could not find element ${t} in ${s}`);s.splice(e,1)}function Wi(s,t){let e=s.findIndex(t);if(e<0)throw new Error(`Could not find element in ${s}`);s.splice(e,1)}var Kn,Hi=v(()=>{wt();na();ra();or();ce();de();ar();sa();ce();$e();({FORBID:Kn}=R.GlitchMode)});function zi(s,t,e){if(!t.randomizeTrades())return;let{items:{StatueOfOnyx:n,FogLamp:r,LovePendant:i,KirisaPlant:o,IvoryStatue:a},locations:{Swan_DanceHall:l,PortoaPalace_ThroneRoom:c},npcs:{KensuInSwan:d}}=s,f=new Map,u=[[n,0,"Akahana"],[r,0,"Fisherman"],[i,0,"Kensu"],[o,0,"Aryllis"],[a,0,"Slimed Kensu"]],h=u.map(([x,y,p])=>{if(x.trades.indexOf(y)<0||y>=x.itemUseData.length)throw new Error(`not a trade: ${x} ${y}`);return[x.itemUseData[y],x.id,p]});e.shuffle(h);for(let[x,y]of u){let[p,w,b]=h.pop();x.itemUseData[y]=p,s.spoiler&&s.spoiler.addTrade(x.id,x.messageName,b),p.want===356&&t.fogLampNotRequired()&&([...s.npcs[100].spawnConditions.values()][0][0]=512|x.id),f.set(w,x.id)}s.itemGets.actionGrants=new Map([...s.itemGets.actionGrants].map(([x,y])=>[f.get(x)??x,y]));let m=s.items[e.nextInt(4)];s.npcs[195].localDialogs.get(-1)[0].condition=512|m.id,s.spoiler&&s.spoiler.addTrade(m.id,m.messageName,"Rage"),s.npcs.PortoaQueen.dialog(c)[1].condition=512|m.id;let g=s.items[e.nextInt(4)*2+6];for(let x of s.npcs[95].localDialogs.values())for(let y=2;y<x.length;y++)if(x[y].message.action===3){x[y-2].condition=~(512|g.id-1),x[y-1].condition=~(512|g.id),s.spoiler&&s.spoiler.addTrade(g.id,g.messageName,"Tornel");break}d.dialog(l)[0].message.mid="13:00"}function Ui(s){let t=new Map;for(let e of s.items)for(let n of e.trades)t.set(e.itemUseData[n].want&255,e.id);return t}var Ur=v(()=>{});function Vi(s){let{flags:{AkahanaStatueOfOnyxTradein:t,AsinaInBackRoom:e,BehindWhirlpool:n,KensuInSwan:r,MtSabreNorthSummit:i,MtSabreWestTornel:o,PortoaQueen:a,Rage:l,RepairedStatue:c,SlimedKensu:d,StomFightReward:f,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:h},npcs:{AkahanaInBrynmaer:m,Aryllis:g,Fisherman:x,PortoaQueen:y},locations:{PortoaPalace_ThroneRoom:p}}=s;F("03:06",",",""),F("17:0c","the worst","the best");let w=Ui(s);function b(Z){let ke=w.get(Z.id);if(!ke)throw new Error(`No trade-in for ${Z.name}`);return s.items[ke]}h.item.isMagic()||xe("00:1b"),F("00:1b","[41:Refresh]",P(h.item));let T=b(m);F("02:01","an unusual statue",qi(T)),F("02:02","a statue",`the ${$n(T)}`),F("02:02","[29:Gas Mask]",P(t)),f.item.isMagic()||xe("03:01"),F("03:01","[43:Telepathy]",P(f));let C=Wl(s);F("03:01","[06:Tornado Bracelet]",P(C)),F("05:0a","[06:Tornado Bracelet]",P(C)),F("05:0a","[44:Teleport]",P(o));let I=b(x);F("09:01","[35:Fog Lamp]",P(I)),F("09:04","[35:Fog Lamp]",P(I)),F("09:05","[35:Fog Lamp]",P(I)),F("09:06","lamp",$n(I));let S=y.dialog(p)[1].condition;F("0a:0c","[28:Flute of Lime]",P(a)),F("0a:0d","[02:Sword of Water]",P(S)),e.item.isMagic()||xe("0b:01"),F("0b:01","[45:Recover]",P(e)),n.item.isMagic()||(xe("0b:01"),xe("1d:12")),F("0b:01","[46:Barrier]",P(n)),F("1d:12","[46:Barrier]",P(n));let O=gt(79,78,77,76,71,70,69,68,75,74,73,72);O?F("0d:00","[35:Fog Lamp]",P(O)):F("0d:00","that a [35:Fog Lamp] was","there was treasure");let L=s.npcs.Rage.dialog()[0].condition;F("0e:03","[02:Sword of Water]",P(L)),F("0e:03","[09:Ball of Water]",P(l)),F("10:0c","that's","is"),F("10:0c",/, is in the\+lighthouse/,"");let A=b(g);F("12:05","[3c:Kirisa Plant]",P(A)),F("12:10","the plant",`the ${$n(A)}`),F("12:10","[3c:Kirisa Plant]",P(A));let _=`Our illustrious chief seeks ${qi(A)}.`;F("12:09",/[^]*/,_),F("12:0a",/[^]*/,_);let X=b(s.npcs.KensuInSwan);F("13:02","[3b:Love Pendant]",P(X)),F("13:00","pendant",$n(X)),r.item.isMagic()||xe("13:02"),F("13:02","[47:Change]",P(r));let se=b(s.npcs.SlimedKensu);F("18:06","[3d:Ivory Statue]",P(se)),F("18:07","[3d:Ivory Statue]",P(se)),F("18:06","It's in a room","{0b:Karmine} is"),d.item.isMagic()||F("18:07","teach","give"),F("18:07","[48:Flight]",P(d)),i.item.isMagic()||xe("1c:10"),F("1c:10","[42:Paralysis]",P(i)),F("20:06","Statue of Gold",P(c));let U=s.allocatedTriggers.get("channel item");U!=null&&F(s.trigger(U).message.mid,"[3b:Love Pendant]",P(u));{let Z=s.messages.alloc();s.trigger(134).message.mid=Z.mid,Z.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",s.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function xe(Z){F(Z,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function P(Z){return typeof Z=="number"?Z=s.items[s.itemGets[Z&255].itemId]:Z instanceof ys||(Z=Z.item),`[${re(Z.id)}:${Z.messageName}]`}function F(Z,ke,be){let[ot,ue]=Z.split(":").map(Ve=>parseInt(Ve,16)),Pe=s.messages.parts[ot][ue];Pe.text=Pe.text.replace(ke,be)}function gt(...Z){let ke=[be=>Pl.has(be),be=>Bl.has(be),be=>De(be).unique];for(let be of ke)for(let ot of Z){let Pe=[...s.locations[ot].spawns].reverse();for(let Ve of Pe){if(!Ve.isChest())continue;let at=s.slots[Ve.id];if(at<=72&&be(at))return s.items[at]}}}function De(Z){let ke=s.itemGets[Z];return s.items[ke.itemId]}}function Wl(s){let{Tornel:t}=s.npcs;for(let e of t.localDialogs.values())for(let n=2;n<e.length;n++){let r=~e[n].condition;if(r>516&&r<=524&&!(r&1))return s.items[r&255]}return s.items.TornadoBracelet}function qi(s){let t=s.rom.items;switch(s){case t.StatueOfOnyx:return"an unusual statue";case t.FluteOfLime:return"a rare instrument";case t.FogLamp:return"a brilliant lamp";case t.LovePendant:return"a beautiful charm";case t.KirisaPlant:return"a fragrant plant";case t.IvoryStatue:return"an exotic statue"}return ir(),"a valuable item"}function $n(s){let t=s.rom.items;switch(s){case t.StatueOfOnyx:return"statue";case t.FluteOfLime:return"instrument";case t.FogLamp:return"lamp";case t.LovePendant:return"pendant";case t.KirisaPlant:return"plant";case t.IvoryStatue:return"statue"}return ir(),"item"}var Pl,Bl,Ki=v(()=>{ia();ce();Ur();tn();Pl=new Set([62,63,64]),Bl=new Set([0,1,2,3,65,66,67,68,69,70,71,72])});function ji(s){let{locations:{Portoa:t,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:n,UndergroundChannel:r,WaterfallCave2:i,WaterfallCave3:o}}=s;qr(n,"edge:bottom",183,t),qr(e,"door",146,r),qr(i,"stair:up",191,o),zl(s)}function qr(s,t,e,n){let[r,...i]=[...s.meta.exits()].filter(([,x])=>x===t);if(!r)throw new Error(`Could not find ${t} in ${s}`);if(i.length)throw new Error(`Ambiguous ${t} in ${s}`);let[o,a]=r[2],l=o>>>8;if(l===n.id)return;let c=o&255,d=s.rom.locations[l],u=d.meta.get(c).data.exits.find(x=>x.type===a);if(!u)throw new Error(`Bad entrance in ${d}`);let h=((u.entrance&61440)>>>8|(u.entrance&240)>>>4)+Hl[u.dir];d.spawns.length>17&&d.spawns.pop();let m=n.spawns.findIndex(x=>x.isTrigger()&&x.id===e),g=m>=0?n.spawns.splice(m,1)[0]:V.of({type:2,id:e});g.xt=(c&15)<<4|h&15,g.yt=c&240|h>>>4,d.spawns.push(g)}function zl(s){let{locations:{MtSabreNorth_Main:t,ValleyOfWind:e}}=s;for(let n of $i(e,17)){let r=s.locations[n>>>8],i=n&255;jn(r,i,s.flags.OpenedSealedCave)}for(let n of $i(t,4)){let r=s.locations[n>>>8];if(r.data.fixed||r.spawns.length>15)continue;let i=n&255;jn(r,i,s.flags.OpenedPrison);let o=r.meta.get(i).findExitByType("cave").entrance,a=V.of({screen:i,coord:o,type:2,id:173});if(r.spawns.push(a),r.spawns.length>15)continue;let l=V.of({screen:i,coord:o-4112,type:4,id:44});r.spawns.splice(1,0,l)}}function $i(s,t){let e=new Set([s,s.id<<8|t]),n=new Set;for(let i of s.meta.exits())i[0]===t&&(i[1]==="cave"||i[1]==="gate")&&n.add(i[2]);let r=[];for(let i of n){if(e.has(i[0]))continue;let o=s.rom.locations[i[0]>>>8],a=i[0]&255;if(!o.meta.customFlags.has(a)){if(i[1]==="cave"||i[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?r.push(i[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||n.add(l[2])}}}return r}function jn(s,t,e,n){e?s.meta.customFlags.set(t,e):s.meta.customFlags.delete(t),!n&&(s===s.rom.locations.CordelPlainEast?jn(s.rom.locations.CordelPlainWest,t,e,!0):s===s.rom.locations.CordelPlainWest&&jn(s.rom.locations.CordelPlainEast,t,e,!0))}var Hl,Yi=v(()=>{wt();Hl=[16,0,0,0]});function Ji(s){Ul(s)}function Ul(s){let{locations:{AngrySea:t},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:n,beachCave:r,beachExitN:i,boatChannel:o}}=s;e.spawnScripts=[];let a=new Set(ae(16,l=>l));for(let l=0;l<t.entrances.length;l++){let c=t.entrances[l],d=t.meta.get(c.screen),f;if(d===o){if(t.meta.get(c.screen-1)!==n)throw new Error(`Bad boatChannel entrance ${c}`);c=lt.of({screen:c.screen-1,tile:0}),d=n}d===n?f={entrance:lt.of({screen:c.screen-17,coord:47336}),movement:5}:d===r?f={entrance:lt.of({screen:c.screen,coord:59400}),movement:8}:d===i&&(f={entrance:lt.of({screen:c.screen,coord:55544}),movement:9}),f&&(a.delete(l),e.spawnScripts[l]=f)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:lt.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:lt.of({x:424,y:120}),movement:7}}var Xi=v(()=>{wt();ce()});function Zi(s){let t=new Set;for(let e of s.locations)for(let n of e.pits??[])t.add(n.dest<<8|n.toScreen);for(let e of t){let n=s.locations[e>>8],r=e&255,i=n.exits.filter(d=>d.screen===r),o=n.entrances.filter(d=>d.screen===r),a=new Map(i.map(d=>[d.tile,d])),l=new _e;for(let d of a.keys())for(let f of Qi)a.has(d+f)&&l.union([d,d+f]);let c=l.map();for(let d of o)for(let f of Qi){let u=c.get(d.tile+f);for(let h of u??[]){let m=a.get(h),g=xs.of({screen:e&255,tile:h+f,dest:m.dest,entrance:m.entrance});n.exits.push(g)}}}}var Qi,eo=v(()=>{St();wt();Qi=[1,-1,16,-16]});function to(s){let{Triggers:{ThunderSwordWarp:t,ThunderSwordWarpItem:e}}=R,{config:{triggers:{thunderSwordWarp:n,thunderSwordWarpItem:r,thunderSwordWarpItemFixed:i}},random:o,rom:a}=s;if(n===t.NONE){Vl(s);return}let[l,c]=n===t.FIXED?Kl(s):$l(s);a.townWarp.thunderSwordWarp=ql(s,l);let d;if(r===e.FIXED)d=i;else if(r===e.RANDOM)d=o.pick([...a.itemGets]).id;else if(r===e.SWORD)d=o.nextInt(4);else if(r===e.UNIQUE)d=o.pick([...a.items].filter(u=>u.unique)).id;else throw new Error(`Unknown thunderSwordWarpItem ${r}`);d!==a.items.SwordOfThunder.id&&a.messages.parts[28][17].text.replace("Sword of Thunder",a.items[a.itemGets[d].itemId].messageName);let f=a.itemGets[d];c!=null&&f.flags.push(c),f.acquisitionAction.action=1}function ql(s,t){let{rom:{locations:{Shyron_Temple:e,Shyron:n}}}=s;return t===e.id?[t,65]:t===n.id?[t,65]:[t,64]}function Vl(s){let{rom:t}=s;t.itemGets[3].acquisitionAction.action=22}function Kl(s){let{rom:t,config:{triggers:{thunderSwordWarpLocation:e}}}=s,n=[...t.townWarp.locations].filter(i=>i!==255),r=n.indexOf(e);return r<0?[e]:[e,768-n.length+r]}function $l(s){let{rom:t,random:e}=s,n=[...t.townWarp.locations].filter(a=>a!==255),r=e.nextInt(n.length),i=n[r],o=768-n.length+r;return[i,o]}var no=v(()=>{$e()});function ro(s){let{config:t,random:e,rom:n}=s,r=new Set(ae(256,m=>m).filter(m=>m in n.objects));for(let[m]of it)r.delete(m);for(let[m,g]of it)for(let x of r)n.objects[m].base===n.objects[x].base&&(it.set(x,g),r.delete(m));for(let m of[200,249,250])n.objects[m].attackType=m>240?254:255,n.objects[m].statusEffect=0;n.objects[125].elements|=8;let i=new Set([n.objects.kelbesque1.id,n.objects.sabera1.id,n.objects.mado1.id,n.objects.kelbesque2.id,n.objects.sabera2.id,n.objects.mado2.id,n.objects.karmine.id]),o=new Set([n.objects.draygon1.id,n.objects.draygon2.id]),a=new Set([n.objects.brownRobot.id,n.objects.whiteRobot.id]),l=new Set([n.objects.blueSlime.id,n.objects.redSlime.id,n.objects.largeBlueSlime.id,n.objects.largeRedSlime.id]),c=[],d=t.enemies.enemyWeaknesses===R.Randomization.RANDOM?void 0:[],f=t.enemies.tetrarchWeaknesses===R.Randomization.RANDOM?void 0:[];for(let m of it.keys()){if(o.has(m)||a.has(m))continue;let g=i.has(m),x=n.objects[m].elements,y=g?f:d;if(!y)continue;let p=0;for(let w=8;w;w>>>=1)x&w&&(y.push(w),p++);g||c?.push(p)}e.shuffle(c),d&&e.shuffle(d),f&&e.shuffle(f);function u(m){if(d){m??=e.nextInt(4);let g=0,x=[];for(;m;){let y=d.pop()??1<<e.nextInt(4);y&g?x.push(y):g|=y,m--}return d.splice(0,0,...x),g}else{if(!m)return e.nextInt(14)+1;let g=[1,2,4,8],x=0;for(let y=0;y<m;y++){let p=e.nextInt(g.length);x|=g.splice(p,1)[0]}return x}}function h(m){return[...m.toString(2)].filter(g=>g==="1").length}for(let[m,{sdef:g,swrd:x,hits:y,satk:p,dgld:w,sexp:b}]of it){let T=n.objects[m].data,C=i.has(m),I=o.has(m),S=a.has(m),O=I?t.enemies.allowDraygonImmunity:S?t.enemies.allowRobotImmunity:t.enemies.enemyWeaknesses===R.Randomization.RANDOM,L=C?t.enemies.tetrarchWeaknesses!==R.Randomization.VANILLA:l.has(m)&&t.enemies.enemyWeaknesses!==R.Randomization.VANILLA;if(T[2]|=128,T[6]=y,T[7]=p,T[8]=g|x<<4,T[16]=T[16]&15|w<<4,T[17]=b,L){let A;if(C)A=f?.pop()??1<<e.nextInt(4);else{let _=O?c.pop():h(n.objects[m].elements);A=u(_)}n.objects[m].elements=A}}if(t.enemies.enemyWeaknesses!==R.Randomization.VANILLA){let m=e.nextInt(4);for(let g of l)n.objects[g].elements=1<<m}}var it,Vr=v(()=>{$e();ce();it=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([s,t,e,n=0,r=0,i=0,o=0,a=0,l=0])=>[s,{id:s,type:t,name:e,sdef:n,swrd:r,hits:i,satk:o,dgld:a,sexp:l}]))});function jl(s){let t=s[0];t.set2d(113,[[t.rom.metascreens.deadEndE_upStair],[t.rom.metascreens.caveEmpty]]),t.moveExits([129,"stair:down",113,"stair:up"]),s[1]=113,s[2]="stair:up"}function Yl(s,t){let e=s[0],n=e.rom.metascreens;e.set2d(32,[[n.caveEmpty,n.hallNS],[n.deadEndE_upStair,n.hallNW]]),e.replaceMonsters(t),e.moveExits([48,"stair:down",48,"stair:up"]),s[2]="stair:up"}function Jl(s){let t=s[0],e=t.rom.metascreens;t.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),t.moveExits([2,"stair:down",1,"stair:up"]),s[1]=1,s[2]="stair:up"}function Kr(s){let t=s[0],e=t.rom.metascreens;t.width<2&&(t.width=2),t.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),t.moveExits([0,"stair:up",1,"stair:down"]),s[1]=1,s[2]="stair:down"}function $r(s,t){s[3](s,t),s[3]=void 0}function so(s,t){let e=s.locations,n=[0,1,2,3];t.shuffle(n);let r=[[e.GoaFortress_Kelbesque.meta,131,"stair:down"],[e.GoaFortress_Sabera.meta,129,"stair:down",jl],[e.GoaFortress_Mado1.meta,114,"stair:down"],[e.GoaFortress_Karmine1.meta,48,"stair:down",Yl]],i=[[e.GoaFortress_Zebu.meta,0,"stair:up",Kr],[e.GoaFortress_Tornel.meta,0,"stair:up",Kr],[e.GoaFortress_Asina.meta,0,"stair:up",Kr],[e.GoaFortress_Kensu.meta,2,"stair:down",Jl]],o=[[e.GoaFortress_Entrance.meta,0,"edge:top"]],a=[],l=!0,c=o[0];for(let d of n){let u=l||r[d][3]||o[o.length-1][3]?t.pick([!1,!0]):!0,h=u?i[d]:r[d];a.push(h),l!==(h[2]==="stair:down")&&(h[3]?$r(h,t):$r(c,t)),o.push(c=u?r[d]:i[d]),l=c[2]==="stair:up"}l&&$r(c,t),a.push([e.GoaFortress_Exit.meta,1,"stair:up"]);for(let d=0;d<o.length;d++)o[d][0].attach(o[d][1],a[d][0],a[d][1],o[d][2],a[d][2])}var io=v(()=>{});function ao(s,t,e){let{locations:{Crypt_Hall1:n,Goa:r,GoaFortress_Exit:i,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:c}}=s,d=new Set([r.id,o.id]),f=new Set([a.data.id,l.data.id,c.data.id]);if(t.shuffleAreas())for(let w of[r,i,o,n])w.data.houseType="palace";let u=new H(()=>[]),h=new H(()=>[]),m=new H(()=>new Set);for(let w of s.locations){if(!w.used||w.data.houseType==null)continue;let b;for(let[T,C,I]of w.meta.exits()){let S=(T&240)<<4|w.meta.get(T).findExitByType(C).entrance>>>8;(!b||S>b[3])&&(b=[T,C,I,S])}for(let[T,C,I]of[b]){let S={type:w.data.houseType,inside:[w.id<<8|T,C],outside:I},O=I[0];h.get(O).push(S),u.get(w.data.houseType).push(S);let L=s.locations[O>>>8].screens[O>>>4&15][O&15];m.get(L).add(O)}}let g=new Map,x=new Map;for(let[w,b]of e.ishuffle(m))b.size>=2||f.has(w)?x.set(w,b):g.set(w,b);let y=new Set,p=u.get("inn");for(let[,w]of[...x,...g]){let b=new Map,T=!0;for(let C of w){for(let I of h.get(C)){let S=T&&oo.has(I.type)?[...oo].map(P=>u.get(P)):[u.get(b.get(I.outside[1])??I.type)];S=S.filter(P=>P.length),I.type==="palace"&&d.has(I.outside[0]>>>8)&&(S=S.map(P=>P.filter(F=>!d.has(F.inside[0]>>>8))));let O=[...w].every(P=>!y.has(P>>>8));!O&&S.length>1?S=S.filter(P=>P!==p):O&&S.some(P=>P===p)&&(S=[p]);let L=e.pickAndRemove(...S);if(L.type==="inn")for(let P of w)y.add(P>>>8);if(b.set(I.outside[1],L.type),s.spoiler&&s.spoiler.addHouse(L.inside[0]>>>8,I.outside[0]>>>8),Ae.connect(s,I.outside,L.inside),!T||jr.get(I.type)===jr.get(L.type))continue;let A=s.locations[I.outside[0]>>>8];if(A.meta.tileset!==s.metatilesets.town)continue;let _=Ae.findExitTiles(s,I.outside);if(_.length>1)continue;let X=_[0]-32;(_[0]&240)<32&&(X-=3856);let se=X>>8,U=X&255,xe=jr.get(L.type)??(A.meta.get(se).data.tallHouses?.includes(U)?Ql:Xl);s.screens[A.screens[se>>4][se&15]].tiles[U]=xe}T=!1}}}var Xl,Ql,jr,Zl,oo,lo=v(()=>{nn();de();Xl=6,Ql=33,jr=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),Zl=new Set(["inn","armor","tool","pawn"]),oo=new Set([...Zl,"house","tavern"])});function co(s,t,e){let n=[],r=[];for(let i of s.locations)for(let o of i.spawns)if(o.isChest()){let a=s.slots[o.id];if(a>=112&&r.push(o.id),t.preserveUniqueChecks()){let l=s.itemGets[a];if(s.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;n.push(o.id)}e.shuffle(n),s.slots.setMimicCount(r.length),[...le.zip(r,n,(i,o)=>s.slots.swap(i,o))]}var fo=v(()=>{de()});function uo(s,t){for(let e of s.locations)(e.id&248)!==88&&e.meta.replaceMonsters(t)}var ho=v(()=>{});function*Yr(s,t){yield t;let e=t.spawnedReplacement();e&&(yield*Yr(s,e));let n=t.spawnedChild();n&&(yield*Yr(s,n)),t.id===80&&(yield s.objects.largeBlueSlime),t.id===83&&(yield s.objects.largeRedSlime)}var Yn,mo=v(()=>{de();gs();Yn=class{constructor(t){this.rom=t;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new H(()=>[]);for(let n of t.locations)if(n.used)for(let r=0;r<n.spawns.length;r++){let i=n.spawns[r];i.used&&(i.isMonster()?e.get(i.monsterId).push([n,r,i]):(i.isNpc()||i.isBoss())&&e.get(~i.id).push([n,r,i]))}for(let[n,r]of e)if(n<0){let i=t.npcs[~n],o=[i.data[3]];if(!t.metasprites[o[0]])throw new Error(`bad NPC: ${~n}`);i.data[2]===208&&o.push(192);let l=i.data[2]<128?i.data[2]&112:0,c=this.computeConstraint(o,r,!0,l);~n===95&&(c=c.ignorePalette()),this.npcConstraints.set(~n,c)}else{let i=Ce.ALL,o=this.rom.objects[n];for(let a of Yr(t,o)){let c=t.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(c(a),r,a.id===n,a.data[1]),f=i.meet(d);if(!f)throw new Error(`Bad meet for ${n} with ${a.id}`);if(f&&(i=f),a.data[4]&2){let u=this.computeConstraint([a.data[20]],r,!1,a.data[1]),h=i.meet(u);if(!h)throw new Error(`Bad meet for ${n} bonus ${a.id}`);i=h}}this.monsterConstraints.set(o.id,i),o.constraint=i}}getMonsterConstraint(t,e){let n=this.monsterConstraints.get(e)||Ce.NONE;return(t&88)===88||!this.rom.objects[e].goldDrop?n:n.meet(Ce.COIN)||Ce.NONE}getNpcConstraint(t,e){let n=this.npcConstraints.get(e)||Ce.NONE;return t===30&&e===96?n.meet(Ce.STOM_FIGHT):t===160&&e===201?n.meet(Ce.GUARDIAN_STATUE):n}shufflePalettes(t){let e=[...this.allSpritePalettes];for(let[n,r]of this.monsterConstraints)this.monsterConstraints.set(n,r.shufflePalette(t,e));for(let[n,r]of this.npcConstraints)this.npcConstraints.set(n,r.shufflePalette(t,e))}configure(t,e){if(!e.used)return;let n=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):void 0;if(e.isChest()&&(e.patternBank=0),!!n){if(n.shift===3||n.float.length>=2)throw new Error("don't know what to do with two floats");if(!n.float.length)e.patternBank=+(n.shift===2);else if(n.float[0].has(t.spritePatterns[0]))e.patternBank=0;else if(n.float[0].has(t.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(t,e,n,r=0){let i=new Set,o=new Set;for(let c of t.map(d=>this.rom.metasprites[d])){for(let d of c.palettes())o.add(d);for(let d of c.patternBanks(r))i.add(d)}n=n&&i.size==1&&[...i][0]===2;let a=new Map;for(let[c,,d]of e)a.set(d.patternBank&&n?~c.id:c.id,d);let l;for(let[c,d]of a){let f=this.rom.locations[c<0?~c:c];for(let h of o)h>1&&this.allSpritePalettes.add(f.spritePalettes[h-2]);let u=Ce.fromSpawn(o,i,f,d,n);l=l?l.join(u):u,!n&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}}});function go(s,t,e){let n=new Yn(s);t.shuffleSpritePalettes()&&n.shufflePalettes(e);let r={},i=new Xr(t,r);for(let o of s.locations)o.used&&i.populate(o);i.shuffle(e,n)}var Xr,Jr,ed,po,xo=v(()=>{gs();mo();ar();Vr();Xr=class{constructor(t,e){this.flags=t;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(t){let{maxFlyers:e=0,nonFlyers:n={},skip:r=!1,tower:i=!1,fixedSlots:o={},...a}=po[t.id]||{};for(let u of Object.keys(a))throw new Error(`Unexpected property '${u}' in MONSTER_ADJUSTMENTS[${t.id}]`);let l=r===!0||!this.flags.shuffleTowerMonsters()&&i||!t.spritePatterns||!t.spritePalettes,c=[],d=[],f=12;for(let u of l?[]:t.spawns){if(++f,!u.used||!u.isMonster())continue;let h=u.monsterId;if(!it.has(h)||it.get(h).type!=="m")continue;let m=t.rom.objects[h];if(!(m instanceof et))continue;let g=u.patternBank,x=t.spritePatterns[g],y=m.palettes(!0),p=y.includes(2)?t.spritePalettes[0]:void 0,w=y.includes(3)?t.spritePalettes[1]:void 0;c.push({id:h,pat:x,pal2:p,pal3:w,patBank:g}),(this.report[`start-${h.toString(16)}`]=this.report[`start-${h.toString(16)}`]||[]).push("$"+t.id.toString(16)),d.push(f)}(!c.length||r)&&(d=[]),this.locations.push({location:t,slots:d}),this.monsters.push(...c)}shuffle(t,e){let n=e.rom;for(this.report["pre-shuffle locations"]=this.locations.map(r=>r.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(r=>r.id),t.shuffle(this.locations),t.shuffle(this.monsters),this.report["post-shuffle locations"]=this.locations.map(r=>r.location.id),this.report["post-shuffle monsters"]=this.monsters.map(r=>r.id);this.locations.length;){let{location:r,slots:i}=this.locations.pop(),o=this.report["$"+r.id.toString(16).padStart(2,"0")]=[],{maxFlyers:a=0,nonFlyers:l={},tower:c=!1}=po[r.id]||{};if(c)continue;let d=a,f=Ce.forLocation(r.id);r.bossId()!=null;for(let g of r.spawns)if(!(g.isChest()&&!g.isInvisible()))if(g.isNpc()||g.isBoss()){let x=e.getNpcConstraint(r.id,g.id);f=f.meet(x,!0),g.isNpc()&&(g.id===107||g.id===104)&&(f=f.meet(Ce.KENSU_CHEST,!0))}else if(g.isMonster()&&!(n.objects[g.monsterId]instanceof et)){let x=e.getMonsterConstraint(r.id,g.monsterId);f=f.meet(x,!0)}else g.isShootingWall(r)&&(f=f.meet(Ce.SHOOTING_WALL,!0));o.push(`Initial pass: ${f.fixed.map(g=>g.size<1/0?"["+[...g].join(", ")+"]":"all")}`);let u=new Map,h=g=>{let x=n.objects[g.id];if(x.monsterClass){let O=u.get(x.monsterClass);if(O!=null&&O!==g.id)return!1}let y=Jr.has(g.id),p=ed.has(g.id);if(y){if(!d)return!1;--d}let w=e.getMonsterConstraint(r.id,g.id),b=f.tryMeet(w);if(!b&&f.pal2.size<1/0&&f.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(b=f.tryMeet(w,!0)),!b)return!1;let T;if(m){let O=n.objects[g.id];if(!(O instanceof et))throw new Error(`non-monster: ${O}`);if(T=m(O),T==null)return!1}o.push(`  Adding ${g.id.toString(16)}: ${JSON.stringify(b)}`),f=b,x.monsterClass&&u.set(x.monsterClass,g.id);let C=0;if(y||p){for(let O=0;O<i.length;O++)if(i[O]in l){C=O;break}}else for(let O=0;O<i.length;O++)if(!(i[O]in l)){C=O;break}(this.report[`mon-${g.id.toString(16)}`]=this.report[`mon-${g.id.toString(16)}`]||[]).push("$"+r.id.toString(16));let I=i[C],S=r.spawns[I-13];return y?(S.data[0]=253,S.data[1]=255):m?(S.screen=T>>>8,S.tile=T&255):I in l&&(S.y+=l[I][0]*16,S.x+=l[I][1]*16),S.monsterId=g.id,o.push(`    slot ${I.toString(16)}: ${S}`),i.splice(C,1),!0},m=r.monstersMoved||i.length&&this.flags.randomizeMaps()?r.monsterPlacer(t):null;if(d&&i.length)for(let g=0;g<Math.min(40,this.monsters.length);g++)Jr.has(this.monsters[g].id)&&h(this.monsters[g])&&this.monsters.splice(g,1);for(let g=0;g<this.monsters.length&&i.length;g++)if(h(this.monsters[g])){let[x]=this.monsters.splice(g,1);Jr.has(x.id)||this.used.push(x),g--}for(let g=0;g<this.used.length&&i.length;g++)h(this.used[g])&&(this.used.push(...this.used.splice(g,1)),g--);if(f.fix(r,t),i.length){console.error(`Failed to fill location ${r.id.toString(16)} ${r.name}: ${i.length} remaining`);for(let g of i){let x=r.spawns[g-13];x.x=x.y=0,x.id=176,x.data[0]=254}}for(let g of r.spawns)e.configure(r,g)}}},Jr=new Set([89,92,110,111,129,138,163,196]),ed=new Set([85,93,124,188,193]),po={3:{fixedSlots:{pat1:96},maxFlyers:2},7:{nonFlyers:{15:[0,-3],16:[-10,0],17:[0,4]}},20:{maxFlyers:2},21:{maxFlyers:2},26:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{16:[4,0],17:[5,0],18:[4,0],19:[5,0],20:[4,0],21:[4,0]}},27:{skip:!0},32:{maxFlyers:1},33:{fixedSlots:{pat1:80},maxFlyers:1},39:{nonFlyers:{13:[0,16]}},40:{maxFlyers:1},41:{maxFlyers:1},43:{nonFlyers:{20:[32,-8]}},64:{maxFlyers:2,nonFlyers:{19:[12,-16]}},65:{maxFlyers:2,nonFlyers:{21:[0,-6]}},66:{maxFlyers:2,nonFlyers:{13:[0,8],14:[-8,8]}},71:{maxFlyers:1,nonFlyers:{13:[-8,-8]}},74:{maxFlyers:1,nonFlyers:{14:[4,0],15:[0,-3],16:[0,4]}},76:{},77:{maxFlyers:1},78:{maxFlyers:1},79:{},87:{fixedSlots:{pat1:77}},89:{tower:!0},90:{tower:!0},91:{tower:!0},96:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},100:{fixedSlots:{pal3:8,pat1:82},skip:!0},104:{fixedSlots:{pal3:8,pat1:82},skip:!0},105:{maxFlyers:1,nonFlyers:{23:[4,6]}},106:{maxFlyers:1,nonFlyers:{21:[0,24]}},108:{maxFlyers:1,nonFlyers:{23:[0,24]}},109:{maxFlyers:1,nonFlyers:{17:[16,0],27:[0,0],28:[6,0]}},120:{maxFlyers:1,nonFlyers:{22:[-8,-8]}},124:{maxFlyers:1,nonFlyers:{21:[-39,84]}},132:{nonFlyers:{18:[0,-4],19:[0,4],20:[-6,0],21:[14,12]}},136:{maxFlyers:1},137:{maxFlyers:1},138:{maxFlyers:1,nonFlyers:{13:[7,0],14:[0,0],15:[7,3],16:[0,6],17:[11,-16]}},143:{skip:!0},144:{maxFlyers:2,nonFlyers:{20:[-11,-3],21:[0,16]}},145:{maxFlyers:2,nonFlyers:{24:[0,14],25:[4,-16]}},152:{maxFlyers:2,nonFlyers:{20:[-6,6],21:[0,-16]}},158:{maxFlyers:2},162:{maxFlyers:1,nonFlyers:{18:[0,11],19:[6,0]}},165:{nonFlyers:{23:[6,6],24:[-6,0],25:[-1,-7]}},166:{skip:!0},168:{skip:!0},169:{maxFlyers:2,nonFlyers:{22:[26,-16],23:[0,32]}},171:{maxFlyers:2,nonFlyers:{13:[1,0],14:[2,-2]}},173:{maxFlyers:2,nonFlyers:{24:[0,8],25:[0,-8]}},175:{nonFlyers:{13:[0,0],14:[0,0],19:[59,-38]}},180:{maxFlyers:2,nonFlyers:{17:[6,0],18:[0,6]}},215:{skip:!0}}});function Zr(s,t,e){new Qr(s,t,e).shuffle()}var Qr,bo=v(()=>{de();Qr=class{constructor(t,e,n){this.rom=t;this.flags=e;this.random=n}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let t=new H(()=>[]);for(let n of this.rom.locations)n.tilePalettes.some(r=>r!==154)&&t.get(n.colorGroup).push(n);let e=[new Map,new Map];for(let n of t.values())for(let r of n)for(let i=0;i<2;i++)for(let o=0;o<2;o++){let a=e[i].get(r.tilePatterns[o]);a||e[i].set(r.tilePatterns[o],a=new Set),a.add(r.tilePalettes[i])}for(let n of t.values()){let r=n[0],i=[new Set,new Set];for(let l=0;l<2;l++)i[l]=new Set([...e[l].get(r.tilePatterns[0]),...e[l].get(r.tilePatterns[1])]);let o=this.random.pick([...i[0]]),a=this.random.pick([...i[1]]);for(let l of n)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}}});function Yt(s,t){t.eastCave?td(s,t.eastCave):t.classicLimeTreeToLeaf&&nd(s),rd(s),sd(s),ad(s),ld(s),id(s)}function td(s,t){let{locations:{EastCave1:e,EastCave2:n,EastCave3:r,SealedCave1:i,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:c,branchNWSE:d,branchNWS:f,branchWSE:u,caveEmpty:h,deadEndE:m,deadEndE_downStair:g,deadEndE_upStair:x,deadEndN_stairs:y,deadEndS:p,deadEndS_stairs:w,deadEndW:b,deadEndW_downStair:T,hallNE:C,hallNS:I,hallNW:S,hallSE:O,hallWS:L,hallWE:A,hallNS_entrance:_,hallNS_ramp:X,hallNS_wall:se}}=s;s.locations.allocate(e),s.locations.allocate(n),t.exit2&&s.locations.allocate(r);for(let U of[e,n,r])U.bgm=U.originalBgm=23,U.entrances=[],U.exits=[],U.pits=[],U.spawns=[],U.flags=[],U.width=U.height=1,U.screens=[[128]],U.tilePalettes=[26,27,5],U.originalTilePalettes=[26,27,5],U.tileset=136,U.tileEffects=181,U.tilePatterns=[20,2],U.spritePatterns=[...i.spritePatterns],U.spritePalettes=[...i.spritePalettes];e.meta=new Ae(e.id,s.metatilesets.cave,5,5),e.meta.set2d(0,[[m,L,h,O,b],[h,I,O,S,h],[O,d,f,h,h],[I,X,C,A,L],[_,C,b,x,S]]),n.meta=new Ae(n.id,s.metatilesets.cave,5,5),n.meta.set2d(0,[[m,L,p,h,p],[h,I,I,h,I],[h,l,c,u,S],[h,X,h,C,L],[m,S,h,h,y]]),o.meta.set2d(51,[[a]]),s.tileEffects[0].effects[192]=0,e.meta.attach(67,n.meta,68),e.meta.attach(64,o.meta,51),t.exit1&&(e.meta.set2d(4,[[T]]),yo(e,4,t.exit1)),t.exit2&&(r.meta=new Ae(r.id,s.metatilesets.cave,3,1),r.meta.set2d(0,[[w],[se],[_]]),r.spawns.push(V.from([24,7,35,0])),r.flags.push(bs.of({screen:16,flag:s.flags.alloc(512)})),n.meta.set2d(64,[[g]]),n.meta.attach(64,r.meta,0),yo(r,32,t.exit2)),e.spawns.push(V.of({screen:33,tile:135,timed:!0,id:2}),V.of({screen:18,tile:136,timed:!1,id:2}),V.of({screen:19,tile:137,timed:!0,id:2}),V.of({screen:50,tile:104,timed:!1,id:2}),V.of({screen:65,tile:136,timed:!0,id:2}),V.of({screen:51,tile:152,timed:!0,id:2}),V.of({screen:3,tile:136,timed:!0,id:2})),n.spawns.push(V.of({screen:1,tile:136,timed:!0,id:2}),V.of({screen:17,tile:72,timed:!1,id:2}),V.of({screen:18,tile:119,timed:!0,id:2}),V.of({screen:20,tile:40,timed:!1,id:2}),V.of({screen:35,tile:133,timed:!0,id:2}),V.of({screen:49,tile:136,timed:!0,id:2}),V.of({screen:51,tile:138,timed:!1,id:2}),V.of({screen:52,tile:152,timed:!0,id:2}),V.of({screen:65,tile:130,timed:!0,id:2}),V.of({y:272,x:1144,type:2,id:89}),V.of({y:112,x:264,type:2,id:124})),s.slots.swap(49,89)}function yo(s,t,e){let{locations:{CordelPlainEast:n,CordelPlainWest:r,Desert2:i,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:c,boundaryN_trees:d,boundaryW_cave:f,cornerNE:u,cornerNW:h,cornerSE:m,cornerSE_cave:g,cornerSW:x}}=s.rom,y,p;switch(e){case"lime":y=a,p=16,y.resizeScreens(0,1,0,0),y.meta.spliceColumns(0,1,2,[[h,d],[f,c],[x,m]]);break;case"cordel":let w=[[f,c],[x,m]];y=n,p=85,y.meta.set2d(85,w),r.meta.set2d(85,w);break;case"goa":y=o,p=17,y.meta.set2d(1,[[h,u],[f,l]]);break;case"desert":y=i,p=83,y.meta.set2d(83,[[g]]);break}s.meta.attach(t,y.meta,p)}function nd(s){let{locations:{ValleyOfWind:t,LimeTreeValley:e},metascreens:{exitE:n,exitW_southwest:r,overworldEmpty_alt:i}}=s;t.meta.set2d(84,[[n]]),e.meta.set2d(16,[[r],[i]]),t.meta.attach(84,e.meta,16)}function rd(s){let{TowerEntrance:t,Crypt_Teleporter:e}=s.locations;e.meta.attach(0,t.meta,0,"teleporter","teleporter")}function sd(s){let{flags:{OpenedSwanGate:t},locations:{SwanGate:e},npcs:{SoldierGuard:n}}=s;e.spawns.push(V.of({xt:10,yt:2,type:1,id:45}),V.of({xt:11,yt:2,type:1,id:45})),n.localDialogs.get(e.id)[0].flags.push(t.id)}function id(s){od(s.locations.SaberaPalace2_West,s.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function od(s,t,...e){s.rom.locations.allocate(s,t),s.bgm=t.bgm,s.entrances=[],s.exits=[],s.pits=[],s.spawns=[],s.flags=[],s.width=s.height=1,s.screens=[[128]],s.tilePalettes=yt(t.tilePalettes),s.originalTilePalettes=yt(t.originalTilePalettes),s.tileset=t.tileset,s.tileEffects=t.tileEffects,s.tilePatterns=yt(t.tilePatterns),s.spritePatterns=yt(t.spritePatterns),s.spritePalettes=yt(t.spritePalettes);let r=0,i=0;for(let a of e)r=Math.max(r,(a>>>4)+1),i=Math.max(i,(a&15)+1);s.meta=new Ae(s.id,t.meta.tileset,r,i);for(let a of e)s.meta.set(a,t.meta.get(a)),t.meta.set(a,t.meta.tileset.empty);let o=new Set(e);s.flags=t.flags.filter(a=>o.has(a.screen)),t.flags=t.flags.filter(a=>!o.has(a.screen)),s.spawns=t.spawns.filter(a=>o.has(a.screen)),t.spawns=t.spawns.filter(a=>!o.has(a.screen)),t.meta.moveExitsAndPitsTo(s.meta)}function ad(s){let t=s.locations.GoaFortress_Kensu.meta;for(let[e,n]of t.exits())e<16||n.startsWith("seamless")||t.deleteExit(e,n)}function ld(s){s.locations.ZebuCave.spawns.find(t=>t.isTrigger()).yt+=3}var So=v(()=>{ta();nn();ce();(t=>{function s(e,n){let r={};if(e.addEastCave()){r.eastCave={};let i=["cordel","lime","goa","desert"],o=n.nextInt(4);[r.eastCave.exit1]=i.splice(o,1),r.eastCave.exit2=n.pick(i)}else e.connectLimeTreeToLeaf()&&(r.classicLimeTreeToLeaf=!0);return r}t.generateOptions=s})(Yt||={})});var wo=v(()=>{});function Eo(s,t,e){if(!t.unidentifiedItems())return;let n=(...c)=>c.map(d=>s.items[d]),r=n(50,51,52),i=n(39,40,49,54),o=n(53,57),a=n(37,56,58,61),l=n(62,63,64);for(let[c,[...d]]of[[r,dd],[i,cd],[o,fd],[a,ud],[l,hd]]){let f=(t.communityJokes()?d:d.filter(h=>h.startsWith("!"))).map(h=>h.replace(/^!/,""));e.shuffle(f);let u=e.shuffle([0,1,2,3]);for(let h of c){let m=f.pop();s.spoiler&&s.spoiler.addUnidentifiedItem(h.id,h.messageName,m),h.menuName=h.messageName=m,h.palette=u.pop()}}}var dd,cd,fd,ud,hd,To=v(()=>{dd=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Unidentified Key","Piano Key","Encryption Key","Private Key","Public Key","Secret Key","Cipher Key","Key Card","Keyboard","Any Key","Ctrl Key","Escape Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Major Key","Minor Key","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Cookie","Turkey","Monkey","Donkey","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key","Sticks Key","Key to my Heart","Aqui","Map Key","Key Stone"],cd=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","Deku Pipes","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power","Otamatone","Melodica","Vuvuzela","Didgeridoo","Dragonzord Flute","Whoopie Cushion"],fd=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Unidentified Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Halogen Bulb","Incandescent Bulb","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Streetlight","Flashlight","Search Light","LED","Nightlight","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Candle","Red Candle","Blue Candle","Gas Stove","Fireplace","Campfire","Bonfire","Tanning Bed","Bug Zapper","CRT","Disco Ball","The Clapper","Merton","Gaddlight","Shroomlight","Froglight","Glowstone","Redstone Lamp","PrismarineLantern","Soul Campire"],ud=["!Random Statue","!Rusty Statue","!Forbidden Statue","Unidentified Idol","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Great Sphynx","Olmec Head","Shakoki Dogu","Moai","Venus de Milo","David","The Thinker","Winged Victory","Terracotta Statue","Gargoyle","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","Tornel Statue","CodeGorilla Trophy","SirArchibald Model","ClaireDiviner Idol","justchris Trophy"],hd=["!Random Bow","Unidentified Bow","Crossbow","Arbalest","Autocrossbow","Long Bow","Compound Bow","Recurve Bow","Golden Bow","Silver Arrows","Ice Arrows","Fire Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Burnham","Bo Dallas","Bo Derek","Bo Diddley","Bo Jackson","Bo Schembechler","Beau Bridges","David Bowie","Bojangles","Bodacious","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn","Cupid's Bow","Bow No!","Slingshot"]});function Co(s,t,e){t.communityJokes()&&(xd(s,t,e),yd(s,e),Sd(s,e))}function xd(s,t,e){if(t.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let n=e.next()<.05?s.items:[s.items[e.nextInt(72)]];for(let r of n){if(!r)continue;let i=md.get(r.messageName)||[],o=Math.floor(e.nextInt(3*i.length+1)/3);o<i.length?r.messageName=r.menuName=i[o]:r.messageName===r.menuName&&(r.messageName=r.menuName=es(r.messageName,e))}}function es(s,t){let e=s.split(""),n=t.nextInt(e.length-1);return e[n]===" "||e[n+1]===" "?s:(e[n].toUpperCase()===e[n]?e.splice(n+1,1):[e[n],e[n+1]]=[e[n+1],e[n]],e.join(""))}function Ro(s,t){for(let e of s.messages.parts)for(let n of e)n.text=t(n.text);s.messages.personNames=s.messages.personNames.map(t),bd(s,t)}function Jn(s,t){return e=>e.includes(s)?e.split(s).join(t):e}function bd(s,t){for(let e of s.objects)e.displayName&&(e.displayName=t(e.displayName))}function yd(s,t){let e=s.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let n=[...pd].flatMap(([l,c])=>["",...c,...c].map(d=>[l,d])),[r,i]=t.pick(n),o=i||es(r,t);if(o===r)return;let a=Jn(r,o);(o==="Stom"||o==="Mado")&&(a=l=>l.includes("Stom")?Jn("Stom","Mado")(l):l.includes("Mado")?Jn("Mado","Stom")(l):l),Ro(s,a)}function Sd(s,t){for(let e=0;e<10;e++){let[n,r]=t.pick([...gd]),o=t.pick(["",...r,...r,...r])||es(n,t);o!==n&&Ro(s,Jn(n,o))}}var md,pd,gd,Mo=v(()=>{md=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer","Sword of Friar"]],["Sword of Water",["Horde of Otters","Cane of Byrna"]],["Sword of Thunder",["Sorg of Chunker"]],["Tornado Bracelet",["Vornado Bracelet","Roarnado Bracelet"]],["Flame Bracelet",["Fame Bracelet","Bomb Ring"]],["Blizzard Bracelet",["Snowflake Ring","Gizzard Bracelet","Lizzard Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Sun",["Bow of Bun","Bow of Pun","Solar Bow"]],["Bow of Moon",["Bow of Noon","Bow of Lune","Lunar Bow"]],["Bow of Truth",["Bow of Strewth","Bow of Tooth","Bow of Grueth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute","Ivy Statue"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump","Shimmering Lamp"]],["Key to Stxy",["Key to Styx","Styx Key","Key to Sticks"]],["Insect Flute",["Bug Flute","Bug Whistle","Cockroach Flute","Mosquito Flute","Bug Summoner"]],["Flute of Lime",["Flute of Grime","Flute of Lemon","Flute of Rhyme"]],["Iron Necklace",["I Ron Necklace","Rusty Necklace"]],["Shield Ring",["Sho Ring","Barrier Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Pocket Cucco","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go","Exit"]],["Change",["Changeify","Transform","Disguise","Morph"]],["Barrier",["Barrierize","Protect","Wall","Shield","Shell"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),pd=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Ninja Cannonball","Steve","Stom"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve","Mado"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),gd=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mimic",["Chompy","Gozen","The Gozenator"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac","TASBot","SkyNet"]],["Vampire",["Captain Telefrag","Count Dracula"]]])});function Io(s){let{locations:t}=s,{CordelPlainEast:e,CordelPlainWest:n,WaterfallValleyNorth:r,WaterfallValleySouth:i,MezameShrine:o,MtSabreWest_Cave1:a}=t;e.meta.reconcileExits(n.meta);for(let l of r.meta.allPos()){let c=r.meta.get(l),d=i.meta.get(l);c.isEmpty()&&!d.isEmpty()?r.meta.set(l,d):d.isEmpty()&&!c.isEmpty()&&i.meta.set(l,c)}for(let l of t)l.used&&(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of t)l.used&&l!==a&&(l.meta.write(),l===n&&a.used&&a.meta.write())}var ko=v(()=>{});function Oo(s){let{config:t,random:e,rom:n}=s;if(t.maps.wildWarp===R.Maps.WildWarp.MEZAME)n.wildWarp.locations.fill(0);else if(t.maps.wildWarp===R.Maps.WildWarp.RANDOM)wd(s);else if(t.maps.wildWarp===R.Maps.WildWarp.FIXED)throw new Error("Fixed wild warp not yet supported")}function wd(s){let{random:t,rom:e}=s,n=[];for(let i of e.locations)i&&i.used&&i.id&&!i.isShop()&&i!==e.locations.EvilSpiritIsland1&&i!==e.locations.UndergroundChannel&&(i.id&248)!==88&&i!==e.locations.Crypt_Draygon2&&i!==e.locations.Crypt_Teleporter&&i!==e.locations.MesiaShrine&&i!==e.locations.LimeTreeLake&&n.push(i);t.shuffle(n),e.wildWarp.locations=[];let r=s.config.maps.wildWarpCount-1;for(let i of[...n.slice(0,r)])e.wildWarp.locations.push(i.id),e.spoiler&&e.spoiler.addWildWarp(i.id,i.name);e.wildWarp.locations.push(0)}var _o=v(()=>{$e()});function Ao(s,t){return t>=112?"Mimic":s.items[s.itemGets[t].itemId].messageName}var Xn,ts,ns,vo=v(()=>{Xn=class{constructor(t){this.rom=t;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(t,e){this.route.push(new ts(this,t,e))}addSlot(t,e,n){this.slots[t&255]=new ns(this.rom,t&255,e,n&255)}addMaze(t,e,n){this.mazes.push({id:t,name:e,maze:n})}addTrade(t,e,n){this.trades.push({itemId:t,item:e,npc:n})}addUnidentifiedItem(t,e,n){this.unidentifiedItems.push({itemId:t,oldName:e,newName:n})}addWall(t,e,n){this.walls.push({location:t,oldElement:e,newElement:n})}addWildWarp(t,e){this.wildWarps.push({id:t,name:e})}addHouse(t,e){this.houses.push({houseId:t,townId:e,house:this.rom.locations[t].name,town:this.rom.locations[e].name})}formatCondition(t){return this.rom.flags[t]?.name}formatConditionList(t){let e=[];for(let n of t){let r=this.rom.flags[n];r?.logic.track&&e.push(r.name)}return e.join(", ")}},ts=class{constructor(t,e,n){this.spoiler=t;this.condition=e;this.deps=n}toString(){let t=0;return(this.condition&-128)===256&&(t=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${t?` (${this.spoiler.formatCondition(t)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},ns=class{constructor(t,e,n,r){this.slot=e;this.slotName=n;this.item=r;this.itemName=Ao(t,r),this.originalItem=Ao(t,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}}});function Ed(s,[t,e,[n,r]]){let i=No.get(e)||rs.get(No.get(r)),o=!1,a=s.id.toString(16),l=(s.id<<8|t).toString(16)+" "+e,c=s.rom.locations[n>>>8],d=n&255,f=n.toString(16)+" "+r,u=c.id.toString(16),h={loc:c,pos:d,type:r,area:u,key:f,reverse:null,origRev:null,get conn(){return rs.get(i)},set conn(g){i=rs.get(g)},get shuffle(){return o},set shuffle(g){if(g&&!i)throw new Error("shuffle without conn");o=g}},m={loc:s,pos:t,type:e,key:l,reverse:h,area:a,origRev:h,get conn(){return i},set conn(g){i=g},get shuffle(){return o},set shuffle(g){if(g&&!i)throw new Error("shuffle without conn");o=g}};return h.reverse=h.origRev=m,m}function Lo(s,t){return typeof t=="string"?s.type===t:typeof t=="number"?s.pos===t:t instanceof lr?s.reverse.loc===t:t.every(e=>Lo(s,e))}function Go(s,t,e){if(!t.shuffleAreas())return;let{locations:n}=s,r=new Map,i=new H(()=>[]);for(let p of s.locations)for(let w of p.meta.exits()){if(p===n.CordelPlainEast&&(w[0]&15)<5||p===n.CordelPlainWest&&(w[0]&15)>4||p.isTower())continue;let b=Ed(p,w);if(b.loc!==n.Portoa_FortuneTeller&&b.reverse.loc!==n.Portoa_FortuneTeller&&!r.has(b.key)){if(r.has(b.reverse.key))throw new Error(`Inconsistent exits: ${b.key} | ${b.reverse.key}`);r.set(b.key,b),r.set(b.reverse.key,b.reverse),i.get(b.loc).push(b),i.get(b.reverse.loc).push(b.reverse)}}function o(p,...w){let b=[];for(let T of i.get(p))for(let C of w)if(Lo(T,C)){b.push(T);break}return b}for(let p of o(n.ValleyOfWind,"door","windmill"))p.area="windmill";for(let p of o(n.AngrySea,100))p.area="lighthouse";o(n.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(p,...w){for(let b of o(p,...w))b.shuffle=!0}function l(...p){let w=new Set(p);for(let b of p)for(let T of i.get(b))w.has(T.reverse.loc)||(T.shuffle=!0)}if(l(n.Leaf_OutsideStart),a(n.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(n.WindmillCave),l(n.EastCave1,n.EastCave2,n.EastCave3),l(n.ZebuCave,n.MtSabreWest_Cave1),l(n.CordelPlainWest,n.CordelPlainEast),l(n.WaterfallValleyNorth,n.WaterfallValleySouth),l(n.KirisaMeadow),l(n.LimeTreeLake),a(n.Portoa_FishermanIsland,"edge:right"),a(n.PortoaPalace_ThroneRoom,"door"),a(n.Joel,"edge:bottom"),l(n.JoelSecretPassage),a(n.EvilSpiritIsland1,"stair:up"),a(n.ZombieTown,"cave"),a(n.AngrySea,"edge:top"),l(n.SwanGate),a(n.GoaValley,"edge:left"),l(n.Desert1),l(n.GoaFortressBasement),l(n.DesertCave1),l(n.SaharaOutsideCave),l(n.DesertCave2),a(n.Desert2,"stair:down"),!t.shuffleHouses()){let p=[[n.ZombieTown,"fortress"],[n.MtHydra,"gate"],[n.Desert2,"fortress"],[n.Goa,"edge:top"],[n.Portoa,"fortress"],[n.Shyron,"fortress"],[n.GoaValley,"fortress"],[n.OasisCave_Entrance,"stair:up"],[n.MtHydra_OutsideShyron,"gate"],[n.Crypt_Entrance,"crypt"]];for(let[w,b]of p){let[T]=o(w,b);T.conn="F",T.shuffle=!0}}{let[p]=o(n.Oak,"edge:bottom");p.conn="X",p.shuffle=!0}let c=new _e;for(let p of r.values())p.shuffle||c.union([p.area,p.reverse.area]);let d=new H(()=>[]);for(let p of r.values())p.shuffle&&d.get(p.area=c.find(p.area)).push(p);let f=i.get(n.MezameShrine)[0].area;function u(){let p=new Set,w=new Map,b=[];for(let C of[f,...d.keys()]){if(p.has(C))continue;let I=new Set([C]),S=[];for(let O of I){p.add(O);for(let L of d.get(O))w.set(L,b.length),S.push(L),!(L.oneWay||p.has(L.reverse.area))&&I.add(L.reverse.area)}b.push(S)}let T=0;for(let C=1;C<b.length;C++)b[C].length<b[T].length&&(T=C);return[b.length,w,b[T]]}let h=new H(()=>[]);for(let p of r.values())!p.shuffle||!p.conn||h.get(p.conn).push(p);for(let p of"NWCF"){let w=h.get(p),b=e.shuffle([...w]).map(T=>T.reverse);for(let T=0;T<b.length;T++){let C=w[T],I=b[T];[C.reverse,I.reverse]=[I,C]}}let m=0,[g,x,y]=u();for(;m-- >0||g>1;){let p=e.pick(y),w=h.get(p.conn);if(g>1){let I=x.get(p);w=w.filter(S=>x.get(S)!==I)}let b=e.pick(w),T=p.reverse,C=b.reverse;p.reverse=C,C.reverse=p,b.reverse=T,T.reverse=b,[g,x,y]=u()}for(let p of r.values()){if(p.reverse!==p.origRev){let w=function(b){return`${b.loc.name} ${b.type}(${b.pos.toString(16)})`};console.log(`${w(p)}  =>  ${w(p.reverse)}  (was ${w(p.origRev)})`)}p.loc.meta.attach(p.pos,p.reverse.loc.meta,p.reverse.pos,p.type,p.reverse.type)}}var No,rs,Fo=v(()=>{wt();de();St();No=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),rs=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]])});function Do(s){for(let t of s.locations){let e=new Set;for(let n of t.spawns)if(n.isTrigger()&&e.has(n.coord))throw new Error(`Overlapping triggers on ${t} at ${n.coord.toString(16)}`)}}var Po=v(()=>{});function Bo(s){Td(s),Cd(s)}function Td(s){let{rom:t}=s;for(let e of t.locations)if(e.used){for(let n of e.spawns)if(n.isWall()){let r=n.id&15;n.id=r|r<<4;let i=n.isShootingWall(e);n.data[2]=i?51:35}}}function Cd(s){let{config:t,random:e,rom:n}=s;if(t.maps.wallElements===R.Randomization.VANILLA)return;let r=[[5,56],[17],[106],[20]];function i(l){return l.data[2]&32?l.id>>>4&3:l.id&3}let o=new H(()=>[]);for(let l of n.locations)o.get(l.data.area).push(l);let a=t.maps.wallElements===R.Randomization.SHUFFLE?(()=>{let l=[];for(let c of o.values())for(let d of c)for(let f of d.spawns){if(!f.isWall())continue;let u=i(f);u!==2&&l.push(u)}return e.shuffle(l),c=>{if(c==null)return l.pop();let d=l.indexOf(c);return d>=0&&l.splice(d,1),c}})():l=>l??e.nextInt(4);for(let l of o.values()){let c,d;for(let f of l)for(let u of f.spawns){if(!u.isWall())continue;let h=i(u);if(h!==2)if(h===3){let m=a();n.spoiler&&n.spoiler.addWall(f.name,h,m),u.data[2]|=32,u.id=48|m}else c==null?(c=a(),d=e.pick(r[c]),n.spoiler&&n.spoiler.addWall(f.name,h,c)):a(c),u.data[2]|=32,u.id=h<<4|c,f.tilePalettes[2]=d}}}var Wo=v(()=>{$e();de()});function wp(s){return s?/^[0-9a-f]{1,8}$/i.test(s)?Number.parseInt(s,16):on(s):We.newSeed()}function Md(s,t){let e={_ALLOW_TELEPORT_OUT_OF_BOSS:s.enemies.permadeath&&s.enemies.tetrarchWeaknesses!==R.Randomization.VANILLA,_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:t==="late"&&s.options.accessibility.audibleWallCues||!1,_AUTO_EQUIP_BRACELET:t==="late"&&s.quality.autoEquipBracelet||!1,_BUFF_DYNA:s.enemies.buffDyna,_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:t==="late"&&(s.quality.quickSwapSword||s.quality.quickWildWarp),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:s.glitches.shopGlitch===R.GlitchMode.FORBID,_DISABLE_STATUE_GLITCH:s.glitches.statueGlitch===R.GlitchMode.FORBID,_DISABLE_SWORD_CHARGE_GLITCH:s.glitches.swordChargeGlitch===R.GlitchMode.FORBID,_DISABLE_TRIGGER_SKIP:s.glitches.triggerSkip===R.GlitchMode.FORBID,_DISABLE_WARP_BOOTS_REUSE:!s.glitches.allowWarpBootsReuse,_DISABLE_WILD_WARP:!1,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:s.items.hazmatSuit,_LEATHER_BOOTS_GIVE_SPEED:s.items.addSpeedBoots,_MAX_SCALING_IN_TOWER:s.enemies.maxScalingInTower,_MONEY_AT_START:!!(s.maps.shuffleHouseEntrances||s.maps.shuffleAreaConnections),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:s.debug.neverDie,_NORMALIZE_SHOP_PRICES:s.towns.rescalePrices,_OOPS_ALL_MIMICS:!!s.enemies.itemsFromMimics,_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:!!s.items.rabbitBootsChargeWhileWalking,_RANDOM_FLYER_SPAWNS:!0,_RANDOM_WILD_WARP_COUNT:s.maps.wildWarp===R.Maps.WildWarp.RANDOM?s.maps.wildWarpCount<16:s.maps.wildWarp===R.Maps.WildWarp.FIXED?s.maps.wildWarpLocations.length<16:!1,_RESCALE_DAMAGE:!0,_SIMPLIFY_INVISIBLE_CHESTS:!0,_SKIP_TITLE:globalThis?.location?.hostname==="localhost",_STATS_TRACKING:s.quality.statTracking,_TINK_MODE:s.enemies.tinkMode!==R.GlitchMode.FORBID,_TRAINER:s.debug.trainer,_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:s.items.unidentifiedItems,_UPDATE_SHIELD_EFFECTS:!0,_ENEMY_HP:s.quality.enemyHpInHud,_UPDATE_HUD:s.quality.updateHud,_WARP_FLAGS_TABLE:!0,_WARRIOR_RING_TURRET:s.items.warriorRingTurret,_ZEBU_STUDENT_GIVES_ITEM:s.triggers.zebuStudentGivesItem},n={warriorRingTurretDelay:s.items.warriorRingTurretDelay,warriorRingTurretFreeShotFrequency:s.items.warriorRingTurretFreeShotFrequency,swordChargeSpeed_still:r(s.items.chargeSpeed),swordChargeSpeed_moving:r(s.items.chargeWhileWalkingSpeed),swordChargeSpeedWithItem_still:r(s.items.chargeWithItemSpeed),swordChargeSpeedWithItem_moving:r(s.items.chargeWhileWalkingWithItemSpeed),deoSpeed_still:r(s.items.deosPendantMpRestoreSpeed),deoSpeed_moving:r(s.items.deosPendantMpRestoreWhileWalkingSpeed),psychoArmorSpeed_still:r(s.items.psychoArmorHealSpeed),psychoArmorSpeed_moving:r(s.items.psychoArmorHealWhileWalkingSpeed)};function r(a){return a<=0?0:a>8?1:(1<<9-a)-1}let i=Object.keys(e).filter(a=>e[a]).map(a=>`.define ${a} ${e[a]}
`).join(""),o=Object.keys(n).map(a=>`${a} = ${n[a]}
.export ${a}
`).join("");return i+o}function Id(s,t){for(let e of t)ht.applyPatch(e,s,!0)}async function Ep(s,t,e,n,r,i){let o=16+(s[6]&4?512:0)+(s[4]<<14)+(s[5]<<13);if(s.length>o&&(s=s.slice(0,o)),Rd&&s.length<524288){if(s.length<524288){let x=new Uint8Array(s.length+262144);x.subarray(0,262160).set(s.subarray(0,262160)),x.subarray(524304).set(s.subarray(262160)),x[4]<<=1,s=x}let g=s.subarray(16);g.subarray(507904,524288).set(g.subarray(245760,262144))}let a=s.slice(16);if(Pi(s.subarray(16)),typeof t!="number")throw new Error("Bad seed");let l=e.configGen.toBinary(),c=new Uint32Array(1);c[0]=t;let d=on([...new Uint8Array(c.buffer),...l]),f=new We(d),u=[],m=!!e.configGen.maps?.shuffleAreaConnections?12:5;for(let g=0;g<m;g++)try{return await kd(s,e,t,f,r,i,n,a)}catch(x){if(x.name==="UsageError")throw x;u.push(x),console.error(`Attempt ${g+1} failed: ${x.stack}`)}throw new Error(`Shuffle failed: ${u.map(g=>g.stack).join(`

`)}`)}async function kd(s,t,e,n,r,i,o,a){let l=String(t),c=t.filterRandom(n);c.validate();let d=new Ts(s),f=String(c),u=c.config,h={config:u,random:n,rom:d};d.flags.defrag(),Ni(d),Li(d),typeof globalThis=="object"&&(globalThis.rom=d),d.spoiler=new Xn(d),r&&(r.spoiler=d.spoiler),f!==l&&(d.spoiler.flags=f),Bi(h),Ss(d),Yt(d,Yt.generateOptions(c,n)),d.scalingLevels=48,u.towns.shopContents!==R.Randomization.VANILLA&&_d(d,c,n),u.maps.shuffleGoaFloorConnections&&so(d,n),Bo(h),Fi(d,n),Oo(h),to(h),ro(h),Eo(d,c,n),Co(d,c,n),zi(d,c,n),c.shuffleHouses()&&ao(d,c,n),c.shuffleAreas()&&Go(d,c,n),ji(d),c.randomizeMaps()&&ti(d,c,n),Io(d),uo(d,n),c.shuffleMimics()&&co(d,c,n),c.shuffleMonsters()&&go(d,c,n);let m=new Vn(d,c),g=new Dn([m.getLocationList()]);if(!c.noShuffle()){let T=await g.shuffle(c,n,void 0,i,d.spoiler);if(T){for(let[C,I]of T)d.slots[C&255]=I&255;d.slots.setCheckCount(T.size)}else throw new Error("Shuffle failed")}c.shuffleShops()&&Fd(d,c.bargainHunting()?n:void 0),c.buffMedicalHerb()&&(d.items.MedicalHerb.value=80,d.items.FruitOfPower.value=56),c.blackoutMode()&&Nd(d),Od(d,c,n),Vi(d),Ji(d),Do(d),c.buffDyna()&&vd(d,c),c.trainer()&&(d.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),c.randomizeMusic("early")&&zo(d,c,n),c.shuffleTilePalettes("early")&&Zr(d,c,n),Gd(d,c),n.shuffle(d.randomNumbers.values);async function x(T){let C=Md(u,T),I=new ls(Ht.P02,{overwriteMode:"forbid"}),S=new cs;S.enter(as.concat(new sr(C,"flags.s"),...fs().map(({filename:_,contents:X})=>(T==="late"&&(globalThis.sourcesContents||(globalThis.sourcesContents=new Map)).set(_,X),new sr(Nr(X,Ht.P02,a),_,{lineContinuations:!0})))));let O=new ds(S,I);I.tokens(O);let L=hs(),A=[];for(let _ of L.labels)I.definedSymbol(_.name)||((A.length!==_.segments.length||A.some((X,se)=>X!==_.segments[se]))&&I.segment(...A=_.segments),I.org(_.org),I.label(_.name));for(let _ of L.refs){let X=_.offset+(_.offset>=245760?262144:0);if(!I.isWritten(X))if((A.length!==_.segments.length||A.some((se,U)=>se!==_.segments[U]))&&I.segment(...A=_.segments),I.org(_.org),_.bytes===1)I.byte(_.expr);else if(_.bytes===2)I.word(_.expr);else throw new Error(`bad bytes: ${_.bytes}`)}return I.module()}d.messages.compress();let y=s.slice(16);d.modules.set(Ho,await x("early")),d.writeData(y),d.modules.set(Ho,await x("late"));let p=o?.some(T=>ht.isCustom(T))||!1,w=Ld(s,e,l,y,p);c.randomizeMusic("late")&&zo(d,c,n),c.noMusic("late")&&Ad(d),c.shuffleTilePalettes("late")&&Zr(d,c,n),Zi(d),d.writeData();let b=o||[];return Id(s.subarray(16),b),[s,w]}function Od(s,t,e){let{}={rom:s,flags:t,random:e};s.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,s.messages.parts[0][14].text="It's dangerous to go alone! Take this.",s.messages.parts[0][14].fixText()}function _d(s,t,e){let n={0:{contents:[],shops:[]},1:{contents:[],shops:[]}};for(let r of s.shops){if(!r.used||r.location===255)continue;let i=n[r.type];i&&(i.contents.push(...r.contents.filter(o=>o!==255)),i.shops.push(r),r.contents=[])}for(let r of Object.values(n)){let i=null,o=[...r.contents];for(e.shuffle(o);o.length;){(!i||!i.length)&&(i&&o.shift(),i=[...r.shops,...r.shops,...r.shops,...r.shops],e.shuffle(i));let a=o[0],l=i[0];l.contents.length<4&&!l.contents.includes(a)&&(l.contents.push(a),o.shift()),i.shift()}}for(let r of Object.values(n))for(let i of r.shops){for(;i.contents.length<4;)i.contents.push(255);i.contents.sort((o,a)=>o-a)}}function Ad(s){for(let t of[...s.locations,...s.bosses.musics])t.bgm=0}function zo(s,t,e){let n=new H(()=>[]),r=new Set;for(let a of s.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;r.add(a.bgm),n.get(l).push(a)}for(let a of s.bosses.musics)n.set(a,[a]),r.add(a.bgm);let i=[...r],o=new Set;for(let a of n.values()){let l=e.pick(i);for(let c of a)c.bgm=l,o.add(c)}}function vd(s,t){s.objects[184].collisionPlane=1,s.objects[184].immobile=!0,s.objects[185].collisionPlane=1,s.objects[185].immobile=!0,s.objects[51].collisionPlane=2,s.adHocSpawns[40].slotRangeLower=28,s.adHocSpawns[41].slotRangeUpper=28,s.adHocSpawns[42].slotRangeUpper=28}function Nd(s){let t=new Set([s.metatilesets.cave.tilesetId,s.metatilesets.fortress.tilesetId,s.metatilesets.iceCave.tilesetId,s.metatilesets.labyrinth.tilesetId,s.metatilesets.pyramid.tilesetId]);for(let e of s.locations)t.has(e.tileset)&&e.tilePalettes.fill(154)}function Ld(s,t,e,n,r){let i=on(n),o=i.toString(16).padStart(8,"0").toUpperCase(),a=kr==="unstable"?si.substring(0,7).padStart(7,"0").toUpperCase()+"     ":ri.substring(0,12).padEnd(12," "),l=t.toString(16).padStart(8,"0").toUpperCase(),c=(u,...h)=>{u+=16;for(let m of h)if(typeof m=="string")for(let g of m)s[u++]=g.charCodeAt(0);else if(typeof m=="number")s[u++]=m;else throw new Error(`Bad value: ${m}`)},d=(u,h)=>{let m=[];for(let g=0;g<u.length||g<h.length;g++)m.push(u[g]||" "),m.push(h[g]||" ");return m.join("")};c(161743,d("  VERSION     SEED      ",`  ${a}${l}`));let f;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");f=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),c(161791,d(e.substring(0,23),e.substring(23))),f&&c(161839,d(f.substring(0,23),f.substring(23))),r&&c(161923,126),c(161925,d(o.substring(0,4),o.substring(4))),c(153366,"RANDOMIZER"),kr==="unstable"&&c(153404,"BETA"),i}function Gd(s,t){let e=t.config;t.decreaseEnemyDamage()&&s.scaling.setPhpFormula(n=>16+6*n),s.scaling.setExpScalingFactor(t.expScalingFactor()),e.glitches.shopGlitch===R.GlitchMode.FORBID?s.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:s.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],s.items.CarapaceShield.defense=s.items.TannedHide.defense=3,s.items.PlatinumShield.defense=s.items.BronzeArmor.defense=9,s.items.MirroredShield.defense=s.items.PlatinumArmor.defense=13,s.items.PsychoArmor.defense=s.items.PsychoShield.defense=20,s.items.CeramicSuit.defense=s.items.BattleShield.defense=32,s.items.CarapaceShield.defense=s.items.TannedHide.defense=2,s.items.PlatinumShield.defense=s.items.BronzeArmor.defense=10,s.items.MirroredShield.defense=s.items.PlatinumArmor.defense=14,s.items.BattleArmor.defense=24}var Rd,Ho,Fd,Dd,Pd=v(()=>{Qo();os();Zo();pi();Yo();ea();Jo();Cs();Bs();xi();vi();Gi();Di();Hi();Ki();Yi();Xi();eo();no();Vr();io();lo();ni();fo();ho();xo();bo();Ur();So();wo();To();Mo();ko();_o();Sn();oa();rn();or();vo();ce();ms();de();ii();Fo();Po();ui();$e();Wo();Rd=!0,Ho=Es("asm");({}={watchArray:ps});Fd=(s,t)=>{for(let n of s.shops)if(n.type!==3)for(let r=0,i=n.prices.length;r<i;r++)n.contents[r]<128?n.prices[r]=t?t.nextNormal(1,.3,.5,1.5):1:n.type!==2?n.prices[r]=0:n.prices[r]=t?t.nextNormal(1,.5,.375,1.625):1;let e=ae(48,n=>n);s.shops.rescale=!0,s.shops.toolShopScaling=e.map(n=>Math.round(8*2**(n/10))),s.shops.armorShopScaling=e.map(n=>Math.round(8*2**((47-n)/12)));for(let n=13;n<39;n++)s.items[n].basePrice=Dd[n]},Dd={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300}});export{on as a,Cs as b,fe as c,Re as d,xn as e,Bs as f,Sn as g,Ga as h,ni as i,kr as j,ri as k,nu as l,si as m,ru as n,su as o,ii as p,au as q,ht as r,oi as s,Ha as t,ui as u,wp as v,Ep as w,Pd as x};
