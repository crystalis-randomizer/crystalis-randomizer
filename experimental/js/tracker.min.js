(function(){'use strict';var k=k||{};k.scope={};k.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};k.arrayIterator=function(a){return{next:k.arrayIteratorImpl(a)}};k.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):k.arrayIterator(a)};
k.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};k.global=k.getGlobal(this);k.ASSUME_ES5=!1;k.ASSUME_NO_NATIVE_MAP=!1;k.ASSUME_NO_NATIVE_SET=!1;k.SIMPLE_FROUND_POLYFILL=!1;
k.defineProperty=k.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};k.polyfill=function(a,b){if(b){var c=k.global;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&k.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};k.FORCE_POLYFILL_PROMISE=!1;k.SYMBOL_PREFIX="jscomp_symbol_";
k.initSymbol=function(){k.initSymbol=function(){};k.global.Symbol||(k.global.Symbol=k.Symbol)};k.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;k.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};k.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};k.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new k.SymbolClass(k.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
k.initSymbolIterator=function(){k.initSymbol();var a=k.global.Symbol.iterator;a||(a=k.global.Symbol.iterator=k.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&k.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return k.iteratorPrototype(k.arrayIteratorImpl(this))}});k.initSymbolIterator=function(){}};
k.initSymbolAsyncIterator=function(){k.initSymbol();var a=k.global.Symbol.asyncIterator;a||(a=k.global.Symbol.asyncIterator=k.global.Symbol("Symbol.asyncIterator"));k.initSymbolAsyncIterator=function(){}};k.iteratorPrototype=function(a){k.initSymbolIterator();a={next:a};a[k.global.Symbol.iterator]=function(){return this};return a};k.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
k.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:k.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;k.generator={};k.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};
k.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};k.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};k.generator.Context.prototype.stop_=function(){this.isRunning_=!1};
k.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};k.generator.Context.prototype.next_=function(a){this.yieldResult=a};k.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};k.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};
k.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};k.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};k.generator.Context.prototype.yieldAll=function(a,b){a=k.makeIterator(a);var c=a.next();k.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};
k.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};k.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};k.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};k.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};k.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
k.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};k.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
k.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};k.generator.Context.prototype.forIn=function(a){return new k.generator.Context.PropertyIterator(a)};
k.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};k.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};k.generator.Engine_=function(a){this.context_=new k.generator.Context;this.program_=a};
k.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};k.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(a){return{value:a,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
k.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
k.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);k.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
k.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
k.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};k.initSymbolIterator();this[Symbol.iterator]=function(){return this}};k.generator.createGenerator=function(a,b){b=new k.generator.Generator_(new k.generator.Engine_(b));k.setPrototypeOf&&k.setPrototypeOf(b,a.prototype);return b};
k.asyncExecutePromiseGenerator=function(a){function b(b){return a.next(b)}function c(b){return a.throw(b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};k.asyncExecutePromiseGeneratorFunction=function(a){return k.asyncExecutePromiseGenerator(a())};k.asyncExecutePromiseGeneratorProgram=function(a){return k.asyncExecutePromiseGenerator(new k.generator.Generator_(new k.generator.Engine_(a)))};
k.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};k.stringPadding=function(a,b){a=void 0!==a?String(a):" ";return 0<b&&a?a.repeat(Math.ceil(b/a.length)).substring(0,b):""};
k.polyfill("String.prototype.padStart",function(a){return a?a:function(a,c){var b=k.checkStringArgs(this,null,"padStart");return k.stringPadding(c,a-b.length)+b}},"es8","es3");k.iteratorFromArray=function(a,b){k.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
k.polyfill("Array.prototype.values",function(a){return a?a:function(){return k.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");k.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");k.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
k.polyfill("Object.entries",function(a){return a?a:function(a){var b=[],d;for(d in a)k.owns(a,d)&&b.push([d,a[d]]);return b}},"es8","es3");k.polyfill("Object.values",function(a){return a?a:function(a){var b=[],d;for(d in a)k.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");function aa(a){throw Error(a);};const ca="function"===typeof BigInt&&"bigint"===typeof BigInt(0);ca&&BigInt(0);ca&&BigInt(1);ca&&BigInt(4294967295);ca&&BigInt(32);class da extends Error{}class m extends Map{constructor(a,b){super(b);this.supplier=a}get(a){let b=super.get(a);null==b&&super.set(a,b=this.supplier(a));return b}sortedKeys(a){return[...this.keys()].sort(a)}sortedEntries(a){return this.sortedKeys(a).map(a=>[a,this.get(a)])}}var ea;
(function(a){a.concat=function*(...a){for(const b of a)yield*b};a.isEmpty=function(a){return!!a[Symbol.iterator]().next().done};a.map=function*(a,c){for(const b of a)yield c(b)};a.filter=function*(a,c){for(const b of a)c(b)&&(yield b)};a.flatMap=function*(a,c){for(const b of a)yield*c(b)};a.count=function(a){let b=0;for(const c of a)b++;return b};a.take=function*(a,c){for(const b of a){if(0>--c)break;yield b}};a.first=function(a,c){for(const b of a)return b;if(2>arguments.length)throw Error(`Empty iterable: ${a}`);
return c};a.zip=function(a,c,d=(a,b)=>[a,b]){return{*[Symbol.iterator](){const b=a[Symbol.iterator](),f=c[Symbol.iterator]();let g,h;for(;g=b.next(),h=f.next(),!g.done&&!h.done;)yield d(g.value,h.value)}}}})(ea||(ea={}));function fa(a){return[...a]}class ha{constructor(){this.map=new Map}add(a){this.map.set(a.label,a)}has(a){return this.map.has(a.label)}delete(a){this.map.delete(a.label)}[Symbol.iterator](){return this.map.values()}}const ia=Symbol("Invalidated"),ka=Symbol("Size");
class la{constructor(a,b,c){this.ownerMap=a;this.ownerKey=b;this.currentSet=c}getCurrentSet(){if(!this.currentSet||this.currentSet[ia])this.currentSet=this.ownerMap.get(this.ownerKey)||new Set;return this.currentSet}mutateSet(a){const b=this.getCurrentSet(),c=b.size;try{return a(b)}finally{this.ownerMap[ka]+=b.size-c,b.size||(this.ownerMap.delete(this.ownerKey),b[ia]=!0)}}add(a){this.mutateSet(b=>b.add(a));return this}has(a){return this.getCurrentSet().has(a)}clear(){this.mutateSet(a=>a.clear())}delete(a){return this.mutateSet(b=>
b.delete(a))}[Symbol.iterator](){return this.getCurrentSet()[Symbol.iterator]()}values(){return this.getCurrentSet().values()}keys(){return this.getCurrentSet().keys()}entries(){return this.getCurrentSet().entries()}forEach(a,b){this.getCurrentSet().forEach(a,b)}get size(){return this.getCurrentSet().size}get [Symbol.toStringTag](){return"Set"}}Reflect.setPrototypeOf(la.prototype,Set.prototype);function ma(a){throw Error(`non-exhaustive check: ${a}`);}
class na{constructor(a){this._map=new Map;if(a)for(const [b,c,d]of a)this.set(b,c,d)}*[Symbol.iterator](){for(const [a,b]of this._map)for(const [c,d]of b)yield[a,c,d]}set(a,b,c){let d=this._map.get(a);d||this._map.set(a,d=new Map);d.set(b,c)}get(a,b){var c;return null===(c=this._map.get(a))||void 0===c?void 0:c.get(b)}has(a,b){var c;return(null===(c=this._map.get(a))||void 0===c?void 0:c.has(b))||!1}delete(a,b){const c=this._map.get(a);c&&(c.delete(b),c.size||this._map.delete(a))}row(a){var b;return null!==
(b=this._map.get(a))&&void 0!==b?b:new Map}}var pa;(function(a){a.NONE={get requested(){return!1},throwIfRequested(){},register(){return{unregister(){}}}};a.CANCELLED={get requested(){return!0},throwIfRequested(){throw Error("cancelled");},register(){return{unregister(){}}}}})(pa||(pa={}));class qa{constructor(a){this.table=a}op(a){const b=this.table[a];if(!b)throw Error(`Bad mnemonic: ${a}`);return b}argLen(a){switch(a){case "acc":case "imp":return 0;case "imm":case "rel":case "zpg":case "zpx":case "zpy":case "iny":return 1;case "abs":case "abx":case "aby":case "ind":case "inx":return 2}return ma(a)}}var ra;
(ra||(ra={})).P02=new qa({adc:{abs:109,abx:125,aby:121,imm:105,iny:113,inx:97,zpg:101,zpx:117},and:{abs:45,abx:61,aby:57,imm:41,iny:49,inx:33,zpg:37,zpx:53},asl:{abs:14,abx:30,acc:10,imp:10,zpg:6,zpx:22},bcc:{rel:144},bcs:{rel:176},beq:{rel:240},bit:{abs:44,zpg:36},bmi:{rel:48},bne:{rel:208},bpl:{rel:16},brk:{imp:0},bvc:{rel:80},bvs:{rel:112},clc:{imp:24},cld:{imp:216},cli:{imp:88},clv:{imp:184},cmp:{abs:205,abx:221,aby:217,imm:201,iny:209,inx:193,zpg:197,zpx:213},cpx:{abs:236,imm:224,zpg:228},cpy:{abs:204,
imm:192,zpg:196},dec:{abs:206,abx:222,zpg:198,zpx:214},dex:{imp:202},dey:{imp:136},eor:{abs:77,abx:93,aby:89,imm:73,iny:81,inx:65,zpg:69,zpx:85},inc:{abs:238,abx:254,zpg:230,zpx:246},inx:{imp:232},iny:{imp:200},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{abs:173,abx:189,aby:185,imm:169,iny:177,inx:161,zpg:165,zpx:181},ldx:{abs:174,aby:190,imm:162,zpg:166,zpy:182},ldy:{abs:172,abx:188,imm:160,zpg:164,zpx:180},lsr:{abs:78,abx:94,acc:74,imp:74,zpg:70,zpx:86},nop:{imp:234},ora:{abs:13,abx:29,aby:25,imm:9,
iny:17,inx:1,zpg:5,zpx:21},pha:{imp:72},php:{imp:8},pla:{imp:104},plp:{imp:40},rol:{abs:46,abx:62,acc:42,imp:42,zpg:38,zpx:54},ror:{abs:110,abx:126,acc:106,imp:106,zpg:102,zpx:118},rti:{imp:64},rts:{imp:96},sbc:{abs:237,abx:253,aby:249,imm:233,iny:241,inx:225,zpg:229,zpx:245},sec:{imp:56},sed:{imp:248},sei:{imp:120},sta:{abs:141,abx:157,aby:153,iny:145,inx:129,zpg:133,zpx:149},stx:{abs:142,zpg:134,zpy:150},sty:{abs:140,zpg:132,zpx:148},tax:{imp:170},tay:{imp:168},tsx:{imp:186},txa:{imp:138},txs:{imp:154},
tya:{imp:152}});var sa;(function(a){class b{next(){for(;;){this.sink||(this.sink=this.pump());const {value:a,done:b}=this.sink.next();if(!b)return a;this.sink=void 0}}}a.Abstract=b;a.concat=function(...a){let b;return{next:()=>{for(;;){b||(b=a.shift());if(!b)break;const c=b.next();if(c)return c;b=void 0}}}}})(sa||(sa={}));var n;
(function(a){function b(a,b){return a&&b&&a.token===b.token&&"grp"!==a.token&&a.str===b.str&&a.num===b.num?!0:!1}function c(a){switch(a.token){case "num":return`NUM[$${a.num.toString(16)}]`;case "str":return`STR[$${a.str}]`;case "lb":return"[";case "rb":return"]";case "grp":return"{";case "lc":return"{";case "rc":return"}";case "lp":return"(";case "rp":return")";case "eol":return"EOL";case "eof":return"EOF";case "ident":return a.str;case "cs":case "op":return`${a.str.toUpperCase()}`;default:ma(a)}}
function d(a){a=a.source;if(!a)return"";const b=a.parent?d({source:a.parent}):"";return`\n  at ${a.file}:${a.line}:${a.column}${b}`}function e(a){return c(a)+d(a)}function f(a,b){return g("ident","identifier",a,b)}function g(a,b,c,d){if(!c){if(!d)throw Error(`Expected ${b}`);throw Error(`Expected ${b} after ${e(d)}`);}if(c.token!==a)throw Error(`Expected ${b}: ${e(c)}`);return c.str}function h(a,c,d){for(;d<a.length;d++)if(b(a[d],c))return d;return-1}function l(a){let b=0;for(const c of a)"grp"===
c.token?b+=2+l(c.inner):b++;return b}a.LB={token:"lb"};a.LC={token:"lc"};a.LP={token:"lp"};a.RB={token:"rb"};a.RC={token:"rc"};a.RP={token:"rp"};a.EOL={token:"eol"};a.EOF={token:"eof"};a.DEFINE={token:"cs",str:".define"};a.DOT_EOL={token:"cs",str:".eol"};a.ELSE={token:"cs",str:".else"};a.ELSEIF={token:"cs",str:".elseif"};a.ENDIF={token:"cs",str:".endif"};a.ENDMAC={token:"cs",str:".endmac"};a.ENDMACRO={token:"cs",str:".endmacro"};a.ENDREP={token:"cs",str:".endrep"};a.ENDREPEAT={token:"cs",str:".endrepeat"};
a.ENDPROC={token:"cs",str:".endproc"};a.ENDSCOPE={token:"cs",str:".endscope"};a.LOCAL={token:"cs",str:".local"};a.MACRO={token:"cs",str:".macro"};a.REPEAT={token:"cs",str:".repeat"};a.SET={token:"cs",str:".set"};a.SKIP={token:"cs",str:".skip"};a.BYTE={token:"cs",str:".byte"};a.WORD={token:"cs",str:".word"};a.COLON={token:"op",str:":"};a.COMMA={token:"op",str:","};a.STAR={token:"op",str:"*"};a.IMMEDIATE={token:"op",str:"#"};a.ASSIGN={token:"op",str:"="};a.match=function(a,b){return a.token!==b.token?
!1:"num"===a.token||"str"===a.token?!0:a.str!==b.str?!1:!0};a.eq=b;a.name=c;a.at=d;a.nameAt=e;a.expectEol=function(b,c="end of line"){if(b)throw Error(`Expected ${c}: ${a.nameAt(b)}`);};a.expect=function(a,d,f){if(!d){if(!f)throw Error(`Expected ${c(a)}`);throw Error(`Expected ${c(a)} after ${e(d)}`);}if(!b(a,d))throw Error(`Expected ${c(a)}: ${e(d)}`);};a.expectIdentifier=f;a.expectString=function(a,b){return g("str","constant string",a,b)};a.identsFromCList=function(c){if(!c.length)return[];const d=
[];for(let f=0;f<=c.length;f+=2){const g=c[f];if("ident"!==(null===g||void 0===g?void 0:g.token)){if(g)throw Error(`Expected identifier: ${e(g)}`);throw Error(`Expected identifier after ${e(c[c.length-1])}`);}if(f+1<c.length&&!b(c[f+1],a.COMMA))throw Error(`Expected comma: ${e(c[f+1])}`);d.push(g.str)}return d};a.findBalanced=function(a,b){const c=a[b++].token;if("lp"!==c&&"lb"!==c)throw Error("non-grouping token");const d="lp"===c?"rp":"rb";let e=1;for(;b<a.length;b++){const f=a[b].token;e+=Number(f===
c)-Number(f===d);if(!e)return b}return-1};a.parseArgList=function(c,e=0,f=c.length){let g=[];const h=[g];let p=0;for(;e<f;e++){const f=c[e];if(!p&&b(f,a.COMMA))h.push(g=[]);else if(g.push(f),b(f,a.LP)&&p++,b(f,a.RP)&&0>--p)throw Error(`Unbalanced paren${d(f)}`);}return h};a.parseAttrList=function(c,g){const h=new Map;let l,p=[];if(g>=c.length)return h;if(!b(c[g],a.COLON))throw Error(`Unexpected: ${e(c[g])}`);for(g+=1;g<c.length;g++){const e=c[g];if(b(e,a.COLON)){if(null==l)throw Error(`Missing key${d(e)}`);
h.set(l,p);l=void 0;p=[]}else null==l?l=f(e):p.push(e)}null!=l?h.set(l,p):f(void 0,c[c.length-1]);return h};a.findComma=function(b,c){c=h(b,a.COMMA,c);return 0>c?b.length:c};a.find=h;a.count=l;a.isRegister=function(a,b){return"ident"===a.token&&a.str.toLowerCase()===b};a.str=function(b){switch(b.token){case "cs":case "ident":case "str":case "op":return b.str}throw Error(`Non-string token: ${a.nameAt(b)}`);};a.strip=function(a){delete a.source;return a}})(n||(n={}));new Set(".blank .const .defined .left .match .mid .right .tcount .xmatch".split(" "));var ta;
(function(a){function b(a,b){function c(a){return a.args?Object.assign({},a,{args:a.args.map(b=>d(b,a))}):a}function d(a,d){const e=a.source;a=b(a,c,d);e&&!a.source&&(a.source=e);return a}return d(a)}function c(a,b){const [c,e]=d(a,void 0===b?0:b);if(e<a.length)throw Error(`Garbage after expression: ${n.nameAt(a[e])}`);if(!c)throw Error("No expression?");return c}function d(a,b){function d(){const [a,[,,b]]=e.pop(),c=f.splice(f.length-b,b);if(c.length!==b)throw Error("shunting parse failed?");f.push(ua({op:a,
args:c}))}b=void 0===b?0:b;const e=[],f=[];for(var g=!0,h=b;h<a.length;h++){var l=a[h];if(g)if("cs"===l.token||"op"===l.token){var p=va.get(l.str);if(p=wa.get(null!==p&&void 0!==p?p:l.str))e.push([l.str,p]);else if("cs"===l.token){g=l.str;if(!xa.has(g))throw Error(`No such function: ${n.nameAt(l)}`);p=a[h+1];if("lp"!==(null===p||void 0===p?void 0:p.token))throw Error(`Bad funcall: ${n.nameAt(null!==p&&void 0!==p?p:l)}`);l=n.findBalanced(a,h+1);if(0>l)throw Error(`Never closed: ${n.nameAt(p)}`);p=
[];for(const b of n.parseArgList(a,h+2,l))p.push(c(b));h=l;f.push(ua({op:g,args:p}));g=!1}else if(n.eq(l,n.STAR))f.push({op:"sym",sym:"*"}),g=!1;else throw Error(`Unknown prefix operator: ${n.nameAt(l)}`);}else if("lp"===l.token){g=n.findBalanced(a,h);if(0>g)throw Error(`No close paren: ${n.nameAt(l)}`);h=c(a.slice(h+1,g));f.push(h);h=g;g=!1}else if("ident"===l.token)f.push({op:"sym",sym:l.str}),g=!1;else if("num"===l.token)l=l.num,f.push({op:"num",num:l,meta:ya(l)}),g=!1;else throw Error(`Bad expression token: ${n.nameAt(l)}`);
else{if(n.eq(l,n.COMMA))break;if("cs"===l.token||"op"===l.token){g=va.get(l.str);g=za.get(null!==g&&void 0!==g?g:l.str);if(!g)break;for(;e.length;){p=e[e.length-1];const a=Aa(p[1],g);if(0>a)break;if(0===a)throw Error(`Mixing ${p[0]} and ${l.str} needs explicit parens.${n.at(l)}`);d()}e.push([l.str,g]);g=!0}else break}}for(;e.length;)d();if(1!==f.length)throw Error("shunting parse failed?");a[b].source&&(f[0].source=a[b].source);return[f[0],h]}function e(a){if(null!=a)return{op:"num",num:a,meta:ya(a)}}
function f(a,b){const c=a.args[0];if(!q(c))return a;a=b(c.num);return{op:"num",num:a,meta:ya(a)}}function g(a,b){const [c,d]=a.args;if(!q(c)||!q(d))return a;a=b(c.num,d.num);return{op:"num",num:a,meta:ya(a)}}function h(a){var b,c,d,e,f,g;const [h,l]=a.args;if("num"!==h.op||"num"!==l.op)return a;const p={op:"num",num:h.num+l.num};if(h.meta||l.meta){if((null===(b=h.meta)||void 0===b?0:b.rel)&&(null===(c=l.meta)||void 0===c?0:c.rel))return a;if(null===(d=h.meta)||void 0===d?0:d.rel)p.meta=h.meta;else if(null===
(e=l.meta)||void 0===e?0:e.rel)p.meta=l.meta}null!==(f=p.meta)&&void 0!==f&&f.rel||null!=(null===(g=p.meta)||void 0===g?void 0:g.size)||((p.meta||(p.meta={})).size=ya(p.num).size);return p}function l(a){var b,c,d,e,f;const [g,h]=a.args;if("num"!==g.op||"num"!==h.op)return a;const l={op:"num",num:g.num-h.num};if(null===(b=h.meta)||void 0===b?0:b.rel)return(null===(c=g.meta)||void 0===c?0:c.rel)&&g.meta.chunk===h.meta.chunk?l:a;if(null===(d=g.meta)||void 0===d?0:d.rel)l.meta=g.meta;null!==(e=l.meta)&&
void 0!==e&&e.rel||null!=(null===(f=l.meta)||void 0===f?void 0:f.size)||((l.meta||(l.meta={})).size=ya(l.num).size);return l}function q(a){var b;return"num"===a.op&&!(null===(b=a.meta)||void 0===b?0:b.rel)}a.traverse=b;a.traversePost=function(a,c){return b(a,(a,b)=>c(b(a)))};a.evaluate=function(a){var b,c,d,p;switch(a.op){case ".move":case "im":case "sym":return a;case "num":return(null===(b=a.meta)||void 0===b?0:b.rel)&&null!=a.meta.org?(b=Object.assign({},a.meta),b=(delete b.rel,b),{op:"num",num:a.num+
b.org,meta:b}):a;case ".max":throw Error();case ".min":throw Error();}if(1===(null===(c=a.args)||void 0===c?void 0:c.length))switch(a.op){case "+":return a.args[0];case "-":return f(a,a=>-a);case "~":return f(a,a=>~a);case "!":return f(a,a=>+!a);case "<":return f(a,a=>a&255);case ">":return f(a,a=>a>>8&255);case "^":return null!==(p=e(null===(d=a.args[0].meta)||void 0===d?void 0:d.bank))&&void 0!==p?p:a;default:throw Error(`Unknown unary operator: ${a.op}`);}switch(a.op){case "+":return h(a);case "-":return l(a);
case "*":return g(a,(a,b)=>a*b);case "/":return g(a,(a,b)=>Math.floor(a/b));case ".mod":return g(a,(a,b)=>a%b);case "&":return g(a,(a,b)=>a&b);case "|":return g(a,(a,b)=>a|b);case "^":return g(a,(a,b)=>a^b);case "<<":return g(a,(a,b)=>a<<b);case ">>":return g(a,(a,b)=>a>>>b);case "<":return g(a,(a,b)=>+(a<b));case "<=":return g(a,(a,b)=>+(a<=b));case ">":return g(a,(a,b)=>+(a>b));case ">=":return g(a,(a,b)=>+(a>=b));case "=":return g(a,(a,b)=>+(a==b));case "<>":return g(a,(a,b)=>+(a!=b));case "&&":return g(a,
(a,b)=>a&&b);case "||":return g(a,(a,b)=>a||b);case ".xor":return g(a,(a,b)=>!a&&b||!b&&a||0);default:throw Error(`Unknown operator: ${a.op}`);}};a.identifier=function(a){if("sym"===a.op&&a.sym)return a.sym;throw Error(`Expected identifier but got op: ${a.op}`);};a.parseOnly=c;a.parse=d})(ta||(ta={}));function Aa(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:a[1]!==b[1]?0:a[1]}
const za=new Map([["*",[5,4,2]],["/",[5,4,2]],[".mod",[5,3,2]],["&",[5,2,2]],["^",[5,1,2]],["<<",[5,0,2]],[">>",[5,0,2]],["+",[4,2,2]],["-",[4,2,2]],["|",[4,1,2]],["<",[3,0,2]],["<=",[3,0,2]],[">",[3,0,2]],[">=",[3,0,2]],["=",[3,0,2]],["<>",[3,0,2]],["&&",[2,3,2]],[".xor",[2,2,2]],["||",[2,1,2]]]),wa=new Map([["+",[9,-1,1]],["-",[9,-1,1]],["~",[9,-1,1]],["<",[9,-1,1]],[">",[9,-1,1]],["^",[9,-1,1]],["!",[2,-1,1]]]),xa=new Set([".byteat",".wordat",".max",".min"]),va=new Map([[".bitand","&"],[".bitxor",
"^"],[".bitor","|"],[".shl","<<"],[".shr",">>"],[".and","&&"],[".or","||"],[".bitnot","~"],[".lobyte","<"],[".hibyte",">"],[".bankbyte","^"],[".not","!"]]),Ba=new Map([["^",(...a)=>1===a.length?1:Math.max(...a)],["<",()=>1],[">",()=>1],["!",()=>1],["<=",()=>1],[">=",()=>1],["<>",()=>1],["=",()=>1],["&",Math.max],["&&",Math.max],["|",Math.max],["||",Math.max],[".xor",Math.max],[".max",Math.max],[".min",Math.max]]);
function ua(a){var b=Ba.get(a.op);if(b=null===b||void 0===b?void 0:b(...a.args.map(a=>{var b;return Number(null===(b=a.meta)||void 0===b?void 0:b.size)})))(a.meta||(a.meta={})).size=b;return a}function ya(a){return{size:0<=a&&256>a?1:2}};var Da;(function(a){a.merge=function(a,c){const b=Object.assign({},a,c);a=[...a.free||[],...c.free||[]];a.length&&(b.free=a);return b}})(Da||(Da={}));class Ea{constructor(a,b,c,d,e){this.line=a;this.column=b;this.prefix=c;this.remainder=d;this.match=e}}
class Fa{constructor(a,b=0,c=0){this.content=a;this.line=b;this.column=c;this.prefix="";this.remainder=a}advance(a){const b=this.remainder.substring(0,a.length);if(a!==b)throw Error(`Non-rooted token: '${a}' vs '${b}'`);this.prefix+=a;this.remainder=this.remainder.substring(a.length);a=a.split(/\n/g);1<a.length&&(this.line+=a.length-1,this.column=0);this.column+=a[a.length-1].length}saveState(){return new Ea(this.line,this.column,this.prefix,this.remainder,this.lastMatch)}restoreState(a){this.line=
a.line;this.column=a.column;this.prefix=a.prefix;this.remainder=a.remainder;this.lastMatch=a.match}skip(a){a=a.exec(this.remainder);if(!a)return!1;this.advance(a[0]);return!0}space(){return this.skip(/^[ \t]+/)}newline(){return this.skip(/^\n/)}lookingAt(a){return"string"===typeof a?this.remainder.startsWith(a):a.test(this.remainder)}token(a){if("string"===typeof a){if(!this.remainder.startsWith(a))return!1;a=[a]}else a=a.exec(this.remainder);if(!a)return!1;a.line=this.line;a.column=this.column;this.lastMatch=
a;this.advance(a[0]);return!0}lookBehind(a){if("string"===typeof a)return this.prefix.endsWith(a);a=a.exec(this.prefix);if(!a)return!1;a.line=this.line;a.column=this.line;this.lastMatch=a;return!0}match(){return this.lastMatch}group(a=0){var b;return null===(b=this.lastMatch)||void 0===b?void 0:b[a]}eof(){return!this.remainder}};class Ga{constructor(a,b="input.s",c={}){this.file=b;this.opts=c;this.buffer=new Fa(a)}next(){for(var a=this.token();n.eq(a,n.EOL);)a=this.token();var b=[[]];let c=0;for(;!n.eq(a,n.EOL)&&!n.eq(a,n.EOF);){if(n.eq(a,n.LC))b[c++].push(a),b.push([]);else if(n.eq(a,n.RC)){if(!c)throw Error(`Missing open curly: ${n.nameAt(a)}`);var d=b.pop();a=b[--c].pop().source;d={token:"grp",inner:d};a&&(d.source=a);b[c].push(d)}else b[c].push(a);a=this.token()}if(c)throw b=b[c-1].pop(),Error(`Missing close curly: ${n.nameAt(b)}`);
return b[0].length?b[0]:void 0}token(){for(;this.buffer.space()||this.buffer.token(/^;.*/)||this.opts.lineContinuations&&this.buffer.token(/^\\\n/););if(this.buffer.eof())return n.EOF;var a={file:this.file,line:this.buffer.line,column:this.buffer.column};try{const b=this.tokenInternal();this.opts.skipSourceAnnotations||(b.source=a);return b}catch(b){const {file:c,line:d,column:e}=a;a=(a=this.buffer.group())?` near '${a}'`:"";b.message+=`\n  at ${c}:${d}:${e}${a}`;throw b;}}tokenInternal(){if(this.buffer.newline())return{token:"eol"};
if(this.buffer.token(/^@+[a-z0-9_]*/i)||this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i))return this.strTok("ident");if(this.buffer.token(/^\.[a-z]+/i))return this.strTok("cs");if(this.buffer.token(/^:(\++|-+)/))return this.strTok("ident");if(this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/))return this.strTok("op");if(this.buffer.token("["))return{token:"lb"};if(this.buffer.token("{"))return{token:"lc"};if(this.buffer.token("("))return{token:"lp"};if(this.buffer.token("]"))return{token:"rb"};
if(this.buffer.token("}"))return{token:"rc"};if(this.buffer.token(")"))return{token:"rp"};if(this.buffer.token(/^["']/))return this.tokenizeStr();if(this.buffer.token(/^[$%]?[0-9a-z_]+/i))return this.tokenizeNum();throw Error("Syntax error");}tokenizeStr(){const a=this.buffer,b=a.match()[0];let c="";for(;!a.lookingAt(b);){if(a.eof())throw Error(`EOF while looking for ${b}`);a.token(/^\\u([0-9a-f]{4})/i)?c+=String.fromCodePoint(parseInt(a.group(1),16)):a.token(/^\\x([0-9a-f]{2})/i)?c+=String.fromCharCode(parseInt(a.group(1),
16)):a.token(/^\\(.)/)?c+=a.group(1):(a.token(/^./),c+=a.group(0))}a.token(b);return{token:"str",str:c}}strTok(a){return{token:a,str:this.buffer.group()}}tokenizeNum(a=this.buffer.group()){this.opts.numberSeparators&&(a=a.replace(/_/g,""));if("$"===a[0]){a=a.substring(1);if(!/^[0-9a-f]+$/i.test(a))throw Error(`Bad hex number: $${a}`);return{token:"num",num:Number.parseInt(a,16)}}if("%"===a[0]){a=a.substring(1);if(!/^[01]+$/.test(a))throw Error(`Bad binary number: %${a}`);return{token:"num",num:Number.parseInt(a,
2)}}if("0"===a[0]){if(!/^[0-7]+$/.test(a))throw Error(`Bad octal number: ${a}`);return{token:"num",num:Number.parseInt(a,8)}}if(!/^[0-9]+$/.test(a))throw Error(`Bad decimal number: ${a}`);return{token:"num",num:Number.parseInt(a,10)}}};class Ha{constructor(){this.symbols=new Map}pickScope(a){return[a,this]}resolve(a,b){const [c,d]=this.pickScope(a);let e=d.symbols.get(c);if(e)return c!==a&&(e.scoped=!0),e;if(b)return b={},d.symbols.set(c,b),c!==a&&(b.scoped=!0),b}}
class Ia extends Ha{constructor(a,b){super();this.parent=a;this.kind=b;this.children=new Map;this.anonymousChildren=[];this.global=a?a.global:this}pickScope(a){var b=this;a=a.split(/::/g);const c=a.pop();for(let c=0;c<a.length;c++){if(!c&&!a[c]){b=b.global;continue}let d=b.children.get(a[c]);for(;!c&&b.parent&&!d;)d=(b=b.parent).children.get(a[c]);if(!d)throw b=a.slice(0,c+1).join("::"),Error(`Could not resolve scope ${b}`);b=d}return[c,b]}}
class Ka extends Ha{clear(){for(var a of this.symbols){const [b,c]=a;if(!c.expr)throw a=c.ref?n.at(c.ref):"",Error(`Cheap local label never defined: ${b}${a}`);}this.symbols.clear()}}
class La{constructor(a,b){a=void 0===a?ra.P02:a;b=void 0===b?{}:b;this.cpu=a;this.opts=b;this.segments=["code"];this.segmentData=new Map;this.segmentStack=[];this.symbols=[];this.globals=new Map;this.currentScope=new Ia;this.cheapLocals=new Ka;this.anonymousForward=[];this.anonymousReverse=[];this.relativeForward=[];this.relativeReverse=[];this.chunks=[];this._org=this._name=this._chunk=void 0;this._segmentPrefix=""}get chunk(){this.ensureChunk();return this._chunk}ensureChunk(){this._chunk||(this._chunk=
{segments:this.segments,data:[]},null!=this._org&&(this._chunk.org=this._org),this._name&&(this._chunk.name=this._name),this.chunks.push(this._chunk))}definedSymbol(a){let b=this.currentScope;const c=!a.includes("::");do{const c=b.resolve(a,!1);if(c)return!!c.expr}while(c&&(b=b.parent));return!1}constantSymbol(a){a=this.currentScope.resolve(a,!1);return!(!a||!a.expr||0>a.id)}referencedSymbol(a){return null!=this.currentScope.resolve(a,!1)}evaluate(a){var b;a=this.resolve(a);if("num"===a.op&&(null===
(b=a.meta)||void 0===b||!b.rel))return a.num}pc(){var a;const b=this.chunk.data.length,c={rel:!0,chunk:this.chunks.length-1};null!=(null===(a=this._chunk)||void 0===a?void 0:a.org)&&(c.org=this._chunk.org);return ta.evaluate({op:"num",num:b,meta:c})}resolve(a){return ta.traverse(a,(a,c)=>{for(;"sym"===a.op&&a.sym;)a=this.resolveSymbol(a.sym);return ta.evaluate(c(a))})}resolveSymbol(a){if("*"===a)return this.pc();if(/^:\++$/.test(a)){a=a.length-2;var b=this.anonymousForward[a];if(null!=b)return{op:"sym",
num:b};this.anonymousForward[a]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^\++$/.test(a)){b=this.relativeForward[a.length-1];if(null!=b)return{op:"sym",num:b};this.relativeForward[a.length-1]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^:-+$/.test(a))return b=this.anonymousReverse.length-a.length+1,0>b&&this.fail(`Bad anonymous backref: ${a}`),this.anonymousReverse[b];if(/^-+$/.test(a))return b=this.relativeReverse[a.length-1],null==
b&&this.fail(`Bad relative backref: ${a}`),b;a=(a.startsWith("@")?this.cheapLocals:this.currentScope).resolve(a,!0);if(a.expr)return a.expr;null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));return{op:"sym",num:a.id}}chunkData(a){return{org:this.chunks[a].org}}closeScopes(){function a(b){for(var c of b.children.values())a(c);for(const c of b.anonymousChildren)a(c);for(const a of b.symbols){const [d,f]=a;if(!f.expr&&null!=f.id&&b.parent){if(f.scoped)throw Error(`Symbol '${d}' undefined`);
if(c=b.parent.symbols.get(d))if(null!=c.id)f.expr={op:"sym",num:c.id};else if(c.expr)f.expr=c.expr;else throw Error(`Impossible: ${d}`);else b.parent.symbols.set(d,f)}}}this.cheapLocals.clear();if(this.currentScope.parent)throw Error("Scope never closed");a(this.currentScope);for(const a of this.globals){const [b,d]=a;{const a=this.currentScope.symbols.get(b);if("export"===d){if(null===a||void 0===a||!a.expr)throw Error(`Symbol '${b}' undefined`);null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));
a.export=b}else if("import"===d){if(a){if(a.expr)throw Error(`Already defined: ${b}`);a.expr={op:"im",sym:b}}}else ma(d)}}for(const a of this.currentScope.symbols){const [b,d]=a;if(!d.expr)throw Error(`Symbol '${b}' undefined`);}}module(){this.closeScopes();const a=[];for(var b of this.chunks)a.push(Object.assign({},b,{data:Uint8Array.from(b.data)}));b=[];for(var c of this.symbols){if(null==c.expr)throw Error("Symbol undefined");const a={expr:c.expr};null!=c.export&&(a.export=c.export);b.push(a)}c=
[...this.segmentData.values()];return{chunks:a,symbols:b,segments:c}}line(a){this._source=a[0].source;3>a.length&&n.eq(a[a.length-1],n.COLON)?this.label(a[0]):n.eq(a[1],n.ASSIGN)?this.assign(n.str(a[0]),this.parseExpr(a,2)):n.eq(a[1],n.SET)?this.set(n.str(a[0]),this.parseExpr(a,2)):"cs"===a[0].token?this.directive(a):this.instruction(a)}tokens(a){let b;for(;b=a.next();)this.line(b)}tokensAsync(a){const b=this;return k.asyncExecutePromiseGeneratorFunction(function*(){let c;for(;c=yield a.nextAsync();)b.line(c)})}directive(a){switch(n.str(a[0])){case ".org":return this.org(this.parseConst(a));
case ".reloc":return this.parseNoArgs(a),this.reloc();case ".assert":return this.assert(this.parseExpr(a));case ".segment":return this.segment(...this.parseSegmentList(a));case ".byte":return this.byte(...this.parseDataList(a,!0));case ".res":return this.res(...this.parseResArgs(a));case ".word":return this.word(...this.parseDataList(a));case ".free":return this.free(this.parseConst(a),a[0]);case ".segmentprefix":return this.segmentPrefix(this.parseStr(a));case ".import":return this.import(...this.parseIdentifierList(a));
case ".export":return this.export(...this.parseIdentifierList(a));case ".scope":return this.scope(this.parseOptionalIdentifier(a));case ".endscope":return this.parseNoArgs(a),this.endScope();case ".proc":return this.proc(this.parseRequiredIdentifier(a));case ".endproc":return this.parseNoArgs(a),this.endProc();case ".pushseg":return this.pushSeg(...this.parseSegmentList(a));case ".popseg":return this.parseNoArgs(a),this.popSeg();case ".move":return this.move(...this.parseMoveArgs(a))}this.fail(`Unknown directive: ${n.nameAt(a[0])}`)}label(a){let b;
const c=this.pc();if("string"===typeof a)var d=a;else d=n.str(b=a),a.source&&(c.source=a.source);":"===d?(this.anonymousReverse.push(c),d=this.anonymousForward.shift(),null!=d&&(this.symbols[d].expr=c)):/^\++$/.test(d)?(a=this.relativeForward[d.length-1],delete this.relativeForward[d.length-1],null!=a&&(this.symbols[a].expr=c)):/^-+$/.test(d)?this.relativeReverse[d.length-1]=c:(d.startsWith("@")||(this.cheapLocals.clear(),this.chunk.name||this.chunk.data.length||(this.chunk.name=d)),this.assignSymbol(d,
!1,c,b))}assign(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!1,b)}set(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!0,b)}assignSymbol(a,b,c,d){"number"===typeof c&&(c={op:"num",num:c});const e=a.startsWith("@")?this.cheapLocals:this.currentScope;let f=e.resolve(a,!b);if(f&&b!==0>f.id)this.fail(`Cannot change mutability of ${a}`,
d);else if(b&&"num"!=c.op)this.fail("Mutable set requires constant",d);else if(!f){if(!b)throw Error("impossible");e.symbols.set(a,f={id:-1})}else if(!b&&f.expr)throw b=f.expr.source?`\nOriginally defined${n.at(f.expr)}`:"",a=d?n.nameAt(d):a+(this._source?n.at({source:this._source}):""),Error(`Redefining symbol ${a}${b}`);f.expr=c}instruction(...a){var b;let c;1===a.length&&Array.isArray(a[0])?(a=a[0],c=n.expectIdentifier(a[0]).toLowerCase(),a=this.parseArg(a)):"string"===typeof a[1]?(c=a[0],a=new Ga(a[1]),
a=this.parseArg(a.next(),0)):([c,a]=a,a||(a=["imp"]),c=c.toLowerCase());const d=this.cpu.op(c),e=a[0];if("add"===e||"a,x"===e||"a,y"===e){const f=a[1],g=(null===(b=f.meta)||void 0===b?void 0:b.size)||2;if("add"===e&&1===g&&"zpg"in d)return this.opcode(d.zpg,1,f);if("add"===e&&"abs"in d)return this.opcode(d.abs,2,f);if("add"===e&&"rel"in d)return this.relative(d.rel,1,f);if("a,x"===e&&1===g&&"zpx"in d)return this.opcode(d.zpx,1,f);if("a,x"===e&&"abx"in d)return this.opcode(d.abx,2,f);if("a,y"===e&&
1===g&&"zpy"in d)return this.opcode(d.zpy,1,f);if("a,y"===e&&"aby"in d)return this.opcode(d.aby,2,f);this.fail(`Bad address mode ${e} for ${c}`)}if(e in d)return b=this.cpu.argLen(e),"rel"===e?this.relative(d[e],b,a[1]):this.opcode(d[e],b,a[1]);this.fail(`Bad address mode ${e} for ${c}`)}parseArg(a,b){b=void 0===b?1:b;if(a.length===b)return["imp"];const c=a[b];var d=a[b+1];if(a.length===b+1){if(n.isRegister(c,"a"))return["acc"]}else if(n.eq(c,n.IMMEDIATE))return["imm",ta.parseOnly(a,b+1)];if(n.eq(c,
n.COLON)&&a.length===b+2&&"op"===d.token&&/^[-+]+$/.test(d.str))return["add",{op:"sym",sym:":"+d.str}];if(a.length===b+1&&"op"===c.token&&/^[-+]+$/.test(c.str))return["add",{op:"sym",sym:c.str}];if(n.eq(c,n.LP)||this.opts.allowBrackets&&n.eq(c,n.LB)){d=n.findBalanced(a,b);0>d&&this.fail(`Unbalanced ${n.name(c)}`,c);const e=n.parseArgList(a,b+1,d);e.length||this.fail("Bad argument",c);const f=ta.parseOnly(e[0]);if(1===e.length){if(n.eq(a[d+1],n.COMMA)&&n.isRegister(a[d+2],"y"))return n.expectEol(a[d+
3]),["iny",f];n.expectEol(a[d+1]);return["ind",f]}if(2===e.length&&1===e[1].length&&n.isRegister(e[1][0],"x"))return["inx",f];this.fail("Bad argument",c)}a=n.parseArgList(a,b);a.length||this.fail("Bad arg",c);b=ta.parseOnly(a[0]);if(1===a.length)return["add",b];if(2===a.length&&1===a[1].length){if(n.isRegister(a[1][0],"x"))return["a,x",b];if(n.isRegister(a[1][0],"y"))return["a,y",b]}this.fail("Bad arg",c)}relative(a,b,c){var d;const e=this.chunk.data.length+b+1,f={rel:!0,chunk:this.chunks.length-
1};if(null===(d=this._chunk)||void 0===d?0:d.org)f.org=this._chunk.org;d={op:"-",args:[c,{op:"num",num:e,meta:f}]};c.source&&(d.source=c.source);this.opcode(a,b,d)}opcode(a,b,c){b&&(c=this.resolve(c));const {chunk:d}=this;d.data.push(a);b&&this.append(c,b);d.name||(d.name="Code")}append(a,b){var c;const {chunk:d}=this;a=this.resolve(a);let e=a.num;"num"!==a.op||(null===(c=a.meta)||void 0===c?0:c.rel)?(c=d.data.length,(d.subs||(d.subs=[])).push({offset:c,size:b,expr:a}),this.writeNumber(d.data,b)):
this.writeNumber(d.data,b,e)}org(a,b){this._org=a;this._chunk=void 0;this._name=b}reloc(a){this._chunk=this._org=void 0;this._name=a}segment(...a){this.segments=a.map(a=>"string"===typeof a?a:a.name);for(const b of a)"object"===typeof b&&(a=this.segmentData.get(b.name)||{name:b.name},this.segmentData.set(b.name,Da.merge(a,b)));this._name=this._chunk=void 0}assert(a){a=this.resolve(a);var b=this.evaluate(a);if(null!=b){if(!b){b="";const c=this.chunk;null!=c.org&&(b=` (PC=$${(c.org+c.data.length).toString(16)})`);
this.fail(`Assertion failed${b}`,a)}}else({chunk:b}=this),(b.asserts||(b.asserts=[])).push(a)}byte(...a){const {chunk:b}=this;for(const d of a)if("number"===typeof d)this.writeNumber(b.data,1,d);else if("string"===typeof d){a=b.data;var c=d;for(let b=0;b<c.length;b++)a.push(c.charCodeAt(b))}else this.append(d,1)}res(a,b){a&&this.byte(...Array(a).fill(null!==b&&void 0!==b?b:0))}word(...a){const {chunk:b}=this;for(const c of a)"number"===typeof c?this.writeNumber(b.data,2,c):this.append(c,2)}free(a,
b){null==this._org&&this.fail(".free in .reloc mode",b);var c=1<this.segments.length?this.segments.filter(a=>{a=this.segmentData.get(a);return!a||null==a.memory||null==a.size||a.memory>this._org||a.memory+a.size<=this._org?!1:!0}):this.segments;1!==c.length?this.fail(`.free with non-unique segment: ${this.segments}`,b):0>a&&this.fail(`.free with negative size: ${a}`,b);this._chunk&&(this._org+=this._chunk.data.length);this._chunk=void 0;b=c[0];(c=this.segmentData.get(b))||this.segmentData.set(b,c=
{name:b});(c.free||(c.free=[])).push([this._org,this._org+a]);this._org+=a}segmentPrefix(a){this._segmentPrefix=a}import(...a){for(const b of a)this.globals.set(b,"import")}export(...a){for(const b of a)this.globals.set(b,"export")}scope(a){this.enterScope(a,"scope")}proc(a){this.label(a);this.enterScope(a,"proc")}enterScope(a,b){const c=a?this.currentScope.children.get(a):void 0;if(c){if(this.opts.reentrantScopes){this.currentScope=c;return}this.fail(`Cannot re-enter scope ${a}`)}b=new Ia(this.currentScope,
b);a?this.currentScope.children.set(a,b):this.currentScope.anonymousChildren.push(b);this.currentScope=b}endScope(){this.exitScope("scope")}endProc(){this.exitScope("proc")}exitScope(a){this.currentScope.kind===a&&this.currentScope.parent||this.fail(`.end${a} without .${a}`);this.currentScope=this.currentScope.parent}pushSeg(...a){this.segmentStack.push([this.segments,this._chunk]);this.segment(...a)}popSeg(){this.segmentStack.length||this.fail(".popseg without .pushseg");[this.segments,this._chunk]=
this.segmentStack.pop()}move(a,b){this.append({op:".move",args:[b],meta:{size:a}},a)}parseConst(a,b){b=this.evaluate(ta.parseOnly(a,void 0===b?1:b));if(null!=b)return b;this.fail("Expression is not constant",a[1])}parseNoArgs(a){n.expectEol(a[1])}parseExpr(a,b){return ta.parseOnly(a,void 0===b?1:b)}parseStr(a,b){b=void 0===b?1:b;const c=n.expectString(a[b]);n.expectEol(a[b+1],"a single string");return c}parseSegmentList(a,b){b=void 0===b?1:b;a.length<b+1&&this.fail("Expected a segment list",a[b-1]);
return n.parseArgList(a,1).map(a=>{var b=this._segmentPrefix+n.expectString(a[0]);if(1===a.length)return b;n.eq(a[1],n.COLON)||this.fail(`Expected comma or colon: ${n.name(a[1])}`,a[1]);b={name:b};a=n.parseAttrList(a,1);for(const c of a){const [a,d]=c;switch(a){case "bank":b.bank=this.parseConst(d,0);break;case "size":b.size=this.parseConst(d,0);break;case "off":b.offset=this.parseConst(d,0);break;case "mem":b.memory=this.parseConst(d,0);break;default:this.fail(`Unknown segment attr: ${a}`)}}return b})}parseResArgs(a){a=
this.parseDataList(a);2<a.length&&this.fail("Expected at most 2 args",a[2]);a.length||this.fail("Expected at least 1 arg");const b=this.evaluate(a[0]);null==b&&this.fail("Expected constant count");const c=a[1]&&this.evaluate(a[1]);a[1]&&null==c&&this.fail("Expected constant value");return[b,c]}parseDataList(a,b){b=void 0===b?!1:b;2>a.length&&this.fail("Expected a data list",a[0]);const c=[];for(const d of n.parseArgList(a,1))b&&1===d.length&&"str"===d[0].token?c.push(d[0].str):c.push(this.resolve(ta.parseOnly(d)));
return c}parseIdentifierList(a){2>a.length&&this.fail("Expected identifier(s)",a[0]);const b=[];for(const c of n.parseArgList(a,1))1===c.length&&"ident"===c[0].token||this.fail(`Expected identifier: ${n.name(c[0])}`,c[0]),b.push(n.str(c[0]));return b}parseOptionalIdentifier(a){var b=a[1];if(b)return b=n.expectIdentifier(b),n.expectEol(a[2]),b}parseRequiredIdentifier(a){const b=n.expectIdentifier(a[1]);n.expectEol(a[2]);return b}parseMoveArgs(a){var b;a=n.parseArgList(a,1);2!==a.length&&this.fail("Expected constant number, then identifier");
const c=this.evaluate(ta.parseOnly(a[0]));null==c&&this.fail("Expected a constant number");const d=this.resolve(ta.parseOnly(a[1]));if("num"===d.op&&null!=(null===(b=d.meta)||void 0===b?void 0:b.chunk))return[c,d];this.fail("Expected a constant offset",a[1][0])}fail(a,b){var c;if(null===b||void 0===b?0:b.source)throw Error(a+n.at(b));if(!this._source&&(null===(c=this._chunk)||void 0===c?0:c.name))throw Error(a+`\n  in ${this._chunk.name}`);throw Error(a+n.at({source:this._source}));}writeNumber(a,
b,c){var d=b<<3;null!=c&&(c<-1<<d||c>=1<<d)&&this.fail(`Not a ${["byte","word","farword","dword"][b-1]}: $${c.toString(16)}`);for(d=0;d<b;d++)a.push(null!=c?c&255:255),null!=c&&(c>>=8)}};function Ma(a,b){if(!a)return-1;var c=b(0),d=b(a-1);if(0>c)return-1;if(0===c)return 0;if(0<d)return~a;if(0===d)return a-1;c=0;for(--a;1<a-c;){d=c+a>>1;const e=b(d);if(0<e)c=d;else if(0>e)a=d;else return d}return~a}function Na(a,b,c){const d=b(c),e=Ma(a.length,c=>d<b(a[c])?-1:1);a.splice(~e,0,c)}
class Pa{constructor(){this._chunks=[];this._length=0}get length(){return this._length}_find(a){return Ma(this._chunks.length,b=>{const [c,d]=this._chunks[b];return a<c?-1:a>=c+d.length?1:0})}apply(a){if(a.length<this._length)throw Error("Target too small.");for(const [b,c]of this._chunks)for(let d=0;d<c.length;d++)a[b+d]=c[d]}chunks(){return this._chunks}get(a){let b=this._find(a);if(!(0>b)){var [c,d]=this._chunks[b];return d[a-c]}}set(a,...b){this.setInternal(a,b)}setInternal(a,b){var c;if(b.length){var d=
a+b.length;this._length=Math.max(this._length,d);var e=this._find(a),f=this._find(d);if(0<=e&&e===f){const [c,d]=this._chunks[e];for(f=0;f<b.length;f++)d[a+f-c]=b[f]}else{var g=this._chunks[~e-1];g&&g[0]+g[1].length===a&&(e=~e-1);(null===(c=this._chunks[~f])||void 0===c?void 0:c[0])===d&&(f=~f);if(0<=e){const [d,l]=this._chunks[e];f===e&&Array.isArray(b)?b.unshift(...l.slice(0,a-d)):(c=l,a-=d,g=c.length,b.length<g||!Array.isArray(b)?(c.splice(a,g-a,...b),b=c):b.unshift(...Qa(c,a)));a=d}if(0<=f){const [a,
e]=this._chunks[f];d-=a;c=e;b.length<c.length||!Array.isArray(b)?(c.splice(0,d,...b),b=c):b.push(...Sa(c,d))}e=0>e?~e:e;d=0>f?~f:f;0<=f&&d++;Array.isArray(b)||(b=Array.from(b));this._chunks.splice(e,d-e,[a,b])}}}splice(a,b=1){const c=a+b;var d=this._find(a);b=this._find(c);var e=0<=d?this._chunks[d]:void 0;let f=0<=b?this._chunks[b]:void 0;e&&((a-=e[0])?e=[e[0],e===f?e[1].slice(0,a):Qa(e[1],a)]:(e=void 0,d=~d));f&&(f=[c,Sa(f[1],c-f[0])],f[1].length||(f=void 0,b=~b));a=[];e&&a.push(e);f&&a.push(f);
d=0>d?~d:d;e=0>b?~b:b;0<=b&&e++;this._chunks.splice(d,e-d,...a)}slice(a,b){if(b<=a)return[];const c=this._find(a);if(0>c)throw Error(`Absent: ${a}`);const [d,e]=this._chunks[c];if(d+e.length<b)throw Error(`Absent: ${d+e.length}`);return e.slice(a-d,b-d)}}
class Ta extends Pa{set(a,...b){this.setInternal(a,b[0]instanceof Uint8Array?b[0]:Uint8Array.from(b))}search(a,b,c){return this.pattern(a).search(b,c)}pattern(a){function b(b){for(let c=b,e=0;c<d;++c,++e)if(a[c]!==a[e])return!1;return!0}function c(b){let c=0;for(let e=b,f=d-1;0<=e&&a[e]===a[f];--e,--f)++c;return c}if(!a.length)return{search:(a=0)=>a};const d=a.length,e=Array(256).fill(d);for(var f=0;f<a.length;f++)e[a[f]]=d-1-f;const g=[];f=d;for(let a=d;0<a;--a){b(a)&&(f=a);g[d-a]=f-a+d;for(let a=
0;a<d-1;++a){const b=c(a);g[b]=d-1-a+b}}return{search:(b=0,c=this._length)=>{if(!this._chunks.length||c<b)return-1;let f=this._find(b),h=0;for(0<=f?h=b-this._chunks[f][0]:f=~f;f<this._chunks.length;){const [l,p]=this._chunks[f++];b=Math.min(c-l,p.length);if(0>b)break;for(let c=d-1+h,f;c<b;){for(f=d-1;a[f]===p[c];--c,--f)if(0===f)return c+l;c+=Math.max(g[d-1-f],e[p[c]])}h=0}return-1}}}addOffset(a){const b=new Ta;for(const [c,d]of this._chunks)b._chunks.push([c+a,d]);return b}toIpsPatch(){var a=8;for(var [,
b]of this._chunks)a+=5+b.length;a=new Uint8Array(a);b=5;a[0]=80;a[1]=65;a[2]=84;a[3]=67;a[4]=72;for(const [c,d]of this._chunks){if(65535<d.length)throw Error("Oops!");a[b++]=c>>>16;a[b++]=c>>>8&255;a[b++]=c&255;a[b++]=d.length>>>8;a[b++]=d.length&255;a.subarray(b,b+d.length).set(d);b+=d.length}a[b]=69;a[b+1]=79;a[b+2]=70;return a}toIpsHexString(){const a=[...this.toIpsPatch()],b=[];for(let c=0;c<a.length;c+=16)b.push([c.toString(16).padStart(8,"0")+":",...a.slice(c,c+16).map(a=>a.toString(16).padStart(2,
"0"))].join(" "));return b.join("\n")}}function Qa(a,b){const c=a.length;if(b<<1<c)return a.slice(0,b);a.splice(b,c-b);return a}function Sa(a,b){return b<<1<a.length?(a.splice(0,b),a):a.slice(b)}
class Ua{constructor(){this.data=[]}[Symbol.iterator](){return this.data[Symbol.iterator]()}_find(a){return Ma(this.data.length,b=>{b=this.data[b];return a<b[0]?-1:a>=b[1]?1:0})}has(a){return 0<=this._find(a)}add(a,b){var c,d,e=this._find(a);let f=this._find(b);(null===(c=this.data[~e-1])||void 0===c?void 0:c[1])===a&&(e=~e-1);(null===(d=this.data[~f])||void 0===d?void 0:d[0])===b&&(f=~f);a=[a,b];0<=e&&(a[0]=this.data[e][0]);0<=f&&(a[1]=this.data[f][1]);e=0>e?~e:e;b=0>f?~f:f;0<=f&&b++;this.data.splice(e,
b-e,a)}delete(a,b){var c=this._find(a);let d=this._find(b);var e=0<=c?this.data[c]:void 0;let f=0<=d?this.data[d]:void 0;e&&(e=[e[0],Math.min(e[1],a)],e[0]===e[1]&&(e=void 0,c=~c));f&&(f=[Math.max(f[0],b),f[1]],f[0]===f[1]&&(f=void 0,d=~d));a=[];e&&a.push(e);f&&a.push(f);c=0>c?~c:c;e=0>d?~d:d;0<=d&&e++;this.data.splice(c,e-c,...a)}tail(a){let b=this._find(a);0>b&&(b=~b);const c=this.data;return{[Symbol.iterator](){return this},next(){if(b>=c.length)return{value:void 0,done:!0};const d=c[b++];return{value:[Math.max(a,
d[0]),d[1]],done:!1}}}}};class Va{constructor(){this._link=new Wa}static link(...a){const b=new Va;for(const c of a)b.read(c);return b.link()}read(a){this._link.readFile(a);return this}base(a,b){this._link.base(a,void 0===b?0:b);return this}link(){return this._link.link()}report(a){console.log(this._link.report(void 0===a?!1:a))}exports(){return this._exports?this._exports:this._exports=this._link.buildExports()}watch(...a){this._link.watches.push(...a)}}function Xa(a){throw Error(a);}
class Ya{constructor(a){var b,c,d,e,f;const g=this.name=a.name;this.bank=null!==(b=a.bank)&&void 0!==b?b:0;this.addressing=null!==(c=a.addressing)&&void 0!==c?c:2;this.size=null!==(d=a.size)&&void 0!==d?d:Xa(`Size must be specified: ${g}`);this.offset=null!==(e=a.offset)&&void 0!==e?e:Xa(`OFfset must be specified: ${g}`);this.memory=null!==(f=a.memory)&&void 0!==f?f:Xa(`OFfset must be specified: ${g}`)}get delta(){return this.offset-this.memory}}
class Za{constructor(a,b,c,d,e){this.linker=a;this.index=b;this.subs=new Set;this.selfSubs=new Set;this.deps=new Set;this.imports=new Set;this.follow=new Map;this.overlaps=!1;this.name=c.name;this.size=c.data.length;this.segments=c.segments;this._data=c.data;for(const a of c.subs||[])this.subs.add($a(a,d,e));this.asserts=(c.asserts||[]).map(a=>cb(a,d,e));c.org&&(this._org=c.org)}get org(){return this._org}get offset(){return this._offset}get segment(){return this._segment}get data(){var a;return null!==
(a=this._data)&&void 0!==a?a:Xa("no data")}initialPlacement(){if(null!=this._org){var a=[];for(const b of this.segments){const c=this.linker.segments.get(b);if(!c)throw Error(`Unknown segment: ${b}`);this._org>=c.memory&&this._org<c.memory+c.size&&a.push(c)}if(1!==a.length)throw Error(`Non-unique segment: ${a}`);a=a[0];if(this._org>=a.memory+a.size)throw Error(`Chunk does not fit in segment ${a.name}`);this.place(this._org,a)}}place(a,b){var c;this._org=a;this._segment=b;a=this._offset=a+b.delta;
for(var d of this.linker.watches)if(d>=a&&d<a+this.size)debugger;Na(this.linker.placed,a=>a[0],[a,this]);d=this.linker.data;b=null!==(c=this._data)&&void 0!==c?c:Xa("No data");this._data=void 0;if(this.subs.size){d.splice(a,b.length);c=new Ta;c.set(0,b);for(const a of this.subs)c.splice(a.offset,a.size);for(const b of c.chunks()){const [c,e]=b;d.set(a+c,...e)}}else d.set(a,b);for(const a of this.follow){const [b,c]=a;c.resolveSub(b,!1)}this.linker.free.delete(this.offset,this.offset+this.size)}resolveSubs(a){a=
void 0===a?!1:a;for(const b of this.selfSubs)this.resolveSub(b,a);for(const b of this.subs)this.resolveSub(b,a)}addDep(a,b){b===this.index&&this.subs.delete(a)&&this.selfSubs.add(a);this.linker.chunks[b].follow.set(a,this);this.deps.add(b)}resolveSub(a,b){var c,d;if(this.subs.has(a)||this.selfSubs.has(a)){a.expr=ta.traverse(a.expr,(c,d,e)=>{var f;if(b&&"^"===(null===e||void 0===e?void 0:e.op)&&1===e.args.length&&c.meta)return null==c.meta.bank&&this.addDep(a,c.meta.chunk),c;c=this.linker.resolveLink(ta.evaluate(d(c)));
b&&(null===(f=c.meta)||void 0===f?0:f.rel)&&this.addDep(a,c.meta.chunk);return c});var e=!1;if("num"===a.expr.op&&(null===(c=a.expr.meta)||void 0===c||!c.rel))this.writeValue(a.offset,a.expr.num,a.size),e=!0;else if(".move"===a.expr.op){if(1!==a.expr.args.length)throw Error("bad .move");c=a.expr.args[0];"num"===c.op&&null!=(null===(d=c.meta)||void 0===d?void 0:d.offset)&&(d=c.meta.offset+c.num,d=this.linker.orig.slice(d,d+a.size),this.writeBytes(a.offset,Uint8Array.from(d)),e=!0)}e&&(this.subs.delete(a)||
this.selfSubs.delete(a),this.subs.size||this.linker.unresolvedChunks.delete(this)&&this.linker.insertResolved(this))}}writeBytes(a,b){if(this._data)this._data.subarray(a,a+b.length).set(b);else if(null!=this._offset)this.linker.data.set(this._offset+a,b);else throw Error("Impossible");}writeValue(a,b,c){var d=c<<3;if(null!=b&&(b<-1<<d||b>=1<<d))throw Error(`Not a ${["byte","word","farword","dword"][c-1]}: $${b.toString(16)}`);d=new Uint8Array(c);for(let a=0;a<c;a++)d[a]=b&255,b>>=8;this.writeBytes(a,
d)}}function $a(a,b,c){a=Object.assign({},a);a.expr=cb(a.expr,b,c);return a}function cb(a,b,c){var d;a=Object.assign({},a);a.meta&&(a.meta=Object.assign({},a.meta));a.args&&(a.args=a.args.map(a=>cb(a,b,c)));null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(a.meta.chunk+=b);"sym"===a.op&&null!=a.num&&(a.num+=c);return a}function db(a,b,c){a=Object.assign({},a);a.expr&&(a.expr=cb(a.expr,b,c));return a}
class Wa{constructor(){this.data=new Ta;this.orig=new Ta;this.exports=new Map;this.chunks=[];this.symbols=[];this.free=new Ua;this.rawSegments=new Map;this.segments=new Map;this.resolvedChunks=[];this.unresolvedChunks=new Set;this.watches=[];this.placed=[];this.initialReport=""}insertResolved(a){Na(this.resolvedChunks,a=>a.size,a)}base(a,b){b=void 0===b?0:b;this.data.set(b,a);this.orig.set(b,a)}readFile(a){const b=this.chunks.length,c=this.symbols.length;for(var d of a.segments||[])this.addRawSegment(d);
for(const e of a.chunks||[])d=new Za(this,this.chunks.length,e,b,c),this.chunks.push(d);for(const d of a.symbols||[])this.symbols.push(db(d,b,c))}resolveLink(a){var b,c,d;if(".orig"===a.op&&1===(null===(b=a.args)||void 0===b?void 0:b.length)){var e=a.args[0];var f=null===(c=e.meta)||void 0===c?void 0:c.offset;if(null!=f&&(e=this.orig.get(f+e.num),null!=e))return{op:"num",num:e}}else"num"===a.op&&null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(c=a.meta,b=this.chunks[c.chunk],b.org!==c.org||
(null===(f=b.segment)||void 0===f?void 0:f.bank)!==c.bank||b.offset!==c.offset)&&(f={org:b.org,offset:b.offset,bank:null===(e=b.segment)||void 0===e?void 0:e.bank},a=ta.evaluate(Object.assign({},a,{meta:Object.assign({},c,f)})));return a}resolveExpr(a){var b;a=ta.traverse(a,(a,b)=>this.resolveLink(ta.evaluate(b(a))));if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=n.at(a);throw Error(`Unable to fully resolve expr${a}`);}link(){for(var a of this.rawSegments){const [c,d]=a;var b=
d[0];for(let a=1;a<d.length;a++)b=Da.merge(b,d[a]);this.segments.set(c,new Ya(b))}for(var c of this.rawSegments){const [e,f]=c;a=this.segments.get(e);for(var d of f){b=d.free;for(const c of b||[]){const [b,d]=c;this.free.add(b+a.delta,d+a.delta);this.data.splice(b+a.delta,d-b)}}}for(const a of this.chunks)a.initialPlacement();for(c=0;c<this.symbols.length;c++){d=this.symbols[c];if(!d.expr)throw Error(`Symbol ${c} never resolved`);null!=d.export&&this.exports.set(d.export,c)}for(var e of this.symbols)e.expr=
this.resolveSymbols(e.expr);for(var f of this.chunks){for(const a of[...f.subs,...f.selfSubs])a.expr=this.resolveSymbols(a.expr);for(e=0;e<f.asserts.length;e++)f.asserts[e]=this.resolveSymbols(f.asserts[e])}for(const a of this.chunks)a.resolveSubs(!0);f=[...this.chunks];f.sort((a,b)=>b.size-a.size);for(var g of f)g.resolveSubs(),g.subs.size?this.unresolvedChunks.add(g):this.insertResolved(g);for(g=this.resolvedChunks.length+2*this.unresolvedChunks.size;g;){if(f=this.resolvedChunks.pop())this.placeChunk(f);
else{[f]=this.unresolvedChunks;for(var h of f.deps)f=this.chunks[h],null==f.org&&this.placeChunk(f)}f=this.resolvedChunks.length+2*this.unresolvedChunks.size;if(f===g)throw console.error(this.resolvedChunks,this.unresolvedChunks),Error("Not making progress");g=f}h=new Ta;for(var l of this.chunks){for(const a of l.asserts)if(!this.resolveExpr(a))throw l=n.at(a),Error(`Assertion failed${l}`);l.overlaps||h.set(l.offset,...this.data.slice(l.offset,l.offset+l.size))}return h}placeChunk(a){if(null==a.org){var b=
a.size;if(!a.subs.size&&!a.selfSubs.size){var c=this.data.pattern(a.data);for(var d of a.segments){var e=this.segments.get(d),f=e.offset;f=c.search(f,f+e.size);if(!(0>f)){a.place(f-e.delta,e);a.overlaps=!0;return}}}for(var g of a.segments){c=this.segments.get(g);f=c.offset;d=f+c.size;let h;e=Infinity;for(const a of this.free.tail(f)){const [c,g]=a;if(c>=d)break;f=Math.min(g,d)-c;!(f<b)&&f<e&&(h=c,e=f)}if(null!=h){a.place(h-c.delta,c);return}}console.log(`After filling:\n${this.report(!0)}`);g=a.name?
`${a.name} `:"";console.log(this.segments.get(a.segments[0]));throw Error(`Could not find space for ${b}-byte chunk ${g}in ${a.segments.join(", ")}`);}}resolveSymbols(a){return ta.traverse(a,(b,c)=>{for(;"im"===b.op||"sym"===b.op;)if("im"===b.op){b=b.sym;const d=this.exports.get(b);if(null==d)throw c=n.at(a),Error(`Symbol never exported ${b}${c}`);b=this.symbols[d].expr}else{if(null==b.num)throw Error("Symbol not global");b=this.symbols[b.num].expr}return ta.evaluate(c(b))})}addRawSegment(a){let b=
this.rawSegments.get(a.name);b||this.rawSegments.set(a.name,b=[]);b.push(a)}buildExports(){var a,b;const c=new Map;for(const d of this.symbols){if(!d.export)continue;const e=ta.traverse(d.expr,(a,b)=>this.resolveLink(ta.evaluate(b(a))));if("num"!==e.op)throw Error(`never resolved: ${d.export}`);const f=e.num,g={value:f};null!=(null===(a=e.meta)||void 0===a?void 0:a.offset)&&null!=e.meta.org&&(g.offset=e.meta.offset+f-e.meta.org);null!=(null===(b=e.meta)||void 0===b?void 0:b.bank)&&(g.bank=e.meta.bank);
c.set(d.export,g)}return c}report(a){a=void 0===a?!1:a;var b;let c="";for(var d of this.free){const [a,b]=d;c+=`Free: ${a.toString(16)}..${b.toString(16)}: ${b-a} bytes\n`}if(a)for(const e of this.placed){const [f,g]=e;a=null!==(b=g.name)&&void 0!==b?b:`Chunk ${g.index}`;d=g.offset+g.size;c+=`${f.toString(16).padStart(5,"0")} .. ${d.toString(16).padStart(5,"0")}: ${a} (${d-f} bytes)\n`}return c}};new WeakMap;const eb=()=>"",hb=a=>!0===a?!1:a;class ib{constructor(a,b){this.flag=a;this.opts=b;ib.flags.set(a,this)}static all(){return[...this.flags.values()]}}ib.flags=new Map;
class jb{constructor(a,b,c,d){this.name=b;this.description=c;this.flags=d.map(a=>a instanceof ib?[a,!0]:a);a.presets.set(b.toLowerCase().replace(/[^a-z]/g,""),this)}static all(){kb.instance||(kb.instance=new kb);return[...kb.instance.presets.values()]}get flagString(){null==this._flagString&&(this._flagString=String(new lb(`@${this.name}`)));return this._flagString}}
class kb{constructor(){this.presets=new Map;this.Casual=new jb(this,"Casual","\n      Basic flags for a relatively easy playthrough.  This is a good\n      place to start.",[mb.PreserveUniqueChecks,mb.NoShuffleMimics,mb.DecreaseEnemyDamage,mb.GuaranteeRefresh,mb.GuaranteeStartingSword,mb.ExperienceScalesFaster,r.NoThunderSwordWarp,nb.Shops,nb.Dyna,[nb.Maps,"!"],[nb.WildWarp,"!"],ob.SpoilerLog]);this.Classic=new jb(this,"Classic","\n      Provides a relatively quick playthough with a reasonable amount of\n      challenge.  Similar to older versions.",
[mb.GuaranteeStartingSword,t.StatueGlitch,[r.NoThunderSwordWarp,"!"],[nb.Maps,"!"],ob.SpoilerLog]);this.Standard=new jb(this,"Standard","\n      Well-balanced, standard race flags.",[sb.RandomizeWeaknesses,r.StoryMode,ob.SpoilerLog]);this.NoBowMode=new jb(this,"No Bow Mode","\n      The tower is open from the start, as soon as you're ready for it.",[sb.RandomizeWeaknesses,sb.TowerRobots,tb.MaxScalingInTower,r.NoBowMode,ob.SpoilerLog]);this.Advanced=new jb(this,"Advanced","\n      A balanced randomization with quite a bit more difficulty.",
[t.GhettoFlight,t.MtSabreRequirementSkip,t.StatueGlitch,[t.SwordChargeGlitch,"!"],ub.Barrier,ub.BattleMagic,ub.GasMask,tb.MaxScalingInTower,sb.RandomizeWeaknesses,sb.TowerRobots,r.OrbsNotRequired,r.StoryMode,u.RandomizeMaps,u.RandomizeTrades,u.RandomizeWallElements,u.UnidentifiedKeyItems,ob.SpoilerLog]);this.WildWarp=new jb(this,"Wild Warp","\n      Significantly opens up the game right from the start with wild\n      warp in logic.",[mb.GuaranteeRefresh,u.RandomizeWildWarp,sb.RandomizeWeaknesses,
sb.TowerRobots,r.OrbsNotRequired,r.StoryMode,ob.SpoilerLog]);this.Hardcore=new jb(this,"Hardcore","\n      Not for the faint of heart.  Good luck.",[ub.Barrier,ub.BattleMagic,tb.ExperienceScalesSlower,tb.MaxScalingInTower,tb.Permadeath,r.OrbsNotRequired,r.StoryMode,u.RandomizeMaps,u.RandomizeTrades,u.RandomizeWallElements,u.UnidentifiedKeyItems]);this.FullStupid=new jb(this,"The Full Stupid","\n      Nobody has ever completed this.  Be sure to record this because\n      pics or it didn't happen.",
[ub.Barrier,ub.BattleMagic,tb.Blackout,tb.ExperienceScalesSlower,tb.MaxScalingInTower,tb.Permadeath,sb.RandomizeWeaknesses,sb.TowerRobots,r.OrbsNotRequired,r.StoryMode,u.RandomizeMaps,u.RandomizeTrades,u.RandomizeWallElements,u.ShuffleGoaFloors,u.UnidentifiedKeyItems]);this.Mystery=new jb(this,"Mystery","\n      Even the options are random.",[[u.RandomizeMaps,"?"],[u.RandomizeTrades,"?"],[u.UnidentifiedKeyItems,"?"],[u.RandomizeWallElements,"?"],[u.ShuffleGoaFloors,"?"],[u.RandomizeSpriteColors,"?"],
[u.RandomizeWildWarp,"?"],[r.OrbsNotRequired,"?"],[r.NoBowMode,"?"],[r.StoryMode,"?"],[r.VanillaDolphin,"?"],[r.NoThunderSwordWarp,"?"],[t.RageSkip,"?"],[t.TriggerSkip,"?"],[t.StatueGlitch,"?"],[t.GhettoFlight,"?"],[t.SwordChargeGlitch,"?"],[t.MtSabreRequirementSkip,"?"],[vb.RandomizeMusic,"?"],[vb.RandomizeMapColors,"?"],[sb.RandomizeWeaknesses,"?"],[sb.TowerRobots,"?"],[mb.NoShuffleMimics,"?"],[mb.PreserveUniqueChecks,"?"],[ub.Barrier,"?"],[ub.BattleMagic,"?"],[ub.GasMask,"?"],[nb.Dyna,"?"],[nb.BonusItems,
"?"],[nb.Maps,"?"],ob.SpoilerLog])}static get(a){this.instance||(this.instance=new kb);return this.instance.presets.get(a.toLowerCase().replace(/[^a-z]/g,""))}}class wb{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(a,b){wb.sections.add(this.instance||(this.instance=new this));b=new ib(a,b);if(!a.startsWith(this.instance.prefix))throw Error("bad flag");this.instance.flags.set(a,b);return b}}wb.sections=new Set;
class u extends wb{constructor(){super(...arguments);this.prefix="W";this.name="World"}}u.RandomizeMaps=u.flag("Wm",{name:"Randomize maps",text:"Individual maps are randomized.  For now this is only a subset of\n           possible maps.  A randomized map will have all the same features\n           (exits, chests, NPCs, etc) except things are moved around.",hard:!0});
u.RandomizeTrades=u.flag("Wt",{name:"Randomize trade-in items",text:"Items expected by various NPCs will be shuffled: specifically,\n           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog\n           Lamp, and Flute of Lime (for Akahana).  Rage will expect a\n           random sword, and Tornel will expect a random bracelet.",hard:!0});
u.UnidentifiedKeyItems=u.flag("Wu",{name:"Unidentified key items",text:"Item names will be generic and effects will be shuffled.  This\n           includes keys, flutes, lamps, and statues.",hard:!0});u.RandomizeWallElements=u.flag("We",{name:"Randomize elements to break walls",text:'Walls will require a randomized element to break.  Normal rock and\n           ice walls will indicate the required element by the color (light\n           grey or yellow for wind, blue for fire, bright orange ("embers") for\n           water, or dark grey ("steel") for thunder.  The element to break\n           these walls is the same throughout an area.  Iron walls require a\n           one-off random element, with no visual cue, and two walls in the\n           same area may have different requirements.'});
u.ShuffleGoaFloors=u.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."});u.RandomizeSpriteColors=u.flag("Ws",{name:"Randomize sprite colors",text:"Monsters and NPCs will have different colors.  This is not an\n           optional flag because it affects what monsters can be grouped\n           together."});
u.RandomizeWildWarp=u.flag("Ww",{name:"Randomize wild warp",text:"Wild warp will go to Mezame Shrine and 15 other random locations.\n           These locations will be considered in-logic.",excludes:["Vw"]});class r extends wb{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}}r.StoryMode=r.flag("Rs",{name:"Story Mode",text:"Draygon 2 won't spawn unless you have all four swords and have\n           defeated all major bosses of the tetrarchy."});
r.NoBowMode=r.flag("Rb",{name:"No Bow mode",text:"No items are required to finish the game.  An exit is added from\n           Mezame shrine directly to the Draygon 2 fight (and the normal entrance\n           is removed).  Draygon 2 spawns automatically with no Bow of Truth."});r.OrbsNotRequired=r.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."});
r.NoThunderSwordWarp=r.flag("Rt",{name:"No Sword of Thunder warp",text:'Normally when acquiring the thunder sword, the player is instantly\n           warped to a random town.  This flag disables the warp.  If set as\n           "R!t", then the warp will always go to Shyron, like in vanilla.',modes:"!"});r.VanillaDolphin=r.flag("Rd",{name:"Vanilla Dolphin interactions",text:"By default, the randomizer changes a number of dolphin and boat\n           interactions: (1) healing the dolphin and having the Shell Flute\n           is no longer required before the fisherman spawns: instead, he\n           will spawn as soon as you have the item he wants; (2) talking to\n           Kensu in the beach cabin is no longer required for the Shell Flute\n           to work: instead, the Shell Flute will always work, and Kensu will\n           spawn after the Fog Lamp is turned in and will give a key item\n           check.  This flag restores the vanilla interaction where healing\n           and shell flute are required, and Kensu no longer drops an item."});
class t extends wb{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description="\n      By default, the randomizer disables all known glitches (except ghetto\n      flight).  These flags selectively re-enable certain glitches.  Most of\n      these flags have two modes: normally enabling a glitch will add it as\n      possibly required by logic, but clicking a second time will add a '!'\n      and enable the glitch outside of logic (e.g. \"G!c\")."}}
t.GhettoFlight=t.flag("Gf",{name:"Ghetto flight",text:"Ghetto flight allows using Dolphin and Rabbit Boots to fly up the\n           waterfalls in the Angry Sea (without calming the whirlpools).\n           This is done by swimming up to a diagonal beach and jumping\n           in a different direction immediately before disembarking."});
t.StatueGlitch=t.flag("Gs",{name:"Statue glitch",text:"Statue glitch allows getting behind statues that block certain\n           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,\n           as well as the statues in the Waterfall Cave.  It is done by\n           approaching the statue from the top right and holding down and\n           left on the controller while mashing B.",modes:"!"});
t.MtSabreRequirementSkip=t.flag("Gn",{name:"Mt Sabre requirements skip",text:"Entering Mt Sabre North normally requires (1) having Teleport,\n           and (2) talking to the rabbit in Leaf after the abduction (via\n           Telepathy).  Both of these requirements can be skipped: first by\n           flying over the river in Cordel plain rather than crossing the\n           bridge, and then by threading the needle between the hitboxes in\n           Mt Sabre North.",modes:"!"});
t.StatueGauntletSkip=t.flag("Gg",{name:"Statue guantlet skip",text:"The shooting statues in front of Goa and Stxy normally require\n           Barrier to pass safely.  With this flag, Flight can also be used\n           by flying around the edge of the statue.",modes:"!"});
t.SwordChargeGlitch=t.flag("Gc",{name:"Sword charge glitch",text:"Sword charge glitch allows charging one sword to the level of\n           another sword by equipping the higher-level sword, re-entering\n           the menu, changing to the lower-level sword without exiting the\n           menu, creating a hard save, resetting, and then continuing.",hard:!0,modes:"!"});
t.TriggerSkip=t.flag("Gt",{name:"Trigger skip",text:"A wide variety of triggers and exit squares can be skipped by\n           using an invalid item every frame while walking.  This allows\n           bypassing both Mt Sabre entrance triggers, the Evil Spirit Island\n           entrance trigger, triggers for guards to move, slopes, and seamless\n           map transitions.",hard:!0,modes:"!"});
t.RageSkip=t.flag("Gr",{name:"Rage skip",text:"Rage can be skipped by damage-boosting diagonally into the Lime\n           Tree Lake screen.  This provides access to the area beyond the\n           lake if flight or bridges are available.",hard:!0,modes:"!"});
class vb extends wb{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description='\n      These flags don\'t directly affect gameplay or shuffling, but they do\n      affect the experience significantly enough that there are three modes\n      for each: "off", "optional" (no exclamation point), and "required"\n      (exclamation point).  The first two are equivalent for seed generation\n      purposes, so that you can play the same seed with either setting.\n      Setting it to "!" will change the seed.'}}
vb.RandomizeMusic=vb.flag("Am",{name:"Randomize background music",modes:"!",optional:hb});vb.NoMusic=vb.flag("As",{name:"No background music",optional:eb});vb.RandomizeMapColors=vb.flag("Ac",{name:"Randomize map colors",modes:"!",optional:hb});class sb extends wb{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}}sb.RandomizeWeaknesses=sb.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."});
sb.TowerRobots=sb.flag("Mt",{name:"Shuffle tower robots",text:"Tower robots will be shuffled into the normal pool.  At some\n           point, normal monsters may be shuffled into the tower as well.",hard:!0});class mb extends wb{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description="\n      The following options make parts of the game easier."}}mb.NoShuffleMimics=mb.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."});
mb.PreserveUniqueChecks=mb.flag("Eu",{name:"Keep unique items and consumables separate",text:"Normally all items and mimics are shuffled into a single pool and\n           distributed from there.  If this flag is set, unique items\n           (specifically, anything that cannot be sold) will only be found in\n           either (a) checks that held unique items in vanilla, or (b) boss\n           drops.  Chests containing consumables in vanilla may be safely\n           ignored, but chests containing unique items in vanilla may still\n           end up with non-unique items because of bosses like Vampire 2 that\n           drop consumables.  If mimics are shuffled, they will only be in\n           consumable locations."});
mb.DecreaseEnemyDamage=mb.flag("Ed",{name:"Decrease enemy damage",text:"Enemy attack power will be significantly decreased in the early game\n           (by a factor of 3).  The gap will narrow in the mid-game and eventually\n           phase out at scaling level 40."});mb.GuaranteeStartingSword=mb.flag("Es",{name:"Guarantee starting sword",text:"The Leaf elder is guaranteed to give a sword.  It will not be\n           required to deal with any enemies before finding the first sword."});
mb.GuaranteeRefresh=mb.flag("Er",{name:"Guarantee refresh",text:"Guarantees the Refresh spell will be available before fighting\n           Tetrarchs."});mb.ExperienceScalesFaster=mb.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]});class ub extends wb{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description="\n      Removes various guarantees from the logic."}}
ub.BattleMagic=ub.flag("Nw",{name:"Battle magic not guaranteed",text:"Normally, the logic will guarantee that level 3 sword charges are\n           available before fighting the tetrarchs (with the exception of Karmine,\n           who only requires level 2).  This disables that check.",hard:!0});
ub.MatchingSword=ub.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:'Enables "tink strats", where wrong-element swords will still do a\n           single damage per hit.  Player may be required to fight monsters\n           (including bosses) with tinks.',hard:!0});
ub.Barrier=ub.flag("Nb",{name:"Barrier not guaranteed",text:"Normally, the logic will guarantee Barrier (or else refresh and shield\n           ring) before entering Stxy, the Fortress, or fighting Karmine.  This\n           disables that check.",hard:!0});ub.GasMask=ub.flag("Ng",{name:"Gas mask not guaranteed",text:"The logic will not guarantee gas mask before needing to enter the swamp.\n           Gas mask is still guaranteed to kill the insect.",hard:!0});
class tb extends wb{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}}tb.NoBuffMedicalHerb=tb.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:"Medical Herb is not buffed to heal 80 damage, which is helpful to make\n           up for cases where Refresh is unavailable early.  Fruit of Power is not\n           buffed to restore 56 MP.",hard:!0});
tb.MaxScalingInTower=tb.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0});tb.ExperienceScalesSlower=tb.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0});tb.ChargeShotsOnly=tb.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0});
tb.Blackout=tb.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0});tb.Permadeath=tb.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});class nb extends wb{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description="\n      Options to restore vanilla behavior changed by default."}}nb.Dyna=nb.flag("Vd",{name:"Don't buff Dyna",text:"By default, we makes the Dyna fight a bit more of a challenge.\n           Side pods will fire significantly more.  The safe spot has been\n           removed.  The revenge beams pass through barrier.  Side pods can\n           now be killed.  This flag prevents that change."});
nb.BonusItems=nb.flag("Vb",{name:"Don't buff bonus items",text:"Leather Boots are changed to Speed Boots, which increase player walking\n           speed (this allows climbing up the slope to access the Tornado Bracelet\n           chest, which is taken into consideration by the logic).  Deo's pendant\n           restores MP while moving.  Rabbit boots enable sword charging up to\n           level 2 while walking (level 3 still requires being stationary, so as\n           to prevent wasting tons of magic)."});
nb.Maps=nb.flag("Vm",{name:"Vanilla maps",text:'Normally the randomizer adds a new "East Cave" to Valley of Wind,\n           borrowed from the GBC version of the game.  This cave contains two\n           chests (one considered a key item) on the upper floor and exits to\n           two random areas (chosen between Lime Tree Valley, Cordel Plain,\n           Goa Valley, or Desert 2; the quicksand is removed from the entrances\n           to Pyramid and Crypt), one unblocked on the lower floor, and one\n           down the stairs and behind a rock wall from the upper floor.  This\n           flag prevents adding that cave.  If set as "V!m" then a direct path\n           will instead be added between Valley of Wind and Lime Tree Valley\n           (as in earlier versions of the randomizer).',
modes:"!"});nb.Shops=nb.flag("Vs",{name:"Vanilla shops",text:"By default, we disable shop glitch, shuffle shop contents, and tie\n           the prices to the scaling level (item shops and inns increase by a\n           factor of 2 every 10 scaling levels, armor shops decrease by a\n           factor of 2 every 12 scaling levels).  This flag prevents all of\n           these changes, restoring shops to be completely vanilla."});
nb.WildWarp=nb.flag("Vw",{name:"Vanilla wild warp",text:"By default, Wild Warp is nerfed to only return to Mezame Shrine.\n           This flag restores it to work like normal.  Note that this will put\n           all wild warp locations in logic unless the flag is set as (V!w).",modes:"!"});
class yb extends wb{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description="\n      The following quality-of-life flags turn <i>off</i> improvements that\n      are normally on by default.  They are optional and will not affect the\n      seed generation.  They may be toggled freely in race mode."}}
yb.NoAutoEquip=yb.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:"Prevents adding a quality-of-life improvement to automatically equip\n           the corresponding orb/bracelet whenever changing swords.",optional:eb});
yb.NoControllerShortcuts=yb.flag("Qc",{name:"Disable controller shortcuts",text:"By default, we disable second controller input and instead enable\n           some new shortcuts on controller 1: Start+A+B for wild warp, and\n           Select+B to quickly change swords.  To support this, the action of\n           the start and select buttons is changed slightly.  This flag\n           disables this change and retains normal behavior.",optional:eb});
class ob extends wb{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description="\n      These options are helpful for exploring or debugging.  Note that,\n      while they do not directly affect any randomization, they\n      <i>do</i> factor into the seed to prevent cheating, and they\n      will remove the option to generate a seed for racing."}}ob.SpoilerLog=ob.flag("Ds",{name:"Generate a spoiler log",text:"Note: <b>this will change the placement of items</b> compared to a\n           seed generated without this flag turned on."});
ob.TrainerMode=ob.flag("Dt",{name:"Trainer mode",text:"Installs a trainer for practicing certain parts of the game.\n           At the start of the game, the player will have all swords, basic\n           armors and shields, all worn items and magics, a selection of\n           consumables, bow of truth, maximum cash, all warp points activated,\n           and the Shyron massacre will have been triggered.  Wild warp is\n           reconfigured to provide easy access to all bosses.  Additionally,\n           the following button combinations are recognized:<ul>\n             <li>Start+Up: increase player level\n             <li>Start+Down: increase scaling level\n             <li>Start+Left: get all balls\n             <li>Start+Right: get all bracelets\n             <li>Start+B+Down: get a full set of consumable items\n             <li>Start+B+Left: get all advanced armors\n             <li>Start+B+Right: get all advanced shields\n           </ul>"});
ob.NeverDie=ob.flag("Di",{name:"Player never dies"});
class lb{constructor(a="@Casual"){if("string"!==typeof a){this.flags=new Map;for(const [b,c]of a)this.set(b.flag,c)}else if(a.startsWith("@")){var b=kb.get(a.substring(1));if(!b)throw new da(`Unknown preset: ${a}`);this.flags=new Map(b.flags)}else{this.flags=new Map;a=a.replace(/[^A-Za-z0-9!?]/g,"");b=/([A-Z])([a-z0-9!?]+)/g;for(var c;c=b.exec(a);){const [,a,b]=c,f=/([!?]|^)([a-z0-9]+)/g;for(;c=f.exec(b);){const [,b,d]=c;for(const c of d)this.set(a+c,b||!0)}}}}filterOptional(){return new lb(new Map([...this.flags].map(([a,
b])=>[a,a.opts.optional?a.opts.optional(b):b])))}filterRandom(a){return new lb(new Map([...this.flags].map(([b,c])=>{c="?"!==c?c:a.pick([!0,!1,...b.opts.modes||""]);return[b,c]})))}toString(){var a=new m(()=>new m(()=>[]));for(const [b,d]of this.flags){if(2!==b.flag.length)throw Error(`Bad flag ${b.flag}`);d&&a.get(b.flag[0]).get(!0===d?"":d).push(b.flag[1])}const b=[];for(const [c,d]of a.sortedEntries()){a=c;for(const [b,c]of d)a+=b+c.sort().join("");b.push(a)}return b.join(" ")}toggle(a){const b=
ib.flags.get(a);if(!b)return console.error(`Bad flag: ${a}`),!1;a=this.flags.get(b)||!1;const c=[!1,!0,...b.opts.modes||"","?",!1],d=c.indexOf(a);if(0>d)throw Error(`Bad current mode ${a}`);a=c[d+1];this.flags.set(b,a);return a}set(a,b){var c;const d=ib.flags.get(a);if(d){if(b)if(!0===b||"?"===b||(null===(c=d.opts.modes)||void 0===c?0:c.includes(b)))this.flags.set(d,b);else{console.error(`Bad flag mode: ${a[0]}${b}${a.substring(1)}`);return}else this.flags.delete(d);for(const a of d.opts.excludes||
[])this.flags.delete(ib.flags.get(a))}else console.error(`Bad flag: ${a}`)}check(a,...b){a=a instanceof ib?a:ib.flags.get(a);b.length||b.push(!0);return b.includes(a&&this.flags.get(a)||!1)}get(a){return(a=a instanceof ib?a:ib.flags.get(a))&&this.flags.get(a)||!1}preserveUniqueChecks(){return this.check(mb.PreserveUniqueChecks)}shuffleMimics(){return this.check(mb.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(nb.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(nb.BonusItems,
!1)}slowDownTornado(){return this.check(nb.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(nb.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(nb.BonusItems,!1)}shuffleSpritePalettes(){return this.check(u.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(nb.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(sb.TowerRobots)}shuffleMonsterElements(){return this.check(sb.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(tb.NoBuffMedicalHerb,
!1)}decreaseEnemyDamage(){return this.check(mb.DecreaseEnemyDamage)}trainer(){return this.check(ob.TrainerMode)}neverDie(){return this.check(ob.NeverDie)}chargeShotsOnly(){return this.check(tb.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(nb.Maps,"!")}addEastCave(){return this.check(nb.Maps,!1)}fogLampNotRequired(){return this.check(r.VanillaDolphin,!1)}storyMode(){return this.check(r.StoryMode)}noBowMode(){return this.check(r.NoBowMode)}requireHealedDolphinToRide(){return this.check(r.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(r.NoThunderSwordWarp,
!1,"!")}randomizeThunderTeleport(){return this.check(r.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(r.OrbsNotRequired)}shuffleGoaFloors(){return this.check(u.ShuffleGoaFloors)}randomizeMaps(){return this.check(u.RandomizeMaps)}randomizeTrades(){return this.check(u.RandomizeTrades)}unidentifiedItems(){return this.check(u.UnidentifiedKeyItems)}randomizeWalls(){return this.check(u.RandomizeWallElements)}guaranteeSword(){return this.check(mb.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(ub.BattleMagic,
!1)}guaranteeMatchingSword(){return this.check(ub.MatchingSword,!1)}guaranteeGasMask(){return this.check(ub.GasMask,!1)}guaranteeBarrier(){return this.check(ub.Barrier,!1)}guaranteeRefresh(){return this.check(mb.GuaranteeRefresh)}disableSwordChargeGlitch(){return this.check(t.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(t.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(t.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(nb.Shops,!1)}disableStatueGlitch(){return this.check(t.StatueGlitch,
!1)}disableRageSkip(){return this.check(t.RageSkip,!1)}disableFlightStatueSkip(){return this.check(t.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(t.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(t.GhettoFlight)}assumeTeleportSkip(){return this.check(t.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(t.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(t.StatueGlitch)}assumeTriggerGlitch(){return this.check(t.TriggerSkip)}assumeFlightStatueSkip(){return this.check(t.StatueGauntletSkip)}assumeWildWarp(){return this.check(nb.WildWarp,
!0)||this.check(u.RandomizeWildWarp)}assumeRageSkip(){return!1}nerfWildWarp(){return this.check(nb.WildWarp,!1)&&this.check(u.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(u.RandomizeWildWarp,!0)}blackoutMode(){return this.check(tb.Blackout)}hardcoreMode(){return this.check(tb.Permadeath)}buffDyna(){return!this.check(nb.Dyna)}maxScalingInTower(){return this.check(tb.MaxScalingInTower)}expScalingFactor(){return this.check(tb.ExperienceScalesSlower)?
.25:this.check(mb.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(a){return"early"===a||this.check(yb.NoAutoEquip,!1)}controllerShortcuts(a){return"early"===a||this.check(yb.NoControllerShortcuts,!1)}randomizeMusic(a){return this.check(vb.RandomizeMusic,"early"===a?"!":!0)}shuffleTilePalettes(a){return this.check(vb.RandomizeMapColors,"early"===a?"!":!0)}noMusic(a){return"late"===a&&this.check(vb.NoMusic)}};function zb(a){return a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace(/Of/g,"of").replace(/_/g," - ")}function Ab(a){return zb(a).replace(/^./,a=>a.toUpperCase())}function v(a,b=a=>a){return Array(a).fill(0).map((a,d)=>b(d))}function Db(a,b,c){return Array.from(a.slice(b,b+c))}function Eb(a){return 128>a?a:a-256}function Fb(a,b,c,d,e=Infinity,f){f||(f=a=>a);const g=[];for(;b+c<=e&&a[b]!==d;)g.push(f(a.slice(b,b+c))),b+=c;return g}function Gb(a,b,c=0){return(a[b]|a[b+1]<<8)+c}
function Hb(a,b,c){c||(c=a=>a);return v(Math.max(0,Math.floor(b.length/a)),d=>{var e=c;d*=a;d=b.slice(d,d+a);return e(d)})}function Ib(a){return 65793*(2050*a&139536|32800*a&558144)>>>16&255}function x(a){return null!=a?a.toString(16).padStart(2,"0"):String(a)}function Jb(a){const b=[];for(const c of a)for(const a of c)b.push(a);return b}function Kb(a,b){return a[b]<<8|a[b+1]}function Lb(a,b){return a[b+1]<<8|a[b]}
function Mb(a,b,c=0){const d=[];for(;a[b]!=c;)d.push(a[b++]);return String.fromCharCode(...d)}
class Nb{constructor(a,b,c=!1){this.last=a;this.clear=b;this.nonEmpty=c}read(a,b=0){const c=[];for(;;){const e=a[b++];var d=a[b++];d|=(e&3)<<8;d=e&this.clear?~d:d;-1!==d&&c.push(d);if(e&this.last)return c}}bytes(a){a=a.filter(a=>-1!==a);this.nonEmpty&&!a.length&&(a=[-1]);const b=[];for(let c=0;c<a.length;c++){let d=a[c];0>d&&(d=this.clear<<8|~d);c===a.length-1&&(d|=this.last<<8);b.push(d>>>8);b.push(d&255)}return b}write(a,b,c=0){b=this.bytes(b);for(let d=0;d<b.length;d++)a[d+c]=b[d]}}
const Ob=new Nb(64,128),Pb=new Nb(64,128,!0),Qb=new Nb(64,128,!0),Wb=new Nb(128,32,!0),Xb=new Nb(128,32);function Yb(){function a(...a){return{tag:b,args:a}}const b=Symbol();a.commit=(a,d)=>{for(const c of Object.getOwnPropertyNames(a)){const e=a[c];e.tag===b&&(a[c]=d(c,...e.args))}};return a}const Zb=Symbol("PROP_TAG"),$b=new WeakMap;
function ac(a){let b=$b.get(a);if(!b){b=class extends bc{};Object.defineProperties(b,{name:{value:a.name}});Object.assign(b,a);Reflect.setPrototypeOf(b.prototype,a.prototype);const c=new a,d={};for(const [a,b]of Object.entries(c))b&&b[Zb]&&(d[a]=b);Object.defineProperties(b.prototype,d);$b.set(a,b);$b.set(b,b)}return b}
class bc{constructor(a){this.data=a}static of(a){return Object.assign(new (ac(this))(Array(this.size).fill(0)),a)}static from(a,b=0){const c=ac(this);a=b||a.length!==this.size?Db(a,b,this.size):a;return new c(a)}[Symbol.iterator](){return this.data[Symbol.iterator]()}hex(){return Array.from(this.data,x).join(" ")}clone(){return new this.constructor(this.data)}prop(...a){return{get(){let b=0;for(const [c,d=255,e=0]of a)b|=(this.data[c]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b},set(b){for(const [c,d=255,
e=0]of a)this.data[c]=this.data[c]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d},[Zb]:!0}}booleanProp(a,b){return{get(){return!!(this.data[a]&1<<b)},set(c){const d=1<<b;this.data[a]=c?this.data[a]|d:this.data[a]&~d},[Zb]:!0}}}class y{constructor(a,b,c){this.name=a;this.bank=b;this.org=c}get offset(){return(this.bank&31)<<13}}y.$04=new y("04",4,32768);y.$05=new y("05",5,40960);y.$0a=new y("0a",10,32768);y.$0b=new y("0b",11,40960);y.$0c=new y("0c",12,32768);y.$0d=new y("0d",13,40960);y.$0e=new y("0e",14,32768);
y.$0f=new y("0f",15,40960);y.$10=new y("10",16,32768);y.$14=new y("14",20,32768);y.$15=new y("15",21,40960);y.$16_a=new y("16:a",22,40960);y.$17=new y("17",23,40960);y.$18=new y("18",24,32768);y.$19=new y("19",25,40960);y.$1a=new y("1a",26,32768);y.$1b=new y("1b",27,40960);y.$fe=new y("fe",30,49152);y.$ff=new y("ff",31,57344);
class C{constructor(a,b){this.seg=a;this.delta=b}static of(a,b){return new C(a,b-a.org)}get offset(){return this.seg.offset+this.delta}get org(){return this.seg.org+this.delta}get segment(){return this.seg.name}plus(a,b){a=this.delta+a;if(8192<=a){if(!b)throw Error("Segment changed");if(this.seg.org&8192)throw Error("Bad segment cross");return new C(b,a&8191)}return new C(this.seg,a)}minus(a){if(a.seg!==this.seg)throw Error("Incompatible segments");return this.delta-a.delta}read(a){return a[this.offset]}readLittleEndian(a){const b=
this.offset;return a[b]|a[b+1]<<8}readAddress(a,...b){a=this.readLittleEndian(a);b.length||(b=[this.seg]);for(const c of b)if((a&57344)===(c.org&57344))return C.of(c,a);throw Error(`Could not find valid segment for ${x(a)}`);}loc(a,b){a.segment(this.segment);a.org(this.org,b)}}function cc(a,b,c,d){a.segment(b.name);a.org(c);a.free(d-c)}function dc(a,b,c){a.segment(...b.map(a=>a.name));a.reloc(c);a.label(c);a.export(c)};var ec;(function(a){a.name=function(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw Error(`Bad direction: ${a}`);};a.all=function(){return[0,1,2,3]};a.North=0;a.West=1;a.South=2;a.East=3})(ec||(ec={}));function fc(a){return a}(function(a){a.from=function({id:a},{x:c,y:d}){return a<<16|d>>>8<<12|c>>>8<<8|(d>>>4&15)<<4|c>>>4&15};a.add=function(a,c,d){if(c){for(c=(a&240)+(c<<4);240<=c;){if(61440<=(a&61440))return-1;c-=240;a+=4096}for(;0>c;){if(!(a&61440))return-1;c+=240;a-=4096}a=a&-241|c}if(d){for(d=(a&15)+d;16<=d;){if(1792<=(a&3840))return-1;d-=16;a+=256}for(;0>d;){if(!(a&3840))return-1;d+=16;a-=256}a=a&-16|d}return a}})(fc||(fc={}));var gc;
(function(a){a.trigger=function(a,c){return{*[Symbol.iterator](){let {x:b,y:e}=c;b+=8;for(const c of[-16,0]){const d=b+c;for(const b of[-16,0])yield fc.from(a,{x:d,y:e+b})}}}};a.adjust=function(a,...c){const b=new Set;a=[...a];for(const [d,f]of c)for(const c of a)b.add(fc.add(c,d,f));return b};a.screen=function(a){const b=[];for(let c=0;240>c;c++)b.push(a&-256|c);return b};a.atLocation=function(a,...c){const b=new Set;a=[...a];for(const d of c)for(const c of a)b.add(c&65535|d.id<<16);return b}})(gc||(gc=
{}));var D;
(function(a){function b(a){return a instanceof c?[...ea.map(a,a=>[...a])]:a}a.and=function(...a){return[[].concat(...a.map(([a])=>a))]};a.or=function(...c){const d=[];for(const e of c){if(e===a.OPEN)return a.OPEN;e!==a.CLOSED&&d.push(...b(e))}return d.length?d:a.CLOSED};a.meet=function(d,e){if(d===a.OPEN)return b(e);if(e===a.OPEN)return b(d);if(d===a.CLOSED||e===a.CLOSED)return a.CLOSED;const f=new c;for(const a of d)for(const b of e)f.addList([...a,...b]);return b(f)};a.freeze=b;a.label=function(a){return a instanceof c?
a.label():a.map(a=>a.join("&")).join("|")};a.isOpen=function(a){a=a[Symbol.iterator]();const {value:b,done:c}=a.next();return c||!a.next().done?!1:b[Symbol.iterator]().next().done};a.isClosed=function(a){return!!a[Symbol.iterator]().next().done};a.OPEN=[[]];a.CLOSED=[];class c{constructor(a){this.self=a;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(a,b){for(const a of b)if(Array.isArray(a))throw Error();if(b.has(this.self)||this.map.has(a))return!1;for(const [a,c]of this.map){if(hc(b,
c))return!1;hc(c,b)&&this.map.delete(a)}this.map.set(a,b);return!0}addRoute(a){return this.addInternal(a[ic],a.deps)}addAll(a){for(const b of a)this.addList(b)}addList(a){a=[...new Set(a)].sort();const b=new Set(a);this.addInternal(a.join("&"),b)}restrict(a){const b=[...this.map.values()];this.map.clear();for(const c of b)for(const b of a)this.addList([...c,...b])}label(){return[this.map.keys()].join("|")}}a.Builder=c})(D||(D={}));
function hc(a,b){if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0}const ic=Symbol("depsLabel");class qc{constructor(a,b){this.target=a;a=[...new Set(b)].sort();this.deps=new Set(a);this[ic]=a.join("&");this.label=`${this.target}:${this[ic]}`}};function rc(a){return a}(function(a){a.from=(a,c)=>"number"!==typeof a&&c?a.id<<8|c.y>>>8<<4|c.x>>>8:Number(a)>>>8;a.fromTile=function(a){return a>>>8}})(rc||(rc={}));class sc{constructor(a){this.rom=a;this.tiles=new m(a=>tc(this.rom,a));this.bosses=new m(a=>new uc(a));this.statues=new Map;this.flags=new m(a=>new m(b=>new m(c=>new vc(a,b,c))));this.meets=new m(a=>new m(b=>new wc(a,b)));this._seamless=new m(a=>new xc(a))}tile(a){return a&4?void 0:this.tiles.get(a)}boss(a){return this.bosses.get(a)}statue(a){const b=D.label(a);let c=this.statues.get(b);c||this.statues.set(b,c=new yc(a));return c}flag(a,b,c){a||(a=zc);return this.flags.get(a).get(b).get(c)}meet(a,
b){return this.meets.get(a).get(b)}seamless(a){return this._seamless.get(a)}label(a,b){return a.label?a.label(b):"Terrain"}}var Ac;(function(a){a.FLY=2;a.BLOCKED=4;a.SLOPE=32;a.BITS=38;a.SWAMP=256;a.BARRIER=512;a.SLOPE8=1024;a.SLOPE9=2048;a.DOLPHIN=4096;a.label=function(a,c){var b,e;return null!==(e=null===(b=a.label)||void 0===b?void 0:b.call(a,c))&&void 0!==e?e:"Terrain"}})(Ac||(Ac={}));
class xc{constructor(a){this._delegate=a;this.enter=a.enter;this.exit=a.exit}label(a){return`Seamless(${Ac.label(this._delegate,a)})`}}class Bc{constructor(a,b=D.OPEN){this.enter=a;this.exit=[[15,b]]}get kind(){return"Simple"}label(a){const b=[];D.isOpen(this.enter)||b.push(`enter = ${Cc(this.enter,a)}`);D.isOpen(this.exit[0][1])||b.push(`exit = ${Cc(this.exit[0][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
class Ic{constructor(a,b){this.enter=a;this.exit=b?[[11,b],[4,D.OPEN]]:[[15,D.OPEN]]}get kind(){return"South"}label(a){if(1===this.exit.length)return Bc.prototype.label.call(this,a);const b=[];D.isOpen(this.enter)||b.push(`enter = ${Cc(this.enter,a)}`);D.isOpen(this.exit[0][1])||b.push(`other = ${Cc(this.exit[0][1],a)}`);D.isOpen(this.exit[1][1])||b.push(`south = ${Cc(this.exit[1][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
function tc(a,b){let c=D.OPEN,d=void 0;b&Ac.DOLPHIN&&b&Ac.FLY?(b&Ac.SLOPE&&(d=a.flags.ClimbWaterfall.r),c=[[a.flags.CurrentlyRidingDolphin.c],[a.flags.Flight.c]]):(b&Ac.SLOPE9?d=a.flags.ClimbSlope9.r:b&Ac.SLOPE8?d=a.flags.ClimbSlope8.r:b&Ac.SLOPE&&(d=a.flags.Flight.r),b&Ac.FLY&&(c=a.flags.Flight.r));b&Ac.SWAMP&&(c=c.map(b=>[a.flags.TravelSwamp.c,...b]));b&Ac.BARRIER&&(c=c.map(b=>[a.flags.ShootingStatue.c,...b]));return new Ic(c,d)}
class uc extends Bc{constructor(a){super(D.OPEN,[[a]]);this._flag=a}get kind(){return"Boss"}}class yc extends Ic{constructor(a){super(D.OPEN,a);this._req=a}get kind(){return"Statue"}}class vc extends Bc{constructor(a,b,c){if(1!==a.exit.length||1!==c.exit.length)throw Error("bad flag");const d=[[b]],e=0<=b?D.meet(c.enter,d):c.enter;b=0<=b?D.meet(c.exit[0][1],d):c.exit[0][1];super(D.or(a.enter,e),D.or(a.exit[0][1],b))}get kind(){return"Flag"}}const zc=new Bc(D.CLOSED,D.CLOSED);
function Jc(a){const b=[];for(var c=0;c<a.exit.length;c++)for(let d=0;4>d;d++)a.exit[c][0]&1<<d&&(b[d]=c);for(c=0;4>c;c++)if(null==b[c])throw Error(`Bad terrain: ${a.exit.map(a=>a[0]).join(",")}`);return b}
class wc{constructor(a,b){this.left=a;this.right=b;const c=Jc(a),d=Jc(b),e=new Set,f=[];for(let a=0;4>a;a++)e.add(c[a]<<2|d[a]);for(const c of e){const [d,e]=a.exit[c>>2],[g,p]=b.exit[c&3];f.push([d&g,D.meet(e,p)])}this.enter=D.meet(a.enter,b.enter);this.exit=f}get kind(){return"Terrain"}label(a){if(1===this.exit.length)return Bc.prototype.label.call(this,a);const b=[];D.isOpen(this.enter)||b.push(`enter = ${Cc(this.enter,a)}`);for(const [c,d]of this.exit){const e=[c&1?"N":"",c&2?"W":"",c&4?"S":"",
c&8?"E":""].join("");b.push(`exit${e} = ${Cc(d,a)}`)}return`${this.kind}(${b.join(", ")})`}}function Cc(a,b){a=[...a];const c=a.map(a=>ea.isEmpty(a)?"open":[...a].map(a=>{var c;return null===(c=b.flags[a])||void 0===c?void 0:c.debug}).join(" & ")).join(") | (");return 1<a.length?`(${c})`:a.length?c:"never"}Ac.debugLabel=Cc;"object"===typeof window&&(window.debugLabel=Cc);function Kc(a){return a}(function(a){a.of=function(a,c){return 16777216*a+c};a.split=function(a){return[Math.floor(a/16777216),a%16777216]}})(Kc||(Kc={}));var Lc,Mc=Lc||(Lc={});Mc[Mc.WIND=0]="WIND";Mc[Mc.FIRE=1]="FIRE";Mc[Mc.WATER=2]="WATER";Mc[Mc.THUNDER=3]="THUNDER";class Nc{constructor(a,b,c,d=1){this.rom=a;this._width=c;this._height=b;this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.element.appendChild(this.canvas);this.canvas.width=c;this.canvas.height=b;this.ctx=this.canvas.getContext("2d")||aa();this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.palettes=new Uint32Array(1024);this.layers=v(d,()=>new Uint32Array(c*b));this.data=this.layers[0];for(d=0;256>d;d++)for(let b=0;4>b;b++){const c=Oc[a.palettes[d].color(b)];
this.palettes[d<<2|b]=c|4278190080}}useLayer(a){this.data=this.layers[a]||aa(`Bad layer: ${a}`)}resizeWidth(a,b){const c=new Uint32Array(b*this._height),d=Math.min(b,this._width);for(let e=0;e<this._height;e++)c.subarray(e*b,e+b+d).set(a.subarray(e*this._width,e*this._width+d));return c}resizeHeight(a,b){const c=new Uint32Array(this._width*b);b=this._width*Math.min(b,this._height);c.subarray(0,b).set(a.subarray(0,b));return c}get width(){return this._width}set width(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=
this.resizeWidth(this.layers[b],a);this._width=a;this.canvas.width=a}get height(){return this._height}set height(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=this.resizeHeight(this.layers[b],a);this._height=a;this.canvas.height=a}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(a){this.data.fill(a)}clear(a){a=null!=a?this.palettes[a<<2]:0;this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.layers[0].fill(a);
for(a=1;a<this.layers.length;a++)this.layers[a].fill(0)}toDataUrl(){return this.canvas.toDataURL("image/png")}render(){let a=this.canvas,b=this.ctx;for(let c=0;c<this.layers.length;c++){c&&(a=document.createElement("canvas"),a.width=this.canvas.width,a.height=this.canvas.height,b=a.getContext("2d")||aa());const d=new Uint8Array(this.layers[c].buffer),e=b.getImageData(0,0,this._width,this._height);e.data.set(d);b.putImageData(e,0,0);c&&this.ctx.drawImage(a,0,0)}}rect(a,b,c,d,e){const f=Math.max(0,
b);c=Math.min(this._height,a+c);d=Math.min(this._width,b+d);for(a=Math.max(0,a);a<c;a++)for(b=f;b<d;b++)this.data[a*this._width+b]=e}tile(a,b,c,d){if(!(0>b||0>a||b+8>=this._width||a+8>=this._height)){c=this.rom.patterns[c].flip(d<<6);for(let e=0;8>e;e++){let f=c.pixels[8|e]<<1,g=c.pixels[e];for(let c=7;0<=c;c--){const h=f&2|g&1;f>>>=1;g>>>=1;h&&(this.data[(a+e)*this._width+b+c]=this.palettes[d&1020|h])}}this._minX=Math.min(this._minX,b);this._maxX=Math.max(this._maxX,b+8);this._minY=Math.min(this._minY,
a);this._maxY=Math.max(this._maxY,a+8)}}metatile(a,b,c,d,e=0){var f=this.rom.locations[d];d=[...f.tilePatterns];f.animation&&(d[1]=this.rom.tileAnimations[f.animation].pages[e&7]);var g=[...f.tilePalettes,127];e=this.rom.tilesets[f.tileset];f=g[e.attrs[c]];for(g=0;2>g;g++)for(let h=0;2>h;h++){const l=e.tiles[g<<1|h][c];this.tile(a+(g<<3),b+(h<<3),d[l&128?1:0]<<6|l&127,f<<2)}}metasprite(a,b,c,d,e=0,f=0){d=this.rom.locations[d];var g=this.rom.metasprites[c];c=[64,66,...d.spritePatterns];d=[0,1,...d.spritePalettes];
let h=!1;null!=g.mirrored&&(g=this.rom.metasprites[g.mirrored],h=!0);if(g&&g.used){f&=g.frameMask;for(let [l,q,p,z]of g.sprites[f]){if(128==l)break;l=128>l?l:l-256;q=128>q?q:q-256;z=z+e&255;f=d[p&3]+176&255;g=c[z>>6]<<6|z&63;h&&(l=-8-l,p^=64);this.tile(a+q,b+l,g,f<<2|p>>6)}}}text(a,b,c,d=18){for(let e=0;e<c.length;e++)this.tile(a,b+8*e,c.charCodeAt(e)|3840,d<<2)}}
const Oc=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];const Pc=Symbol("[LocationMap data]");
class Qc extends Nc{constructor(a,b=0){super(a,1,1,4);this.rom=a;this.flags=new Set;this._maxWidth=Infinity;a=a.locations[b];this.width=256*(a.used?a.width:1);this.height=240*(a.used?a.height:1);this.location=a;a=a=>{let b=a.offsetX,c=a.offsetY;for(var f=a.target;f&&f!==this.element;)f=f.parentElement;if(f){f=b>>8;var g=Math.floor(c/240);Qc.setData(a,{tile:this.location.id<<16|g<<12|f<<8|c-240*g>>4<<4|b-256*f>>4,target:this})}};this.element.addEventListener("mousemove",a);this.element.addEventListener("mousedown",
a);this.element.addEventListener("mouseup",a);this.element.addEventListener("click",a);this.redraw()}static getData(a){return a[Pc]}static setData(a,b){a[Pc]=b}get id(){return this.location.id}set id(a){this.location=this.rom.locations[a];this.height=240*(this.location.used?this.location.height:1);this.width=256*(this.location.used?this.location.width:1);this.ensureWidth();this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(a){this._maxWidth=a;this.ensureWidth()}ensureWidth(){if(this.width<=
this._maxWidth)this.element.style.transform="",this.element.style.width="",this.element.style.height="";else{var a=this._maxWidth/this.width,b=50*(1-a);this.element.style.transform=`translate(-${b}%,-${b}%) scale(${a})`;this.element.style.width=`${this.width*a}px`;this.element.style.height=`${this.height*a}px`}}clearOverlay(){this.useLayer(1);this.fill(0);this.useLayer(3);this.fill(0);this.render()}overlayShade(a){this.useLayer(3);this.fill(a)}overlayArea(a,b,c){for(const d of a){if(d>>>16!==this.location.id)continue;
const e=240*(d>>>12&15)+16*(d>>>4&15),f=256*(d>>>8&15)+16*(d&15);null!=c&&(this.useLayer(3),this.rect(e-1,f-1,18,18,0));this.useLayer(1);a.has(fc.add(d,-1,0))||this.rect(e-1,f-1,2,18,b);a.has(fc.add(d,0,-1))||this.rect(e-1,f-1,18,2,b);a.has(fc.add(d,1,0))||this.rect(e+15,f-1,2,18,b);a.has(fc.add(d,0,1))||this.rect(e-1,f+15,18,2,b)}}redraw(){this.useLayer(0);this.clear(this.location.tilePalettes[0]);for(var a=0;a<this.location.height;a++)for(var b=0;b<this.location.width;b++)this.drawScreen(this.rom.screens[this.location.screens[a][b]],
a,b);this.useLayer(2);for(const c of this.location.spawns){a=0;let {x:d,y:e}=c;e-=c.yt&240;let f;if(c.isNpc()){b=this.rom.npcs[c.id];if(!b||!b.data)continue;d+=8;e+=12;f=2|b.data[3]}else if(c.isChest())f=170;else if(c.isMonster()){b=this.rom.objects[c.monsterId];if(!b)continue;f=b.metasprite;41==b.action?f=104:[42,94].includes(b.action)&&(f=2|b.data[31])}c.patternBank&&(a+=64);null!=f&&this.metasprite(e,d,f,this.location.id,a)}this.render()}drawScreen(a,b,c){var d;const e=240*b,f=256*c,g=this.rom.tilesets[this.location.tileset];
let h,l=!1;for(const a of this.location.flags)if(a.xs===c&&a.ys===b){h=a.flag;if(null===(d=this.rom.flags[h])||void 0===d?0:d.logic.assumeTrue)l=!0;break}for(b=0;240>b;b+=16)for(c=0;16>c;c++)d=a.tiles[b|c],32>d&&(this.flags.has(h)||l)&&(d=g.alternates[d]),this.metatile(e+b,f+16*c,d,this.location.id,0)}};class Rc{constructor(a,b){this.rom=a;this.world=b;this.element=document.createElement("div");this.element.addEventListener("click",a=>this.click(a));this.element.addEventListener("mousemove",a=>this.move(a));this.renderArea(0)}click(a){if(a=Qc.getData(a))if(a=this.world.tiles.get(a.tile),null!=a){if(a.area===this.area){const b=null!=a.exit?this.world.tiles.get(a.exit):null;b&&b.area!==this.area&&(a=b)}a.area&&a.area!==this.area&&this.renderArea(a.area.id)}}move(a){if(a=Qc.getData(a)){var b=this.world.tiles.get(a.tile);
null!=b&&(b=null!=b.exit&&!this.area.tiles.has(b.exit),a.target.element.style.cursor=b?"pointer":"default")}}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(a){var b;this.clear();const c=document.createElement("select");c.appendChild(document.createElement("option"));c.children[0].textContent="Select location";for(const a of this.rom.locations){if(!a.used)continue;const d=null===(b=this.world.locations[a.id])||void 0===b?void 0:b.areas[Symbol.iterator]().next().value;
if(null==d)continue;const f=document.createElement("option");f.textContent=`${x(a.id)} ${a.name}`;f.value=String(d.id);c.appendChild(f)}c.addEventListener("change",()=>{this.renderArea(Number(c.value))});this.element.appendChild(c);this.area=this.world.areas[a];b=document.createElement("pre");b.textContent=`Area ${a}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${Ac.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([a,b])=>`${a.debug}: ${Cc(b,this.rom)}`))].join("\n  ")}
Routes:
  ${Cc(this.area.routes,this.rom).split(" | ").join("\n  ").replace(/[()]/g,"")}`;this.element.appendChild(b);for(const c of this.area.locations)a=this.rom.locations[c],b=document.createElement("h2"),b.textContent=a.name,this.element.appendChild(b),this.element.appendChild(this.makeLocation(this.area,a))}makeLocation(a,b){const c=new Qc(this.rom,b.id);c.maxWidth=574;c.overlayShade(1426063360);for(const d of this.world.locations[b.id].areas)d!==a&&c.overlayArea(d.tiles,4294901760);c.overlayArea(a.tiles,
4278255615,0);c.render();return c.element}};class Sc{constructor(a,b){this.rom=a;this.id=b}write(){return[]}toString(){return`${this.constructor.name} $${x(this.id)}`}}class Tc extends Array{static get [Symbol.species](){return Array}};class Uc extends Tc{constructor(a){super(44);this.rom=a;this.innBasePrice=20;this.toolShopScaling=Array(48).fill(0);this.armorShopScaling=Array(48).fill(0);for(let b=0;44>b;b++)this[b]=new Vc(a,b);if(null!=a.shopDataTablesAddress){const b=a.shopDataTablesAddress+21*a.shopCount+2*a.scalingLevels;this.basePrices=v(73,c=>13<=c&&39>c?Lb(a.prg,b+2*(c-13)):0)}else this.basePrices=v(73,b=>2*Lb(a.prg,138946+2*b))}armorShops(){return v(11,a=>this[4*a])}toolShops(){return v(11,a=>this[4*a+1])}inns(){return v(11,
a=>this[4*a+2])}pawnShops(){return v(11,a=>this[4*a+3])}write(){var a,b,c,d,e,f,g,h;const l=this.rom.assembler();if(this.rescale){var q=function(a){l.export(a);l.label(a)};l.segment("10","fe","ff");l.reloc("ShopData");q("ShopData");q("ArmorShopIdTable");for(const b of this.armorShops())for(var p=0;4>p;p++)l.byte(null!==(a=b.contents[p])&&void 0!==a?a:255);q("ToolShopIdTable");for(const a of this.toolShops())for(p=0;4>p;p++)l.byte(null!==(b=a.contents[p])&&void 0!==b?b:255);q("ArmorShopPriceTable");
for(const a of this.armorShops())for(p=0;4>p;p++)l.byte(Math.round(32*(null!==(c=a.prices[p])&&void 0!==c?c:0)));q("ToolShopPriceTable");for(const a of this.toolShops())for(c=0;4>c;c++)l.byte(Math.round(32*(null!==(d=a.prices[c])&&void 0!==d?d:0)));q("InnPrices");for(const a of this.inns())l.byte(Math.round(32*(null!==(e=a.prices[0])&&void 0!==e?e:0)));q("ShopLocations");for(const a of this)l.byte(a.location);q("ToolShopScaling");l.byte(...this.toolShopScaling);q("ArmorShopScaling");l.byte(...this.armorShopScaling);
q("BasePrices");l.word(...this.basePrices.slice(13,39).map(a=>null!==a&&void 0!==a?a:0));q("InnBasePrice");l.word(this.innBasePrice)}else{l.segment("10","fe","ff");l.org(40356,"ShopData");for(const a of this.armorShops())for(d=0;4>d;d++)l.byte(null!==(f=a.contents[d])&&void 0!==f?f:255);for(const a of this.armorShops())for(d=0;4>d;d++)l.word(null!==(g=a.prices[d])&&void 0!==g?g:0);for(const a of this.toolShops())for(d=0;4>d;d++)l.byte(null!==(h=a.contents[d])&&void 0!==h?h:255);for(p of this.toolShops())for(d=
0;4>d;d++)l.word(null!==(q=p.prices[d])&&void 0!==q?q:0)}return[l.module()]}}var Wc,Xc=Wc||(Wc={});Xc[Xc.ARMOR=0]="ARMOR";Xc[Xc.TOOL=1]="TOOL";Xc[Xc.INN=2]="INN";Xc[Xc.PAWN=3]="PAWN";const Yc=[Wc.ARMOR,Wc.TOOL,Wc.INN,Wc.PAWN],Zc=[a=>a?a:138660,(a,b)=>a?a+4*b:138792,()=>0,()=>0],$c=[4,4,0,0],ad=[(a,b)=>a?a+8*b:138704,(a,b)=>a?a+12*b:138836,(a,b)=>a?a+16*b:138924,()=>0],ed=[4,4,1,0];
class Vc extends Sc{constructor(a,b){super(a,b);this.type=Yc[b&3];this.index=b>>>2;if(a.shopDataTablesAddress)this.location=a.prg[a.shopDataTablesAddress+17*a.shopCount+b];else{b=255;for(let d=0;33>d&&255===b;d++){if(a.prg[139125+d]!==this.index)continue;const e=a.prg[139092+d];for(var c of a.locations[e].spawns)if(4===c.type&&a.objects[c.id].data[25]===32+this.type){b=e;break}}this.location=b}c=a.shopDataTablesAddress?b=>a.prg[this.pricesAddress+b]/32:b=>Lb(a.prg,this.pricesAddress+2*b);this.contents=
Db(a.prg,this.contentsAddress,$c[this.type]);this.prices=v(ed[this.type],c);this.used=255!==this.location}get contentsAddress(){return Zc[this.type](this.rom.shopDataTablesAddress,this.rom.shopCount)+4*this.index}get pricesAddress(){const a=this.rom.shopDataTablesAddress;return ad[this.type](a,this.rom.shopCount)+(a?1:2)*ed[this.type]*this.index}updateShopkeeper(){throw Error("not implemented");}};class fd{constructor(){this.data=new Map;this.sizes=new Map}find(a){if(a!==a)throw"nan";this.data.has(a)||(this.data.set(a,a),this.sizes.set(a,1));let b;for(;!Object.is(b=this.data.get(a),a);)this.data.set(a,a=this.data.get(b));return a}union(a){this.find(a[0]);for(let b=1;b<a.length;b++){if(a[b]!==a[b])throw"nan";this.unionInternal(a[0],a[b])}}unionInternal(a,b){a=this.find(a);b=this.find(b);if(a!==b){var c=this.sizes.get(a),d=this.sizes.get(b);c<d?(this.sizes.set(b,c+d),this.data.set(a,b)):(this.sizes.set(a,
c+d),this.data.set(b,a))}}sets(){const a=new Map;for(const b of this.data.keys()){const c=this.find(b);let d=a.get(c);d||a.set(c,d=new Set);d.add(b)}return[...a.values()]}map(){const a=new m(()=>new Set);for(const b of this.data.keys()){let c=a.get(this.find(b));a.set(b,c);c.add(b)}return a}roots(){const a=new Set;for(const b of this.data.keys())a.add(this.find(b));return[...a]}};const gd={next(){return{done:!0}}},hd={get size(){return 0},has(){return!1},[Symbol.iterator](){return gd}},E={get size(){return Infinity},has(){return!0},[Symbol.iterator](){throw Error("cannot iterate");}};class id{constructor(a){this.bit=a}get size(){return 1}has(a){return a===this.bit}[Symbol.iterator](){return[this.bit][Symbol.iterator]()}}function jd(a){return new id(a)}var kd;
(function(a){a.intersect=function(a,c){if(a===E||!c.size)return c;if(c===E||!a.size)return a;const b=new Set;for(const d of a)c.has(d)&&b.add(d);return b.size?b:hd};a.union=function(a,c){if(a===E||!c.size)return a;if(c===E||!a.size)return c;a=new Set(a);for(const b of c)a.add(b);return a};a.isSubset=function(a,c){if(c===E||!a.size)return!0;if(a.size>c.size)return!1;for(const b of a)if(!c.has(b))return!1;return!0};a.label=function(a){return a===E?"all":[...a].sort().join(" ")}})(kd||(kd={}));
class ld{constructor(a,b,c){this.fixed=a;this.float=b;this.shift=c}get pat0(){return this.fixed[0]}get pat1(){return this.fixed[1]}get pal2(){return this.fixed[2]}get pal3(){return this.fixed[3]}static get ALL(){return new ld([E,E,E,E],[],0)}static get NONE(){return new ld([hd,hd,hd,hd],[],0)}static get MIMIC(){return new ld([E,jd(108),E,E],[],2)}static get TREASURE_CHEST(){return new ld([E,E,E,E],[md],0)}static get BOSS(){return new ld([md,E,E,E],[],0)}static get COIN(){return new ld([nd,E,E,E],
[],0)}static get STOM_FIGHT(){return new ld([E,new Set([77]),E,E],[],0)}static get GUARDIAN_STATUE(){return new ld([new Set([116]),new Set([98]),E,E],[],0)}static get SHOOTING_WALL(){return new ld([new Set([97]),E,E,E],[],0)}static get KENSU_CHEST(){return new ld([new Set([81]),E,E,E],[],0)}static forLocation(a){switch(a){case 3:return new ld([E,jd(96),E,jd(32)],[],0);case 96:case 100:case 104:return new ld([E,jd(82),E,jd(8)],[],0)}return ld.ALL}static fromSpawn(a,b,c,d,e){const [f,...g]=b;(e=e&&
2===f&&!g.length)&&d.patternBank&&(b=new Set([3]));const h=e||!b.has(2)?E:jd(c.spritePatterns[0]);b=e||!b.has(3)?E:jd(c.spritePatterns[1]);d=e?[jd(c.spritePatterns[d.patternBank])]:[];e=a.has(2)?jd(c.spritePalettes[0]):E;a=a.has(3)?jd(c.spritePalettes[1]):E;return new ld([h,b,e,a],d,0)}ignorePalette(){return new ld([this.fixed[0],this.fixed[1],E,E],this.float,this.shift)}shufflePalette(a,b){const c=[...this.fixed];for(let d=2;4>d;d++){if(c[d]===E)continue;const e=Math.floor(5-Math.log2(a.nextInt(15)+
2)),f=c[d]=new Set;for(let c=0;c<e;c++)f.add(a.pick(b))}return new ld(c,this.float,this.shift)}shifted(){return new ld(this.fixed,this.float,this.shift|2)}join(a){const b=v(4,b=>kd.union(this.fixed[b],a.fixed[b]));if(this.float.length!==a.float.length)throw console.dir(this),console.dir(a),Error(`incompatible float: ${this.float} ${a.float}`);const c=v(this.float.length,b=>kd.union(this.float[b],a.float[b]));return new ld(b,c,this.shift|a.shift)}fix(a,b){var c=b?a=>b.nextInt(a):()=>0;const d=b?a=>
b.pick([...a]):a=>a[Symbol.iterator]().next().value,e=[...this.fixed];if(this.float.length){c=c(2);const a=1-c;c<this.float.length&&(e[0]=kd.intersect(e[0],this.float[c]));a<this.float.length&&(e[1]=kd.intersect(e[1],this.float[a]))}e[0]!==E&&(a.spritePatterns[0]=d([...e[0]]));e[1]!==E&&(a.spritePatterns[1]=d([...e[1]]));e[2]!==E&&(a.spritePalettes[0]=d([...e[2]]));e[3]!==E&&(a.spritePalettes[1]=d([...e[3]]))}meet(a,b=!1){a=this.tryMeet(a,b);if(!a)throw Error("Could not reconcile patterns");return a}tryMeet(a,
b=!1){const c=[];let d=this.shift|a.shift;for(var e=0;4>e;e++){var f=kd.intersect(this.fixed[e],a.fixed[e]);if(!f.size){if(!b||2>e)return;f=kd.union(this.fixed[e],a.fixed[e])}c.push(f)}e=new Map;b=[];for(var g of ea.concat(this.float,a.float)){if(g===E)throw Error("Unexpected unconstrained float");a=!1;for(var h of g)if(f=e.get(h),null!=f){for(var l of b[f])e.delete(l);b[f]=kd.intersect(b[f],g);for(const a of b[f])e.set(a,f);a=!0;break}if(a)break;for(const a of g)e.set(a,b.length);b.push(g);if(2<
b.length)return}for(g=0;g<b.length;g++)for(h=0;2>h;h++)if(!kd.intersect(b[g],c[h]).size){l=c[1-h]=kd.intersect(b[g],c[1-h]);d|=1<<1-h;if(!l.size)return;b.splice(g,1);g=-1;break}return new ld(c,b,d)}}const md=new Set([94,95,96,97,100,101,102,103,104,105,106,108,109,110,111,112,116,117,118,119]),nd=new Set([94,95,96,97,99,100,101,102,103,104,105,106,107,108,109,110,111,112,116,117,118,119]);class od extends Sc{constructor(a,b){super(a.rom,b);this.constraint=ld.ALL;a[b]=this;this.used=!0;this.name="";this.base=Lb(this.rom.prg,this.pointer)+65536;this.sfx=this.rom.prg[this.base];this.data=[];a=this.base+1;b=0;for(let c=0;32>c;c++)c&7||(b=this.rom.prg[a++]),this.data.push(b&128?this.rom.prg[a++]:0),b<<=1}get pointer(){return 109568+(this.id<<1)}serialize(){const a=[this.sfx];for(let b=0;4>b;b++){const c=a.length;a.push(0);for(let d=0;8>d;d++)this.data[8*b+d]&&(a[c]|=128>>>d,a.push(this.data[8*
b+d]))}return a}write(){const a=`Object_${this.id.toString(16).padStart(2,"0")}`,b=this.rom.assembler();b.segment("0d");b.reloc(a);const c=b.pc();b.byte(...this.serialize());b.org(44032+(this.id<<1),`${a}_Ptr`);b.word(c);return[b.module()]}get(a){return this.data[a-768>>>5]}parents(){return[]}spawnedChild(){var a;if(null!==(a=this.rom.objectActions[this.action])&&void 0!==a&&a.data.hasChild&&(a=(a=this.rom.adHocSpawns[this.child])&&a.objectId,null!=a))return this.rom.objects[a]}spawnedReplacement(){if(this.replacement)return this.rom.objects[this.replacement]}locations(){return this.rom.locations.filter(a=>
a.used&&a.spawns.some(a=>a.isMonster()&&a.monsterId===this.id))}palettes(a=!1){var b,c;if(34===this.action)return[3];var d=this.data[0];42===this.action&&(d=this.data[31]|1);41===this.action&&(d=107);38===this.action&&(d=156);d=this.rom.metasprites[d];a=a&&this.child?this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]]:null;return[...new Set([...null!==(b=null===d||void 0===d?void 0:d.palettes())&&void 0!==b?b:[],...null!==(c=null===a||void 0===a?void 0:a.palettes())&&
void 0!==c?c:[]])]}isVulnerable(a){return!(this.elements&1<<a)}isShadow(){return 123===this.id||140===this.id}get metasprite(){return pd.get(this.data)}set metasprite(a){pd.set(this.data,a)}get speed(){return qd.get(this.data)}set speed(a){qd.set(this.data,a)}get collisionPlane(){return rd.get(this.data)}set collisionPlane(a){rd.set(this.data,a)}get hitbox(){return sd.get(this.data)}set hitbox(a){sd.set(this.data,a)}get hp(){return td.get(this.data)}set hp(a){td.set(this.data,a)}get atk(){return ud.get(this.data)}set atk(a){ud.set(this.data,
a)}get def(){return vd.get(this.data)}set def(a){vd.set(this.data,a)}get level(){return wd.get(this.data)}set level(a){wd.set(this.data,a)}get poison(){return!!xd.get(this.data)}set poison(a){xd.set(this.data,a?1:0)}get child(){return yd.get(this.data)}set child(a){yd.set(this.data,a)}get terrainSusceptibility(){return zd.get(this.data)}set terrainSusceptibility(a){zd.set(this.data,a)}get immobile(){return!!Ad.get(this.data)}set immobile(a){Ad.set(this.data,a?1:0)}get action(){return Bd.get(this.data)}set action(a){Bd.set(this.data,
a)}get replacement(){return Cd.get(this.data)}set replacement(a){Cd.set(this.data,a)}get goldDrop(){return Dd.get(this.data)}set goldDrop(a){Dd.set(this.data,a)}get elements(){return Ed.get(this.data)}set elements(a){Ed.set(this.data,a)}get expReward(){return Fd.get(this.data)}set expReward(a){Fd.set(this.data,a)}get attackType(){return Gd.get(this.data)}set attackType(a){Gd.set(this.data,a)}get statusEffect(){return Hd.get(this.data)}set statusEffect(a){Hd.set(this.data,a)}toString(){return super.toString()+
(this.name?" "+this.name:"")}}function Id(...a){return new Jd(...a)}class Jd{constructor(...a){this.spec=a}get(a){let b=0;for(const [c,d=255,e=0]of this.spec)b|=(a[c-768>>>5]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b}set(a,b){for(const [c,d=255,e=0]of this.spec){const f=c-768>>>5;a[f]=a[f]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d}}}
const pd=Id([768]),qd=Id([832,15]),rd=Id([928,240,4]),sd=Id([1056,64,2],[928,15]),td=Id([960]),ud=Id([992]),vd=Id([1024]),wd=Id([1056,31]),xd=Id([1056,128,7]),yd=Id([1088]),zd=Id([1120]),Ad=Id([1184,128,7]),Bd=Id([1184,127]),Cd=Id([1216]),Dd=Id([1280,240,4]),Ed=Id([1280,15]),Fd=Id([1312]),Gd=Id([1344]),Hd=Id([1376,15]);class F extends od{constructor(a,b){super(a,b.id);a=b.scaling;var c=((24>a?1+a/3:(a+12)/4)+this.level)/2;a:{var d=this.elements;d=void 0===d?0:d;var e=10>a?1:18>a?2:38>a?4:8;for(var f=e;f;f>>>=1)if(!(f&d)){d=f<<1;break a}d=e<<1}d=c+d;this.hits=(this.hp+1)/(d-this.def);this.sdef=this.def/d;c=Math.min(255,Math.max(16,32+16*c));d=this.atk;e=24>a?1+a/3:(a+12)/4;f=this.attackType?Kd(a,2,[6,6],[18,8],[25,12],[30,18],[37,24],[42,32]):Kd(a,2,[6,6],[18,10],[25,14],[30,18],[40,24],[46,32]);this.satk=(d-(e+
f))/c;this.extraDifficulty=b.difficulty||0;this.monsterClass=b.class;c=this.expReward;c=(128>c?c:(c&127)<<4)/Math.pow(2,a/5-1);a=Ld[this.goldDrop]/Math.pow(2,a/7-1);this.type=b.type||"monster";this.wealth=a&&a/(c+a)}isBoss(){return"boss"===this.type}isProjectile(){return"projectile"===this.type}isFlyer(){const a=this.rom.objectActions[this.action];return(null===a||void 0===a?void 0:a.data.bird)||(null===a||void 0===a?void 0:a.data.moth)||!1}placement(){var a,b;return null!==(b=null===(a=this.rom.objectActions[this.action])||
void 0===a?void 0:a.data.placement)&&void 0!==b?b:"normal"}clearance(){var a;return(null===(a=this.rom.objectActions[this.action])||void 0===a?0:a.data.large)?6:3}totalDifficulty(){return this.toughness()+this.attack()+this.statusDifficulty()+this.immunities()+this.movement()}collectDifficulty(a,b){let c=a(this);var d=this.spawnedChild();d instanceof F&&(c=b(c,d.collectDifficulty(a,b)));d=this.spawnedReplacement();d instanceof F&&(c=b(c,d.collectDifficulty(a,b)));return c}toughness(){return this.collectDifficulty(a=>
Kd(a.hits,0,[2,1],[3,2],[5,3],[7,4],[10,5],[13,6]),Math.max)}attack(){return this.collectDifficulty(a=>a.attackType&&a.statusEffect?0:Kd(a.satk,0,[.04,1],[.08,2],[.13,3],[.18,4],[.25,5],[.33,6]),Math.max)}addStatusEffects(a){this.attackType&&this.statusEffect?a.add(this.statusEffect):!this.attackType&&this.poison&&a.add(0);var b=this.spawnedReplacement();b instanceof F&&b.addStatusEffects(a);b=this.spawnedChild();b instanceof F&&b.addStatusEffects(a)}statusDifficulty(){const a=new Set;this.addStatusEffects(a);
let b=0;for(const c of a)b+=Md[c];return b}immunities(){let a=0,b=this.elements;for(;b;)b&1&&a++,b>>>=1;return a&&1<<a-1}movement(){return this.collectDifficulty(a=>{const b=this.rom.objectActions[a.action],c=a.spawnedChild();a=a.extraDifficulty;b&&(a+=b.data.movement||0,b.data.large&&a++,c&&!c.statusEffect&&(a+=b.data.projectile||0));167===this.metasprite&&(a+=2);return a},(a,b)=>a+b)}totalReward(){return this.totalDifficulty()/4}normalizedGold(){if(!this.wealth)return 0;const a=this.totalDifficulty()*
this.wealth*.6;return Math.max(1,Math.min(15,Math.round(a)))}normalizedExp(){if(1===this.wealth)return 0;const a=.488+this.totalDifficulty()*(1-this.wealth)*.256;return Math.max(1,Math.min(255,Math.round(32*a)))}toString(){return`Monster $${x(this.id)} ${this.name}`}}const Md=[2,1,3,2,4],Ld=[0,1,2,4,8,16,30,50,100,200,400,50,100,200,400,500];function Kd(a,b,...c){for(let b=c.length-1;0<=b;b--){const [d,f]=c[b];if(a>=d)return f}return b};class Nd{constructor(a,b,c=!1){this.rom=a;this.flagset=b;this.tracker=c;this.terrainFactory=new sc(this.rom);this.terrains=new Map;this.checks=new m(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new m(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new fd;this.neighbors=new m(()=>0);this.routes=new m(()=>new D.Builder);this.routeEdges=new m(()=>new ha);this.requirementMap=new m(a=>new D.Builder(a));for(const b of a.items)for(const a of b.itemUseData)"expect"===
a.kind?this.itemUses.get(a.want).push([b,a]):"location"===a.kind&&this.itemUses.get(~a.want).push([b,a]);this.aliases=new Map([[a.flags.ChangeAkahana,a.flags.Change],[a.flags.ChangeSoldier,a.flags.Change],[a.flags.ChangeStom,a.flags.Change],[a.flags.ChangeWoman,a.flags.Change],[a.flags.ParalyzedKensuInDanceHall,a.flags.Paralysis],[a.flags.ParalyzedKensuInTavern,a.flags.Paralysis]]);for(const b of a.locations)this.processLocation(b);this.addExtraChecks();this.unionNeighbors();this.recordExits();this.buildNeighbors();
this.addAllRoutes();this.consolidateChecks();this.buildRequirementMap()}addExtraChecks(){const {locations:{Leaf_ToolShop:a,MezameShrine:b,Oak:c,Shyron_ToolShop:d},flags:{AbleToRideDolphin:e,BallOfFire:f,BallOfThunder:g,BallOfWater:h,BallOfWind:l,Barrier:q,BlizzardBracelet:p,BowOfMoon:z,BowOfSun:B,BreakStone:A,BreakIce:w,BreakIron:S,BrokenStatue:ja,BuyHealing:O,BuyWarp:T,ClimbWaterfall:X,ClimbSlope8:oa,ClimbSlope9:xb,CurrentlyRidingDolphin:Rb,Flight:ab,FlameBracelet:fb,FormBridge:pb,GasMask:Bb,GlowingLamp:Ra,
InjuredDolphin:gb,LeadingChild:Sb,LeatherBoots:Tb,Money:Oa,OpenedCrypt:bd,RabbitBoots:jc,Refresh:qb,RepairedStatue:Dc,RescuedChild:Cb,ShellFlute:kc,ShieldRing:Ec,ShootingStatue:lc,StormBracelet:Fc,Sword:cd,SwordOfFire:bb,SwordOfThunder:mc,SwordOfWater:nc,SwordOfWind:oc,TornadoBracelet:Gc,TravelSwamp:Hc,WildWarp:dd},items:{MedicalHerb:Ub,WarpBoots:I}}=this.rom,ba=this.entrance(b);var Ca=this.entrance(c);this.addCheck([ba],Od(z,B),[bd.id]);this.addCheck([ba],Od(e,kc),[Rb.id]);this.addCheck([Ca],Od(Sb),
[Cb.id]);this.addItemCheck([ba],Od(Ra,ja),Dc.id,{lossy:!0,unique:!0});for(var Ja of this.rom.shops)if(Ja.location!==a.id&&Ja.location!==d.id&&Ja.used&&Ja.type===Wc.TOOL){Ca=[fc(Ja.location<<16|136)];for(var rb of Ja.contents)rb===Ub.id?this.addCheck(Ca,Oa.r,[O.id]):rb===I.id&&this.addCheck(Ca,Oa.r,[T.id])}Ja=oc.r;rb=bb.r;Ca=nc.r;let pc=mc.r;if(!this.flagset.orbsOptional()){var Vb=Pd(l,Gc);const a=Pd(f,fb),b=Pd(h,p),c=Pd(g,Fc);Ja=D.meet(Ja,Vb);rb=D.meet(rb,a);Ca=D.meet(Ca,b);pc=D.meet(pc,c);if(this.flagset.assumeSwordChargeGlitch()){Vb=
function(b){return a.map(a=>a[0]===b.c?a:[b.c,...a])};const a=D.or(Ja,rb,Ca,pc);Ja=Vb(oc);rb=Vb(bb);Ca=Vb(nc);pc=Vb(mc)}}this.addCheck([ba],Ja,[A.id]);this.addCheck([ba],rb,[w.id]);this.addCheck([ba],Ca,[pb.id]);this.addCheck([ba],pc,[S.id]);this.addCheck([ba],Pd(oc,bb,nc,mc),[cd.id]);this.addCheck([ba],ab.r,[X.id]);this.addCheck([ba],Pd(ab,jc),[oa.id]);this.addCheck([ba],Pd(ab,jc),[xb.id]);this.addCheck([ba],q.r,[lc.id]);this.addCheck([ba],Bb.r,[Hc.id]);this.flagset.leatherBootsGiveSpeed()&&this.addCheck([ba],
Tb.r,[oa.id]);this.flagset.assumeGhettoFlight()&&this.addCheck([ba],Od(Rb,jc),[X.id]);this.flagset.fogLampNotRequired()&&(Ja=this.flagset.requireHealedDolphinToRide(),this.addCheck([ba],Ja?gb.r:[[]],[e.id]));this.flagset.guaranteeBarrier()||this.addCheck([ba],[[Oa.c,O.c],[Oa.c,Ec.c],[Oa.c,qb.c]],[lc.id]);this.flagset.assumeFlightStatueSkip()||this.addCheck([ba],[[Oa.c,ab.c]],[lc.id]);this.flagset.guaranteeGasMask()||this.addCheck([ba],[[Oa.c,O.c],[Oa.c,qb.c]],[Hc.id]);this.flagset.assumeWildWarp()&&
this.addCheck([ba],D.OPEN,[dd.id])}addExtraRoutes(){var a;const {flags:{BuyWarp:b,SwordOfThunder:c,Teleport:d,WildWarp:e},locations:{MezameShrine:f}}=this.rom;this.addRoute(new qc(this.entrance(f),[]));if(this.flagset.teleportOnThunderSword()){var g=this.rom.townWarp.thunderSwordWarp;this.addRoute(new qc(this.entrance(g[0],g[1]&31),[c.c,b.c]));this.addRoute(new qc(this.entrance(g[0],g[1]&31),[c.c,d.c]))}if(this.flagset.assumeWildWarp())for(const b of this.rom.wildWarp.locations){if(b===this.rom.locations.UndergroundChannel.id)continue;
g=this.entrance(b);const c=null!==(a=this.terrains.get(g))&&void 0!==a?a:aa("bad entrance");for(const a of c.enter)this.addRoute(new qc(g,[e.c,...a]))}}consolidateChecks(){for(const [a,b]of this.checks){const c=this.tiles.find(a);if(a!==c){for(const a of b)this.checks.get(c).add(a);this.checks.delete(a)}}}buildRequirementMap(){for(const [a,b]of this.checks)for(const {checks:c,requirement:d}of b)for(const b of c){const c=this.requirementMap.get(b);for(const b of d)for(const d of this.routes.get(a)||
[])c.addList([...b,...d])}}getLocationList(a="Crystalis"){return{worldName:a,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:a=>this.rom.flags[a].name,prefill:a=>{const {Crystalis:b,MesiaInTower:d,LeafElder:e}=this.rom.flags,f=new Map([[d.id,b.id]]);this.flagset.guaranteeSword()&&f.set(e.id,512|a.nextInt(4));return f}}}processLocation(a){a.used&&(this.processLocationTiles(a),this.processLocationSpawns(a),this.processLocationItemUses(a))}unionNeighbors(){for(const [b,c]of this.terrains){var a=
fc.add(b,0,1);this.terrains.get(a)===c&&this.tiles.union([b,a]);a=fc.add(b,1,0);this.terrains.get(a)===c&&this.tiles.union([b,a])}}addAllRoutes(){this.addExtraRoutes();for(const [b,c]of this.neighbors){const [d,e]=Kc.split(b);var a=this.terrains.get(d);const f=this.terrains.get(e);if(!a||!f)throw Error(`missing terrain ${x(a?d:e)}`);for(const [b,h]of a.exit)if(b&c)for(const a of h)for(const b of f.enter)this.addRoute(new qc(e,[...a,...b]),d)}"object"===typeof document&&(a=document.getElementById("debug"))&&
a.appendChild((new Rc(this.rom,this.getWorldData())).element)}getWorldData(){var a=0;const b=new m(()=>({})),c=v(256,()=>({areas:new Set,tiles:new Set})),d=[];for(var e of this.tiles.sets()){var f=this.tiles.find(ea.first(e)),g=this.terrains.get(f);if(g&&(f=this.routes.has(f)?D.freeze(this.routes.get(f)):[],f.length)){g={checks:[],id:a++,locations:new Set,routes:f,terrain:g,tiles:new Set};d.push(g);for(const a of e)f=a>>>16,g.locations.add(f),g.tiles.add(a),c[f].areas.add(g),c[f].tiles.add(a),b.get(a).area=
g}}for(const [a,c]of this.exits)b.has(a)&&(b.get(a).exit=c);for(const [c,d]of this.checks)if(a=b.get(c).area)for(const {checks:b,requirement:c}of d)for(const d of b)e=this.rom.flags[d]||aa(),a.checks.push([e,c]);return{tiles:b,areas:d,locations:c}}addRoute(a,b){if(null!=b){this.routeEdges.get(b).add(a);for(var c of this.routes.get(b))this.addRoute(new qc(a.target,[...c,...a.deps]))}else for(b=new ha,c=new ha,b.add(a),a=b[Symbol.iterator]();;){const {value:d,done:e}=a.next();if(e)break;c.add(d);b.delete(d);
const f=new ha,g=d.target;if(this.routes.get(g).addRoute(d))for(const a of this.routeEdges.get(g))f.add(new qc(a.target,[...d.deps,...a.deps]));for(const a of f)c.has(a)||(b.delete(a),b.add(a))}}recordExits(){for(const [a,b]of this.exits)this.exitSet.add(Kc.of(this.tiles.find(a),this.tiles.find(b)));for(const a of this.exitSet){const [b,c]=Kc.split(a);if(this.terrains.get(b)!==this.terrains.get(c))continue;const d=Kc.of(c,b);this.exitSet.has(d)&&(this.tiles.union([b,c]),this.exitSet.delete(a),this.exitSet.delete(d))}}buildNeighbors(){for(const [c,
d]of this.terrains)if(d){var a=fc.add(c,1,0),b=this.terrains.get(a);b&&b!==d&&this.handleAdjacentNeighbors(c,a,ec.North);a=fc.add(c,0,1);(b=this.terrains.get(a))&&b!==d&&this.handleAdjacentNeighbors(c,a,ec.West)}for(const b of this.exitSet){const [c,e]=Kc.split(b);this.terrains.has(c)&&this.terrains.has(e)&&(a=Kc.of(this.tiles.find(c),this.tiles.find(e)),this.neighbors.set(a,this.neighbors.get(a)|1))}}handleAdjacentNeighbors(a,b,c){var d=this.tiles.find(a);const e=this.tiles.find(b);this.seamlessExits.has(b)||
(b=Kc.of(e,d),this.neighbors.set(b,this.neighbors.get(b)|1<<c));this.seamlessExits.has(a)||(a=c^2,d=Kc.of(d,e),this.neighbors.set(d,this.neighbors.get(d)|1<<a))}processLocationTiles(a){var b,c,d,e=new Map;const f=new Set,g=88===(a.id&248);for(var h of a.spawns)h.isWall()?e.set(rc.from(a,h),h.id&3):h.isMonster()&&63===h.id&&f.add(rc.from(a,h));h=this.rom.tilesets[a.tileset];const l=this.rom.tileEffects[a.tileEffects-179],q=b=>l.effects[this.rom.screens[a.screens[(b&61440)>>>12][(b&3840)>>>8]].tiles[b&
255]],p=(b,c,d)=>{b&=Ac.BITS;26===a.id&&(b|=Ac.SWAMP);if(96===a.id||104===a.id)b|=Ac.DOLPHIN;100===a.id&&4144>(c&61680)&&(b|=Ac.DOLPHIN);d&&(b|=Ac.BARRIER);if(!(b&Ac.DOLPHIN)&&b&Ac.SLOPE){for(d=0;q(c)&Ac.SLOPE;)c=fc.add(c,1,0),d++;6>d?b&=~Ac.SLOPE:9>d?b|=Ac.SLOPE8:10>d&&(b|=Ac.SLOPE9)}return this.terrainFactory.tile(b)};for(let q=0,ja=a.height;q<ja;q++){const ja=a.screens[q],S=a.id<<8|q<<4;for(let q=0,O=a.width;q<O;q++){const O=this.rom.screens[ja[q]],oa=rc(S|q),T=f.has(oa),X=oa&255;var z=e.get(oa);
z=g?this.rom.flags.AlwaysTrue.id:null!=z?this.wallCapability(z):null===(b=a.flags.find(a=>a.screen===X))||void 0===b?void 0:b.flag;var B=a.pits.find(a=>a.fromScreen===oa);B&&this.exits.set(fc(oa<<8|136),fc(B.toScreen<<8|136));B=null!==(d=null===(c=this.rom.flags[z])||void 0===c?void 0:c.logic)&&void 0!==d?d:{};for(let b=0;240>b;b++){const c=fc(oa<<8|b);var A=O.tiles[b];B.assumeTrue&&32>A&&(A=h.alternates[A]);var w=a.isShop()?0:l.effects[A]&38;w=p(w,c,T);32>A&&h.alternates[A]!==A&&null!=z&&!B.assumeTrue&&
!B.assumeFalse&&(A=p(l.effects[h.alternates[A]],c,T))&&(w=this.terrainFactory.flag(w,B.track?z:-1,A));w&&this.terrains.set(c,w)}}}for(const f of a.exits){const {dest:g,entrance:h}=f;b=fc.from(a,f);f.isSeamless()?(c=fc(b&65535|g<<16),d=fc.from(a,f),this.seamlessExits.add(d),(e=this.terrains.get(d))&&this.terrains.set(d,this.terrainFactory.seamless(e))):c=this.entrance(this.rom.locations[g],h&31);this.exits.set(b,c)}}processLocationSpawns(a){for(const b of a.spawns)b.isTrigger()?this.processTrigger(a,
b):b.isNpc()?this.processNpc(a,b):b.isBoss()?this.processBoss(a,b):b.isChest()?this.processChest(a,b):b.isMonster()?this.processMonster(a,b):3===b.type&&224===b.id&&this.processKeyUse(gc.screen(fc.from(a,b)),this.rom.flags.UsedWindmillKey.r)}processTrigger(a,b){var c=this.rom.trigger(b.id);if(!c)throw Error(`Missing trigger ${b.id.toString(16)}`);const d=this.filterRequirements(c.conditions);let e=this.filterAntiRequirements(c.conditions);const f=fc.from(a,b);let g=gc.trigger(a,b);const h=[];for(const a of c.flags){const b=
this.flag(a);(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}h.length&&this.addCheck(g,d,h);switch(c.message.action){case 25:134!==c.id||this.flagset.assumeRabbitSkip()?186!==c.id||this.flagset.assumeTeleportSkip()||this.flagset.disableTeleportSkip()||(g=gc.atLocation(g,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)):g=gc.adjust(g,[0,-1],[0,1]);this.addTerrain(g,this.terrainFactory.statue(e));break;case 29:this.addBossCheck(g,this.rom.bosses.Mado1,d);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(g,
d,c.id);break;case 24:c=this.flagset.chargeShotsOnly()?D.meet(d,Od(this.rom.flags.WarpBoots)):d;this.addItemCheck(g,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break;case 30:this.addItemCheck(g,d,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(f,a,d);break;case 27:a===this.rom.locations.Portoa_PalaceEntrance&&(g=gc.adjust(g,[-2,0]),e=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(g,a,e)}for(const [c,d]of this.itemUses.get(b.type<<8|
b.id))this.processItemUse([fc.from(a,b)],D.OPEN,c,d)}processNpc(a,b){var c,d,e;const f=this.rom.npcs[b.id];if(!f||!f.used)throw Error(`Unknown npc: ${x(b.id)}`);const g=f.spawnConditions.get(a.id)||[];var h=this.filterRequirements(g),l=fc.from(a,b);l=[this.terrains.has(l)?l:null!==(c=this.walkableNeighbor(l))&&void 0!==c?c:l];for(const [a,c]of this.itemUses.get(b.type<<8|b.id))this.processItemUse(l,h,a,c);f===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(l,this.rom.bosses.Sabera1,h);f.data[2]&
4&&!this.flagset.assumeStatueGlitch()&&(b=this.filterAntiRequirements(g),f===this.rom.npcs.Rage?(l=gc.adjust(l,[2,-1],[2,0],[2,1],[2,2]),l=gc.adjust(l,[0,-6],[0,-2],[0,2],[0,6]),this.flagset.assumeRageSkip()&&(b=void 0)):f===this.rom.npcs.PortoaThroneRoomBackDoorGuard?b=Pd(this.rom.flags.MesiaRecording,this.rom.flags.Paralysis):f===this.rom.npcs.SoldierGuard&&(b=void 0),b&&this.addTerrain(l,this.terrainFactory.statue(b)));f===this.rom.npcs.FortuneTeller&&(l=gc.adjust(l,[0,0],[2,0]));if(!D.isClosed(h)){[[...h]]=
h;for(const a of f.globalDialogs){b=this.flag(~a.condition);c=this.flag(a.condition);if((null===b||void 0===b?0:b.logic.assumeFalse)||(null===c||void 0===c?0:c.logic.assumeTrue))return;(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}a=null!==(e=null!==(d=f.localDialogs.get(a.id))&&void 0!==d?d:f.localDialogs.get(-1))&&void 0!==e?e:[];for(const b of a){d=[...h];e=this.flag(b.condition);a=this.flag(~b.condition);(null===e||void 0===e?0:e.logic.track)&&d.push(e.id);(null===e||void 0===e?0:e.logic.assumeFalse)||
(null===a||void 0===a?0:a.logic.assumeTrue)||this.processDialog(l,f,d,b);if((null===e||void 0===e?0:e.logic.assumeTrue)||(null===a||void 0===a?0:a.logic.assumeFalse))break;(null===a||void 0===a?0:a.logic.track)&&h.push(a.id)}}}processDialog(a,b,c,d){this.addCheckFromFlags(a,[c],d.flags);const e={lossy:!0,unique:!0};switch(d.message.action){case 8:this.processKeyUse(a,[c]);break;case 20:this.addItemCheck(a,[c],this.rom.flags.SlimedKensu.id,e);break;case 16:this.addItemCheck(a,[c],this.rom.flags.AsinaInBackRoom.id,
e);break;case 17:this.addItemCheck(a,[c],256|b.data[1],e);break;case 3:case 10:this.addItemCheck(a,[c],256|b.data[0],e);break;case 9:b=b.data[1];255!==b&&this.addItemCheck(a,[c],256|b,e);break;case 25:this.addItemCheck(a,[c],this.rom.flags.AkahanaFluteOfLimeTradein.id,e);break;case 26:this.addItemCheck(a,[c],this.rom.flags.Rage.id,e)}}processLocationItemUses(a){for(const [b,c]of this.itemUses.get(~a.id))this.processItemUse([this.entrance(a)],D.OPEN,b,c)}handleMovingGuard(a,b,c){if(!this.flagset.assumeStatueGlitch()){var d=
[];for(const a of b.spawns.slice(0,2))if(a.isNpc()&&this.rom.npcs[a.id].isParalyzable()){d.push([this.rom.flags.Paralysis.id]);break}this.addTerrain(a,this.terrainFactory.statue([...c,...d].map(fa)))}}handleBoat(a,b,c){const d=this.walkableNeighbor(a);if(null==d)throw Error("Could not find walkable neighbor.");var e=a>>8&240|a>>4&15;a=a>>4&240|a&15;var f;for(const c of b.exits)c.yt===e&&c.xt<a&&(f=c);if(!f)throw Error("Could not find boat exit");b=this.rom.locations[f.dest];if(!b)throw Error("Bad destination");
for(e=f=fc.from(b,b.entrances[f.entrance]);;)if(e=fc.add(e,0,-1),b=this.walkableNeighbor(e),null!=b){c={enter:D.freeze(c),exit:[[15,D.OPEN]]};this.addTerrain([d],c);this.exits.set(d,b);this.exitSet.add(Kc.of(d,b));this.exits.set(f,b);this.exitSet.add(Kc.of(f,b));this.terrains.set(f,this.terrainFactory.tile(0));break}}addItemGrantChecks(a,b,c){const d=this.itemGrant(c),e=256|d;if(null==d)throw Error(`missing item grant for ${c.toString(16)}`);this.addItemCheck(a,b,e,{lossy:!0,unique:!0,preventLoss:128<=
c})}addTerrain(a,b){for(const c of a)a=this.terrains.get(c),null!=a&&this.terrains.set(c,this.terrainFactory.meet(a,b))}addCheck(a,b,c){if(!D.isClosed(b)){b={requirement:D.freeze(b),checks:c};for(const c of a)this.terrains.has(c)&&this.checks.get(c).add(b)}}addItemCheck(a,b,c,d){this.addCheck(a,b,[c]);this.slots.set(c,d);a=this.rom.itemGets[this.rom.slots[c&255]];b=this.rom.items[a.itemId];c=null===b||void 0===b?void 0:b.unique;d=a.isLosable();const e=c||b===this.rom.items.OpelStatue;let f=1;b===
this.rom.items.SwordOfWind&&(f=5);b===this.rom.items.SwordOfFire&&(f=5);b===this.rom.items.SwordOfWater&&(f=10);b===this.rom.items.SwordOfThunder&&(f=15);b===this.rom.items.Flight&&(f=15);this.items.set(512|a.id,{unique:c,losable:d,preventLoss:e,weight:f})}addCheckFromFlags(a,b,c){const d=[];for(const a of c)c=this.flag(a),(null===c||void 0===c?0:c.logic.track)&&d.push(c.id);d.length&&this.addCheck(a,b,d)}walkableNeighbor(a){if(this.isWalkable(a))return a;for(let b of[-1,1]){const c=fc.add(a,b,0),
d=fc.add(a,0,b);if(this.isWalkable(c))return c;if(this.isWalkable(d))return d}}isWalkable(a){return!(this.getEffects(a)&Ac.BITS)}ensurePassable(a){var b;return this.isWalkable(a)?a:null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}getEffects(a){const b=this.rom.locations[a>>>16];return this.rom.tileEffects[b.tileEffects-179].effects[this.rom.screens[b.screens[(a&61440)>>>12][(a&3840)>>>8]].tiles[a&255]]}processBoss(a,b){if(201!==b.id&&202!==b.id){var c=195===b.id?this.rom.bosses.Rage:this.rom.bosses.fromLocation(a.id);
b=fc.from(a,b);if(!c||!c.flag)throw Error(`Bad boss at ${a.name}`);var d=b&-256;a=this.terrainFactory.boss(c.flag.id);b=v(240,a=>d|a);this.addTerrain(b,a);this.addBossCheck(b,c)}}addBossCheck(a,b,c=D.OPEN){if(null==b.flag)throw Error(`Expected a flag: ${b}`);c=D.meet(c,this.bossRequirements(b));b===this.rom.bosses.Draygon2?this.addCheck(a,c,[b.flag.id]):this.addItemCheck(a,c,b.flag.id,{lossy:!1,unique:!0})}processChest(a,b){if(!(112<=this.rom.slots[b.id])){var c=256|b.id,d=this.rom.slots[b.id];112<=
d||(d=this.rom.items[d],d=this.flagset.preserveUniqueChecks()?!(null===d||void 0===d||!d.unique):!0,this.addItemCheck([fc.from(a,b)],D.OPEN,c,{lossy:!1,unique:d}))}}processMonster(a,b){const c=this.rom.objects[b.monsterId];if(c instanceof F&&c.goldDrop){var {Money:d,Sword:e,SwordOfWind:f,SwordOfFire:g,SwordOfWater:h,SwordOfThunder:l}=this.rom.flags;a=[fc.from(a,b)];this.flagset.guaranteeMatchingSword()?(b=[f,g,h,l].filter((a,b)=>c.elements&1<<b),this.addCheck(a,Pd(...b),[d.id])):this.addCheck(a,e.r,
[d.id])}}processItemUse(a,b,c,d){a=new Set([...a].map(a=>{var b;return null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}));const e=[[512|c.id]];c.id===this.rom.prg[251061]+28&&e[0].push(this.rom.flags.Change.c);c===this.rom.items.MedicalHerb&&(e[0][0]=this.rom.flags.BuyHealing.c);b=D.meet(b,e);this.addCheckFromFlags(a,b,d.flags);switch(d.message.action){case 16:this.processKeyUse(a,b);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(a,b,c.id);break;case 2:this.addItemCheck(a,
b,256|this.rom.npcs[d.want&255].data[1],{lossy:!0,unique:!0})}}processKeyUse(a,b){const [c,...d]=new Set([...a].map(a=>rc.from(a)));if(null==c||d.length)throw Error("Expected one screen");const e=this.rom.locations[c>>>8].flags.find(a=>a.screen===(c&255));if(null==e)throw Error("Expected flag on screen");this.addCheck(a,b,[e.flag])}bossRequirements(a){if(a===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];
var b=a.object;const c=new D.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())c.addAll(this.rom.flags.Sword.r);else{var d=this.flagset.guaranteeSwordMagic()?a.swordLevel:1;b=this.rom.objects[b];for(let a=0;4>a;a++)b.isVulnerable(a)&&c.addAll(this.swordRequirement(a,d))}d=[];null!=a.npc&&null!=a.location&&(b=a.npc.spawns(this.rom.locations[a.location]),d.push(...this.filterRequirements(b)[0]));a===this.rom.bosses.Insect?d.push(this.rom.flags.InsectFlute.c,
this.rom.flags.GasMask.c):a===this.rom.bosses.Draygon2&&d.push(this.rom.flags.BowOfTruth.c);this.flagset.guaranteeRefresh()&&d.push(this.rom.flags.Refresh.c);c.restrict([d]);return D.freeze(c)}swordRequirement(a,b){const c=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][a];if(1===b)return c.r;a=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,
this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][a];return 3===b?Od(c,...a):a.map(a=>[c.c,a.c])}itemGrant(a){for(const [b,c]of this.rom.itemGets.actionGrants)if(b===a)return c;throw Error(`Could not find item grant ${a.toString(16)}`);}filterRequirements(a){var b;const c=[];for(const d of a)if(0>d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeTrue)return D.CLOSED}else{a=this.flag(d);if(null===a||void 0===a?0:a.logic.assumeFalse)return D.CLOSED;
(null===a||void 0===a?0:a.logic.track)&&c.push(a.id)}return[c]}filterAntiRequirements(a){var b;const c=[];for(const d of a)if(0<=d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeFalse)return D.OPEN}else{a=this.flag(~d);if(null===a||void 0===a?0:a.logic.assumeTrue)return D.OPEN;(null===a||void 0===a?0:a.logic.track)&&c.push([a.id])}return c}flag(a){var b;a=this.rom.flags[a];return null!==(b=this.aliases.get(a))&&void 0!==b?b:a}entrance(a,b=0){"number"===typeof a&&
(a=this.rom.locations[a]);return this.tiles.find(fc.from(a,a.entrances[b]))}wallCapability(a){switch(a){case Lc.WIND:return this.rom.flags.BreakStone.id;case Lc.FIRE:return this.rom.flags.BreakIce.id;case Lc.WATER:return this.rom.flags.FormBridge.id;case Lc.THUNDER:return this.rom.flags.BreakIron.id;default:throw Error(`bad wall type: ${a}`);}}}function Od(...a){return[a.map(a=>a.id)]}function Pd(...a){return a.map(a=>[a.id])};class Qd extends bc{constructor(){super(...arguments);this.x=this.prop([0],[1,255,-8]);this.y=this.prop([2],[3,255,-8]);this.screen=this.prop([3,15,-4],[1,15]);this.tile=this.prop([2,240],[0,240,4]);this.coord=this.prop([2,255,-8],[0,255])}get used(){return 8>this.data[1]}toString(){return`Entrance ${this.hex()}: (${x(this.y)}, ${x(this.x)})`}}Qd.size=4;
class Rd extends bc{constructor(){super(...arguments);this.x=this.prop([0,255,-4]);this.xt=this.prop([0]);this.y=this.prop([1,255,-4]);this.yt=this.prop([1]);this.screen=this.prop([1,240],[0,240,4]);this.tile=this.prop([1,15,-4],[0,15]);this.coord=this.prop([1,15,-12],[0,15,-4]);this.dest=this.prop([2]);this.entrance=this.prop([3])}isSeamless(){return!!(this.entrance&32)}toString(){return`Exit ${this.hex()}: (${x(this.y)}, ${x(this.x)}) => ${this.dest}:${this.entrance}`}}Rd.size=4;
class Sd extends bc{constructor(){super(...arguments);this.x=this.prop([1,7,-8]);this.xs=this.prop([1,7]);this.y=this.prop([1,240,-4]);this.ys=this.prop([1,240,4]);this.screen=this.prop([1])}get flag(){return this.data[0]|512}set flag(a){if(512!==(a&-256))throw Error(`bad flag: ${x(a)}`);this.data[0]=a&255}toString(){return`Flag ${this.hex()}: ${x(this.screen)} @ ${x(this.flag)}`}}Sd.size=2;
class Td extends bc{constructor(){super(...arguments);this.fromXs=this.prop([1,112,4]);this.toXs=this.prop([1,7]);this.fromYs=this.prop([3,240,4]);this.toYs=this.prop([3,15]);this.fromScreen=this.prop([3,240],[1,112,4]);this.toScreen=this.prop([3,15,-4],[1,7]);this.dest=this.prop([0])}toString(){return`Pit ${this.hex()}: (${x(this.fromXs)}, ${x(this.fromYs)}) => ${x(this.dest)}:(${x(this.toXs)}, ${x(this.toYs)})`}}Td.size=4;
class Ud extends bc{constructor(){super(...arguments);this.y=this.prop([0,255,-4]);this.yt=this.prop([0]);this.x=this.prop([1,127,-4],[2,64,3]);this.xt=this.prop([1,127]);this.timed=this.booleanProp(1,7);this.screen=this.prop([0,240],[1,112,4]);this.tile=this.prop([0,15,-4],[1,15]);this.coord=this.prop([0,15,-12],[1,15,-4],[2,64,3]);this.type=this.prop([2,7]);this.id=this.prop([3]);this.patternBank=this.prop([2,128,7])}get used(){return 254!==this.data[0]}set used(a){this.data[0]=a?0:254}get monsterId(){return this.id+
80&255}set monsterId(a){this.id=a-80&255}isChest(){return 2===this.type&&128>this.id}isInvisible(){return this.isChest()&&!!(this.data[2]&32)}isTrigger(){return 2===this.type&&128<=this.id}isNpc(){return 1===this.type&&192>this.id}isBoss(){return 1===this.type&&192<=this.id}isMonster(){return 0===this.type}isGeneric(){return 4===this.type}isWall(){return!(3!==this.type||!(4>this.id||this.data[2]&32))}isShootingWall(a){return this.isWall()&&!!(this.data[2]&32?this.data[2]&16:143===a.id||168===a.id)}wallType(){if(3!==
this.type)return"";const a=this.data[2]&32?this.id>>>4:this.id;return 4<=a?"":2===a?"bridge":"wall"}wallElement(){return this.isWall()?this.id&3:-1}toString(){return`Spawn ${this.hex()}: (${x(this.x)}, ${x(this.y)}) ${this.timed?"timed":"fixed"} ${this.type}:${x(this.id)}`}}Ud.size=4;function Vd(a,b){return a-b-((a>>>4)-(b>>>4))}function Wd(a,...b){for(const c of b){const d=c%15;b=(a>>4)+(c-d)/15;a=(a&15)+d;0>a?(b--,a=15+a):15<=a&&(b++,a-=15);a|=b<<4}return a};class Xd{constructor(a,b,c,d){this.id=a;this.tileset=b;this.customFlags=new Map;this.freeFlags=new Set;this._pos=void 0;this._exits=new na;this._pits=new Map;this.rom=b.rom;this._height=c;this._width=d;this._screens=Array(c<<4).fill(b.empty)}static of(a,b){function c(a,b,c){for(const d of g.metascreens.getById(b,a.tileset))if(b=d.findEntranceType(c,1===a.height),null!=b)return b}var d,e,f;const {rom:g,width:h,height:l}=a;if(!b){const {fortress:c,labyrinth:d}=g.metatilesets;b=new Set;for(var q of g.metatilesets)a.tileset===
q.tileset.id&&b.add(q);b.delete(169===a.id?c:d);for(var p of new Set(ea.concat(...a.screens)))for(var z of b)if(z.getMetascreens(p).length||b.delete(z),!b.size)throw Error(`No tileset for ${x(p)} in ${a}`);if(1!==b.size)throw Error(`Non-unique tileset for ${a}: [${Array.from(b,a=>a.name).join(", ")}]`);b=[...b][0]}const B=a.reachableTiles(!0);q=new Set;for(var A of B.keys())q.add(A>>>8);for(var w of a.entrances)w.used&&q.add(w.screen);for(var S of a.exits)q.add(S.screen),S.isSeamless()&&(A=S.tile>>>
4,0===A?B.set(S.screen-16<<8|136,1):14===A&&B.set(S.screen<<8|136,1));S=Array(l<<4).fill(b.empty);for(let c=0;c<l;c++)for(let d=0;d<h;d++){A=c<<4|d;var ja=b.getMetascreens(a.screens[c][d]);w=void 0;if(1===ja.length)w=ja[0];else if(ja.length){p=a.flags.find(a=>a.screen===(c<<4|d));z=[];var O=[];for(var T of ja)T.data.match?z.push(T):"always"===T.flag&&766===(null===p||void 0===p?void 0:p.flag)||!T.flag&&!T.data.wall&&!p?O.unshift(T):O.push(T);if(z.length){ja=function(a,b){b=(d<<8)+b;a=(c<<8)+a;return B.has(a<<
4&61440|b&3840|a&240|b>>4&15)};for(var X of z)if(X.data.match(ja,null!=p)){w=X;break}}w||(w=O[0])}else throw Error("impossible");if(!w)throw Error("impossible");S[A]=w}T=new na;for(const b of a.exits)if(255!==b.dest&&(X=b.screen,A=b.tile,!b.isSeamless()||b.yt&15||(X-=16,A|=240),q.has(X)))if(w=S[X],p=w.findExitType(A,1===l,!!(b.entrance&32)),A=null===p||void 0===p?void 0:p.type,!A)Yd.has(a.id<<16|X<<8|b.tile)||(A=null===(d=w.data.exits)||void 0===d?void 0:d.map(a=>a.type+": "+a.exits.map(x).join(", ")).join("\n  "),
console.warn(`Unknown exit ${x(b.tile)}: ${w.name} in ${a} @ ${x(X)}:\n  ${A}`));else if(!T.has(X,A))if(w=g.locations[b.dest],A.startsWith("seamless"))z="seamless:down"===A,T.set(X,A,[w.id<<8|X+(0>p.exits[0]+(z?-16:16)?-16:0),z?"seamless:up":"seamless:down"]);else if(O=w.entrances[b.entrance&31],p=O.screen,z=O.coord,"door"===A&&0===(O.y&240)&&(p-=16,z+=65536),O=w.screens[p>>4][p&15],ja=c(w,O,z))T.set(X,A,[w.id<<8|p,ja]);else{X=[];for(const a of g.metascreens.getById(O,w.tileset))for(const b of null!==
(e=a.data.exits)&&void 0!==e?e:[])b.type.startsWith("seamless")||X.push(`  ${a.name} ${b.type}: ${x(b.entrance)}`);console.warn(`Bad entrance ${x(z)}: raw ${x(O)} in ${w} @ ${x(p)}\n${X.join("\n")}`)}d=new Map;for(var oa of a.pits)d.set(oa.fromScreen,oa.dest<<8|oa.toScreen);oa=new Xd(a.id,b,l,h);oa._screens=S;oa._exits=T;oa._pits=d;for(const b of a.flags)a=oa._screens[b.screen],(null===(f=a.flag)||void 0===f?0:f.startsWith("custom"))?oa.customFlags.set(b.screen,g.flags[b.flag]):a.flag||oa.freeFlags.add(g.flags[b.flag]);
return oa}getUid(a){return this._screens[a].uid}get(a){return this._screens[a]}get width(){return this._width}set width(a){this._width=a;this._pos=void 0}get height(){return this._height}set height(a){this._height>a?this._screens.splice(a+2<<4,this._height-a<<4):this._height<a&&(this._screens.length=a+2<<4,this._screens.fill(this.tileset.empty,this.height+2<<4,this._screens.length));this._height=a;this._pos=void 0}allPos(){if(this._pos)return this._pos;const a=this._pos=[];for(let b=0;b<this._height;b++)for(let c=
0;c<this._width;c++)a.push(b<<4|c);return a}set(a,b){this._screens[a]=null!==b&&void 0!==b?b:this.tileset.empty}inBounds(a){return(a&15)<this.width&&0<=a&&a>>>4<this.height}set2d(a,b){for(const c of b){b=0;for(const d of c)d&&this.set(a+b,d),b++;a+=16}}validate(){for(var a of[0,1])for(var b=a?0:1;b<this.height;b++)for(var c=a;c<this.width;c++){var d=b<<4|c,e=this._screens[d],f=d-(a?1:16),g=this._screens[f];if(!e.isEmpty()&&!g.isEmpty()&&!e.checkNeighbor(g,a)){b=Error;a=[g.name,f,Zd[a],e.name,d];d=
"bad neighbor %s (%02x) %s %s (%02x)".split(/%/g);e=0;f=d[0];for(g=1;g<d.length;g++){if(!d[g]){f+="%"+d[++g];continue}c=/([-+]*)([0\D]?)(\d*)([dxs])/.exec(d[g]);if(!c){f+=a[e++]+d[g];continue}var h=parseInt(c[3])||0;const b=c[2]||" ",q=a[e++];let p="x"===c[4]?Number(q).toString(16):String(q);"s"!==c[4]&&/\+/.test(c[1])&&0<=Number(q)&&(p="+"+p);p.length<h&&(h=b.repeat(h-p.length),p=/-/.test(c[1])?p+h:h+p);f+=p+d[g].substring(c[0].length)}a=f;throw b(a);}}return!0}spliceColumns(a,b,c,d){for(var e=0;e<
this._screens.length;e+=16)this._screens.copyWithin(e+a+c,e+a+b,e+10),this._screens.splice(e+a,c,...d[e>>4]);c-=b;this.width+=c;this._pos=void 0;d=[];for(var f of this._exits){const [g,h]=f;e=g&15;e<a+b?e>=a&&this._exits.delete(g,h):d.push([g,h,g+c,h])}this.moveExits(...d);f=this.rom.locations[this.id];d=a+b<<4;for(const a of f.spawns)a.xt<d||(a.xt-=c<<4);for(const d of f.flags)d.xs<a+b?d.xs>=a&&(d.screen=255):d.xs-=c;f.flags=f.flags.filter(a=>255!==a.screen)}setExit(a,b,c){const d=this.rom.locations[c[0]>>>
8].meta;if(!d)throw Error("Cannot set two-way exit without meta");this.setExitOneWay(a,b,c);d.setExitOneWay(c[0]&255,c[1],[this.id<<8|a,b])}setExitOneWay(a,b,c){this._exits.set(a,b,c)}deleteExit(a,b){this._exits.delete(a,b)}getExit(a,b){return this._exits.get(a,b)}exits(){return this._exits}exitCandidates(a){var b;const c=[];for(const d of this.tileset)(null===(b=d.data.exits)||void 0===b?0:b.some(b=>b.type===a))&&c.push(d);return c}show(){var a,b;const c=[];let d=[];for(var e=0;e<this.width;e++)d.push(e.toString(16));
c.push("   "+d.join("  "));for(e=0;e<this.height;e++)for(let f=0;3>f;f++){d=[1===f?e.toString(16):" "," "];for(let c=0;c<this.width;c++){const g=this._screens[e<<4|c];d.push(null!==(b=null===(a=null===g||void 0===g?void 0:g.data.icon)||void 0===a?void 0:a.full[f])&&void 0!==b?b:1===f?" ? ":"   ")}c.push(d.join(""))}return c.join("\n")}screenNames(){const a=[];for(let b=0;b<this.height;b++){let c=[];for(let a=0;a<this.width;a++){const d=this._screens[b<<4|a];c.push(null===d||void 0===d?void 0:d.name)}a.push(c.join(" "))}return a.join("\n")}traverse(a){a=
void 0===a?{}:a;var b,c,d=new fd;const e=(a.flight?2:0)|(a.noFlagged?1:0);for(const f of this.allPos()){const g=null!==(c=null===(b=a.with)||void 0===b?void 0:b.get(f))&&void 0!==c?c:this._screens[f];for(const a of g.connections[e])a.length&&d.union(a.map(a=>(f<<8)+a))}a=new Map;d=d.sets();for(b=0;b<d.length;b++){c=d[b];for(const b of c)a.set(b,c)}return a}exitType(a){var b;if(224===(a&240)){var c=a>>>8;a=null===(b=this.get(c).data.exits)||void 0===b?void 0:b[a&15].type;if(null===a||void 0===a||!a.startsWith("edge:")||
!("edge:top"===a&&c>>>4||"edge:bottom"===a&&c>>>4===this.height-1||"edge:left"===a&&c&15||"edge:bottom"===a&&(c&15)===this.width-1))return a}}poiTile(){throw Error("not implemented");}attach(a,b,c,d,e){d||(d=this.pickTypeFromExits(a));e||(e=b.pickTypeFromExits(c));const f=b.id<<8|c,g=this.id<<8|a,h=this._exits.get(a,d),l=b._exits.get(c,e);if(h&&l){const [a,b]=h,[c,B]=l;if(a===f&&b===e&&c===g&&B===d)return}this._exits.set(a,d,[f,e]);b._exits.set(c,e,[g,d]);if(l&&h){const [b,c]=h,[d,e]=l;a=this.rom.locations[b>>
8].meta;this.rom.locations[d>>8].meta._exits.set(d&255,e,h);a._exits.set(b&255,c,l)}else if(l||h){const [a,b]=l||h;a===g&&b===d||a===f&&b===e||this.rom.locations[a>>8].meta._exits.delete(a&255,b)}}pickTypeFromExits(a){const b=[...this._exits.row(a).keys()];if(!b.length)return this.pickTypeFromScreens(a);if(1<b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);return b[0]}moveExits(...a){const b=[];for(const c of a){const [d,e,f,g]=c;{a=this._exits.get(d,e);const [c,l]=a;this.rom.locations[c>>
8].meta._exits.set(c&255,l,[this.id<<8|f,g]);b.push([f,g,a]);this._exits.delete(d,e)}}for(const a of b){const [b,c,f]=a;this._exits.set(b,c,f)}}moveExit(a,b,c,d){c||(c=this.pickTypeFromExits(a));d||(d=this.pickTypeFromScreens(b));const e=this._exits.get(a,c),[f,g]=e;this.rom.locations[f>>8].meta._exits.set(f&255,g,[this.id<<8|b,d]);this._exits.set(b,d,e);this._exits.delete(a,c)}moveExitsAndPitsTo(a){const b=new Set;for(const c of a.allPos())a.get(c).data.delete||b.add(c);for(const c of this._exits){const [d,
e,[f,g]]=c;b.has(d)&&(this.rom.locations[f>>>8].meta._exits.set(f&255,g,[a.id<<8|d,e]),a._exits.set(d,e,[f,g]),this._exits.delete(d,e))}for(const c of this._pits){const [d,e]=c;b.has(d)&&(a._pits.set(d,e),this._pits.delete(d))}}pickTypeFromScreens(a){var b=this._screens[a].data.exits;b=(null!==b&&void 0!==b?b:[]).map(a=>a.type);if(1!==b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);return b[0]}transferFlags(a,b){var c;this.freeFlags=new Set(a.freeFlags);const d=new m(()=>[]);
for(const b of a.customFlags){const [c,e]=b;d.get(a._screens[c]).push(e)}for(const a of d.values())b.shuffle(a);for(const e of this.allPos())if(a=this._screens[e],null===(c=a.flag)||void 0===c?0:c.startsWith("custom")){b=d.get(a).pop();if(!b)throw Error(`No flag for ${a.name} at ${this.rom.locations[this.id]} @${x(e)}`);this.customFlags.set(e,b)}}transferPits(a){this._pits=a._pits}shufflePits(){var a;if(this._pits.size){var b=new Set;for(var c of this._pits){var [,d]=c;b.add(this.rom.locations[d>>>
8].id)}this._pits.clear();c=new m(()=>[]);for(var e of this.allPos())if(this.get(e).hasFeature("pit")){var f=[-1,this,Infinity];for(var g of this._exits){const [a,,[c]]=g;d=$d(e,a);b.has(c>>>8)&&d<f[2]&&(f=this.rom.locations[c>>>8].meta,f=[ae(e,c&255,a,f),f,d])}0<=f[0]&&c.get(f[1]).push([e,f[0]])}for(var h of b)b=c.get(this.rom.locations[h].meta),b.length||b.push([0,240]);for(const f of c){const [l,p]=f;h=[[],[]];b=new Map;for(const a of l.allPos())e=l.get(a),e.hasFeature("river")||e.hasFeature("empty")||
(g=(e.data.edges||"").split("").map(a=>" "===a?"":a),g[0]&&g[2]&&h[0].push(a),(g[1]&&g[3]||e.hasFeature("spikes"))&&h[1].push(a),e.hasFeature("spikes")&&b.set(a,[...g].filter(a=>"s"===a).length));g=[0,0];for(const f of p){const [p,q]=f;e=this.get(p).data.edges||"";c="c"===e[1]&&"c"===e[3]?1:0;e=[-1,Infinity,0];g=ae(q,g[0],g[1],l);for(const f of h[c])c=null!==(a=b.get(f))&&void 0!==a?a:0,c<e[2]||(d=$d(g,f),d<e[1]&&(e=[f,d,c]));e=e[0];if(0>e)throw Error("no eligible dest");g=[e,g];this._pits.set(p,
l.id<<8|e)}}}}transferExits(a,b){var c;const d=new m(()=>[]),e=new m(()=>new Set);for(var f of this.allPos()){var g=this._screens[f];for(var h of null!==(c=g.data.exits)&&void 0!==c?c:[])({type:g}=h),"edge:top"===g&&f>>>4||"edge:left"===g&&f&15||"edge:bottom"===g&&f>>>4<this.height-1||"edge:right"===g&&(f&15)<this.width-1||d.get(g).push(f)}for(var l of d.values())b.shuffle(l);for(const g of a._exits){const [p,q,B]=g;if(!e.get(q).has(p)){f=d.get(q).pop();if(null==f)throw Error(`Could not transfer exit ${q} in ${this.rom.locations[this.id]}: no eligible screen\n${this.show()}`);
h=this.rom.locations[B[0]>>>8].meta;b=B[0]&255;c=B[1];if(h===a){h=d.get(c).pop();if(null==h)throw Error("Impossible");this._exits.set(f,q,[this.id<<8|h,c]);this._exits.set(h,c,[this.id<<8|f,q]);e.get(c).add(b)}else{l=h._exits.get(b,c);if(!l)throw a=this.rom.locations[B[0]>>>8],console.log(h),Error(`No exit for ${a} at ${x(b)} ${c}\n${h.show()}\n${this.rom.locations[this.id]} at ${x(p)} ${q}\n${this.show()}`);l[0]>>>8===this.id&&(l[0]&255)===p&&l[1]===q&&h._exits.set(b,c,[this.id<<8|f,q]);this._exits.set(f,
q,B)}}}}transferSpawns(a,b){var c,d,e,f=new Map;const g=new Map,h=[],l=[],q=[],p=[];var z=[];for(var B of[this,a]){for(const a of B.allPos()){const b=B._screens[a],d=a&240,e=(a&15)<<4;if(b.hasFeature("pit")&&B===this)g.set(a,5===b.edgeIndex("c")?0:1);else if((null===(c=b.data.statues)||void 0===c?0:c.length)&&B===this)for(var A=0;A<b.data.statues.length;A++)h.push([a,b.data.statues[A]<<12|((a&15^a>>>4^A)&1?80:160)]);if(B===this&&b.hasFeature("wall")){if(null==b.data.wall)throw Error("Missing wall prop");
A=[d|b.data.wall>>4,e|b.data.wall&15];q.push(A);b.data.tilesets.lime&&q.push([A[0]-1,A[1]])}else if(B===this&&b.hasFeature("bridge")){if(null==b.data.wall)throw Error("Missing wall prop");p.push([d|b.data.wall>>4,e|b.data.wall&15])}if(b.hasFeature("arena"))if(B===this)z.push([d|8,e|8]);else{const [a,b]=z.pop();l.push([d|8,e|8,a,b,144])}}B===this&&(b.shuffle(z),b.shuffle(h))}for(const b of[this,a])for(const e of b._exits){const [g,h,p]=e;c=b._screens[g];a=null===(d=c.data.exits)||void 0===d?void 0:
d.find(a=>a.type===h);if(!a)throw Error(`Invalid exit: ${c.name} ${h}`);c=g&15;z=g>>>4;B=a.exits[0]&15;a=a.exits[0]>>>4;if(b===this)f.set(p,[z<<4|a,c<<4|B]);else if(p[0]>>>8!==this.id){const [b,d]=f.get(p);l.push([z<<4|a,c<<4|B,b,d,25])}}d=[[],[],[],[],[],[]];for(var w of this.allPos()){f=this._screens[w];for(var S of null!==(e=f.data.poi)&&void 0!==e?e:[]){const [a,b=112,c=120]=S;d[a].push([((w&240)<<4)+b,((w&15)<<8)+c])}}for(const a of d)b.shuffle(a);e=[...ea.concat(...d)];w=this.rom.locations[this.id];
for(const a of b.ishuffle(w.spawns)){if(a.isMonster()){b=be.indexOf(a.monsterId);if(0<=b&&g.size){const [[c,d]]=g;g.delete(c);a.monsterId=be[b&2|d];a.screen=c;a.tile=d?115:71}else if(143===a.monsterId&&h.length){const [b,c]=h.pop();a.screen=b;a.coord=c}continue}else if(a.isWall()){b=("bridge"===a.wallType()?p:q).pop();if(!b)throw Error(`Not enough ${a.wallType()} screens in new metalocation: ${w}\n${this.show()}`);const [c,d]=b;a.yt=c;a.xt=d;continue}else if(a.isNpc()||a.isBoss()||a.isTrigger()||
a.isGeneric()){b=[-1,-1,Infinity];for(const c of l){const [d,e,f,g,h]=c;S=Math.pow(Vd(a.yt,d),2)+Math.pow(a.xt-e,2);S<=h&&S<b[2]&&(b=[Wd(a.yt,Vd(f,d)),a.xt+g-e,S])}if(Number.isFinite(b[2])){[a.yt,a.xt]=b;continue}}if(a.isTrigger()||a.isBoss())throw Error(`Could not place ${w} ${a.isBoss()?"Boss":"Trigger"} ${a.hex()}\n${this.show()}`);b=e.shift();if(!b)throw Error(`Ran out of POI for ${w}`);const [c,d]=b;l.push([a.y>>>4,a.x>>>4,c>>>4,d>>>4,4]);a.y=c;a.x=d}}reconcileExits(a){const b=[],c=[];for(const d of[this,
a])for(const e of d._exits){const [f,g,[h,l]]=e;{if(l.startsWith("seamless"))continue;const e=this.rom.locations[h>>>8].meta._exits.get(h&255,l);if(e){const [c,q]=e;if(c>>>8===d.id&&(c&255)===f&&q===g){b.push([d===this?a:this,f,g,[h,l]]);continue}}c.push([d,f,g])}}for(const a of c){const [b,c,d]=a;b._exits.delete(c,d)}for(const a of b){const [b,c,d,h]=a;b._exits.set(c,d,h)}}write(){var a,b,c,d,e,f,g,h,l,q,p,z;const B=this.rom.locations[this.id],A=new Set;for(var w of this._exits){const [c,d,[e,f]]=
w;{var S=this._screens[c],ja=e>>8,O=e&255;const g=this.rom.locations[ja],h=g.meta._screens[e&255],l=null===(a=S.data.exits)||void 0===a?void 0:a.find(a=>a.type===d);var T=null===(b=h.data.exits)||void 0===b?void 0:b.find(a=>a.type===f);if(!l||!T)throw Error(`Missing ${l?"dest":"source"} exit:
  From: ${B} @ ${x(c)}:${d} ${S.name}
  To:   ${g} @ ${x(O)}:${f} ${h.name}`);S=32;T.type.startsWith("seamless")?A.add(c):(T=T.entrance,61439<T&&(O+=16,T-=65536),S=g.findOrAddEntrance(O,T));for(let a of l.exits)O=c,240===(a&240)&&(O+=16,a&=15),B.exits.push(Rd.of({screen:O,tile:a,dest:ja,entrance:S}))}}B.width=this._width;B.height=this._height;B.screens=[];for(a=0;a<this._height;a++)for(b=[],B.screens.push(b),w=0;w<this._width;w++)b.push(this._screens[a<<4|w].sid);B.tileset=this.tileset.tilesetId;B.tileEffects=this.tileset.effects().id;
a=new fd;for(const g of this.allPos())A.has(g)||(b=this._screens[g],w=g+16,ja=g+1,A.has(w)||" "===(null!==(d=null===(c=b.data.edges)||void 0===c?void 0:c[2])&&void 0!==d?d:" ")||a.union([g,w]),A.has(ja)||" "===(null!==(f=null===(e=b.data.edges)||void 0===e?void 0:e[3])&&void 0!==f?f:" ")||a.union([g,ja]),a.union([g]));d=a.map();c=new Set;for(var X of this._exits){[e]=X;for(const a of null!==(g=d.get(e))&&void 0!==g?g:[])c.add(a)}B.flags=[];g=[...this.freeFlags];for(const a of this.allPos()){X=this._screens[a];
let b;null!=X.data.wall&&c.has(a)?b=null!==(l=null===(h=g.pop())||void 0===h?void 0:h.id)&&void 0!==l?l:this.rom.flags.alloc(512):"always"===X.flag?b=this.rom.flags.AlwaysTrue.id:"calm"===X.flag?b=this.rom.flags.CalmedAngrySea.id:"custom:false"===X.flag?b=null===(q=this.customFlags.get(a))||void 0===q?void 0:q.id:"custom:true"===X.flag&&(b=null!==(z=null===(p=this.customFlags.get(a))||void 0===p?void 0:p.id)&&void 0!==z?z:this.rom.flags.AlwaysTrue.id);null!=b&&B.flags.push(Sd.of({screen:a,flag:b}))}B.pits=
[];for(const a of this._pits){const [b,c]=a;B.pits.push(Td.of({fromScreen:b,toScreen:c&255,dest:c>>>8}))}}replaceMonsters(a){if(104!==this.id){var b=this.rom.locations[this.id];a=b.monsterPlacer(a);for(const c of b.spawns){if(!c.used)continue;if(!c.isMonster())continue;const d=b.rom.objects[c.monsterId];if(!(d instanceof F))continue;const e=a(d);null==e?(console.error(`no valid location for ${x(d.id)} in ${b}`),c.used=!1):(c.screen=e>>>8,c.tile=e&255)}}}}
const Yd=new Set([65594,65595,1392800,1716320,4202496,4202544,4292816,6326207,10552102,10552105,11077158,11077161]),Zd=["above","left of","below","right of"];function $d(a,b){return Math.pow((a>>>4)-(b>>>4),2)+Math.pow((a&15)-(b&15),2)}function ae(a,b,c,d){return Math.max(0,Math.min(d.height-1,(a>>>4)+(b>>>4)-(c>>>4)))<<4|Math.max(0,Math.min(d.width-1,(a&15)+(b&15)-(c&15)))}const be=[126,127,159,141];var G,H=G||(G={});H[H.Unknown=0]="Unknown";H[H.GrassLongGrass=1]="GrassLongGrass";H[H.GrassLongGrassRemapping=2]="GrassLongGrassRemapping";H[H.RiverShortGrass=3]="RiverShortGrass";H[H.SeaCaveEntrance=4]="SeaCaveEntrance";H[H.SeaRocks=5]="SeaRocks";H[H.SeaMarsh=6]="SeaMarsh";H[H.SeaTrees=7]="SeaTrees";H[H.DesertShortGrass=8]="DesertShortGrass";H[H.DesertLongGrass=9]="DesertLongGrass";H[H.DesertMarsh=10]="DesertMarsh";H[H.DesertRocks=11]="DesertRocks";H[H.DesertTrees=12]="DesertTrees";
H[H.DesertTownEntrance=13]="DesertTownEntrance";H[H.LabyrinthParapets=14]="LabyrinthParapets";H[H.SwampDoors=15]="SwampDoors";H[H.ExtraSpikes=16]="ExtraSpikes";H[H.CloseCaves=17]="CloseCaves";H[H.WideArenaExits=18]="WideArenaExits";function ce(a,b){for(const c in b)b[c].requires=[a];return b};let de=0;class ee{constructor(){this.name=`Area ${++de}`}}class fe extends ee{constructor(){super(...arguments);this.type="overworld"}}class ge extends ee{constructor(){super(...arguments);this.type="town"}}class he extends ee{constructor(){super(...arguments);this.type="connector";this.exits=[2,2]}}class ie extends ee{constructor(){super(...arguments);this.type="terminal";this.exits=[1,1]}}var J;
(function(a){a.Unused=new ie;a.ValleyOfWind=new class extends fe{constructor(){super(...arguments);this.exits=[3,6]}};a.CordelPlain=new class extends fe{constructor(){super(...arguments);this.exits=[5,8]}};a.WaterfallValley=new class extends fe{constructor(){super(...arguments);this.exits=[6,6]}};a.AngrySea=new class extends fe{constructor(){super(...arguments);this.exits=[0,0]}};a.GoaValley=new class extends fe{constructor(){super(...arguments);this.exits=[0,0]}};a.Desert1=new class extends fe{constructor(){super(...arguments);
this.exits=[0,0]}};a.Desert2=new class extends fe{constructor(){super(...arguments);this.exits=[0,0]}};a.Leaf=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Brynmaer=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Oak=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Amazones=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Nadare=new class extends ge{constructor(){super(...arguments);this.exits=
[0,0]}};a.Portoa=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Joel=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.ZombieTown=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Swan=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Shyron=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.Goa=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};
a.Sahara=new class extends ge{constructor(){super(...arguments);this.exits=[0,0]}};a.WindmillCave=new class extends he{};a.SealedCave=new class extends he{};a.ZebuCave=new class extends he{};a.MtSabreWest=new class extends he{};a.MtSabreNorth=new class extends he{};a.LimeTreeValley=new class extends he{};a.PortoaPalace=new class extends he{};a.FishermanHouse=new class extends he{};a.UndergroundChannel=new class extends he{};a.JoelPassage=new class extends he{};a.EvilSpiritIslandEntrance=new class extends he{};
a.EvilSpiritIsland=new class extends he{};a.KirisaPlantCave=new class extends he{};a.SwanGate=new class extends he{};a.MtHydra=new class extends he{};a.GoaFortress=new class extends he{};a.OasisEntrance=new class extends he{};a.OasisCave=new class extends he{};a.DesertCave1=new class extends he{};a.SaharaMeadow=new class extends he{};a.DesertCave2=new class extends he{};a.EastCave=new class extends he{};a.Swamp=new class extends he{};a.Mezame=new class extends ie{};a.Windmill=new class extends ie{};
a.StomHouse=new class extends ie{};a.WaterfallCave=new class extends ie{};a.KirisaMeadow=new class extends ie{};a.FogLampCave=new class extends ie{};a.LimeTreeLake=new class extends ie{};a.Lighthouse=new class extends ie{};a.SaberaFortress=new class extends ie{};a.ShyronTemple=new class extends ie{};a.Styx=new class extends ie{};a.FortressBasement=new class extends ie{};a.Pyramid=new class extends ie{};a.Crypt=new ie;a.Tower=new ie})(J||(J={}));
for(const [a,b]of Object.entries(J))b.name=a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace("Of","of");const {$0a:je,$0b:ke,$0c:le,$0d:me}=y,ne={subArea:"cave",music:a=>`${a.name}-Cave`,palette:a=>`${a.name}-Cave`},K={subArea:"house",palette:()=>Symbol()},oe={subArea:"house",palette:()=>Symbol(),music:a=>`${a.name}-FortuneTeller`},pe={name:"mesia",music:a=>`${a.name}-Mesia`,palette:a=>"Tower"===a.name?a.name:`${a.name}-Mesia`},qe={name:"dyna",music:a=>`${a.name}-Dyna`,palette:a=>`${a.name}-Dyna`},re={name:"goa 1",music:"goa 1",palette:"goa 1"},se={name:"goa 2",music:"goa 2",palette:"goa 2"},te={name:"goa 3",
music:"goa 3",palette:"goa 3"},ue=Object.assign({},te,{palette:"goa 3 upper"}),ve={name:"goa 4",music:"goa 4",palette:"goa 4"},we=Object.assign({},ve,{palette:"goa 4 lower"}),L=(()=>{function a(a,e){e=void 0===e?{}:e;e=Object.assign({},e);c=e.area=e.area||c;return b(a,e)}const b=Yb();let c;a.commit=a=>{b.commit(a,(b,c,d)=>{b=zb(b);const e=d.area,f="function"===typeof d.music?d.music(e):null!=d.music?d.music:e.name,g="function"===typeof d.palette?d.palette(e):d.palette||e.name;b={area:e,name:b,music:f,
palette:g};null!=d.subArea&&(b.subArea=d.subArea);null!=d.bossScreen&&(b.bossScreen=d.bossScreen);d=new xe(a.rom,c,b);0<=c&&(a[c]=d);return d})};return a})();
class ye extends Array{constructor(a){super(256);this.rom=a;this.MezameShrine=L(0,{area:J.Mezame});this.Leaf_OutsideStart=L(1,{music:1});this.Leaf=L(2,{area:J.Leaf});this.ValleyOfWind=L(3,{area:J.ValleyOfWind});this.SealedCave1=L(4,{area:J.SealedCave});this.SealedCave2=L(5);this.SealedCave6=L(6);this.SealedCave4=L(7);this.SealedCave5=L(8);this.SealedCave3=L(9);this.SealedCave7=L(10,{bossScreen:145});this.SealedCave8=L(12);this.WindmillCave=L(14,{area:J.WindmillCave});this.Windmill=L(15,{area:J.Windmill,
music:0});this.ZebuCave=L(16,{area:J.ZebuCave});this.MtSabreWest_Cave1=L(17,Object.assign({},{area:J.MtSabreWest},ne));this.CordelPlainWest=L(20,{area:J.CordelPlain});this.CordelPlainEast=L(21);this.Brynmaer=L(24,{area:J.Brynmaer});this.OutsideStomHouse=L(25,{area:J.StomHouse,music:0});this.Swamp=L(26,{area:J.Swamp,bossScreen:124});this.Amazones=L(27,{area:J.Amazones,fixed:[13,14]});this.Oak=L(28,{area:J.Oak});this.StomHouse=L(30,{area:J.StomHouse});this.MtSabreWest_Lower=L(32,{area:J.MtSabreWest});
this.MtSabreWest_Upper=L(33);this.MtSabreWest_Cave2=L(34,ne);this.MtSabreWest_Cave3=L(35,ne);this.MtSabreWest_Cave4=L(36,ne);this.MtSabreWest_Cave5=L(37,ne);this.MtSabreWest_Cave6=L(38,ne);this.MtSabreWest_Cave7=L(39,ne);this.MtSabreNorth_Main=L(40,{area:J.MtSabreNorth,bossScreen:181});this.MtSabreNorth_Middle=L(41);this.MtSabreNorth_Cave2=L(42,ne);this.MtSabreNorth_Cave3=L(43,ne);this.MtSabreNorth_Cave4=L(44,ne);this.MtSabreNorth_Cave5=L(45,ne);this.MtSabreNorth_Cave6=L(46,ne);this.MtSabreNorth_PrisonHall=
L(47,ne);this.MtSabreNorth_LeftCell=L(48,ne);this.MtSabreNorth_LeftCell2=L(49,ne);this.MtSabreNorth_RightCell=L(50,ne);this.MtSabreNorth_Cave8=L(51,ne);this.MtSabreNorth_Cave9=L(52,ne);this.MtSabreNorth_SummitCave=L(53,ne);this.MtSabreNorth_Cave1=L(56,ne);this.MtSabreNorth_Cave7=L(57,ne);this.Nadare_Inn=L(60,Object.assign({},{area:J.Nadare},K));this.Nadare_ToolShop=L(61,K);this.Nadare_BackRoom=L(62,K);this.WaterfallValleyNorth=L(64,{area:J.WaterfallValley});this.WaterfallValleySouth=L(65);this.LimeTreeValley=
L(66,{area:J.LimeTreeValley,music:0});this.LimeTreeLake=L(67,{area:J.LimeTreeLake,music:0});this.KirisaPlantCave1=L(68,{area:J.KirisaPlantCave});this.KirisaPlantCave2=L(69);this.KirisaPlantCave3=L(70);this.KirisaMeadow=L(71,{area:J.KirisaMeadow});this.FogLampCave1=L(72,{area:J.FogLampCave});this.FogLampCave2=L(73);this.FogLampCave3=L(74);this.FogLampCaveDeadEnd=L(75);this.FogLampCave4=L(76);this.FogLampCave5=L(77);this.FogLampCave6=L(78);this.FogLampCave7=L(79);this.Portoa=L(80,{area:J.Portoa});this.Portoa_FishermanIsland=
L(81,{area:J.FishermanHouse,music:0});this.MesiaShrine=L(82,Object.assign({},{area:J.LimeTreeLake},pe));this.WaterfallCave1=L(84,{area:J.WaterfallCave});this.WaterfallCave2=L(85);this.WaterfallCave3=L(86);this.WaterfallCave4=L(87);this.TowerEntrance=L(88,{area:J.Tower});this.Tower1=L(89);this.Tower2=L(90);this.Tower3=L(91);this.TowerOutsideMesia=L(92);this.TowerOutsideDyna=L(93);this.TowerMesia=L(94,pe);this.TowerDyna=L(95,qe);this.AngrySea=L(96,{area:J.AngrySea});this.BoatHouse=L(97);this.JoelLighthouse=
L(98,{area:J.Lighthouse,music:0});this.UndergroundChannel=L(100,{area:J.UndergroundChannel});this.ZombieTown=L(101,{area:J.ZombieTown});this.EvilSpiritIsland1=L(104,{area:J.EvilSpiritIslandEntrance,music:1});this.EvilSpiritIsland2=L(105,{area:J.EvilSpiritIsland});this.EvilSpiritIsland3=L(106);this.EvilSpiritIsland4=L(107);this.SaberaPalace1=L(108,{area:J.SaberaFortress,bossScreen:253});this.SaberaPalace2=L(109);this.SaberaPalace2_West=L(-1);this.SaberaPalace3=L(110,{bossScreen:253});this.JoelSecretPassage=
L(112,{area:J.JoelPassage});this.Joel=L(113,{area:J.Joel});this.Swan=L(114,{area:J.Swan,music:1});this.SwanGate=L(115,{area:J.SwanGate,music:1});this.GoaValley=L(120,{area:J.GoaValley});this.MtHydra=L(124,{area:J.MtHydra});this.MtHydra_Cave1=L(125,ne);this.MtHydra_OutsideShyron=L(126,{fixed:[13,14]});this.MtHydra_Cave2=L(127,ne);this.MtHydra_Cave3=L(128,ne);this.MtHydra_Cave4=L(129,ne);this.MtHydra_Cave5=L(130,ne);this.MtHydra_Cave6=L(131,ne);this.MtHydra_Cave7=L(132,ne);this.MtHydra_Cave8=L(133,
ne);this.MtHydra_Cave9=L(134,ne);this.MtHydra_Cave10=L(135,ne);this.Styx1=L(136,{area:J.Styx});this.Styx2=L(137);this.Styx2_East=L(-1);this.Styx3=L(138);this.Shyron=L(140,{area:J.Shyron});this.Goa=L(142,{area:J.Goa});this.GoaFortressBasement=L(143,{area:J.FortressBasement,music:0});this.Desert1=L(144,{area:J.Desert1});this.OasisCaveMain=L(145,{area:J.OasisCave});this.DesertCave1=L(146,{area:J.DesertCave1,music:0});this.Sahara=L(147,{area:J.Sahara});this.SaharaOutsideCave=L(148,{music:0});this.DesertCave2=
L(149,{area:J.DesertCave2,music:1});this.SaharaMeadow=L(150,{area:J.SaharaMeadow,music:0});this.Desert2=L(152,{area:J.Desert2});this.Pyramid_Entrance=L(156,{area:J.Pyramid});this.Pyramid_Branch=L(157);this.Pyramid_Main=L(158);this.Pyramid_Draygon=L(159);this.Crypt_Entrance=L(160,{area:J.Crypt});this.Crypt_Hall1=L(161);this.Crypt_Branch=L(162);this.Crypt_DeadEndLeft=L(163);this.Crypt_DeadEndRight=L(164);this.Crypt_Hall2=L(165);this.Crypt_Draygon2=L(166);this.Crypt_Teleporter=L(167,{music:"Crypt-Teleporter"});
this.GoaFortress_Entrance=L(168,{area:J.GoaFortress,music:1});this.GoaFortress_Kelbesque=L(169,Object.assign({},{bossScreen:115},re));this.GoaFortress_Zebu=L(170,Object.assign({},re,{palette:1}));this.GoaFortress_Sabera=L(171,se);this.GoaFortress_Tornel=L(172,Object.assign({},{bossScreen:145},se,{palette:1}));this.GoaFortress_Mado1=L(173,te);this.GoaFortress_Mado2=L(174,ue);this.GoaFortress_Mado3=L(175,ue);this.GoaFortress_Karmine1=L(176,ve);this.GoaFortress_Karmine2=L(177,ve);this.GoaFortress_Karmine3=
L(178,ve);this.GoaFortress_Karmine4=L(179,ve);this.GoaFortress_Karmine5=L(180,ve);this.GoaFortress_Karmine6=L(181,we);this.GoaFortress_Karmine7=L(182,Object.assign({},{bossScreen:253},we));this.GoaFortress_Exit=L(183,{music:0});this.OasisCave_Entrance=L(184,{area:J.OasisEntrance,music:2});this.GoaFortress_Asina=L(185,Object.assign({},{area:J.GoaFortress},ue,{bossScreen:145}));this.GoaFortress_Kensu=L(186,ve);this.Goa_House=L(187,Object.assign({},{area:J.Goa},K));this.Goa_Inn=L(188,K);this.Goa_ToolShop=
L(190,K);this.Goa_Tavern=L(191,K);this.Leaf_ElderHouse=L(192,Object.assign({},{area:J.Leaf},K));this.Leaf_RabbitHut=L(193,K);this.Leaf_Inn=L(194,K);this.Leaf_ToolShop=L(195,K);this.Leaf_ArmorShop=L(196,K);this.Leaf_StudentHouse=L(197,K);this.Brynmaer_Tavern=L(198,Object.assign({},{area:J.Brynmaer},K));this.Brynmaer_PawnShop=L(199,K);this.Brynmaer_Inn=L(200,K);this.Brynmaer_ArmorShop=L(201,K);this.Brynmaer_ItemShop=L(203,K);this.Oak_ElderHouse=L(205,Object.assign({},{area:J.Oak},K));this.Oak_MotherHouse=
L(206,K);this.Oak_ToolShop=L(207,K);this.Oak_Inn=L(208,K);this.Amazones_Inn=L(209,Object.assign({},{area:J.Amazones},K));this.Amazones_ItemShop=L(210,K);this.Amazones_ArmorShop=L(211,K);this.Amazones_Elder=L(212,K);this.Nadare=L(213,{area:J.Nadare});this.Portoa_FishermanHouse=L(214,Object.assign({},{area:J.FishermanHouse},K,{music:0}));this.Portoa_PalaceEntrance=L(215,{area:J.PortoaPalace});this.Portoa_FortuneTeller=L(216,Object.assign({},{area:J.Portoa,fixed:[13,14]},oe));this.Portoa_PawnShop=L(217,
K);this.Portoa_ArmorShop=L(218,K);this.Portoa_Inn=L(220,K);this.Portoa_ToolShop=L(221,K);this.PortoaPalace_Left=L(222,Object.assign({},{area:J.PortoaPalace},K));this.PortoaPalace_ThroneRoom=L(223,K);this.PortoaPalace_Right=L(224,K);this.Portoa_AsinaRoom=L(225,Object.assign({},{area:J.UndergroundChannel},K,{music:"asina"}));this.Amazones_ElderDownstairs=L(226,Object.assign({},{area:J.Amazones},K));this.Joel_ElderHouse=L(227,Object.assign({},{area:J.Joel},K));this.Joel_Shed=L(228,K);this.Joel_ToolShop=
L(229,K);this.Joel_Inn=L(231,K);this.ZombieTown_House=L(232,Object.assign({},{area:J.ZombieTown},K));this.ZombieTown_HouseBasement=L(233,K);this.Swan_ToolShop=L(235,Object.assign({},{area:J.Swan},K));this.Swan_StomHut=L(236,K);this.Swan_Inn=L(237,K);this.Swan_ArmorShop=L(238,K);this.Swan_Tavern=L(239,K);this.Swan_PawnShop=L(240,K);this.Swan_DanceHall=L(241,K);this.Shyron_Temple=L(242,{area:J.ShyronTemple,bossScreen:112});this.Shyron_TrainingHall=L(243,Object.assign({},{area:J.Shyron},K));this.Shyron_Hospital=
L(244,K);this.Shyron_ArmorShop=L(245,K);this.Shyron_ToolShop=L(246,K);this.Shyron_Inn=L(247,K);this.Sahara_Inn=L(248,Object.assign({},{area:J.Sahara},K));this.Sahara_ToolShop=L(249,K);this.Sahara_ElderHouse=L(250,K);this.Sahara_PawnShop=L(251,K);this.EastCave1=L(-1,{area:J.EastCave});this.EastCave2=L(-1);this.EastCave3=L(-1);this.FishermanBeach=L(-1,Object.assign({},{area:J.FishermanHouse},K));this.locsByScreen=new m(()=>[]);L.commit(this);for(let b=0;256>b;b++)this[b]?this.indexScreens(this[b]):
this[b]=new xe(a,b,{area:J.Unused,name:"",music:"",palette:""})}indexScreens(a){for(const b of a.screens)for(const c of b)this.locsByScreen.get(c).push(a)}renumberScreen(a,b){var c=this.locsByScreen.get(a);this.locsByScreen.set(b,c);this.locsByScreen.delete(a);for(const d of c)for(const e of d.screens)for(c=0;c<e.length;c++)e[c]===a&&(e[c]=b)}allocate(a,b){for(const c of this)if(!(c.used||b&&c.id<b.id))return a.id=c.id,a.used=!0,this.indexScreens(a),this[c.id]=a;throw Error("No unused location");
}write(){const a=this.rom.assembler();cc(a,je,34040,40960);cc(a,ke,40960,48640);cc(a,le,37881,40960);cc(a,me,40960,44032);cc(a,me,44544,49152);for(const b of this)b.assemble(a);return[a.module()]}location(){}}
class xe extends Sc{constructor(a,b,c){super(a,b);this.data=c;this._meta=this._isShop=void 0;var d=0<=b?Lb(a.prg,this.mapDataPointer)+49152:0;if(this.used=49152<d&&!!this.name){var e=Lb(a.prg,d)+49152;b=Lb(a.prg,d+2)+49152;c=Lb(a.prg,d+4)+49152;var f=Lb(a.prg,d+6)+49152,g=Lb(a.prg,d+8)+49152,h=this.used&&e!==d+10,l=f-c;this.exits=(()=>{const b=[];let c=f;for(;!(a.prg[c]&128);)255!=a.prg[c+2]&&b.push(Rd.from(a.prg,c)),c+=4;255!==a.prg[c]&&(h=!!(a.prg[c]&64),l=(a.prg[c]&31)<<2);return b})();d=h?Lb(a.prg,
d+10)+49152:0;this.bgm=this.originalBgm=a.prg[e];this.layoutWidth=a.prg[e+1];this.layoutHeight=a.prg[e+2];this.animation=a.prg[e+3];var q=a.prg[e+4]?256:0;this.screens=v(this.height,b=>Db(a.prg,e+5+b*this.width,this.width).map(a=>q|a));this.tilePalettes=Db(a.prg,b,3);this.originalTilePalettes=Db(this.tilePalettes,0,3);this.tileset=a.prg[b+3];this.tileEffects=a.prg[b+4];this.tilePatterns=Db(a.prg,b+5,2);this.entrances=Hb(4,a.prg.slice(c,c+l),a=>Qd.from(a));this.flags=Fb(a.prg,g,2,255,Infinity,a=>Sd.from(a));
this.pits=d?Fb(a.prg,d,4,255,Infinity,a=>Td.from(a)):[];b=Lb(a.prg,this.npcDataPointer)+65536;this.spritePalettes=(c=65536!==b)?Db(a.prg,b+1,2):[0,0];this.spritePatterns=c?Db(a.prg,b+3,2):[0,0];this.spawns=c?Fb(a.prg,b+5,4,255,Infinity,a=>Ud.from(a)):[]}else this.animation=this.layoutHeight=this.layoutWidth=this.bgm=this.originalBgm=0,this.screens=[[0]],this.tilePalettes=[36,1,38],this.originalTilePalettes=[36,1,38],this.tileset=128,this.tileEffects=179,this.tilePatterns=[2,4],this.exits=[],this.entrances=
[],this.flags=[],this.pits=[],this.spawns=[],this.spritePalettes=[0,0],this.spritePatterns=[0,0]}set meta(a){this._meta=a}get meta(){this.ensureMeta();return this._meta}ensureMeta(){this._meta||(this._meta=Xd.of(this))}set musicGroup(a){this._musicGroup=a}get musicGroup(){this.ensureMusicGroup();return this._musicGroup}ensureMusicGroup(){if(null==this._musicGroup){const a=this.data.music;this._musicGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].musicGroup}}set colorGroup(a){this._colorGroup=
a}get colorGroup(){this.ensureColorGroup();return this._colorGroup}ensureColorGroup(){if(null==this._colorGroup){const a=this.data.music;this._colorGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].colorGroup}}lazyInitialization(){this.ensureMeta();this.ensureMusicGroup();this.ensureColorGroup()}get name(){return this.data.name}get mapDataPointer(){if(0>this.id)throw Error(`no mapdata pointer for ${this.name}`);return 82688+(this.id<<1)}get npcDataPointer(){if(0>this.id)throw Error(`no npcdata pointer for ${this.name}`);
return 102913+(this.id<<1)}get hasSpawns(){return 0<this.spawns.length}mapPlane(){const a=new Set;for(const b of this.screens)for(const c of b)a.add(c>>>8);if(1!==a.size)throw Error(`Non-unique screen page: ${[...a].join(", ")}`);return a[Symbol.iterator]().next().value}isShop(){null==this._isShop&&(this._isShop=0<=this.rom.shops.findIndex(a=>a.location===this.id),251===this.id&&(this._isShop=!0));return this._isShop}spawn(a){const b=this.spawns[a-13];if(!b)throw Error(`Expected spawn $${x(a)}`);
return b}get width(){return this.layoutWidth+1}set width(a){this.layoutWidth=a-1}get height(){return this.layoutHeight+1}set height(a){this.layoutHeight=a-1}findOrAddEntrance(a,b){for(let c=0;c<this.entrances.length;c++){const d=this.entrances[c];if(d.screen===a&&d.coord===b)return c}this.entrances.push(Qd.of({screen:a,coord:b}));return this.entrances.length-1}assemble(a){if(this.used){var b=this.id.toString(16).padStart(2,"0"),c=this.spawns.length?this.spritePalettes:[255,255],d=this.spawns.length?
this.spritePatterns:[255,255],e=[];d=[0,...c,...d,...Jb(this.spawns),255];a.segment("0c","0d");a.reloc(`NpcData_${b}`);var f=a.pc();a.byte(...d);a.org(37377+(this.id<<1),`NpcData_${b}_Ptr`);a.word(f);a.segment("0a","0b");d=[];for(var g of Jb(this.screens))d.push(g&255);g=this.rom.compressedMapData?[this.bgm,this.layoutHeight<<4|this.layoutWidth,this.mapPlane()<<2|this.animation,...d]:[this.bgm,this.layoutWidth,this.layoutHeight,this.animation,this.mapPlane()?128:0,...d];a.reloc(`MapData_${b}_Layout`);
d=a.pc();a.byte(...g);e.push(d);a.reloc(`MapData_${b}_Graphics`);g=a.pc();a.byte(...this.tilePalettes,this.tileset,this.tileEffects,...this.tilePatterns);e.push(g);if(1===this.height){for(var h of this.entrances)h.used&&191<h.y&&(h.y=191);for(var l of this.exits)12<l.yt&&(l.yt=12)}a.reloc(`MapData_${b}_Entrances`);h=a.pc();a.byte(...Jb(this.entrances));e.push(h);a.reloc(`MapData_${b}_Exits`);h=a.pc();a.byte(...Jb(this.exits),128|(this.pits.length?64:0)|this.entrances.length);e.push(h);a.reloc(`MapData_${b}_Flags`);
h=a.pc();a.byte(...Jb(this.flags),255);e.push(h);h=Jb(this.pits);h.length&&(a.reloc(`MapData_${b}_Pits`),l=a.pc(),a.byte(...h),e.push(l));a.reloc(`MapData_${b}`);h=a.pc();a.word(...e);a.org(33536+(this.id<<1),`MapData_${b}_Ptr`);a.word(h);b=this.bossId();if(null!=b&&95!==this.id){e=this.rom.bossKills[b].base;h=[,,,166===this.id?0:this.bgm,,...this.tilePalettes,,,,this.spritePalettes[0],,,,,,,,this.animation];a.segment("0f");for(l=0;l<h.length;l++)g=h[l],null!=g&&(a.org(e+l,`Boss_${b}_${l}`),a.byte(g));
a.org(47041+5*b,`Boss_${b}_Post`);a.byte(c[1])}}}allScreens(){const a=new Set;for(const b of this.screens)for(const c of b)a.add(this.rom.screens[c]);return a}bossId(){for(let a=0;14>a;a++)if(this.rom.prg[129373+a]===this.id)return a}hasDolphin(){return 96===this.id||100===this.id||104===this.id}reachableTiles(a){a=void 0===a?!1:a;this.hasDolphin()&&(a=!0);const b=new Set(this.exits.map(a=>a.screen<<8|a.tile));var c=new fd;const d=this.rom.tilesets[this.tileset],e=this.rom.tileEffects[this.tileEffects-
179];var f=new Set;for(let c=0;c<this.height;c++){const h=this.screens[c];for(let l=0;l<this.width;l++){const p=this.rom.screens[h[l]],q=c<<4|l,A=this.flags.find(a=>a.screen===q);for(let c=0;240>c;c++){const h=q<<8|c;if(b.has(h))continue;let l=p.tiles[c];var g=e.effects[l];g=a?g&4:g&6;A&&g&&32>l&&d.alternates[l]!=l&&(l=d.alternates[l],g=e.effects[l],g=a?g&4:g&6);g||f.add(h)}}}for(let b of f)a=15===(b&15)?b+241:b+1,f.has(a)&&c.union([b,a]),a=224===(b&240)?b+3872:b+16,f.has(a)&&c.union([b,a]);f=c.map();
c=new Set;for(var h of this.entrances)h.used&&c.add(f.get(h.screen<<8|h.tile)||new Set);h=new Map;for(const a of c)for(const b of a)h.set(b,e.effects[this.rom.screens[this.screens[b>>>12][b>>>8&15]].tiles[b&255]]);return h}screenMover(){const a=new m(()=>[]),b=ea.concat(this.spawns,this.exits,this.entrances);for(const c of b)a.get(c.screen).push(c);return(b,d)=>{for(const c of a.get(b))c.screen=d}}moveScreen(a,b){const c=ea.concat(this.spawns,this.exits,this.entrances);for(const d of c)d.screen===
a&&(d.screen=b)}monsterPlacer(a){const b=this.data.bossScreen,c=this.reachableTiles(!1),d=new Map([...c.keys()].map(a=>[a,0])),e=[],f=[],g=[],h=[],l=[],q=this.hasDolphin()?37:39;for(const a of d){const [l,p]=a;{const a=this.screens[l>>>12][l>>>8&15];if(a!==b){for(const a of ze(l,this.width,this.height))d.has(a)||d.set(a,p+1);p||c.get(l)&q||e.push(l);26===this.id?240===this.rom.screens[a].tiles[l&255]&&h.push(l):2<=p&&4>=p&&h.push(l);3<=p&&7>=p&&f.push(l);12<=p&&g.push(l)}}}return b=>{var c=b.placement();
c=[..."normal"===c?e:"moth"===c?f:"bird"===c?g:"plant"===c?h:ma(c)];a:for(;c.length;){var d=a.nextInt(c.length),[p]=c.splice(d,1);d=(p&3840)>>>4|p&15;p=(p&61440)>>>8|(p&240)>>>4;const e=b.clearance();for(const a of l){const [,b,c,f]=a;if(Math.pow(p-c,2)+Math.pow(d-b,2)<Math.pow(e+f,2))continue a}for(const a of this.entrances){const {x:b,y:c,used:f}=a;if(f&&Math.pow(p-(c>>4),2)+Math.pow(d-(b>>4),2)<Math.pow(e+1,2))continue a}l.push([b,d,p,e]);return(p&240|(d&240)>>>4)<<8|(p&15)<<4|d&15}}}resizeScreens(a,
b,c,d,e){e=void 0===e?0:e;const f=this.width+b+d;c=this.height+a+c;d=Array.from({length:c},(c,d)=>{d-=a;return Array.from({length:f},(a,c)=>{c-=b;return 0>d||0>c||d>=this.height||c>=this.width?e:this.screens[d][c]})});this.width=f;this.height=c;this.screens=d;for(const c of this.flags)c.xs+=b,c.ys+=a;for(const c of this.pits)c.fromXs+=b,c.fromYs+=a;for(const c of[...this.spawns,...this.exits])c.xt+=16*b,c.yt+=16*a;for(const c of this.entrances)c.used&&(c.x+=256*b,c.y+=256*a)}writeScreens2d(a,b){const c=
a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){let f=e[b];null!=f&&(0>f&&(f=~f,this.flags.push(Sd.of({screen:a+d<<4|c+b,flag:this.rom.flags.AlwaysTrue.id}))),this.screens[a+d][c+b]=f)}}}connect(a,b,c){var d=0>a?256:0,e=0>c?256:0;a=0>a?~a:a;c=0>c?~c:c;const f=a>>>4,g=a&15,h=c>>>4,l=c&15,q=b.screens[h][l],[p,z]=Ae[d|this.screens[f][g]],[B,A]=Ae[e|q];d=this.entrances.length;e=b.entrances.length;this.entrances.push(Qd.of({y:f<<8|p>>>8,x:g<<8|p&255}));b.entrances.push(Qd.of({y:h<<
8|B>>>8,x:l<<8|B&255}));for(const c of z)this.exits.push(Rd.of({screen:a,tile:c,dest:b.id,entrance:e}));for(const a of A)b.exits.push(Rd.of({screen:c,tile:a,dest:this.id,entrance:d}))}neighborForEntrance(a){const b=this.entrances[a];if(!b)throw Error(`no entrance ${x(this.id)}:${a}`);for(const a of this.exits){if(a.screen!==b.screen)continue;const c=Math.abs(a.y-b.y);if(24>Math.abs(a.x-b.x)&&24>c)return this.rom.locations[a.dest]}throw Error(`no exit found near ${x(this.id)}:${a}`);}toString(){return`${super.toString()} ${this.name}`}}
function ze(a,b,c){const d=[],e=a&61680,f=a&3855;e<(c-1<<12|224)&&d.push(224===(a&240)?a+3872:a+16);e&&d.push(0===(a&240)?a-3872:a-16);f<(b-1<<8|15)&&d.push(15===(a&15)?a+241:a+1);f&&d.push(0===(a&15)?a-241:a-1);return d}const Ae={21:[37024,[137,138]],25:[24720,[88,89]],150:[16432,[50,51]],151:[44848,[178,179]],152:[16592,[60,61]],153:[45008,[188,189]],154:[8064,[39,40]],158:[57216,[231,232]],193:[20640,[73,74]],194:[24752,[90,91]],410:[53376,[199,200]]};class Be extends bc{constructor(){super(...arguments);this.action=this.prop([0,248,3]);this.part=this.prop([0,7,-3],[1,224,5]);this.index=this.prop([1,31])}toString(){const a=this.action?` (action ${x(this.action)})`:"";return`MessageId ${this.hex()}: (${x(this.part)}:${x(this.index)}${a}`}get mid(){return`${x(this.part)}:${x(this.index)}`}set mid(a){const b=a.split(":");if(2!==b.length)throw Error(`oops: ${a}`);this.part=Number.parseInt(b[0],16);this.index=Number.parseInt(b[1],16);if(isNaN(this.part)||
isNaN(this.index))throw Error(`oops: ${a}`);}nonzero(){return!(!this.part&&!this.index)}}Be.size=2;const {$04:Ce,$05:De,$0e:Ee,$1b:Fe,$fe:Ge}=y;
class He extends Tc{constructor(a){super(205);this.rom=a;this.GoaSoldier=new M(this,11);this.LeafElder=new M(this,13);this.LeafElderDaughter=new M(this,17);this.LeafRabbit=new M(this,19);this.WindmillGuard=new M(this,20);this.SleepingWindmillGuard=new M(this,21);this.Akahana=new M(this,22);this.OakElder=new M(this,29);this.OakMother=new M(this,30);this.OakChild=new M(this,31);this.Aryllis=new M(this,35);this.AmazonesGuard=new M(this,37);this.AryllisRightAttendant=new M(this,38);this.AryllisLeftAttendant=
new M(this,39);this.Nadare=new M(this,40);this.SoldierGuard=new M(this,45);this.PortoaThroneRoomBackDoorGuard=new M(this,51);this.PortoaPalaceFrontGuard=new M(this,52);this.PortoaQueen=new Ie(this,56);this.FortuneTeller=new M(this,57);this.WaterfallCaveAdventurers=new M(this,58);this.JoelElder=new M(this,61);this.Clark=new M(this,68);this.ShyronGuard=new M(this,78);this.Brokahana=new M(this,84);this.SaharaBunny=new M(this,89);this.Deo=new M(this,90);this.SaharaElder=new M(this,91);this.SaharaElderDaughter=
new M(this,92);this.Zebu=new M(this,94);this.Tornel=new M(this,95);this.Stom=new M(this,96);this.MesiaRecording=new M(this,97);this.Asina=new M(this,98);this.HurtDolphin=new M(this,99);this.Fisherman=new M(this,100);this.KensuInCabin=new M(this,104);this.Dolphin=new Je(this,105);this.SleepingKensu=new M(this,107);this.KensuDisguisedAsDancer=new M(this,108);this.KensuDisguisedAsSoldier=new M(this,109);this.AztecaInShyron=new M(this,110);this.DeadAkahana=new M(this,112);this.DeadStomsGirlfriend=new M(this,
113);this.DeadStom=new M(this,114);this.KensuInSwan=new M(this,116);this.SlimedKensu=new M(this,117);this.FishermanDaughter=new M(this,123);this.Kensu=new M(this,126);this.AkahanaInBrynmaer=new M(this,130);this.AztecaInPyramid=new M(this,131);this.SaberaDisguisedAsMesia=new M(this,132);this.StonedWaterfallCaveAdventurers=new M(this,133);this.StonedAkahana=new M(this,136);this.Mesia=new M(this,142);this.Vampire1=new M(this,192);this.Insect=new M(this,193);this.Kelbesque1=new M(this,194);this.Rage=
new M(this,195);this.Kelbesque2=new M(this,197);this.Sabera2=new M(this,198);this.Mado2=new M(this,199);this.Karmine=new M(this,200);this.StatueOfMoon=new M(this,201);this.StatueOfSun=new M(this,202);this.Draygon=new M(this,203);this.Vampire2=new M(this,204);for(var b in this){const a=this[b];this.hasOwnProperty(b)&&a instanceof M&&(this[a.id]=a,a.name=zb(b))}for(b=0;205>b;b++)this[b]||(this[b]=new M(this,b));const c=Ke.readAddress(a.prg);this.movementScripts=v(16,b=>{b=c.plus(2*b).readAddress(a.prg).offset;
const d=[];for(;128>a.prg[b];)d.push(a.prg[b++]);return{steps:d,terminate:a.prg[b]}})}write(){const a=this.rom.assembler();for(var b of this)b&&b.used&&b.assemble(a);cc(a,Fe,44804,44969);b=[];a.segment("1b","fe","ff");let c=0;for(var d of this.movementScripts){const e=(a.reloc(`MovementScript_${x(c++)}`),a.pc());a.byte(...d.steps,d.terminate);b.push(e)}d=(a.reloc("MovementScriptTable"),a.pc());a.word(...b);Ke.loc(a,"MovementScriptTablePtr");a.word(d);Ke.plus(5).loc(a,"MovementScriptTablePlus1Ptr");
a.word({op:"+",args:[d,{op:"num",num:1}]});return[a.module()]}}
class M extends Sc{constructor(a,b){super(a.rom,b);this.npcs=a;this.spawnConditions=new Map;this.localDialogs=new Map;a=a.rom;if(204<b)throw Error(`Unavailable: ${b}`);this._used=!Le.has(b)&&(143>b||192<=b);(b=196>b?this.dialogPointer.readAddress(a.prg):null)&&35641===b.org&&(b=null);this.data=Db(a.prg,this.dataBase.offset,4);for(var c=this.spawnPointer.readAddress(a.prg).offset,d;this.used&&255!==(d=a.prg[c++]);){const b=Xb.read(a.prg,c);c+=2*b.length;this.spawnConditions.set(d,b)}this.globalDialogs=
[];if(b){for(d=b.offset;;){const [b,c]=Me.parse(a.prg,d);d+=4;b.condition&&this.globalDialogs.push(b);if(c)break}for(b=[];;){c=a.prg[d++];if(255===c)break;b.push([c,a.prg[d++]])}b.length||b.push([-1,0]);c=d;for(const [e,f]of b)for(b=[],this.localDialogs.set(e,b),d=c+f;;){const [c,e]=Ne.parse(a.prg,d);d+=c.byteLength();b.push(c);if(e)break}}}get dataBase(){return C.of(this.id&128?De:Ce,33008|(this.id&252)<<6|(this.id&3)<<2)}get spawnPointer(){return C.of(Ee,34272+(this.id<<1))}get dialogPointer(){return C.of(Ee,
35165+(this.id<<1))}get used(){return this._used}set used(a){if(a&&136<this.id&&192>this.id&&142!==this.id)throw Error(`invalid: ${this.id}`);this._used=a}spawnConditionsBytes(){const a=[];for(const [b,c]of this.spawnConditions)a.push(b,...Xb.bytes(c));a.push(255);return a}dialog(a){a=a?a.id:-1;const b=this.localDialogs.get(a);if(b)return b;throw Error(`No local dialog for NPC ${x(this.id)} at ${x(a)}`);}spawns(a){const b=a.id;if(a=this.spawnConditions.get(a.id))return a;throw Error(`No spawn condition for NPC ${x(this.id)} at ${x(b)}`);
}hasDialog(){const a=!(!this.globalDialogs.length&&!this.localDialogs.size);if(142<this.id&&195!==this.id&&a)throw Error(`invalid: ${this.id}`);return a}*allDialogs(){yield*this.globalDialogs;for(const a of this.localDialogs.values())yield*a}dialogBytes(){function a(a){const b=[];for(let c=0;c<a.length;c++)b.push(...a[c].bytes(c===a.length-1));return b}if(!this.hasDialog())return[];const b=[];this.globalDialogs.length?b.push(...a(this.globalDialogs)):b.push(128,0,0,0);const c=[],d=new Map;for(const [e,
f]of this.localDialogs){const g=a(f),h=g.join(","),l=d.get(h);null!=l?b.push(e,l):(d.set(h,c.length),-1!==e&&b.push(e,c.length),c.push(...g))}c.length&&b.push(255,...c);return b}link(a){this.spawnConditions=this.rom.npcs[a].spawnConditions;this.linkDialog(a)}linkDialog(a){a=this.rom.npcs[a];this.globalDialogs=a.globalDialogs;this.localDialogs=a.localDialogs}localDialog(a,b){null==b&&(b=a,a=-1);const c=this.localDialogs.get(a);if(null==c||b>=c.length)throw Error(`No local dialog ${b} for location ${x(a)}`);
return c[b]}isParalyzable(){for(let a=217176;217196>a;a++)if(this.rom.prg[a]===this.id)return!1;return!0}assemble(a){if(this.used){var b=x(this.id);this.dataBase.loc(a,"PersonData_${id}");a.byte(...this.data);a.segment("0e","fe","ff");a.reloc(`SpawnCondition_${b}`);var c=a.pc();a.byte(...this.spawnConditionsBytes());this.spawnPointer.loc(a,`SpawnCondition_${b}_Pointer`);a.word(c);this.hasDialog()&&(a.segment("0e","fe","ff"),a.reloc(`Dialog_${b}`),c=a.pc(),a.byte(...this.dialogBytes()),this.dialogPointer.loc(a,
`Dialog_${b}_Pointer`),a.word(c))}}}class Me{constructor(a,b){this.condition=a;this.message=b}static of(a,b){const [c,d,e=0]=b;return new Me(a,Be.of({part:c,index:d,action:e}))}static parse(a,b=0){const c=Kb(a,b);a=Be.from(a,b+2);b=c&1023;const d=!!(c&32768);c&8192&&(b=~b);return[new Me(b,a),d]}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);return[b>>>8,b&255,...this.message.data]}}
class Ne{constructor(a,b,c,d){this.condition=a;this.message=b;this.update=c;this.flags=d}clone(){return Ne.parse(this.bytes(!1))[0]}static parse(a,b=0){const c=Kb(a,b),d=Be.from(a,b+2),e=a[b+4];let f=c&1023;const g=!!(c&32768);c&8192&&(f=~f);a=c&16384?Ob.read(a,b+5):[];return[new Ne(f,d,e,a),g]}static of(a,b,c=[]){const [d,e,f=0]=b;return new Ne(a,Be.of({part:d,index:e,action:f}),0,c)}byteLength(){return 5+2*this.flags.length}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);this.flags.length&&
(b|=16384);return[b>>>8,b&255,...this.message.data,this.update,...Ob.bytes(this.flags)]}}const Le=new Set([49,59,60,102,103,106,115,116,130,134,135,137,138,139,140,141,196]);class Ie extends M{get expectedSword(){return this.localDialog(3).condition&255}set expectedSword(a){this.localDialog(3).condition=512|a}}
class Je extends M{constructor(a,b){super(a,b);const c=a.rom.prg,d=Oe.readAddress(c).offset;this.spawnScripts=v(9,a=>({entrance:Qd.from(c,d+5*a),movement:c[d+5*a+4]}));this.channelSpawn=Pe(Qe.read(c)/5);this.evilSpiritIslandSpawn=Pe(Re.read(c)/5)}assemble(a){super.assemble(a);a.segment("fe");a.org(54952);a.free(45);a.segment("fe","ff");a.reloc("DolphinSpawnTable");const b=a.pc();for(;!this.spawnScripts[this.spawnScripts.length-1].entrance.used;)this.spawnScripts.pop();for(var c=0;c<this.rom.locations.AngrySea.entrances.length;c++){const b=
this.spawnScripts[c];b?a.byte(...b.entrance.data,b.movement):a.byte(255,15,255,15,15)}Qe.loc(a,"DolphinChannelSpawn");a.byte(5*this.channelSpawn);Re.loc(a,"DolphinEvilSpiritIslandSpawn");a.byte(5*this.evilSpiritIslandSpawn);Oe.loc(a,"DolphinSpawnTablePtr");a.word(b);for(c=0;4>c;c++)Se.plus(5*c).loc(a,`DolphinSpawnTablePlus${c+1}Ptr`),a.word({op:"+",args:[b,{op:"num",num:c+1}]})}}var Te,Ue=Te||(Te={});Ue.UP=0;Ue.RIGHT=2;Ue.DOWN=4;Ue.LEFT=6;Ue.DOLPHIN=255;Ue.DESPAWN=254;
const Qe=C.of(Ge,54884),Re=C.of(Ge,54892),Oe=C.of(Ge,54906),Se=C.of(Ge,54926),Ke=C.of(Fe,44627);function Pe(a){if(a!==Math.floor(a))throw Error(`Expected integer: ${a}`);return a};function Ve(a,b,...c){for(let d=0;d<c.length;d++)a[b+d]=c[d]}
function We(a){a[107924]=255;a[118213]=168;a[106870]=255;a[108620]=255;a[120899]=160;a[122987]&=7;a[122991]&=7;a[122995]&=7;a[122999]&=7;a[123003]&=7;a[123012]&=7;a[123035]&=7;a[123065]&=7;a[123141]=47;a[123511]=0;a[123750]=64;a[123761]=0;a[123783]=0;a[123793]=0;Ve(a,106856,51,51);Ve(a,107662,51,51);a[105393]=112;a[105397]=113;a[105079]=114;a[105963]=115;a[106565]=116;a[106721]=117;a[106725]=118;a[106729]=119;a[108037]=120;a[107457]=121;a[107461]=122;a[107465]=123;Ve(a,123063,192,0);Ve(a,123690,192,
0);Ve(a,123696,192,0);Ve(a,123702,192,0);Ve(a,123104,192,0);Ve(a,123110,192,0);a[116739]=0;Ve(a,116749,162,179);a[109190]=254;Ve(a,251605,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255)}
function Xe(a,b){{const {flags:{WarpZombie:b},locations:{ZombieTown:d}}=a;a.flags.insertZombieWarpFlag();a.messages.parts[33][0].text=" {1a:Leaf}      {16:Brynmaer} {1d:Oak} \n{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} \n{19:Joel}      Zombie   {20:Swan} \n{23:Shyron}    {18:Goa}      {21:Sahara}";var c=a.nextFreeTrigger();c.used=!0;c.conditions=[];c.message=Be.of({});c.flags=[b.id];for(const a of d.spawns)a.isTrigger()&&138===a.id&&(a.id=c.id);a.townWarp.locations.splice(7,0,d.id);if(255!==a.townWarp.locations.pop())throw Error("unexpected");
}a.items.GlowingLamp.itemUseData[0].message.action=11;c=a.nextFreeTrigger();c.used=!0;c.conditions=[~a.flags.AlwaysTrue.id];c.message=Be.of({action:4});c.flags=[a.flags.AlwaysTrue.id];a.locations.MezameShrine.spawns.push(Ud.of({tile:136,type:2,id:c.id}));a.objects[16].atk=3;a.objects[17].atk=6;a.objects[18].atk=8;a.objects[24].atk=3;a.objects[19].atk=5;a.objects[25].atk=5;a.objects[23].atk=7;a.objects[26].atk=7;a.objects[20].atk=3;a.objects[21].atk=6;a.objects[22].atk=8;a.objects[28].atk=3;a.objects[29].atk=
3;a.objects[30].atk=5;a.objects[27].atk=7;a.objects[31].atk=7;b.slowDownTornado()&&(c=a.objects[18],c.speed=7,c.data[12]=96);for(var d of a.objects)d instanceof F&&!(d.isProjectile()||d.isBoss()||d.isFlyer())&&d!==a.objects.mimic&&(d.terrainSusceptibility|=3);a.objects[51].elements=15;a.items.OpelStatue.selectedItemValue=0;for(var e of[96,100,101,102,103,104,105,106,107,108,109,111])for(const b of[0,1,2])a.patterns[e<<6|b].pixels=a.patterns[6016|b].pixels;a.objects[12].metasprite=169;for(const b of a.locations)for(const a of b.spawns)a.isChest()&&
(a.timed=!1);d=a.trigger(160);d.used=!0;d.conditions=[];d.flags=[];d.message=Be.of({part:0,index:0,action:21});a.objects[94].data[13]=254;a.items.InsectFlute.itemUseData[0].flags=[a.flags.UsedInsectFlute.id];{const {flags:{BallOfWind:b,TornadoBracelet:c},npcs:{Tornel:e}}=a;d=e.localDialogs.get(33);d=[d[0],d[2],d[2].clone(),d[1]];d[1].condition=~c.id;d[2].condition=~b.id;d[3].condition=-1;e.localDialogs.set(33,d)}d=a.locations;d.GoaFortress_Kelbesque.spawns[0].x-=16;d.GoaFortress_Zebu.spawns.splice(1,
1);d.GoaFortress_Tornel.spawns.splice(2,1);d.GoaFortress_Asina.spawns.splice(2,1);d.GoaFortress_Kensu.spawns.splice(3,1);d.GoaFortress_Kensu.spawns.splice(1,1);Ye(a,b);a.npcs[13].localDialogs.get(53)[0].message.action=23;if(b.requireHealedDolphinToRide()){{const {flags:{InjuredDolphin:b,ShellFlute:c},npcs:{Fisherman:e,FishermanDaughter:f}}=a;e.spawnConditions.set(214,[c.id,b.id]);d=f.localDialogs.get(-1);d.unshift(d[0].clone());d[0].condition=~b.id;d[1].condition=~c.id}}if(b.saharaRabbitsRequireTelepathy()){{const {flags:{Telepathy:b},
npcs:{Deo:c,SaharaBunny:d}}=a;d.globalDialogs.push(Me.of(~b.id,[26,18]));c.globalDialogs.push(Me.of(~b.id,[26,19]))}}b.leatherBootsGiveSpeed()&&(d=a.items[47],d.menuName="Speed Boots",d.messageName="Speed Boots",b.changeGasMaskToHazmatSuit()&&(d=a.items[41],d.menuName="Hazmat Suit",d.messageName="Hazmat Suit"));for(d=5;12>d;d+=2)a.items[d].menuName=a.items[d].menuName.replace("Ball","Orb"),a.items[d].messageName=a.items[d].messageName.replace("Ball","Orb");{const {items:{AlarmFlute:b},locations:{WaterfallCave4:c},
npcs:{WindmillGuard:l}}=a;a.itemGets[49].inventoryRowStart=32;b.unique=!0;b.basePrice=0;l.data[1]=49;d=[[33,.72],[31,.9]];e=0;for(var f of a.shops)if(f.type===Wc.TOOL)for(let b=0,c=f.contents.length;b<c;b++){if(49!==f.contents[b])continue;const [c,g]=d[e++%d.length];f.contents[b]=c;a.shopDataTablesAddress&&(f.prices[b]=Math.round(f.prices[b]*g))}a.itemGets[91].itemId=29;c.spawn(25).id=16}{const {flags:{Karmine:b,Mado1:c},npcs:{Brokahana:d}}=a;f=d.localDialogs.get(-1);if(!f)throw Error(`asserted but falsy: ${f}`);
f=f[0];if(f.condition!==~b.id)throw Error(`Bad brokahana condition: ${f.condition}`);f.condition=~c.id}b.teleportOnThunderSword()?({flags:{WarpShyron:f}}=a,a.itemGets[3].flags.push(f.id),a.townWarp.thunderSwordWarp=[a.locations.Shyron.id,65]):a.itemGets[3].acquisitionAction.action=22;({tiles:f}=a.screens[161]);f[40]=159;f[55]=35;f[56]=35;f[57]=33;f[71]=141;f[72]=143;f[86]=153;f[87]=154;f[88]=140;if(b.fogLampNotRequired()){{const {flags:{AlwaysTrue:c,InjuredDolphin:d,FogLamp:e,KensuInCabin:q,ReturnedFogLamp:p},
items:{ShellFlute:z},locations:{BoatHouse:B,Portoa_FishermanHouse:A},npcs:w}=a;f=b.requireHealedDolphinToRide();z.itemUseData[0].want=f?d.id:c.id;w.KensuInCabin.data[0]=103;w.KensuInCabin.localDialogs.get(-1)[0].message.action=10;w.KensuInCabin.localDialogs.get(-1)[0].flags=[];w.KensuInCabin.spawnConditions.set(B.id,[p.id,~q.id]);w.Fisherman.spawnConditions.set(A.id,[e.id]);a.itemGets[100].flags=[];a.itemGets[103].copyFrom(a.itemGets[100])}}a.trigger(138).conditions=[~a.flags.CurrentlyRidingDolphin.id];
a.messages.parts[29][16].text="The cave entrance appears\nto be underwater. You'll\nneed to swim.";{const {CordelPlainEast:b,KirisaMeadow:c,UndergroundChannel:d}=a.locations;for(const a of[b,c,d])for(const b of a.spawns)b.isChest()&&(b.data[2]|=32)}{const {CordelPlainEast:c,CordelPlainWest:d}=a.locations;for(const a of c.spawns)(a.isChest()||b.disableTeleportSkip()&&a.isTrigger())&&d.spawns.push(a.clone())}if(b.disableRabbitSkip())for(const b of a.locations.MtSabreNorth_Main.spawns)b.isTrigger()&&
134===b.id&&1856===b.x&&(b.x+=16,b.y+=16);b.disableRageSkip()&&(a.metatilesets.lime.getTile(124).setEffects(6),a.metatilesets.lime.getTile(127).setEffects(6),a.metatilesets.lime.getTile(123).setTiles([127,127,127,127]).setAttrs(0).setEffects(6),a.screens[116].set2d(144,[[123,123,123,123,123,123,123,null,null,123,123,123,123,123,123,123],[123,123,123,123,123,123,123,null,null,123,123,123,123,123,123,123]]));for(const b in[4,5,8,9])a.tileEffects[9].effects[b]=24,a.tileEffects[2].effects[b]=24;if(b.chargeShotsOnly()){for(const b of[8,
9,39])a.objects[b].collisionPlane=0;a.npcs.Brokahana.data[0]=a.items.FruitOfLime.id}if(b.orbsOptional())for(const b of[16,20,24,29])a.objects[b].terrainSusceptibility&=-5,a.objects[b].level=2;if(b.noBowMode()){{const {flags:{UsedBowOfTruth:b},locations:{Crypt_Draygon2:c,Crypt_Hall2:d,MezameShrine:e}}=a;let f;for(const b of e.spawns)b.isTrigger()&&136===b.tile&&(f=a.trigger(b.id));if(!f)throw Error("Could not find start trigger");f.flags.push(b.id);a.tileEffects[6].effects[88]=0;e.exits.push(Rd.of({tile:104,
dest:c.id,entrance:0}));for(let a of c.exits)a.dest===d.id&&(a.dest=e.id,a.entrance=1);for(let a of d.exits)a.dest===c.id&&(a.dest=e.id,a.entrance=0)}}a.messages.parts[32][15].text+="\nItem: [:ITEM:]"}
function Ye(a,b){function c(a,b){const c=a.indexOf(b);if(0>c)throw Error(`Could not find element ${b} in ${a}`);a.splice(c,1)}function d(a){a.reverse();for(let b=0;b<a.length;b++){const c=a[b+1];a[b].condition=c?~c.condition:-1}}const {locations:{BoatHouse:e,Brynmaer:f,Crypt_Draygon2:g,Joel_Shed:h,MtSabreNorth_SummitCave:l,MtSabreWest_Upper:q,PortoaPalace_ThroneRoom:p,Portoa_PalaceEntrance:z,Portoa_AsinaRoom:B,Portoa_FortuneTeller:A,Shyron_Temple:w,StomHouse:S,Swan_DanceHall:ja,Swan_Tavern:O,WindmillCave:T,
WaterfallCave4:X,WaterfallValleyNorth:oa,ZebuCave:xb,ZombieTown_HouseBasement:Rb},items:{GlowingLamp:ab,KeyToPrison:fb,LovePendant:pb,StatueOfOnyx:Bb},npcs:{Akahana:Ra,AkahanaInBrynmaer:gb,Asina:Sb,AztecaInShyron:Tb,Clark:Oa,Draygon:bd,FortuneTeller:jc,Kensu:qb,KensuInCabin:Dc,KensuInSwan:Cb,LeafRabbit:kc,OakChild:Ec,OakElder:lc,OakMother:Fc,PortoaPalaceFrontGuard:cd,PortoaQueen:bb,PortoaThroneRoomBackDoorGuard:mc,Rage:nc,Stom:oc,StonedAkahana:Gc,Tornel:Hc,WindmillGuard:dd,Zebu:Ub},flags:I}=a;qb.localDialogs.delete(O.id);
Cb.link(qb.id);Cb.used=!0;Cb.data=[...qb.data];qb.data[0]=ab.id;ja.spawns.find(a=>a.isNpc()&&a.id===qb.id).id=Cb.id;pb.itemUseData[0].want=256|Cb.id;Gc.linkDialog(Ra.id);gb.used=!0;gb.link(Ra.id);gb.data=[...Ra.data];f.spawns.find(a=>a.isNpc()&&a.id===Ra.id).id=gb.id;Bb.itemUseData[0].want=256|gb.id;kc.dialog()[2].condition=I.RescuedLeafElder.id;kc.dialog()[2].flags.push(I.TalkedToLeafRabbit.id);kc.dialog()[3].flags.push(I.TalkedToLeafRabbit.id);dd.spawns(T)[1]=~I.WindmillGuardAlarmFluteTradein.id;
c(Ra.spawns(X),~I.BehindWhirlpool.id);c(Gc.spawns(X),~I.BehindWhirlpool.id);for(var ba=0;4>ba;ba++){var Ca=lc.dialog()[ba];Ca.condition!==a.flags.OakElder.id&&(Ca.message.action=3)}(()=>{const [a,b,c,d]=Fc.dialog();d.condition=~I.RescuedChild.id;b.condition=-1;Fc.dialog().splice(0,4,d,c,a,b)})();for(const b of[32,33,34,124,125])d(a.npcs[b].dialog());Ec.dialog().unshift(...Ec.dialog().splice(1,1));mc.spawnConditions.set(p.id,[~I.QueenNotInThroneRoom.id,~I.MesiaRecording.id]);cd.dialog()[1].condition=
I.MesiaRecording.id;bb.dialog()[3].condition=I.SwordOfWater.id;bb.dialog()[3].message.action=3;bb.dialog()[4].flags.push(I.PortoaQueenGoingAway.id);bb.spawns(p)[1]=~I.MesiaRecording.id;bb.spawns(B)[0]=I.MesiaRecording.id;bb.dialog()[1].condition=I.MesiaRecording.id;jc.spawns(A)[1]=~I.MesiaRecording.id;Oa.spawnConditions.set(Rb.id,[~I.Clark.id]);Oa.spawnConditions.set(h.id,[I.Clark.id]);Ub.localDialogs.set(xb.id,[Ne.of(~I.TalkedToZebuInCave.id,[0,26],[I.TalkedToZebuInCave.id]),Ne.of(I.LeafVillagersRescued.id,
[0,29]),Ne.of(I.LeafAbduction.id,[0,28]),Ne.of(I.ZebuAtWindmill.id,[0,29]),Ne.of(I.UsedWindmillKey.id,[0,27,3]),Ne.of(-1,[0,29])]);c(Ub.spawns(xb),~I.BehindWhirlpool.id);Hc.spawnConditions.delete(q.id);oc.spawnConditions.delete(S.id);c(Sb.spawns(B),~I.CalmedAngrySea.id);ba=a.npcs[52];ba.spawnConditions.set(p.id,[I.MesiaRecording.id,~I.PortoaQueen.id]);ba.localDialogs.set(z.id,ba.localDialogs.get(-1));ba.data[0]=a.items.FluteOfLime.id;Ca=a.messages.alloc();Ca.text="The queen left this for you.";ba.localDialogs.set(p.id,
[Ne.of(~I.PortoaQueen.id,[Ca.part,Ca.id,3]),Ne.of(-1,[10,14])]);p.spawns.push(Ud.of({yt:3,xt:12,type:1,patternBank:1,id:ba.id}));Dc.spawnConditions.set(e.id,[~I.AbleToRideDolphin.id,I.ReturnedFogLamp.id]);Dc.dialog()[0].message.action=2;Tb.spawns(w).push(~I.ShyronMassacre.id);a.trigger(130).conditions.push(~I.ShyronMassacre.id);nc.dialog()[0].condition=I.SwordOfWater.id;bd.spawnConditions.set(g.id,[~I.Draygon2.id]);Ub.dialog(w).unshift(...Ub.dialog(w).splice(1,1));a.trigger(128).conditions=[~I.ShyronMassacre.id,
I.TalkedToZebuInShyron.id,I.SwordOfThunder.id];a.trigger(129).conditions=[];b.barrierRequiresCalmSea()&&a.trigger(132).conditions.push(I.CalmedAngrySea.id);a.trigger(140).conditions.push(I.TalkedToZebuInCave.id);a.trigger(141).used=!1;for(const a of l.spawns)a.isTrigger()&&141===a.id&&(a.id=178);(function(a,b){b=a.findIndex(b);if(0>b)throw Error(`Could not find element in ${a}`);a.splice(b,1)})(oa.spawns,a=>a.isTrigger()&&141===a.id);a.trigger(178).conditions.push(I.Kelbesque1.id);a.trigger(178).flags.push(~I.LeafVillagersCurrentlyAbducted.id,
~I.LeafElderCurrentlyAbducted.id,I.LeafVillagersRescued.id);a.trigger(140).conditions.push(~I.Kelbesque1.id);a.trigger(134).conditions.push(~I.Kelbesque1.id);c(fb.itemUseData[0].flags,~I.LeafVillagersCurrentlyAbducted.id);Ze(a.trigger(187).conditions,~I.Rage.id,~I.MesiaRecording.id)}function Ze(a,b,c){for(let d=0;d<a.length;d++)if(a[d]===b){a[d]=c;return}throw Error(`Could not find ${b} in ${a.join(",")}`);};const {$0e:$e,$0f:af,$10:bf,$1a:cf}=y,df=C.of($e,33689),ef=C.of($e,39906),ff=C.of(bf,36848),gf=C.of(bf,36923),hf=C.of(bf,36998),jf=C.of(cf,35776),kf=C.of(cf,35785),lf=[["Sword","\n\x0B\f"],[" of ","\\]"],["Bracelet","<=>["],["Shield","\r\u000e\u000f"],["Armor","{\u0011\u0012"],["Magic","#%("],["Power","\u0013\u0014\u0015"],["Item","\u0016\u0017^"]];
class N extends Sc{constructor(a,b,c={}){super(a.rom,b);this.items=a;const d=this.rom;a[b]=this;this.itemUseData=[];this.trades=c.trades||[];this.use=c.use||!1;this.weight=c.weight||1;this.valueAddr=null!=c.valueAddr?C.of($e,c.valueAddr):void 0;null!=this.valueAddr&&(this.value=this.valueAddr.read(d.prg));if(this.use){this.itemUseJump=this.itemUseJumpPointer.readAddress(d.prg,$e,af);b=a.itemUseJumps[this.itemUseJump.org];if(!b)throw Error(`Bad ItemUseJump: ${this.itemUseJump}`);a=this.itemUseDataPointer.readAddress(d.prg,
$e,af);for(var e of b)b=mf.from(e,d.prg,a),this.itemUseData.push(b),a=a.plus(b.length)}this.itemDataValue=this.itemDataPointer.read(d.prg);this.selectedItemValue=this.selectedItemPointer.read(d.prg);e=this.menuNamePointer.readAddress(d.prg);this.menuName=lf.reduce((a,[b,c])=>a.replace(c,b),Mb(d.prg,e.offset,255))}get messageName(){return this.rom.messages.itemNames[this.id]}set messageName(a){this.rom.messages.itemNames[this.id]=a}get basePrice(){return this.rom.shops.basePrices[this.id]}set basePrice(a){this.rom.shops.basePrices[this.id]=
a}get itemUseJumpPointer(){return df.plus(this.id<<1)}get itemUseDataPointer(){return ef.plus(this.id<<1)}get itemDataPointer(){return ff.plus(this.id)}get selectedItemPointer(){return gf.plus(this.id)}get menuNamePointer(){return hf.plus(this.id<<1)}itemUseMessages(){const a=new Map;for(const {message:b}of this.itemUseData)a.set(b.mid,b);return[...a.values()]}setName(a){this.messageName=this.menuName=a}get palette(){return this.itemDataValue&3}set palette(a){this.itemDataValue=this.itemDataValue&
-4|a&3}get unique(){return!!(this.itemDataValue&64)}set unique(a){this.itemDataValue=this.itemDataValue&-65|(a?64:0)}get worn(){return!!(this.itemDataValue&32)}set worn(a){this.itemDataValue=this.itemDataValue&-33|(a?32:0)}get solid(){return!!(this.itemDataValue&128)}set solid(a){this.itemDataValue=this.itemDataValue&-129|(a?128:0)}assemble(a){const b=x(this.id);this.itemDataPointer.loc(a,`ItemData_${b}`);a.byte(this.itemDataValue);this.selectedItemPointer.loc(a,`ItemSelectedValue_${b}`);a.byte(this.selectedItemValue);
var c=lf.reduce((a,[b,c])=>a.replace(b,c),this.menuName);a.segment(bf);a.reloc(`ItemMenuName_${x(this.id)}`);const d=a.pc();a.byte(c,255);this.menuNamePointer.loc(a,`ItemMenuName_${b}`);a.word(d);if(this.itemUseJump){this.itemUseJumpPointer.loc(a,`ItemUseJump_${b}_Ptr`);a.word(this.itemUseJump.org);c=[];for(var e of this.itemUseData)c.push(...e.bytes());a.segment($e.name,af.name);a.reloc(`ItemUseData_${b}`);e=a.pc();a.byte(...c);this.itemUseDataPointer.loc(a,`ItemUseData_${b}_Ptr`);a.word(e)}this.valueAddr&&
(this.valueAddr.loc(a,`ItemValue_${b}`),a.byte(this.value))}isMagic(){return 65<=this.id&&72>=this.id}}
class mf{constructor(a,b,c,d){this.kind=a;this.want=b;this.message=c;this.flags=d}static from(a,b,c){({offset:c}=c);var d=0;if("expect"===a||"screen"===a)d=b[c+1]<<8|b[c],c+=2;else if("flag"===a){d=Wb.read(b,c);d.length||d.push(-1);if(1<d.length)throw Error(`Flag list too long: ${d}`);d=d[0];c+=2}else"location"===a?d=b[c++]:"empty"!==a&&ma(a);const e=Be.from(b,c);b=Qb.read(b,c+2);return new mf(a,d,e,b)}bytes(){const a=[];if("expect"===this.kind||"screen"===this.kind)a.push(this.want&255,this.want>>>
8&255);else if("flag"===this.kind){const b=Wb.bytes([this.want]);if(2!==b.length)throw Error(`bad data: ${b}`);a.push(...b)}else"location"===this.kind?a.push(this.want):"empty"!==this.kind&&ma(this.kind);a.push(...this.message.data);a.push(...Qb.bytes(this.flags));return a}tradeNpc(){return"expect"!==this.kind||1!==this.want>>>8?null:this.want&255}get length(){return 2*(1+Math.max(1,this.flags.length))+("empty"===this.kind?0:"location"===this.kind?1:2)}}
class nf extends N{get defense(){return this.items.shieldDefense[this.id-12]}set defense(a){this.items.shieldDefense[this.id-12]=a}}class of extends N{get defense(){return this.items.armorDefense[this.id-20]}set defense(a){this.items.armorDefense[this.id-20]=a}}
class pf extends Tc{constructor(a){super(73);this.rom=a;this.itemUseJumps=qf;this.SwordOfWind=new N(this,0);this.SwordOfFire=new N(this,1);this.SwordOfWater=new N(this,2);this.SwordOfThunder=new N(this,3);this.Crystalis=new N(this,4);this.BallOfWind=new N(this,5);this.TornadoBracelet=new N(this,6);this.BallOfFire=new N(this,7);this.FlameBracelet=new N(this,8);this.BallOfWater=new N(this,9);this.BlizzardBracelet=new N(this,10);this.BallOfThunder=new N(this,11);this.StormBracelet=new N(this,12);this.CarapaceShield=
new nf(this,13);this.BronzeShield=new nf(this,14);this.PlatinumShield=new nf(this,15);this.MirroredShield=new nf(this,16);this.CeramicShield=new nf(this,17);this.SacredShield=new nf(this,18);this.BattleShield=new nf(this,19);this.PsychoShield=new nf(this,20);this.TannedHide=new of(this,21);this.LeatherArmor=new of(this,22);this.BronzeArmor=new of(this,23);this.PlatinumArmor=new of(this,24);this.SoldierSuit=new of(this,25);this.CeramicSuit=new of(this,26);this.BattleArmor=new of(this,27);this.PsychoArmor=
new of(this,28);this.MedicalHerb=new N(this,29,{use:!0,trades:[0],valueAddr:34026});this.Antidote=new N(this,30,{use:!0});this.LysisPlant=new N(this,31,{use:!0});this.FruitOfLime=new N(this,32,{use:!0});this.FruitOfPower=new N(this,33,{use:!0,valueAddr:34060});this.MagicRing=new N(this,34,{use:!0});this.FruitOfRepun=new N(this,35,{use:!0});this.WarpBoots=new N(this,36,{use:!0});this.StatueOfOnyx=new N(this,37,{use:!0,trades:[0]});this.OpelStatue=new N(this,38,{use:!0});this.InsectFlute=new N(this,
39,{use:!0});this.FluteOfLime=new N(this,40,{use:!0,trades:[0,1,2,3]});this.GasMask=new N(this,41);this.PowerRing=new N(this,42);this.WarriorRing=new N(this,43);this.IronNecklace=new N(this,44);this.DeosPendant=new N(this,45);this.RabbitBoots=new N(this,46);this.LeatherBoots=new N(this,47);this.ShieldRing=new N(this,48);this.AlarmFlute=new N(this,49,{use:!0,trades:[0,1]});this.WindmillKey=new N(this,50,{use:!0});this.KeyToPrison=new N(this,51,{use:!0});this.KeyToStyx=new N(this,52,{use:!0});this.FogLamp=
new N(this,53,{use:!0,trades:[0]});this.ShellFlute=new N(this,54,{use:!0});this.EyeGlasses=new N(this,55,{use:!0});this.BrokenStatue=new N(this,56,{use:!0});this.GlowingLamp=new N(this,57,{use:!0});this.StatueOfGold=new N(this,58,{use:!0});this.LovePendant=new N(this,59,{use:!0,trades:[0]});this.KirisaPlant=new N(this,60,{use:!0,trades:[0]});this.IvoryStatue=new N(this,61,{use:!0,trades:[0]});this.BowOfMoon=new N(this,62,{use:!0});this.BowOfSun=new N(this,63,{use:!0});this.BowOfTruth=new N(this,64,
{use:!0});this.Refresh=new N(this,65);this.Paralysis=new N(this,66);this.Telepathy=new N(this,67);this.Teleport=new N(this,68);this.Recover=new N(this,69);this.Barrier=new N(this,70);this.Change=new N(this,71);this.Flight=new N(this,72);this.armorDefense=Db(a.prg,jf.offset,9);this.shieldDefense=Db(a.prg,kf.offset,9)}write(){const a=this.rom.assembler();jf.loc(a);a.byte(...this.armorDefense);kf.loc(a);a.byte(...this.shieldDefense);const b=Array(10).fill(0);for(const c of this)c.assemble(a),c.unique&&
(b[c.id>>>3]|=1<<(c.id&7));dc(a,[$e,af],"KeyItemData");a.byte(...b);return[a.module()]}}const qf={33849:["expect"],33858:["screen"],33872:["empty"],33873:["screen"],33887:["location"],33937:["expect"],33961:["expect","expect"],33971:["location"],34E3:["expect"],34011:[],34016:["expect","empty"],34055:["empty"],34077:["empty"],34084:["empty"],34095:["empty"],34106:["empty"],34122:["empty"],34148:["empty"],34149:["expect"],34155:["flag"],34181:["empty"],34206:["expect","expect","expect","expect"]};new Set([62,63,64]);new Set([0,1,2,3,65,66,67,68,69,70,71,72]);new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m",
"Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",
4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",
5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,
110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m",
"Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,
"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,
,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",
,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,
"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([a,b,c,d=0,e=0,f=0,g=0,h=0,l=0])=>[a,{id:a,type:b,name:c,sdef:d,swrd:e,hits:f,satk:g,dgld:h,sexp:l}]));new Set([182]);new Set([89,92,110,111,129,138,163,196]);new Set([85,93,124,188,193]);function rf(a,b){if(b.eastCave){{b=b.eastCave;const {locations:{EastCave1:d,EastCave2:e,EastCave3:f,SealedCave1:g,ValleyOfWind:h},metascreens:{boundaryE_cave:l,branchNSE:q,branchNWE:p,branchNWSE:z,branchNWS:B,branchWSE:A,caveEmpty:w,deadEndE:S,deadEndE_downStair:ja,deadEndE_upStair:O,deadEndN_stairs:T,deadEndS:X,deadEndS_stairs:oa,deadEndW:xb,deadEndW_downStair:Rb,hallNE:ab,hallNS:fb,hallNW:pb,hallSE:Bb,hallWS:Ra,hallWE:gb,hallNS_entrance:Sb,hallNS_ramp:Tb,hallNS_wall:Oa}}=a;a.locations.allocate(d);
a.locations.allocate(e);b.exit2&&a.locations.allocate(f);for(var c of[d,e,f])c.bgm=c.originalBgm=23,c.entrances=[],c.exits=[],c.pits=[],c.spawns=[],c.flags=[],c.width=c.height=1,c.screens=[[128]],c.tilePalettes=[26,27,5],c.originalTilePalettes=[26,27,5],c.tileset=136,c.tileEffects=181,c.tilePatterns=[20,2],c.spritePatterns=[...g.spritePatterns],c.spritePalettes=[...g.spritePalettes];d.meta=new Xd(d.id,a.metatilesets.cave,5,5);d.meta.set2d(0,[[S,Ra,w,Bb,xb],[w,fb,Bb,pb,w],[Bb,z,B,w,w],[fb,Tb,ab,gb,
Ra],[Sb,ab,xb,O,pb]]);e.meta=new Xd(e.id,a.metatilesets.cave,5,5);e.meta.set2d(0,[[S,Ra,X,w,X],[w,fb,fb,w,fb],[w,q,p,A,pb],[w,Tb,w,ab,Ra],[S,pb,w,w,T]]);h.meta.set2d(51,[[l]]);a.tileEffects[0].effects[192]=0;d.meta.attach(67,e.meta,68);d.meta.attach(64,h.meta,51);b.exit1&&(d.meta.set2d(4,[[Rb]]),sf(d,4,b.exit1));b.exit2&&(f.meta=new Xd(f.id,a.metatilesets.cave,3,1),f.meta.set2d(0,[[oa],[Oa],[Sb]]),f.spawns.push(Ud.from([24,7,35,0])),f.flags.push(Sd.of({screen:16,flag:a.flags.alloc(512)})),e.meta.set2d(64,
[[ja]]),e.meta.attach(64,f.meta,0),sf(f,32,b.exit2));d.spawns.push(Ud.of({screen:33,tile:135,timed:!0,id:2}),Ud.of({screen:18,tile:136,timed:!1,id:2}),Ud.of({screen:19,tile:137,timed:!0,id:2}),Ud.of({screen:50,tile:104,timed:!1,id:2}),Ud.of({screen:65,tile:136,timed:!0,id:2}),Ud.of({screen:51,tile:152,timed:!0,id:2}),Ud.of({screen:3,tile:136,timed:!0,id:2}));e.spawns.push(Ud.of({screen:1,tile:136,timed:!0,id:2}),Ud.of({screen:17,tile:72,timed:!1,id:2}),Ud.of({screen:18,tile:119,timed:!0,id:2}),Ud.of({screen:20,
tile:40,timed:!1,id:2}),Ud.of({screen:35,tile:133,timed:!0,id:2}),Ud.of({screen:49,tile:136,timed:!0,id:2}),Ud.of({screen:51,tile:138,timed:!1,id:2}),Ud.of({screen:52,tile:152,timed:!0,id:2}),Ud.of({screen:65,tile:130,timed:!0,id:2}),Ud.of({y:272,x:1144,type:2,id:89}),Ud.of({y:112,x:264,type:2,id:124}));a.slots.swap(49,89)}}else if(b.classicLimeTreeToLeaf){{const {locations:{ValleyOfWind:b,LimeTreeValley:c},metascreens:{exitE:f,exitW_southwest:g,overworldEmpty_alt:h}}=a;b.meta.set2d(84,[[f]]);c.meta.set2d(16,
[[g],[h]]);b.meta.attach(84,c.meta,16)}}{const {TowerEntrance:b,Crypt_Teleporter:c}=a.locations;c.meta.attach(0,b.meta,0,"teleporter","teleporter")}{const {flags:{OpenedSwanGate:b},locations:{SwanGate:c},npcs:{SoldierGuard:f}}=a;c.spawns.push(Ud.of({xt:10,yt:2,type:1,id:45}),Ud.of({xt:11,yt:2,type:1,id:45}));f.localDialogs.get(c.id)[0].flags.push(b.id)}c=a.locations.GoaFortress_Kensu.meta;for(const [a,b]of c.exits())16>a||b.startsWith("seamless")||c.deleteExit(a,b);tf(a);uf(a.locations.SaberaPalace2_West,
a.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}(function(a){a.generateOptions=function(a,c){const b={};if(a.addEastCave()){b.eastCave={};a=["cordel","lime","goa","desert"];let d=c.nextInt(4);[b.eastCave.exit1]=a.splice(d,1);b.eastCave.exit2=c.pick(a)}else a.connectLimeTreeToLeaf()&&(b.classicLimeTreeToLeaf=!0);return b}})(rf||(rf={}));
function sf(a,b,c){const {locations:{CordelPlainEast:d,CordelPlainWest:e,Desert2:f,GoaValley:g,LimeTreeValley:h},metascreens:{bendNE:l,bendSE:q,boundaryN_trees:p,boundaryW_cave:z,cornerNE:B,cornerNW:A,cornerSE:w,cornerSE_cave:S,cornerSW:ja}}=a.rom;let O,T;switch(c){case "lime":O=h;T=16;O.resizeScreens(0,1,0,0);O.meta.spliceColumns(0,1,2,[[A,p],[z,q],[ja,w]]);break;case "cordel":c=[[z,q],[ja,w]];O=d;T=85;O.meta.set2d(85,c);e.meta.set2d(85,c);break;case "goa":O=g;T=17;O.meta.set2d(1,[[A,B],[z,l]]);
break;case "desert":O=f,T=83,O.meta.set2d(83,[[S]])}a.meta.attach(b,O.meta,T)}
function uf(a,b,...c){a.rom.locations.allocate(a,b);a.bgm=b.bgm;a.entrances=[];a.exits=[];a.pits=[];a.spawns=[];a.flags=[];a.width=a.height=1;a.screens=[[128]];a.tilePalettes=[...b.tilePalettes];a.originalTilePalettes=[...b.originalTilePalettes];a.tileset=b.tileset;a.tileEffects=b.tileEffects;a.tilePatterns=[...b.tilePatterns];a.spritePatterns=[...b.spritePatterns];a.spritePalettes=[...b.spritePalettes];let d=0,e=0;for(const a of c)d=Math.max(d,(a>>>4)+1),e=Math.max(e,(a&15)+1);a.meta=new Xd(a.id,
b.meta.tileset,d,e);for(const d of c)a.meta.set(d,b.meta.get(d)),b.meta.set(d,b.meta.tileset.empty);const f=new Set(c);a.flags=b.flags.filter(a=>f.has(a.screen));b.flags=b.flags.filter(a=>!f.has(a.screen));a.spawns=b.spawns.filter(a=>f.has(a.screen));b.spawns=b.spawns.filter(a=>!f.has(a.screen));b.meta.moveExitsAndPitsTo(a.meta)}function tf(a){a.locations.ZebuCave.spawns.find(a=>a.isTrigger()).yt+=3};class vf extends Sc{constructor(a,b){super(a,b);this.data=Db(a.prg,this.base,4)}get base(){return(this.id<<2)+171008}get slotRangeLower(){return this.data[0]}set slotRangeLower(a){this.data[0]=a}get slotRangeUpper(){return this.data[1]}set slotRangeUpper(a){this.data[1]=a}get objectId(){return this.data[2]}set objectId(a){this.data[2]=a}get count(){return this.data[3]}set count(a){this.data[3]=a}write(){const a=this.rom.assembler();a.segment("14");a.org(39936+(this.id<<2));a.byte(...this.data);return[a.module()]}}
;class wf extends Sc{constructor(a,b){super(a,b);this.base=Lb(a.prg,this.pointer);this.data=a.prg.slice(this.base+81920,this.base+81941);this.palettes=this.data.subarray(5,13);this.patterns=this.data.subarray(13,19)}get pointer(){return 129387+2*this.id}get routine(){const a=Lb(this.data,0);return a&&a+81920}set routine(a){var b=this.data;a=a?a-81920:0;b[0]=a&255;b[1]=a>>>8}get restoreMusic(){return this.data[3]}set restoreMusic(a){this.data[3]=a}get itemDrop(){return this.data[4]}set itemDrop(a){this.data[4]=
a}get restoreAnimation(){return this.data[19]}set restoreAnimation(a){this.data[19]=a}get explode(){return!!this.data[20]}set explode(a){this.data[20]=a?1:0}write(){if(!this.base)return[];const a=this.rom.assembler();a.segment("0f");a.org(this.base);a.byte(this.data[0],this.data[1]);a.org(this.base+4);a.byte(this.data[4]);return[a.module()]}};const {$0f:xf,$1b:yf}=y;
class zf{constructor(a){this.rom=a;this.Vampire1=new Af(this,{flag:this.rom.flags.Vampire1,kill:0,npc:this.rom.npcs.Vampire1,shuffled:!0,sword:1});this.Insect=new Af(this,{flag:this.rom.flags.GiantInsect,kill:1,npc:this.rom.npcs.Insect,sword:1});this.Kelbesque1=new Af(this,{flag:this.rom.flags.Kelbesque1,kill:2,npc:this.rom.npcs.Kelbesque1,shuffled:!0});this.Rage=new Af(this,{flag:this.rom.flags.Rage,kill:3,npc:this.rom.npcs.Rage});this.Sabera1=new Af(this,{address:222574,flag:this.rom.flags.Sabera1,
kill:4,npc:this.rom.npcs.SaberaDisguisedAsMesia,shuffled:!0});this.Vampire2=new Af(this,{flag:this.rom.flags.Vampire2,kill:12,npc:this.rom.npcs.Vampire2,shuffled:!0,sword:1});this.Mado1=new Af(this,{address:251936,flag:this.rom.flags.Mado1,kill:5,shuffled:!0});this.Kelbesque2=new Af(this,{flag:this.rom.flags.Kelbesque2,kill:6,npc:this.rom.npcs.Kelbesque2,shuffled:!0});this.Sabera2=new Af(this,{flag:this.rom.flags.Sabera2,kill:7,npc:this.rom.npcs.Sabera2,shuffled:!0});this.Mado2=new Af(this,{flag:this.rom.flags.Mado2,
kill:8,npc:this.rom.npcs.Mado2,shuffled:!0});this.Karmine=new Af(this,{flag:this.rom.flags.Karmine,kill:9,npc:this.rom.npcs.Karmine,shuffled:!0,sword:2});this.Draygon1=new Af(this,{flag:this.rom.flags.Draygon1,kill:10,npc:this.rom.npcs.Draygon,shuffled:!0,sword:2});this.StatueOfMoon=new Af(this,{flag:this.rom.flags.UsedBowOfMoon,npc:this.rom.npcs.StatueOfMoon});this.StatueOfSun=new Af(this,{flag:this.rom.flags.UsedBowOfSun,npc:this.rom.npcs.StatueOfSun});this.Draygon2=new Af(this,{flag:this.rom.flags.Draygon2,
kill:11,npc:this.rom.npcs.Draygon});this.Dyna=new Af(this,{kill:13,object:164});this.musics=[new Bf(xf,42168,[this.Vampire1,this.Vampire2]),new Bf(xf,42640,[this.Insect]),new Bf(xf,43419,[this.Kelbesque1,this.Kelbesque2]),new Bf(xf,44209,[this.Sabera1,this.Sabera2]),new Bf(xf,44559,[this.Mado1,this.Mado2]),new Bf(xf,44931,[this.Karmine]),new Bf(xf,45447,[this.Draygon1]),new Bf(xf,45841,[this.Draygon2]),new Bf(yf,48176,[this.Dyna])];this.all=[];for(const b in this)this.hasOwnProperty(b)&&(a=this[b],
a instanceof Af&&(a.name=zb(b),this.all.push(a)))}isBossFlag(a){return(this.flags||(this.flags=(()=>{const a=new Set;for(const b of this.all)null!=b.flag&&a.add(b.flag.id);return a})())).has(a)}fromLocation(a){return this.all.find(b=>b.location===a)}fromBossKill(a){return this.all.find(b=>b.kill===a)}fromObject(a){return this.all.find(b=>b.object===a)}[Symbol.iterator](){return this.all[Symbol.iterator]()}write(){const a=this.rom.assembler();for(const b of this.musics)b.addr.loc(a),a.byte(b.bgm);
return[a.module()]}}class Bf{constructor(a,b,c){this.bosses=c;this.addr=C.of(a,b);this.bgm=this.addr.read(c[0].bosses.rom.prg)}}
class Af{constructor(a,{flag:b,npc:c,kill:d,shuffled:e,address:f,sword:g=3,object:h}){this.bosses=a;({prg:a}=a.rom);this.flag=b;this.npc=c;this.object=f?a[f]:c?c.data[1]:null!==h&&void 0!==h?h:aa("address, npc, or object is required");this.swordLevel=g;this.shuffled=!!e;this.kill=d;null!=d&&(b=81920+Lb(a,129387+2*d),b=a[b+4],255!==b&&(this.drop=b),this.location=a[129373+d])}};class Cf{constructor(a){this.rom=a;this.values=Db(a.prg,Df.offset,16)}write(){const a=this.rom.assembler();Df.loc(a);a.word(...this.values);return[a.module()]}}const Df=C.of(y.$1a,35806);const Ef=Symbol(),Ff={assumeFalse:!0},Gf={assumeTrue:!0},Hf={track:!0},If={};
class Jf{constructor(a,b,c,d){var e;this.flags=a;this.name=b;this.id=c;this.fixed=d.fixed||!1;this.obsolete=d.obsolete;this.logic=null!==(e=d.logic)&&void 0!==e?e:Hf}get c(){return this.id}get r(){return[[this.id]]}get debug(){return this.id.toString(16).padStart(3,"0")+" "+this.name}get item(){if(256>this.id||383<this.id)throw Error(`not a slot: ${this.id}`);const a=this.flags.rom.items[this.flags.rom.itemGets[this.flags.rom.slots[this.id&255]].itemId];if(!a)throw Error("no item");return a}}
function P(a){"number"===typeof a&&(a=(a=>()=>a)(a));return{obsolete:a,[Ef]:!0}}function Kf(a,b){b=void 0===b?If:b;return{id:a,fixed:!0,[Ef]:!0,logic:b}}function Q(a){return Kf(a,Hf)}function Lf(a,b){b=void 0===b?If:b;return{id:a,[Ef]:!0,logic:b}}function R(a,b){b=void 0===b?If:b;return{name:a,[Ef]:!0,logic:b}}function Mf(a,b){b=void 0===b?If:b;return{name:a,[Ef]:!0,logic:b}}function Nf(a){const b=Of.get(a)||1024;Of.set(a,b+1);return{id:b,[Ef]:!0,logic:Hf}}const Of=new WeakMap;
class Pf{constructor(a){this.rom=a;this[0]=Kf(0,Ff);this[1]=Kf(1);this[2]=Kf(2);this[3]=Kf(3);this[4]=Kf(4);this[5]=Kf(5);this[6]=Kf(6);this[7]=Kf(7);this[8]=Kf(8);this[9]=Kf(9);this.UsedWindmillKey=Kf(10,Hf);this[11]=P(256);this[12]=Mf("Leaf villager");this.LeafVillagersRescued=Lf(13);this[14]=P(a=>{var b;return 133===(null===(b=a.trigger)||void 0===b?void 0:b.id)?323:579});this.WokeWindmillGuard=Lf(15,Hf);this.TurnedInKirisaPlant=Lf(16);this[17]=R("Welcomed to Amazones");this[18]=R("Treasure hunter dead");
this[19]=P(312);this[22]=R("Portoa queen Rage hint");this[23]=P(258);this.EnteredUndergroundChannel=Lf(24,Hf);this[25]=Mf("Portoa queen tired of talking");this[26]=R("Initial talk with Portoa queen");this.MesiaRecording=Lf(27,Hf);this[28]=P(272);this.TalkedToFortuneTeller=Lf(29,Hf);this.QueenRevealed=Lf(30,Hf);this[31]=P(265);this.QueenNotInThroneRoom=Lf(32);this.ReturnedFogLamp=Lf(33,Hf);this[34]=R("Sahara elder");this[35]=R("Sahara elder daughter");this[36]=P(317);this[37]=P(310);this[38]=P(765);
this.ShyronMassacre=Kf(39,Hf);this.ChangeWoman=Kf(40);this.ChangeAkahana=Kf(41);this.ChangeSoldier=Kf(42);this.ChangeStom=Kf(43);this[45]=R("Shyron sages");this[46]=P(301);this.UsedBowOfTruth=Kf(47);this[49]=R("Zombie town");this[50]=P(311);this[52]=R("Akahana in waterfall cave");this.CuredAkahana=Lf(53,Hf);this[54]=R("Akahana Shyron");this[55]=P(322);this.LeafAbduction=Lf(56,Hf);this[57]=P(321);this.TalkedToZebuInCave=Lf(58,Hf);this.TalkedToZebuInShyron=Lf(59,Hf);this[60]=P(315);this[61]=R("Asina in Shyron temple");
this.FoundKensuInDanceHall=Lf(62,Hf);this[63]=P(a=>{var b;return 186===(null===(b=a.trigger)||void 0===b?void 0:b.id)?580:324});this[64]=R("Tornel in Shyron temple");this[65]=P(263);this[68]=P(263);this.RescuedChild=Kf(69,Hf);this.UsedInsectFlute=Kf(70);this.RescuedLeafElder=Lf(71);this[72]=R("Treasure hunter embarked");this[73]=P(257);this[74]=R("Boat owner");this[75]=Mf("Shyron sick men");this[76]=Mf("Shyron training men 1");this[77]=Mf("Shyron training men 2");this[78]=P(262);this[79]=P(299);this.GivenStatueToAkahana=
Lf(80);this[81]=P(326);this.TalkedToDwarfMother=Lf(82,Hf);this.LeadingChild=Kf(83,Hf);this[85]=R("Zebu rescued");this[86]=R("Tornel rescued");this[87]=R("Asina rescued");this.MtSabreGuardsDespawned=Lf(91,Gf);this[94]=P(653);this[95]=P(515);this.TalkedToStomInSwan=Lf(97,Hf);this[98]=P(337);this[99]=P(327);this.CuredKensu=Lf(101,Hf);this[103]=P(267);this[104]=P(260);this.StonedPeopleCured=Lf(106,Hf);this[108]=P(284);this.CurrentlyRidingDolphin=Kf(-111,Hf);this.ParalyzedKensuInTavern=Kf(112);this.ParalyzedKensuInDanceHall=
Kf(113);this.FoundKensuInTavern=Lf(114,Hf);this[115]=R("Startled man in Leaf");this[117]=P(313);this[118]=R("Kensu in Goa");this[119]=P(264);this[120]=P(268);this[121]=P(320);this[122]=P(266);this[123]=P(265);this[125]=P(319);this[126]=R("Mt Sabre guards 1");this[127]=R("Mt Sabre guards 2");this.AlarmFluteUsedOnce=Kf(118);this.FluteOfLimeUsedOnce=Kf(119);this[130]=P(320);this[131]=R("Rescued Leaf elder");this.LeafVillagersCurrentlyAbducted=Lf(132);this.LeafElderCurrentlyAbducted=Lf(133);this[135]=
P(261);this[136]=P(306);this[137]=R("Dead Stom's girlfriend");this[138]=R("Dead Stom");this[139]=P(566);this[141]=P(311);this[143]=P(643);this[144]=R("Stoned people gone");this[146]=P(296);this[150]=Mf("Leaf elder daughter");this[151]=Mf("Leaf villager");this[152]=R("Nadare villager");this.AbleToRideDolphin=Lf(155,Hf);this.PortoaQueenGoingAway=Lf(156);this[160]=P(295);this[163]=Mf("Portoa queen/fortune teller");this.WokeKensuInLighthouse=Lf(164,Hf);this[165]=P(305);this[166]=R("Oak elder 1",Ff);this[167]=
Mf("Swan dancer");this[168]=R("Oak elder 2",Ff);this.TalkedToLeafRabbit=Lf(169,Hf);this[170]=P(285);this[171]=P(336);this[173]=P(338);this[174]=P(339);this[175]=P(340);this[176]=P(341);this[177]=P(342);this[178]=P(343);this[179]=P(344);this[180]=P(345);this[181]=P(346);this[182]=P(287);this[183]=P(348);this[184]=P(349);this[185]=P(286);this[186]=P(350);this[187]=P(351);this[188]=P(352);this[189]=P(288);this[190]=P(289);this[191]=P(354);this[192]=P(355);this[193]=P(356);this[194]=P(290);this[195]=
P(357);this[196]=P(358);this[197]=P(363);this[198]=P(364);this[199]=P(291);this[200]=P(292);this[201]=P(362);this[202]=P(317);this[203]=P(298);this[204]=P(284);this[205]=P(276);this[206]=P(293);this[207]=P(307);this[208]=P(296);this[209]=P(309);this[210]=P(361);this[211]=P(294);this[212]=P(347);this[213]=Mf("Portoa queen 1");this[214]=Mf("Portoa queen 2");this[215]=Mf("Portoa queen 3");this[216]=R("Kensu rescued");this[217]=Mf("Stoned pair");this[218]=R("Kensu gone from tavern");this[219]=Mf("In Sabera's trap");
this[220]=P(367);this[221]=P(368);this[222]=P(300);this[223]=P(283);this[224]=R("Dead Akahana");this[228]=P(316);this[229]=P(366);this[230]=P(365);this[231]=P(303);this[232]=R("Dead Shyron villager");this[233]=R("Dead Shyron guard");this[234]=R("Tower message 1");this[235]=R("Tower message 2");this[236]=R("Tower message 3");this[237]=R("Mesia");this.TalkedToZebuStudent=Lf(238,Hf);this[256]=P(302);this[257]=P(263);this[258]=P(264);this[259]=P(265);this[261]=P(294);this[262]=P(291);this[263]=P(274);
this[264]=P(317);this.UsedBowOfMoon=Lf(265);this.UsedBowOfSun=Lf(266);this[267]=P(284);this[268]=P(353);this.LeafElder=Q(-257);this.OakElder=Q(-258);this.WaterfallCaveSwordOfWaterChest=Q(-259);this.StxyLeftUpperSwordOfThunderChest=Q(-260);this.MesiaInTower=Q(260);this.SealedCaveBallOfWindChest=Q(-262);this.MtSabreWestTornadoBraceletChest=Q(-263);this.GiantInsect=Q(-264);this.Kelbesque1=Q(-265);this.Rage=Q(-266);this.AryllisBasementChest=Q(-267);this.Mado1=Q(-268);this.StormBraceletChest=Q(-269);this.WaterfallCaveRiverLeftChest=
Q(272);this.Mado2=Q(274);this.StxyRightMiddleChest=Q(276);this.BattleArmorChest=Q(283);this.Draygon1=Q(284);this.SealedCaveSmallRoomBackChest=Q(285);this.SealedCaveBigRoomNortheastChest=Q(286);this.FogLampCaveFrontChest=Q(287);this.MtHydraRightChest=Q(288);this.SaberaUpstairsLeftChest=Q(289);this.EvilSpiritIslandLowerChest=Q(290);this.Sabera2=Q(291);this.SealedCaveSmallRoomFrontChest=Q(292);this.CordelGrass=Q(293);this.Kelbesque2=Q(294);this.OakMother=Q(295);this.PortoaQueen=Q(296);this.AkahanaStatueOfOnyxTradein=
Q(297);this.OasisCaveFortressBasementChest=Q(298);this.Brokahana=Q(299);this.EvilSpiritIslandRiverLeftChest=Q(300);this.Deo=Q(301);this.Vampire1=Q(302);this.OasisCaveNorthwestChest=Q(303);this.AkahanaFluteOfLimeTradein=Q(304);this.ZebuStudent=Q(305);this.WindmillGuardAlarmFluteTradein=Q(306);this.MtSabreNorthBackOfPrisonChest=Q(307);this.ZebuInShyron=Q(308);this.FogLampCaveBackChest=Q(309);this.InjuredDolphin=Q(310);this.Clark=Q(311);this.Sabera1=Q(312);this.KensuInLighthouse=Q(313);this.RepairedStatue=
Q(314);this.UndergroundChannelUnderwaterChest=Q(315);this.KirisaMeadow=Q(316);this.Karmine=Q(317);this.Aryllis=Q(318);this.MtHydraSummitChest=Q(319);this.AztecaInPyramid=Q(320);this.ZebuAtWindmill=Q(321);this.MtSabreNorthSummit=Q(322);this.StomFightReward=Q(323);this.MtSabreWestTornel=Q(324);this.AsinaInBackRoom=Q(325);this.BehindWhirlpool=Q(326);this.KensuInSwan=Q(327);this.SlimedKensu=Q(328);this.SealedCaveBigRoomSouthwestChest=Q(336);this.MtSabreWestRightChest=Q(338);this.MtSabreNorthMiddleChest=
Q(339);this.FortressMadoHellwayChest=Q(340);this.SaberaUpstairsRightChest=Q(341);this.MtHydraFarLeftChest=Q(342);this.StxyLeftLowerChest=Q(343);this.KarmineBasementLowerMiddleChest=Q(344);this.EastCaveNortheastChest=Q(345);this.OasisCaveEntranceAcrossRiverChest=Q(346);this.EvilSpiritIslandExitChest=Q(348);this.FortressSaberaMiddleChest=Q(349);this.MtSabreNorthUnderBridgeChest=Q(350);this.KirisaPlantCaveChest=Q(351);this.FortressMadoUpperNorthChest=Q(352);this.Vampire2=Q(353);this.FortressSaberaNorthwestChest=
Q(354);this.FortressMadoLowerCenterNorthChest=Q(355);this.OasisCaveNearEntranceChest=Q(356);this.MtHydraLeftRightChest=Q(357);this.FortressSaberaSoutheastChest=Q(358);this.KensuInCabin=Q(359);this.MtSabreWestNearKensuChest=Q(361);this.MtSabreWestLeftChest=Q(362);this.FortressMadoUpperBehindWallChest=Q(363);this.PyramidChest=Q(364);this.CryptRightChest=Q(365);this.KarmineBasementLowerLeftChest=Q(366);this.FortressMadoLowerSoutheastChest=Q(367);this.FogLampCaveMiddleNorthMimic=Q(368);this.FogLampCaveMiddleSouthwestMimic=
Q(369);this.WaterfallCaveFrontMimic=Q(370);this.EvilSpiritIslandRiverRightMimic=Q(371);this.MtHydraFinalCaveMimic=Q(372);this.StxyLeftNorthMimic=Q(373);this.StxyRightNorthMimic=Q(374);this.StxyRightSouthMimic=Q(375);this.CryptLeftPitMimic=Q(376);this.KarmineBasementUpperMiddleMimic=Q(377);this.KarmineBasementUpperRightMimic=Q(378);this.KarmineBasementLowerRightMimic=Q(379);this.SwordOfWind=Q(512);this.SwordOfFire=Q(513);this.SwordOfWater=Q(514);this.SwordOfThunder=Q(515);this.Crystalis=Q(516);this.BallOfWind=
Q(517);this.TornadoBracelet=Q(518);this.BallOfFire=Q(519);this.FlameBracelet=Q(520);this.BallOfWater=Q(521);this.BlizzardBracelet=Q(522);this.BallOfThunder=Q(523);this.StormBracelet=Q(524);this.CarapaceShield=Q(525);this.BronzeShield=Q(526);this.PlatinumShield=Q(527);this.MirroredShield=Q(528);this.CeramicShield=Q(529);this.SacredShield=Q(530);this.BattleShield=Q(531);this.PsychoShield=Q(532);this.TannedHide=Q(533);this.LeatherArmor=Q(534);this.BronzeArmor=Q(535);this.PlatinumArmor=Q(536);this.SoldierSuit=
Q(537);this.CeramicSuit=Q(538);this.BattleArmor=Q(539);this.PsychoArmor=Q(540);this.MedicalHerb=Q(541);this.Antidote=Q(542);this.LysisPlant=Q(543);this.FruitOfLime=Q(544);this.FruitOfPower=Q(545);this.MagicRing=Q(546);this.FruitOfRepun=Q(547);this.WarpBoots=Q(548);this.StatueOfOnyx=Q(549);this.OpelStatue=Q(550);this.InsectFlute=Q(551);this.FluteOfLime=Q(552);this.GasMask=Q(553);this.PowerRing=Q(554);this.WarriorRing=Q(555);this.IronNecklace=Q(556);this.DeosPendant=Q(557);this.RabbitBoots=Q(558);this.LeatherBoots=
Q(559);this.ShieldRing=Q(560);this.AlarmFlute=Q(561);this.WindmillKey=Q(562);this.KeyToPrison=Q(563);this.KeyToStxy=Q(564);this.FogLamp=Q(565);this.ShellFlute=Q(566);this.EyeGlasses=Q(567);this.BrokenStatue=Q(568);this.GlowingLamp=Q(569);this.StatueOfGold=Q(570);this.LovePendant=Q(571);this.KirisaPlant=Q(572);this.IvoryStatue=Q(573);this.BowOfMoon=Q(574);this.BowOfSun=Q(575);this.BowOfTruth=Q(576);this.Refresh=Q(577);this.Paralysis=Q(578);this.Telepathy=Q(579);this.Teleport=Q(580);this.Recover=Q(581);
this.Barrier=Q(582);this.Change=Q(583);this.Flight=Q(584);this.CalmedAngrySea=Q(643);this.OpenedJoelShed=Q(647);this.Draygon2=Q(653);this.OpenedCrypt=Q(654);this.OpenedStxy=Q(688);this.OpenedSwanGate=Q(691);this.OpenedPrison=Q(728);this.OpenedSealedCave=Q(750);this.AlwaysTrue=Kf(752,Gf);this.WarpLeaf=Q(757);this.WarpBrynmaer=Q(758);this.WarpOak=Q(759);this.WarpNadare=Q(760);this.WarpPortoa=Q(761);this.WarpAmazones=Q(762);this.WarpJoel=Q(763);this.WarpZombie=Q(-764);this.WarpSwan=Q(764);this.WarpShyron=
Q(765);this.WarpGoa=Q(766);this.WarpSahara=Q(767);this.Sword=Nf(this);this.Money=Nf(this);this.BreakStone=Nf(this);this.BreakIce=Nf(this);this.FormBridge=Nf(this);this.BreakIron=Nf(this);this.TravelSwamp=Nf(this);this.ClimbWaterfall=Nf(this);this.BuyHealing=Nf(this);this.BuyWarp=Nf(this);this.ShootingStatue=Nf(this);this.ClimbSlope8=Nf(this);this.ClimbSlope9=Nf(this);this.WildWarp=Nf(this);this.unallocated=new Map;for(var b in this){if(!this.hasOwnProperty(b))continue;var c=this[b];if(!c[Ef])continue;
var d=Number(b);const a="number"===typeof c.id?c.id:d;if(isNaN(a))throw Error(`Bad flag: ${b}`);d=c.name||(isNaN(d)?zb(b):"Flag "+a.toString(16).padStart(3,"0"));c=new Jf(this,d,a,c);this[b]=c;0>c.id?this.unallocated.set(~c.id,c):this[c.id]||(this[c.id]=c)}for(b=256;384>b;b++)c=`Check ${x(b&255)}`,this[b]?this[b].fixed||this.unallocated.has(b)||this.unallocated.set(b,new Jf(this,c,~b,{fixed:!0})):this[b]=new Jf(this,c,b,{fixed:!0});for(b=384;640>b;b++)this[b]||(this[b]=new Jf(this,(512>b?"Buffer ":
"Item ")+x(b),b,{fixed:!0}));for(const b of a.locations)for(const a of b.flags)this[a.flag]||(this[a.flag]=Qf(this,a.flag))}defrag(){function a(a){return()=>a}var b=new Map,c=new Set;for(var d=0;768>d;d++){const a=this[d],e=null===a||void 0===a?void 0:a.obsolete;e?(b.set(d,b=>b.set?-1:e.call(a,b)),delete this[d]):a||c.add(d)}d=0;let e=767;for(;d<e;){if(this[d]||this.unallocated.has(d)){d++;continue}const c=this[e];c&&!c.fixed&&(b.set(e,a(d)),c.id=d,this[d]=c,delete this[e],d++);e--}this.remapFlags(b,
c);for(const a of this.unallocated){const [b,c]=a;this[b]||(this.unallocated.delete(b),(this[b]=c).id=b)}b=[];for(c=0;768>c;c++)this[c]||b.push(c.toString(16).padStart(3,"0"));console.log(`Free flags: ${b.join(" ")}`)}insertZombieWarpFlag(){const a=new Map;if(this[756])throw Error("No space to insert warp flag");const b=~this.WarpZombie.id;if(0>b)throw Error("Bad WarpZombie id");for(let c=756;c<b;c++)this[c]=this[c+1],this[c].id=c,a.set(c+1,()=>c);this.WarpZombie.id=b;this[b]=this.WarpZombie;this.remapFlags(a)}remap(a,
b){this.remapFlags(new Map([[a,()=>b]]))}remapFlags(a,b){function c(c,d){for(let f=c.length-1;0<=f;f--){var e=c[f];0>e&&(e=~e);if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);null!=e&&(e=e(Object.assign({},d,{index:f})),0<=e?c[f]=0>c[f]?~e:e:c.splice(f,1))}}function d(c,d){var e=0>c?~c:c;if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);if(null==e)return c;d=e(d);if(0>d)throw Error("Bad flag delete");return 0>c?~d:d}for(var e of this.rom.locations)if(e.used)for(const a of e.flags)a.flag=
d(a.flag,{location:e});for(const a of this.rom.npcs)if(a.used){for(const b of a.spawnConditions){const [d,e]=b;c(e,{npc:a,spawn:d})}for(const b of a.globalDialogs)b.condition=d(b.condition,{npc:a,dialog:!0});for(const b of a.localDialogs){[,e]=b;for(const b of e)b.condition=d(b.condition,{npc:a,dialog:!0}),c(b.flags,{npc:a,dialog:!0,set:!0})}}for(const a of this.rom.triggers)a.used&&(c(a.conditions,{trigger:a}),c(a.flags,{trigger:a,set:!0}));for(const a of this.rom.itemGets)c(a.flags,{set:!0});for(const a of this.rom.items)for(const b of a.itemUseData)"flag"===
b.kind&&(b.want=d(b.want,{})),c(b.flags,{set:!0})}alloc(a){if(512!==(void 0===a?0:a))throw Error("Cannot allocate outside 2xx");for(a=640;768>a;)return this[a]||(this[a]=Qf(this,a)),a;throw Error("No free flags.");}free(a){delete this[a]}}function Qf(a,b){return new Jf(a,"Wall "+x(b&255),b,{fixed:!0})};class Rf extends Sc{constructor(a,b){super(a,b);this.coordinates=Db(a.prg,this.base,4)}get base(){return 218769+(this.id<<2)}get w(){return this.coordinates[1]}set w(a){this.coordinates[1]=a}get x0(){return Eb(this.coordinates[0])}set x0(a){this.coordinates[0]=0>a?a+256:a}get x1(){return this.x0+this.w}get h(){return this.coordinates[3]}set h(a){this.coordinates[3]=a}get y0(){return Eb(this.coordinates[2])}set y0(a){this.coordinates[2]=0>a?a+256:a}get y1(){return this.y0+this.h}write(){const a=this.rom.assembler();
a.segment("1a");a.org(38545+(this.id<<2));a.byte(...this.coordinates);return[a.module()]}};const {$0e:Sf,$0f:Tf,$14:Uf,$fe:Vf,$ff:Wf}=y,Xf=C.of(Sf,39680),Yf=C.of(Sf,40294);
class Zf extends Tc{constructor(a){super(113);this.rom=a;this.actionGrants=new Map;for(let b=0;113>b;b++)this[b]=new $f(a,b);this.actionGrants.set(37,41);this.actionGrants.set(57,58);this.actionGrants.set(59,71);this.actionGrants.set(60,62);this.actionGrants.set(132,70);this.actionGrants.set(178,66);this.actionGrants.set(180,65)}write(){const a=this.rom.assembler();for(const b of this)b.assemble(a);dc(a,[Uf,Vf,Wf],"GrantItemTable");for(const [b,c]of this.actionGrants)a.byte(b,c);return[a.module()]}}
class $f extends Sc{constructor(a,b){super(a,b);this._itemId=this.itemPointer.read(a.prg);const c=this.tablePointer.readAddress(a.prg,Sf,Tf);let d=c.offset;this.inventoryRowStart=a.prg[d++];this.inventoryRowLength=a.prg[d++];this.acquisitionAction=Be.from(a.prg,d);this.flags=Pb.read(a.prg,d+2);this.key=254===a.prg[d+2+2*this.flags.length+1];0!==b&&c.org===Lb(a.prg,122214)&&(this.key=!1,this.flags=[])}get itemPointer(){return Yf.plus(this.id)}get tablePointer(){return Xf.plus(this.id<<1)}get itemId(){return this._itemId}set itemId(a){if(73>
this.id)throw Error(`${this.id}`);this._itemId=a}isLosable(){return ag.has(this.inventoryRowStart)}copyFrom(a){this.inventoryRowStart=a.inventoryRowStart;this.inventoryRowLength=a.inventoryRowLength;this.acquisitionAction=a.acquisitionAction;this.flags=[...a.flags];this.key=a.key}assemble(a){this.itemPointer.loc(a);a.byte(this.itemId);const b=[this.inventoryRowStart,this.inventoryRowLength,...this.acquisitionAction.data,...Pb.bytes(this.flags),this.key?254:255];a.segment(Sf.name,Tf.name);a.reloc(`ItemGetData ${x(this.id)}`);
const c=a.pc();a.byte(...b);this.tablePointer.loc(a);a.word(c)}}const ag=new Set([4,8,16]);const {$14:bg,$15:cg,$16_a:dg,$17:eg}=y,fg=new Map([[6,"{}"],[7,"[]"]]);
class gg{constructor(a,b,c,d,e){this.messages=a;this.part=b;this.id=c;this.bytes=[];this.hex="";a=a.rom.prg;b=[];for(c=d;d&&a[c];c++){const f=a[c];this.bytes.push(f);if(1===f){if(c!==d&&3!==a[c-1])throw Error(`Unexpected start message signal at ${c.toString(16)}`);}else if(2===f)b.push("\n ");else if(3===f)b.push(`${hg.CONTINUED}\n`);else if(4===f)b.push("{:HERO:}");else if(8===f)b.push("[:ITEM:]");else if(5<=f&&9>=f){const d=a[++c];this.bytes.push(d);if(9===f){b.push(" ".repeat(d));continue}const h=
fg.get(f);h&&(b.push(h[0]),b.push(d.toString(16).padStart(2,"0")),b.push(":"));b.push(e(d,f));h&&b.push(h[1]);ig[String.fromCharCode(a[c+1])]||b.push(" ")}else if(128<=f)b.push(e(f,0)),ig[String.fromCharCode(a[c+1])]||b.push(" ");else if(32<=f)b.push(String.fromCharCode(f));else throw Error(`Non-exhaustive switch: ${f} at ${c.toString(16)}`);}this.text=b.join("")}get mid(){return`${x(this.part)}:${x(this.id)}`}fixText(){function a(a,b=a.length){28<f+b&&c();" "===a?(d.push(...h," "),h=[]):/^[[{]:/.test(a)?
h.push({toString:()=>a,length:b}):h.push(a);f+=b;g=a.endsWith(" ")}function b(b){b=b.split(/\s+/);for(let c=0;c<b.length;c++)c&&(g||a(" "),g=!0),a(b[c])}function c(){f=1+h.reduce((a,b)=>a+b.length,0);2<++e?(d.push("#\n "),e=0):d.push("\n ");g=!0}if(!this.checkText()){var d=[],e=0,f=0,g=!1,h=[],l=new Map;for(var q=0;q<this.text.length;q++){var p=this.text[q],z=this.text[q+1];/[\s\n#]/.test(p)?(g||a(" "),g=!0):"{"===p?(":"===z?a("{:HERO:}",6):(p=this.text.indexOf(":",q),p=Number.parseInt(this.text.substring(q+
1,p),16),z=this.messages.extraWords[6][p],l.set(z,`{${p.toString(16)}:${z}}`),b(z)),q=this.text.indexOf("}",q)):"["===p?(":"===z?a("[:ITEM:]",Math.max(...this.messages.rom.items.map(a=>a.messageName.length))):(p=this.text.indexOf(":",q),p=Number.parseInt(this.text.substring(q+1,p),16),z=this.messages.rom.items[p].messageName,l.set(z,`[${p.toString(16)}:${z}]`),b(z)),q=this.text.indexOf("]",q)):a(p)}d.push(...h);q=d.join("");for(const [a,b]of l)q.includes(a)&&(q=q.split(a).join(b));this.text=q}}checkText(){let a=
0,b=0;const c=this.text.replace(/\s+$/mg,"");for(let e=0;e<c.length;e++){const f=c[e];var d=c[e+1];if("\n"===f){if(a++,b=0,3<a)return!1}else if("#"===f)"\n"===d&&e++,a=b=0;else if("{"===f||"["===f){if(":"===d){if(b="{"===f?b+6:b+Math.max(...this.messages.rom.items.map(a=>a.messageName.length)),28<b)return!1}else d=c.indexOf(":",e),d=Number.parseInt(c.substring(e+1,d),16),b+=("{"===f?this.messages.personNames[d]:this.messages.itemNames[d]).length;e=c.indexOf(jg[f],e)}else b++;if(28<b||14<b&&2<a&&c.includes("#",
e))return!1}return!0}}const ig={"\x00":!0," ":!0,"!":!0,"'":!0,",":!0,".":!0,":":!0,";":!0,"?":!0,_:!0,"\n":!0,"#":!0},kg=C.of(bg,34564),lg=C.of(bg,34442),mg=C.of(bg,34517),ng=C.of(bg,34537),og=C.of(bg,34697),pg=C.of(bg,34113),qg=C.of(bg,34380),rg=C.of(bg,34124),sg={21:cg,22:dg,23:eg};
class hg{constructor(a){this.rom=a;this.partCount=34;this.commonWords=[];this.uncommonWords=[];this.personNames=[];this.itemNames=[];this.parts=[];const b=kg.readAddress(a.prg);var c=lg.readAddress(a.prg),d=mg.readAddress(a.prg),e=ng.readAddress(a.prg),f=pg.readAddress(a.prg);const g=rg.readAddress(a.prg),h={5:c,6:d,7:e};this.extraWords={5:this.uncommonWords,6:this.personNames,7:this.itemNames};const l=(b,c,d)=>{let e=b[d];if(null!=e)return e;e=Mb(a.prg,c.plus(2*d).readAddress(a.prg).offset);return b[d]=
e};c=(a,c)=>c?l(this.extraWords[c],h[c],a):l(this.commonWords,b,a-128);for(d=0;73>d;d++)c(d,7);f=f.offset;this.banks=Db(a.prg,f,this.partCount);for(d=this.partCount-1;0<=d;d--){e=g.plus(2*d).readAddress(a.prg);const b=f-e.offset>>>1;f=e.offset;const h=sg[this.banks[d]],l=this.parts[d]=[];for(let f=0;f<b;f++){const b=e.plus(2*f).readAddress(a.prg,h);l[f]=new gg(this,d,f,b.offset,c)}}}*messages(a){for(const b of this.parts)if(a)for(const c of b)a.has(c.mid)&&(yield c);else yield*b}alloc(){const a=this.uses();
for(const b of this.parts)for(const c of b)if(!a.has(c.mid))return c;throw Error("could not find an unused message id");}uses(){function a(a,c){a="string"===typeof a?a:a.mid;const d=b.get(a)||new Set;d.add(c);b.set(a,d)}const b=new Map;for(var c of this.rom.triggers)c.message.nonzero()&&a(c.message,`Trigger $${x(c.id)}`);for(const b of this.rom.items)for(const c of b.itemUseMessages())c.nonzero()&&a(c,`Item $${x(b.id)}`);for(const b of this.rom.npcs){for(const c of b.globalDialogs)a(c.message,`NPC $${x(b.id)}`);
for(const [d,f]of b.localDialogs){c=0<=d?` @ $${x(d)}`:"";for(const d of f)a(d.message,`NPC $${x(b.id)}${c}`)}}for(const b of this.rom.telepathy.sages){for(const c of b.defaultMessages)a(c,`Telepathy ${b.sage}`);for(const c of b.messageGroups)for(const [,...d]of c.messages)for(const c of d)a(c,`Telepathy ${b.sage}`)}for(const b of tg)a(b,"Hardcoded");return b}buildAbbreviationTable(a=this.uses()){const b=[];var c=new Map;const d=new Map;for(var e of this.messages(a)){e.fixText();a=e.mid;var f=c.get(e.text);
if(f=null!=f&&d.get(f))f.push(a);else{c.set(e.text,a);d.set(a,[]);f=e.text;var g=[];for(let c=0,d=f.length;c<=d;c++){var h=f[c],l=jg[h];if(ig[h]||l||c===d){var q=f[c+1];l&&(c=Math.max(c,f.indexOf(l,c)));if(g.length){l=" "!==h&&"'"!==h||!q||ig[q]?"":h;q=g.join("");var p=b.length;h=q.length+(" "===h?1:0);g=[];b.push({str:q,id:p,chain:l,bytes:h,used:0,suffixes:new Set,mid:a})}}else g.push(h)}}}c=new Map;for(e=b.length-1;0<=e;e--)for(a=b[e],f=a.bytes-2;0<=f;f--)for(g=a.str.substring(f),h=0,l=a,q=a.bytes-
f-1;;){(p=c.get(g))||c.set(g,p={chains:h,missing:f,saving:-g.length,str:g,words:new Set});p.words.add(e);p.saving+=q;for(let a=h;0<=a;a--)b[e+a].suffixes.add(p);if(!l.chain)break;g+=l.chain;l=b[e+ ++h];g+=l.str;q+=l.bytes}e=new Set;a=[];f=({saving:a},{saving:b})=>b-a;g=[...c.values()].sort(f);for(h=0;g.length&&1250>h;){e.has(g[0].str)&&(g.sort(f),e.clear());const {str:z,saving:B,missing:A,words:w,chains:S}=g.shift();if(0>=B)break;h+=z.length+3;l=a.length;q=new Set;for(const a of w){p=b[a];for(const a of[p.mid,
...d.get(p.mid)||[]])q.add(a)}a.push({bytes:128>l?[l+128]:[5,l-128],mids:q,str:z});for(const a of w)for(l=0;l<=S;l++){q=b[a+l];p=q.bytes-(l?0:A);for(const a of q.suffixes)a.saving-=p-q.used,e.add(a.str);q.used=p}if(128===a.length){for(const a of c.values())a.saving-=a.words.size;g.sort(f);e.clear()}}return a}compress(){var a=this.uses(),b=this.buildAbbreviationTable(a);const c=new Map;this.commonWords.splice(0,this.commonWords.length);this.uncommonWords.splice(0,this.uncommonWords.length);for(var d of b){1===
d.bytes.length?this.commonWords[d.bytes[0]&127]=d.str:this.extraWords[d.bytes[0]][d.bytes[1]]=d.str;for(var e of d.mids)(b=c.get(e))||c.set(e,b=[]),b.push(d)}for(var f of c.values())f.sort(({str:{length:a}},{str:{length:b}})=>b-a);for(const g of this.messages(a)){a=g.text;a=a.replace(/([\[{])([^\]}]*)[\]}](.|$)/g,(a,b,c,d)=>{if(d&&!ig[d])return a;" "===d&&(d="");if("["===b&&":ITEM:"===c)return`[8]${d}`;if("{"===b&&":HERO:"===c)return`[4]${d}`;c=/^([0-9a-f]+):/.exec(c);if(!c)throw Error(`Bad message text: ${a}`);
a=Number.parseInt(c[1],16);return`[${"{"===b?6:7}][${a}]${d}`});for(const {str:b,bytes:d}of c.get(g.mid)||[])a=a.replace(new RegExp(b+"( [ &0-9]|.|$)","g"),(a,b)=>{if(b&&!ig[b])return a;" "===b&&(b="");return d.map(a=>`[${a}]`).join("")+b});d=["[01]"];e=[];e.push(1);for(let c=0,g=a.length;c<g;c++)if(f=a[c],f===hg.CONTINUED)e.push(3,1),d.push("[03][01]"),"\n"===a[c+1]&&c++;else if("\n"===f)e.push(2)," "===a[c+1]&&c++,d.push("[02]");else if("["===f){f=a.indexOf("]",c);if(0>=f)throw Error(`bad text: ${a}`);
b=Number(a.substring(c+1,f));if(isNaN(b))throw Error(`bad text: ${a}`);e.push(b);d.push(`[${x(b)}]`);c=f}else if(" "===f&&" "===a[c+1]){for(f=c+2;" "===a[f];)f++;e.push(9,f-c);d.push(`[09][${x(f-c)}]`);c=f-1}else e.push(f.charCodeAt(0)),d.push(f);e.push(0);d.push("[0]");g.bytes=e;g.hex=d.join("")}}write(){function a(a,c,...d){a.loc(b);b.word(c);let e=0;for(const f of d)a.plus(f).loc(b),b.word({op:"+",args:[c,{op:"num",num:++e}]})}const b=this.rom.assembler();cc(b,bg,32768,34048);cc(b,bg,34080,34088);
cc(b,bg,34182,34195);cc(b,bg,35072,37888);cc(b,bg,38533,38662);cc(b,bg,40576,40960);cc(b,cg,40960,49152);cc(b,dg,40960,49152);cc(b,eg,40960,48128);var c=v(this.partCount,()=>[]);for(var d=0;d<this.partCount;d++){var e=c[d];const a=this.parts[d];b.segment(sg[this.banks[d]].name);for(const c of a)b.reloc(`Message_${c.mid}`),e.push(b.pc()),b.byte(...c.bytes,0)}d=[];b.segment(bg.name);b.reloc("MessagesTable");for(e=0;e<this.partCount;e++)d.push(b.pc()),b.word(...c[e]);c=b.pc();b.byte(...this.banks);b.reloc("MessageParts");
e=b.pc();b.word(...d);a(pg,c);a(qg,c);a(rg,e,5);c=[["CommonWords",this.commonWords,[kg]],["UncommonWords",this.uncommonWords,[lg]],["PersonNames",this.personNames,[mg]],["ItemNames",this.itemNames,[ng,og]]];for(const [e,g,h]of c){c=[];d=0;for(const a of g)a?(b.reloc(`${e}_${x(d++)}`),c.push(b.pc()),b.byte(a,0)):c.push(0);b.reloc(e);d=b.pc();b.word(...c);for(const b of h)a(b,d,5)}return[b.module()]}}hg.CONTINUED="#";const jg={"{":"}","[":"]"},tg=new Set("20:1d 1b:0f 1b:10 1b:11 1b:12 1b:05 1b:06 1b:07 1f:00 13:00 0b:01 20:0c 20:0f 1c:11 0e:05 16:00 16:02 16:04 16:06 20:11 21:00 21:02 21:01 06:00 18:00 18:02 18:04 18:08 1b:03 1b:00 1b:00 1b:04 06:01 10:13 19:05 20:14 20:15 20:17 20:02 20:0d 20:19 20:1a 20:1b 03:01 03:02 10:10 10:11 10:12 0c:04 0c:05 03:03 20:0e 20:13".split(" "));const ug={empty:1,pit:2,arena:4,spikes:8,wide:16,river:32,bridge:64,wall:128,ramp:256,overpass:512,underpass:1024,whirlpool:2048,deadend:4096,"stair:up":65536,"stair:down":131072,portoa1:117440512,portoa2:184549376,portoa3:218103808,lake:234881024,lighthouse:318767104,cabin:352321536,windmill:369098752,altar:419430400,pyramid:436207616,crypt:469762048,manual:1073741824,consolidate:2147483648};
function U(a){if(1!=a.length)throw Error("Bad icon input");a=a[0].split("\n");const b=a.slice(1).map(a=>a.replace(/^\s*\||\|\s*$/g,""));return{short:/\S/.test(a[0])?a[0][0]:b[1][1],full:[b[0],b[1],b[2]]}}function vg(a,...b){a=a.split(/\s+/g);a[0]||a.shift();a[a.length-1]||a.pop();if(240!==a.length)throw Error(`Bad screen definition: ${a.length}`);const c=new Map(b);return Uint8Array.from(a,a=>{var b;return null!==(b=c.get(a))&&void 0!==b?b:parseInt(a,16)})}
function wg(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:up",dir:2,entrance:(c<<12)+(14===c?10240:6144)|(d<<4)+8,exits:[a]}:{type:"stair:up",dir:0,entrance:c<<12|(d<<4)+(b<<3),exits:v(b,b=>a-16+b)}}
function xg(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:down",dir:2,entrance:(c<<12)-2048|(d<<4)+8,exits:[a],allowedExits:[a+16,a-16]}:{type:"stair:down",dir:2,entrance:c<<12|3840|(d<<4)+(b<<3),exits:v(b,b=>a+16+b),allowedExits:[...v(b,b=>a+32+b),...v(b,b=>a+b)]}}function V(a,b){b=void 0===b?"cave":b;return Object.assign({},wg(a+16),{type:b})}function W(a,b){b=void 0===b?"door":b;return Object.assign({},wg(a,1),{type:b})}
function yg(a){var {left:b=7,width:c=2,top:d=2,manual:e=!1}=void 0===a?{}:a;return{type:"edge:top",manual:e,dir:0,entrance:d+1<<12|(b<<4)+(c<<3),exits:v(c,a=>d<<4|a+b)}}function Y(a){var {left:b=7,width:c=2,shift:d=0,type:e="edge:bottom",manual:f=!1}=void 0===a?{}:a;return{type:e,manual:f,dir:2,entrance:57088|(b<<4)+(c<<3)+16*d,exits:v(c,a=>224|a+b)}}
function zg(a){var {left:b=7,width:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:bottom",dir:2,entrance:44800|(b<<4)+(c<<3)+16*d,exits:v(c,a=>176|a+b)}}function Ag(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:left",dir:1,entrance:(b<<12)+(16*d<<8)+(c<<11)|16,exits:v(c,a=>a+b<<4)}}function Bg(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:right",dir:3,entrance:(b<<12)+(16*d<<8)+(c<<11)|239,exits:v(c,a=>a+b<<4|15)}}
function Cg(a,b){return{type:"seamless:up",dir:0,get entrance(){throw Error("does not make sense");},exits:v(void 0===b?2:b,b=>a+b)}}function Dg(a,b){return{type:"seamless:down",dir:2,get entrance(){throw Error("does not make sense");},exits:v(void 0===b?2:b,b=>a+b)}};class Eg{constructor(a,b,c){var d,e,f,g,h;this.rom=a;this.uid=b;this.data=c;this._tilesets=new Set;this.used=!1;this.neighbors=[new m(a=>this._checkNeighbor(a,0)),new m(a=>this._checkNeighbor(a,1))];for(const a of Object.values(c.tilesets))a.requires||(this.used=!0);a=0;for(var l of null!==(d=c.feature)&&void 0!==d?d:[])d=ug[l],null!=d&&(a|=d);for(var q of null!==(e=c.exits)&&void 0!==e?e:[])if("stair:down"===q.type||"stair:up"===q.type)a|=ug[q.type];this._features=a;this._isEmpty=!!(a&ug.empty);
this.flag=c.flag;this.connections=c=[[[]],[[]],[[]],[[]]];for(e=0;4>e;e++){q=l=0;d=c[e][0];for(const b of null!==(f=this.data.connect)&&void 0!==f?f:"")if(Fg[e].includes(b))c[e].push(d=[]);else if(!Gg.has(b)){if("p"===b)a=240|l++;else if("x"===b)a=224|q++;else{a=parseInt(b,16);if(!a)throw Error(`bad term: '${b}'`);a=(a&3)<<(a&4)|(a&8?a&4?256:4096:0)}d.push(a)}for(;l<(null===(g=this.data.poi)||void 0===g?void 0:g.length);)d.push(240|l++);for(;q<(null===(h=this.data.exits)||void 0===h?void 0:h.length);)d.push(224|
q++)}}get features(){return this._features}get manual(){return!!(this._features&Hg)}get counted(){return!!(this._features&Ig)}hasFeature(a){return!!(this._features&ug[a])}hasFeatures(a){return(this._features&a)===a}withFeature(){throw Error();}isEmpty(){return this._isEmpty}hasStair(){return!!(this._features&(ug["stair:up"]|ug["stair:down"]))}withObstruction(){throw Error();}isCompatibleWithTileset(a){for(const b of this._tilesets)if(b.tilesetId===a)return!0;return!1}replace(a,b){const {tiles:c}=
this.screen;for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b);return this}remove(){for(const a of this.tilesets())a.deleteScreen(this)}tilesets(){const a=[];for(const b in this.data.tilesets)a.push(this.rom.metatilesets[b]);return a}setGridTile(...a){this.data.tile=a;for(const a of this.tilesets())a.invalidate()}gridTiles(){var a;let b=null!==(a=this.data.tile)&&void 0!==a?a:[];Array.isArray(b)||(b=[b]);return b.map(a=>a.replace(/\|/g,""))}get sid(){return this.data.id}set sid(a){this.sid!==a&&this.rom.metascreens.renumber(this.sid,
a)}get screen(){const {sid:a,rom:{screens:b}}=this;return 0>a?b.unallocated[~a]:b[a]}unsafeSetId(a){this.data.id=a;for(const a of this._tilesets)a.invalidate()}unsafeAddTileset(a){this._tilesets.add(a)}unsafeRemoveTileset(a){this._tilesets.delete(a)}edgeExits(){var a;let b=0;for(const c of null!==(a=this.data.exits)&&void 0!==a?a:[])a=Jg[c.type],null!=a&&(b|=1<<a);return b}edgeIndex(a){var b;let c=0;const d=null!==(b=this.data.edges)&&void 0!==b?b:"";for(b=0;4>b;b++)if(" "!==d[b]){if(d[b]!==a)return;
c|=1<<b}return c}findExitType(a,b,c){var d,e;for(const f of null!==(d=this.data.exits)&&void 0!==d?d:[])if(f.type.startsWith("seamless")===c&&(d=b&&"edge:bottom"===f.type&&192<=a?a+32:a,f.exits.includes(d)||(null!==(e=f.allowedExits)&&void 0!==e?e:[]).includes(d)))return f}findExitByType(a){const b=this.data.exits.find(b=>b.type===a);if(!b)throw Error(`no exit ${a}`);return b}findEntranceType(a,b){var c,d;for(const e of null!==(c=this.data.exits)&&void 0!==c?c:[]){if(e.type.startsWith("seamless"))continue;
c=b&&"edge:bottom"===e.type&&48896<=a?a+8192:a;const f=(c&240)>>4|(c&61440)>>8;if(e.entrance===c||e.exits.includes(f)||(null!==(d=e.allowedExits)&&void 0!==d?d:[]).includes(f))return e.type}}addCustomFlag(a){this.flag=a?"custom:true":"custom:false"}checkNeighbor(a,b){return(b&2?this:a).neighbors[b&1].get(b&2?a:this)}_checkNeighbor(a,b){const c=this.data.edges;a=a.data.edges;if(c&&a){const d=b^2;if("*"!==c[d]&&c[d]===a[b])return!0}return!1}}
const Jg={"edge:top":0,"edge:left":1,"edge:bottom":2,"edge:right":3},Fg=["|:","|:=-","|","|="],Gg=new Set(["|",":","-","="]),Kg=new Set("arena portoa1 portoa2 portoa3 lake overpass underpass lighthouse cabin windmill altar pyramid crypt".split(" ")),Lg=new Set("pit spikes bridge wall ramp whirlpool".split(" ")),Hg=[...Kg].map(a=>ug[a]).reduce((a,b)=>a|b),Ig=[...Lg].map(a=>ug[a]).reduce((a,b)=>a|b);class Mg{constructor(a){this.rom=a;this.length=0;this.screensByFix=new m(()=>[]);this.screensById=new m(()=>[]);this.overworldEmpty=this.metascreen({id:0,icon:U`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryW_trees=this.metascreen({id:1,icon:U`
      |\u2588\u258c |
      |\u2588\u258c^|
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaTrees]}},edges:"> >o"});this.boundaryW=this.metascreen({id:2,icon:U`
      |\u2588\u258c |
      |\u2588\u258c |
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"> >o"});this.boundaryE_rocks=this.metascreen({id:3,icon:U`
      |.\u2590\u2588|
      | \u2590\u2588|
      |.\u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:"<o< "});this.boundaryE=this.metascreen({id:4,icon:U`
      | \u2590\u2588|
      | \u2590\u2588|
      | \u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<o< "});this.longGrassS=this.metascreen({id:5,icon:U`
      |vv |
      | vv|
      |   |`,tile:"olo|ooo|   ",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]}},edges:"looo"});this.longGrassN=this.metascreen({id:6,icon:U`
      |   |
      | vv|
      |vv |`,tile:"   |ooo|olo",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]}},edges:"oolo"});this.boundaryS_rocks=this.metascreen({id:7,icon:U`
      | . |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:"o^ ^"});this.fortressTownEntrance=this.metascreen({id:8,icon:U`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |   |`,placement:"manual",tile:["   |oFo|ooo","oo |oFo|ooo"],tilesets:{grass:{}},edges:" vov",exits:[Object.assign({},wg(166,3),{type:"fortress"})]});this.bendSE_longGrass=this.metascreen({id:9,icon:U`\u2597
      | v |
      |vv\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.exitW_cave=this.metascreen({id:10,icon:U`\u2229
      |\u2588\u2229\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:["   |o< |   ","   |x< |   "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:" n  ",exits:[V(72),Ag({top:6})]});this.bendNE_grassRocks=this.metascreen({id:11,icon:U`\u259d
      |.\u2590\u2588|
      |  \u2580|
      |;;;|`,tile:"oo |ooo|ogo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass]},desert:{requires:[G.DesertShortGrass,G.DesertRocks]}},edges:"<osv"});this.cornerNW=this.metascreen({id:12,icon:U`\u259b
      |\u2588\u2588\u2588|
      |\u2588 \u2580|
      |\u2588\u258c |`,tile:"   | oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"  >v"});this.overworldEmpty_alt=this.metascreen({id:12,icon:U`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,placement:"manual",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty","manual"],edges:"    ",match:()=>!1,delete:!0});this.cornerNE=this.metascreen({id:13,icon:U`\u259c
      |\u2588\u2588\u2588|
      |\u2580\u2588\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:" v< "});this.cornerSW=this.metascreen({id:14,icon:U`\u2599
      |\u2588\u258c |
      |\u2588\u2588\u2584|
      |\u2588\u2588\u2588|`,tile:" oo| oo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">  ^"});this.cornerSE=this.metascreen({id:15,icon:U`\u259f
      | \u2590\u2588|
      |\u2584\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |oo |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  "});this.exitE=this.metascreen({id:16,icon:U`\u2576
      | \u2590\u2588|
      |   |
      | \u2590\u2588|`,tile:["oo |ooo|oo ","oo |oox|oo "],tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]}},edges:"<o<n",exits:[Bg({top:6})]});this.boundaryN_trees=this.metascreen({id:17,icon:U`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      | ^ |`,tile:"   |ooo|ooo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaTrees]}},edges:" vov"});this.bridgeToPortoa=this.metascreen({id:18,icon:U`\u2574
      |\u2550  |
      |\u255e\u2550\u2550|
      |\u2502  |`,placement:"manual",tile:"roo|1rr| oo",tilesets:{river:{}},feature:["portoa3"],edges:"2*>r",exits:[Ag({top:1})]});this.slopeAbovePortoa=this.metascreen({id:19,icon:U`
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2580|
      |\u2502  |`,placement:"manual",tile:" \u2193 | oo|roo",tilesets:{river:{}},feature:["portoa2"],edges:"1*2v"});this.riverBendSE=this.metascreen({id:20,icon:U`
      |w  |
      | \u2554\u2550|
      | \u2551 |`,tile:"ooo|orr|oro",tilesets:{river:{}},edges:"oorr"});this.boundaryW_cave=this.metascreen({id:21,icon:U`
      |\u2588\u258c |
      |\u2588\u2229 |
      |\u2588\u258c |`,tile:" oo| <o| oo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"> >o",exits:[V(137)]});this.exitN=this.metascreen({id:22,icon:U`\u2575
      |\u2588 \u2588|
      |\u2580 \u2580|
      | ^ |`,tile:[" o |ooo|ooo"," x |ooo|ooo"],tilesets:{grass:{},river:{},desert:{}},edges:"nvov",exits:[yg()]});this.riverWE_woodenBridge=this.metascreen({id:23,icon:U`\u2550
      |   |
      |\u2550\u2551\u2550|
      |   |`,tile:"ooo|ror|ooo",tilesets:{river:{}},edges:"oror",exits:[Cg(119),Dg(135)]});this.riverBoundaryE_waterfall=this.metascreen({id:24,icon:U`\u2561
      | \u2590\u2588|
      |\u2550\u2550/|
      | \u2590\u2588|`,tile:"oo |rr |oo ",tilesets:{river:{}},edges:"<r< "});this.boundaryE_cave=this.metascreen({id:25,icon:U`
      | \u2590\u2588|
      |v\u2229\u2588|
      |v\u2590\u2588|`,tile:"oo |o< |oo ",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]},desert:{requires:[G.DesertLongGrass]}},edges:"<o< ",exits:[V(88)]});this.exitW_southwest=this.metascreen({id:26,icon:U`\u2574
      |\u2588\u258c |
      |\u2580 \u2584|
      |\u2584\u2588\u2588|`,tile:" oo|Boo|   ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:">* ^",exits:[Ag({top:11})]});this.nadare=this.metascreen({id:27,tilesets:{house:{}},exits:[zg(),W(35),W(37,"door2"),W(42,"door3")]});this.townExitW=this.metascreen({id:28,icon:U`\u2574
      |\u2588\u258c |
      |\u2580 ^|
      |\u2588\u258c |`,tile:" oo|8oo| oo",tilesets:{grass:{},river:{}},edges:">n>o",exits:[Ag({top:8,height:3,shift:-.5})]});this.shortGrassS=this.metascreen({id:29,icon:U` |
      |;;;|
      | v |
      |   |`,tile:"ogo|ooo|ooo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass,G.GrassLongGrassRemapping]}},edges:"sooo"});this.townExitS=this.metascreen({id:30,icon:U`\u2577
      | ^ |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x "],tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks,G.DesertTownEntrance]}},edges:"o^n^",exits:[Y()]});this.swanGate=this.metascreen({id:31,tilesets:{town:{}},exits:[Ag({top:3}),Bg({top:9})],flag:"custom:false"});this.riverBranchNSE=this.metascreen({id:32,icon:U`
      | \u2551 |
      | \u2560\u2550|
      | \u2551 |`,tile:"oro|orr|oro",tilesets:{river:{}},edges:"rorr"});this.riverWE=this.metascreen({id:33,icon:U`
      |   |
      |\u2550\u2550\u2550|
      |   |`,tile:"ooo|rrr|ooo",tilesets:{river:{}},edges:"oror"});this.riverBoundaryS_waterfall=this.metascreen({id:34,icon:U`\u2568
      | \u2551 |
      |\u2584\u2551\u2584|
      |\u2588/\u2588|`,tile:"oro|oro|   ",tilesets:{river:{}},edges:"r^ ^"});this.shortGrassSE=this.metascreen({id:35,icon:U`
      |;;;|
      |;  |
      |; ^|`,tile:"ogo|goo|ooo",tilesets:{grass:{}},edges:"ssoo"});this.shortGrassNE=this.metascreen({id:36,icon:U` |
      |;  |
      |;v |
      |;;;|`,tile:"ooo|goo|ogo",tilesets:{grass:{}},edges:"osso"});this.stomHouseOutside=this.metascreen({id:37,icon:U`\u2229
      |\u2588\u2588\u2588|
      |\u258c\u2229\u2590|
      |\u2588 \u2588|`,placement:"manual",tile:["   | H | o ","   | H | x "],tilesets:{grass:{}},exits:[W(104),Y({shift:.5})]});this.bendNW_trees=this.metascreen({id:38,icon:U`\u2598
      |\u2588\u258c |
      |\u2580 ^|
      | ^^|`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks,G.DesertTrees]},sea:{requires:[G.SeaRocks,G.SeaTrees]}},edges:">voo"});this.shortGrassSW=this.metascreen({id:39,icon:U`
      |;;;|
      |  ;|
      |^ ;|`,tile:"ogo|oog|ooo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass]}},edges:"soos"});this.riverBranchNWS=this.metascreen({id:40,icon:U`
      | \u2551 |
      |\u2550\u2563 |
      | \u2551 |`,tile:"oro|rro|oro",tilesets:{river:{}},edges:"rrro"});this.shortGrassNW=this.metascreen({id:41,icon:U`
      |  ;|
      | v;|
      |;;;|`,tile:"ooo|oog|ogo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass,G.GrassLongGrassRemapping]}},edges:"ooss"});this.valleyBridge=this.metascreen({id:42,icon:U` |
      |\u259b\u2551\u259c|
      | \u2551 |
      |\u2599\u2551\u259f|`,tile:[" o | o | o "," x | o | o "," o | o | x "],tilesets:{grass:{},river:{}},edges:"n n ",exits:[Cg(119),Dg(135),yg(),Y()]});this.exitS_cave=this.metascreen({id:43,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588 \u2588|`,tile:["   | < | o ","   | < | x "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"  n ",exits:[V(103),Y()]});this.outsideWindmill=this.metascreen({id:44,icon:U`\u2573
      |\u2588\u2588\u2573|
      |\u2588\u2229\u2588|
      |\u2588 \u2588|`,placement:"manual",tile:["   | W | o ","   | W | x "],tilesets:{grass:{}},flag:"custom:false",feature:["windmill"],edges:"  n ",exits:[V(99),Y(),W(137,"windmill"),W(140)]});this.townExitW_cave=this.metascreen({id:45,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u2584\u2584\u2588|
      |\u2588\u2588\u2588|`,tile:"   |x< |   ",tilesets:{grass:{}},edges:" n  ",exits:[V(74),Ag({top:5,height:3,shift:-.5})],flag:"custom:true"});this.riverNS=this.metascreen({id:46,icon:U`
      | \u2551 |
      | \u2551 |
      | \u2551 |`,tile:"oro|ooo|oro",tilesets:{river:{}},edges:"roro",mod:"bridge"});this.riverNS_bridge=this.metascreen({id:47,icon:U`
      | \u2551 |
      |w\u254fw|
      | \u2551 |`,placement:"mod",tile:"oro|oro|oro",tilesets:{river:{}},feature:["bridge"],edges:"roro",wall:119});this.riverBendWS=this.metascreen({id:48,icon:U`
      | w\u259c|
      |\u2550\u2557w|
      | \u2551 |`,tile:"oo |rro|oro",tilesets:{river:{}},edges:"<rrv"});this.boundaryN_waterfallCave=this.metascreen({id:49,icon:U`
      |\u259b/\u2588|
      |\u2598\u2551\u2580|
      | \u2551 |`,tile:"   |oro|oro",tilesets:{river:{}},edges:" vrv",exits:[{type:"cave",dir:0,entrance:28767,exits:[102,118]}]});this.open_trees=this.metascreen({id:50,icon:U`
      | ^ |
      |^ ^|
      | ^ |`,tile:"ooo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertTrees,G.DesertRocks]}},edges:"oooo"});this.exitS=this.metascreen({id:51,icon:U`\u2577
      | w |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x |"],tilesets:{grass:{},river:{},desert:{requires:[G.DesertMarsh]},sea:{requires:[G.SeaMarsh]}},edges:"o^n^",exits:[Y()]});this.bendNW=this.metascreen({id:52,icon:U`\u2598
      |\u2588\u258c |
      |\u2580\u2580 |
      |   |`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">voo"});this.bendNE=this.metascreen({id:53,icon:U`\u259d
      | \u2590\u2588|
      |  \u2580|
      |   |`,tile:"oo |ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<oov"});this.bendSE=this.metascreen({id:54,icon:U`\u2597
      |   |
      | \u2584\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.bendWS=this.metascreen({id:55,icon:U`\u2596
      |   |
      |\u2584\u2584 |
      |\u2588\u258c |`,tile:"ooo|ooo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^>o"});this.towerPlain_upStair=this.metascreen({id:56,icon:U`\u2534
      | \u250a |
      |\u2500\u2534\u2500|
      |   |`,tile:" t |ttt|   ",tilesets:{tower:{}},edges:"st t",exits:[yg({left:8})]});this.towerRobotDoor_downStair=this.metascreen({id:57,icon:U`\u252c
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u250a |`,tile:"   |ttt| t ",tilesets:{tower:{}},edges:" tst",exits:[Cg(232,2),Dg(248,2)]});this.towerDynaDoor=this.metascreen({id:58,icon:U`\u2229
      | \u2229 |
      |\u2514\u252c\u2518|
      | \u250a |`,tile:"   | < | t ",tilesets:{tower:{}},edges:"  s ",exits:[V(103,"door")]});this.towerLongStairs=this.metascreen({id:59,icon:U`
      | \u250a |
      | \u250a |
      | \u250a |`,tile:" t | t | t ",tilesets:{tower:{}},edges:"s s ",exits:[Y()]});this.towerMesiaRoom=this.metascreen({id:60,tilesets:{tower:{}},exits:[zg()]});this.towerTeleporter=this.metascreen({id:61,tilesets:{tower:{}},exits:[zg(),V(87,"teleporter")]});this.caveAbovePortoa=this.metascreen({id:62,icon:U`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |\u2588\u2193\u2588|`,placement:"manual",tile:"   | < | \u2193 ",tilesets:{river:{}},edges:"  1 ",feature:["portoa1"],exits:[V(102)]});this.cornerNE_flowers=this.metascreen({id:63,icon:U`\u259c
      |\u2588\u2588\u2588|
      |\u2580*\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{}},edges:" v< "});this.towerEdge=this.metascreen({id:64,icon:U` |
      |   |
      |\u2524 \u251c|
      |   |`,tile:"   |t t|   ",tilesets:{tower:{}},edges:" t t"});this.towerEdgeW=this.metascreen({id:64,icon:U` |
      |   |
      |\u2524  |
      |   |`,tile:"   |t  |   ",tilesets:{tower:{}},edges:" t  "});this.towerEdgeE=this.metascreen({id:64,icon:U` |
      |   |
      |  \u251c|
      |   |`,tile:"   |  t|   ",tilesets:{tower:{}},edges:"   t"});this.towerRobotDoor=this.metascreen({id:65,icon:U`\u2500
      | O |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ttt|   ",tilesets:{tower:{}},edges:" t t"});this.towerDoor=this.metascreen({id:66,icon:U`\u2229
      | \u2229 |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |t<t|   ",tilesets:{tower:{}},edges:" t t",exits:[V(88)]});this.house_bedroom=this.metascreen({id:67,tilesets:{house:{}},exits:[zg()]});this.shed=this.metascreen({id:68,tilesets:{house:{}},exits:[zg(),V(73)],flag:"custom:false"});this.tavern=this.metascreen({id:69,tilesets:{house:{}},exits:[zg()]});this.house_twoBeds=this.metascreen({id:70,tilesets:{house:{}},exits:[zg()]});this.throneRoom_amazones=this.metascreen({id:71,tilesets:{house:{}},exits:[zg({width:3}),xg(76,1)]});this.house_ruinedUpstairs=
this.metascreen({id:72,tilesets:{house:{}},exits:[zg(),xg(156,1)]});this.house_ruinedDownstairs=this.metascreen({id:73,tilesets:{house:{}},exits:[wg(86,1)]});this.foyer=this.metascreen({id:74,tilesets:{house:{}},exits:[zg({shift:.5}),W(40),W(83,"door2"),W(92,"door3")]});this.throneRoom_portoa=this.metascreen({id:75,tilesets:{house:{}},exits:[zg(),W(43)]});this.fortuneTeller=this.metascreen({id:76,tilesets:{house:{}},exits:[zg(),W(86),W(89,"door2")]});this.backRoom=this.metascreen({id:77,tilesets:{house:{}},
exits:[zg()]});this.dojo=this.metascreen({id:78,tilesets:{house:{}},exits:[zg({shift:-.5})]});this.windmillInside=this.metascreen({id:79,tilesets:{house:{}},exits:[zg({left:9,width:1})]});this.horizontalTownMiddle=this.metascreen({id:80,tilesets:{town:{}},exits:[W(76),W(85,"door2")]});this.brynmaerRight_exitE=this.metascreen({id:81,tilesets:{town:{type:"horizontal"}},exits:[Bg({top:8}),W(65)]});this.brynmaerLeft_deadEnd=this.metascreen({id:82,tilesets:{town:{type:"horizontal"}},exits:[W(73),W(76,
"door2")]});this.swanLeft_exitW=this.metascreen({id:83,tilesets:{town:{type:"horizontal"}},exits:[Ag({top:9}),W(73),W(94,"door2")]});this.swanRight_exitS=this.metascreen({id:84,tilesets:{town:{type:"horizontal"}},exits:[Y({left:3}),W(65),W(67,"door2"),W(87,"door3")]});this.horizontalTownLeft_exitN=this.metascreen({id:85,tilesets:{town:{type:"horizontal"}},exits:[yg({left:13}),W(70),W(75,"door2")]});this.amazonesRight_deadEnd=this.metascreen({id:86,tilesets:{town:{type:"horizontal"}},exits:[W(64),
W(88,"door2")]});this.saharaRight_exitE=this.metascreen({id:87,tilesets:{town:{type:"horizontal"}},exits:[Bg({top:7}),W(64),W(102,"door2")]});this.portoaNW=this.metascreen({id:88,tilesets:{town:{type:"square"}},exits:[V(71,"fortress"),Y()]});this.portoaNE=this.metascreen({id:89,tilesets:{town:{type:"square"}},exits:[W(99),W(138,"door2"),Y({left:3,width:4})]});this.portoaSW_exitW=this.metascreen({id:90,tilesets:{town:{type:"square"}},exits:[Ag({top:9}),W(134),yg()]});this.portoaSE_exitE=this.metascreen({id:91,
tilesets:{town:{type:"square"}},exits:[Bg({top:9}),W(122),W(135,"door2")]});this.dyna=this.metascreen({id:92,tilesets:{tower:{}},exits:[{type:"stair:down",manual:!0,dir:2,entrance:49024,exits:[]}]});this.portoaFisherman=this.metascreen({id:93,tilesets:{town:{type:"square"}},exits:[Bg({top:6}),Ag({top:4,height:6,shift:.5}),W(104)]});this.verticalTownTop_fortress=this.metascreen({id:94,tilesets:{town:{type:"vertical"}},exits:[V(71),Y()]});this.shyronMiddle=this.metascreen({id:95,tilesets:{town:{type:"vertical"}},
exits:[W(84),W(91,"door2"),yg()]});this.shyronBottom_exitS=this.metascreen({id:96,tilesets:{town:{type:"vertical"}},exits:[Y({left:3}),W(4),W(6,"door2"),W(153,"door3")]});this.zombieTownMiddle=this.metascreen({id:97,tilesets:{town:{type:"vertical"}},exits:[W(153),yg()]});this.zombieTownBottom_caveExit=this.metascreen({id:98,tilesets:{town:{type:"vertical"}},exits:[V(146),W(35),W(77,"door2")]});this.leafNW_houseShed=this.metascreen({id:99,tilesets:{town:{type:"square"}},exits:[W(140),W(149,"door2")]});
this.squareTownNE_house=this.metascreen({id:100,tilesets:{town:{type:"square"}},exits:[yg({left:1}),W(183)]});this.leafSW_shops=this.metascreen({id:101,tilesets:{town:{type:"square"}},exits:[W(119),W(138,"door2")]});this.leafSE_exitE=this.metascreen({id:102,tilesets:{town:{type:"square"}},exits:[Bg({top:3,height:3,shift:-.5}),W(132)]});this.goaNW_tavern=this.metascreen({id:103,tilesets:{town:{type:"square"}},exits:[W(186)]});this.squareTownSW_exitS=this.metascreen({id:104,tilesets:{town:{type:"square"}},
exits:[Y({left:8}),W(132)]});this.goaSE_shop=this.metascreen({id:105,tilesets:{town:{type:"square"}},exits:[W(130)]});this.joelNE_shop=this.metascreen({id:106,tilesets:{town:{type:"square"}},exits:[W(167)]});this.joelSE_lake=this.metascreen({id:107,tilesets:{town:{type:"square"}}});this.oakNW=this.metascreen({id:108,tilesets:{town:{type:"square"}},exits:[W(231)]});this.oakNE=this.metascreen({id:109,tilesets:{town:{type:"square"}},exits:[W(96)]});this.oakSW=this.metascreen({id:110,tilesets:{town:{type:"square"}},
exits:[W(124)]});this.oakSE=this.metascreen({id:111,tilesets:{town:{type:"square"}},exits:[Y({left:0,shift:.5}),W(151)]});this.temple=this.metascreen({id:112,tilesets:{house:{}},exits:[zg()]});this.wideDeadEndN=this.metascreen({id:113,icon:U`
      | \u2503 |
      | > |
      |   |`,tile:" w | > |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",exits:[xg(199)],statues:[4]});this.goaWideDeadEndN=this.metascreen({id:113,icon:U`
      |\u2575\u2503\u2575|
      | > |
      |   |`,tile:" w | > |   ",tilesets:{labyrinth:{}},edges:"w   ",connect:"1|2x|3",exits:[xg(199)],statues:[4]});this.wideHallNS=this.metascreen({id:114,icon:U`
      | \u2503 |
      | \u2503 |
      | \u2503 |`,tile:" w | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2a",statues:[1,7,13]});this.goaWideHallNS=this.metascreen({id:114,icon:U`
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|`,tile:" w | w | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"19|2a|3b",statues:[1,7,13]});this.goaWideHallNS_blockedRight=this.metascreen({id:114,icon:U`
      |\u2502\u2503\u2502|
      |\u2502\u2503 |
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[157]}},edges:"w w ",connect:"19|2a|3|b"});this.goaWideHallNS_blockedLeft=this.metascreen({id:114,icon:U`
      |\u2502\u2503\u2502|
      | \u2503\u2502|
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[81]}},edges:"w w ",connect:"1|9|2a|3b"});this.goaWideArena=this.metascreen({id:115,icon:U`<
      |\u257b<\u257b|
      |\u2521\u2501\u2529|
      |\u2502\u257b\u2502|`,placement:"manual",tile:"   | < | w ",tilesets:{labyrinth:{}},feature:["arena"],edges:"w w ",connect:"9b|a",exits:[wg(55)]});this.limeTreeLake=this.metascreen({id:116,tilesets:{lime:{}},exits:[zg(),V(71)],feature:["bridge"],wall:103});this.swampNW=this.metascreen({id:117,icon:U`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss  ",connect:"26",exits:[yg({left:6,width:4}),Ag({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampE=this.metascreen({id:118,icon:U`
      |   |
      | \u2576\u2500|
      |   |`,tile:"   | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"   s",connect:"e",exits:[],poi:[[0]]});this.swampE_door=this.metascreen({id:118,icon:U`\u2229
      | \u2229 |
      | \u2576\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"   s",connect:"e",exits:[V(92,"swamp")]});this.swampNWSE=this.metascreen({id:119,icon:U`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ssss",connect:"26ae",exits:[yg({left:6,width:4}),Ag({top:7,height:4,shift:-.5}),Y({left:6,width:4}),Bg({top:7,height:4,shift:-.5})]});this.swampNWS=this.metascreen({id:120,icon:U`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"sss ",connect:"26a",exits:[yg({left:6,width:4}),Ag({top:7,height:4,shift:-.5}),Y({left:6,width:4})]});this.swampNE=this.metascreen({id:121,icon:U`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s  s",connect:"2e",exits:[yg({left:6,width:4}),Bg({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampWSE=this.metascreen({id:122,icon:U`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" sss",connect:"6ae",exits:[Ag({top:7,height:4,shift:-.5}),Y({left:6,width:4}),Bg({top:7,height:4,shift:-.5})]});this.swampWSE_door=this.metascreen({id:122,icon:U`\u2229
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |c<c| c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" sss",connect:"6ae",exits:[V(86,"swamp")]});this.swampW=this.metascreen({id:123,icon:U`
      |   |
      |\u2500\u2574 |
      |   |`,tile:"   |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s  ",connect:"6",poi:[[0]]});this.swampW_door=this.metascreen({id:123,icon:U`\u2229
      | \u2229 |
      |\u2500\u2574 |
      |   |`,tile:"   |c< |   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s  ",connect:"6",exits:[V(84,"swamp")]});this.swampArena=this.metascreen({id:124,icon:U`
      |   |
      |\u2517\u252f\u251b|
      | \u2502 |`,tile:"   | a | c ",tilesets:{swamp:{}},feature:["arena"],edges:"  s ",connect:"a"});this.swampNWE=this.metascreen({id:125,icon:U`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss s",connect:"26e",exits:[yg({left:6,width:4}),Ag({top:7,height:4}),Bg({top:7,height:4})]});this.swampWS=this.metascreen({id:126,icon:U`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],update:[[G.SwampDoors,(a,c,d)=>{d.metascreens.swampWS_door.flag="always";return!0}]],edges:" ss ",connect:"6a",exits:[Ag({top:7,height:4}),Y({left:6,width:4})],poi:[[2]]});this.swampWS_door=this.metascreen({id:126,icon:U`\u2229
      | \u2229 |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |c< | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" ss ",connect:"6a",exits:[V(87,"swamp")]});this.swampEmpty=this.metascreen({id:127,icon:U`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{swamp:{}},feature:["empty"],edges:"    ",connect:"",delete:!0});this.swampN=this.metascreen({id:-113,icon:U`
      | \u2502 |
      | \u2575 |
      |   |`,tile:" c | c |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s   ",connect:"2",poi:[[0]],definition:vg(".  .  .  .  cf f6 c7 ad c4 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b9 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b8 ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad b9 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad ad d2 e2 .  .  .  .\n         .  .  .  .  e3 f6 c3 c3 b8 b6 d2 .  .  .  .  .\n         .  .  .  .  .  e3 fd ad ad fc e2 .  .  .  .  .\n         .  .  .  .  .  .  ff fb fb fa .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200])});this.swampS=this.metascreen({id:-114,icon:U`
      |   |
      | \u2577 |
      | \u2502 |`,tile:"   | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  s ",connect:"a",poi:[[0]],definition:vg(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 ca .  .  .  .  .  .\n         .  .  .  .  .  cd eb a0 a0 cb ca .  .  .  .  .\n         .  .  .  .  cf a0 f9 f5 f7 f8 cb cc .  .  .  .\n         .  .  .  .  cf a0 ed 08 09 a0 a0 cc .  .  .  .\n         .  .  .  .  cf db ee 0c 0b ef a0 cc .  .  .  .\n         .  .  .  .  cf d0 d1 03 03 d8 db cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad ad ae d2 cc .  .  .  .\n         .  .  .  .  cf d3 ad b9 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c5 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .",
[".",200])});this.swampNS=this.metascreen({id:-115,icon:U`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s s ",connect:"2a",exits:[yg({left:6,width:4}),Y({left:6,width:4})],definition:vg(".  .  .  .  cf d3 b6 b6 c6 b6 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c3 c7 b6 f6 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c7 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b6 c6 c5 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c6 c3 c7 d2 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 ad c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 c4 c5 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f5 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 c2 b8 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 c7 b6 d2 cc .  .  .  .",
[".",200])});this.swampWE=this.metascreen({id:-116,icon:U`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s s",connect:"6e",exits:[Ag({top:7,height:4,shift:-.5}),Bg({top:7,height:4,shift:-.5})],definition:vg(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9\n         a0 e4 e8 eb e4 a0 a0 a0 eb eb e8 f0 f1 a0 e4 a0\n         a0 e5 e9 f9 f5 f6 f6 f7 ec f9 f7 f8 f2 a0 e5 a0\n         a0 e6 f0 f1 e6 e0 08 09 ed de ea de f2 a0 e6 a0\n         db e7 db f3 e7 e1 0c 0b dd df e0 df f3 db e7 e0\n         d0 d1 da da d0 d1 03 03 d0 d1 d0 d1 da da da da\n         ad c4 ad ad ad ad ad ad ad ad ad ad ad ad ad ad\n         c2 c5 b8 c6 c4 c4 b9 c7 c4 c5 c5 c7 ad ad ad ad\n         ad ad ad ad c2 c3 c3 c3 c3 c3 c7 ad ad ad ad ad\n         fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200])});this.swampWE_door=this.metascreen({id:-116,icon:U`\u2229
      | \u2229 |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s s",connect:"6e",exits:[V(86,"swamp")]});this.swampSE=this.metascreen({id:-117,icon:U`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  ss",connect:"ae",exits:[Bg({top:7,height:4,shift:-.5}),Y({left:6,width:4})],poi:[[2]],definition:vg(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 c9 c9 c9 c9 c9 c9 c9\n         .  .  .  .  .  cd a0 a0 a0 e8 04 a0 e8 a0 a0 e4\n         .  .  .  .  cf f8 a0 f0 f1 f5 f5 f7 e9 f4 f7 e5\n         .  .  .  .  cf f6 f7 f8 f2 ea 06 aa e9 f0 f1 e6\n         .  .  .  .  cf a0 dd e0 f3 e0 07 0c ea db f3 e7\n         .  .  .  .  cf db d5 d0 d1 d1 03 03 d0 d1 da da\n         .  .  .  .  cf d5 af c4 c4 ad ad ad ad ad c4 ad\n         .  .  .  .  cf d3 b9 c3 c3 b8 ad ad ad c2 b7 b8\n         .  .  .  .  cf f6 c3 c3 c3 c3 b8 ad ad ad ad ad\n         .  .  .  .  cf f6 c7 ad c2 c3 c7 fc fb fb fb fb\n         .  .  .  .  cf d3 ad ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad b9 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad b9 c7 d2 cc .  .  .  . \n         .  .  .  .  cf d3 b6 b9 c3 b8 d2 cc .  .  .  .",
[".",200])});this.swampSE_door=this.metascreen({id:-117,icon:U`\u2229
      | \u2229 |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | <c| c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"  ss",connect:"ae",exits:[V(90,"swamp")]});this.swampNSE=this.metascreen({id:-118,icon:U`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s ss",connect:"2ae",exits:[yg({left:6,width:4}),Y({left:6,width:4}),Bg({top:7,height:4,shift:-.5})],definition:vg(".  .  .  .  cf d3 c4 c3 c3 c3 f7 f8 ca .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f7 f7 a0 ca c9 c9\n         .  .  .  .  cf f6 c3 c3 b8 b6 d2 f7 f8 e8 e4 a0\n         .  .  .  .  cf f5 b7 c3 b7 b8 d2 f0 f1 e9 e5 de\n         .  .  .  .  cf d3 c2 b8 c2 b8 d8 db f2 ea e6 df\n         .  .  .  .  cf d3 ad ad ad ad ae d4 f3 dd e7 df\n         .  .  .  .  cf d3 ad ad ad ad ad ae d0 d1 d0 d1\n         .  .  .  .  cf d3 c2 c3 c3 b7 b8 ad ad ad ad ad\n         .  .  .  .  cf d3 ad ad c2 b7 b7 b7 b8 c4 ad ad\n         .  .  .  .  cf d3 ad ad b6 b9 b7 b7 b7 b7 b8 ad\n         .  .  .  .  cf d3 ad c4 c3 b7 b8 fc fb fb fb fb\n         .  .  .  .  cf d3 b6 ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c4 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b9 b7 b7 f6 cc .  .  .  .",
[".",200])});this.caveEmpty=this.metascreen({id:128,icon:U`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{cave:{},fortress:{},labyrinth:{},pyramid:{},iceCave:{},dolphinCave:{}},feature:["empty"],edges:"    ",delete:!0});this.open=this.metascreen({id:128,icon:U`
      |   |
      |   |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{},sea:{}},edges:"oooo"});this.hallNS=this.metascreen({id:129,icon:U`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",connect:"2a",poi:[[4]],exits:[Y({left:6,width:4,manual:!0})]});this.hallNS_unreachable=this.metascreen({id:129,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE=this.metascreen({id:130,icon:U`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",poi:[[4]]});this.hallWE_unreachable=this.metascreen({id:130,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallSE=this.metascreen({id:131,icon:U`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"  cc",connect:"ae",poi:[[2]]});this.hallSE_unreachable=this.metascreen({id:131,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWS=this.metascreen({id:132,icon:U`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" cc ",connect:"6a",poi:[[2]]});this.hallWS_unreachable=this.metascreen({id:132,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNE=this.metascreen({id:133,icon:U`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c  c",connect:"2e",poi:[[2]]});this.hallNE_unreachable=this.metascreen({id:133,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNW=this.metascreen({id:134,icon:U`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc  ",connect:"26",poi:[[2]]});this.hallNW_unreachable=this.metascreen({id:134,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNSE=this.metascreen({id:135,icon:U`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c cc",connect:"2ae",poi:[[3]]});this.branchNSE_unreachable=this.metascreen({id:135,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWSE=this.metascreen({id:136,icon:U`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cccc",connect:"26ae",poi:[[3]]});this.branchNWSE_unreachable=this.metascreen({id:136,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWS=this.metascreen({id:137,icon:U`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"ccc ",connect:"26a",poi:[[3]]});this.branchNWS_unreachable=this.metascreen({id:137,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchWSE=this.metascreen({id:138,icon:U`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" ccc",connect:"6ae",poi:[[3]]});this.branchWSE_unreachable=this.metascreen({id:138,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE=this.metascreen({id:139,icon:U`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc c",connect:"26e",poi:[[3]]});this.branchNWE_unreachable=this.metascreen({id:139,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_ramp=this.metascreen({id:140,icon:U`
      | \u250b |
      | \u250b |
      | \u250b |`,tile:" c | / | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["ramp"],edges:"c c ",connect:"2a"});this.hallNS_ramp_unreachable=this.metascreen({id:140,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_overBridge=this.metascreen({id:141,icon:U`
      | \u257d |
      |\u2500\u2503\u2500|
      | \u257f |`,tile:" c | b | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["overpass"],edges:"cbcb",connect:"2a"});this.hallWE_underBridge=this.metascreen({id:142,icon:U`
      | \u257d |
      |\u2500\u2500\u2500|
      | \u257f |`,tile:"   |cbc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["underpass"],edges:"bcbc",connect:"6e"});this.hallNS_wall=this.metascreen({id:143,icon:U`
      | \u2502 |
      | \u2506 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",feature:["wall"],connect:"2=a",wall:135,mod:"wall"});this.hallNS_wall_unreachable=this.metascreen({id:143,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE_wall=this.metascreen({id:144,icon:U`
      |   |
      |\u2500\u2504\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},iceCave:{}},feature:["wall"],edges:" c c",connect:"6=e",wall:103,mod:"wall"});this.hallWE_wall_unreachable=this.metascreen({id:144,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arena=this.metascreen({id:145,icon:U`
      |\u250c\u2538\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,tile:[" n | a | c "," n | a | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena"],edges:"c c ",connect:"2a",poi:[[1,96,120]],exits:[yg(),Y({left:6,width:4,manual:!0}),Cg(230,4),Dg(246,4)],arena:1});this.hallNS_arena_unreachable=this.metascreen({id:145,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arenaWall=this.metascreen({id:146,
icon:U`
      |\u250c\u2504\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,placement:"manual",tile:[" n | a | c "],tilesets:{cave:{},iceCave:{}},feature:["arena","wall"],edges:"n c ",connect:"2x=apx",wall:39,mod:"wall",poi:[[1,96,120]],exits:[yg({top:1}),Y({left:6,width:4,manual:!0})],arena:1});this.branchNWE_wall=this.metascreen({id:148,icon:U`
      | \u2506 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wall"],edges:"cc c",connect:"2x=6e",exits:[yg({left:6,width:4})],mod:"wall",wall:55});this.branchNWE_wall_unreachable=this.metascreen({id:148,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE_upStair=this.metascreen({id:149,icon:U`<
      | < |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",exits:[wg(71)]});this.branchNWE_upStair_unreachable=this.metascreen({id:149,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.deadEndW_upStair=this.metascreen({id:150,icon:U`<
      | < |
      |\u2500\u2518 |
      |   |`,tile:"   |c< |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[wg(66)]});this.deadEndW_upStair_unreachable=this.metascreen({id:150,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndW_downStair=this.metascreen({id:151,icon:U`>
      |   |
      |\u2500\u2510 |
      | > |`,tile:"   |c> |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[xg(162)]});this.deadEndW_downStair_unreachable=this.metascreen({id:151,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndE_upStair=this.metascreen({id:152,icon:U`<
      | < |
      | \u2514\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[wg(76)]});this.deadEndE_upStair_unreachable=this.metascreen({id:152,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndE_downStair=this.metascreen({id:153,icon:U`>
      |   |
      | \u250c\u2500|
      | > |`,tile:"   | >c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[xg(172)]});this.deadEndE_downStair_unreachable=this.metascreen({id:153,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndNS_stairs=this.metascreen({id:154,icon:U`
      | > |
      |   |
      | < |`,placement:"manual",tile:" > |   | < ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2x|ax",exits:[xg(23),wg(215)],match:a=>a(264,120)&&a(-48,120)});this.deadEndNS_stairs_unreachable=this.metascreen({id:154,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(264,120)&&!a(-48,120),delete:!0});this.deadEndN_stairs=this.metascreen({id:154,icon:U`
      | > |
      |   |
      |   |`,tile:[" c | > |   "," > |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",exits:[xg(23)],match:a=>!a(264,120)&&a(-48,120)});this.deadEndS_stairs=this.metascreen({id:154,icon:U`
      |   |
      |   |
      | < |`,tile:["   | < | c ","   |   | < "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",exits:[wg(215)],match:a=>!a(-48,120)&&a(264,120)});this.deadEndNS=this.metascreen({id:155,icon:U`
      | \u2575 |
      |   |
      | \u2577 |`,placement:"manual",tile:" c |   | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c c ",connect:"2p|ap",poi:[[0,-48,120],[0,272,120]],match:a=>a(-48,120)&&a(272,120)});this.deadEndNS_unreachable=this.metascreen({id:155,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(-48,120)&&!a(272,120),delete:!0});this.deadEndN=this.metascreen({id:155,icon:U`
      | \u2575 |
      |   |
      |   |`,tile:[" c | c |   "," c |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c   ",connect:"2",poi:[[0,-48,120]],match:a=>!a(272,120)&&a(-48,120)});this.deadEndS=this.metascreen({id:155,icon:U`
      |   |
      |   |
      | \u2577 |`,tile:["   | c | c ","   |   | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"  c ",connect:"a",poi:[[0,272,120]],match:a=>!a(-48,120)&&a(272,120)});this.deadEndWE=this.metascreen({id:156,icon:U`
      |   |
      |\u2574 \u2576|
      |   |`,placement:"manual",tile:"   |c c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c c",connect:"6p|ep",poi:[[0,112,-40],[0,112,264]],match:a=>a(112,-40)&&a(112,264)});this.deadEndWE_unreachable=this.metascreen({id:156,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(112,-40)&&!a(112,264),delete:!0});this.deadEndW=this.metascreen({id:156,icon:U`
      |   |
      |\u2574  |
      |   |`,tile:["   |cc |   ","   |c  |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c  ",connect:"6",poi:[[0,112,-40]],match:a=>!a(112,264)&&a(112,-40)});this.deadEndE=this.metascreen({id:156,icon:U`
      |   |
      |  \u2576|
      |   |`,tile:["   | cc|   ","   |  c|   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"   c",connect:"e",poi:[[0,112,264]],match:a=>!a(112,-40)&&a(112,264)});this.hallNS_entrance=this.metascreen({id:158,icon:U`\u257d
      | \u2502 |
      | \u2502 |
      | \u257d |`,tile:" c | c | n ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c n ",connect:"2a",exits:[Y()]});this.hallNS_entrance_unreachable=this.metascreen({id:158,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.channelExitSE=this.metascreen({id:159,icon:U`
      |   |
      | \u2554\u2550|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:"  rr",exits:[Y({left:5})]});this.channelBendWS=this.metascreen({id:160,icon:U`
      |\u2588  |
      |\u2550\u2557 |
      |\u2588\u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:" rr "});this.channelHallNS=this.metascreen({id:161,icon:U`
      | \u2551 |
      | \u2560\u2508|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],wall:139,edges:"r r "});this.channelEntranceSE=this.metascreen({id:162,icon:U`
      |   |
      | \u2554\u2508|
      |\u2577\u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Y({left:2})],wall:124,edges:"  rr"});this.channelCross=this.metascreen({id:163,icon:U`
      | \u2551 |
      |\u2550\u256c\u2550|
      |\u2577\u2551\u2577|`,tilesets:{dolphinCave:{}},feature:["river"],exits:[Y({left:3}),Y({left:11,type:"door"})],edges:"  rr"});this.channelDoor=this.metascreen({id:164,icon:U`\u2229
      | \u2229\u2588|
      |\u2508\u2550\u2550|
      |  \u2588|`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[W(56)],wall:115,edges:" r  "});this.mountainFloatingIsland=this.metascreen({id:165,icon:U`*
      |\u2550\u2557\u2588|
      |*\u2551 |
      |\u2550\u2563\u2588|`,placement:"manual",tile:"   | ap|   ",tilesets:{mountainRiver:{}},edges:"  wp",connect:"e"});this.mountainPathNE_stair=this.metascreen({id:166,icon:U`\u2514
      |\u2588\u250b\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" / | pp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"l  p",connect:"2e",exits:[yg()]});this.mountainBranchNWE=this.metascreen({id:167,icon:U`\u2534
      |\u2588 \u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" p |ppp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp p",connect:"26e"});this.mountainPathWE_iceBridge=this.metascreen({id:168,icon:U`\u256b
      |\u2588\u2551\u2588|
      | \u2506 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},feature:["bridge"],edges:"wpwp",connect:"6-e:2a",wall:135});this.mountainPathSE=this.metascreen({id:169,icon:U`\u250c
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588 \u2588|`,tile:"   | pp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:"  pp",connect:"ae",exits:[Bg({top:6,height:4}),Y({left:6,width:4})]});this.mountainDeadEndW_caveEmpty=this.metascreen({id:170,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u2590 \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[V(56)]});this.mountainPathNE=this.metascreen({id:171,icon:U`\u2514
      |\u2588 \u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" p | pp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"p  p",connect:"2e",exits:[Bg({top:6,height:4}),yg({left:6,width:4})]});this.mountainBranchWSE=this.metascreen({id:172,icon:U`\u252c
      |\u2588\u2588\u2588|
      |   |
      |\u2588 \u2588|`,tile:"   |ppp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:" ppp",connect:"6ae"});this.mountainPathW_cave=this.metascreen({id:173,icon:U`\u2229
      |\u2588\u2229\u2588|
      |  \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[V(85)]});this.mountainPathE_slopeS=this.metascreen({id:174,icon:U`\u2553
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588\u2193\u2588|`,tile:"   | pp| \u2193 ",tilesets:{mountain:{}},edges:"  sp",connect:"ae"});this.mountainPathNW=this.metascreen({id:175,icon:U`\u2518
      |\u2588 \u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:" p |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp  ",connect:"26",exits:[Ag({top:6,height:4}),yg({left:6,width:4})]});this.mountainCave_empty=this.metascreen({id:176,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588\u2588\u2588|`,tile:"   | < |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"    ",connect:"",exits:[V(88)]});this.mountainPathE_cave=this.metascreen({id:177,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"   p",connect:"e",exits:[V(87)]});this.mountainPathWE_slopeN=this.metascreen({id:178,icon:U`\u2568
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |ppp|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e"});this.mountainDeadEndW=this.metascreen({id:179,icon:U`\u2574
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:"   |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6"});this.mountainPathWE=this.metascreen({id:180,icon:U`\u2500
      |\u2588\u2588\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |ppp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p p",connect:"6e",exits:[Ag({top:6,height:4}),Bg({top:6,height:4})]});this.mountainArena_gate=this.metascreen({id:181,icon:U`#
      |\u2588#\u2588|
      |\u258c \u2590|
      |\u2588\u250b\u2588|`,tile:"   | < | / ",tilesets:{mountain:{},mountainRiver:{}},feature:["arena"],edges:"  l ",connect:"a",exits:[Object.assign({},wg(71,3),{type:"cave"})],flag:"custom:false"});this.mountainPathN_slopeS_cave=this.metascreen({id:182,icon:U`\u2229
      |\u2588\u250b\u2229|
      |\u258c \u2590|
      |\u2588\u2193\u2588|`,tile:" / | < | \u2193 ",tilesets:{mountain:{}},edges:"l s ",connect:"2a",exits:[V(90),yg()]});this.mountainPathWE_slopeNS=this.metascreen({id:183,icon:U`\u256b
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"26ae"});this.mountainPathWE_slopeN_cave=this.metascreen({id:184,icon:U`\u2229
      |\u2588\u2193\u2229|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |p<p|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e",exits:[V(92)]});this.mountainPathWS=this.metascreen({id:185,icon:U`\u2510
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588 \u2588|`,tile:"   |pp | p ",tilesets:{mountain:{},mountainRiver:{}},edges:" pp ",connect:"6a",exits:[Ag({top:6,height:4}),Y({left:6,width:4})]});this.mountainSlope=this.metascreen({id:186,icon:U`\u2193
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|`,tile:" \u2193 | \u2193 | \u2193 ",tilesets:{mountain:{}},edges:"s s ",connect:"2a"});this.mountainRiver=this.metascreen({id:186,icon:U`\u2551
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|`,tile:[" r | r | r "," r | r |   "],tilesets:{mountainRiver:{}},edges:"w w ",connect:"2:e"});this.mountainPathE_gate=this.metascreen({id:187,icon:U`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{}},edges:"   p",connect:"e",exits:[V(87,"gate")]});this.mountainPathWE_inn=this.metascreen({id:188,icon:U`\u2229
      |\u2588\u2229\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |p<p|   ",placement:"manual",tilesets:{mountain:{}},edges:" p p",connect:"6e",exits:[W(118)]});this.mountainPathWE_bridgeOverSlope=this.metascreen({id:189,icon:U`\u2550
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"6e",exits:[Cg(182,4)]});this.mountainPathWE_bridgeOverRiver=this.metascreen({id:189,icon:U`\u2550
      |\u2588\u2551\u2588|
      | \u2550 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},edges:"wpwp",connect:"6e|2|a"});this.mountainSlope_underBridge=this.metascreen({id:190,icon:U`\u2193
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |p\u2193p| \u2193 ",placement:"manual",tilesets:{mountain:{}},edges:"spsp",connect:"2a",exits:[Dg(198,4)]});this.mountainEmpty=this.metascreen({id:191,icon:U`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{mountain:{},mountainRiver:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryS=this.metascreen({id:192,icon:U`
      |   |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^ ^"});this.boundaryN_cave=this.metascreen({id:193,icon:U`
      |\u2588\u2588\u2588|
      |\u2580\u2229\u2580|
      |   |`,tile:"   |o<o|ooo",tilesets:{grass:{},sea:{},desert:{},river:{requires:[G.SeaCaveEntrance]}},edges:" vov",exits:[V(73)]});this.cornerSE_cave=this.metascreen({id:194,icon:U`
      | \u2590\u2588|
      |\u2584\u2229\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |o< |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  ",exits:[V(90)]});this.waterfall=this.metascreen({id:195,icon:U`
      |   |
      |\u2193\u2193\u2193|
      |   |`,tile:"ooo|\u2193\u2193\u2193|ooo",tilesets:{sea:{}},edges:"oooo"});this.whirlpoolBlocker=this.metascreen({id:196,icon:U`
      |   |
      |\u2588\u2573\u2588|
      |   |`,tile:"ooo|\u2193#\u2193|ooo",tilesets:{sea:{}},feature:["whirlpool"],flag:"calm",edges:"oooo"});this.beachExitN=this.metascreen({id:197,icon:U`
      |\u2588 \u2588|
      |\u2588\u2571\u2580|
      |\u2588\u258c |`,placement:"manual",tile:" x | bo| oo",tilesets:{sea:{}},edges:"n >v",exits:[yg({left:9})]});this.whirlpoolOpen=this.metascreen({id:198,icon:U`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{sea:{}},feature:["whirlpool"],edges:"oooo",flag:"calm"});this.quicksandOpen=this.metascreen({id:198,icon:U`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{}},feature:["whirlpool"],edges:"oooo"});this.lighthouseEntrance=this.metascreen({id:199,icon:U`
      |\u2597\u259f\u2588|
      |\u2590\u2229\u259b|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"oo |oLo|ooo",tilesets:{sea:{}},feature:["lighthouse"],edges:"<oov",exits:[V(42),W(117)]});this.beachCave=this.metascreen({id:200,icon:U`
      |\u2588\u2229\u2588|
      |\u2580\u2572\u2588|
      |   |`,placement:"manual",tile:"   |o<o|ooo",tilesets:{sea:{}},edges:" vov",exits:[V(40)]});this.beachCabinEntrance=this.metascreen({id:201,icon:U`
      | \u2229\u2588|
      | \u2572\u2580|
      |\u2588\u2584\u2584|`,placement:"manual",tile:"oo |oC8|   ",tilesets:{sea:{}},feature:["cabin"],edges:"<^ b",exits:[W(85),Bg({top:8,height:3})]});this.oceanShrine=this.metascreen({id:202,icon:U`
      |\u2597\u2584\u2596|
      |\u2590*\u258c|
      |\u259d \u2598|`,placement:"manual",tile:"ooo|oAo|ooo",tilesets:{sea:{}},feature:["altar"],edges:"oooo"});this.pyramidEntrance=this.metascreen({id:203,icon:U`
      | \u2584 |
      |\u259f\u2229\u2599|
      | \u2573 |`,placement:"manual",tile:"ooo|oPo|ooo",tilesets:{desert:{}},feature:["pyramid"],edges:"oooo",exits:[V(167)]});this.cryptEntrance=this.metascreen({id:204,icon:U`
      | \u2573 |
      |\u2590>\u258c|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"ooo|oYo|ooo",tilesets:{desert:{}},feature:["crypt"],edges:"oooo",exits:[xg(103)]});this.oasisLake=this.metascreen({id:205,icon:U`
      | ^ |
      |vOv|
      | vv|`,tile:"ooo|ooo|oro",placement:"manual",tilesets:{desert:{}},feature:["lake"],edges:"oo3o"});this.desertCaveEntrance=this.metascreen({id:206,icon:U`
      |\u2597\u2584\u2596|
      |\u259c\u2229\u259b|
      | \u2573 |`,tile:"ooo|o<o|ooo",tilesets:{desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"oooo",exits:[V(167)]});this.oasisCave=this.metascreen({id:207,icon:U`
      | vv|
      |\u2584\u2229v|
      |\u2588\u258c |`,placement:"manual",tile:"oro|o<o| oo",tilesets:{desert:{}},edges:"3^>o",exits:[wg(55)]});this.channelEndW_cave=this.metascreen({id:208,icon:U`
      |\u2588\u2588\u2229|
      |\u2550\u2550 |
      |\u2588\u2588\u2588|`,tile:"   |r< |   ",tilesets:{dolphinCave:{}},feature:["river"],exits:[wg(87)]});this.boatChannel=this.metascreen({id:209,icon:U`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      |\u2584\u2584\u2584|`,tile:["   |888|   ","   |88x|   "],tilesets:{sea:{}},edges:" b b",exits:[Object.assign({},Bg({top:8,height:3}),{entrance:40168}),Ag({top:8,height:3})]});this.channelWE=this.metascreen({id:210,icon:U`
      |\u2588\u2588\u2588|
      |\u2550\u2550\u2550|
      |\u2588\u2588\u2588|`,tile:"   |rrr|   ",tilesets:{dolphinCave:{}},feature:["river"]});this.riverCaveNWSE=this.metascreen({id:211,icon:U`
      |\u2518\u2551\u2514|
      |\u2550\u256c\u2550|
      |\u252c\u2507\u252c|`,tile:" r |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"rrrr",connect:"15p:3dp:79-bf",wall:182,poi:[[4,0,72],[4,0,152]]});this.riverCaveNS=this.metascreen({id:212,icon:U`
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3b",mod:"bridge"});this.riverCaveWE=this.metascreen({id:213,icon:U`
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" r r",connect:"5d:7f",mod:"bridge"});this.riverCaveNS_bridge=this.metascreen({id:214,icon:U`
      |\u2502\u2551\u2502|
      |\u251c\u2507\u2524|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r r ",connect:"19-3b",wall:135});this.riverCaveWE_bridge=this.metascreen({id:215,icon:U`
      |\u2500\u252c\u2500|
      |\u2550\u2505\u2550|
      |\u2500\u2534\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:" r r",connect:"5d-7f",wall:134});this.riverCaveSE=this.metascreen({id:216,icon:U`
      |\u250c\u2500\u2500|
      |\u2502\u2554\u2550|
      |\u2502\u2551\u250c|`,tile:"   | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"  rr",connect:"9d:bf"});this.riverCaveWS=this.metascreen({id:217,icon:U`
      |\u2500\u2500\u2510|
      |\u2550\u2557\u2502|
      |\u2510\u2551\u2502|`,tile:"   |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rr ",connect:"5b:79"});this.riverCaveNE=this.metascreen({id:218,icon:U`
      |\u2502\u2551\u2514|
      |\u2502\u255a\u2550|
      |\u2514\u2500\u2500|`,tile:" r | rr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r  r",connect:"1f:3d"});this.riverCaveNW=this.metascreen({id:219,icon:U`
      |\u2518\u2551\u2502|
      |\u2550\u255d\u2502|
      |\u2500\u2500\u2518|`,tile:" r |rr |   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr  ",connect:"15:37"});this.riverCaveWE_passageN=this.metascreen({id:220,icon:U`\u2567
      |\u2500\u2534\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:" c |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"cr r",connect:"25d:7f"});this.riverCaveWE_passageS=this.metascreen({id:221,icon:U`\u2564
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u252c\u2500|`,tile:"   |rrr| c ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rcr",connect:"5d:7af"});this.riverCaveNS_passageW=this.metascreen({id:222,icon:U`\u2562
      |\u2502\u2551\u2502|
      |\u2524\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r |cr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rcr ",connect:"169:3b"});this.riverCaveNS_passageE=this.metascreen({id:223,icon:U`\u255f
      |\u2502\u2551\u2502|
      |\u2502\u2551\u251c|
      |\u2502\u2551\u2502|`,tile:" r | rc| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rc",connect:"19:3be"});this.wideHallNE=this.metascreen({id:224,icon:U`
      | \u2503 |
      | \u2517\u2501|
      |   |`,tile:" w | ww|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w  w",connect:"2e"});this.goaWideHallNE=this.metascreen({id:224,icon:U`
      |\u2502\u2503\u2514|
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{}},edges:"w  w",connect:"1f|2e|3d"});this.goaWideHallNE_blockedLeft=this.metascreen({id:224,icon:U`
      |\u2502\u2503\u2514|
      | \u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97]}},edges:"w  w",connect:"1|f|2e|3d"});this.goaWideHallNE_blockedRight=this.metascreen({id:224,icon:U`
      |\u2502\u2503 |
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[13]}},edges:"w  w",connect:"1f|2e|3|d"});this.wideHallNW=this.metascreen({id:225,icon:U`
      | \u2503 |
      |\u2501\u251b |
      |   |`,tile:" w |ww |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww  ",connect:"26"});this.goaWideHallNW=this.metascreen({id:225,icon:U`
      |\u2518\u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],removeWall:109}},edges:"ww  ",connect:"15|26|37"});this.goaWideHallNW_blockedRight=this.metascreen({id:225,icon:U`
      |\u2518\u2503\u2502|
      |\u2501\u251b |
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{}},edges:"ww  ",connect:"15|26|3|7"});this.goaWideHallNW_blockedLeft=this.metascreen({id:225,icon:U`
      | \u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1],removeWall:109}},edges:"ww  ",connect:"1|5|26|37"});this.wideHallSE=this.metascreen({id:226,icon:U`
      |   |
      | \u250f\u2501|
      | \u2503 |`,tile:"   | ww| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  ww",connect:"ae"});this.goaWideHallSE=this.metascreen({id:226,icon:U`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{}},edges:"  ww",connect:"9d|ae|bf"});this.goaWideHallSE_blockedLeft=this.metascreen({id:226,icon:U`
      |\u250c\u2500\u2500|
      | \u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97]}},edges:"  ww",connect:"9|d|ae|bf"});this.goaWideHallSE_blockedRight=this.metascreen({id:226,icon:U`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503 |`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[221]}},edges:"  ww",connect:"9d|ae|b|f"});this.wideHallWS=this.metascreen({id:227,icon:U`
      |   |
      |\u2501\u2513 |
      | \u2503 |`,tile:"   |ww | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" ww ",connect:"6a"});this.goaWideHallWS=this.metascreen({id:227,icon:U`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],removeWall:157}},edges:" ww ",connect:"5b|6a|79"});this.goaWideHallWS_blockedRight=this.metascreen({id:227,icon:U`
      |\u2500\u2500\u2510|
      |\u2501\u2513 |
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{}},edges:" ww ",connect:"5|b|6a|79"});this.goaWideHallWS_blockedLeft=this.metascreen({id:227,icon:U`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      | \u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[209],removeWall:157}},edges:" ww ",connect:"5b|6a|7|9"});this.goaWideHallNS_stairs=this.metascreen({id:228,icon:U`
      |\u251c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2524|`,tile:" w | H | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"1239ab"});this.goaWideHallNS_stairsBlocked13=this.metascreen({id:228,icon:U`
      |\u2514\u2528\u2502|
      |\u2577\u2503\u2575|
      |\u2502\u2520\u2510|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[65,141]}},edges:"w w ",connect:"12ab|3|9"});this.goaWideHallNS_stairsBlocked24=this.metascreen({id:228,icon:U`
      |\u250c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2518|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,205]}},edges:"w w ",connect:"1|239a|b"});this.wideHallNS_deadEnds=this.metascreen({id:229,icon:U`
      | \u2579 |
      |   |
      | \u257b |`,tile:" w |   | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2|a",match:a=>a(272,120)&&a(-48,120)});this.wideHall_deadEndN=this.metascreen({id:229,icon:U`
      | \u2579 |
      |   |
      |   |`,tile:[" w |   |   "," w | w |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",match:a=>!a(272,120)&&a(-48,120)});this.wideHall_deadEndS=this.metascreen({id:229,icon:U`
      |   |
      |   |
      | \u257b |`,tile:["   |   | w ","   | w | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  w ",connect:"a",match:a=>a(272,120)&&!a(-48,120)});this.goaWideHallNS_deadEnd=this.metascreen({id:229,icon:U`
      |\u2502\u2579\u2502|
      |\u251c\u2500\u2524|
      |\u2502\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"139b|2|a"});this.goaWideHallNS_deadEndBlocked24=this.metascreen({id:229,icon:U`
      |\u2575\u2579\u2502|
      |\u250c\u2500\u2518|
      |\u2502\u257b\u2577|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97,173]}},edges:"w w ",connect:"1|2|39|a|b"});this.goaWideHallNS_deadEndBlocked13=this.metascreen({id:229,icon:U`
      |\u2502\u2579\u2575|
      |\u2514\u2500\u2510|
      |\u2577\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[109,161]}},edges:"w w ",connect:"1b|2|3|9|a"});this.wideHallNWSE=this.metascreen({id:230,icon:U`
      | \u2503 |
      |\u2501\u254b\u2501|
      | \u2503 |`,tile:" w |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"wwww",connect:"26ae"});this.goaWideHallNWSE=this.metascreen({id:230,icon:U`
      |\u2518\u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{}},edges:"wwww",connect:"26ae|15|3d|79|bf"});this.goaWideHallNWSE_blocked13=this.metascreen({id:230,icon:U`
      |\u2518\u2503 |
      |\u2501\u254b\u2501|
      | \u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[13,209]}},edges:"wwww",connect:"26ae|15|3|d|7|9|bf"});this.goaWideHallNWSE_blocked24=this.metascreen({id:230,icon:U`
      | \u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503 |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,221]}},edges:"wwww",connect:"26ae|1|5|3d|79|b|f"});this.wideHallNWE=this.metascreen({id:231,icon:U`
      | \u2503 |
      |\u2501\u253b\u2501|
      |   |`,tile:" w |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww w",connect:"26e"});this.goaWideHallNWE=this.metascreen({id:231,icon:U`
      |\u2518\u2503\u2514|
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{}},edges:"ww w",connect:"26e|15|3d|7f"});this.goaWideHallNWE_blockedTop=this.metascreen({id:231,icon:U`
      | \u2503 |
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,13]}},edges:"ww w",connect:"26e|1|5|3|d|7f"});this.wideHallWSE=this.metascreen({id:232,icon:U`
      |   |
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" www",connect:"6ae"});this.goaWideHallWSE=this.metascreen({id:232,icon:U`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      |\u2510\u2503\u250c|`,tile:"   |www| w ",tilesets:{labyrinth:{}},edges:" www",connect:"6ae|5d|79|bf"});this.goaWideHallWSE_blockedBottom=this.metascreen({id:232,icon:U`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[209,221]}},edges:" www",connect:"6ae|5d|7|9|b|f"});this.wideHallNS_wallTop=this.metascreen({id:233,icon:U`
      | \u2506 |
      | \u2503 |
      | \u2503 |`,tile:" n | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide","wall"],edges:"c w",connect:"2a",exits:[yg({left:6,width:4})],wall:55,statues:[10]});this.goaWideHallNS_wallTop=this.metascreen({id:233,icon:U`
      | \u2506 |
      |\u2577\u2503\u2577|
      |\u2502\u2503\u2502|`,tile:" n | w | w ",tilesets:{labyrinth:{}},feature:["wall"],edges:"c w ",connect:"2ax|9|b",exits:[yg({left:6,width:4})],wall:55,statues:[10]});this.wideHallWE=this.metascreen({id:234,icon:U`
      |   |
      |\u2501\u2501\u2501|
      |   |`,tile:"   |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" w w",connect:"6e"});this.goaWideHallWE=this.metascreen({id:234,icon:U`
      |\u2500\u2500\u2500|
      |\u2501\u2501\u2501|
      |\u2500\u2500\u2500|`,tile:"   |www|   ",tilesets:{labyrinth:{}},edges:" w w",connect:"5d|6e|7f"});this.pitWE=this.metascreen({id:235,tile:"   |cpc|   ",icon:U`
      |   |
      |\u2500\u2573\u2500|
      |   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:" c c",connect:"6e",platform:{type:"horizontal",coord:28728}});this.pitNS=this.metascreen({id:236,icon:U`
      | \u2502 |
      | \u2573 |
      | \u2502 |`,tile:" c | p | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:"c c ",connect:"2a",platform:{type:"vertical",coord:16504}});this.pitNS_unreachable=this.metascreen({id:236,icon:U`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.spikesNS_hallS=this.metascreen({id:237,icon:U`
      | \u2591 |
      | \u2591 |
      | \u2502 |`,tile:" s | s | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s c ",connect:"2a"});this.spikesNS_hallN=this.metascreen({id:238,icon:U`
      | \u2502 |
      | \u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" c | s | s ",feature:["spikes"],edges:"c s ",connect:"2a"});this.spikesNS_hallWE=this.metascreen({id:239,icon:U`
      | \u2591 |
      |\u2500\u2591\u2500|
      | \u2591 |`,tile:" s |csc| s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"scsc",connect:"26ae"});this.spikesNS_hallW=this.metascreen({id:-225,icon:U`
      | \u2591 |
      |\u2500\u2591 |
      | \u2591 |`,tilesets:ce(G.ExtraSpikes,{cave:{},fortress:{},pyramid:{},iceCave:{}}),tile:" s |cs | s ",feature:["spikes"],edges:"scs ",connect:"26a"});this.spikesNS_hallE=this.metascreen({id:-226,icon:U`
      | \u2591 |
      | \u2591\u2500|
      | \u2591 |`,tilesets:ce(G.ExtraSpikes,{cave:{},fortress:{},pyramid:{},iceCave:{}}),tile:" s | sc| s ",feature:["spikes"],edges:"s sc",connect:"2ae"});this.riverCave_deadEndsNS=this.metascreen({id:240,icon:U`
      | \u2568 |
      |   |
      | \u2565 |`,tile:" r |   | r ",placement:"manual",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r r ",connect:"1p:3p|9p:bp",poi:[[1,-48,72],[1,-48,152],[1,272,72],[1,272,152]]});this.riverCave_deadEndsN=this.metascreen({id:240,icon:U`
      | \u2568 |
      |   |
      |   |`,tile:[" r |   |   "," r | r |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r   ",connect:"1p:3p",poi:[[1,-48,72],[1,-48,152]],match:a=>!a(264,72)&&!a(264,152),mod:"bridge"});this.riverCave_deadEndsS=this.metascreen({id:240,icon:U`
      |   |
      |   |
      | \u2565 |`,tile:["   |   | r ","   | r | r "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"  r ",connect:"9p:bp",poi:[[1,272,72],[1,272,152]],match:a=>!a(-48,72)&&!a(-48,152),mod:"bridge"});this.riverCave_deadEndsWE=this.metascreen({id:241,icon:U`
      |   |
      |\u2561 \u255e|
      |   |`,tile:"   |r r|   ",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r r",connect:"5p:7p|dp:fp",poi:[[1,96,-40],[1,160,-40],[1,96,264],[1,160,264]]});this.riverCave_deadEndsW=this.metascreen({id:241,icon:U`
      |   |
      |\u2561  |
      |   |`,tile:["   |r  |   ","   |rr |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r  ",connect:"5p:7p",poi:[[1,96,-40],[1,160,-40]],match:a=>!a(96,264)&&!a(160,264)});this.riverCave_deadEndsE=this.metascreen({id:241,icon:U`
      |   |
      |  \u255e|
      |   |`,tile:["   |  r|   ","   | rr|   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"   r",connect:"dp:fp",poi:[[1,96,264],[1,160,264]],match:a=>!a(96,-40)&&!a(160,-40)});this.riverCaveN_bridge=this.metascreen({id:242,icon:U`
      | \u2507 |
      | \u2568 |
      |   |`,tile:[" r | r |   "," r |   |   "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r   ",connect:"1-3",wall:23,match:a=>!a(208,72)&&!a(208,152)});this.riverCaveS_bridge=this.metascreen({id:242,icon:U`
      |   |
      | \u2565 |
      | \u2507 |`,tile:["   | r | r ","   |   | r "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"  r ",connect:"9-b",wall:198,match:a=>!a(16,72)&&!a(16,152)});this.riverCaveWSE=this.metascreen({id:243,icon:U`
      |\u2500\u2500\u2500|
      |\u2550\u2566\u2550|
      |\u2510\u2551\u250c|`,tile:"   |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rrr",connect:"5d:79:bf"});this.riverCaveNWE=this.metascreen({id:244,icon:U`
      |\u2518\u2551\u2514|
      |\u2550\u2569\u2550|
      |\u2500\u2500\u2500|`,tile:" r |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr r",connect:"15p:3dp:7f",poi:[[4,0,72],[4,0,152]]});this.riverCaveNS_blockedRight=this.metascreen({id:245,icon:U`
      |\u2502\u2551\u2502|
      |\u2502\u2551 |
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3p:bp",poi:[[0,64,152],[0,192,152]],mod:"block"});this.riverCaveNS_blockedLeft=this.metascreen({id:246,icon:U`
      |\u2502\u2551\u2502|
      | \u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"1p:3b:9p",poi:[[0,48,72],[0,176,72]],mod:"block"});this.spikesNS=this.metascreen({id:247,icon:U`
      | \u2591 |
      | \u2591 |
      | \u2591 |`,tile:" s | s | s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s s ",connect:"2a"});this.cryptArena_statues=this.metascreen({id:248,icon:U`<
      |&<&|
      |\u2502 \u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | c ",tilesets:{pyramid:{}},feature:["arena"],edges:"  c ",connect:"a",exits:[Object.assign({},wg(87),{type:"crypt"})],flag:"custom:false",arena:2});this.pyramidArena_draygon=this.metascreen({id:249,icon:U`
      |\u250c\u2500\u2510|
      |\u2502\u2573\u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | w ",tilesets:{pyramid:{}},feature:["arena","pit"],edges:"  w ",connect:"a",arena:3});this.cryptArena_draygon2=this.metascreen({id:250,icon:U`
      |\u250f\u2537\u2513|
      |\u2503&\u2503|
      |\u2517\u2533\u251b|`,tile:" x | a | w ",tilesets:{pyramid:{}},feature:["arena"],edges:"c w ",connect:"2a",exits:[yg({left:6,width:4})],flag:"custom:false",arena:4});this.cryptArena_entrance=this.metascreen({id:251,icon:U`
      | \u2503 |
      | \u2503 |
      | \u257f |`,tile:" w | w | x ",tilesets:{pyramid:{}},edges:"w n ",connect:"2a",exits:[Y()]});this.cryptTeleporter=this.metascreen({id:252,tilesets:{pyramid:{},tower:{}},exits:[Y({left:6,width:4}),V(87,"teleporter")]});this.fortressArena_through=this.metascreen({id:253,icon:U`\u257d
      |\u250c\u2534\u2510|
      |\u2502 \u2502|
      |\u2515\u2533\u2519|`,tile:[" c | a | w "," n | a | w "],tilesets:{fortress:{},pyramid:{}},feature:["arena"],edges:"n w ",connect:"2a",exits:[yg()],arena:5});this.fortressTrap=this.metascreen({id:254,icon:U`
      |\u2514\u2500\u2518|
      | \u2573 |
      |\u2576\u252c\u2574|`,tile:"   | x | n ",tilesets:{fortress:{},pyramid:{}},feature:["pit"],edges:"  n ",connect:"a",exits:[Y()]});this.shrine=this.metascreen({id:255,tilesets:{shrine:{}},exits:[Y({left:6,width:5})]});this.inn=this.metascreen({id:256,tilesets:{house:{}},exits:[Object.assign({},W(134),{entrance:37992})]});this.toolShop=this.metascreen({id:257,tilesets:{house:{}},exits:[Object.assign({},W(134),{entrance:37992})]});this.armorShop=this.metascreen({id:258,tilesets:{house:{}},exits:[Object.assign({},
W(134),{entrance:37992})]});for(const b in this)a=this[b],a instanceof Eg&&(a.name=b)}metascreen(a){const b=new Eg(this.rom,this.length,a);this[this.length++]=b;this.screensById.get(b.sid).push(b);for(const c in a.tilesets){const d=c,e=a.tilesets[d];if(e.requires)for(const a of e.requires)this.screensByFix.get(a).push(b);else this.rom.metatilesets[d].addScreen(b)}return b}getById(a,b){a=this.screensById.has(a)?[...this.screensById.get(a)]:[];null!=b&&(a=a.filter(a=>a.isCompatibleWithTileset(b)));
return a}registerFix(a,b){for(const d of this.screensByFix.get(a)){var c=(d.data.update||[]).find(b=>b[0]===a);if(c){if(null==b)throw Error("Seed required for update");if(!c[1](d,b,this.rom))continue}for(const b in d.data.tilesets){c=b;const e=d.data.tilesets[c];if(!e.requires)continue;const g=e.requires.indexOf(a);0>g||(e.requires.splice(g,1),e.requires.length||this.rom.metatilesets[c].addScreen(d))}}}renumber(a,b){console.log(`renumber ${a} -> ${b}`);var c=this.screensById.get(b);if(c.length)throw Error(`ID already used: ${b}: ${c}`);
let d;for(var e of this.getById(a))e.data.definition&&(d=e.data.definition,e.data.definition=void 0),e.unsafeSetId(b),c.push(e);this.screensById.delete(a);e=this.rom.screens.getScreen(a);0<=a&&0>b&&(c[0].data.definition=Uint8Array.from(e.tiles));c=e.clone(b);this.rom.screens.setScreen(b,c);e.used=!1;0>a&&(this.rom.screens.deleteScreen(a),d&&0<=b&&(c.tiles=Array.from(d)));this.rom.locations.renumberScreen(a,b)}checkExitTypes(){var a;for(const b in this){const c=this[b],d=new Set;for(const e of(null===
(a=null===c||void 0===c?void 0:c.data)||void 0===a?void 0:a.exits)||[])d.has(e.type)&&console.log(`duplicate: ${b} ${e.type}`),d.add(e.type)}}};class Ng extends Sc{constructor(a,b){super(a,b);this.mirrored=null;this.pointer=230492+(this.id<<1);this.base=Lb(a.prg,this.pointer)+196608;this.used=229376<=this.base;if(255===a.prg[this.base]){const c=Lb(a.prg,this.base+1);for(let b=0;256>b;b++)if(Lb(a.prg,230492+(b<<1))===c){this.mirrored=b;break}if(null==this.mirrored)throw Error(`could not find mirrored sprite for ${x(b)}: ${x(c)}`);this.frames=this.frameMask=this.size=0;this.sprites=[]}else this.mirrored=null,this.size=a.prg[this.base],this.frameMask=
a.prg[this.base+1],this.frames=this.frameMask+1,this.sprites=v(this.frames,b=>{b=this.base+2+4*b*this.size;const c=[];for(let d=0;d<this.size&&128!==a.prg[b+4*d];d++)c.push(Db(a.prg,b+4*d,4));return c})}patternBanks(a=0){if(!this.used)return[];let b=this;b.mirrored&&(b=this.rom.metasprites[b.mirrored]);const c=new Set;for(const d of b.sprites)for(const [b,,,f]of d){if(128===b)break;c.add(f+a>>>6&255)}return[...c]}palettes(){if(!this.used)return[];let a=this;a.mirrored&&(a=this.rom.metasprites[a.mirrored]);
const b=new Set;for(const c of a.sprites)for(const [a,,e]of c){if(128===a)break;b.add(e&3)}return[...b]}};class Og{constructor(a){this.rom=a;this._all=[];this.grass=this.tileset(128,{patterns:[0,12]});this.town=this.tileset(132,{});this.cave=this.tileset(136,{});this.dolphinCave=this.tileset(136,{});this.pyramid=this.tileset(140,{});this.river=this.tileset(144,{animated:[0,1],patterns:[20,0]});this.sea=this.tileset(148,{});this.lime=this.tileset(148,{});this.mountain=this.tileset(148,{});this.shrine=this.tileset(152,{});this.desert=this.tileset(156,{});this.mountainRiver=this.tileset(156,{});this.swamp=
this.tileset(160,{consolidated:!0});this.house=this.tileset(160,{});this.fortress=this.tileset(164,{});this.labyrinth=this.tileset(164,{});this.iceCave=this.tileset(168,{});this.tower=this.tileset(172,{});for(const b in this)a=this[b],a instanceof Pg&&(a.name=b)}tileset(a,b){a=new Pg(this.rom,a,b);this._all.push(a);return a}[Symbol.iterator](){return this._all[Symbol.iterator]()}}
class Pg{constructor(a,b,c){this.rom=a;this.tilesetId=b;this.data=c;this._screens=new Set;this._cache=void 0}[Symbol.iterator](){return this._screens[Symbol.iterator]()}get cache(){this._cache||(this._cache=new Qg(this));return this._cache}get tileset(){return this.rom.tilesets[this.tilesetId]}get empty(){const a=this.cache.empty;if(!a)throw Error(`No empty screen for ${this.name}`);return a}effects(){return this.tileset.effects()}getTile(a){return this.tileset.getTile(a)}addScreen(a){this._screens.add(a);
a.unsafeAddTileset(this);this.invalidate()}deleteScreen(a){this._screens.delete(a);a.unsafeRemoveTileset(this);this.invalidate()}getMetascreens(a){var b;return null!==(b=this.cache.fromId.get(a))&&void 0!==b?b:[]}getExits(a){return this.cache.exits.get(a)}getMetascreensFromTileString(a){return this.cache.tiles.has(a)?this.cache.tiles.get(a):[]}getScreensWithOnlyFeatures(...a){let b=0;for(const c of a)b|=ug[c];a=[];for(const c of this)c.features&~b||a.push(c);return a}withMod(a,b){const c=[];for(const d of this.cache.tiles.get(a))d.data.mod===
b&&c.push(d);return c}unreachableVariant(a){for(const b of this)if(b.sid===a.sid&&b.isEmpty())return b;return a}isBannedVertical(a,b){return this.cache.bannedNeighbors[0].has(a.uid<<16|b.uid)}isBannedHorizontal(a,b){return this.cache.bannedNeighbors[1].has(a.uid<<16|b.uid)}invalidate(){this._cache=void 0}}var Rg,Sg=Rg||(Rg={});Sg.N=0;Sg.W=1;Sg.S=2;Sg.E=3;
class Qg{constructor(a){var b,c;this.tileset=a;this.fromId=new m(()=>[]);this.exits=new m(()=>[]);this.tiles=new m(()=>[]);this.bannedNeighbors=[new Set,new Set];let d=void 0;for(const f of a){0<=f.sid&&this.fromId.get(f.sid).push(f);d||"    "!==f.data.edges||"manual"===f.data.placement||!f.hasFeature("empty")||(null===(b=f.data.exits)||void 0===b?0:b.length)||(d=f);for(const a of null!==(c=f.data.exits)&&void 0!==c?c:[])this.exits.get(a.type).push(f);var e="string"===typeof f.data.tile?[f.data.tile]:
f.data.tile;for(const a of null!==e&&void 0!==e?e:[])this.tiles.get(a.replace(/\|/g,"")).push(f);(f.hasFeature("ramp")||f.hasFeature("overpass")||f.hasFeature("pit")||f.isEmpty())&&this.banDeadEndNeighbor(f);e=a.rom.metascreens;this.banDeadEndNeighbor(e.branchNWE_wall,1);this.banNeighbor(e.deadEndS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndS_stairs,e.deadEndNS_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndNS_stairs,2)}this.empty=
null!==d&&void 0!==d?d:a.rom.metascreens.caveEmpty}banDeadEndNeighbor(a,b=15){var c,d;for(const e of this.tileset)if(e.hasFeature("deadend"))for(let f=0;4>f;f++)b&1<<f&&" "!==(null===(c=a.data.edges)||void 0===c?void 0:c[f])&&" "!==(null===(d=e.data.edges)||void 0===d?void 0:d[f^2])&&this.banNeighbor(a,e,f)}banNeighbor(a,b,c){this.bannedNeighbors[c&1].add((c&2?a:b).uid<<16|(c&2?b:a).uid)}};class Z extends Sc{constructor(a,b,c,d={}){super(a.rom,b);this.type=c;this.data=d;a[b]=this}}
class Tg extends Tc{constructor(a){super();this.rom=a;this.straightShotOptionalBounce=new Z(this,16,"projectile");this.straightShotNoBounce=new Z(this,17,"projectile");this.madoShuriken=new Z(this,22,"projectile");this.demonWallFire=new Z(this,23,"projectile");this.popcorn=new Z(this,27,"projectile");this.harpoonSource=new Z(this,29,"source");this.lasers=new Z(this,30,"projectile");this.paralysisPowder=new Z(this,31,"projectile");this.randomMovement=new Z(this,32,"monster",{movement:1});this.randomLargeStoner=
new Z(this,33,"monster",{hasChild:!0,large:!0,movement:2});this.slowHoming=new Z(this,34,"monster",{hasChild:!0,movement:3});this.smallHoming1=new Z(this,36,"monster",{movement:3});this.smallHoming2=new Z(this,37,"monster",{movement:3});this.homingShooter1=new Z(this,38,"monster",{hasChild:!0,projectile:1,movement:3});this.homingShooter2=new Z(this,39,"monster",{hasChild:!0,projectile:1,movement:3});this.headShooter=new Z(this,40,"monster",{hasChild:!0,projectile:2,movement:3,metasprites:()=>[101,
145]});this.puddle=new Z(this,41,"monster",{hasChild:!0,movement:5,metasprites:()=>[107,104]});this.soldier=new Z(this,42,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});this.mimic=new Z(this,43,"monster",{movement:4});this.mothResidueSource=new Z(this,44,"source",{hasChild:!0});this.flailGuy=new Z(this,46,"monster",{hasChild:!0,large:!0,projectile:2,movement:3});this.dynaLaser=new Z(this,47,"projectile");this.guardianStatue=new Z(this,52,"source",{hasChild:!0});
this.movingPlatform=new Z(this,56,"other");this.crumblingMovingPlatform=new Z(this,60,"other");this.erraticFlyer=new Z(this,64,"monster",{hasChild:!0,moth:!0,movement:4,placement:"moth"});this.skeleton=new Z(this,65,"monster",{hasChild:!0,movement:3});this.swampTomato=new Z(this,68,"monster",{movement:3});this.shootingFlyer=new Z(this,69,"monster",{hasChild:!0,bird:!0,projectile:2,movement:5,placement:"bird"});this.swampPlant=new Z(this,76,"monster",{hasChild:!0,stationary:!0,projectile:3,placement:"plant"});
this.kraken=new Z(this,77,"monster",{hasChild:!0,stationary:!0,projectile:3});this.burt=new Z(this,78,"monster",{hasChild:!0,stationary:!0});this.dynaShot=new Z(this,87,"projectile",{});this.popcorn2=new Z(this,88,"projectile");this.towerSentinel=new Z(this,92,"monster",{hasChild:!0,projectile:3,movement:1});this.helicopter=new Z(this,93,"monster",{bird:!0,movement:6,placement:"bird"});this.whiteRobot=new Z(this,94,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});
this.vampire=new Z(this,96,"boss");this.vampireBat=new Z(this,97,"monster");this.kelbesque=new Z(this,99,"boss");this.kelbesqueRock=new Z(this,100,"projectile");this.sabera=new Z(this,102,"boss");this.mado=new Z(this,103,"boss");this.karmine=new Z(this,104,"boss");this.draygon1=new Z(this,106,"boss");this.draygon2=new Z(this,107,"boss");this.dyna=new Z(this,112,"boss");this.giantBug=new Z(this,127,"boss")}};class Ug extends Tc{constructor(a){super(256);this.rom=a;this.sorcerorShot=new F(this,{id:63,scaling:37,type:"projectile"});this.wraith1=new F(this,{id:75,scaling:24,class:"wraith"});this.paralysisPowderSource=new F(this,{id:77,scaling:23,type:"projectile"});this.wraith2=new F(this,{id:79,scaling:28,class:"wraith"});this.blueSlime=new F(this,{id:80,scaling:1,class:"slime"});this.weretiger=new F(this,{id:81,scaling:1});this.greenJelly=new F(this,{id:82,scaling:4,class:"jelly"});this.redSlime=new F(this,
{id:83,scaling:4,class:"slime"});this.rockGolem=new F(this,{id:84,scaling:4,class:"golem"});this.blueBat=new F(this,{id:85,scaling:4});this.greenWyvern=new F(this,{id:86,scaling:4,class:"wyvern"});this.vampire1=new F(this,{id:87,scaling:5,type:"boss"});this.orc=new F(this,{id:88,scaling:6});this.redMosquito=new F(this,{id:89,scaling:10,class:"mosquito"});this.blueMushroom=new F(this,{id:90,scaling:10,class:"mushroom"});this.swampTomato=new F(this,{id:91,scaling:10});this.blueMosquito=new F(this,{id:92,
scaling:23,class:"mosquito"});this.swampPlant=new F(this,{id:93,scaling:10});this.giantInsect=new F(this,{id:94,scaling:11,type:"boss"});this.largeBlueSlime=new F(this,{id:95,scaling:11,class:"slime"});this.iceZombie=new F(this,{id:96,scaling:12,class:"zombie"});this.greenBrain=new F(this,{id:97,scaling:12,class:"brain"});this.greenSpider=new F(this,{id:98,scaling:12,class:"spider"});this.redWyvern=new F(this,{id:99,scaling:12,class:"wyvern"});this.soldier=new F(this,{id:100,scaling:14,class:"soldier"});
this.iceEntity=new F(this,{id:101,scaling:14,class:"entity"});this.redBrain=new F(this,{id:102,scaling:14,class:"brain"});this.iceGolem=new F(this,{id:103,scaling:14,class:"golem"});this.kelbesque1=new F(this,{id:104,scaling:15,type:"boss"});this.largeRedSlime=new F(this,{id:105,scaling:18,class:"slime"});this.troll=new F(this,{id:106,scaling:18});this.redJelly=new F(this,{id:107,scaling:18,class:"jelly"});this.medusa=new F(this,{id:108,scaling:19});this.crab=new F(this,{id:109,scaling:19});this.medusaHead=
new F(this,{id:110,scaling:20});this.bird=new F(this,{id:111,scaling:20,class:"bird"});this.redMushroom=new F(this,{id:113,scaling:21,class:"mushroom"});this.earthEntity=new F(this,{id:114,scaling:22,class:"entity"});this.mimic=new F(this,{id:115,scaling:22});this.redSpider=new F(this,{id:116,scaling:22,class:"spider"});this.fishman=new F(this,{id:117,scaling:25});this.jellyfish=new F(this,{id:118,scaling:25});this.kraken=new F(this,{id:119,scaling:25});this.darkGreenWyvern=new F(this,{id:120,scaling:27,
class:"wyvern"});this.sandZombie=new F(this,{id:121,scaling:38,class:"zombie"});this.wraithShadow1=new F(this,{id:123,scaling:28,class:"wraith"});this.moth=new F(this,{id:124,scaling:28,difficulty:3});this.sabera1=new F(this,{id:125,scaling:29,type:"boss"});this.verticalPlatform=new od(this,126);this.horizotalPlatform=new od(this,127);this.archer=new F(this,{id:128,scaling:33,class:"soldier"});this.bomberBird=new F(this,{id:129,scaling:33,class:"bird"});this.lavaBlob=new F(this,{id:130,scaling:37,
class:"puddle"});this.flailGuy=new F(this,{id:132,scaling:37});this.blueEye=new F(this,{id:133,scaling:37,class:"eye"});this.salamander=new F(this,{id:134,scaling:37});this.sorceror=new F(this,{id:135,scaling:37});this.mado1=new F(this,{id:136,scaling:37});this.knight=new F(this,{id:137,scaling:41,difficulty:1});this.devil=new F(this,{id:138,scaling:41});this.kelbesque2=new F(this,{id:139,scaling:41,type:"boss"});this.wraithShadow2=new F(this,{id:140,scaling:41,class:"wraith"});this.glitch1=new od(this,
141);this.glitch2=new od(this,142);this.guardianStatue=new od(this,143);this.sabera2=new F(this,{id:144,scaling:41,type:"boss"});this.tarantula=new F(this,{id:145,scaling:41});this.skeleton=new F(this,{id:146,scaling:41});this.mado2=new F(this,{id:147,scaling:41,type:"boss"});this.purpleEye=new F(this,{id:148,scaling:41,class:"eye"});this.flailKnight=new F(this,{id:149,scaling:41});this.scorpion=new F(this,{id:150,scaling:41});this.karmine=new F(this,{id:151,scaling:41,type:"boss"});this.sandBlob=
new F(this,{id:152,scaling:44,class:"puddle"});this.mummy=new F(this,{id:153,scaling:44});this.warlock=new F(this,{id:154,scaling:46});this.draygon1=new F(this,{id:155,scaling:45,type:"boss"});this.statueOfSun=new od(this,156);this.statueOfMoon=new od(this,157);this.draygon2=new F(this,{id:158,scaling:47,type:"boss"});this.crumblingVerticalPlatform=new od(this,159);this.brownRobot=new F(this,{id:160,scaling:47,difficulty:1});this.whiteRobot=new F(this,{id:161,scaling:47});this.towerSentinel=new F(this,
{id:162,scaling:47});this.helicopter=new F(this,{id:163,scaling:47});this.dyna=new F(this,{id:164,scaling:47,type:"boss"});this.vampire2=new F(this,{id:165,scaling:28,type:"boss"});this.glitch3=new od(this,166);this.dynaPod=new F(this,{id:180,scaling:47,type:"boss"});this.dynaCounter=new F(this,{id:184,scaling:47,type:"projectile"});this.dynaLaser=new F(this,{id:185,scaling:47,type:"projectile"});this.dynaBubble=new F(this,{id:186,scaling:47,type:"projectile"});this.vampire2Bat=new F(this,{id:188,
scaling:28});this.brownRobotLaserSource=new F(this,{id:190,scaling:47,type:"projectile"});this.draygon2Fireball=new F(this,{id:191,scaling:47,type:"projectile"});this.vampire1Bat=new F(this,{id:193,scaling:5});this.giantInsectFireball=new F(this,{id:195,scaling:11,type:"projectile"});this.greenMosquito=new F(this,{id:196,scaling:11});this.kelbesque1Rock=new F(this,{id:197,scaling:15,type:"projectile"});this.sabera1Balls=new F(this,{id:198,scaling:29,type:"projectile"});this.kelbesque2Fire=new F(this,
{id:199,scaling:41,type:"projectile"});this.sabera2Fire=new F(this,{id:200,scaling:41,type:"projectile"});this.sabera2Balls=new F(this,{id:201,scaling:41,type:"projectile"});this.karmineBalls=new F(this,{id:202,scaling:41,type:"projectile"});this.statueBalls=new F(this,{id:203,scaling:47,type:"projectile"});this.draygon1Lightning=new F(this,{id:204,scaling:45,type:"projectile"});this.draygon2Laser=new F(this,{id:205,scaling:47,type:"projectile"});this.draygon2Breath=new F(this,{id:206,scaling:47,
type:"projectile"});this.birdBomb=new F(this,{id:224,scaling:33,type:"projectile"});this.greenMosquitoShot=new F(this,{id:226,scaling:11,type:"projectile"});this.paralysisBeam=new F(this,{id:227,scaling:25,type:"projectile"});this.stoneGaze=new F(this,{id:228,scaling:19,type:"projectile"});this.rockGolemRock=new F(this,{id:229,scaling:4,type:"projectile"});this.curseBeam=new F(this,{id:230,scaling:41,type:"projectile"});this.mpDrainWeb=new F(this,{id:231,scaling:41,type:"projectile"});this.fishmanTrident=
new F(this,{id:232,scaling:25,type:"projectile"});this.orcAxe=new F(this,{id:233,scaling:6,type:"projectile"});this.swampPollen=new F(this,{id:234,scaling:10,type:"projectile"});this.paralysisPowder=new F(this,{id:235,scaling:23,type:"projectile"});this.soldierSword=new F(this,{id:236,scaling:14,type:"projectile"});this.iceGolemRock=new F(this,{id:237,scaling:14,type:"projectile"});this.trollAxe=new F(this,{id:238,scaling:18,type:"projectile"});this.krakenInk=new F(this,{id:239,scaling:25,type:"projectile"});
this.archerArrow=new F(this,{id:240,scaling:33,type:"projectile"});this.knightSword=new F(this,{id:242,scaling:41,type:"projectile"});this.mothResidue=new F(this,{id:243,scaling:28,type:"projectile"});this.brownRobotLaser=new F(this,{id:244,scaling:47,type:"projectile"});this.whiteRobotLaser=new F(this,{id:245,scaling:47,type:"projectile"});this.towerSentinelLaser=new F(this,{id:246,scaling:47,type:"projectile"});this.skeletonShot=new F(this,{id:247,scaling:41,type:"projectile"});this.blobShot=new F(this,
{id:248,scaling:37,type:"projectile"});this.flailKnightFlail=new F(this,{id:249,scaling:41,type:"projectile"});this.flailGuyFlail=new F(this,{id:250,scaling:37,type:"projectile"});this.madoShuriken=new F(this,{id:252,scaling:37,type:"projectile"});this.guardianStatueMissile=new F(this,{id:253,scaling:36,type:"projectile"});this.demonWallFire=new F(this,{id:254,scaling:37,type:"projectile"});for(var b in this)a=this[b],a instanceof od&&(a.name=Ab(b));for(b=0;b<this.length;b++)this[b]||(this[b]=new od(this,
b))}};var Vg;(function(a){a.bit=(a,c)=>new Wg(a,c);a.byte=a=>new Xg(a);a.address=a=>new Yg(a)})(Vg||(Vg={}));class Wg{constructor(a,b){this.address=a;this.bit=b}get(a){return!!(a[this.address]&1<<this.bit)}set(a,b){const c=1<<this.bit;a[this.address]=b?a[this.address]|c:a[this.address]&~c}}class Xg{constructor(a){this.address=a}get(a){return a[this.address]}set(a,b){a[this.address]=b&255}}
class Yg{constructor(a){this.address=a}get(a){return a[this.address]<<16|a[this.address+1]<<8|a[this.address+2]}set(a,b){a[this.address]=b>>>16&255;a[this.address+1]=b>>>8&255;a[this.address+2]=b&255}};class Zg extends Sc{constructor(a,b){super(a,b);this.base=(b&3)<<2|(b&252)<<6|16624;this.colors=Db(a.prg,this.base,4)}color(a){return this.colors[a]&63}};class $g extends Sc{constructor(a,b,c){super(a,b);this.pixels=c||Db(a.chr,b<<4,16)}pixelAt(a,b){return(this.pixels[a|8]>>b&1)<<1|this.pixels[a]>>b&1}flipH(){return new $g(this.rom,-1,this.pixels.map(Ib))}flipV(){return new $g(this.rom,-1,v(16,a=>this.pixels[a&8|~a&7]))}flip(a){let b=this;a&ah.HORIZONTAL&&(b=b.flipH());a&ah.VERTICAL&&(b=b.flipV());return b}write(){const a=this.id<<4;this.rom.chr.subarray(a,a+16).set(this.pixels);return[]}}var ah,bh=ah||(ah={});bh[bh.HORIZONTAL=64]="HORIZONTAL";
bh[bh.VERTICAL=128]="VERTICAL";class ch{constructor(a){this.rom=a;this.values=Db(a.prg,dh.offset,64)}write(){const a=this.rom.assembler();dh.loc(a);a.byte(...this.values);return[a.module()]}}const dh=C.of(y.$1a,38884);const {$0d:eh,$fe:fh,$ff:gh}=y;
class hh{constructor(a){this.rom=a;this.patk=Array(48).fill(0);this.pdef=Array(48).fill(0);this.php=Array(48).fill(0);this.exp=Array(48).fill(0);this.setPAtkFormula(a=>5+15*a/32);this.setPDefFormula(a=>a);this.setPhpFormula(a=>48+5.5*a);this.setExpScalingFactor(1)}setExpScalingFactor(a){this.setExpFormula(b=>Math.floor(4*Math.pow(2,(16+9*b)/32)*a))}setPAtkFormula(a){this.patk=this.patk.map((b,c)=>Math.round(8*a(c)))}setPDefFormula(a){this.pdef=this.pdef.map((b,c)=>Math.round(4*a(c)))}setPhpFormula(a){this.php=
this.php.map((b,c)=>Math.min(255,Math.max(5,Math.round(a(c)))))}setExpFormula(a){this.exp=this.exp.map((b,c)=>{b=a(c);return 128>b?b:Math.min(255,128+(b>>4))})}write(){const a=this.rom.assembler();dc(a,[eh,fh,gh],"DiffAtk");a.byte(...this.patk);dc(a,[eh,fh,gh],"DiffDef");a.byte(...this.pdef);dc(a,[eh,fh,gh],"DiffHP");a.byte(...this.php);dc(a,[eh,fh,gh],"DiffExp");a.byte(...this.exp);return[a.module()]}};class ih extends Sc{constructor(a,b){super(a,b);this.used=!0;this.tiles=Db(a.prg,(255<b?64+b:b)<<8,240)}clone(a){a=new ih(this.rom,a);a.used=this.used;a.tiles=[...this.tiles];return a}allTilesSet(){return new Set(this.tiles)}set2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){const f=e[b];null!=f&&(this.tiles[a+d<<4|c+b]=f)}}}assemble(a){const b=this.id.toString(16).padStart(2,"0");let c=this.tiles;if(this.rom.compressedMapData||256>this.id){const b=
(this.id>>5).toString(16).padStart(2,"0");a.segment(b);"0a"===b&&(c=c.slice(192))}else a.segment("0a"),c=c.slice(0,192);a.org(32768|(this.id&63)<<8,`Screen_${b}`);a.byte(...c)}}
class jh extends Array{constructor(a){super(259);this.rom=a;this.unallocated=[];for(let b=0;259>b;b++)this[b]=new ih(a,b)}getScreen(a){const b=0>a?this.unallocated:this,c=0>a?~a:a;return b[c]||(b[c]=new ih(this.rom,a))}setScreen(a,b){(0>a?this.unallocated:this)[0>a?~a:a]=b}deleteScreen(a){delete (0>a?this.unallocated:this)[0>a?~a:a]}write(){const a=this.rom.assembler();for(const b of this)(null===b||void 0===b?0:b.used)&&b.assemble(a);return[a.module()]}};const {$0e:kh}=y;class lh extends Array{constructor(a){super(128);this.rom=a;for(a=0;128>a;a++)this[a]=a}swap(a,b){if(a!==b){var c=this[a];this[a]=this[b];this[b]=c}}write(){const a=this.rom.assembler();dc(a,[kh],"CheckToItemGetMap");a.byte(...this);return[a.module()]}};const {$0e:mh,$fe:nh,$ff:oh}=y;var ph,qh=ph||(ph={});qh[qh.TORNEL=0]="TORNEL";qh[qh.ZEBU=1]="ZEBU";qh[qh.ASINA=2]="ASINA";qh[qh.KENSU=3]="KENSU";var rh,sh=rh||(rh={});sh[sh.INSUFFICIENT_MAGIC=0]="INSUFFICIENT_MAGIC";sh[sh.FREE_MAGIC=1]="FREE_MAGIC";sh[sh.IGNORED=2]="IGNORED";sh[sh.DEFAULT=3]="DEFAULT";
class th{constructor(a){this.rom=a;this.sages=v(4,a=>new uh(this,a));this.resultTable=Db(a.prg,115247,64);a.telepathyTablesAddress?(this.groupsByLocation=[],this.minimumLevels=[]):(this.groupsByLocation=Db(a.prg,121076,256),this.minimumLevels=Db(a.prg,115219,7))}write(){var a=this.rom.telepathyTablesAddress;const b=this.rom.assembler();b.segment(mh.name,nh.name,oh.name);if(a)for(cc(b,mh,39156,39680),a=this.sages.map((a,c)=>{b.reloc(`Telepathy_Sage_${c}`);c=b.pc();b.byte(...a.messageGroups[0].bytes());
return c}),b.org(33327,"Telepathy_ResultTable"),b.byte(...this.resultTable.map(a=>4>a?a:a>>>1)),b.reloc("TelepathyTable"),b.export("TelepathyTable"),b.label("TelepathyTable"),b.word(...a),a=1;4>a;a++)for(var c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);else{cc(b,mh,39500,39680);b.org(33327,"Telepathy_ResultTable");b.byte(...this.resultTable);b.org(33299,"Telepathy_LevelsTable");b.byte(...this.minimumLevels);b.org(39156,"Telepathy_LocationTable");b.byte(...this.groupsByLocation);b.org(39468,
"Telepathy_VanillaDefaultsTable");for(a=0;4>a;a++)for(c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);a=[];for(c=0;4>c;c++){const d=this.sages[c];for(let e=0,f=d.messageGroups.length;e<f;e++)b.reloc(`Telepathy_Sage_${c}_Group_${e}`),a[4*e+c]=b.pc(),b.byte(...d.messageGroups[e].bytes())}b.org(39412,"Telepathy_VanillaMainTable");b.word(...a)}return[b.module()]}}
class uh{constructor(a,b){this.telepathy=a;this.sage=b;const c=a.rom;let d,e;c.telepathyTablesAddress?(e=d=c.telepathyTablesAddress+2*b,a=1):(d=121388+2*b,e=121332+2*b,a=7);this.defaultMessages=v(4,a=>Be.from(c.prg,d+8*a));this.messageGroups=v(a,a=>vh.from(c.prg,e+8*a))}}
class vh{constructor(a){this.messages=a}bytes(){const a=[];for(let b=0,c=this.messages.length;b<c;b++){const [d,e,f]=this.messages[b];let g=0<=d?d:8192|~d;b===c-1&&(g|=32768);f&&(g|=16384);a.push(g>>=8,g&255,...e.data,...f?f.data:[])}return a}static from(a,b){const c=new vh([]);b=Lb(a,b)+81920;let d=0;for(;!(d&32768);){d=Kb(a,b);b+=2;var e=d&8191;d&8192&&(e=~e);e=[e,Be.from(a,b)];b+=2;d&16384&&(e.push(Be.from(a,b)),b+=2);c.messages.push(e)}return c}};class wh extends Sc{constructor(a,b){super(a,b);this.base=255865+(b<<3);this.pages=Db(a.prg,this.base,8)}};class xh extends Sc{constructor(a,b){super(a,b);this.effects=Db(a.prg,this.base,256)}get base(){return this.id<<8&8191|73728}get org(){return this.id<<8&8191|40960}write(){const a=this.rom.assembler();a.segment("09","fe","ff");a.org(this.org,`TileEffects_${this.id.toString(16)}_Tiles`);a.byte(...this.effects);return[a.module()]}}xh.PIT=1;xh.NO_WALK=2;xh.IMPASSIBLE=4;xh.ALTERNATIVE=8;xh.BEHIND=16;xh.SLOPE=32;xh.SLOW=64;xh.PAIN=128;class yh{constructor(a,b){this.tileset=a;this.id=b;this.copiedFrom=-1}get tiles(){return[0,1,2,3].map(a=>this.tileset.tiles[a][this.id])}setTiles(a){for(let b=0;4>b;b++){const c=a[b];null!=c&&(this.tileset.tiles[b][this.id]=c)}return this}get alternative(){const a=32>this.id?this.tileset.alternates[this.id]:this.id;return a!==this.id?a:null}setAlternative(a){if(32<=this.id)return this;this.tileset.alternates[this.id]=null!=a?a:this.id;this.tileset.effects().effects[this.id]|=8;return this}get attrs(){return this.tileset.attrs[this.id]}setAttrs(a){this.tileset.attrs[this.id]=
a;return this}get effects(){return this.tileset.effects().effects[this.id]}setEffects(a){this.tileset.effects().effects[this.id]=a;return this}copyFrom(a){const b=new yh(this.tileset,a);this.copiedFrom=a;this.setTiles(b.tiles);32>(this.id|b.id)&&this.setAlternative(b.alternative);this.setAttrs(b.attrs);this.setEffects(b.effects);return this}replaceIn(...a){if(0>this.copiedFrom)throw Error("Must copyFrom first.");for(const b of a)b.replace(this.copiedFrom,this.id);return this}};class zh{constructor(a){this.rom=a;this.tilesets=[];for(let b=128;176>b;b+=4)this.tilesets.push(this[b]=new Ah(a,b))}[Symbol.iterator](){return this.tilesets[Symbol.iterator]()}}
class Ah extends Sc{constructor(a,b){super(a,b);this.tiles=v(4,b=>Db(a.prg,this.tileBase|b<<8,256));this.attrs=v(256,b=>a.prg[this.attrBase|b>>2]>>((b&3)<<1)&3);this.alternates=Db(a.prg,this.alternatesBase,32)}get map(){return this.id&63}get tileBase(){return 65536|this.map<<8}get attrBase(){return 77824|this.map<<4}get alternatesBase(){return 81408|this.map<<3}getTile(a){return new yh(this,a)}write(){const a=v(64,a=>{a<<=2;return this.attrs[a]&3|(this.attrs[a+1]&3)<<2|(this.attrs[a+2]&3)<<4|(this.attrs[a+
3]&3)<<6}),b=this.rom.assembler(),c=`Tileset_${this.id.toString(16).padStart(2,"0")}`;b.segment("08","09");b.org(32768|this.map<<8,`${c}_Tiles`);b.byte(...[].concat(...this.tiles));b.org(45056|this.map<<4,`${c}_Attrs`);b.byte(...a);b.org(48640|this.map<<3,`${c}_Alternates`);b.byte(...this.alternates);return[b.module()]}effects(){let a=this.id>>>2&15;168===this.id&&(a=2);172===this.id&&a--;return this.rom.tileEffects[a]}};class Bh{constructor(a){this.rom=a;this.locations=Db(a.prg,Ch.offset,12);this.thunderSwordWarp=[a.prg[251338],a.prg[251342]]}write(){const a=this.rom.assembler();Ch.loc(a);a.label("TownWarpTable");a.byte(...this.locations);a.org(56460);a.instruction("lda","TownWarpTable,y");a.org(54729);a.instruction("lda","#"+this.thunderSwordWarp[0]);a.org(54733);a.instruction("lda","#"+this.thunderSwordWarp[1]);return[a.module()]}}const Ch=C.of(y.$fe,56408);const Dh=new Set([131,135,136,137,143,147,150,152,155,156,157,158,159,170,179,181,185,190,192]);
class Eh extends Sc{constructor(a,b){super(a,b);this.used=!Dh.has(b);this.pointer=123258+((b&127)<<1);this.base=Gb(a.prg,this.pointer,81920);this.conditions=[];this.message=Be.of({});this.flags=[];let c=this.base;do{b=Kb(a.prg,c);var d=b&4095;this.conditions.push(b&8192?~d:d);c+=2}while(!(b&32768));this.message=Be.from(a.prg,c);do c+=2,b=Kb(a.prg,c),d=b&4095,this.flags.push(b&32768?~d:d);while(!(b&16384))}bytes(){const a=[];this.conditions.length||this.conditions.push(-1);for(var b=0;b<this.conditions.length;b++){var c=
this.conditions[b];0>c&&(c=~c|8192);b===this.conditions.length-1&&(c|=32768);a.push(c>>>8,c&255)}a.push(...this.message.data);this.flags.length||this.flags.push(-1);for(b=0;b<this.flags.length;b++)c=this.flags[b],0>c&&(c=~c|32768),b===this.flags.length-1&&(c|=16384),a.push(c>>>8,c&255);return a}write(){if(!this.used)return[];const a=this.rom.assembler(),b=`Trigger_${x(this.id)}`;a.segment("0f");a.reloc(b);const c=a.pc();a.byte(...this.bytes());a.org(41338+2*(this.id&127),b+"_Ptr");a.word(c);return[a.module()]}}
;class Fh{constructor(a){this.rom=a;this.locations=Db(a.prg,Gh.offset,16)}write(){const a=this.rom.assembler();Gh.loc(a);a.label("WildWarpLocations");a.byte(...this.locations);a.org(52185);a.instruction("lda","WildWarpLocations,y");return[a.module()]}}const Gh=C.of(y.$fe,52204);const {$0e:Hh,$0f:Ih,$10:Jh}=y;
class Kh{constructor(a){this.modules=[];const b=16+(a[6]&4?512:0),c=b+16384*a[4];this.prg=a.subarray(b,c);this.chr=a.subarray(c);this.shopCount=Kh.SHOP_COUNT.get(a);this.scalingLevels=Kh.SCALING_LEVELS.get(a);this.uniqueItemTableAddress=Kh.UNIQUE_ITEM_TABLE.get(a);this.shopDataTablesAddress=Kh.SHOP_DATA_TABLES.get(a);this.telepathyTablesAddress=Kh.TELEPATHY_TABLES.get(a);this.omitItemGetDataSuffix=Kh.OMIT_ITEM_GET_DATA_SUFFIX.get(a);this.omitLocalDialogSuffix=Kh.OMIT_LOCAL_DIALOG_SUFFIX.get(a);this.compressedMapData=
Kh.COMPRESSED_MAPDATA.get(a);for(const a of Lh){const [b,c,d]=a;this.prg[b]===c&&(this.prg[b]=d)}this.tilesets=new zh(this);this.tileEffects=v(11,a=>new xh(this,a+179));this.screens=new jh(this);this.metatilesets=new Og(this);this.metascreens=new Mg(this);this.triggers=v(67,a=>new Eh(this,128|a));this.patterns=v(this.chr.length>>4,a=>new $g(this,a));this.palettes=v(256,a=>new Zg(this,a));this.locations=new ye(this);this.tileAnimations=v(4,a=>new wh(this,a));this.hitboxes=v(24,a=>new Rf(this,a));this.objectActions=
new Tg(this);this.objects=new Ug(this);this.adHocSpawns=v(96,a=>new vf(this,a));this.metasprites=v(256,a=>new Ng(this,a));this.messages=new hg(this);this.telepathy=new th(this);this.itemGets=new Zf(this);this.items=new pf(this);this.shops=new Uc(this);this.slots=new lh(this);this.npcs=new He(this);this.bossKills=v(14,a=>new wf(this,a));this.wildWarp=new Fh(this);this.townWarp=new Bh(this);this.coinDrops=new Cf(this);this.flags=new Pf(this);this.bosses=new zf(this);this.scaling=new hh(this);this.randomNumbers=
new ch(this);for(const a of this.locations)a.used&&a.lazyInitialization()}trigger(a){if(128>a||255<a)throw Error(`Bad trigger id $${x(a)}`);return this.triggers[a&127]}get projectiles(){const a=new Set;for(const b of this.objects.filter(a=>a instanceof F))b.child&&a.add(this.objects[this.adHocSpawns[b.child].objectId]);return[...a].sort((a,c)=>a.id-c.id)}get monsterGraphics(){const a={};for(const b of this.locations)if(b.used&&b.hasSpawns)for(const c of b.spawns)if(!(c.data[2]&7)){const d=c.data[2]&
128?1:0,e=x(c.data[3]+80);(a[e]=a[e]||{})[`${d}:${b.spritePatterns[d].toString(16)}:${b.spritePalettes[d].toString(16)}`]={pal:b.spritePalettes[d],pat:b.spritePatterns[d],slot:d}}return a}get locationMonsters(){const a={};for(const b of this.locations){if(!b.used||!b.hasSpawns)continue;const c=a["$"+x(b.id)]={};for(const a of b.spawns)if(!(a.data[2]&7)){const b=a.data[2]&128?1:0,d=a.data[3]+80;c[`${b}:${d.toString(16)}`]=(c[`${b}:${d.toString(16)}`]||0)+1}}return a}assembler(){return new La}writeData(a){a=
void 0===a?this.prg:a;var b,c=this.assembler();cc(c,Hh,34682,35165);cc(c,Hh,35557,39156);cc(c,Hh,40422,40960);cc(c,Ih,40960,41222);cc(c,Ih,41472,41920);cc(c,Jh,37146,37992);const d=[...this.modules,c.module()];c=a=>{for(const b of a)d.push(...b.write())};d.push(...this.locations.write());c(this.objects);c(this.hitboxes);c(this.triggers);d.push(...this.npcs.write());c(this.tilesets);c(this.tileEffects);c(this.adHocSpawns);d.push(...this.itemGets.write());d.push(...this.slots.write());d.push(...this.items.write());
d.push(...this.shops.write());c(this.bossKills);c(this.patterns);d.push(...this.wildWarp.write());d.push(...this.townWarp.write());d.push(...this.coinDrops.write());d.push(...this.scaling.write());d.push(...this.bosses.write());d.push(...this.randomNumbers.write());d.push(...this.telepathy.write());d.push(...this.messages.write());d.push(...this.screens.write());c=new Va;c.base(this.prg,0);for(const a of d)c.read(a);c.link().apply(a);a===this.prg&&(a=c.exports(),this.uniqueItemTableAddress=a.get("KeyItemData").offset,
this.shopCount=11,this.shopDataTablesAddress=(null===(b=a.get("ShopData"))||void 0===b?void 0:b.offset)||0,Kh.SHOP_COUNT.set(this.prg,this.shopCount),Kh.SCALING_LEVELS.set(this.prg,this.scalingLevels),Kh.UNIQUE_ITEM_TABLE.set(this.prg,this.uniqueItemTableAddress),Kh.SHOP_DATA_TABLES.set(this.prg,this.shopDataTablesAddress||0),Kh.OMIT_ITEM_GET_DATA_SUFFIX.set(this.prg,this.omitItemGetDataSuffix),Kh.OMIT_LOCAL_DIALOG_SUFFIX.set(this.prg,this.omitLocalDialogSuffix),Kh.COMPRESSED_MAPDATA.set(this.prg,
this.compressedMapData))}analyzeTiles(){}disjointTilesets(){var a=[];for(var b of this.locations)if(b.used){var c=b.tileset;for(const d of b.screens)for(const b of d)(a[b]||(a[b]=new Set)).add(c)}b=v(256,()=>new fd);for(c=0;c<a.length;c++)if(a[c])for(var d of this.screens[c].allTilesSet())b[d].union([...a[c]]);for(a=0;a<b.length;a++)d=b[a].sets().map(a=>[...a].map(x).join(" ")).join(" | "),console.log(`Tile ${x(a)}: ${d}`)}swapMetatiles(a,...b){var c=new Map,d=v(256);const e=new Map,f=a=>Array.isArray(a)?
a[0]:0>a?~a:a;for(var g of b){for(var h=0;h<g.length-1;h++)if(Array.isArray(g[h])){var l=g[h];e.set(l[0],l[1]);g[h]=l[0]}for(h=0;h<g.length-1;h++){l=g[h];const a=g[h+1];0>l||0>a||(c.set(a,l),d[a]=l)}}g=new Set;c=new Set;a=new Set(a);for(var q of this.locations)if(q.used&&a.has(q.tileset)){c.add(q.tileEffects);for(var p of q.allScreens())g.add(p)}for(var z of g)for(let a=0,b=z.tiles.length;a<b;a++)z.tiles[a]=d[z.tiles[a]];for(var B of a){d=this.tilesets[B];for(var A of b)for(q=0;q<A.length-1;q++){p=
f(A[q]);z=f(A[q+1]);for(a=0;4>a;a++)d.tiles[a][p]=d.tiles[a][z];d.attrs[p]=d.attrs[z];if(32>z&&d.alternates[z]!==z){if(32<=p)throw Error(`Cannot unflag: ${B} ${p} ${z} ${d.alternates[z]}`);d.alternates[p]=d.alternates[z]}}for(var w of e){const [a,b]=w;d.alternates[a]=b}}for(const a of c){B=this.tileEffects[a-179];for(const a of b)for(A=0;A<a.length-1;A++)w=f(a[A]),d=f(a[A+1]),B.effects[w]=B.effects[d];for(const a of e.keys())B.effects[a]|=8}}moveFlag(a,b){function c(c){for(let d=0;d<c.length;d++)c[d]===
a&&(c[d]=b),c[d]===~a&&(c[d]=~b)}for(const a of this.triggers)c(a.conditions),c(a.flags);for(const d of this.npcs){for(const a of d.spawnConditions.values())c(a);for(const c of[d.globalDialogs,...d.localDialogs.values()])for(const d of c)d.condition===a&&(d.condition=b),d.condition===~a&&(d.condition=~b)}if(512===(a&-256)&&512===(b&-256))for(const c of this.locations)for(const d of c.flags)d.flag===a&&(d.flag=b)}nextFreeTrigger(){for(const a of this.triggers)if(!a.used)return a;throw Error("Could not find an unused trigger.");
}moveScreens(a,b){if(!this.compressedMapData)throw Error("Must compress maps first.");const c=new Map;for(b<<=8;this.screens[b];)b++;for(var d of a)if(!(256<=d.sid)){var e=d.sid;if(!c.has(e)){var f=d.sid=b++;c.set(e,f);c.set(f,f)}}for(const g of this.locations)if(g.tileset==a.tilesetId){d=!1;b=!0;for(const a of g.screens)for(e=0;e<a.length;e++)f=c.get(a[e]),null!=f?(a[e]=f,d=!0):b=!1;if(d&&!b)throw Error("Inconsistent move");}}static load(a,b){return k.asyncExecutePromiseGeneratorFunction(function*(){const c=
yield Mh(b);a&&(yield a(c));return new Kh(c)})}}Kh.OMIT_ITEM_GET_DATA_SUFFIX=Vg.bit(82624,0);Kh.OMIT_LOCAL_DIALOG_SUFFIX=Vg.bit(82624,1);Kh.COMPRESSED_MAPDATA=Vg.bit(82624,2);Kh.SHOP_COUNT=Vg.byte(82625);Kh.SCALING_LEVELS=Vg.byte(82626);Kh.UNIQUE_ITEM_TABLE=Vg.address(82640);Kh.SHOP_DATA_TABLES=Vg.address(82643);Kh.TELEPATHY_TABLES=Vg.address(82646);
function Mh(a){a||(a=a=>document.body.appendChild(a));return new Promise(a=>{if("#reset"!==window.location.hash){const b=localStorage.getItem("rom");if(b)return a(Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))))}const b=document.createElement("input");document.body.appendChild(b);b.type="file";b.addEventListener("change",()=>{const c=b.files[0],e=new FileReader;e.addEventListener("loadend",()=>{const c=new Uint8Array(e.result),d=Array.from(c,x).join("");
localStorage.setItem("rom",d);b.remove();a(c)});e.readAsArrayBuffer(c)})})}
const Lh=[[79430,2,6],[83272,86,80],[83306,0,255],[83343,56,48],[83480,96,112],[83494,168,160],[83507,21,22],[83511,21,22],[84305,168,160],[84307,152,144],[84505,120,112],[84715,9,255],[84809,128,136],[84871,32,48],[84890,1,2],[84894,1,2],[85433,8,128],[85750,104,96],[87133,255,0],[87145,120,112],[88070,152,160],[88074,152,160],[88078,88,80],[88093,0,255],[88142,219,255],[88181,120,112],[88911,120,128],[89007,240,128],[89014,223,128],[89015,150,128],[89315,223,207],[89326,110,109],[89330,110,109],
[89486,223,207],[89489,46,45],[89493,46,45],[89658,216,223],[89913,120,112],[89920,2,255],[89953,141,255],[89957,141,255],[91133,72,64],[91139,85,80],[91227,216,223],[91340,4,32],[91391,11,10],[91661,32,48],[91684,1,2],[91688,1,2],[93616,154,128],[93620,158,128],[93624,145,128],[93628,158,128],[93632,145,128],[93672,0,255],[93677,223,208],[93688,12,92],[93689,176,185],[93690,0,2],[93692,12,92],[93693,176,185],[93694,0,2],[93695,7,255],[93789,2,255],[93802,173,255],[93806,173,255],[94209,2,255],[94254,
183,255],[94258,183,255],[94379,3,255],[94383,2,255],[94387,5,255],[94391,6,255],[94395,0,255],[94404,178,255],[94408,178,255],[94412,177,255],[94416,177,255],[94420,179,255],[94424,179,255],[94428,181,255],[94432,181,255],[94436,181,255],[94440,181,255],[95470,128,136],[96193,136,128],[96197,152,160],[96199,88,80],[96298,16,1],[96343,16,1],[96596,128,120],[96674,128,120],[97162,0,64],[97168,0,64],[97230,0,64],[97236,0,64],[97294,0,64],[97300,0,64],[97358,0,64],[97364,0,64],[106242,64,128],[106243,
51,50],[106976,64,192],[106977,61,52],[118533,71,72],[119569,32,160],[119570,48,0],[118777,96,224],[182928,2,0],[193907,2,0],[195300,95,0]];Array.prototype.flatMap||Object.defineProperties(Array.prototype,{flatMap:{value(a){const b=[];let c=0;for(const d of this){let e=a(d,c++);"function"!==typeof e[Symbol.iterator]&&(e=[e]);e=[...e];e.length&&b.push(...e)}return b}}});const Nh=[[/\b(sort)\b/,"sword"],[/\b(sorta)\b/,"sword of"],[/\b(win)\b/,"wind"],[/\bketostix\b/,"key 2 styx"],[/\bketo\b/,"key 2"],[/\b(sticks|stick c|stix e|stick sea|dixie|sticks e|stick see|sexy|60|sixty)\b/,"styx"],[/\b(arraylist|gorilla[sz]|aurelius|h?airless|a realist|arl[eiy]ss?)\b/,"aryllis"],[/\b(amazon us|amazon[ae]?ss?|amazon)\b/,"amazones"],[/\bamazones basement\b/,"aryllis basement"],[/\b(deal|dil|diehl)\b/,"deo"],[/\b(ds|deals|diaz|delos|drose|theos)\b/,"deos"],[/\bone\b/,"1"],[/\b(two|ii|to|too)\b/,
"2"],[/\bthree\b/,"3"],[/\bfour\b/,"4"],[/\bar[ck]s tom\b/,"ark stom"],[/\borbit\b/,"orb of"],[/\borb\n/,"ball"],[/^(contract|amtrack|ontra(c|k|ck))\b/,"untrack"],[/^((ch|tr)[eu](c|k|ck))\b/,"track"],[/^track ?suit\b/,"track flute"],[/\b(floote|food)\b/,"flute"],[/\b(lyme|lion)\b/,"lime"],[/mark(s|ed)\b/,"mark"],[/^(marc|mach|smart|[bp]ark)\b/,"mark"],[/\blee felder\b/,"leaf elder"],[/^markley f/,"mark leaf "],[/^(mark of|market)\b/,"mark"],[/\bleif\b/,"leaf"],[/\beldar\b/,"elder"],[/\blight\b/,"flight"],
[/\bmann\b/,"moon"],[/^trackball\b/,"track bow"],[/\bbosemann?\b/,"bow of moon"],[/\b(bo(we)?)\b/,"bow"],[/\b(certifier|start a fire)\b/,"sword of fire"],[/\bwhen milky\b/,"windmill key"],[/^(4 clear|faux clear|folklore|so ?clear|pho clear)\b/,"full clear"],[/\b(mayo|meto|nato|mader|meadow|matter|ma[dt]er|motto|model)\b/,"mado"],[/\bcalvey\b/,"kelby"],[/\b(kelbyone|lv ?1)\b/,"kelby 1"],[/\blv ?2\b/,"kelby 2"],[/\b(carmine|carmen|combine)\b/,"karmine"],[/\b(dra[gk][ao]n)\b/,"draygon"],[/\b([cs][ae][bdgv][aeiu]*r[ae]|xavier)\b/,
"sabera"],[/\b(wright|rite|write)\b/,"right"],[/\b([ck]or[bd]el[le]?|quadrel)\b/,"cordel"],[/\b(hotel desk|(bel)?l desk|kill basque|kehl basc|caleb ask(ed)?)\b/,"kelby"],[/\b(porter|port[eo]la|porto a)\b/,"portoa"],[/\b(athena|cena|tina|isina|esquina)\b/,"asina"],[/\b((at the|ec[hk]o) h[ao]nn?ah?|alcohol(ic)?)\b/,"akahana"],[/\b((roca|broke[nr]|brokaw|barr?oca) hann?ah?|bro k[ao]h[ao]na|pokehana)\b/,"brokahana"],[/\b(stoned)\b/,"stone"],[/\b(roc[ck]a? ?(honda|ohana|h[oa]nn?ah?|auto))\b/,"stone akahana"],
[/\b(guards)\b/,"guard"],[/\b(window)\b/,"windmill"],[/\b(sa[bv][eo]r)\b/,"sabre"],[/\bsabre south\b/,"sabre west"],[/\b(hebrew|cebu|sebba|zabel)\b/,"zebu"],[/\b([bct]([aou]r|r[aou])nn?ell?)\b/,"tornel"],[/\b(clarke)\b/,"clark"],[/\bsabera 1 left\b/,"sabera fortress left"],[/\bsabera 1 right\b/,"sabera fortress right"],[/\b(cantu|cancel|can sue|kincer|kenzo|cancer)\b/,"kensu"],[/\b(light house)\b/,"lighthouse"],[/\bkensu(?: in)? (lighthouse|swan)\b/,"$1"],[/\b(kensu slime|slime kensu)\b/,"slime"],
[/\bunderground channel\b/,"channel"],[/\b(?:mount|mt) (sabre|hydra)\b/,"$1"],[/\b([ck]h?[au]r[iu]ss?[aou])\b/,"kirisa"],[/\bmado (lower|upper)\b/,"mado 2 $1"],[/\bsabera( 2)? (level|chest|sewer)\b/,"sabera 2 level"],[/\b(script|richt)\b/,"crypt"],[/\bdraygon 1\b/,"draygon"],[/\besi\b/,"evil spirit island"],[/\bsabre north summit\b/,"sabre summit"],[/\bkirisa plant cave\b/,"kirisa cave"],[/\b(windmill|vampire) cave\b/,"sealed cave"],[/^((?:un)?)ma[urxkcs ]*t[io]me?(?: fight)?/,"$1mark stom"],[/\b(bow|flute)\b/,
"$1 of"],[/\bof( of)+\b/,"of"],[/ of$/,""]],Oh=new Map([["sealed cave",["sealed cave front","sealed cave back","vampire 1"]],["styx",["styx left","styx right"]],["oak",["oak elder","oak mother"]],["sabre west",["sabre west slope","sabre west","tornel"]],["sabre north",["sabre north","kelby 1","sabre summit"]],["waterfall cave",["waterfall cave","stone akahana"]],["fog lamp",["fog lamp front","fog lamp back"]],["kirisa plant",["kirisa cave","kirisa meadow"]],["karmine",["karmine basement","karmine",
"behind karmine","slime"]],["amazones",["aryllis","aryllis basement"]],["mado 2",["mado 2","mado 2 upper","mado 2 lower"]],["pyramid",["pyramid","draygon"]],["hydra",["hydra front","hydra back","hydra summit"]],["sabera 1",["sabera fortress left","sabera fortress right","vampire 2","sabera 1","clark"]],["oasis cave",["oasis cave","oasis cave flight","oasis cave center"]],["sabera 2",["sabera 2","sabera 2 level"]]]),Ph=[[0,121,192,"leaf elder","sword of wind"],[1,274,176,"oak elder","sword of fire"],
[2,335,123,"waterfall cave","sword of water"],[3,77,10,"styx left","sword of thunder"],[5,89,107,"sealed cave front","ball of wind"],[6,115,224,"sabre west slope","tornado bracelet"],[7,282,187,"insect","ball of fire"],[8,47,182,"kelby 1","flame bracelet"],[9,251,232,"rage","ball of water"],[10,206,249,"aryllis basement","blizzard bracelet"],[11,83,63,"mado 1","ball of thunder"],[12,23,9,"behind karmine","storm bracelet"],[18,49,48,"mado 2","sacred shield"],[20,77,2,"styx right","psycho shield"],
[118,70,3,"styx right"],[119,84,3,"styx right"],[27,168,96,"oasis cave flight","battle armor"],[28,199,110,"draygon","psycho armor"],[29,82,95,"sealed cave back"],[30,82,101,"sealed cave back"],[31,346,147,"fog lamp front"],[112,346,153,"fog lamp front"],[113,346,159,"fog lamp front"],[32,126,52,"hydra front"],[33,227,97,"sabera fortress left"],[34,256,73,"evil spirit island"],[35,58,115,"sabera 2"],[36,82,113,"sealed cave front"],[37,189,180,"cordel grass","statue of onyx"],[38,18,172,"kelby 2"],
[39,267,185,"oak mother","insect flute"],[40,275,147,"portoa queen","flute of lime"],[41,147,206,"akahana","gas mask"],[42,172,104,"oasis cave center","power ring"],[43,203,5,"brokahana","warrior ring"],[44,249,69,"evil spirit island","iron necklace"],[45,191,110,"deo","deos pendant"],[46,89,99,"vampire 1","rabbit boots"],[47,164,104,"oasis cave","leather boots"],[48,319,123,"stone akahana","shield ring"],[114,320,130,"waterfall cave"],[50,105,94,"windmill guard","windmill key"],[51,64,198,"sabre north",
"key 2 prison"],[52,83,71,"zebu","key 2 styx"],[53,345,140,"fog lamp back","fog lamp"],[54,301,119,"dolphin","shell flute"],[55,233,118,"clark","eye glasses"],[56,234,88,"sabera 1","broken statue"],[57,295,92,"lighthouse","glowing lamp"],[58,234,49,"altar","statue of gold"],[59,274,117,"channel","love pendant"],[60,338,226,"kirisa meadow","kirisa plant"],[61,23,17,"karmine","ivory statue"],[62,206,241,"aryllis","bow of moon"],[63,101,6,"hydra summit","bow of sun"],[64,207,110,"draygon","bow of truth"],
[65,92,117,"windmill","refresh"],[66,279,126,"sabre summit","paralysis"],[67,202,138,"stom","telepathy"],[68,124,202,"tornel","teleport"],[69,304,128,"asina","recover"],[70,248,35,"whirlpool","barrier"],[71,277,3,"swan","change"],[72,15,25,"slime","flight"],[80,82,107,"sealed cave front"],[82,134,219,"sabre west"],[83,59,219,"sabre north"],[84,52,55,"mado 2 upper"],[85,241,97,"sabera fortress right"],[86,123,23,"hydra front"],[116,115,3,"hydra back"],[87,70,9,"styx left"],[117,84,9,"styx left"],[88,
32,38,"karmine basement"],[121,32,16,"karmine basement"],[122,40,16,"karmine basement"],[123,40,38,"karmine basement"],[90,161,97,"fortress exit"],[16,327,123,"waterfall cave"],[92,256,79,"evil spirit island"],[93,36,139,"sabera 2 level"],[94,14,229,"sabre north"],[95,345,225,"kirisa cave"],[96,18,94,"mado 2 upper"],[97,234,96,"vampire 2"],[98,18,118,"sabera 2 level"],[99,36,54,"mado 2 upper"],[100,175,97,"oasis cave"],[101,139,40,"hydra back"],[102,66,160,"sabera 2 level"],[105,131,201,"sabre west"],
[106,76,226,"sabre west"],[107,18,100,"mado 2 upper"],[108,193,103,"pyramid"],[120,199,103,"crypt"],[109,205,103,"crypt"],[115,256,67,"evil spirit island"],[110,24,38,"karmine basement"],[111,44,97,"mado 2 lower"]],Qh=new Set([16,18,35,38,97]),Rh=new Set([41,62,68,71,72]);
class Sh{constructor(a,b,c){this.rom=a;this.world=b;this.flags=c;this.slots=new Map;this.items=new Map;this.slotElts=new Map;this.has=new Set;this.tracks=new Map;this.marks=new Map;this.voice=!1;window.GRAPH=this;this.graph=b.getLocationList();this.grid=document.getElementsByClassName("grid")[0];this.map=document.getElementsByClassName("map")[0];a=new m(()=>new Set);for(const b of this.graph.requirements){const [c,d]=b;for(const b of d)for(const d of b)a.get(d).add(c)}this.unlocks=new Map([...a].map(a=>
{var [b,c]=a;return[b,[...c]]}));this.grid.addEventListener("click",a=>{let b=a.target;for(;b&&!b.dataset.slot;)b=b.parentElement;b&&(this.toggle(b),a.preventDefault())})}toggle(a,b){const c=Number(a.dataset.slot);b=a.classList.toggle("got",b);a.dataset.item&&(b?this.has.add(c):this.has.delete(c));this.update()}addSlot(a,b,c,...d){const e=document.createElement("div");var f=this.rom.itemGets[a];if((f=f&&this.rom.items[f.itemId])&&f.unique||Qh.has(a))e.classList.add("key"),b--,c--;b--;c--;e.dataset.slot=
String(a);e.style.left=b+"px";e.style.top=c+"px";b=document.createElement("div");e.appendChild(b);b.textContent=d[0];this.flags.randomizeTrades()&&Rh.has(a)&&e.classList.add("boss");this.slotElts.set(a,e);for(const b of d)a=this.marks.get(b),null==a&&this.marks.set(b,a=[]),a.push(e);this.map.appendChild(e)}addItem(a,b,...c){b=Number.parseInt(b.substring(1),16);const d=document.getElementsByClassName(a)[0],e=document.createElement("div");d.appendChild(e);d.dataset.slot=String(b);d.dataset.item=String(b);
this.tracks.set(a.replace(/-/g," "),d);for(const a of c)this.tracks.set(a.replace(/-/g," "),d)}addExtraFlags(){}update(){for(var a of this.slotElts.values())a.dataset.state=a.classList.contains("got")?"":"blocked";a=this.traverse();for(const b of a)256===(b&-128)&&(a=this.slotElts.get(b&255))&&!a.classList.contains("got")&&(a.dataset.state="available")}traverse(){const a=new Set([...this.has].map(a=>a|512)),b=new Set,c=new Set,d=new Set(this.graph.requirements.keys());for(const f of d)if(d.delete(f),
!b.has(f)){var e=this.graph.requirements.get(f);for(const g of e)if(Th(a,g)){b.add(f);e=[];256===(f&-128)?c.add(f&255):(512===(f&-128)&&e.push(f&255),a.add(f));for(const b of a)for(const a of this.unlocks.get(b)||[]){if(!this.graph.requirements.has(a))throw console.dir(this),Error(`Adding bad node ${a} from unlock ${b}`);d.add(a)}break}}return b}addVoiceRecognition(a){try{const b=this.recognition=new SpeechRecognition,c=new SpeechGrammarList;c.addFromString(`
          #JSGF V1.0;
          grammar command;
          public <item> = ${[...this.tracks.keys()].join(" | ")};
          public <check> = ${[...this.marks.keys()].join(" | ")};
          public <clear> = <check> | ${[...Oh.keys()].join(" | ")};
          public <command> = track <item> | untrack <item> | mark <check> | unmark <check> | clear <clear> | stop listening;
      `,1);b.lang="en-US";b.grammars=c;b.interimResults=!1;b.maxAlternatives=10;b.onstart=()=>{this.voice=!0};b.onresult=c=>{const d=new Set;var f=c.results[c.results.length-1];if(f.isFinal){c=!1;for(var g of f){let b=g.transcript.toLowerCase().replace(/[^a-z ]/g,"");d.add(b);"stop listening"===b&&(c=!0,this.voice=!1,a());for(const a of Nh){const [c,e]=a;b=b.replace(c,e);d.add(b)}if(f=/^(track|untrack|clear|unclear|full clear) (.*)/.exec(b)){if(f[1].endsWith("track")){var h=this.tracks.get(f[2]);
if(!h)continue;this.toggle(h,!f[1].startsWith("un"))}else if(f[1].endsWith("clear")){h=Oh.get(f[2]);if(!h){if(!this.marks.has(f[2]))continue;h=[f[2]]}for(const a of h)for(const b of this.marks.get(a))b.classList.toggle("got",!f[1].startsWith("un"))}c=!0;break}if(f=/^(?:un)?mark(?: (\d+)(?: che(?:st|ck)s?)?(?: in))? (.*)/.exec(b))if(h=this.marks.get(f[2]),f=Number(f[1]||"1"),h&&f){g=!b.startsWith("un");for(const a of h)if(a.classList.contains("got")!==g&&(a.classList.toggle("got",g),0===--f))break;
c=!0;break}}c||console.log(`No match: ${[...d].join(", ")}`);b.stop()}};b.onend=()=>{this.voice&&b.start()};return!0}catch(b){return console.error(b),!1}}startVoice(a){if(!this.recognition&&!this.addVoiceRecognition(a))return!1;this.voice=!0;this.recognition.start();return!0}stopVoice(){this.voice=!1;this.recognition&&this.recognition.stop()}}function Uh(...a){const b=window;for(let c of a)if("function"===typeof b[c]){b[a[0]]=b[c];return}console.error(`Could not polyfill ${a[0]}`)}
Uh("SpeechRecognition","webkitSpeechRecognition");Uh("SpeechGrammarList","webkitSpeechGrammarList");function Th(a,b){for(const c of b)if(!a.has(c))return!1;return!0}let Vh="@Casual";for(const a of location.hash.substring(1).split("&")){const [b,c]=a.split("=");"flags"===b&&(Vh=decodeURIComponent(c))}
k.asyncExecutePromiseGeneratorFunction(function*(){const a=yield Kh.load(We);a.flags.defrag();a.itemGets.actionGrants=new Map([[37,41],[57,58],[59,71],[60,62],[132,70],[178,66],[180,65]]);const b=new lb(Vh);Xe(a,b);const c=new Nd(a,b,!0),d=new Sh(a,c,b);for(let a of";sword-of-wind $00;sword-of-fire $01;sword-of-water $02;sword-of-thunder $03;windmill-key $32;statue-of-onyx $25 onyx-statue;insect-flute $27;key-to-prison $33 prison-key key-2-prison;flute-of-lime $28;;ball-of-wind $05 ball-of-wind;ball-of-fire $07 ball-of-fire;ball-of-water $09 ball-of-water;ball-of-thunder $0b ball-of-thunder;kirisa-plant $3c;alarm-flute $31;fog-lamp $35;shell-flute $36;broken-statue $38;eye-glasses $37 eyeglasses;glowing-lamp $39;;tornado-bracelet $06;flame-bracelet $08;blizzard-bracelet $0a;storm-bracelet $0c;love-pendant $3b;key-to-styx $34 key-2-styx;statue-of-gold $3a gold-statue;sacred-shield $12;ivory-statue $3d;;rabbit-boots $2e;gas-mask $29 hazard-suit hazmat-suit;shield-ring $30;iron-necklace $2c;leather-boots $2f speed-boots;power-ring $2a;warrior-ring $2b;deos-pendant $2d deo;bow-of-moon $3e moon;bow-of-sun $3f sun;;refresh $41;paralysis $42;telepathy $43;teleport $44;recover $45;barrier $46;change $47;flight $48;psycho-armor $1c;bow-of-truth $40 truth;".split(";"))(a=
a.replace(/#.*/,"").trim())&&d.addItem(...a.split(/ +/g));for(const a of Ph)d.addSlot(...a);d.addExtraFlags();d.update();document.getElementById("toggle-map").addEventListener("click",()=>{d.map.classList.toggle("hidden")});document.getElementById("clear-all").addEventListener("click",()=>{for(const a of d.grid.querySelectorAll(".got"))a.classList.remove("got");d.has=new Set;d.update()});const e=document.getElementById("voice");e.addEventListener("click",()=>{d.voice?(d.stopVoice(),e.textContent=
"enable voice"):d.startVoice(()=>e.textContent="enable voice")?e.textContent="disable voice":e.textContent="voice recognition failed"});window.graph=d});}).call(this);
