import { Token } from './token.js';
export class Macro {
    constructor(params, production) {
        this.params = params;
        this.production = production;
    }
    static from(line, source) {
        var _a;
        if (!Token.eq(line[0], Token.MACRO))
            throw new Error(`invalid`);
        if (((_a = line[1]) === null || _a === void 0 ? void 0 : _a.token) !== 'ident')
            throw new Error(`invalid`);
        const params = Token.identsFromCList(line.slice(2));
        const lines = [];
        let next;
        while ((next = source.next())) {
            if (Token.eq(next[0], Token.ENDMACRO))
                return new Macro(params, lines);
            if (Token.eq(next[0], Token.ENDMAC))
                return new Macro(params, lines);
            lines.push(next);
        }
        throw new Error(`EOF looking for .endmacro: ${Token.nameAt(line[1])}`);
    }
    expand(tokens, idGen) {
        let i = 1;
        const replacements = new Map();
        const lines = [];
        for (const param of this.params) {
            const comma = Token.findComma(tokens, i);
            let slice = tokens.slice(i, comma);
            i = comma + 1;
            if (slice.length === 1 && slice[0].token === 'grp') {
                slice = slice[0].inner;
            }
            replacements.set(param, slice);
        }
        if (i < tokens.length) {
            throw new Error(`Too many macro parameters: ${Token.nameAt(tokens[i])}`);
        }
        const locals = new Map();
        for (const line of this.production) {
            if (Token.eq(line[0], Token.LOCAL)) {
                for (const local of Token.identsFromCList(line.slice(1))) {
                    locals.set(local, `${local}@${idGen.next()}`);
                }
            }
            function map(toks) {
                const mapped = [];
                for (const tok of toks) {
                    if (tok.token === 'ident') {
                        const param = replacements.get(tok.str);
                        if (param) {
                            mapped.push(...param);
                            continue;
                        }
                        const local = locals.get(tok.str);
                        if (local) {
                            mapped.push({ token: 'ident', str: local });
                            continue;
                        }
                    }
                    else if (tok.token === 'grp') {
                        mapped.push({ token: 'grp', inner: map(tok.inner) });
                        continue;
                    }
                    const source = tok.source && tokens[0].source ?
                        { ...tok.source, parent: tokens[0].source } :
                        tok.source || tokens[0].source;
                    mapped.push(source ? { ...tok, source } : tok);
                }
                return mapped;
            }
            lines.push(map(line));
        }
        return lines;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFjcm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvYXNtL21hY3JvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxLQUFLLEVBQWMsTUFBTSxZQUFZLENBQUM7QUFTOUMsTUFBTSxPQUFPLEtBQUs7SUFDaEIsWUFBNkIsTUFBZ0IsRUFDaEIsVUFBcUI7UUFEckIsV0FBTSxHQUFOLE1BQU0sQ0FBVTtRQUNoQixlQUFVLEdBQVYsVUFBVSxDQUFXO0lBQUcsQ0FBQztJQUV0RCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQWEsRUFBRSxNQUFtQjs7UUFJNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUM7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hFLElBQUksT0FBQSxJQUFJLENBQUMsQ0FBQyxDQUFDLDBDQUFFLEtBQUssTUFBSyxPQUFPO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDakIsSUFBSSxJQUF1QixDQUFDO1FBQzVCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUU7WUFDN0IsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDO2dCQUFFLE9BQU8sSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUs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LElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUMsQ0FBQyxDQUFDO3dCQUNuRCxTQUFTO3FCQUNWO29CQUNELE1BQU0sTUFBTSxHQUNSLEdBQUcsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUM1QixFQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLENBQUM7d0JBQzNDLEdBQUcsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztvQkFDdkMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxHQUFHLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUM5QztnQkFDRCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1lBQ0QsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUN2QjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtUb2tlbiwgVG9rZW5Tb3VyY2V9IGZyb20gJy4vdG9rZW4uanMnO1xuXG4vLyBjb25zdCBERUJVRyA9IHRydWU7XG4vLyBjb25zdCBbXSA9IFtERUJVR107XG5cbmludGVyZmFjZSBTb3VyY2U8VD4ge1xuICBuZXh0KCk6IFQ7XG59XG5cbmV4cG9ydCBjbGFzcyBNYWNybyB7XG4gIHByaXZhdGUgY29uc3RydWN0b3IocmVhZG9ubHkgcGFyYW1zOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgICAgICAgICByZWFkb25seSBwcm9kdWN0aW9uOiBUb2tlbltdW10pIHt9XG5cbiAgc3RhdGljIGZyb20obGluZTogVG9rZW5bXSwgc291cmNlOiBUb2tlblNvdXJjZSkge1xuICAgIC8vIEZpcnN0IGxpbmUgbXVzdCBzdGFydCB3aXRoIC5tYWNybyA8bmFtZT4gW2FyZ3NdXG4gICAgLy8gTGFzdCBsaW5lIGlzIHRoZSBsaW5lIEJFRk9SRSB0aGUgLmVuZG1hY3JvXG4gICAgLy8gTmVzdGVkIG1hY3JvIGRlZmluaXRpb25zIGFyZSBub3QgYWxsb3dlZCFcbiAgICBpZiAoIVRva2VuLmVxKGxpbmVbMF0sIFRva2VuLk1BQ1JPKSkgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkYCk7XG4gICAgaWYgKGxpbmVbMV0/LnRva2VuICE9PSAnaWRlbnQnKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWRgKTtcbiAgICBjb25zdCBwYXJhbXMgPSBUb2tlbi5pZGVudHNGcm9tQ0xpc3QobGluZS5zbGljZSgyKSk7XG4gICAgY29uc3QgbGluZXMgPSBbXTtcbiAgICBsZXQgbmV4dDogVG9rZW5bXXx1bmRlZmluZWQ7XG4gICAgd2hpbGUgKChuZXh0ID0gc291cmNlLm5leHQoKSkpIHtcbiAgICAgIGlmIChUb2tlbi5lcShuZXh0WzBdLCBUb2tlbi5FTkRNQUNSTykpIHJldHVybiBuZXcgTWFjcm8ocGFyYW1zLCBsaW5lcyk7XG4gICAgICBpZiAoVG9rZW4uZXEobmV4dFswXSwgVG9rZW4uRU5ETUFDKSkgcmV0dXJuIG5ldyBNYWNybyhwYXJhbXMsIGxpbmVzKTtcbiAgICAgIGxpbmVzLnB1c2gobmV4dCk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgRU9GIGxvb2tpbmcgZm9yIC5lbmRtYWNybzogJHtUb2tlbi5uYW1lQXQobGluZVsxXSl9YCk7XG4gIH1cblxuICBleHBhbmQodG9rZW5zOiBUb2tlbltdLCBpZEdlbjogU291cmNlPG51bWJlcj4pOiBUb2tlbltdW10ge1xuICAgIC8vIEZpbmQgdGhlIHBhcmFtZXRlcnMuXG4gICAgLy8gVGhpcyBpcyBhIGxpdHRsZSBtb3JlIHByaW5jaXBsZWQgdGhhbiBEZWZpbmUsIGJ1dCB3ZSBkbyBuZWVkIHRvIGJlXG4gICAgLy8gYSBsaXR0bGUgY2FyZWZ1bC5cbiAgICBsZXQgaSA9IDE7IC8vIHN0YXJ0IGxvb2tpbmcgX2FmdGVyXyBtYWNybyBpZGVudFxuICAgIGNvbnN0IHJlcGxhY2VtZW50cyA9IG5ldyBNYXA8c3RyaW5nLCBUb2tlbltdPigpO1xuICAgIGNvbnN0IGxpbmVzOiBUb2tlbltdW10gPSBbXTtcbiAgICBcbiAgICAvLyBGaW5kIGEgY29tbWEsIHNraXBwaW5nIGJhbGFuY2VkIGN1cmxpZXMuICBQYXJlbnMgYXJlIG5vdCBzcGVjaWFsLlxuICAgIGZvciAoY29uc3QgcGFyYW0gb2YgdGhpcy5wYXJhbXMpIHtcbiAgICAgIGNvbnN0IGNvbW1hID0gVG9rZW4uZmluZENvbW1hKHRva2VucywgaSk7XG4gICAgICBsZXQgc2xpY2UgPSB0b2tlbnMuc2xpY2UoaSwgY29tbWEpO1xuICAgICAgaSA9IGNvbW1hICsgMTtcbiAgICAgIGlmIChzbGljZS5sZW5ndGggPT09IDEgJiYgc2xpY2VbMF0udG9rZW4gPT09ICdncnAnKSB7XG4gICAgICAgIC8vIHVud3JhcCBvbmUgbGF5ZXJcbiAgICAgICAgc2xpY2UgPSBzbGljZVswXS5pbm5lcjtcbiAgICAgIH1cbiAgICAgIHJlcGxhY2VtZW50cy5zZXQocGFyYW0sIHNsaWNlKTtcbiAgICB9XG4gICAgaWYgKGkgPCB0b2tlbnMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRvbyBtYW55IG1hY3JvIHBhcmFtZXRlcnM6ICR7VG9rZW4ubmFtZUF0KHRva2Vuc1tpXSl9YCk7XG4gICAgfVxuICAgIC8vIEFsbCBwYXJhbXMgZmlsbGVkIGluLCBtYWtlIHJlcGxhY2VtZW50XG4gICAgY29uc3QgbG9jYWxzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgdGhpcy5wcm9kdWN0aW9uKSB7XG4gICAgICBpZiAoVG9rZW4uZXEobGluZVswXSwgVG9rZW4uTE9DQUwpKSB7XG4gICAgICAgIGZvciAoY29uc3QgbG9jYWwgb2YgVG9rZW4uaWRlbnRzRnJvbUNMaXN0KGxpbmUuc2xpY2UoMSkpKSB7XG4gICAgICAgICAgLy8gcGljayBhIG5hbWUgdGhhdCBpcyBpbXBvc3NpYmxlIHRvIHR5cGUgZHVlIHRvIHRoZSAnQCcgaW4gdGhlIG1pZGRsZVxuICAgICAgICAgIGxvY2Fscy5zZXQobG9jYWwsIGAke2xvY2FsfUAke2lkR2VuLm5leHQoKX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gVE9ETyAtIGNoZWNrIGZvciAubG9jYWwgaGVyZSBhbmQgcmVuYW1lPyAgbW92ZSBpbnRvIGFzc2VtbGJlclxuICAgICAgLy8gb3IgcHJlcHJvY2Vzc2luZy4uLj8gIHByb2JhYmx5IHdhbnQgdG8ga2VlcCB0cmFjayBlbHNld2hlcmUuXG4gICAgICBmdW5jdGlvbiBtYXAodG9rczogVG9rZW5bXSk6IFRva2VuW10ge1xuICAgICAgICBjb25zdCBtYXBwZWQ6IFRva2VuW10gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCB0b2sgb2YgdG9rcykge1xuICAgICAgICAgIGlmICh0b2sudG9rZW4gPT09ICdpZGVudCcpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtID0gcmVwbGFjZW1lbnRzLmdldCh0b2suc3RyKTtcbiAgICAgICAgICAgIGlmIChwYXJhbSkge1xuICAgICAgICAgICAgICAvLyB0aGlzIGlzIGFjdHVhbGx5IGEgcGFyYW1ldGVyXG4gICAgICAgICAgICAgIG1hcHBlZC5wdXNoKC4uLnBhcmFtKTsgLy8gVE9ETyAtIGNvcHkgdy8gY2hpbGQgc291cmNlaW5mbz9cbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBsb2NhbCA9IGxvY2Fscy5nZXQodG9rLnN0cik7XG4gICAgICAgICAgICBpZiAobG9jYWwpIHtcbiAgICAgICAgICAgICAgbWFwcGVkLnB1c2goe3Rva2VuOiAnaWRlbnQnLCBzdHI6IGxvY2FsfSk7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAodG9rLnRva2VuID09PSAnZ3JwJykge1xuICAgICAgICAgICAgbWFwcGVkLnB1c2goe3Rva2VuOiAnZ3JwJywgaW5uZXI6IG1hcCh0b2suaW5uZXIpfSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgc291cmNlID1cbiAgICAgICAgICAgICAgdG9rLnNvdXJjZSAmJiB0b2tlbnNbMF0uc291cmNlID9cbiAgICAgICAgICAgICAgICAgIHsuLi50b2suc291cmNlLCBwYXJlbnQ6IHRva2Vuc1swXS5zb3VyY2V9IDpcbiAgICAgICAgICAgICAgICAgIHRvay5zb3VyY2UgfHwgdG9rZW5zWzBdLnNvdXJjZTtcbiAgICAgICAgICBtYXBwZWQucHVzaChzb3VyY2UgPyB7Li4udG9rLCBzb3VyY2V9IDogdG9rKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWFwcGVkO1xuICAgICAgfVxuICAgICAgbGluZXMucHVzaChtYXAobGluZSkpO1xuICAgIH1cbiAgICByZXR1cm4gbGluZXM7XG4gIH1cbn1cbiJdfQ==