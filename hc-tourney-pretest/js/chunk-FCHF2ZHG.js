import{A as ne,B as He,C as Je,D as vi,E as Ei,F as z,G as xe,H as zt,I as Mt,J as Ms,K as Be,L as ye,M as Ii,N as Ti,O as Ri,P as Mi,Q as Fi,a as mi,b as D,c as se,d as Ot,e as Tt,f as ks,g as pi,h as vs,i as Es,j as Is,k as Rt,l as xi,m as Ts,n as gi,o as bi,p as wi,q as yi,r as Si,s as Ci,t as te,u as V,v as ki,w as ht,x as Rs,y as Ie,z as pe}from"./chunk-A7TBDZL7.js";var $t,$r=()=>{let r;$t=new Uint32Array(256);for(let s=0;s<256;s++){r=s;for(let e=0;e<8;e++)r=r&1?3988292384^r>>>1:r>>>1;$t[s]=r}};var Hr=r=>r.split("").map(s=>s.charCodeAt(0)),Ht=r=>{$t||$r(),typeof r=="string"&&(r=Hr(r));let s=-1;for(let e=0,t=r.length;e<t;e++)s=s>>>8^$t[(s^r[e])&255];return(s^-1)>>>0};var qt=r=>"",Fs=r=>r===!0?!1:r,Gs=class{constructor(s,e){this.flag=s;this.opts=e;Gs.flags.set(s,this)}static all(){return[...this.flags.values()]}},ge=Gs;ge.flags=new Map;var le=class{constructor(s,e,t,i){this.name=e;this.description=t;this.flags=i.map(n=>n instanceof ge?[n,!0]:n),s.presets.set(Gi(e),this)}static all(){return Ne.instance||(Ne.instance=new Ne),[...Ne.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new et(`@${this.name}`))),this._flagString}};function Gi(r){return r.toLowerCase().replace(/[^a-z]/g,"")}var Ne=class{constructor(){this.presets=new Map;this.Casual=new le(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[$.PreserveUniqueChecks,$.NoShuffleMimics,$.DecreaseEnemyDamage,$.GuaranteeRefresh,$.GuaranteeStartingSword,$.ExperienceScalesFaster,$.NoCommunityJokes,_.NoThunderSwordWarp,U.Shops,U.Dyna,[U.Maps,"!"],[U.WildWarp,"!"],oe.SpoilerLog]);this.Classic=new le(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[$.GuaranteeStartingSword,$.NoCommunityJokes,B.StatueGlitch,[_.NoThunderSwordWarp,"!"],[U.Maps,"!"],oe.SpoilerLog]);this.Standard=new le(this,"Standard",`
      Well-balanced, standard race flags.`,[J.RandomizeWeaknesses,_.StoryMode,oe.SpoilerLog]);this.NoBowMode=new le(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[J.RandomizeWeaknesses,J.TowerRobots,j.MaxScalingInTower,_.NoBowMode,oe.SpoilerLog]);this.Advanced=new le(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[B.GhettoFlight,B.MtSabreRequirementSkip,B.StatueGlitch,[B.SwordChargeGlitch,"!"],Y.Barrier,Y.BattleMagic,Y.GasMask,j.MaxScalingInTower,J.RandomizeWeaknesses,J.TowerRobots,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.UnidentifiedKeyItems,oe.SpoilerLog]);this.WildWarp=new le(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[$.GuaranteeRefresh,T.RandomizeWildWarp,J.RandomizeWeaknesses,J.TowerRobots,_.OrbsNotRequired,_.StoryMode,oe.SpoilerLog]);this.Mystery=new le(this,"Mystery",`
      Even the options are random.`,[[T.ShuffleAreas,"?"],[T.ShuffleHouses,"?"],[T.RandomizeMaps,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeWildWarp,"?"],[_.OrbsNotRequired,"?"],[_.NoBowMode,"?"],[_.StoryMode,"?"],[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[B.RageSkip,"?"],[B.TriggerSkip,"?"],[B.StatueGlitch,"?"],[B.GhettoFlight,"?"],[B.SwordChargeGlitch,"?"],[B.MtSabreRequirementSkip,"?"],[Te.RandomizeMusic,"?"],[Te.RandomizeMapColors,"?"],[J.RandomizeWeaknesses,"?"],[J.TowerRobots,"?"],[$.NoShuffleMimics,"?"],[$.PreserveUniqueChecks,"?"],[Y.Barrier,"?"],[Y.BattleMagic,"?"],[Y.GasMask,"?"],[U.Dyna,"?"],[U.BonusItems,"?"],[U.Maps,"?"],oe.SpoilerLog]);this.Hardcore=new le(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[Y.Barrier,Y.BattleMagic,j.ExperienceScalesSlower,j.MaxScalingInTower,j.Permadeath,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.UnidentifiedKeyItems]);this.FullStupid=new le(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[Y.Barrier,Y.BattleMagic,j.Blackout,j.ExperienceScalesSlower,j.MaxScalingInTower,j.Permadeath,J.RandomizeWeaknesses,J.TowerRobots,_.OrbsNotRequired,_.StoryMode,T.RandomizeMaps,T.ShuffleAreas,T.ShuffleHouses,T.RandomizeTrades,T.RandomizeWallElements,T.ShuffleGoaFloors,T.UnidentifiedKeyItems]);this.Tournament2022Early=new le(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[$.GuaranteeStartingSword,B.StatueGlitch,B.StatueGauntletSkip,[J.RandomizeWeaknesses,"?"],_.OrbsNotRequired,_.StoryMode,[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new le(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[$.GuaranteeStartingSword,"?"],[B.GhettoFlight,"?"],[B.StatueGlitch,"?"],[B.MtSabreRequirementSkip,"?"],[B.StatueGauntletSkip,"?"],j.MaxScalingInTower,[j.NoBuffMedicalHerb,"?"],[J.RandomizeWeaknesses,"?"],[J.TowerRobots,"?"],[Y.Barrier,"?"],[Y.BattleMagic,"?"],_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new le(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[$.GuaranteeStartingSword,"?"],B.GhettoFlight,B.StatueGlitch,B.MtSabreRequirementSkip,B.StatueGauntletSkip,j.NoBuffMedicalHerb,j.MaxScalingInTower,[J.RandomizeWeaknesses,"?"],[J.TowerRobots,"?"],Y.Barrier,Y.BattleMagic,_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],T.ShuffleHouses,[T.RandomizeWallElements,"?"],[T.ShuffleGoaFloors,"?"],[T.RandomizeSpriteColors,"?"],[T.RandomizeTrades,"?"],[T.UnidentifiedKeyItems,"?"]])}static get(s){return this.instance||(this.instance=new Ne),this.instance.presets.get(Gi(s))}},As=class{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(s,e){As.sections.add(this.instance||(this.instance=new this));let t=new ge(s,e);if(!s.startsWith(this.instance.prefix))throw new Error(`bad flag ${s} ${e}`);return this.instance.flags.set(s,t),t}},de=As;de.sections=new Set;var Se=class extends de{constructor(){super(...arguments);this.prefix="W";this.name="World"}},T=Se;T.RandomizeMaps=Se.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0}),T.ShuffleAreas=Se.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0}),T.ShuffleHouses=Se.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0}),T.RandomizeTrades=Se.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog
           Lamp, and Flute of Lime (for Akahana).  Rage will expect a
           random sword, and Tornel will expect a random bracelet.`,hard:!0}),T.UnidentifiedKeyItems=Se.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0}),T.RandomizeWallElements=Se.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`}),T.ShuffleGoaFloors=Se.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."}),T.RandomizeSpriteColors=Se.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`}),T.RandomizeWildWarp=Se.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]});var Qe=class extends de{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}},_=Qe;_.StoryMode=Qe.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`}),_.NoBowMode=Qe.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`}),_.OrbsNotRequired=Qe.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."}),_.NoThunderSwordWarp=Qe.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"}),_.VanillaDolphin=Qe.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`});var _e=class extends de{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}},B=_e;B.GhettoFlight=_e.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`}),B.StatueGlitch=_e.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"}),B.MtSabreRequirementSkip=_e.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"}),B.StatueGauntletSkip=_e.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"}),B.SwordChargeGlitch=_e.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"}),B.TriggerSkip=_e.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"}),B.RageSkip=_e.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"});var Ft=class extends de{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}},Te=Ft;Te.RandomizeMusic=Ft.flag("Am",{name:"Randomize background music",modes:"!",optional:Fs}),Te.NoMusic=Ft.flag("As",{name:"No background music",optional:qt}),Te.RandomizeMapColors=Ft.flag("Ac",{name:"Randomize map colors",modes:"!",optional:Fs});var Ut=class extends de{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}},J=Ut;J.RandomizeWeaknesses=Ut.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."}),J.TowerRobots=Ut.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0});var De=class extends de{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}},$=De;$.NoShuffleMimics=De.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."}),$.PreserveUniqueChecks=De.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`}),$.DecreaseEnemyDamage=De.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`}),$.GuaranteeStartingSword=De.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`}),$.GuaranteeRefresh=De.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`}),$.ExperienceScalesFaster=De.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]}),$.NoCommunityJokes=De.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`});var ut=class extends de{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}},Y=ut;Y.BattleMagic=ut.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0}),Y.MatchingSword=ut.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0}),Y.Barrier=ut.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0}),Y.GasMask=ut.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0});var qe=class extends de{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}},j=qe;j.NoBuffMedicalHerb=qe.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0}),j.MaxScalingInTower=qe.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0}),j.ExperienceScalesSlower=qe.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0}),j.ChargeShotsOnly=qe.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0}),j.Blackout=qe.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0}),j.Permadeath=qe.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});var Ue=class extends de{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}},U=Ue;U.Dyna=Ue.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`}),U.BonusItems=Ue.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`}),U.Maps=Ue.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"}),U.Shops=Ue.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`}),U.WildWarp=Ue.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"}),U.Hud=Ue.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:Fs});var Gt=class extends de{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}},je=Gt;je.NoAutoEquip=Gt.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:qt}),je.NoControllerShortcuts=Gt.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:qt}),je.AudibleWallCues=Gt.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:qt});var mt=class extends de{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}},oe=mt;oe.SpoilerLog=mt.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`}),oe.TrainerMode=mt.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`}),oe.NeverDie=mt.flag("Di",{name:"Player never dies"}),oe.NoShuffle=mt.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`});var et=class{constructor(s="@Casual"){if(typeof s!="string"){this.flags=new Map;for(let[i,n]of s)this.set(i.flag,n);return}if(s.startsWith("@")){let i=Ne.get(s.substring(1));if(!i)throw new mi(`Unknown preset: ${s}`);this.flags=new Map(i.flags);return}this.flags=new Map,s=s.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,t;for(;t=e.exec(s);){let[,i,n]=t,o=/([!?]|^)([a-z0-9]+)/g;for(;t=o.exec(n);){let[,a,l]=t;for(let c of l)this.set(i+c,a||!0)}}}filterOptional(){return new et(new Map([...this.flags].map(([s,e])=>[s,s.opts.optional?s.opts.optional(e):e])))}filterRandom(s){function e(t,i){return i!=="?"?i:s.pick([!0,!1,...t.opts.modes||""])}return new et(new Map([...this.flags].map(([t,i])=>[t,e(t,i)])))}toString(){let s=new D(()=>new D(()=>[]));for(let[t,i]of this.flags){if(t.flag.length!==2)throw new Error(`Bad flag ${t.flag}`);if(!i)continue;let n=s.get(t.flag[0]),o=i===!0?"":i;n.get(o).push(t.flag[1])}let e=[];for(let[t,i]of s.sortedEntries()){let n=t;for(let[o,a]of i.sortedEntries())n+=o+a.sort().join("");e.push(n)}return e.join(" ")}toggle(s){let e=ge.flags.get(s);if(!e)return console.error(`Bad flag: ${s}`),!1;let t=this.flags.get(e)||!1,i=[!1,!0,...e.opts.modes||"","?",!1],n=i.indexOf(t);if(n<0)throw new Error(`Bad current mode ${t}`);let o=i[n+1];return this.flags.set(e,o),o}set(s,e){let t=ge.flags.get(s);if(!t){console.error(`Bad flag: ${s}`);return}if(!e)this.flags.delete(t);else if(e===!0||e==="?"||t.opts.modes?.includes(e))this.flags.set(t,e);else{console.error(`Bad flag mode: ${s[0]}${e}${s.substring(1)}`);return}for(let i of t.opts.excludes||[])this.flags.delete(ge.flags.get(i))}check(s,...e){let t=s instanceof ge?s:ge.flags.get(s);return e.length||e.push(!0),e.includes(t&&this.flags.get(t)||!1)}get(s){let e=s instanceof ge?s:ge.flags.get(s);return e&&this.flags.get(e)||!1}alwaysMimics(){return!0}preserveUniqueChecks(){return this.check($.PreserveUniqueChecks)}shuffleMimics(){return this.check($.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(U.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(U.BonusItems,!1)}slowDownTornado(){return this.check(U.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(U.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(U.BonusItems,!1)||this.check(j.ChargeShotsOnly)}shuffleSpritePalettes(){return this.check(T.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(U.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(J.TowerRobots)}shuffleMonsterElements(){return this.check(J.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(j.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check($.DecreaseEnemyDamage)}trainer(){return this.check(oe.TrainerMode)}neverDie(){return this.check(oe.NeverDie)}noShuffle(){return this.check(oe.NoShuffle)}chargeShotsOnly(){return this.check(j.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(U.Maps,"!")}addEastCave(){return this.check(U.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(_.VanillaDolphin,!1)}storyMode(){return this.check(_.StoryMode)}noBowMode(){return this.check(_.NoBowMode)}requireHealedDolphinToRide(){return this.check(_.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(_.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(_.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(_.OrbsNotRequired)}shuffleGoaFloors(){return this.check(T.ShuffleGoaFloors)}shuffleHouses(){return this.check(T.ShuffleHouses)}shuffleAreas(){return this.check(T.ShuffleAreas)}randomizeMaps(){return this.check(T.RandomizeMaps)}randomizeTrades(){return this.check(T.RandomizeTrades)}unidentifiedItems(){return this.check(T.UnidentifiedKeyItems)}randomizeWalls(){return this.check(T.RandomizeWallElements)}guaranteeSword(){return this.check($.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(Y.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(Y.MatchingSword,!1)}guaranteeGasMask(){return this.check(Y.GasMask,!1)}guaranteeBarrier(){return this.check(Y.Barrier,!1)}guaranteeRefresh(){return this.check($.GuaranteeRefresh)}communityJokes(){return this.check($.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(B.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(B.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(B.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(U.Shops,!1)}disableStatueGlitch(){return this.check(B.StatueGlitch,!1)}disableRageSkip(){return this.check(B.RageSkip,!1)}disableTriggerGlitch(){return this.check(B.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(B.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(B.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(B.GhettoFlight)}assumeTeleportSkip(){return this.check(B.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(B.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(B.StatueGlitch)}assumeTriggerGlitch(){return this.check(B.TriggerSkip)}assumeFlightStatueSkip(){return this.check(B.StatueGauntletSkip)}assumeWildWarp(){return this.check(U.WildWarp,!0)||this.check(T.RandomizeWildWarp)}assumeRageSkip(){return this.check(B.RageSkip)}nerfWildWarp(){return this.check(U.WildWarp,!1)&&this.check(T.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(T.RandomizeWildWarp,!0)}blackoutMode(){return this.check(j.Blackout)}hardcoreMode(){return this.check(j.Permadeath)}buffDyna(){return!this.check(U.Dyna)}maxScalingInTower(){return this.check(j.MaxScalingInTower)}expScalingFactor(){return this.check(j.ExperienceScalesSlower)?.25:this.check($.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(s){return s==="early"||this.check(je.NoAutoEquip,!1)}controllerShortcuts(s){return s==="early"||this.check(je.NoControllerShortcuts,!1)}randomizeMusic(s){return this.check(Te.RandomizeMusic,s==="early"?"!":!0)}shuffleTilePalettes(s){return this.check(Te.RandomizeMapColors,s==="early"?"!":!0)}noMusic(s){return s==="late"&&this.check(Te.NoMusic)}audibleWallCues(s){return s==="late"&&this.check(je.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(U.Hud,!1)}hasStatTracking(){return!0}};var qr=4656613057391769e-25,Bi=2147483563-1,Ai=40014,Ur=40692,jt=53668,Pi=52774,Li=12211,jr=3791,Kt=32,Kr=1+Math.floor(Bi/Kt),Vr=12e-8,Xr=1-Vr,tt=class{constructor(s=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(s)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(s){this.idum=Math.max(1,Math.floor(s)),this.idum2=this.idum,this.iy=0,this.iv=new Array(Kt).fill(0);for(let e=Kt+7;e>=0;e--){let t=Math.floor(this.idum/jt);this.idum=Ai*(this.idum-t*jt)-t*Li,this.idum<0&&(this.idum+=2147483563),e<Kt&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let s=Math.floor(this.idum/jt);this.idum=Ai*(this.idum-s*jt)-s*Li,this.idum<0&&(this.idum+=2147483563),s=Math.floor(this.idum2/Pi),this.idum2=Ur*(this.idum2-s*Pi)-s*jr,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/Kr);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=Bi),Math.min(qr*this.iy,Xr)}nextInt(s){return Math.floor(this.next()*s)}nextNormal(s=0,e=1,t=-1/0,i=1/0){for(;;){let n=this.z1;if(n==null){let o=Math.sqrt(-2*Math.log(this.next())),a=Zr*this.next();n=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(n=s+n*e,n>=t&&n<=i)return n}}shuffle(s){for(let e=s.length;e;){let t=this.nextInt(e--);[s[e],s[t]]=[s[t],s[e]]}return s}*ishuffle(s){let e=[];if(!Array.isArray(s))if(Yr(s)){let t=s[Symbol.iterator]();for(let i=0;i<s.size;i++){let n=i+this.nextInt(s.size-i);for(;e.length<=n;)e.push(t.next().value);yield e[n],e[n]=e[i]}return}else s=[...s];if(!Array.isArray(s))throw new Error("impossible");for(let t=0;t<s.length;t++){let i=t+this.nextInt(s.length-t);yield i in e?e[i]:s[i],e[i]=t in e?e[t]:s[t]}}pick(s){if(!s.length)throw new Error("empty array");return s[this.nextInt(s.length)]}pickWeighted(s){if(!s.length)throw new Error("empty array");let e=0;for(let[i]of s)e+=i;let t=this.next()*e;for(let[i,n]of s){if(t<i)return n;t-=i}throw new Error("bad weights")}pickAndRemove(...s){let e=0;for(let i of s)e+=i.length;if(!e)throw new Error("empty arrays");let t=this.nextInt(e);for(let i of s){if(t<i.length)return i.splice(t,1)[0];t-=i.length}throw new Error("impossible")}bitGenerator(){let s=0,e=0;return()=>{s||(s=32,e=this.nextInt(4294967296)),s--;let t=!(e&1);return e>>>=1,t}}};function Yr(r){return"size"in r}var Zr=2*Math.PI;var Re=class{constructor(s,e){this.height=s;this.width=e;this._coords=void 0;this.data=new Array((s<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let s=[];for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++)s.push(e<<12|t<<4);return this._coords=s}index(s){return((s&248)>>3)+this.row*(s>>>11)}index2(s,e){return(this.row<<1)*s+2*e}yx(s){let e=s%this.row;return[(s-e)/this.row/2,e/2]}coord(s){let e=s%this.row;return(s-e)/this.row<<11|e<<3}get(s){return this.data[this.index(s)]}set(s,e){this.data[this.index(s)]=e}get2(s,e){return this.data[this.index2(s,e)]}set2(s,e,t){this.data[this.index2(s,e)]=t}plus(s,e,t){return s+(this.row<<1)*e+2*t}x(s){return s%this.row/2}y(s){return Math.floor(s/this.row)/2}border(s,e){let t,i;return s&1?(i=e<<12|2048,t=s&2?this.width<<4:0):(i=s&2?this.height<<12:0,t=e<<4|8),i|t}randomBorder(s,e){let t,i;if(e!=null)e&1?(i=s.nextInt(this.height)<<12|2048,t=e&2?this.width<<4:0):(i=e&2?this.height<<12:0,t=s.nextInt(this.width)<<4|8);else{let n=this.width+this.height,o=s.nextInt(n<<1)-n,a=!1;o<0&&(o=~o,a=!0),o<this.width?(t=o<<4|8,i=a?this.height<<12:0):(i=o-this.width<<12|2048,t=a?this.width<<4:0)}return i|t}oppositeBorder(s){return s&8?s^this.height<<12:s^this.width<<4}furthestBorder(s){return(this.height<<12|this.width<<4)-s}edgeCoordination(s,e){let t=0;if((s&2056)!==2056)throw new Error(`Bad tile: ${V(s)}`);for(let i of[8,-8,2048,-2048]){let n=this.get(s+i);(e?n===e:n)&&t++}return t}isBorder(s){if(s&8){if(s&2048)return!1;let e=s>>>12;return!e||e===this.height}else if(s&2048){let e=s>>>4&15;return!e||e===this.width}return!1}partition(s){let e=new pe;for(let t=0;t<this.data.length;t+=this.row)for(let i=0;i<this.row;i++){let n=t+i,o=this.coord(n);if(!(s?.get(o)??this.data[n]))continue;e.find(o);let l=o-2048;t&&(s?.get(l)??this.data[n-this.row])&&e.union([o,l]);let c=o-8;i&&(s?.get(c)??this.data[n-1])&&e.union([o,c])}return e.map()}show(){let s=[];for(let e=0;e<this.data.length;e+=this.row){let t="";for(let i=0;i<this.row;i++)t+=this.data[e+i]||" ";s.push(t)}return s.join(`
`)}static writeGrid2d(s,e,t){let i=s.index(e);for(let n=0;n<t.length;n++){let o=t[n];for(let a=0;a<o.length;a++){let l=o[a];s.data[i+n*s.row+a]=l!==" "?l:""}}}};function _i(r){return r>>4&15|r>>8&240}function Ke(r,s=1){return r-s*8}function Ce(r,s=1){return r+s*8}function ae(r,s=1){return r-s*2048}function Q(r,s=1){return r+s*2048}var[]=[V],R={ok:!0,value:void 0},Vt=class{constructor(s,e){this.rom=s;this.random=e;this.shuffles=[]}add(...s){this.shuffles.push(...s)}shuffleAll(){for(let s of this.shuffles)s.shuffle(this.random);for(let s of this.shuffles)s.meta&&s.finish();for(let s of this.rom.locations)s.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((s,e)=>(s.badness||0)-(e.badness||0)).join(`
`)}},Xt=class{constructor(s,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new Re(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=s,this.orig=s.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let s=this.pickHeight(),e=this.pickWidth(),t=this.pickSize(),i=new Re(s,e);i.data.fill(""),Object.assign(this,{h:s,w:e,size:t,grid:i,fixed:new Set,count:0,exitMap:[]})}shuffle(s){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:s});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let s=[];for(let[e,t,i]of this.exitMap)for(let[n,o,a]of s)if(e(n,o)){s.push([t,i,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,t,i]of s){let n=this.meta.rom.locations[i[0]>>>8].meta,o=i[0]&255,a=i[1];this.meta.attach(e,n,o,t,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(s,e){let t=this.posToGrid(s);for(let i=0;i<3;i++)for(let n=0;n<3;n++){let o=t+i*2048+n*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[i*3+n])return!1}for(let i=0;i<3;i++)for(let n=0;n<3;n++){let o=t+i*2048+n*8;this.grid.set(o,e[i*3+n])}return!0}posToGrid(s,e=0){let t=s>>>4,i=s&15;return(t<<12|i<<4)+e}insertPattern(s,{top:e=0,bottom:t=0,left:i=0,right:n=0}={}){let o=s.length-1>>>1,a=s[0].length-1>>>1,l=e+t,c=i+n;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+c)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,f=this.random.nextInt(this.w-a-1-l)+i,u=d+1<<12|f+1<<4;Re.writeGrid2d(this.grid,u,s);for(let h=12288;h<=20480;h+=2048)for(let p=48;p<=64;p+=8)this.fixed.add(u+(h|p));return{ok:!0,value:void 0}}extract(s,e,{h:t=3,w:i=3,replace:n=void 0}={}){let o=s.index(e),a="",l=o+t*s.row,{row:c}=s;for(let d=o;d<l;d+=c)for(let f=d;f<d+i;f++){if(n){let u=n.get(s.coord(f));if(u!=null){a+=u||" ";continue}}a+=s.data[f]||" "}return a}canSet(s,e){return this.canSetAll(new Map([[s,e]]))}canSetAll(s){let e=new Set;for(let t of s.keys()){if(this.fixed.has(t))return!1;let i=t&-2057,n=i>>>12,o=i>>>4&15;o<this.w&&n<this.h&&e.add(i),!(t&8)&&n<this.h&&o&&e.add(i-16),!(t&2048)&&o<this.w&&n&&e.add(i-4096),!(t&2056)&&o&&n&&e.add(i-4112)}for(let t of e){let i=this.extract(this.grid,t,{replace:s});if(!this.orig.tileset.getMetascreensFromTileString(i).length)return!1}return!0}addAllFixed(){for(let s=0;s<this.grid.data.length;s++)this.grid.data[s]&&this.fixed.add(this.grid.coord(s))}};var[]=[V],v=class extends Xt{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let t={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let i of e.rom.locations[e.id].spawns)i.isMonster()&&i.monsterId===143&&t.features.statue++;for(let i of e.allPos()){let n=e.get(i);(!n.isEmpty()||n.data.exits?.length)&&t.size++;for(let o of n.data.exits??[]){let{type:a}=o;if(a==="edge:top"){i>>>4===0&&t.edges[0]++;continue}else if(a==="edge:left"){(i&15)===0&&t.edges[1]++;continue}else if(a==="edge:bottom"){i>>>4===e.height-1&&t.edges[2]++;continue}else if(a==="edge:right"){(i&15)===e.width-1&&t.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);t.stairs[o.dir>>>1]++;continue}}}n.hasFeature("arena")&&t.features.arena++,n.hasFeature("bridge")&&t.features.bridge++,n.hasFeature("overpass")&&t.features.over++,n.hasFeature("pit")&&t.features.pit++,n.hasFeature("ramp")&&t.features.ramp++,n.hasFeature("spikes")&&t.features.spike++,n.hasFeature("underpass")&&t.features.under++,n.hasFeature("wall")&&t.features.wall++,n.hasFeature("river")&&t.features.river++,n.hasFeature("wide")&&t.features.wide++}return t.size<2&&(e.width>1||e.height>1)&&(t.size=2),t}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let t=this.inferScreens();return t.ok?(e=this.refineMetascreens(t.value),!e.ok||(e=this.checkMetascreens(t.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(t.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=t.value,R)):t}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:R):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),R}fillCave(e){for(let t=.5;t<this.h;t++)for(let i=.5;i<this.w;i++)t>1&&this.grid.set2(t-.5,i,e),i>1&&this.grid.set2(t,i-.5,e),this.grid.set2(t,i,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return R;for(let e=0;e<4;e++){let t=this.params.edges[e]||0;if(!t)continue;let i=te(e&1?this.h:this.w,n=>this.grid.border(e,n));for(let n of this.random.ishuffle(i))if(!this.grid.get(n)&&(e&1?e===1?this.addLeftEdge(n)&&t--:this.addRightEdge(n)&&t--:e===0?this.addUpEdge(n)&&t--:this.addDownEdge(n)&&t--,!t))break;if(t)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${t} ${e}`}}return R}addUpEdge(e){let t=e+2048,i=t-8,o=i-8-8,a=t+8,c=a+8+8;if(this.grid.isBorder(i)){if(this.grid.get(i))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(c)&&this.grid.get(c))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(i,""),this.grid.set(a,""),!0}addDownEdge(e){let t=e-2048,i=t-8,n=t+8;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(i,""),this.grid.set(n,""),!0)}addLeftEdge(e){let t=e+8,i=t-2048,n=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let t=e-8,i=t-2048,n=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?R:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?R:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let n=i|2056;if(!this.isEligibleArena(n))continue;let o=this.extract(this.grid,i),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(n),t.set(n,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let t=this.grid,i=e-8,n=i-8,o=e+8,a=o+8;return!(t.get(e)!=="c"&&t.get(e)!=="w"||t.get(i)||t.get(o)||!t.isBorder(i)&&t.get(n)||!t.isBorder(o)&&t.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let t=0;for(;e;){let i=this.random.nextInt(this.h-2)+1,n=this.random.nextInt(this.w-2)+1,o=i<<12|n<<4|2056;if(this.grid.get(o)!=="c"){if(++t>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,t,i){if(!e)return!0;for(let n of this.random.ishuffle(this.grid.screens())){let o=n|2056;if(this.grid.get(o)!=="c")continue;if(i){let d=o-i,f=o+i;if(this.grid.get(d)||this.grid.get(f))continue}let a=this.extract(this.grid,n),l=a.substring(0,4)+t+a.substring(5);if(!!this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,t),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let t=0;for(;e>0;){if(++t>20)return!1;let i=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;i<e-1&&i>this.minSpikes;)this.random.next()<.2&&i--;let n=i>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);i>e-this.minSpikes&&(i>=this.h-2?i=this.h-2:i=e);let a=this.random.nextInt(this.h-i-2)+1<<12|n<<4|2056,l=a+(i-1<<12);for(let f=a-4096;i&&f<=l+4096;f+=2048)this.grid.get(f)!=="c"&&(i=0);if(!i)continue;let c=[a-8,a+8,l-8,l+8],d=this.tryClear(c);if(!!d.length){for(let f of d)this.grid.set(f,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let f=a;f<=l;f+=2048)this.fixed.add(f),this.grid.set(f,"s");e-=i,t=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let t=new Map;for(let c of e){if(this.fixed.has(c))return[];t.set(c,"")}let i=this.grid.partition(t),[n]=i.values();if(n.size===i.size)return[...e];let o=new Set,a=new Set(i.values());for(let c of this.fixed)o.add(i.get(c));if(o.size>this.maxPartitions)return[];let l=[...e];for(let c of a)o.has(c)||l.push(...c);return l}refine(){let e=new Set;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]&&e.add(this.grid.coord(i));let t=0;for(;this.count>this.size;){if(t++>50)throw new Error("refine failed: attempts");let i=0;for(let n of this.random.ishuffle([...e])){if(this.grid.isBorder(n)||!this.canRemove(this.grid.get(n))||this.fixed.has(n))continue;if(i>3)break;let o=this.grid.partition(this.removalMap(n)),[a]=o.values();if(a.size===o.size&&o.size>1)i++,e.delete(n),(n&2056)===2056&&this.count--,this.grid.set(n,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let c=[...l].filter(d=>(d&2056)==2056).length;if(c<this.size)continue;i++,e=l,this.count=c,this.grid.set(n,"");for(let[d,f]of o)f!==l&&this.grid.set(d,"")}}if(!i)return this.looseRefine?R:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return R}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let t=this.grid.partition(new Map),i=t.size,n=new Set(t.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===n)&&a.size===i-1&&(i--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|2056|t<<4;if(this.grid.get(i))continue;let n=i-2048,o=i+2048,a=i-8,l=i+8;(this.grid.get(n)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(n,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let t=e<<12|2048;for(let i=0;i<this.w-1;i++){let n=t|i<<4|8;this.isTightLoop(n)&&this.breakTightLoop(n)}}}isTightLoop(e){for(let t=0;t<6144;t+=2048)for(let i=0;i<24;i+=8){let n=t|i;if(n!==2056&&this.grid.get(e+n)!=="c")return!1}return!0}breakTightLoop(e){let t=this.random.nextInt(65536),i=t&1?t&4096|8:t&16|2048;this.grid.set(e+i,"")}addStairs(e=0,t=0){let i=[e,t];if(!i[0]&&!i[1])return R;for(let n of this.random.ishuffle(this.grid.screens()))if(!!this.tryAddStair(n,i)&&!i[0]&&!i[1])return R;return{ok:!1,fail:"stairs"}}addEarlyStair(e,t){let i=[],n=e-8,o=e+8,a=e-2048,l=e+2048,c=[e-8,e+8];if(t==="<"){if(c.push(l),i.push([a,""]),this.grid.get(n)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return i.push([l,""],[e,"<"]),i}else t===">"&&(c.push(a),i.push([l,""]));if(c=c.filter(f=>this.grid.get(f)==="c"),!c.length)return[];let d=this.random.nextInt(c.length);for(let f=0;f<c.length;f++)f!==d&&i.push([c[f],""]);return i.push([e,t]),i}tryAddStair(e,t){if(this.fixed.has(e|2056))return!1;let i=this.extract(this.grid,e),n=t[0]&&t[1],o=t[0]+t[1],a=this.random.nextInt(o)<t[0],l=[a?0:1];n&&l.push(a?1:0);for(let c of l){let d="<>"[c],f=i.substring(0,4)+d+i.substring(5);if(this.orig.tileset.getMetascreensFromTileString(f).length)return this.grid.set(e|2056,d),t[c]--,!0}return!1}tryConnect(e,t,i,n=1){for(;n-- >0;){let o=new Map,a=e;if((e&t&2056)!==2056)throw new Error(`bad start ${V(e)} or end ${V(t)}`);for(o.set(a,i);a!==t;){let l=[];for(let h of[8,-8,2048,-2048]){let p=a+h,m=a+2*h;this.fixed.has(m)||(o.get(m)??this.grid.get(m))||this.grid.isBorder(p)||l.push(h)}if(!l.length)break;let c=(t>>12)-(a>>12),d=(t&240)-(a&240),f=new Set(l);c<0&&f.delete(2048),c>0&&f.delete(-2048),d<0&&f.delete(8),d>0&&f.delete(-8),l.push(...f,...f);let u=this.random.pick(l);o.set(a+u,i),o.set(a=a+2*u,i)}if(a===t){for(let[l,c]of o)this.grid.set(l,c),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,t=1){let i=new pe;for(let l=0;l<this.grid.data.length;l++){let c=this.grid.coord(l);this.grid.get(c)||this.grid.isBorder(c)||(this.grid.get(Ce(c))||i.union([c,Ce(c)]),this.grid.get(Q(c))||i.union([c,Q(c)]))}let n=new D(()=>[]);for(let l of this.grid.screens()){let c=l+2056;if(!!this.grid.get(c))for(let d of[8,-8,2048,-2048]){let f=c+d;if(this.grid.isBorder(f)||this.grid.get(f))continue;let u=c+2*d;if(this.grid.get(u))continue;let h=new Map([[f,e]]),p=this.extract(this.grid,l,{replace:h});this.orig.tileset.getMetascreensFromTileString(p).length&&n.get(i.find(u)).push([f,u])}}let o=new Map;for(let l of n.values())if(!(l.length<2))for(let[c]of l)o.set(c,l);let a=[...o.values()];if(!a.length)return!1;for(;t-- >0;){let l=this.random.pick(a),[[c,d],[f,u]]=this.random.ishuffle(l);if(this.grid.set(c,e),this.grid.set(f,e),this.tryConnect(d,u,e,5))return!0;this.grid.set(c,""),this.grid.set(f,"")}return!1}tryExtrude(e,t,i=1){for(;i--;)for(let n of this.random.ishuffle(this.grid.screens())){let o=n+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,n);for(let l of this.random.ishuffle([0,1,2,3])){let c=o+pt[l],d=o+2*pt[l];if(this.grid.get(c)||this.grid.isBorder(c)||this.grid.get(d))continue;let f=Ps[l],u=a.substring(0,f)+e+a.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(u).length){this.grid.set(c,e),this.grid.set(d,e);let h=this.tryContinueExtrude(e,t,d);if(h)return h;this.grid.set(d,""),this.grid.set(c,"")}}}return 0}tryContinueExtrude(e,t,i){let n=this.extract(this.grid,i-2056),o=this.orig.tileset.getMetascreensFromTileString(n).length>0;if(t===1)return o?1:0;if(o&&!this.random.nextInt(t))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=i+pt[a],c=i+2*pt[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(c))continue;let d=Ps[a],f=n.substring(0,d)+e+n.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(l,e),this.grid.set(c,e);let u=this.tryContinueExtrude(e,t-1,c);if(u)return u+1;this.grid.set(c,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let t=this.orig.tileset,{attempts:i=1,char:n="c",start:o,loop:a=!1}=e;for(let l=0;l<i;l++){let c=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of c){let f=d+2056;if(!this.grid.get(f))continue;let u=this.extract(this.grid,d);for(let h of this.random.ishuffle([0,1,2,3])){let p=f+pt[h],m=f+2*pt[h];if(this.fixed.has(p)||this.fixed.has(m))continue;let b=this.grid.get(p),C=this.grid.get(m);if(b&&(C||b!==n)||this.grid.isBorder(p))continue;if(!a){let x=this.extract(this.grid,m-2056,{replace:new Map([[p,""]])});if(/\S/.test(x))continue}let g=Ps[h],y=u.substring(0,g)+n+u.substring(g+1);if(t.getMetascreensFromTileString(y).length){this.count++,this.grid.set(p,n),this.grid.set(m,n);let x=this.extract(this.grid,m-2056);if(t.getMetascreensFromTileString(x).length)return 1;this.grid.set(m,C),this.grid.set(p,b),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:R}preinferSpikes(){return R}inferScreens(){let e=[];for(let n of this.grid.screens()){let o=this.extract(this.grid,n),a=this.orig.tileset.getMetascreensFromTileString(o).filter(c=>!c.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${V(n)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let t=!0,i=new xe(this.params.id,this.orig.tileset,this.h,this.w);for(let n=0;n<this.h;n++)for(let o=0;o<this.w;o++){let a=e[n*this.w+o];if(i.set(n<<4|o,a),a.isEmpty()||(t=!1),n){let l=i.get(n-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${n}${o}: ${l.name} ${a.name}`}}if(o){let l=i.get(n<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${n}${o}: ${l.name} ${a.name}`}}}return t?{ok:!1,fail:"all screens empty"}:{ok:!0,value:i}}refineMetascreens(e){let t=this.params.features?.bridge||0,i=this.params.features?.wall||0;for(let n of this.random.ishuffle(e.allPos())){let o=(n<<8|n<<4)&61680,a=this.extract(this.grid,o),l=e.get(n);if(!(this.bridges<=t&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<i&&!l.hasFeature("wall")&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==t?{ok:!1,fail:`refineMeta bridges want ${t} got ${this.bridges}
${e.show()}`}:this.walls!==i?{ok:!1,fail:`refineMeta walls want ${i} got ${this.walls}
${e.show()}`}:R}tryMeta(e,t,i){for(let n of i)if(!!this.checkMeta(e,new Map([[t,n]])))return e.set(t,n),!0;return!1}checkMeta(e,t){let i=t?{with:t}:{},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let t=!1,i=!1;for(let n of e.allPos()){let o=e.get(n);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(t=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(i=!0),t&&i)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return R;let t=0;for(let i of e.allPos()){let n=e.get(i);t+=n.data.statues?.length||0}return t<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:R}},st=class extends v{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,t=super.addEdges();if(!t.ok)return t;let i=this.params.features?.arena;if(!i)return R;let n=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&n.push(a)}if(n.length<i)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(n)){if(!i)break;let a=o-8,l=a-8,c=l-8,d=l-2048,f=l+2048,u=o+8,h=u+8,p=h+8,m=h-2048,b=h+2048;!e.isBorder(a)&&(e.isBorder(c)&&e.get(c)||e.isBorder(d)&&e.get(d)||e.isBorder(f)&&e.get(f))||!e.isBorder(u)&&(e.isBorder(p)&&e.get(p)||e.isBorder(m)&&e.get(m)||e.isBorder(b)&&e.get(b))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(u,""),e.set(h,""),this.grid.set(o,"a"),i--)}return R}addArenas(){return!0}},Yt=class extends v{refineMetascreens(s){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)this.grid.get(e<<12|t<<4|2056)==="a"&&s.set(e<<4|t,s.rom.metascreens.cryptArena_statues);return super.refineMetascreens(s)}isEligibleArena(s){return!this.grid.get(s-2048)&&super.isEligibleArena(s)}},Ps=[1,3,7,5],pt=[-2048,-8,2048,8];function Zt(r,s,e=!1){let t=new Bs(r,s,e),i=new Ls(s,t,e);return[t,i]}var Ls=class extends v{constructor(e,t,i){super(e);this.location=e;this.under=t;this.reverse=i;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,t]of se.zip(this.under.upStairs,this.downStairs))this.meta.attach(t,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let t=16,i=0,n=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let c=l>>>4,d=l&15;t=Math.min(d,t),i=Math.max(d,i),n=Math.min(c-a,n),o=Math.max(c+a,o)}e:for(let l=0;l<10;l++){let c=[],d=this.random.nextInt(this.w-(i-t))+t,u=this.random.nextInt(this.h-(o-n))+n-n<<4+(d-t);for(let h of this.under.underBridges){let p=h+u,m=p>>>4,b=p&15,C=m<<12|b<<4|2056;if(this.grid.get(C)!=="c")continue e;c.push([C,"b"]),c.push([C-8,""]),c.push([C+8,""])}for(let h of this.under.upStairsEffective){let p=h+u,m=p>>>4,b=p&15,C=m<<12|b<<4|2056;if(this.grid.get(C)!=="c")continue e;c.push([C,this.reverse?"<":">"]),c.push([C+(this.reverse?-2048:2048),""]);let g=this.addEarlyStair(C,this.reverse?"<":">");if(!g.length)continue e;c.push(...g)}for(let[h,p]of c)p&&this.fixed.add(h),(p==="<"||p===">")&&this.downStairs.push(_i(h)),this.grid.set(h,p);return R}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,t=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,t):super.addStairs(e,t-this.under.upStairs.length)}addOverpasses(){return!0}},Bs=class extends v{constructor(e,t,i){super(e);this.loc=e;this.overpass=t;this.reverse=i;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let t=this.reverse?"stair:down":"stair:up";for(let n of this.meta.allPos()){let o=this.meta.get(n);if(o.hasFeature("underpass")&&this.underBridges.push(n),o.hasFeature(t)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(n+a),this.upStairs.push(n)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let i=0;for(let[,n,[o]]of this.orig.exits())n===t&&o>>>8===this.overpass.id&&i++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,i),R}};var it=class extends v{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let i=0;i<this.h;i++)for(let n=0;n<this.w;n++){let o=i<<12|n<<4|2056;this.grid.get(o)&&e.push(o)}let t=e.filter(i=>this.tryClear([i]).length===1);if(!t.length)return{ok:!1,fail:"all critical?"};for(let i=0;i<t.length;i++)for(let n=0;n<i;n++)if(this.tryClear([t[i],t[n]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},Jt=class extends it{removeTightLoops(){}};var We=class{constructor(s,e,t){this.h=s;this.w=e;this.valid=t;this.fixed=new Set;this.size=0;this.data=new Uint8Array(s*e)}fill(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e;s>0&&(this.data[t]|=1),e>0&&(this.data[t]|=2),s<this.h-1&&(this.data[t]|=4),e<this.w-1&&(this.data[t]|=8)}}isBorder(s,e){let t=s%this.w,i=(s-t)/this.w;return this.isBorder2(i,t,e)}isBorder2(s,e,t){if(t===0)return!s;if(t===1)return!e;if(t===2)return s>=this.h-1;if(t===3)return e>=this.w-1;throw new Error("bad direction")}delete2(s,e,t=s*this.w+e){if(this.fixed.has(t))return!1;let i=new Map;i.set(t,0);for(let n=0;n<4;n++){if(this.isBorder2(s,e,n))continue;let o=t+this.delta(n),a=this.data[o],l=a&~(1<<(n^2));if(a!==l){if(this.fixed.has(o))return!1;i.set(o,l)}}return this.try(i)}delete(s){let e=s%this.w,t=(s-e)/this.w;return this.delete2(t,e,s)}deleteEdge2(s,e,t,i=s*this.w+e){if(this.fixed.has(i))return!1;if(this.isBorder2(s,e,t))return this.data[i]&=~(1<<t),!0;let n=new Map,o=i+this.delta(t);return this.fixed.has(o)?!1:(n.set(i,this.data[i]&~(1<<t)),n.set(o,this.data[o]&~(1<<(t^2))),this.try(n))}deleteEdge(s,e){let t=s%this.w,i=(s-t)/this.w;return this.deleteEdge2(i,t,e,s)}refine(s,e){let t=0,i=new Set;for(let n=0;n<this.data.length;n++)this.data[n]&&t++,this.fixed.has(n)||i.add(n);for(;t>e;){let n=!1;for(let o of s.ishuffle(i)){if(t<=e)break;if(!this.data[o]){t--;continue}this.delete(o)&&(n=!0,t--)}if(!n)return!1}return!0}validate(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e,i=this.data[t];if(s&&!(this.data[t-this.w]&4)!=!(i&1))throw new Error(`invalid above ${s}${e}`);if(e&&!(this.data[t-1]&8)!=!(i&2))throw new Error(`invalid left of ${s}${e}`)}}addEdge(s,e,t){let i=s*this.w+e;this.data[i]|=1<<t,this.isBorder2(s,e,t)||(this.data[i+this.delta(t)]|=1<<(t^2))}consolidate(s,e){let t=new ks;for(let n=0;n<this.data.length;n++)!this.fixed.has(n)&&this.data[n]&&t.add(this.data[n]);let i=1e3;for(;t.unique()>e&&--i;){let n=[...t].sort((c,d)=>d[1]-c[1]),o=n[e][1],a=new Set(n.filter(c=>c[1]<=o).map(c=>c[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[c,d]of s.pick(l))this.data[c]&&t.delete(this.data[c]),d&&t.add(d),this.data[c]=d}return i?[...t].map(n=>n[0]):[]}consolidateFixed(s,e){let t=new ks;for(let n=0;n<this.data.length;n++){let o=this.data[n];!this.fixed.has(n)&&e.has(o)&&t.add(o)}let i=1e3;for(;t.unique()&&--i;){let n=this.findEligibleConsolidates(e);if(!n.length)return!1;for(let[o,a]of s.pick(n)){let l=this.data[o];e.has(l)&&t.delete(l),e.has(a)&&t.add(a),this.data[o]=a}}return!!i}findEligibleConsolidates(s){let e=[],t=[];for(let i=0;i<this.data.length;i++){if(this.fixed.has(i))continue;let n=this.data[i];if(!!s.has(n))for(let o=0;o<4;o++){if(this.isBorder(i,o))continue;let a=this.delta(o);if(this.fixed.has(i+a))continue;let l=1<<o;if(s.has(n^l))continue;let c=1<<(o^2),d=this.data[i+a],f=new Map([[i,n^l],[i+a,d^c]]);if(!!this.check(f)&&(e.push(f),!s.has(d^c)&&s.has(d))){t.push(f);break}}}return t.length?t:e}try(s){if(!this.check(s))return!1;for(let[e,t]of s)this.data[e]=t;return!0}check(s){let e=new pe;for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let n=t*this.w+i,o=s?.get(n)??this.data[n];o&&e.union([n]),t>0&&o&1&&e.union([n,n-this.w]),i>0&&o&2&&e.union([n,n-1]),t<this.h-1&&o&4&&e.union([n,n+this.w]),i<this.w-1&&o&8&&e.union([n,n+1])}return e.roots().length===1}addPath(s,e){let t,i;if(!this.size)t=s.nextInt(this.h),i=s.nextInt(this.w);else{let c=[];for(let f=0;f<this.data.length;f++)this.data[f]&&this.data[f]!==15&&c.push(f);if(!c.length)return!1;let d=s.pick(c);i=d%this.w,t=(d-i)/this.w}let n=new Map,o=t*this.w+i,a=0,l=!0;for(;;){let c=!1,d=n.get(o)??this.data[o],f=!1;for(let u of s.ishuffle([0,1,2,3])){let h=1<<u;if(d&h)continue;let p=d|h;if(this.valid&&!this.valid.has(p))continue;let m=t+Jr[u],b=i+Qr[u];if(m<0||b<0||m>=this.h||b>=this.w)continue;let C=m*this.w+b,g=n.get(C)??this.data[C],y=g|1<<(u^2);if(g){if(g===y||this.valid&&!this.valid.has(y))continue;c=!0}l=!this.valid||this.valid.has(y),n.set(o,p),n.set(C,y),i=b,t=m,o=C,f=!0;break}if(!f||c||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&s.nextInt(15)<a++)break}if(!n.size||!l)return!1;for(let[c,d]of n)this.data[c]=d;return!0}toGrid(s){let e=new Re(this.h,this.w);for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let n=t*this.w+i,o=this.data[n];if(!o)continue;let a=t<<12|i<<4|2056;e.set(a,s);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let c=l&1?8:2048;e.set(l&2?a+c:a-c,s)}}return e}delta(s){return(s&2?1:-1)*(s&1?1:this.w)}show(){let s=[];for(let e=0;e<this.h;e++){let t="";for(let i=0;i<this.w;i++)t+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+i]];s.push(t)}return s.join(`
`)}},Qt=class{constructor(s,e,t){this.grid=s;this._i=e*s.w+t}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(s){let e=this.grid.delta(s),t=this._i+e,i=1<<s,n=1<<(s^2);this.grid.data[this._i]|=i,this.grid.data[this._i=t]|=n}directedPath(s,e,t){for(;;){let i=this.y,n=this.x,o=[];if(e<i&&o.push(0),t<n&&o.push(1),e>i&&o.push(2),t>n&&o.push(3),!o.length)return;this.go(s.pick(o))}}},Jr=[-1,0,1,0],Qr=[0,-1,0,1];var At=class extends v{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(t=>this.grid.get(t+2056)).length,R)}initialFillEarly(){let e=new We(this.h,this.w,this.getValidEarlyScreens()),t=0,i=this.targetEarly();for(;t++<20&&e.size<i;)e.addPath(this.random,i)&&(t=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),R}initialFillLate(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|t<<4|2056;this.grid.get(i)||this.grid.set(i,"c")}for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)for(let i of[8,2048]){let n=e<<12|t<<4|2056,o=n+i,a=n+2*i;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(n)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let t of[8,2048]){let i=e|2056,n=i+t,o=i+2*t;if(this.grid.isBorder(n)||this.grid.get(n))continue;this.grid.set(n,"c");let a=this.extract(this.grid,i-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(n,"")}return R}pruneDisconnected(){let e=new Set(this.grid.partition().values()),t=0;for(let i of e)if([...i].some(o=>this.grid.get(o)===this.early))t+=[...i].filter(o=>(o&2056)===2056).length;else for(let o of i){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${V(o)} disconnected`};this.grid.set(o,"")}return t<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):R}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let t of this.orig.tileset){let i=t.edgeIndex(this.early);i!=null&&e.add(i)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},es=class extends At{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new We(this.h,this.w);e.fill();let t=te(e.data.length).slice(e.w),i=this.random.pick(t);if(!e.deleteEdge(i,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,3))return{ok:!1,fail:"initial stair"};e.fixed.add(i);let n=new Set(t);n.delete(i);let o=[];for(let d of this.random.ishuffle(n)){let f=function(b){return e.delete(b)?(e.fixed.add(b),!0):!1},u=this.params.features?.arena??0;if(o.length>=u)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let h=!e.isBorder(d,1),p=!e.isBorder(d,3);if(h&&e.fixed.has(d-1)||p&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!f(d-e.w))return{ok:!1,fail:"initial arena"};if(h&&!f(d-1))return{ok:!1,fail:"initial arena"};if(p&&!f(d+1))return{ok:!1,fail:"initial arena"};let m=d+e.w;if((e.data[m]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(m+e.w,2),e.fixed.add(m),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,f)=>{let u=d%e.w,p=(d-u)/e.w<<12|u<<4|2056;this.grid.set(p,f);for(let m of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(p+m)};l(i,">");for(let d of o)l(d,"a");let c=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&c++;return this.size=c,R}addStairs(e,t){return super.addStairs(e,t?t-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let t=e<<12|2056;for(let i=0;i<this.w;i++){let n=t|i<<4;this.grid.get(n)==="a"&&this.grid.set(n-2048,"c")}}return R}preinfer(){let e=new Map;for(let n=0;n<this.grid.data.length;n++)this.grid.data[n]==="w"&&e.set(this.grid.coord(n),"");let t=this.grid.partition(e),i=new Set;for(let[n,o]of t)this.grid.get(n)==="<"&&i.add(o);return i.size<2?{ok:!1,fail:"stairs bunched"}:R}refineMetascreens(e){for(let t of e.allPos())e.get(t).hasFeature("arena")&&e.set(t,e.rom.metascreens.fortressArena_through);return R}refineEdges(){return!0}};var Oe=class extends At{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return R;let e=new Map;for(let n=0;n<this.grid.data.length;n++)this.grid.data[n]==="r"&&e.set(this.grid.coord(n),"");let t=this.grid.partition(e),i=[];for(let n=0;n<this.grid.data.length;n++)(this.grid.data[n]==="<"||this.grid.data[n]===">"||this.grid.data[n]&&this.grid.isBorder(this.grid.coord(n)))&&i.push(t.get(this.grid.coord(n)));return new Set(i).size<i.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return R}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let n=i|2056,o=n-8,a=o-8,l=n+8,c=l+8,d=n-2048,f=n+2048;if(t.get(n)!=="c"||t.get(d)!=="c"||t.get(f)!=="c")continue;let u=t.isBorder(o)?"":this.extract(t,a-2056),h=t.isBorder(l)?"":this.extract(t,c-2056);if(!/[^ c]/.test(u+h)&&(t.isBorder(o)||(t.set(o,""),t.set(a,""),t.set(a-8,""),t.set(a-2048,""),t.set(a+2048,"")),t.isBorder(l)||(t.set(l,""),t.set(c,""),t.set(c+8,""),t.set(c-2048,""),t.set(c+2048,"")),this.fixed.add(n),this.fixed.add(d),this.fixed.add(f),t.set(n,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},ts=class extends Oe{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new We(this.h,this.w,this.getValidEarlyScreens()),t=2+this.random.nextInt(this.w-4),i=2+this.random.nextInt(this.w-4),n=new Qt(e,this.h-1,i);return n.go(0),n.directedPath(this.random,1,t),n.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),R}addEdges(){let e=-1,t=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(t|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let i=t|this.random.nextInt(e)<<4,n=t|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.grid.set(n,">"),this.grid.set(n-8,""),this.grid.set(n+8,""),this.fixed.add(i),this.fixed.add(n),R}addStairs(){return R}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}},ss=class extends v{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new D(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let f=0;for(let u=0;u<4;u++)d.data.edges[u]==="s"&&(f|=1<<u);e.get(f).push(...d.gridTiles())}let t=1+this.random.nextInt(this.w-2),i=1+this.random.nextInt(this.h-2),n=i<<4|t,o=this.posToGrid(n,2056),a=i<this.h/2?2:0;this.insertTile(n,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){n+=en[a],o=o+_s[a];let f=a^2,u=[];for(let[p,m]of e){if(!(p&1<<f))continue;let b=p&~(1<<f);if(!(d?!b:b))for(let C of m)u.push(p)}let h;for(let p of this.random.ishuffle(u))if(!this.grid.isBorder(o+_s[p])&&this.insertTile(n,this.random.pick(e.get(p)))){h=31-Math.clz32(p&~(1<<f));break}if(h==null)return{ok:!1,fail:"spikes"};a=h}let l=[];for(let d=3;d<this.h-3;d++)for(let f=1;f<this.w-1;f++)l.push(d<<12|f<<4|2056);let c=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let f of _s){if(this.grid.get(d+f)!=="c")continue;this.grid.set(d,"r");let u=2056&~Math.abs(f);this.grid.set(d+u,"r"),this.grid.set(d-u,"r");let h=this.random.pick([-u,u]);this.grid.set(d+2*h,"r"),this.grid.set(d+3*h,"r"),this.grid.set(d+2*h-f,"c"),c=!0;break}if(c)break}if(!c)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return R}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}refine(){return R}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){return[...new Set(a.values())].filter(c=>{for(let d of c)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let n=i(e.traverse()),o=i(e.traverse({flight:!0}));return n===o?{ok:!1,fail:"flight not required"}:R}},_s=[-2048,-8,2048,8],en=[-16,-1,16,1],is=class extends Oe{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],t=0;for(let l of this.random.ishuffle(te(this.w-2,c=>c+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let c=this.h-1<<12|l<<4|2056;if(this.grid.set(c,"c"),this.grid.set(ae(c),"c"),this.grid.set(Q(c),"n"),this.fixed.add(c),this.fixed.add(ae(c)),this.fixed.add(Q(c)),e.push(l),t++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let i=this.w,n=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*n+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;i<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};i+=l,t+=l}let a=this.params.size;for(;t<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};t+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(l){let c=0;for(let d of new Set(l.values()))for(let f of d)if(e.exitType(f)==="edge:bottom"){c+=d.size;break}return c}let n=i(e.traverse({noFlagged:!0})),o=i(e.traverse());if(n===o)return{ok:!1,fail:"bridge didn't matter"};let a=i(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:R}},rs=class extends Oe{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let n=0;n<this.grid.data.length;n++)if(this.grid.data[n]==="r"){e=this.grid.coord(n)-2056;break}if(e==null)throw new Error("no corner");let t=[];for(let n=0;n<this.pattern.length;n++)for(let o=1;o<this.pattern[n].length-1;o++)!((o^n)&1)||this.pattern[n][o]===" "&&t.push(e+(n<<11|o<<3));let i=this.random.shuffle([..."ccrrrrrrrr"]);for(let n of this.random.ishuffle(t)){let o=i[i.length-1];if(!(o==="c"&&[...this.extract(this.grid,n-2056)].filter(a=>a==="r").length<4)&&(this.canSet(n,o)&&this.grid.set(n,i.pop()),!i.length))break}for(let n=0;n<6;n++)this.tryAdd({char:"c"});return R}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let n=this.addStairs(...e);if(!n.ok)return n}let t=0;for(let n of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,n).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(n+8)&&(this.grid.set(n+2056,"<"),e[0]--),this.fixed.add(n+2056),++t>=2))break;let i=this.grid.partition();return new Set(i.values()).size>1?{ok:!1,fail:"orphans"}:R}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:R}checkMeta(e,t){let i=e.traverse(t?{with:t}:{}),n=[];for(let o of new Set(i.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;n.push(a)}return n.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){let l=0;for(let c of new Set(a.values()))for(let d of c)if(e.exitType(d)){l+=c.size;break}return l}let n=i(e.traverse()),o=i(e.traverse({flight:!0}));return n===o?{ok:!1,fail:"flight not required"}:R}};var ns=class extends v{build(){let{h:s,w:e}=this,t=this.orig.rom,i=new We(s,e);i.fill();let n=s*e<28?0:this.random.nextInt(s-1),o=this.random.nextInt(e),a=new Set;function l(w,k){i.delete2(w,k),a.add(w*i.w+k)}function c(w){return!w.startsWith("edge")}a.add(n*i.w+o),o&&l(n,o-1),o<i.w-1&&l(n,o+1),n&&(l(n-1,o),o&&l(n-1,o-1),o<i.w-1&&l(n-1,o+1));for(let w of a)i.fixed.add(w);let d=new Set;for(let w=0;w<4;w++){let k=w&1?s:e,M=this.random.shuffle(te(k)),N=w&2?k:0,Z=this.params.edges?.[w]??0;for(;Z&&M.length;){let ie=w&1?M.pop():N,re=w&1?N:M.pop(),H=ie*i.w+re;!i.data[H]||i.fixed.has(H)||(i.addEdge(ie,re,w),d.add(ie<<4|re),Z--)}if(Z)return{ok:!1,fail:`could not add all edges: ${w} ${Z}
${i.toGrid("c").show()}
${i.data}`}}let f=0,u=i.h*i.w*(this.random.next()*.15+.4);for(let w of this.random.ishuffle(te(i.data.length<<2))){let k=w>>>2,M=w&3;if(!i.isBorder(k,M)&&i.deleteEdge(k,M)&&++f>=u)break}let h=new Set,p=new Set,m=[],b=[],C;for(let w of this.orig.tileset){if(w.hasFeature("arena")){C=w;continue}else if(w.hasFeature("empty")){m[0]=w;continue}let k=w.edgeIndex("s");if(k==null)throw new Error("bad edges");let M=w.data.exits?.some(N=>c(N.type));(M?b:m)[k]=w,(w.sid<0?p:h).add(w.sid)}if(!C)throw new Error("never found arena");let g=i.consolidate(this.random,h.size),y=new Set(g.map(w=>m[w].sid));if(!y.size)return{ok:!1,fail:"consolidate failed"};let x=[...p].filter(w=>y.has(w)),E=[...h].filter(w=>!y.has(w));if(x.length>E.length)throw new Error("out of space");if(x.length){let w=-1;for(;t.metascreens.getById(w).length;)w--;let k=w;for(let M=0;M<x.length;M++)t.metascreens.renumber(E[M],w),t.metascreens.renumber(x[M],E[M]),w=x[M];t.metascreens.renumber(k,x[x.length-1])}let I=new xe(this.orig.id,this.orig.tileset,s,e);for(let w=0;w<i.h;w++)for(let k=0;k<i.w;k++){let M=w===n&&k===o;I.set(w<<4|k,M?C:m[i.data[w*i.w+k]])}let F=[...this.orig.exits()].filter(w=>c(w[1])).length;for(let w of this.random.ishuffle(I.allPos())){if(!F)break;if(d.has(w))continue;let k=w&15,M=w>>>4,N=b[i.data[M*i.w+k]];!N||(I.set(w,N),F--)}return F?{ok:!1,fail:"could not place all doors"}:R}};function Di(r){let{swamp:s}=r.metatilesets,e=r.metascreens,t=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[i,n,o]of t)s.getTile(i).copyFrom(n).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var os=class extends v{initialFill(){let e=this.size+3,t=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(Ke(t))||this.fixed.add(Ke(t,2)),this.grid.isBorder(Ce(t))||this.fixed.add(Ce(t,2)),this.grid.set(t,">"),this.fixed.add(t),this.grid.set(ae(t),"w"),this.fixed.add(ae(t)),this.fixed.add(Ke(t)),this.fixed.add(Ce(t));let i=this.random.nextInt(this.w)<<4|2056,n=Q(i,2);if(this.grid.set(i,"<"),this.fixed.add(i),this.grid.set(Q(i),"w"),this.fixed.add(Q(i)),this.grid.set(n,"w"),this.fixed.add(n),this.grid.set(Q(n),"w"),this.fixed.add(Q(n)),this.fixed.add(Ke(n)),this.fixed.add(Ce(n)),!this.tryConnect(ae(t,2),Q(n,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<e;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return R}refine(){return R}refineEdges(){return!0}addArenas(){return!0}addStairs(){return R}refineMetascreens(e){console.log(e.show());for(let i=0;i<e.height;i++)for(let n=0;n<e.width;n++){let o=i<<4|n,a=e.get(o),l=a.edgeIndex("w");if(a.hasFeature("arena"))this.arena=o+16<<8|1;else if(l===5){if(o<16||!e.get(o-16).hasFeature("arena")){e.set(o,e.rom.metascreens.goaWideHallNS_stairs);let c=(o<<8|o<<4)&61680|2056;this.grid.set(c,"H")}}else l===1&&(this.stair=o<<8|2)}if(this.reachable=void 0,!this.checkMeta(e))return{ok:!1,fail:"initial meta check"};console.log(e.show());let t=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let i=0;i<e.width;i++)for(let n=0;n<e.height;n++){let o=n<<12|i<<4|2056,a=0;for(;n+a<e.height&&this.grid.get(o+a*4096)==="H";)a++;if(!a)continue;let l=[new Map,new Map];for(let d=0;d<a;d++)l[d&1].set(n+d<<4|i,t);let c=!1;for(let d of this.random.ishuffle(l)){if(!d.size){c=!0;continue}if(!!this.checkMeta(e,d)){for(let[f,u]of d)e.set(f,u),this.grid.set(o+4096*((f>>4)-n),"=");c=!0;break}}if(!c)return{ok:!1,fail:"could not rectify hallway"};n+=a}return super.refineMetascreens(e)}checkMeta(e,t){let i=t?{with:t}:{},n=e.traverse(i),o=n.get(this.stair);return o!==n.get(this.arena)?(console.log(`stair not connected to arena
${e.show()}`),!1):this.reachable==null?o&&o.size<n.size*.95?(console.log("too small"),!1):(this.reachable=o?.size,!0):o?.size>this.reachable*.95}};function Ni(r,s){let{metatilesets:{cave:e,fortress:t,iceCave:i,labyrinth:n,pyramid:o}}=r;r.metascreens.registerFix(14,1);{for(let l of[n,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[t,n,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[i,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);n.getTile(23).copyFrom(198).setAlternative(197),n.getTile(24).copyFrom(196).setAlternative(197)}let a=new D(()=>[]);for(let l of r.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,c]of a){let d=r.screens[l],f=c.map(p=>p.data.tilesets.labyrinth?.removeWall),[u,...h]=new Set(f.filter(p=>p!=null));if(u!=null){if(d.set2d(u,[[197,197],[208,197]]),h.length)throw new Error("bad remove");for(let p=0;p<f.length;p++)f[p]==null&&(c[p].data.tilesets.labyrinth.addWall=[u])}if(!(c.length<2)){if(c.length>2){let p=s.pick(c.filter(m=>m.data.tilesets.labyrinth?.addWall));c.splice(c.indexOf(p),1),p.remove()}for(let p of c){let m=p.data.tilesets.labyrinth?.addWall;if(m!=null){p.data.mod="block";for(let b of m)d.set2d(b,[[23,23],[24,24]])}else p.flag="always"}}}}var as=class{constructor(s){this.location=s}shuffle(s){if(this.meta)throw new Error("impossible");let e=this.location.meta;sn(e,s),s.nextInt(2)&&rn(this.location.rom);let t=[...e.exits()].filter(a=>a[1]==="stair:up"),i=[...e.exits()].filter(a=>a[1]==="stair:down");s.shuffle(t),s.shuffle(i);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?t:i).pop();e.setExit(l[0],l[1],a[2])}if(t.length!==i.length)throw new Error("length mismatch");let n=s.shuffle([...i]);for(let a=0;a<i.length;a++)i[a]===n[a]&&(s.shuffle(n),a=-1);let o=this.location.id<<8;for(let a=0;a<t.length;a++)e.setExitOneWay(t[a][0],t[a][1],[o|i[a][0],i[a][1]]),e.setExitOneWay(n[a][0],n[a][1],[o|t[a][0],t[a][1]]);this.meta=e}finish(){}};function sn(r,s){let e=s.nextInt(2)+6,t=s.nextInt(3)+2;if(e===7&&t===3)return;let{branchNWSE:i,branchNWE:n,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:c}=r.rom.metascreens,d=e<<4|t,f=o;e===7&&t===1&&(f=c),e===7&&t===5&&(f=l),r.set2d(99,[[i],[i],[i]]),r.set2d(d-16,[[n],[a],[f]]),r.moveExit(115,d)}function rn(r){let s=r.locations.Pyramid_Draygon.meta,e=r.locations.Pyramid_Main.meta,{metascreens:{hallSE:t,deadEndW_downStair:i,wideHallNE:n,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=r;s.width=2,s.set2d(0,[[null,l],[null,a],[n,o]]),s.moveExit(32,1),e.set2d(3,[[t,i]]),e.moveExit(3,4),e.attach(4,s,1)}function Wi(r,s,e){let t=new Ds(r),i=new Ns(s,t),n=new Ws(e,i);return[t,i,n]}var Ds=class extends v{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let t=this.insertPattern(e,{top:1,bottom:1});if(!t.ok)return t;this.addAllFixed();for(let i=0;i<this.grid.data.length;i++){if(this.grid.data[i]!==">")continue;let n=this.grid.coord(i);this.stair=n>>>8&240|n>>>4&15}return R}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let t of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,t)===" c  c  c "){this.grid.set(t+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return R}addLateFeatures(){return R}addStairs(){return R}},Ns=class extends v{constructor(e,t){super(e);this.location=e;this.upper=t;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],t=!0,i=this.upper.meta,n=this.upper.stair;if(i.get(n).isEmpty()||(n+=16,t=!1),n==null)throw new Error("no stair found");for(let x of i.allPos())i.get(x).hasFeature("overpass")&&e.push(x);this.random.shuffle(e);let o=n>>>4,a=n&15,l=a,c=o;for(let x of e){let E=x>>>4,I=x&15;o=Math.min(o,E),a=Math.min(a,I),l=Math.max(l,I),c=Math.max(c,E)}let d=c-o+1,f=l-a+1,u=o<<4|a,h=1+this.random.nextInt(this.w-f-2),m=(this.random.nextInt(this.h-d-(t?1:0))<<4|h)-u,b=(n&15)-a<f/2;n+=m;for(let x=0;x<e.length;x++)e[x]+=m;let C=t?"    <  c ":b?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(n,C)){let x=[-1,1,16,-16,15,17,-15,-17],E=!1;for(let I of this.random.ishuffle(x))if(this.insertTile(n+I,C)){n+=I,E=!0;break}if(!E)throw new Error("Could not insert stair")}this.stair=n,this.addAllFixed(),this.count=3;let g=b?1:-1,y=t?16:g;return!e.includes(n+g)&&!this.tryConnect(this.posToGrid(n+y,2056),this.posToGrid(e[0]-g,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+g,2056),this.posToGrid(e[1]+g,2056),"c",10)?R:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"could not populate"}}refine(){return R}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let t=e+2056;if(!(this.fixed.has(t)||this.grid.get(t))&&!(this.grid.get(Ke(t,2))||this.grid.get(Ce(t,2)))&&this.grid.get(Q(t,2))==="c"&&!!this.canSetAll(new Map([[Q(t),"c"],[t,"a"],[ae(t),"c"],[ae(t,2),"c"]])))return this.grid.set(Q(t),"c"),this.grid.set(t,"a"),this.grid.set(ae(t),"c"),this.fixed.add(t),this.fixed.add(ae(t,2)),!0}return!1}addStairs(e=0,t=0){return super.addStairs(e-1,t)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,t=this.upper.stair,i=this.stair;t!=null&&i!=null&&this.meta.attach(i,e,t,"stair:up","stair:down")}},Ws=class extends v{constructor(e,t){super(e);this.main=t}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let t of e.allPos())if(e.get(t).hasFeature("arena"))return t;throw new Error("never found arena")}initialFill(){let e=this.main.meta,t=this.findArena(e),i=this.posToGrid(t,2056);return this.grid.set(i,"a"),this.grid.set(ae(i),"c"),this.grid.set(Q(i),"c"),this.fixed.add(i),this.fixed.add(Q(i)),this.fixed.add(Q(i,2)),R}addEdges(){let e=10,t=2+this.random.nextInt(2);for(;this.count<t&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"addEdges"}}refine(){return R}addLateFeatures(){return R}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let t=e.value,i=this.findArena(t),n=this.main.meta;return t.set(i+15,this.orig.tileset.unreachableVariant(n.get(i+15))),t.set(i+16,this.orig.tileset.unreachableVariant(n.get(i+16))),t.set(i+17,this.orig.tileset.unreachableVariant(n.get(i+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,t=this.findArena(this.meta);super.finishInternal(),e.setExit(t,"seamless:up",[this.meta.id<<8|t,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},Os=class extends v{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return Re.writeGrid2d(this.grid,0,Os.PATTERN),this.count=36,R}addSpikes(){let e=this.random.nextInt(4);for(let n=1;n<10;n++)for(let o=0;o<4;o++){let a=2*o+5+n*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),n===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let t=0;for(let n of this.random.ishuffle(this.grid.screens())){if(t===3)break;let o=n|2056,a=ae(o),l=ae(o,2),c=Q(o),d=Q(o,2),f=Ke(o),u=Ce(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(c)==="s"||this.grid.get(d)==="s")continue;let h=[],p=[];for(let m of[c,f,u])this.grid.get(m)==="c"&&(this.grid.get(2*m-o)==="s"?p.push(m):h.push(m));if(!(p.length>1)&&!(!h.length&&!p.length)){for(;h.length+p.length>1&&!(h.length+p.length===2&&!h.includes(c)&&!p.includes(c));){let[m]=h.splice(this.random.nextInt(h.length),1);this.grid.set(m,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),t++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return R}},Pt=Os;Pt.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "];function Oi(r,s,e){let t=r.locations;nn(r,e);let i=new Vt(r,e);i.add(),i.shuffles.length||i.add(new v(t.EastCave1),new v(t.EastCave2),new v(t.EastCave3),...Zt(t.SealedCave1,t.SealedCave2),new v(t.SealedCave3),new v(t.SealedCave4),new v(t.SealedCave5),new v(t.SealedCave6),new v(t.SealedCave7),new v(t.SealedCave8),new v(t.WindmillCave),new v(t.ZebuCave),new ns(t.Swamp),new v(t.MtSabreWest_Cave1),new v(t.MtSabreWest_Cave2),new v(t.MtSabreWest_Cave3),new v(t.MtSabreWest_Cave4),new v(t.MtSabreWest_Cave5),new v(t.MtSabreWest_Cave6),new it(t.MtSabreWest_Cave7),new v(t.MtSabreNorth_Cave1),new v(t.MtSabreNorth_Cave2),new v(t.MtSabreNorth_Cave3),new v(t.MtSabreNorth_Cave4),new v(t.MtSabreNorth_Cave5),new v(t.MtSabreNorth_Cave6),new v(t.MtSabreNorth_Cave7),new v(t.MtSabreNorth_Cave8),new v(t.MtSabreNorth_Cave9),new v(t.MtSabreNorth_LeftCell2),new v(t.MtSabreNorth_SummitCave),new v(t.KirisaPlantCave1),new v(t.KirisaPlantCave2),new v(t.KirisaPlantCave3),new v(t.FogLampCave1),new v(t.FogLampCave2),new v(t.FogLampCave3),new Jt(t.FogLampCaveDeadEnd),...Zt(t.FogLampCave5,t.FogLampCave4,!0),...Zt(t.FogLampCave7,t.FogLampCave6),new it(t.WaterfallCave1),new v(t.WaterfallCave2),new st(t.WaterfallCave3),new ts(t.WaterfallCave4),new Oe(t.EvilSpiritIsland2).requirePitDestination(),new it(t.EvilSpiritIsland3),new Oe(t.EvilSpiritIsland4),new es(t.SaberaPalace1).requirePitDestination(),new v(t.SaberaPalace2),new v(t.SaberaPalace2_West),new v(t.JoelSecretPassage),new v(t.MtHydra_Cave1),new v(t.MtHydra_Cave2),new v(t.MtHydra_Cave3),new v(t.MtHydra_Cave4),new v(t.MtHydra_Cave5),new v(t.MtHydra_Cave6),new st(t.MtHydra_Cave7),new v(t.MtHydra_Cave8),new v(t.MtHydra_Cave9),new v(t.MtHydra_Cave10),new st(t.Styx1).setUpEdgeType("c"),new is(t.Styx2).requirePitDestination(),new v(t.Styx3),new rs(t.OasisCaveMain),new v(t.DesertCave1),new v(t.DesertCave2),new v(t.Pyramid_Branch),new as(t.Pyramid_Main),new Yt(t.Crypt_Entrance),new st(t.Crypt_Hall1).setUpEdgeType("c"),new v(t.Crypt_DeadEndLeft),new v(t.Crypt_DeadEndRight),new v(t.Crypt_Branch),new v(t.Crypt_Hall2),new os(t.GoaFortress_Kelbesque),new Oe(t.GoaFortress_Sabera),new v(t.GoaFortress_Mado1).requirePitDestination(),new v(t.GoaFortress_Mado2),new v(t.GoaFortress_Mado3),new v(t.GoaFortress_Karmine1),new v(t.GoaFortress_Karmine2),new v(t.GoaFortress_Karmine4),new Pt(t.GoaFortress_Karmine6),...Wi(t.GoaFortress_Karmine3,t.GoaFortress_Karmine5,t.GoaFortress_Kensu),new ss(t.OasisCave_Entrance)),i.shuffleAll(),console.log(String(i))}function nn(r,s=new tt(1)){Ri(r),Di(r),Ni(r,s)}var xt=typeof __VERSION__=="object"?__VERSION__:{},zs=xt.STATUS||"unstable",zi=xt.VERSION||"HEAD",ql=xt.LABEL||"HEAD",$i=xt.HASH||"HEAD",Ul=xt.DATE||new Date,jl=xt.PREV||"";var $s=class{constructor(s,e,t,i){this.filename=s,this.chrdata=Array.from(new Uint8Array(e)),this.palette=t,this.rendered=Array.from(new Uint8Array(i.data))}};async function Vl(r){let s=document.createElement("canvas");s.width=112,s.height=100;let e=s.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,s.width,s.height);let t=new ImageData(new Uint8ClampedArray(r.rendered),128,128),i=await createImageBitmap(t,{resizeQuality:"pixelated"});return e.drawImage(i,0,0,16,24,24,2,16*4,24*4),s.toDataURL("image/png")}async function an(r,s){let e=r.byteLength/16,t=8,i=0,n=document.createElement("canvas");n.width=128,n.height=128;let a=n.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(r);for(let c=0;c<e;++c){let d=c*16,f=c%16*8,u=Math.floor(c/16)*8;for(let h=0;h<t;++h){let p=l[d+h],m=l[d+h+8];for(let b=0;b<t;++b){let C=7-b,g=p>>C&1,y=(m>>C&1)<<1,x=(g|y)+i*4,E=fn[s[x]],I=(f+b)*4+(u+h)*4*128;a.data[0+I]=E[0],a.data[1+I]=E[1],a.data[2+I]=E[2],a.data[3+I]=x==0?0:255}}}return a}var ds=class{constructor(s,e,t,i){this.name=s,this.converter=e,this.nssdata=t,this.description=i}static async init(s,e,t,i){let n=await t;return new ds(s,e,n,i)}static applyPatch(s,e,t){if(!ds.isCustom(s))return;let i=t?262144:0;for(let[n,o]of rt.getChr(s.converter))for(let a of o)for(let l=0;l<16;++l)e[a+l+i]=s.nssdata.chrdata[n*16+l];for(let[n,o]of rt.getPalette(s.converter))for(let a of o)switch(n){case"color0":e[a]=s.nssdata.palette[0];break;case"color1":e[a]=s.nssdata.palette[1];break;case"color2":e[a]=s.nssdata.palette[2];break;case"color3":e[a]=s.nssdata.palette[3];break;case"metasprite":e[a+i]=0;break}}},Ve=ds;Ve.isCustom=s=>s.name!="Simea";var ls=class{constructor(){this.mapping=new Map;this.mapping.set("simea",new Map([["Simea",Ve.init("Simea","simea",Hi("Simea.nss"),"The original main character of Crystalis")],["Mesia",Ve.init("Mesia","simea",Hi("Mesia.nss"),"Secondary protagonist Mesia takes the spotlight! Artwork by jroweboy")]]))}static get(s){return this.instance||(this.instance=new ls),this.instance.mapping.get(s)}};function S(r,s,e){return 262160+r*8192+s*4096+e*16}var rt=class{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.simeaChrMapping=this.generateSimeaMapping(),this.simeaPaletteMapping=this.generateSimeaPalette(),this.chrMapping.set("simea",this.simeaChrMapping),this.paletteMapping.set("simea",this.simeaPaletteMapping)}static getChr(s){return this.instance||(this.instance=new rt),this.instance.chrMapping.get(s)}static getPalette(s){return this.instance||(this.instance=new rt),this.instance.paletteMapping.get(s)}generateSimeaPalette(){let s=new Map,e=27888+16;return s.set("color0",[e+0]),s.set("color1",[e+1]),s.set("color2",[e+2]),s.set("color3",[e+3]),s.set("metasprite",[245844+16]),s}generateSimeaMapping(){let t=new Map;t.set(0,[S(8,0,26)]),t.set(1,[S(8,0,27)]),t.set(16,[S(8,0,0)]),t.set(17,[S(8,0,1)]),t.set(32,[S(8,0,32)]),t.set(33,[S(8,0,33)]),t.set(2,[S(8,0,28)]),t.set(3,[S(8,0,29)]),t.set(18,[S(8,0,2)]),t.set(19,[S(8,0,3)]),t.set(20,[S(8,0,4)]),t.set(21,[S(8,0,5)]),t.set(34,[S(8,0,34)]),t.set(35,[S(8,0,35)]),t.set(36,[S(8,0,36)]),t.set(37,[S(8,0,37)]),t.set(6,[S(8,0,30)]),t.set(7,[S(8,0,31)]),t.set(22,[S(8,0,6)]),t.set(23,[S(8,0,7)]),t.set(38,[S(8,0,38)]),t.set(39,[S(8,0,39)]),t.set(64,[S(8,0,20)]),t.set(65,[S(8,0,21)]),t.set(80,[S(8,0,52)]),t.set(81,[S(8,0,53)]),t.set(50,[S(8,0,60)]),t.set(51,[S(8,0,61)]),t.set(66,[S(8,0,24)]),t.set(67,[S(8,0,25)]),t.set(82,[S(8,0,56)]),t.set(68,[S(8,0,22)]),t.set(69,[S(8,0,23)]),t.set(84,[S(8,0,54)]),t.set(112,[S(8,0,14)]),t.set(113,[S(8,0,15)]),t.set(128,[S(8,0,46)]),t.set(129,[S(8,0,47)]),t.set(114,[S(8,0,18)]),t.set(115,[S(8,0,19)]),t.set(130,[S(8,0,48)]),t.set(131,[S(8,0,51)]),t.set(116,[S(8,0,16)]),t.set(117,[S(8,0,17)]),t.set(133,[S(8,0,49)]),t.set(160,[S(8,0,8)]),t.set(161,[S(8,0,9)]),t.set(176,[S(8,0,40)]),t.set(146,[S(8,0,58)]),t.set(147,[S(8,0,59)]),t.set(162,[S(8,0,12)]),t.set(163,[S(8,0,13)]),t.set(178,[S(8,0,44)]),t.set(179,[S(8,0,45)]),t.set(164,[S(8,0,10)]),t.set(165,[S(8,0,11)]),t.set(181,[S(8,0,43)]);let i=new Map(t);for(let[o,a]of i){let l=o+8,c=a.map(d=>d+1024);t.set(l,c)}t.set(192,[S(11,1,0)]),t.set(193,[S(11,1,1)]),t.set(208,[S(11,1,2)]),t.set(209,[S(11,1,3)]),t.set(224,[S(11,1,4)]),t.set(225,[S(11,1,5)]),t.set(194,[S(11,1,36)]),t.set(195,[S(11,1,37)]),t.set(210,[S(11,1,6)]),t.set(211,[S(11,1,7)]),t.set(226,[S(11,1,38)]),t.set(227,[S(11,1,39)]),t.set(196,[S(11,1,32)]),t.set(197,[S(11,1,33)]),t.set(212,[S(11,1,34)]),t.set(213,[S(11,1,35)]),t.set(214,[S(11,1,20)]),t.set(215,[S(11,1,21)]),t.set(230,[S(11,1,22)]),t.set(231,[S(11,1,23)]),t.set(54,[S(11,1,12)]),t.set(55,[S(11,1,13)]),t.set(70,[S(11,1,50)]),t.set(71,[S(11,1,51)]),t.set(86,[S(11,1,46)]),t.set(87,[S(11,1,47)]),t.set(102,[S(11,1,18)]),t.set(103,[S(11,1,19)]),t.set(118,[S(11,1,8)]),t.set(119,[S(11,1,9)]),t.set(134,[S(11,1,40)]),t.set(135,[S(11,1,41)]),t.set(150,[S(11,1,44)]),t.set(151,[S(11,1,45)]),t.set(166,[S(11,1,10)]),t.set(167,[S(11,1,11)]),t.set(182,[S(11,1,42)]),t.set(183,[S(11,1,43)]);let n=o=>[S(8,0,o)+1024*2,S(8,0,o)+1024*3,S(8,1,o),S(8,1,o)+1024,S(8,1,o)+1024*2];return t.set(240,n(16)),t.set(241,n(17)),t.set(242,n(18)),t.set(243,n(19)),t.set(244,n(20)),t.set(245,n(21)),t.set(246,n(22)),t.set(247,n(23)),t.set(248,[S(8,1,237)]),t.set(249,n(25)),t.set(250,n(26)),t.set(252,n(48)),t.set(253,n(49)),t.set(254,n(50)),t.set(255,n(51)),t}};async function Hi(r){let s=Si()[r],e=r.replace(/^.*[\\\/]/,"");return cn(e,s)}function qi(r){let s="",e="",t=0;for(;t<r.length;)if(r[t]==="["){++t;let i=r.indexOf("]",t),n=parseInt(r.slice(t,i),16)-1;s+=e.repeat(n),t=i+1}else e=r.slice(t,t+2),s+=e,t+=2;return s}function Ui(r,s){return r.match(new RegExp(".{1,"+s+"}","g"))||[]}function ln(r){let s=Ui(r,2).map(e=>parseInt(e,16));return new Uint8Array(s)}function dn(r){return r.map(s=>parseInt(s,16))}async function cn(r,s){let e=new Map(s.split(`
`).filter(a=>a.includes("=")).map(a=>a.split("=")).map(a=>[a[0],a[1]])),t=e.get("Palette")||"",i=dn(Ui(qi(t).slice(0,32),2)),n=ln(qi(e.get("CHRMain")||"")),o=await an(new Uint8ClampedArray(n),i);return new $s(r,n,i,o)}var fn=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]];function Us(r,s,e){return new Hs(s,e).smudge(r)}var ji;(s=>{function r(e,t=Rt.P02){return i=>Promise.resolve(Us(i,t,e))}s.forKnownPrg=r})(ji||(ji={}));function*hn(r){let s=0;for(;s<r.length;){let e=r.indexOf(`
`,s)+1||r.length;yield r.substring(s,e),s=e}}var Hs=class{constructor(s,e){this.cpu=s;this.prg=e}smudge(s){let e="";for(let t of hn(s))e+=this.smudgeLine(t);return e}smudgeLine(s){let e=/^([^;]*?)<@([0-9a-f]+)(?: (.*?))?@>(.*\n?)$/i.exec(s);if(e){let[,i,n,o,a]=e,l=parseInt(n,16),c=un(this.cpu,this.prg,l,o);return i+c+a}let t="";for(;;){let i=/^([^;]*?)\[@([0-9a-f]+)(:[0-9]+|:[wdb])?@\](.*\n?)/i.exec(s);if(!i){t+=s;break}let[,n,o,a,l]=i;s=l,t+=n;let c=parseInt(o,16);t+=mn(this.prg,c,a)}return t}};function un(r,s,e,t){let i=t,[n,o]=r.disasm(s[e])||["brk","imp"],a=r.argLen(o);return i||(a>0&&(i=s[e+1]),a>1&&(i=i|s[e+2]<<8)),n+(a?" "+r.format(o,i):"")}function mn(r,s,e){let t=r[s];if(e===":w")return t|=r[s+1]<<8,`($${Ki(t,4)})`;if(/:\d+/.test(e)){let i=parseInt(e.substring(1)),n='"';for(let o=0;o<i;o++){let a=String.fromCharCode(r[s+o]);'"\\'.includes(a)&&(a="\\"+a),n+=a}return n+='"',n}else return e===":d"?String(t):e===":b"?`%${t.toString(2).padStart(8,"0")}`:`$${Ki(t,2)}`}var qs=class{constructor(s){this.plain=s}fix(s,e,t){}format(s,e){return this.plain}},nt=class extends qs{constructor(e){super("");this.fix=e}static set(e){return new nt(t=>t.set(e))}},gt=nt;gt.push=new nt(e=>e.push()),gt.alt=new nt(e=>e.alt()),gt.pop=new nt(e=>e.pop()),gt.merge=new nt(e=>e.merge());function Ki(r,s=2){return r.toString(16).padStart(s,"0")}var be={of:(...r)=>{let s=0n;for(let e of r)s|=1n<<BigInt(e);return s},from:r=>{let s=0n;for(let e of r)s|=1n<<BigInt(e);return s},containsAll:(r,s)=>!(s&~r),with:(r,s)=>r|1n<<BigInt(s),without:(r,s)=>r&~(1n<<BigInt(s)),has:(r,s)=>!!(r&1n<<BigInt(s)),bits:r=>{let s=[],e=0;for(;r;){let t=Number(r&0xffffffffn),i=32;for(;t;){let n=Math.clz32(t)+1;i-=n,t<<=n,n===32&&(t=0),s.push(e|i)}r>>=32n,e+=32}return s},clone:r=>r,empty:r=>!r,difference:(r,s)=>r&~s};var cs=class{constructor(s){this.worlds=s;let e=new Set,t=new Set,i=new Map,n=new Map;for(let f=0;f<s.length;f++){let u=s[f],h=f<<24;for(let[p,m]of u.requirements){e.add(h|p);for(let b of m)for(let C of b)t.add(h|C)}for(let[p,m]of u.items)n.set(h|p,m);for(let[p,m]of u.slots)i.set(h|p,m)}this.itemInfos=new Map(n),this.slotInfos=new Map(i),this.progression=new Set(t);for(let f of n.keys())t.add(f);let o=new Set,a=new Set,l=new Set;for(let f of t)(e.has(f)?o:l).add(f);for(let f of e)t.has(f)||a.add(f);this.common=o.size,this.slots=new Es([...o,...a]),this.items=new Es([...o,...l]);let c=[],d=[];for(let f=0;f<s.length;f++){let u=f<<24;for(let[h,p]of s[f].requirements){let m=this.slots.index(u|h);if(m==null)throw new Error(`Provided a non-slot? ${V(h)}`);for(let b of p){let C=[...b].map(g=>this.items.index(u|g)??Ie());(c[m]||(c[m]=[])).push(be.from(C));for(let g of C)(d[g]||(d[g]=new Set)).add(m)}}}for(let f=0;f<this.slots.length;f++)if(!c[f]||!c[f].length){let u=this.slots.get(f)??NaN,h=this.checkName(u);console.error(`Nothing provided $${V(u)}: ${h} (index ${f})`)}this.graph=new vs(c),this.unlocks=new vs(d.map(Ot))}async shuffle(s,e,t=200,i,n){i&&i.addTasks(Math.floor(t/10));for(let o=0;o<t;o++){i&&o%10===9&&(i.addCompleted(1),await new Promise(requestAnimationFrame));let a=new Is;this.prefill(a,e);let l=this.compressFill(a),c=this.itemPool(l.values(),e),d=be.from(new Set(c)),f=Math.floor(o/5);if(!this.fillInternal(l,c,d,e,s,f))continue;let u=n?[]:void 0,h=this.traverse(m=>l.get(m),be.of(),u);if(h.size!==this.slots.length){let m=y=>`${String(y).padStart(3)} ${this.slots.get(y).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(y))}`,b=y=>`${String(y).padStart(3)} ${this.items.get(y).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(y))}`,C=new Set([...this.slots].map(y=>y[0]));for(let y of h)C.delete(y);let g=new Map;for(let y of C)g.set(m(y),this.graph.get(y).map(x=>`
    `+be.bits(x).map(b).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...g.keys()].sort().map(y=>y+g.get(y)).join(`
  `)}`);continue}this.expandFill(l,a);let p=this.fillNonProgression(a,s,e);if(p!=null){if(i&&i.addCompleted(Math.floor((t-o)/100)),n){for(let[m,b]of a){let C=this.checkName(m).replace(/^[0-9a-f]{3} /,"");n.addSlot(m,C,b)}if(u)for(let[m,...b]of u)(m<this.common||l.has(m))&&n.addCheck(this.slots.get(m),b.map(C=>this.items.get(C)))}return p}}return null}fillInternal(s,e,t,i,n,o){let a=new Set(s.keys());for(let l=e.pop();l!=null;l=e.pop()){if(!be.has(t,l))continue;let c=this.itemInfoFromIndex(l);t=be.without(t,l);let d=this.expandReachable(this.traverse(h=>s.get(h),t),n);i.shuffle(d);let f=!1,u=new Set(s.keys());for(let h of d){if(u.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!(!p||!this.fits(p,c,n))){s.set(h,l),f=!0;break}}if(!f){if(u.clear(),o-- >0){for(let h of d){if(u.has(h)||!s.has(h)||a.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!p||!this.fits(p,c,n))continue;let m=s.replace(h,l)??Ie();t=be.with(t,m),e.push(m),i.shuffle(e),f=!0;break}if(f)continue}return!1}}return!0}expandReachable(s,e){let t=[];for(let i of s){let n=this.slotInfoFromIndex(i);!n||e.preserveUniqueChecks()&&!n.unique||Vi(t,i,n.weight||1)}return t}itemPool(s,e){let t=new Set(s),i=[];for(let[n,o]of this.itemInfos){let a=this.items.index(n);a!=null&&(!this.progression.has(n)||t.has(a)||Vi(i,a,o.weight||1))}return e.shuffle(i)}fits(s,e,t){if(t.preserveUniqueChecks()&&e.unique&&!s.unique)return!1;let i=e.preventLoss||s.preventLoss;return!(s.lossy&&e.losable&&i)}fillNonProgression(s,e,t){let i=[[],[],[]],n=[[],[]];for(let[c,d]of this.itemInfos){if(s.hasValue(c))continue;let f=2;d.losable&&d.preventLoss&&(f=1),e.preserveUniqueChecks()&&d.unique&&(f=0),i[f].push(c)}for(let[c,d]of this.slotInfos){if(s.has(c))continue;let f=d.lossy&&d.preventLoss?0:1;n[f].push(c)}for(let c of[...i,...n])t.shuffle(c);let o=c=>this.checkName(c),a=se.count(se.concat(...n)),l=se.count(se.concat(...i));if(l>a)throw console.log(`Slots ${a}:
  ${[...se.concat(...n)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...se.concat(...i)].map(o).join(`
  `)}`),new Error("Too many items");for(let c of se.concat(...i)){let d=!1;for(let f of[...n]){if(d)break;for(let u=0;u<f.length;u++)if(this.fits(this.slotInfos.get(f[u]),this.itemInfos.get(c),e)){s.set(f[u],c),d=!0,f.splice(u,1);break}}if(!d)return console.log(`Slots:
  ${[...se.concat(...n)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(c)}`),null}return new Map(s)}traverse(s,e,t){e=be.clone(e);let i=new Set,n=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}n.add(o)}for(let o of n){if(n.delete(o),i.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,c=a.length;l<c;l++){if(!be.containsAll(e,a[l]))continue;t&&t.push([o,...be.bits(a[l])]),i.add(o);let d=[];o<this.common&&d.push(o);let f=s(o);f!=null&&d.push(f);for(let u of d){e=be.with(e,u);for(let h of this.unlocks.get(u)||[]){if(this.graph.get(h)==null)throw console.dir(this),new Error(`Adding bad node ${h} from unlock ${u}`);n.add(h)}}break}}return i}expandFill(s,e){for(let[t,i]of s){let n=this.slots.get(t),o=this.items.get(i);if(n==null||o==null)throw new Error("missing");e.replace(n,o)}}compressFill(s){let e=new Is;for(let[t,i]of s){let n=this.slots.index(t),o=this.items.index(i);if(n==null||o==null)throw new Error(`Bad slot/item: ${t} ${n} ${i} ${o}`);e.set(n,o)}return e}checkName(s){return this.worlds[s>>>24].checkName(s&16777215)}prefill(s,e){for(let t=0;t<this.worlds.length;t++){let i=t<<24,n=this.worlds[t].prefill(e);for(let[o,a]of n)s.set(i|o,i|a)}}itemInfoFromIndex(s){let e=this.items.get(s);if(e==null)throw new Error(`Bad item: ${s}`);return this.itemInfoFromId(e)}itemInfoFromId(s){let e=this.itemInfos.get(s);if(e==null)throw new Error(`Missing info: ${V(s)}`);return e}slotInfoFromIndex(s){let e=this.slots.get(s);if(e==null)throw new Error(`Bad slot: ${s}`);return this.slotInfoFromId(e)}slotInfoFromId(s){let e=this.slotInfos.get(s);if(e!=null)return e}};function Vi(r,s,e){for(let t=0;t<e;t++)r.push(s)}var fs=class{constructor(s,e,t,i=1){this.rom=s;this._width=t,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Ie(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=te(i,()=>new Uint32Array(t*e)),this.data=this.layers[0];for(let n=0;n<256;n++)for(let o=0;o<4;o++){let a=pn[s.palettes[n].color(o)];this.palettes[n<<2|o]=a|4278190080}}useLayer(s){this.data=this.layers[s]||Ie(`Bad layer: ${s}`)}resizeWidth(s,e){let t=new Uint32Array(e*this._height),i=Math.min(e,this._width);for(let n=0;n<this._height;n++)t.subarray(n*e,n+e+i).set(s.subarray(n*this._width,n*this._width+i));return t}resizeHeight(s,e){let t=new Uint32Array(this._width*e),i=this._width*Math.min(e,this._height);return t.subarray(0,i).set(s.subarray(0,i)),t}get width(){return this._width}set width(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],s);this._width=s,this.canvas.width=s}get height(){return this._height}set height(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],s);this._height=s,this.canvas.height=s}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(s){this.data.fill(s)}clear(s){let e=s!=null?this.palettes[s<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let t=1;t<this.layers.length;t++)this.layers[t].fill(0)}toDataUrl(s=!1){return this.canvas.toDataURL("image/png")}render(){let s=this.canvas,e=this.ctx;for(let t=0;t<this.layers.length;t++){t&&(s=document.createElement("canvas"),s.width=this.canvas.width,s.height=this.canvas.height,e=s.getContext("2d")||Ie());let i=new Uint8Array(this.layers[t].buffer),n=e.getImageData(0,0,this._width,this._height);n.data.set(i),e.putImageData(n,0,0),t&&this.ctx.drawImage(s,0,0)}}rect(s,e,t,i,n){let o=Math.max(0,s),a=Math.max(0,e),l=Math.min(this._height,s+t),c=Math.min(this._width,e+i);for(s=o;s<l;s++)for(e=a;e<c;e++)this.data[s*this._width+e]=n}tile(s,e,t,i){if(e<0||s<0||e+8>=this._width||s+8>=this._height)return;let n=this.rom.patterns.get(t).flip(i<<6);for(let o=0;o<8;o++){let a=n.pixels[8|o]<<1,l=n.pixels[o];for(let c=7;c>=0;c--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(s+o)*this._width+e+c]=this.palettes[i&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,s),this._maxY=Math.max(this._maxY,s+8)}metatile(s,e,t,i,n=0){let o=this.rom.locations[i],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[n&7]);let l=[...o.tilePalettes,127],c=this.rom.tilesets[o.tileset],d=l[c.attrs[t]];for(let f=0;f<2;f++)for(let u=0;u<2;u++){let h=c.tiles[f<<1|u][t],p=a[h&128?1:0]<<6|h&127,m=e+(u<<3),b=s+(f<<3);this.tile(b,m,p,d<<2)}}metasprite(s,e,t,i,n=0,o=0){let a=this.rom.locations[i],l=this.rom.metasprites[t],c=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],f=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],f=!0),!l||!l.used)return;let u=o&l.frameMask;for(let[h,p,m,b]of l.sprites[u]){if(h==128)break;h=Xi(h),p=Xi(p),b=b+n&255;let C=c[b>>6],g=d[m&3]+176&255,y=C<<6|b&63;f&&(h=-8-h,m^=64),this.tile(s+p,e+h,y,g<<2|m>>6)}}text(s,e,t,i=18){for(let n=0;n<t.length;n++)this.tile(s,e+8*n,t.charCodeAt(n)|3840,i<<2)}},pn=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];function Xi(r){return r<128?r:r-256}function W(r){return r}(e=>{function r({id:t},{x:i,y:n}){let o=i>>>8,a=i>>>4&15,l=n>>>8,c=n>>>4&15;return t<<16|l<<12|o<<8|c<<4|a}e.from=r;function s(t,i,n){let o=t;if(i){let a=(o&240)+(i<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(n){let a=(o&15)+n;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=s})(W||(W={}));var Yi=Symbol("[LocationMap data]"),Xe=class extends fs{constructor(e,t=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let i=e.locations[t];this.width=(i.used?i.width:1)*256,this.height=(i.used?i.height:1)*240,this.location=i;let n=o=>{let a=o.offsetX,l=o.offsetY,c=o.target;for(;c&&c!==this.element;)c=c.parentElement;if(!c)return;let d=a>>8,f=Math.floor(l/240),u=a-256*d>>4,h=l-240*f>>4,m=this.location.id<<16|f<<12|d<<8|h<<4|u;Xe.setData(o,{tile:m,target:this})};this.element.addEventListener("mousemove",n),this.element.addEventListener("mousedown",n),this.element.addEventListener("mouseup",n),this.element.addEventListener("click",n),this.redraw()}static getData(e){return e[Yi]}static setData(e,t){e[Yi]=t}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,t=(1-e)*50;this.element.style.transform=`translate(-${t}%,-${t}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,t,i){for(let n of e){if(n>>>16!==this.location.id)continue;let o=n>>>12&15,a=n>>>8&15,l=n>>>4&15,c=n&15,d=240*o+16*l,f=256*a+16*c;i!=null&&(this.useLayer(3),this.rect(d-1,f-1,18,18,0)),this.useLayer(1),e.has(W.add(n,-1,0))||this.rect(d-1,f-1,2,18,t),e.has(W.add(n,0,-1))||this.rect(d-1,f-1,18,2,t),e.has(W.add(n,1,0))||this.rect(d+15,f-1,2,18,t),e.has(W.add(n,0,1))||this.rect(d-1,f+15,18,2,t)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let t=0;t<this.location.width;t++){let i=this.location.screens[e][t];this.drawScreen(this.rom.screens[i],e,t)}this.useLayer(2);for(let e of this.location.spawns){let t=0,{x:i,y:n}=e;n-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;i+=8,n+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(t+=64),o!=null&&this.metasprite(n,i,o,this.location.id,t)}this.render()}drawScreen(e,t,i){let n=t*240,o=i*256,a=this.rom.tilesets[this.location.tileset],l,c=!1;for(let d of this.location.flags)if(d.xs===i&&d.ys===t){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(c=!0);break}for(let d=0;d<240;d+=16)for(let f=0;f<16;f++){let u=e.tiles[d|f];u<32&&(this.flags.has(l)||c)&&(u=a.alternates[u]),this.metatile(n+d,o+f*16,u,this.location.id,0)}}};var G;(d=>{function r(...f){return[[].concat(...f.map(([u])=>u))]}d.and=r;function s(...f){let u=[];for(let h of f){if(h===d.OPEN)return d.OPEN;h!==d.CLOSED&&u.push(...t(h))}return u.length?u:d.CLOSED}d.or=s;function e(f,u){if(f===d.OPEN)return t(u);if(u===d.OPEN)return t(f);if(f===d.CLOSED||u===d.CLOSED)return d.CLOSED;let h=new c;for(let p of f)for(let m of u)h.addList([...p,...m]);return t(h)}d.meet=e;function t(f){return f instanceof c?[...se.map(f,u=>[...u])]:f}d.freeze=t;function i(f){return f instanceof c?f.label():f.map(u=>u.join("&")).join("|")}d.label=i;function n(f){let u=f[Symbol.iterator](),{value:h,done:p}=u.next();if(p||!u.next().done)return!1;let m=h[Symbol.iterator]();return Boolean(m.next().done)}d.isOpen=n;function o(f){let u=f[Symbol.iterator]();return Boolean(u.next().done)}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class c{constructor(u){this.self=u;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(u,h){for(let p of h)if(Array.isArray(p))throw new Error;if(h.has(this.self)||this.map.has(u))return!1;for(let[p,m]of this.map){if(Zi(h,m))return!1;Zi(m,h)&&this.map.delete(p)}return this.map.set(u,h),!0}addRoute(u){return this.addInternal(u[hs],u.deps)}addAll(u){for(let h of u)this.addList(h)}addList(u){let h=[...new Set(u)].sort(),p=new Set(h);this.addInternal(h.join("&"),p)}restrict(u){let h=[...this.map.values()];this.map.clear();for(let p of h)for(let m of u)this.addList([...p,...m])}label(){return[this.map.keys()].join("|")}}d.Builder=c})(G||(G={}));function Zi(r,s){if(r.size<s.size)return!1;for(let e of s)if(!r.has(e))return!1;return!0}var hs=Symbol("depsLabel"),Me=class{constructor(s,e){this.target=s;let t=[...new Set(e)].sort();this.deps=new Set(t),this[hs]=t.join("&"),this.label=`${this.target}:${this[hs]}`}};hs;var us=class{constructor(s){this.rom=s;this.tiles=new D(s=>xn(this.rom,s));this.bosses=new D(s=>new Ks(s));this.statues=new Map;this.flags=new D(s=>new D(e=>new D(t=>new Ys(s,e,t))));this.meets=new D(s=>new D(e=>new Zs(s,e)));this._seamless=new D(s=>new js(s))}tile(s){return s&4?void 0:this.tiles.get(s)}boss(s,e){return e?this.rage||(this.rage=new Xs(s,this.rom.flags.RageSkip.id)):this.bosses.get(s)}statue(s){let e=G.label(s),t=this.statues.get(e);return t||this.statues.set(e,t=new Vs(s)),t}flag(s,e,t){return s||(s=gn),this.flags.get(s).get(e).get(t)}meet(s,e){return this.meets.get(s).get(e)}seamless(s){return this._seamless.get(s)}label(s,e){return s.label?s.label(e):"Terrain"}},O;(f=>{f.FLY=2,f.BLOCKED=4,f.SLOPE=32,f.PAIN=128,f.BITS=166,f.SWAMP=256,f.BARRIER=512,f.SLOPE8=1024,f.SLOPE9=2048,f.DOLPHIN=4096;function d(u,h){return u.label?.(h)??"Terrain"}f.label=d})(O||(O={}));var js=class{constructor(s){this._delegate=s;this.enter=s.enter,this.exit=s.exit}label(s){return`Seamless(${O.label(this._delegate,s)})`}},ot=class{constructor(s,e=G.OPEN){this.enter=s;this.exit=[[15,e]]}get kind(){return"Simple"}label(s){let e=[];return G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`),G.isOpen(this.exit[0][1])||e.push(`exit = ${we(this.exit[0][1],s)}`),`${this.kind}(${e.join(", ")})`}},ms=class{constructor(s,e,t=4){this.enter=s;this.exit=e?[[15&~t,e],[t,G.OPEN]]:[[15,G.OPEN]]}get kind(){return"South"}label(s){if(this.exit.length===1)return ot.prototype.label.call(this,s);let e=[];return G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`),G.isOpen(this.exit[0][1])||e.push(`other = ${we(this.exit[0][1],s)}`),G.isOpen(this.exit[1][1])||e.push(`south = ${we(this.exit[1][1],s)}`),`${this.kind}(${e.join(", ")})`}};function xn(r,s){let e=G.OPEN,t,i=4;return s&O.DOLPHIN&&s&O.FLY?(s&O.SLOPE&&(t=r.flags.ClimbWaterfall.r),e=[[r.flags.CurrentlyRidingDolphin.c],[r.flags.Flight.c]]):(s&O.SLOPE9?t=r.flags.ClimbSlope9.r:s&O.SLOPE8?t=r.flags.ClimbSlope8.r:s&O.SLOPE&&(t=r.flags.ClimbSlope10.r),s&O.FLY&&(e=r.flags.Flight.r)),s&O.SWAMP&&(e=e.map(n=>[r.flags.TravelSwamp.c,...n])),s&O.PAIN&&(e=e.map(n=>[r.flags.CrossPain.c,...n])),s&O.BARRIER&&(e=e.map(n=>[r.flags.ShootingStatue.c,...n]),t=r.flags.ShootingStatueSouth.r,i=1),new ms(e,t,i)}var Ks=class extends ot{constructor(e){super(G.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},Vs=class extends ms{constructor(e){super(G.OPEN,e);this._req=e}get kind(){return"Statue"}},Xs=class{constructor(s,e){this._rageFlag=s;this._rageSkipFlag=e;this.enter=G.OPEN;this.exit=[[11,[[s],[e]]],[4,G.OPEN]]}label(){return"Rage"}},Ys=class extends ot{constructor(s,e,t){if(s.exit.length!==1||t.exit.length!==1)throw console.error(s,t),new Error("bad flag");let i=[[e]],n=e>=0?G.meet(t.enter,i):t.enter,o=e>=0?G.meet(t.exit[0][1],i):t.exit[0][1];super(G.or(s.enter,n),G.or(s.exit[0][1],o))}get kind(){return"Flag"}},gn=new ot(G.CLOSED,G.CLOSED);function Ji(r){let s=[];for(let e=0;e<r.exit.length;e++)for(let t=0;t<4;t++)r.exit[e][0]&1<<t&&(s[t]=e);for(let e=0;e<4;e++)if(s[e]==null)throw new Error(`Bad terrain: ${r.exit.map(t=>t[0]).join(",")}`);return s}var Zs=class{constructor(s,e){this.left=s;this.right=e;let t=Ji(s),i=Ji(e),n=new Set,o=[];for(let a=0;a<4;a++)n.add(t[a]<<2|i[a]);for(let a of n){let[l,c]=s.exit[a>>2],[d,f]=e.exit[a&3];o.push([l&d,G.meet(c,f)])}this.enter=G.meet(s.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(s){if(this.exit.length===1)return ot.prototype.label.call(this,s);let e=[];G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`);for(let[t,i]of this.exit){let n=[t&1?"N":"",t&2?"W":"",t&4?"S":"",t&8?"E":""].join("");e.push(`exit${n} = ${we(i,s)}`)}return`${this.kind}(${e.join(", ")})`}};function we(r,s){let e=[...r],t=e.map(i=>se.isEmpty(i)?"open":[...i].map(n=>s.flags[n]?.debug).join(" & ")).join(") | (");return e.length>1?`(${t})`:e.length?t:"never"}O.debugLabel=we;typeof window=="object"&&(window.debugLabel=we);var ps=class{constructor(s,e){this.rom=s;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",t=>this.click(t)),this.element.addEventListener("mousemove",t=>this.move(t)),this.renderArea(0)}click(s){let e=Xe.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t!=null){if(t.area===this.area){let i=t.exit!=null?this.world.tiles.get(t.exit):null;i&&i.area!==this.area&&(t=i)}t.area&&t.area!==this.area&&this.renderArea(t.area.id)}}move(s){let e=Xe.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t==null)return;let i=t.exit!=null&&!this.area.tiles.has(t.exit);e.target.element.style.cursor=i?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(s){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let i of this.rom.locations){if(!i.used)continue;let n=this.world.locations[i.id]?.areas[Symbol.iterator]().next().value;if(n==null)continue;let o=document.createElement("option");o.textContent=`${V(i.id)} ${i.name}`,o.value=String(n.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[s];let t=document.createElement("pre");t.textContent=`Area ${s}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${O.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([i,n])=>`${i.debug}: ${we(n,this.rom)}`))].join(`
  `)}
Routes:
  ${we(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(t);for(let i of this.area.locations){let n=this.rom.locations[i],o=document.createElement("h2");o.textContent=n.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,n))}}makeLocation(s,e){let t=new Xe(this.rom,e.id);t.maxWidth=574,t.overlayShade(1426063360);for(let i of this.world.locations[e.id].areas)i!==s&&t.overlayArea(i.tiles,4294901760);return t.overlayArea(s.tiles,4278255615,0),t.render(),t.element}};var Lt;(o=>{function r(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=r;function s(){return[0,1,2,3]}o.all=s,o.North=0,o.West=1,o.South=2,o.East=3})(Lt||(Lt={}));var ke;(i=>{function r(n,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let c of[-16,0]){let d=a+c;for(let f of[-16,0]){let u=l+f;yield W.from(n,{x:d,y:u})}}}}}i.trigger=r;function s(n,...o){let a=new Set,l=[...n];for(let[c,d]of o)for(let f of l)a.add(W.add(f,c,d));return a}i.adjust=s;function e(n){let o=[];for(let a=0;a<240;a++)o.push(n&-256|a);return o}i.screen=e;function t(n,...o){let a=new Set,l=[...n];for(let c of o)for(let d of l)a.add(d&65535|c.id<<16);return a}i.atLocation=t})(ke||(ke={}));function at(r){return r}(e=>{e.from=(t,i)=>typeof t=="number"||!i?Number(t)>>>8:t.id<<8|i.y>>>8<<4|i.x>>>8;function s(t){return t>>>8}e.fromTile=s})(at||(at={}));function ce(r){return r}(e=>{function r(t,i){return t*(1<<24)+i}e.of=r;function s(t){return[Math.floor(t/(1<<24)),t%(1<<24)]}e.split=s})(ce||(ce={}));var[]=[V],xs=class{constructor(s,e,t=!1){this.rom=s;this.flagset=e;this.tracker=t;this.terrainFactory=new us(this.rom);this.terrains=new Map;this.checks=new D(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new D(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new pe;this.neighbors=new D(()=>0);this.routes=new D(()=>new G.Builder);this.routeEdges=new D(()=>new Tt);this.requirementMap=new D(s=>new G.Builder(s));this.limeTreeEntranceLocation=-1;this.chestRequirement=G.OPEN;if(e.alwaysMimics()){let n=[s.flags.SwordOfWind,s.flags.SwordOfFire,s.flags.SwordOfWater,s.flags.SwordOfThunder].filter((o,a)=>s.objects.mimic.elements&1<<a);this.chestRequirement=Fe(...n)}for(let i of s.items)for(let n of i.itemUseData)n.kind==="expect"?this.itemUses.get(n.want).push([i,n]):n.kind==="location"&&this.itemUses.get(~n.want).push([i,n]);this.aliases=new Map([[s.flags.ChangeAkahana,s.flags.Change],[s.flags.ChangeSoldier,s.flags.Change],[s.flags.ChangeStom,s.flags.Change],[s.flags.ChangeWoman,s.flags.Change],[s.flags.ParalyzedKensuInDanceHall,s.flags.Paralysis],[s.flags.ParalyzedKensuInTavern,s.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let i of s.locations)this.processLocation(i);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:s,MezameShrine:e,Oak:t,Shyron_ToolShop:i},flags:{AbleToRideDolphin:n,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:c,Barrier:d,BlizzardBracelet:f,BowOfMoon:u,BowOfSun:h,BreakStone:p,BreakIce:m,BreakIron:b,BrokenStatue:C,BuyHealing:g,BuyWarp:y,ClimbWaterfall:x,ClimbSlope8:E,ClimbSlope9:I,ClimbSlope10:F,CrossPain:w,CurrentlyRidingDolphin:k,Flight:M,FlameBracelet:N,FormBridge:Z,GasMask:ie,GlowingLamp:re,InjuredDolphin:H,LeadingChild:fe,LeatherBoots:L,Money:A,OpenedCrypt:Ge,RabbitBoots:Ae,Refresh:q,RepairedStatue:he,RescuedChild:ue,ShellFlute:ze,ShieldRing:dt,ShootingStatue:ee,ShootingStatueSouth:Pe,StormBracelet:Ze,Sword:Ss,SwordOfFire:ct,SwordOfThunder:yt,SwordOfWater:St,SwordOfWind:$e,TornadoBracelet:P,TravelSwamp:Bt,TriggerSkip:Le,UsedBowOfMoon:Ct,UsedBowOfSun:K,WildWarp:me},items:{MedicalHerb:ft,WarpBoots:_t}}=this.rom,X=this.entrance(e),Nr=this.entrance(t);this.addCheck([X],Ye(u,h),[Ge.id]),this.addCheck([X],u.r,[Ct.id]),this.addCheck([X],h.r,[K.id]),this.addCheck([X],Ye(n,ze),[k.id]),this.addCheck([Nr],Ye(fe),[ue.id]),this.addItemCheck([X],Ye(re,C),he.id,{lossy:!0,unique:!0});for(let Ee of this.rom.shops){if(Ee.location===s.id||Ee.location===i.id||!Ee.used||Ee.type!==1)continue;let Dt=[Ee.location<<16|136];for(let Nt of Ee.contents)Nt===ft.id?this.addCheck(Dt,A.r,[g.id]):Nt===_t.id&&this.addCheck(Dt,A.r,[y.id])}let kt=$e.r,vt=ct.r,Et=St.r,It=yt.r;if(!this.flagset.orbsOptional()){let Ee=Fe(c,P),Dt=Fe(o,N),Nt=Fe(l,f),Or=Fe(a,Ze);if(kt=G.meet(kt,Ee),vt=G.meet(vt,Dt),Et=G.meet(Et,Nt),It=G.meet(It,Or),this.flagset.assumeSwordChargeGlitch()){let Wt=function(ui){return zr.map(Cs=>Cs[0]===ui.c?Cs:[ui.c,...Cs])},zr=G.or(kt,vt,Et,It);kt=Wt($e),vt=Wt(ct),Et=Wt(St),It=Wt(yt)}}this.addCheck([X],kt,[p.id]),this.addCheck([X],vt,[m.id]),this.addCheck([X],Et,[Z.id]),this.addCheck([X],It,[b.id]),this.addCheck([X],Fe($e,ct,St,yt),[Ss.id]),this.addCheck([X],M.r,[x.id,F.id]),this.addCheck([X],Fe(M,Ae),[E.id]),this.addCheck([X],Fe(M,Ae),[I.id]),this.addCheck([X],d.r,[ee.id,Pe.id]),this.addCheck([X],ie.r,[Bt.id]);let Wr=this.flagset.changeGasMaskToHazmatSuit()?ie:L;if(this.addCheck([X],Fe(M,Ae,Wr),[w.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([X],L.r,[E.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([X],Ye(k,Ae),[x.id]),this.flagset.fogLampNotRequired()){let Ee=this.flagset.requireHealedDolphinToRide();this.addCheck([X],Ee?H.r:[[]],[n.id])}this.flagset.guaranteeBarrier()||this.addCheck([X],[[A.c,g.c],[A.c,dt.c],[A.c,q.c]],[ee.id,Pe.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([X],[[A.c,M.c]],[ee.id]),this.flagset.guaranteeGasMask()||this.addCheck([X],[[A.c,g.c],[A.c,q.c]],[Bt.id,w.id]),this.flagset.assumeWildWarp()&&this.addCheck([X],G.OPEN,[me.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([X],G.OPEN,[Le.id]),this.addCheck([X],Le.r,[w.id,E.id,I.id]))}addExtraRoutes(){let{flags:{BuyWarp:s,SwordOfThunder:e,Teleport:t,WildWarp:i},locations:{MezameShrine:n}}=this.rom;if(this.addRoute(new Me(this.entrance(n),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new Me(this.entrance(o[0],o[1]&31),[e.c,s.c])),this.addRoute(new Me(this.entrance(o[0],o[1]&31),[e.c,t.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Ie("bad entrance");for(let c of l.enter)this.addRoute(new Me(a,[i.c,...c]))}}consolidateChecks(){for(let[s,e]of this.checks){let t=this.tiles.find(s);if(s!==t){for(let i of e)this.checks.get(t).add(i);this.checks.delete(s)}}}buildRequirementMap(){for(let[e,t]of this.checks)for(let{checks:i,requirement:n}of t)for(let o of i){let a=this.requirementMap.get(o);for(let l of n)for(let c of this.routes.get(e)||[])a.addList([...l,...c])}if(!Qi)return;let s=[];for(let[e,t]of this.requirementMap){let i=n=>this.rom.flags[n].name;for(let n of t)s.push(`${i(e)}: ${[...n].map(i).join(" & ")}
`)}s.sort((e,t)=>e<t?-1:e>t?1:0),console.log(s.join(""))}getLocationList(s="Crystalis"){let e=Qi?t=>t.debug:t=>t.name;return{worldName:s,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:t=>e(this.rom.flags[t]),prefill:t=>{let{Crystalis:i,MesiaInTower:n,LeafElder:o}=this.rom.flags,a=new Map([[n.id,i.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|t.nextInt(4)),a}}}processLocation(s){!s.used||(this.processLocationTiles(s),this.processLocationSpawns(s),this.processLocationItemUses(s))}unionNeighbors(){for(let[s,e]of this.terrains){let t=W.add(s,0,1);this.terrains.get(t)===e&&this.tiles.union([s,t]);let i=W.add(s,1,0);this.terrains.get(i)===e&&this.tiles.union([s,i])}}addAllRoutes(){this.addExtraRoutes();for(let[s,e]of this.neighbors){let[t,i]=ce.split(s),n=this.terrains.get(t),o=this.terrains.get(i);if(!n||!o)throw new Error(`missing terrain ${V(n?t:i)}`);for(let[a,l]of n.exit)if(!!(a&e))for(let c of l)for(let d of o.enter)this.addRoute(new Me(i,[...c,...d]),t)}if(typeof document=="object"){let s=document.getElementById("debug");s&&s.appendChild(new ps(this.rom,this.getWorldData()).element)}}getWorldData(){let s=0,e=new D(()=>({})),t=te(256,()=>({areas:new Set,tiles:new Set})),i=[];for(let n of this.tiles.sets()){let o=this.tiles.find(se.first(n)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?G.freeze(this.routes.get(o)):[];if(!l.length)continue;let c={checks:[],id:s++,locations:new Set,routes:l,terrain:a,tiles:new Set};i.push(c);for(let d of n){let f=d>>>16;c.locations.add(f),c.tiles.add(d),t[f].areas.add(c),t[f].tiles.add(d),e.get(d).area=c}}for(let[n,o]of this.exits)e.has(n)&&(e.get(n).exit=o);for(let[n,o]of this.checks){let a=e.get(n).area;if(!!a)for(let{checks:l,requirement:c}of o)for(let d of l){let f=this.rom.flags[d]||Ie();a.checks.push([f,c])}}return{tiles:e,areas:i,locations:t}}addRoute(s,e){if(e!=null){this.routeEdges.get(e).add(s);for(let a of this.routes.get(e))this.addRoute(new Me(s.target,[...a,...s.deps]));return}let t=new Tt,i=new Tt,n=s;t.add(n);let o=t[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;i.add(a),t.delete(a);let c=new Tt,d=a.target;if(this.routes.get(d).addRoute(a))for(let u of this.routeEdges.get(d))c.add(new Me(u.target,[...a.deps,...u.deps]));for(let u of c)i.has(u)||(t.delete(u),t.add(u))}}recordExits(){for(let[s,e]of this.exits)this.exitSet.add(ce.of(this.tiles.find(s),this.tiles.find(e)));for(let s of this.exitSet){let[e,t]=ce.split(s);if(this.terrains.get(e)!==this.terrains.get(t))continue;let i=ce.of(t,e);this.exitSet.has(i)&&(this.tiles.union([e,t]),this.exitSet.delete(s),this.exitSet.delete(i))}}buildNeighbors(){for(let[s,e]of this.terrains){if(!e)continue;let t=W.add(s,1,0),i=this.terrains.get(t);i&&i!==e&&this.handleAdjacentNeighbors(s,t,Lt.North);let n=W.add(s,0,1),o=this.terrains.get(n);o&&o!==e&&this.handleAdjacentNeighbors(s,n,Lt.West)}for(let s of this.exitSet){let[e,t]=ce.split(s);if(!this.terrains.has(e)||!this.terrains.has(t))continue;let i=ce.of(this.tiles.find(e),this.tiles.find(t));this.neighbors.set(i,this.neighbors.get(i)|1)}}handleAdjacentNeighbors(s,e,t){let i=this.tiles.find(s),n=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=ce.of(n,i);this.neighbors.set(o,this.neighbors.get(o)|1<<t)}if(!this.seamlessExits.has(s)){let o=t^2,a=ce.of(i,n);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(s){let e=new Map,t=new Set,i=(s.id&248)===88;for(let c of s.spawns)if(c.isWall())e.set(at.from(s,c),c.id&3);else if(c.isMonster()&&c.id===63){let d=at.from(s,c)<<8|c.yt<<4;for(let f=4;f<=11;f++)for(let u=-3;u<=3;u++)t.add(W.add(d,u,f))}let n=this.rom.tilesets[s.tileset],o=this.rom.tileEffects[s.tileEffects-179],a=c=>{let d=s.screens[(c&61440)>>>12][(c&3840)>>>8];return o.effects[this.rom.screens[d].tiles[c&255]]},l=(c,d,f)=>{if(c&=O.BITS,s.id===26&&(c|=O.SWAMP),(s.id===96||s.id===104)&&(c|=O.DOLPHIN),s.id===100&&(d&61680)<4144&&(c|=O.DOLPHIN),f&&(c|=O.BARRIER),!(c&O.DOLPHIN)&&c&O.SLOPE){let u=d,h=0;for(;a(u)&O.SLOPE;)u=W.add(u,1,0),h++;h<6?c&=~O.SLOPE:h<9?c|=O.SLOPE8:h<10&&(c|=O.SLOPE9)}if(c&O.PAIN){for(let u of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a(W.add(d,...u))&(O.PAIN|O.FLY))){c&=~O.PAIN;break}}return this.terrainFactory.tile(c)};for(let c=0,d=s.height;c<d;c++){let f=s.screens[c],u=s.id<<8|c<<4;for(let h=0,p=s.width;h<p;h++){let m=this.rom.screens[f[h]],b=u|h,C=b&255,g=e.get(b),y=i?this.rom.flags.AlwaysTrue.id:g!=null?this.wallCapability(g):s.flags.find(I=>I.screen===C)?.flag,x=s.pits.find(I=>I.fromScreen===b);x&&this.exits.set(b<<8|136,x.toScreen<<8|136);let E=this.rom.flags[y]?.logic??{};for(let I=0;I<240;I++){let F=b<<8|I,w=m.tiles[I];E.assumeTrue&&w<32&&(w=n.alternates[w]);let k=s.isShop()?0:o.effects[w],M=t.has(F),N=l(k,F,M);if(w<32&&n.alternates[w]!==w&&y!=null&&!E.assumeTrue&&!E.assumeFalse){let Z=l(o.effects[n.alternates[w]],F,M);Z&&(N=this.terrainFactory.flag(N,E.track?y:-1,Z))}N&&this.terrains.set(F,N)}}}for(let c of s.exits){let{dest:d,entrance:f}=c,u=W.from(s,c),h;if(c.isSeamless()){h=u&65535|d<<16;let p=W.from(s,c);this.seamlessExits.add(p);let m=this.terrains.get(p);m&&this.terrains.set(p,this.terrainFactory.seamless(m))}else h=this.entrance(this.rom.locations[d],f&31);this.exits.set(u,h),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[f].y>160&&(this.limeTreeEntranceLocation=s.id)}}processLocationSpawns(s){for(let e of s.spawns)e.isTrigger()?this.processTrigger(s,e):e.isNpc()?this.processNpc(s,e):e.isBoss()?this.processBoss(s,e):e.isChest()?this.processChest(s,e):e.isMonster()?this.processMonster(s,e):e.type===3&&e.id===224&&this.processKeyUse(ke.screen(W.from(s,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(s,e){let t=this.rom.trigger(e.id);if(!t)throw new Error(`Missing trigger ${e.id.toString(16)}`);let i=this.filterRequirements(t.conditions),n=this.filterAntiRequirements(t.conditions),o=W.from(s,e),a=ke.trigger(s,e),l=[];for(let c of t.flags){let d=this.flag(c);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,i,l),t.message.action){case 25:t.id===134&&!this.flagset.assumeRabbitSkip()?a=ke.adjust(a,[0,-1],[0,1]):t.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=ke.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(n=G.or(n,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(n));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,i);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,i,t.id);break;case 24:{let c=this.flagset.chargeShotsOnly()?G.meet(i,Ye(this.rom.flags.WarpBoots)):i;this.addItemCheck(a,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,i,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,s,i);break;case 27:s===this.rom.locations.Portoa_PalaceEntrance&&(a=ke.adjust(a,[-2,0]),n=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,s,n);break}for(let[c,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([W.from(s,e)],G.OPEN,c,d)}processNpc(s,e){let t=this.rom.npcs[e.id];if(!t||!t.used)throw new Error(`Unknown npc: ${V(e.id)}`);let i=t.spawnConditions.get(s.id)||[],n=this.filterRequirements(i),o=W.from(s,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,f]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,n,d,f);if(t===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,n),t.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(i),t===this.rom.npcs.Rage?(a=ke.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=ke.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):t===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=G.or(this.rom.flags.MesiaRecording.r,Ye(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):t===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(t===this.rom.npcs.FortuneTeller&&(a=ke.adjust(a,[0,0],[2,0])),G.isClosed(n))return;let[[...l]]=n;for(let d of t.globalDialogs){let f=this.flag(~d.condition),u=this.flag(d.condition);if(f?.logic.assumeFalse||u?.logic.assumeTrue)return;f?.logic.track&&l.push(f.id)}let c=t.localDialogs.get(s.id)??t.localDialogs.get(-1)??[];for(let d of c){let f=[...l],u=this.flag(d.condition),h=this.flag(~d.condition);if(u?.logic.track&&f.push(u.id),!u?.logic.assumeFalse&&!h?.logic.assumeTrue&&this.processDialog(a,t,f,d),u?.logic.assumeTrue||h?.logic.assumeFalse)break;h?.logic.track&&l.push(h.id)}}processDialog(s,e,t,i){this.addCheckFromFlags(s,[t],i.flags);let n={lossy:!0,unique:!0};switch(i.message.action){case 8:this.processKeyUse(s,[t]);break;case 20:this.addItemCheck(s,[t],this.rom.flags.SlimedKensu.id,n);break;case 16:this.addItemCheck(s,[t],this.rom.flags.AsinaInBackRoom.id,n);break;case 17:this.addItemCheck(s,[t],256|e.data[1],n);break;case 3:case 10:this.addItemCheck(s,[t],256|e.data[0],n);break;case 9:let o=e.data[1];o!==255&&this.addItemCheck(s,[t],256|o,n);break;case 25:this.addItemCheck(s,[t],this.rom.flags.AkahanaFluteOfLimeTradein.id,n);break;case 26:this.addItemCheck(s,[t],this.rom.flags.Rage.id,n);break;case 27:break}}processLocationItemUses(s){for(let[e,t]of this.itemUses.get(~s.id))this.processItemUse([this.entrance(s)],G.OPEN,e,t)}handleMovingGuard(s,e,t){if(this.flagset.assumeStatueGlitch())return;let i=[];for(let n of e.spawns.slice(0,2))if(n.isNpc()&&this.rom.npcs[n.id].isParalyzable()){i.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&i.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(s,this.terrainFactory.statue([...t,...i].map(Ot)))}handleBoat(s,e,t){let i=this.walkableNeighbor(s);if(i==null)throw new Error("Could not find walkable neighbor.");let n=s>>8&240|s>>4&15,o=s>>4&240|s&15,a;for(let u of e.exits)u.yt===n&&u.xt<o&&(a=u);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let c=l.entrances[a.entrance],d=W.from(l,c),f=d;for(;;){f=W.add(f,0,-1);let u=this.walkableNeighbor(f);if(u!=null){let h={enter:G.freeze(t),exit:[[15,G.OPEN]]};this.addTerrain([i],h),this.exits.set(i,u),this.exitSet.add(ce.of(i,u)),this.exits.set(d,u),this.exitSet.add(ce.of(d,u)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(s,e,t){let i=this.itemGrant(t),n=256|i;if(i==null)throw new Error(`missing item grant for ${t.toString(16)}`);let o=t>=128;this.addItemCheck(s,e,n,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(s,e){for(let t of s){let i=this.terrains.get(t);i!=null&&this.terrains.set(t,this.terrainFactory.meet(i,e))}}addCheck(s,e,t){if(G.isClosed(e))return;let i={requirement:G.freeze(e),checks:t};for(let n of s)!this.terrains.has(n)||this.checks.get(n).add(i)}addItemCheck(s,e,t,i){this.addCheck(s,e,[t]),this.slots.set(t,i);let n=this.rom.itemGets[this.rom.slots[t&255]],o=this.rom.items[n.itemId],a=o?.unique,l=n.isLosable(),c=a||o===this.rom.items.OpelStatue,d=1;o===this.rom.items.SwordOfWind&&(d=5),o===this.rom.items.SwordOfFire&&(d=5),o===this.rom.items.SwordOfWater&&(d=10),o===this.rom.items.SwordOfThunder&&(d=15),o===this.rom.items.Flight&&(d=15),this.items.set(512|n.id,{unique:a,losable:l,preventLoss:c,weight:d})}addCheckFromFlags(s,e,t){let i=[];for(let n of t){let o=this.flag(n);o?.logic.track&&i.push(o.id)}i.length&&this.addCheck(s,e,i)}walkableNeighbor(s){if(this.isWalkable(s))return s;for(let e of[-1,1]){let t=W.add(s,e,0),i=W.add(s,0,e);if(this.isWalkable(t))return t;if(this.isWalkable(i))return i}}isWalkable(s){return!(this.getEffects(s)&O.BITS)}ensurePassable(s){return this.isWalkable(s)?s:this.walkableNeighbor(s)??s}getEffects(s){let e=this.rom.locations[s>>>16],t=this.rom.tileEffects[e.tileEffects-179].effects,i=e.screens[(s&61440)>>>12][(s&3840)>>>8];return t[this.rom.screens[i].tiles[s&255]]}processBoss(s,e){let{bosses:t}=this.rom,{Rage:i,StatueOfSun:n,StatueOfMoon:o}=t,a=e.id===201,l=e.id===202,c=e.id===195,d=c?i:a?o:l?n:t.fromLocation(s.id),f=W.from(s,e);if(!d||!d.flag)throw new Error(`Bad boss at ${s.name}`);let u=f&-256,h=this.terrainFactory.boss(d.flag.id,c),p=te(240,m=>u|m);this.addTerrain(p,h),!a&&!l&&this.addBossCheck(p,d)}addBossCheck(s,e,t=G.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let i=G.meet(t,this.bossRequirements(e));e===this.rom.bosses.Draygon2?this.addCheck(s,i,[e.flag.id]):this.addItemCheck(s,i,e.flag.id,{lossy:!1,unique:!0})}processChest(s,e){if(this.rom.slots[e.id]>=112)return;let t=256|e.id,i=this.rom.slots[e.id];if(i>=112)return;let n=this.rom.items[i],o=this.flagset.preserveUniqueChecks()?!!n?.unique:!0;this.addItemCheck([W.from(s,e)],this.chestRequirement,t,{lossy:!1,unique:o})}processMonster(s,e){let t=this.rom.objects[e.monsterId];if(!(t instanceof He))return;let{Money:i,RageSkip:n,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:c,SwordOfThunder:d}=this.rom.flags;if(s.id===this.limeTreeEntranceLocation&&t.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(s)],G.OPEN,[n.id]),!t.goldDrop)return;let f=[W.from(s,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(f,o.r,[i.id]);return}let u=[a,l,c,d].filter((h,p)=>t.elements&1<<p);this.addCheck(f,Fe(...u),[i.id])}processItemUse(s,e,t,i){s=new Set([...s].map(a=>this.walkableNeighbor(a)??a));let n=[[512|t.id]];t.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&n[0].push(this.rom.flags.Change.c),t===this.rom.items.MedicalHerb&&(n[0][0]=this.rom.flags.BuyHealing.c);let o=G.meet(e,n);switch(this.addCheckFromFlags(s,o,i.flags),i.message.action){case 16:this.processKeyUse(s,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(s,o,t.id);break;case 2:this.addItemCheck(s,o,256|this.rom.npcs[i.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(s,e){let[t,...i]=new Set([...s].map(a=>at.from(a)));if(t==null||i.length)throw new Error("Expected one screen");let o=this.rom.locations[t>>>8].flags.find(a=>a.screen===(t&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(s,e,[o.flag])}bossRequirements(s){if(s===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=s.object,t=new G.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())t.addAll(this.rom.flags.Sword.r);else{let n=this.flagset.guaranteeSwordMagic()?s.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&t.addAll(this.swordRequirement(a,n))}let i=[];if(s.npc!=null&&s.location!=null){let n=s.npc.spawns(this.rom.locations[s.location]);i.push(...this.filterRequirements(n)[0])}return s===this.rom.bosses.Insect?i.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):s===this.rom.bosses.Draygon2&&i.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&i.push(this.rom.flags.Refresh.c),t.restrict([i]),G.freeze(t)}swordRequirement(s,e){let t=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][s];if(e===1)return t.r;let i=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][s];return e===3?Ye(t,...i):i.map(n=>[t.c,n.c])}itemGrant(s){for(let[e,t]of this.rom.itemGets.actionGrants)if(e===s)return t;throw new Error(`Could not find item grant ${s.toString(16)}`)}filterRequirements(s){let e=[];for(let t of s)if(t<0){if(this.flag(~t)?.logic?.assumeTrue)return G.CLOSED}else{let i=this.flag(t);if(i?.logic.assumeFalse)return G.CLOSED;i?.logic.track&&e.push(i.id)}return[e]}filterAntiRequirements(s){let e=[];for(let t of s)if(t>=0){if(this.flag(~t)?.logic?.assumeFalse)return G.OPEN}else{let i=this.flag(~t);if(i?.logic.assumeTrue)return G.OPEN;i?.logic.track&&e.push([i.id])}return e}flag(s){let e=s,t=this.rom.flags[e];return this.aliases.get(t)??t}entrance(s,e=0){return typeof s=="number"&&(s=this.rom.locations[s]),this.tiles.find(W.from(s,s.entrances[e]))}wallCapability(s){switch(s){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${s}`)}}};function Ye(...r){return[r.map(s=>s.id)]}function Fe(...r){return r.map(s=>[s.id])}var Qi=!1;function tr(r){if(!r.compressedMapData){r.compressedMapData=!0;for(let s=0;s<3;s++)r.metascreens.renumber(256|s,320|s),delete r.screens[256|s]}}function sr(r){if(!r.compressedMapData)throw new Error("Must compress first");let{grass:s,town:e,cave:t,dolphinCave:i,pyramid:n,river:o,sea:a,lime:l,mountain:c,shrine:d,desert:f,mountainRiver:u,swamp:h,house:p,fortress:m,labyrinth:b,iceCave:C,tower:g}=r.metatilesets;r.moveScreens([h],4),r.moveScreens([p],4),r.moveScreens([e],4),r.moveScreens([l],4),r.moveScreens([d],4),r.moveScreens([g],4),r.moveScreens([c,u],4),r.moveScreens([t,n,m,b,C],5);let[]=[a,i,s,o,f]}var[]=[zt];function ir(r,s){let o=r.objects[159],a=r.objects[127],l=r.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((f,u)=>l.data[u]=f),l.data[3]=a.data[3];let c=new Set([127-80,141-80]),d=new Set([126-80,159-80]);for(let f of r.locations){if(!f.pits.length)continue;let u=s.nextInt(3)<1;for(let h of f.spawns)!h.isMonster()||(d.has(h.id)&&(h.id=(u?159:126)-80),c.has(h.id)&&(h.id=(u?141:127)-80))}}var[]=[V];function ve(r,s,...e){let t=s,i=0,n;for(;(n=e[i++])!=null;)if(typeof n=="number")r[t++]=n;else if(typeof n=="string")for(let o of n)r[t++]=o.charCodeAt(0);else throw new Error("bad data")}function rr(r){r[107924]=255,r[118213]=168,r[106870]=255,r[108620]=255,r[120899]=160,r[122987]&=7,r[122991]&=7,r[122995]&=7,r[122999]&=7,r[123003]&=7,r[123012]&=7,r[123035]&=7,r[123065]&=7,r[123141]=47,r[123511]=0,r[123750]=64,r[123761]=0,r[123783]=0,r[123793]=0,ve(r,106856,51,51),ve(r,107662,51,51),r[105393]=112,r[105397]=113,r[105079]=114,r[105963]=115,r[106565]=116,r[106721]=117,r[106725]=118,r[106729]=119,r[108037]=120,r[107457]=121,r[107461]=122,r[107465]=123,ve(r,123063,192,0),ve(r,123690,192,0),ve(r,123696,192,0),ve(r,123702,192,0),ve(r,123104,192,0),ve(r,123110,192,0),r[116739]=0,ve(r,116749,162,179),r[109190]=254,ve(r,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(let s of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])r[s]|=1;ve(r,157038,"Simea",16,0,"     ",16,0)}function nr(r,s){jn(r),kn(r),Sn(r),Cn(r),vn(r,s),so(r),io(r),to(r),In(r),Tn(r),Gn(r),En(r),On(r),An(r),Zn(r,s),Xn(r),s.requireHealedDolphinToRide()&&Bn(r),s.saharaRabbitsRequireTelepathy()&&_n(r),Wn(r,s),Pn(r,s),Ln(r),s.teleportOnThunderSword()?(Dn(r),r.townWarp.thunderSwordWarp=[r.locations.Shyron.id,65]):Nn(r),Mn(r),s.fogLampNotRequired()&&Fn(r,s),Kn(r),Vn(r),zn(r),$n(r,s),s.disableRabbitSkip()&&Hn(r),s.disableFlightStatueSkip()&&qn(r),Yn(r,s),Rn(r),s.chargeShotsOnly()&&Jn(r),s.orbsOptional()&&Qn(r),s.noBowMode()&&eo(r),Un(r),s.hardcoreMode()&&ro(r),s.shouldUpdateHud()&&(yn(r),r.writeMonsterNames=!0),s.shouldColorSwordElements()&&wn(r),s.hasStatTracking()&&bn(r),no(r)}function bn(r){for(let x=0;x<4;x++)r.patterns.set(5376,41+x,ye.BLANK_TILES[x]);if(r.prg[143082]===40)return;r.prg[143082]=40;let t=143364,i=144132,n=128-1;for(let x=t;x<i;x++)r.prg[x]>=41&&r.prg[x]<=45&&(r.prg[x]+=n);let o=42,a=160;for(let x=t;x<i;x+=192)r.prg[x+a]=o;let l=new Map([[66,a]]),c=142469,d=142546;for(let x=c;x<d;x++)l.has(r.prg[x])&&(r.prg[x]=l.get(r.prg[x]));for(let x=t;x<i;x+=192)for(let E=123;E<=127;E++)r.prg[x+E]==o+n&&(r.prg[x+E]=o);let f=3,u=2,h=144376,p=144440;for(let x=h;x<p;x++){let E=r.prg[x];for(let I=0;I<8;I+=2){let F=f<<I,w=u<<I;(E&F)==F&&(E=E&(255^3<<I)|w)}r.prg[x]=E}let m=144440,b=4*f,C=[15,48,15,17];for(let x=0;x<C.length;x++)r.prg[m+b+x]=C[x];r.prg[m+u*4+3]=8;let g=145114,y=145222;for(let x=g;x<y;x+=4)r.prg[x]+=128}function wn(r){function s(e,t){for(let i=0;i<=10;i++){if(i===8)continue;let n=r.patterns.get(i|e),o=[...n.pixels];for(let a=0;a<n.pixels.length;a++)n.pixels[a]=o[a^8],a>>>3===t&&(n.pixels[a]|=o[a])}}s(4240),s(4304),s(4368),s(4432),s(4496)}function yn(r){r.patterns.set(3584,0,ye.HUD_LF),r.patterns.set(3584,1,ye.HUD_PW),r.patterns.set(3584,2,ye.HUD_EY),r.patterns.set(3584,3,ye.HUD_LV),r.patterns.set(3584,4,ye.HUD_DL),r.patterns.set(3584,5,ye.HUD_MP),r.patterns.set(3584,6,ye.HUD_EX),r.patterns.set(3584,26,ye.HUD_CLOSE_LEFT),r.patterns.set(3584,27,ye.HUD_CLOSE_RIGHT)}function Sn(r){r.items.GlowingLamp.itemUseData[0].message.action=11}function Cn(r){let s=r.nextFreeTrigger("mezame");s.used=!0,s.conditions=[~r.flags.AlwaysTrue.id],s.message=Mt.of({action:4}),s.flags=[r.flags.AlwaysTrue.id],r.locations.MezameShrine.spawns.push(z.of({tile:136,type:2,id:s.id}))}function kn(r){let s=new Set([129,139,144,153,166,167,168,169,170,171,172,r.allocatedTriggers.get("zombie warp")]);for(let e of r.locations)!e.used||(e.spawns=e.spawns.filter(t=>!t.isTrigger()||!s.has(t.id)))}function vn(r,s){if(r.objects[16].atk=3,r.objects[17].atk=6,r.objects[18].atk=8,r.objects[24].atk=3,r.objects[19].atk=5,r.objects[25].atk=5,r.objects[23].atk=7,r.objects[26].atk=7,r.objects[20].atk=3,r.objects[21].atk=6,r.objects[22].atk=8,r.objects[28].atk=3,r.objects[29].atk=3,r.objects[30].atk=5,r.objects[27].atk=7,r.objects[31].atk=7,s.slowDownTornado()){let e=r.objects[18];e.speed=7,e.data[12]=96}}function En(r){let s=r.trigger(160);s.used=!0,s.conditions=[],s.flags=[],s.message=Mt.of({part:0,index:0,action:21}),r.objects[94].data[13]=254,r.items.InsectFlute.itemUseData[0].flags=[r.flags.UsedInsectFlute.id]}function In(r){r.items.OpelStatue.selectedItemValue=0}function Tn(r){for(let s of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])r.patterns.set(s<<6,e,r.patterns.get(94<<6,e).pixels);r.objects[12].metasprite=169}function Rn(r){for(let s in[4,5,8,9])r.tileEffects[188-179].effects[s]=24,r.tileEffects[181-179].effects[s]=24}function Mn(r){let{tiles:s}=r.screens[161];s[40]=159,s[55]=35,s[56]=35,s[57]=33,s[71]=141,s[72]=143,s[86]=153,s[87]=154,s[88]=140}function Fn(r,s){let{flags:{AlwaysTrue:e,InjuredDolphin:t,FogLamp:i,KensuInCabin:n,ReturnedFogLamp:o},items:{ShellFlute:a},locations:{BoatHouse:l,Portoa_FishermanHouse:c},npcs:d}=r,f=s.requireHealedDolphinToRide();a.itemUseData[0].want=f?t.id:e.id,d.KensuInCabin.data[0]=103,d.KensuInCabin.localDialogs.get(-1)[0].message.action=10,d.KensuInCabin.localDialogs.get(-1)[0].flags=[],d.KensuInCabin.spawnConditions.set(l.id,[o.id,~n.id]),d.Fisherman.spawnConditions.set(c.id,[i.id]),r.itemGets[100].flags=[],r.itemGets[103].copyFrom(r.itemGets[100])}function Gn(r){for(let s of r.locations)for(let e of s.spawns)e.isChest()&&(e.timed=!1)}function An(r){let s=r.locations;s.GoaFortress_Kelbesque.spawns[0].x-=16,s.GoaFortress_Zebu.spawns.splice(1,1),s.GoaFortress_Tornel.spawns.splice(2,1),s.GoaFortress_Asina.spawns.splice(2,1),s.GoaFortress_Kensu.spawns.splice(3,1),s.GoaFortress_Kensu.spawns.splice(1,1)}function Pn(r,s){let{items:{AlarmFlute:e},flags:{TalkedToZebuStudent:t,ZebuStudent:i},locations:{MezameShrine:n,Leaf_StudentHouse:o,WaterfallCave4:a,ZebuCave:l},npcs:{WindmillGuard:c,Zebu:d}}=r;if(r.itemGets[49].inventoryRowStart=32,e.unique=!0,e.basePrice=0,s.zebuStudentGivesItem())c.data[1]=49;else{c.data[1]=255;let h=c.dialog(o)[0];h.condition=~t.id,h.flags.push(t.id),Js(d.spawns(l),i.id,t.id),n.spawns.push(z.of({screen:0,tile:155,type:2,id:49})),n.spawns.push(z.of({screen:0,tile:149,type:2,id:73})),r.itemGets[73].itemId=r.items.MedicalHerb.id}let f=[[33,.72],[31,.9]],u=0;for(let h of r.shops)if(h.type===1)for(let p=0,m=h.contents.length;p<m;p++){if(h.contents[p]!==49)continue;let[b,C]=f[u++%f.length];h.contents[p]=b,r.shopDataTablesAddress&&(h.prices[p]=Math.round(h.prices[p]*C))}r.itemGets[91].itemId=29,a.spawn(25).id=16}function Ln(r){let{flags:{Karmine:s,Mado1:e},npcs:{Brokahana:t}}=r,i=pi(t.localDialogs.get(-1))[0];if(i.condition!==~s.id)throw new Error(`Bad brokahana condition: ${i.condition}`);i.condition=~e.id}function Bn(r){let{flags:{InjuredDolphin:s,ShellFlute:e},npcs:{Fisherman:t,FishermanDaughter:i}}=r;t.spawnConditions.set(214,[e.id,s.id]);let n=i.localDialogs.get(-1);n.unshift(n[0].clone()),n[0].condition=~s.id,n[1].condition=~e.id}function _n(r){let{flags:{Telepathy:s},npcs:{Deo:e,SaharaBunny:t}}=r;t.globalDialogs.push(Ms.of(~s.id,[26,18])),e.globalDialogs.push(Ms.of(~s.id,[26,19]))}function Dn(r){let{flags:{WarpShyron:s}}=r;r.itemGets[3].flags.push(s.id)}function Nn(r){r.itemGets[3].acquisitionAction.action=22}function Wn(r,s){if(s.leatherBootsGiveSpeed()){let e=r.items[47];if(e.menuName="Speed Boots",e.messageName="Speed Boots",s.changeGasMaskToHazmatSuit()){let t=r.items[41];t.menuName="Hazmat Suit",t.messageName="Hazmat Suit"}}for(let e=5;e<12;e+=2)r.items[e].menuName=r.items[e].menuName.replace("Ball","Orb"),r.items[e].messageName=r.items[e].messageName.replace("Ball","Orb")}function On(r){let{flags:{BallOfWind:s,TornadoBracelet:e},npcs:{Tornel:t}}=r,i=t.localDialogs.get(33),n=[i[0],i[2],i[2].clone(),i[1]];n[1].condition=~e.id,n[2].condition=~s.id,n[3].condition=-1,t.localDialogs.set(33,n)}function zn(r){let{CordelPlainEast:s,KirisaMeadow:e,UndergroundChannel:t}=r.locations;for(let i of[s,e,t])for(let n of i.spawns)n.isChest()&&(n.data[2]|=32)}function $n(r,s){let{CordelPlainEast:e,CordelPlainWest:t}=r.locations;for(let i of e.spawns)(i.isChest()||s.disableTeleportSkip()&&i.isTrigger())&&t.spawns.push(i.clone())}function Hn(r){for(let s of r.locations.MtSabreNorth_Main.spawns)s.isTrigger()&&s.id===134&&s.x===1856&&(s.x+=16,s.y+=16)}function qn(r){let s=r.hitboxes[r.objects.guardianStatueMissile.hitbox],e=r.hitboxes[6];r.objects.guardianStatueMissile.hitbox=e.id,e.x0=s.x0-6,e.w=s.w+12,e.y0=s.y0-2,e.h=s.h+4}function Un(r){r.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function jn(r){let{flags:{WarpZombie:s},locations:{ZombieTown:e}}=r;r.flags.insertZombieWarpFlag();let t=r.messages.parts[33][0];t.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let i=r.nextFreeTrigger("zombie warp");i.used=!0,i.conditions=[],i.message=Mt.of({}),i.flags=[s.id];for(let n of e.spawns)n.isTrigger()&&n.id===138&&(n.id=i.id);if(r.townWarp.locations.splice(7,0,e.id),r.townWarp.locations.pop()!==255)throw new Error("unexpected")}function Kn(r){let{flags:{CurrentlyRidingDolphin:s},locations:{AngrySea:e,EvilSpiritIsland1:t}}=r;r.trigger(138).conditions=[~s.id],r.messages.parts[29][16].text=`This cave ceiling is too
low to fly in.`,or(e.spawns,i=>i.isTrigger()&&i.id===138),t.spawns.push(z.of({x:88,y:160,type:2,id:138}))}function Vn(r){let s=r.nextFreeTrigger("channel item");s.used=!0,s.conditions=[r.flags.CurrentlyRidingDolphin.id,~r.flags.UndergroundChannelUnderwaterChest.id];let e=r.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",s.message=Mt.of({part:e.part,index:e.id,action:15});let t=r.locations.UndergroundChannel.spawns.find(i=>i.isChest());t.data[2]=2,t.yt++,t.id=s.id,r.itemGets.actionGrants.set(s.id,59)}function Xn(r){let e=r.npcs[13].localDialogs.get(53)[0];e.message.action=23}function Yn(r,s){let e=r.locations.LimeTreeLake,t=r.screens[r.metascreens.limeTreeLake.sid];if(s.disableRageSkip()){t.set2d(32,t.get2d(0,143)),t.set2d(42,t.get2d(58,1)),t.set2d(16,t.get2d(32,4)),t.set2d(26,t.get2d(42,5)),t.set2d(27,t.get2d(0,16));for(let n of e.spawns)n.tile+=32;let i=r.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(n=>n+32)}else t.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function Zn(r,s){let{locations:{BoatHouse:e,Brynmaer:t,Crypt_Draygon2:i,Joel_Shed:n,Leaf_ElderHouse:o,MtSabreNorth_SummitCave:a,MtSabreWest_Upper:l,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:d,Portoa_AsinaRoom:f,Portoa_FortuneTeller:u,Shyron_Temple:h,StomHouse:p,Swan_DanceHall:m,Swan_Tavern:b,WindmillCave:C,WaterfallCave4:g,WaterfallValleyNorth:y,ZebuCave:x,ZombieTown_HouseBasement:E},items:{GlowingLamp:I,KeyToPrison:F,LovePendant:w,StatueOfOnyx:k},npcs:{Akahana:M,AkahanaInBrynmaer:N,Asina:Z,AztecaInShyron:ie,Clark:re,Draygon:H,FortuneTeller:fe,Kensu:L,KensuInCabin:A,KensuInSwan:Ge,LeafElder:Ae,LeafRabbit:q,OakChild:he,OakElder:ue,OakMother:ze,PortoaPalaceFrontGuard:dt,PortoaQueen:ee,PortoaThroneRoomBackDoorGuard:Pe,Rage:Ze,Stom:Ss,StonedAkahana:ct,Tornel:yt,WindmillGuard:St,Zebu:$e},flags:P}=r;L.localDialogs.delete(b.id),Ge.link(L.id),Ge.used=!0,Ge.data=[...L.data],L.data[0]=I.id,m.spawns.find(K=>K.isNpc()&&K.id===L.id).id=Ge.id,w.itemUseData[0].want=256|Ge.id,ct.linkDialog(M.id),N.used=!0,N.link(M.id),N.data=[...M.data],t.spawns.find(K=>K.isNpc()&&K.id===M.id).id=N.id,k.itemUseData[0].want=256|N.id,Ae.dialog(o).splice(0,0,...Ae.dialog(o).splice(2,1)),q.dialog()[2].condition=P.RescuedLeafElder.id,q.dialog()[2].flags.push(P.TalkedToLeafRabbit.id),q.dialog()[3].flags.push(P.TalkedToLeafRabbit.id),St.spawns(C)[1]=~P.WindmillGuardAlarmFluteTradein.id,bt(M.spawns(g),~P.BehindWhirlpool.id),bt(ct.spawns(g),~P.BehindWhirlpool.id);function Bt(K){K.reverse();for(let me=0;me<K.length;me++){let ft=K[me+1];K[me].condition=ft?~ft.condition:-1}}for(let K=0;K<4;K++){let me=ue.dialog()[K];me.condition!==r.flags.OakElder.id&&(me.message.action=3)}(()=>{let[K,me,ft,_t]=ze.dialog();_t.condition=~P.RescuedChild.id,me.condition=-1,ze.dialog().splice(0,4,_t,ft,K,me)})();for(let K of[32,33,34,124,125])Bt(r.npcs[K].dialog());he.dialog().unshift(...he.dialog().splice(1,1)),Pe.spawnConditions.set(c.id,[~P.QueenNotInThroneRoom.id,~P.MesiaRecording.id]),dt.dialog()[1].condition=P.MesiaRecording.id,ee.dialog()[3].condition=P.SwordOfWater.id,ee.dialog()[3].message.action=3,ee.dialog()[4].flags.push(P.PortoaQueenGoingAway.id),ee.spawns(c)[1]=~P.MesiaRecording.id,ee.spawns(f)[0]=P.MesiaRecording.id,ee.dialog()[1].condition=P.MesiaRecording.id,fe.spawns(u)[1]=~P.MesiaRecording.id,re.spawnConditions.set(E.id,[~P.Clark.id]),re.spawnConditions.set(n.id,[P.Clark.id]),$e.localDialogs.set(x.id,[Be.of(~P.TalkedToZebuInCave.id,[0,26],[P.TalkedToZebuInCave.id]),Be.of(P.LeafVillagersRescued.id,[0,29]),Be.of(P.LeafAbduction.id,[0,28]),Be.of(P.ZebuAtWindmill.id,[0,29]),Be.of(P.UsedWindmillKey.id,[0,27,3]),Be.of(-1,[0,29])]),bt($e.spawns(x),~P.BehindWhirlpool.id),yt.spawnConditions.delete(l.id),Ss.spawnConditions.delete(p.id),bt(Z.spawns(f),~P.CalmedAngrySea.id);let Le=r.npcs[52];Le.spawnConditions.set(c.id,[P.MesiaRecording.id,~P.PortoaQueen.id]),Le.localDialogs.set(d.id,Le.localDialogs.get(-1)),Le.data[0]=r.items.FluteOfLime.id;let Ct=r.messages.alloc();Ct.text="The queen left this for you.",Le.localDialogs.set(c.id,[Be.of(~P.PortoaQueen.id,[Ct.part,Ct.id,3]),Be.of(-1,[10,14])]),c.spawns.push(z.of({yt:3,xt:12,type:1,patternBank:1,id:Le.id})),ee.localDialogs.set(f.id,ee.dialog().splice(0,2)),ee.localDialogs.set(c.id,ee.dialog()),ee.localDialogs.delete(-1),A.spawnConditions.set(e.id,[~P.AbleToRideDolphin.id,P.ReturnedFogLamp.id]),A.dialog()[0].message.action=2,ie.spawns(h).push(~P.ShyronMassacre.id),r.trigger(130).conditions.push(~P.ShyronMassacre.id),r.bossKills.kensuLighthouse.data2[0]=0,Ze.dialog()[0].condition=P.SwordOfWater.id,H.spawnConditions.set(i.id,[~P.Draygon2.id]),$e.dialog(h).unshift(...$e.dialog(h).splice(1,1)),r.trigger(128).conditions=[~P.ShyronMassacre.id,P.TalkedToZebuInShyron.id,P.SwordOfThunder.id],r.trigger(129).conditions=[],s.barrierRequiresCalmSea()&&r.trigger(132).conditions.push(P.CalmedAngrySea.id),r.trigger(140).conditions.push(P.TalkedToZebuInCave.id),r.trigger(141).used=!1;for(let K of a.spawns)K.isTrigger()&&K.id===141&&(K.id=178);or(y.spawns,K=>K.isTrigger()&&K.id===141),r.trigger(178).conditions.push(P.Kelbesque1.id),r.trigger(178).flags.push(~P.LeafVillagersCurrentlyAbducted.id,~P.LeafElderCurrentlyAbducted.id,P.LeafVillagersRescued.id),r.trigger(140).conditions.push(~P.Kelbesque1.id),r.trigger(134).conditions.push(~P.Kelbesque1.id),bt(F.itemUseData[0].flags,~P.LeafVillagersCurrentlyAbducted.id),bt(F.itemUseData[0].flags,P.LeafVillagersRescued.id),Js(r.trigger(187).conditions,~P.Rage.id,~P.MesiaRecording.id)}function Jn(r){for(let s of[8,9,39])r.objects[s].collisionPlane=0}function Qn(r){for(let s of[16,20,24,29])r.objects[s].terrainSusceptibility&=-5,r.objects[s].level=2}function eo(r){let{flags:{UsedBowOfTruth:s},locations:{Crypt_Draygon2:e,MezameShrine:t}}=r,i;for(let n of t.spawns)n.isTrigger()&&n.tile===136&&(i=r.trigger(n.id));if(!i)throw new Error("Could not find start trigger");i.flags.push(s.id),r.tileEffects[185-179].effects[88]=0,t.meta.setExit(0,"door",[e.meta.id<<8|16,"edge:bottom"])}function to(r){r.objects[51].elements=15}function so(r){r.tileEffects[181-179].effects[116]=6,r.tileEffects[182-179].effects[70]=6}function io(r){for(let s of r.objects)s instanceof He&&(s.isProjectile()||s.isBoss()||s.isFlyer()||s!==r.objects.mimic&&(s.terrainSusceptibility|=3))}function Js(r,s,e){for(let t=0;t<r.length;t++)if(r[t]===s){r[t]=e;return}throw new Error(`Could not find ${s} in ${r.join(",")}`)}function ro(r){for(let s of r.locations)s.checkpoint=s.saveable=!1}function no(r){Js(r.wildWarp.locations,100,105)}function bt(r,s){let e=r.indexOf(s);if(e<0)throw new Error(`Could not find element ${s} in ${r}`);r.splice(e,1)}function or(r,s){let e=r.findIndex(s);if(e<0)throw new Error(`Could not find element in ${r}`);r.splice(e,1)}function ar(r,s,e){if(!s.randomizeTrades())return;let{items:{StatueOfOnyx:t,FogLamp:i,LovePendant:n,KirisaPlant:o,IvoryStatue:a},locations:{Swan_DanceHall:l,PortoaPalace_ThroneRoom:c},npcs:{KensuInSwan:d}}=r,f=new Map,u=[[t,0,"Akahana"],[i,0,"Fisherman"],[n,0,"Kensu"],[o,0,"Aryllis"],[a,0,"Slimed Kensu"]],h=u.map(([b,C,g])=>{if(b.trades.indexOf(C)<0||C>=b.itemUseData.length)throw new Error(`not a trade: ${b} ${C}`);return[b.itemUseData[C],b.id,g]});e.shuffle(h);for(let[b,C]of u){let[g,y,x]=h.pop();b.itemUseData[C]=g,r.spoiler&&r.spoiler.addTrade(b.id,b.messageName,x),g.want===356&&s.fogLampNotRequired()&&([...r.npcs[100].spawnConditions.values()][0][0]=512|b.id),f.set(y,b.id)}r.itemGets.actionGrants=new Map([...r.itemGets.actionGrants].map(([b,C])=>[f.get(b)??b,C]));let p=r.items[e.nextInt(4)];r.npcs[195].localDialogs.get(-1)[0].condition=512|p.id,r.spoiler&&r.spoiler.addTrade(p.id,p.messageName,"Rage"),r.npcs.PortoaQueen.dialog(c)[1].condition=512|p.id;let m=r.items[e.nextInt(4)*2+6];for(let b of r.npcs[95].localDialogs.values())for(let C=2;C<b.length;C++)if(b[C].message.action===3){b[C-2].condition=~(512|m.id-1),b[C-1].condition=~(512|m.id),r.spoiler&&r.spoiler.addTrade(m.id,m.messageName,"Tornel");break}d.dialog(l)[0].message.mid="13:00"}function lr(r){let s=new Map;for(let e of r.items)for(let t of e.trades)s.set(e.itemUseData[t].want&255,e.id);return s}function cr(r){let{flags:{AkahanaStatueOfOnyxTradein:s,AsinaInBackRoom:e,BehindWhirlpool:t,KensuInSwan:i,MtSabreNorthSummit:n,MtSabreWestTornel:o,PortoaQueen:a,Rage:l,RepairedStatue:c,SlimedKensu:d,StomFightReward:f,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:h},npcs:{AkahanaInBrynmaer:p,Aryllis:m,Fisherman:b,PortoaQueen:C},locations:{PortoaPalace_ThroneRoom:g}}=r;A("03:06",",","");let y=lr(r);function x(q){let he=y.get(q.id);if(!he)throw new Error(`No trade-in for ${q.name}`);return r.items[he]}h.item.isMagic()||fe("00:1b"),A("00:1b","[41:Refresh]",L(h.item));let E=x(p);A("02:01","an unusual statue",dr(E)),A("02:02","a statue",`the ${gs(E)}`),A("02:02","[29:Gas Mask]",L(s)),f.item.isMagic()||fe("03:01"),A("03:01","[43:Telepathy]",L(f));let I=lo(r);A("03:01","[06:Tornado Bracelet]",L(I)),A("05:0a","[06:Tornado Bracelet]",L(I)),A("05:0a","[44:Teleport]",L(o));let F=x(b);A("09:01","[35:Fog Lamp]",L(F)),A("09:04","[35:Fog Lamp]",L(F)),A("09:05","[35:Fog Lamp]",L(F)),A("09:06","lamp",gs(F));let w=C.dialog(g)[1].condition;A("0a:0c","[28:Flute of Lime]",L(a)),A("0a:0d","[02:Sword of Water]",L(w)),e.item.isMagic()||fe("0b:01"),A("0b:01","[45:Recover]",L(e)),t.item.isMagic()||(fe("0b:01"),fe("1d:12")),A("0b:01","[46:Barrier]",L(t)),A("1d:12","[46:Barrier]",L(t));let k=Ge(79,78,77,76,71,70,69,68,75,74,73,72);k?A("0d:00","[35:Fog Lamp]",L(k)):A("0d:00","that a [35:Fog Lamp] was","there was treasure");let M=r.npcs.Rage.dialog()[0].condition;A("0e:03","[02:Sword of Water]",L(M)),A("0e:03","[09:Ball of Water]",L(l)),A("10:0c","that's","is"),A("10:0c",/, is in the\+lighthouse/,"");let N=x(m);A("12:05","[3c:Kirisa Plant]",L(N)),A("12:10","the plant",`the ${gs(N)}`),A("12:10","[3c:Kirisa Plant]",L(N));let Z=`Our illustrious chief seeks ${dr(N)}.`;A("12:09",/[^]*/,Z),A("12:0a",/[^]*/,Z);let ie=x(r.npcs.KensuInSwan);A("13:02","[3b:Love Pendant]",L(ie)),A("13:00","pendant",gs(ie)),i.item.isMagic()||fe("13:02"),A("13:02","[47:Change]",L(i));let re=x(r.npcs.SlimedKensu);A("18:06","[3d:Ivory Statue]",L(re)),A("18:07","[3d:Ivory Statue]",L(re)),A("18:06","It's in a room","{0b:Karmine} is"),d.item.isMagic()||A("18:07","teach","give"),A("18:07","[48:Flight]",L(d)),n.item.isMagic()||fe("1c:10"),A("1c:10","[42:Paralysis]",L(n)),A("20:06","Statue of Gold",L(c));let H=r.allocatedTriggers.get("channel item");H!=null&&A(r.trigger(H).message.mid,"[3b:Love Pendant]",L(u));{let q=r.messages.alloc();r.trigger(134).message.mid=q.mid,q.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",r.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function fe(q){A(q,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function L(q){return typeof q=="number"?q=r.items[r.itemGets[q&255].itemId]:q instanceof Ii||(q=q.item),`[${V(q.id)}:${q.messageName}]`}function A(q,he,ue){let[ze,dt]=q.split(":").map(Pe=>parseInt(Pe,16)),ee=r.messages.parts[ze][dt];ee.text=ee.text.replace(he,ue)}function Ge(...q){let he=[ue=>oo.has(ue),ue=>ao.has(ue),ue=>Ae(ue).unique];for(let ue of he)for(let ze of q){let ee=[...r.locations[ze].spawns].reverse();for(let Pe of ee){if(!Pe.isChest())continue;let Ze=r.slots[Pe.id];if(Ze<=72&&ue(Ze))return r.items[Ze]}}}function Ae(q){let he=r.itemGets[q];return r.items[he.itemId]}}var oo=new Set([62,63,64]),ao=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function lo(r){let{Tornel:s}=r.npcs;for(let e of s.localDialogs.values())for(let t=2;t<e.length;t++){let i=~e[t].condition;if(i>516&&i<=524&&!(i&1))return r.items[i&255]}return r.items.TornadoBracelet}function dr(r){let s=r.rom.items;switch(r){case s.StatueOfOnyx:return"an unusual statue";case s.FluteOfLime:return"a rare instrument";case s.FogLamp:return"a brilliant lamp";case s.LovePendant:return"a beautiful charm";case s.KirisaPlant:return"a fragrant plant";case s.IvoryStatue:return"an exotic statue"}return Rs(),"a valuable item"}function gs(r){let s=r.rom.items;switch(r){case s.StatueOfOnyx:return"statue";case s.FluteOfLime:return"instrument";case s.FogLamp:return"lamp";case s.LovePendant:return"pendant";case s.KirisaPlant:return"plant";case s.IvoryStatue:return"statue"}return Rs(),"item"}function hr(r){let{locations:{Portoa:s,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:t,UndergroundChannel:i,WaterfallCave2:n,WaterfallCave3:o}}=r;Qs(t,"edge:bottom",183,s),Qs(e,"door",146,i),Qs(n,"stair:up",191,o),fo(r)}function Qs(r,s,e,t){let[i,...n]=[...r.meta.exits()].filter(([,b])=>b===s);if(!i)throw new Error(`Could not find ${s} in ${r}`);if(n.length)throw new Error(`Ambiguous ${s} in ${r}`);let[o,a]=i[2],l=o>>>8;if(l===t.id)return;let c=o&255,d=r.rom.locations[l],u=d.meta.get(c).data.exits.find(b=>b.type===a);if(!u)throw new Error(`Bad entrance in ${d}`);let h=((u.entrance&61440)>>>8|(u.entrance&240)>>>4)+co[u.dir];d.spawns.length>17&&d.spawns.pop();let p=t.spawns.findIndex(b=>b.isTrigger()&&b.id===e),m=p>=0?t.spawns.splice(p,1)[0]:z.of({type:2,id:e});m.xt=(c&15)<<4|h&15,m.yt=c&240|h>>>4,d.spawns.push(m)}var co=[16,0,0,0];function fo(r){let{locations:{MtSabreNorth_Main:s,ValleyOfWind:e}}=r;for(let t of fr(e,17)){let i=r.locations[t>>>8],n=t&255;bs(i,n,r.flags.OpenedSealedCave)}for(let t of fr(s,4)){let i=r.locations[t>>>8];if(i.data.fixed||i.spawns.length>15)continue;let n=t&255;bs(i,n,r.flags.OpenedPrison);let o=i.meta.get(n).findExitByType("cave").entrance,a=z.of({screen:n,coord:o,type:2,id:173});if(i.spawns.push(a),i.spawns.length>15)continue;let l=z.of({screen:n,coord:o-4112,type:4,id:44});i.spawns.splice(1,0,l)}}function fr(r,s){let e=new Set([r,r.id<<8|s]),t=new Set;for(let n of r.meta.exits())n[0]===s&&(n[1]==="cave"||n[1]==="gate")&&t.add(n[2]);let i=[];for(let n of t){if(e.has(n[0]))continue;let o=r.rom.locations[n[0]>>>8],a=n[0]&255;if(!o.meta.customFlags.has(a)){if(n[1]==="cave"||n[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?i.push(n[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||t.add(l[2])}}}return console.log(`From ${r}: ${i.map(n=>n.toString(16))}`),i}function bs(r,s,e,t){e?r.meta.customFlags.set(s,e):r.meta.customFlags.delete(s),!t&&(r===r.rom.locations.CordelPlainEast?bs(r.rom.locations.CordelPlainWest,s,e,!0):r===r.rom.locations.CordelPlainWest&&bs(r.rom.locations.CordelPlainEast,s,e,!0))}function ur(r){ho(r)}function ho(r){let{locations:{AngrySea:s},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:t,beachCave:i,beachExitN:n,boatChannel:o}}=r;e.spawnScripts=[];let a=new Set(te(16,l=>l));for(let l=0;l<s.entrances.length;l++){let c=s.entrances[l],d=s.meta.get(c.screen),f;if(d===o){if(s.meta.get(c.screen-1)!==t)throw new Error(`Bad boatChannel entrance ${c}`);c=Je.of({screen:c.screen-1,tile:0}),d=t}d===t?f={entrance:Je.of({screen:c.screen-17,coord:47336}),movement:5}:d===i?f={entrance:Je.of({screen:c.screen,coord:59400}),movement:8}:d===n&&(f={entrance:Je.of({screen:c.screen,coord:55544}),movement:9}),f&&(a.delete(l),e.spawnScripts[l]=f)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:Je.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:Je.of({x:424,y:120}),movement:7}}function pr(r){let s=new Set;for(let e of r.locations)for(let t of e.pits??[])s.add(t.dest<<8|t.toScreen);for(let e of s){let t=r.locations[e>>8],i=e&255,n=t.exits.filter(d=>d.screen===i),o=t.entrances.filter(d=>d.screen===i),a=new Map(n.map(d=>[d.tile,d])),l=new pe;for(let d of a.keys())for(let f of mr)a.has(d+f)&&l.union([d,d+f]);let c=l.map();for(let d of o)for(let f of mr){let u=c.get(d.tile+f);for(let h of u??[]){let p=a.get(h),m=vi.of({screen:e&255,tile:h+f,dest:p.dest,entrance:p.entrance});t.exits.push(m)}}}}var mr=[1,-1,16,-16];function xr(r,s){let e=[...r.townWarp.locations].filter(l=>l!==255),t=s.nextInt(e.length),i=e[t],n=64;(i===r.locations.Shyron.id||i===r.locations.Shyron_Temple.id)&&(n=65),r.townWarp.thunderSwordWarp=[i,n];let o=768-e.length+t,a=r.itemGets[3].flags;for(let l=0;l<a.length;l++)if(a[l]===765){a[l]=o;return}a.push(o)}function gr(r,s,e){let t=new Set(te(256,o=>o).filter(o=>o in r.objects));for(let[o]of lt)t.delete(o);for(let[o,a]of lt)for(let l of t)r.objects[o].base===r.objects[l].base&&(lt.set(l,a),t.delete(o));for(let o of[200,249,250])r.objects[o].attackType=o>240?254:255,r.objects[o].statusEffect=0;r.objects[125].elements|=8;let i=new Set([87,94,104,125,136,151,155,158]),n=new Set([80,83,95,105]);for(let[o,{sdef:a,swrd:l,hits:c,satk:d,dgld:f,sexp:u}]of lt){let h=r.objects[o].data,p=i.has(o)?1:0;if(h[2]|=128,h[6]=c,h[7]=d,h[8]=a|l<<4,h[16]=h[16]&15|f<<4,h[17]=u,(p?s.shuffleBossElements():s.shuffleMonsterElements())&&!n.has(o)){let m=[...r.objects[o].elements.toString(2).padStart(4,"0")];e.shuffle(m),r.objects[o].elements=Number.parseInt(m.join(""),2)}}if(s.shuffleMonsterElements()){let o=e.nextInt(4);for(let a of n)r.objects[a].elements=1<<o}}var lt=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([r,s,e,t=0,i=0,n=0,o=0,a=0,l=0])=>[r,{id:r,type:s,name:e,sdef:t,swrd:i,hits:n,satk:o,dgld:a,sexp:l}]));function uo(r){console.log("flip sabera entrance");let s=r[0];s.set2d(113,[[s.rom.metascreens.deadEndE_upStair],[s.rom.metascreens.caveEmpty]]),s.moveExits([129,"stair:down",113,"stair:up"]),r[1]=113,r[2]="stair:up"}function mo(r,s){console.log("flip karmine entrance");let e=r[0],t=e.rom.metascreens;e.set2d(32,[[t.caveEmpty,t.hallNS],[t.deadEndE_upStair,t.hallNW]]),e.replaceMonsters(s),e.moveExits([48,"stair:down",48,"stair:up"]),r[2]="stair:up"}function po(r){console.log("flip karmine exit");let s=r[0],e=s.rom.metascreens;s.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),s.moveExits([2,"stair:down",1,"stair:up"]),r[1]=1,r[2]="stair:up"}function ei(r){console.log("flip generic exit");let s=r[0],e=s.rom.metascreens;s.width<2&&(s.width=2),s.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),s.moveExits([0,"stair:up",1,"stair:down"]),r[1]=1,r[2]="stair:down"}function ti(r,s){r[3](r,s),r[3]=void 0}function br(r,s){let e=r.locations,t=[0,1,2,3];s.shuffle(t);let i=[[e.GoaFortress_Kelbesque.meta,131,"stair:down"],[e.GoaFortress_Sabera.meta,129,"stair:down",uo],[e.GoaFortress_Mado1.meta,114,"stair:down"],[e.GoaFortress_Karmine1.meta,48,"stair:down",mo]],n=[[e.GoaFortress_Zebu.meta,0,"stair:up",ei],[e.GoaFortress_Tornel.meta,0,"stair:up",ei],[e.GoaFortress_Asina.meta,0,"stair:up",ei],[e.GoaFortress_Kensu.meta,2,"stair:down",po]],o=[[e.GoaFortress_Entrance.meta,0,"edge:top"]],a=[],l=!0,c=o[0];for(let d of t){let f=l||i[d][3]||o[o.length-1][3],u=f?s.pick([!1,!0]):!0;console.log(`FLOOR ${d}: up ${l} flexible ${!!f} reverse ${u}`);let h=u?n[d]:i[d];console.log(`push b ${r.locations[h[0].id].name}`),a.push(h),l!==(h[2]==="stair:down")&&(h[3]?ti(h,s):ti(c,s)),o.push(c=u?i[d]:n[d]),console.log(`push a ${r.locations[c[0].id].name}`),l=c[2]==="stair:up"}l&&ti(c,s),a.push([e.GoaFortress_Exit.meta,1,"stair:up"]);for(let d=0;d<o.length;d++)o[d][0].attach(o[d][1],a[d][0],a[d][1],o[d][2],a[d][2])}var xo=6,go=33,si=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),bo=new Set(["inn","armor","tool","pawn"]),wr=new Set([...bo,"house","tavern"]);function yr(r,s,e){let{locations:{Crypt_Hall1:t,Goa:i,GoaFortress_Exit:n,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:c}}=r,d=new Set([i.id,o.id]),f=new Set([a.data.id,l.data.id,c.data.id]);if(s.shuffleAreas())for(let y of[i,n,o,t])y.data.houseType="palace";let u=new D(()=>[]),h=new D(()=>[]),p=new D(()=>new Set);for(let y of r.locations){if(!y.used||y.data.houseType==null)continue;let x;for(let[E,I,F]of y.meta.exits()){let w=(E&240)<<4|y.meta.get(E).findExitByType(I).entrance>>>8;(!x||w>x[3])&&(x=[E,I,F,w])}for(let[E,I,F]of[x]){let w={type:y.data.houseType,inside:[y.id<<8|E,I],outside:F},k=F[0];h.get(k).push(w),u.get(y.data.houseType).push(w);let M=r.locations[k>>>8].screens[k>>>4&15][k&15];p.get(M).add(k)}}let m=new Map,b=new Map;for(let[y,x]of e.ishuffle(p))x.size>=2||f.has(y)?b.set(y,x):m.set(y,x);let C=new Set,g=u.get("inn");for(let[,y]of[...b,...m]){let x=new Map,E=!0;for(let I of y){for(let F of h.get(I)){let w=E&&wr.has(F.type)?[...wr].map(L=>u.get(L)):[u.get(x.get(F.outside[1])??F.type)];w=w.filter(L=>L.length),F.type==="palace"&&d.has(F.outside[0]>>>8)&&(w=w.map(L=>L.filter(A=>!d.has(A.inside[0]>>>8))));let k=[...y].every(L=>!C.has(L>>>8));!k&&w.length>1?w=w.filter(L=>L!==g):k&&w.some(L=>L===g)&&(w=[g]);let M=e.pickAndRemove(...w);if(M.type==="inn")for(let L of y)C.add(L>>>8);if(x.set(F.outside[1],M.type),r.spoiler&&r.spoiler.addHouse(M.inside[0]>>>8,F.outside[0]>>>8),xe.connect(r,F.outside,M.inside),!E||si.get(F.type)===si.get(M.type))continue;let N=r.locations[F.outside[0]>>>8];if(N.meta.tileset!==r.metatilesets.town)continue;let Z=xe.findExitTiles(r,F.outside);if(Z.length>1)continue;let ie=Z[0]-32;(Z[0]&240)<32&&(ie-=3856);let re=ie>>8,H=ie&255,fe=si.get(M.type)??(N.meta.get(re).data.tallHouses?.includes(H)?go:xo);r.screens[N.screens[re>>4][re&15]].tiles[H]=fe}E=!1}}}function Sr(r,s,e){let t=[],i=[];for(let n of r.locations)if(!wo.has(n.id)){for(let o of n.spawns)if(o.isChest()){let a=r.slots[o.id];if(a>=112&&i.push(o.id),s.preserveUniqueChecks()){let l=r.itemGets[a];if(r.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;t.push(o.id)}}e.shuffle(t),r.slots.setMimicCount(i.length),[...se.zip(i,t,(n,o)=>r.slots.swap(n,o))]}var wo=new Set([182]);function Cr(r,s){for(let e of r.locations)(e.id&248)!==88&&e.meta.replaceMonsters(s)}var ws=class{constructor(s){this.rom=s;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new D(()=>[]);for(let t of s.locations)if(!!t.used)for(let i=0;i<t.spawns.length;i++){let n=t.spawns[i];!n.used||(n.isMonster()?e.get(n.monsterId).push([t,i,n]):(n.isNpc()||n.isBoss())&&e.get(~n.id).push([t,i,n]))}for(let[t,i]of e)if(t<0){let n=s.npcs[~t],o=[n.data[3]];if(!s.metasprites[o[0]])throw new Error(`bad NPC: ${~t}`);n.data[2]===208&&o.push(192);let l=n.data[2]<128?n.data[2]&112:0,c=this.computeConstraint(o,i,!0,l);~t===95&&(c=c.ignorePalette()),this.npcConstraints.set(~t,c)}else{let n=ne.ALL,o=this.rom.objects[t];for(let a of ii(s,o)){let c=s.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(c(a),i,a.id===t,a.data[1]),f=n.meet(d);if(!f)throw new Error(`Bad meet for ${t} with ${a.id}`);if(f&&(n=f),a.data[4]&2){let u=this.computeConstraint([a.data[20]],i,!1,a.data[1]),h=n.meet(u);if(!h)throw new Error(`Bad meet for ${t} bonus ${a.id}`);n=h}}this.monsterConstraints.set(o.id,n),o.constraint=n}}getMonsterConstraint(s,e){let t=this.monsterConstraints.get(e)||ne.NONE;return(s&88)===88||!this.rom.objects[e].goldDrop?t:t.meet(ne.COIN)||ne.NONE}getNpcConstraint(s,e){let t=this.npcConstraints.get(e)||ne.NONE;return s===30&&e===96?t.meet(ne.STOM_FIGHT):s===160&&e===201?t.meet(ne.GUARDIAN_STATUE):t}shufflePalettes(s){let e=[...this.allSpritePalettes];for(let[t,i]of this.monsterConstraints)this.monsterConstraints.set(t,i.shufflePalette(s,e));for(let[t,i]of this.npcConstraints)this.npcConstraints.set(t,i.shufflePalette(s,e))}configure(s,e){if(!e.used)return;let t=this.rom.slots[e.id],i=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):e.isChest()?t<112?ne.TREASURE_CHEST:ne.MIMIC:void 0;if(!!i){if(i.shift===3||i.float.length>=2)throw new Error("don't know what to do with two floats");if(!i.float.length)e.patternBank=Number(i.shift===2);else if(i.float[0].has(s.spritePatterns[0]))e.patternBank=0;else if(i.float[0].has(s.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(s,e,t,i=0){let n=new Set,o=new Set;for(let c of s.map(d=>this.rom.metasprites[d])){for(let d of c.palettes())o.add(d);for(let d of c.patternBanks(i))n.add(d)}t=t&&n.size==1&&[...n][0]===2;let a=new Map;for(let[c,,d]of e)a.set(d.patternBank&&t?~c.id:c.id,d);let l;for(let[c,d]of a){let f=this.rom.locations[c<0?~c:c];for(let h of o)h>1&&this.allSpritePalettes.add(f.spritePalettes[h-2]);let u=ne.fromSpawn(o,n,f,d,t);l=l?l.join(u):u,!t&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}};function*ii(r,s){yield s;let e=s.spawnedReplacement();e&&(yield*ii(r,e));let t=s.spawnedChild();t&&(yield*ii(r,t)),s.id===80&&(yield r.objects.largeBlueSlime),s.id===83&&(yield r.objects.largeRedSlime)}function vr(r,s,e){let t=new ws(r);s.shuffleSpritePalettes()&&t.shufflePalettes(e);let i=new ni(s,{});for(let n of r.locations)n.used&&i.populate(n);i.shuffle(e,t)}var ni=class{constructor(s,e){this.flags=s;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(s){let{maxFlyers:e=0,nonFlyers:t={},skip:i=!1,tower:n=!1,fixedSlots:o={},...a}=kr[s.id]||{};for(let u of Object.keys(a))throw new Error(`Unexpected property '${u}' in MONSTER_ADJUSTMENTS[${s.id}]`);let l=i===!0||!this.flags.shuffleTowerMonsters()&&n||!s.spritePatterns||!s.spritePalettes,c=[],d=[],f=12;for(let u of l?[]:s.spawns){if(++f,!u.used||!u.isMonster())continue;let h=u.monsterId;if(!lt.has(h)||lt.get(h).type!=="m")continue;let p=s.rom.objects[h];if(!(p instanceof He))continue;let m=u.patternBank,b=s.spritePatterns[m],C=p.palettes(!0),g=C.includes(2)?s.spritePalettes[0]:void 0,y=C.includes(3)?s.spritePalettes[1]:void 0;c.push({id:h,pat:b,pal2:g,pal3:y,patBank:m}),(this.report[`start-${h.toString(16)}`]=this.report[`start-${h.toString(16)}`]||[]).push("$"+s.id.toString(16)),d.push(f)}(!c.length||i)&&(d=[]),this.locations.push({location:s,slots:d}),this.monsters.push(...c)}shuffle(s,e){let t=e.rom;for(this.report["pre-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(i=>i.id),s.shuffle(this.locations),s.shuffle(this.monsters),this.report["post-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["post-shuffle monsters"]=this.monsters.map(i=>i.id);this.locations.length;){let{location:i,slots:n}=this.locations.pop(),o=this.report["$"+i.id.toString(16).padStart(2,"0")]=[],{maxFlyers:a=0,nonFlyers:l={},tower:c=!1}=kr[i.id]||{};if(c)continue;let d=a,f=ne.forLocation(i.id);i.bossId()!=null;for(let m of i.spawns)if(m.isChest()&&!m.isInvisible())t.slots[m.id]<112?f=f.meet(ne.TREASURE_CHEST,!0):f=f.meet(ne.MIMIC,!0);else if(m.isNpc()||m.isBoss()){let b=e.getNpcConstraint(i.id,m.id);f=f.meet(b,!0),m.isNpc()&&(m.id===107||m.id===104)&&(f=f.meet(ne.KENSU_CHEST,!0))}else if(m.isMonster()&&!(t.objects[m.monsterId]instanceof He)){let b=e.getMonsterConstraint(i.id,m.monsterId);f=f.meet(b,!0)}else m.isShootingWall(i)&&(f=f.meet(ne.SHOOTING_WALL,!0));o.push(`Initial pass: ${f.fixed.map(m=>m.size<1/0?"["+[...m].join(", ")+"]":"all")}`);let u=new Map,h=m=>{let b=t.objects[m.id];if(b.monsterClass){let k=u.get(b.monsterClass);if(k!=null&&k!==m.id)return!1}let C=ri.has(m.id),g=yo.has(m.id);if(C){if(!d)return!1;--d}let y=e.getMonsterConstraint(i.id,m.id),x=f.tryMeet(y);if(!x&&f.pal2.size<1/0&&f.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(x=f.tryMeet(y,!0)),!x)return!1;let E;if(p){let k=t.objects[m.id];if(!(k instanceof He))throw new Error(`non-monster: ${k}`);if(E=p(k),E==null)return!1}o.push(`  Adding ${m.id.toString(16)}: ${x}`),f=x,b.monsterClass&&u.set(b.monsterClass,m.id);let I=0;if(C||g){for(let k=0;k<n.length;k++)if(n[k]in l){I=k;break}}else for(let k=0;k<n.length;k++)if(!(n[k]in l)){I=k;break}(this.report[`mon-${m.id.toString(16)}`]=this.report[`mon-${m.id.toString(16)}`]||[]).push("$"+i.id.toString(16));let F=n[I],w=i.spawns[F-13];return C?(w.data[0]=253,w.data[1]=255):p?(w.screen=E>>>8,w.tile=E&255):F in l&&(w.y+=l[F][0]*16,w.x+=l[F][1]*16),w.monsterId=m.id,o.push(`    slot ${F.toString(16)}: ${w}`),n.splice(I,1),!0},p=i.monstersMoved||n.length&&this.flags.randomizeMaps()?i.monsterPlacer(s):null;if(d&&n.length)for(let m=0;m<Math.min(40,this.monsters.length);m++)ri.has(this.monsters[m].id)&&h(this.monsters[m])&&this.monsters.splice(m,1);for(let m=0;m<this.monsters.length&&n.length;m++)if(h(this.monsters[m])){let[b]=this.monsters.splice(m,1);ri.has(b.id)||this.used.push(b),m--}for(let m=0;m<this.used.length&&n.length;m++)h(this.used[m])&&(this.used.push(...this.used.splice(m,1)),m--);if(f.fix(i,s),n.length){console.error(`Failed to fill location ${i.id.toString(16)} ${i.name}: ${n.length} remaining`);for(let m of n){let b=i.spawns[m-13];b.x=b.y=0,b.id=176,b.data[0]=254}}for(let m of i.spawns)e.configure(i,m)}}},ri=new Set([89,92,110,111,129,138,163,196]),yo=new Set([85,93,124,188,193]),kr={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};function ai(r,s,e){new oi(r,s,e).shuffle()}var oi=class{constructor(s,e,t){this.rom=s;this.flags=e;this.random=t}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let s=new D(()=>[]);for(let t of this.rom.locations)!t.tilePalettes.some(i=>i!==154)||s.get(t.colorGroup).push(t);let e=[new Map,new Map];for(let t of s.values())for(let i of t)for(let n=0;n<2;n++)for(let o=0;o<2;o++){let a=e[n].get(i.tilePatterns[o]);a||e[n].set(i.tilePatterns[o],a=new Set),a.add(i.tilePalettes[n])}for(let t of s.values()){let i=t[0],n=[new Set,new Set];for(let l=0;l<2;l++)n[l]=new Set([...e[l].get(i.tilePatterns[0]),...e[l].get(i.tilePatterns[1])]);let o=this.random.pick([...n[0]]),a=this.random.pick([...n[1]]);for(let l of t)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}};function wt(r,s){s.eastCave?So(r,s.eastCave):s.classicLimeTreeToLeaf&&Co(r),ko(r),vo(r),To(r),Ro(r),Eo(r)}(s=>{function r(e,t){let i={};if(e.addEastCave()){i.eastCave={};let n=["cordel","lime","goa","desert"],o=t.nextInt(4);[i.eastCave.exit1]=n.splice(o,1),i.eastCave.exit2=t.pick(n)}else e.connectLimeTreeToLeaf()&&(i.classicLimeTreeToLeaf=!0);return i}s.generateOptions=r})(wt||(wt={}));function So(r,s){let{locations:{EastCave1:e,EastCave2:t,EastCave3:i,SealedCave1:n,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:c,branchNWSE:d,branchNWS:f,branchWSE:u,caveEmpty:h,deadEndE:p,deadEndE_downStair:m,deadEndE_upStair:b,deadEndN_stairs:C,deadEndS:g,deadEndS_stairs:y,deadEndW:x,deadEndW_downStair:E,hallNE:I,hallNS:F,hallNW:w,hallSE:k,hallWS:M,hallWE:N,hallNS_entrance:Z,hallNS_ramp:ie,hallNS_wall:re}}=r;r.locations.allocate(e),r.locations.allocate(t),s.exit2&&r.locations.allocate(i);for(let H of[e,t,i])H.bgm=H.originalBgm=23,H.entrances=[],H.exits=[],H.pits=[],H.spawns=[],H.flags=[],H.width=H.height=1,H.screens=[[128]],H.tilePalettes=[26,27,5],H.originalTilePalettes=[26,27,5],H.tileset=136,H.tileEffects=181,H.tilePatterns=[20,2],H.spritePatterns=[...n.spritePatterns],H.spritePalettes=[...n.spritePalettes];e.meta=new xe(e.id,r.metatilesets.cave,5,5),e.meta.set2d(0,[[p,M,h,k,x],[h,F,k,w,h],[k,d,f,h,h],[F,ie,I,N,M],[Z,I,x,b,w]]),t.meta=new xe(t.id,r.metatilesets.cave,5,5),t.meta.set2d(0,[[p,M,g,h,g],[h,F,F,h,F],[h,l,c,u,w],[h,ie,h,I,M],[p,w,h,h,C]]),o.meta.set2d(51,[[a]]),r.tileEffects[0].effects[192]=0,e.meta.attach(67,t.meta,68),e.meta.attach(64,o.meta,51),s.exit1&&(e.meta.set2d(4,[[E]]),Er(e,4,s.exit1)),s.exit2&&(i.meta=new xe(i.id,r.metatilesets.cave,3,1),i.meta.set2d(0,[[y],[re],[Z]]),i.spawns.push(z.from([24,7,35,0])),i.flags.push(Ei.of({screen:16,flag:r.flags.alloc(512)})),t.meta.set2d(64,[[m]]),t.meta.attach(64,i.meta,0),Er(i,32,s.exit2)),e.spawns.push(z.of({screen:33,tile:135,timed:!0,id:2}),z.of({screen:18,tile:136,timed:!1,id:2}),z.of({screen:19,tile:137,timed:!0,id:2}),z.of({screen:50,tile:104,timed:!1,id:2}),z.of({screen:65,tile:136,timed:!0,id:2}),z.of({screen:51,tile:152,timed:!0,id:2}),z.of({screen:3,tile:136,timed:!0,id:2})),t.spawns.push(z.of({screen:1,tile:136,timed:!0,id:2}),z.of({screen:17,tile:72,timed:!1,id:2}),z.of({screen:18,tile:119,timed:!0,id:2}),z.of({screen:20,tile:40,timed:!1,id:2}),z.of({screen:35,tile:133,timed:!0,id:2}),z.of({screen:49,tile:136,timed:!0,id:2}),z.of({screen:51,tile:138,timed:!1,id:2}),z.of({screen:52,tile:152,timed:!0,id:2}),z.of({screen:65,tile:130,timed:!0,id:2}),z.of({y:272,x:1144,type:2,id:89}),z.of({y:112,x:264,type:2,id:124})),r.slots.swap(49,89)}function Er(r,s,e){let{locations:{CordelPlainEast:t,CordelPlainWest:i,Desert2:n,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:c,boundaryN_trees:d,boundaryW_cave:f,cornerNE:u,cornerNW:h,cornerSE:p,cornerSE_cave:m,cornerSW:b}}=r.rom,C,g;switch(e){case"lime":C=a,g=16,C.resizeScreens(0,1,0,0),C.meta.spliceColumns(0,1,2,[[h,d],[f,c],[b,p]]);break;case"cordel":let y=[[f,c],[b,p]];C=t,g=85,C.meta.set2d(85,y),i.meta.set2d(85,y);break;case"goa":C=o,g=17,C.meta.set2d(1,[[h,u],[f,l]]);break;case"desert":C=n,g=83,C.meta.set2d(83,[[m]]);break}r.meta.attach(s,C.meta,g)}function Co(r){let{locations:{ValleyOfWind:s,LimeTreeValley:e},metascreens:{exitE:t,exitW_southwest:i,overworldEmpty_alt:n}}=r;s.meta.set2d(84,[[t]]),e.meta.set2d(16,[[i],[n]]),s.meta.attach(84,e.meta,16)}function ko(r){let{TowerEntrance:s,Crypt_Teleporter:e}=r.locations;e.meta.attach(0,s.meta,0,"teleporter","teleporter")}function vo(r){let{flags:{OpenedSwanGate:s},locations:{SwanGate:e},npcs:{SoldierGuard:t}}=r;e.spawns.push(z.of({xt:10,yt:2,type:1,id:45}),z.of({xt:11,yt:2,type:1,id:45})),t.localDialogs.get(e.id)[0].flags.push(s.id)}function Eo(r){Io(r.locations.SaberaPalace2_West,r.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function Io(r,s,...e){r.rom.locations.allocate(r,s),r.bgm=s.bgm,r.entrances=[],r.exits=[],r.pits=[],r.spawns=[],r.flags=[],r.width=r.height=1,r.screens=[[128]],r.tilePalettes=ht(s.tilePalettes),r.originalTilePalettes=ht(s.originalTilePalettes),r.tileset=s.tileset,r.tileEffects=s.tileEffects,r.tilePatterns=ht(s.tilePatterns),r.spritePatterns=ht(s.spritePatterns),r.spritePalettes=ht(s.spritePalettes);let i=0,n=0;for(let a of e)i=Math.max(i,(a>>>4)+1),n=Math.max(n,(a&15)+1);r.meta=new xe(r.id,s.meta.tileset,i,n);for(let a of e)r.meta.set(a,s.meta.get(a)),s.meta.set(a,s.meta.tileset.empty);let o=new Set(e);r.flags=s.flags.filter(a=>o.has(a.screen)),s.flags=s.flags.filter(a=>!o.has(a.screen)),r.spawns=s.spawns.filter(a=>o.has(a.screen)),s.spawns=s.spawns.filter(a=>!o.has(a.screen)),s.meta.moveExitsAndPitsTo(r.meta)}function To(r){let s=r.locations.GoaFortress_Kensu.meta;for(let[e,t]of s.exits())e<16||t.startsWith("seamless")||s.deleteExit(e,t)}function Ro(r){r.locations.ZebuCave.spawns.find(s=>s.isTrigger()).yt+=3}var Mo=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Piano Key","Encryption Key","Private Key","Public Key","Key Card","Any Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Major Key","Minor Key","Cookie","Turkey","Monkey","Ctrl Key","Escape Key","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key"],Fo=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power"],Go=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Flashlight","Search Light","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Tanning Bed","CRT"],Ao=["!Random Statue","!Rusty Statue","!Forbidden Statue","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","CodeGorilla Trophy"],Po=["!Random Bow","Crossbow","Autocrossbow","Long Bow","Compound Bow","Silver Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Derek","Bo Diddley","Bo Dallas","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn"];function Ir(r,s,e){if(!s.unidentifiedItems())return;let t=(...c)=>c.map(d=>r.items[d]),i=t(50,51,52),n=t(39,40,49,54),o=t(53,57),a=t(37,56,58,61),l=t(62,63,64);for(let[c,[...d]]of[[i,Mo],[n,Fo],[o,Go],[a,Ao],[l,Po]]){let f=(s.communityJokes()?d:d.filter(h=>h.startsWith("!"))).map(h=>h.replace(/^!/,""));e.shuffle(f);let u=e.shuffle([0,1,2,3]);for(let h of c){let p=f.pop();r.spoiler&&r.spoiler.addUnidentifiedItem(h.id,h.messageName,p),h.menuName=h.messageName=p,h.palette=u.pop()}}}var Lo=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),Bo=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),_o=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac"]]]);function Tr(r,s,e){!s.communityJokes()||(Do(r,s,e),Wo(r,e),Oo(r,e))}function Do(r,s,e){if(s.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let t=e.next()<.05?r.items:[r.items[e.nextInt(72)]];for(let i of t){if(!i)continue;let n=Lo.get(i.messageName)||[],o=Math.floor(e.nextInt(3*n.length+1)/3);o<n.length?i.messageName=i.menuName=n[o]:i.messageName===i.menuName&&(i.messageName=i.menuName=li(i.messageName,e))}}function li(r,s){let e=r.split(""),t=s.nextInt(e.length-1);return e[t]===" "||e[t+1]===" "?r:(e[t].toUpperCase()===e[t]?e.splice(t+1,1):[e[t],e[t+1]]=[e[t+1],e[t]],e.join(""))}function Rr(r,s){for(let e of r.messages.parts)for(let t of e)t.text=s(t.text);r.messages.personNames=r.messages.personNames.map(s),No(r,s)}function Mr(r,s){return e=>e.includes(r)?e.split(r).join(s):e}function No(r,s){for(let e of r.objects)e.displayName&&(e.displayName=s(e.displayName))}function Wo(r,s){let e=r.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let t=[...Bo].flatMap(([a,l])=>["",...l,...l].map(c=>[a,c])),[i,n]=s.pick(t),o=n||li(i,s);o!==i&&Rr(r,Mr(i,o))}function Oo(r,s){for(let e=0;e<10;e++){let[t,i]=s.pick([..._o]),o=s.pick(["",...i,...i,...i])||li(t,s);o!==t&&Rr(r,Mr(t,o))}}function Fr(r){let{locations:s}=r,{CordelPlainEast:e,CordelPlainWest:t,WaterfallValleyNorth:i,WaterfallValleySouth:n,MezameShrine:o,MtSabreWest_Cave1:a}=s;e.meta.reconcileExits(t.meta);for(let l of i.meta.allPos()){let c=i.meta.get(l),d=n.meta.get(l);c.isEmpty()&&!d.isEmpty()?i.meta.set(l,d):d.isEmpty()&&!c.isEmpty()&&n.meta.set(l,c)}for(let l of s)!l.used||(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of s)!l.used||l!==a&&(l.meta.write(),l===t&&a.used&&a.meta.write())}var ys=class{constructor(s){this.rom=s;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(s,e){this.route.push(new di(this,s,e))}addSlot(s,e,t){this.slots[s&255]=new ci(this.rom,s&255,e,t&255)}addMaze(s,e,t){this.mazes.push({id:s,name:e,maze:t})}addTrade(s,e,t){this.trades.push({itemId:s,item:e,npc:t})}addUnidentifiedItem(s,e,t){this.unidentifiedItems.push({itemId:s,oldName:e,newName:t})}addWall(s,e,t){this.walls.push({location:s,oldElement:e,newElement:t})}addWildWarp(s,e){this.wildWarps.push({id:s,name:e})}addHouse(s,e){this.houses.push({houseId:s,townId:e,house:this.rom.locations[s].name,town:this.rom.locations[e].name})}formatCondition(s){return this.rom.flags[s]?.name}formatConditionList(s){let e=[];for(let t of s){let i=this.rom.flags[t];i?.logic.track&&e.push(i.name)}return e.join(", ")}},di=class{constructor(s,e,t){this.spoiler=s;this.condition=e;this.deps=t}toString(){let s=0;return(this.condition&-128)===256&&(s=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${s?` (${this.spoiler.formatCondition(s)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},ci=class{constructor(s,e,t,i){this.slot=e;this.slotName=t;this.item=i;this.itemName=Gr(s,i),this.originalItem=Gr(s,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};function Gr(r,s){return s>=112?"Mimic":r.items[r.itemGets[s].itemId].messageName}var Ar=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),fi=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);function zo(r,[s,e,[t,i]]){let n=Ar.get(e)||fi.get(Ar.get(i)),o=!1,a=r.id.toString(16),l=(r.id<<8|s).toString(16)+" "+e,c=r.rom.locations[t>>>8],d=t&255,f=t.toString(16)+" "+i,u=c.id.toString(16),h={loc:c,pos:d,type:i,area:u,key:f,reverse:null,origRev:null,get conn(){return fi.get(n)},set conn(m){n=fi.get(m)},get shuffle(){return o},set shuffle(m){if(m&&!n)throw new Error("shuffle without conn");o=m}},p={loc:r,pos:s,type:e,key:l,reverse:h,area:a,origRev:h,get conn(){return n},set conn(m){n=m},get shuffle(){return o},set shuffle(m){if(m&&!n)throw new Error("shuffle without conn");o=m}};return h.reverse=h.origRev=p,p}function Pr(r,s){return typeof s=="string"?r.type===s:typeof s=="number"?r.pos===s:s instanceof zt?r.reverse.loc===s:s.every(e=>Pr(r,e))}function Lr(r,s,e){if(!s.shuffleAreas())return;let{locations:t}=r,i=new Map,n=new D(()=>[]);for(let g of r.locations)for(let y of g.meta.exits()){if(g===t.CordelPlainEast&&(y[0]&15)<5||g===t.CordelPlainWest&&(y[0]&15)>4||g.isTower())continue;let x=zo(g,y);if(x.loc!==t.Portoa_FortuneTeller&&x.reverse.loc!==t.Portoa_FortuneTeller&&!i.has(x.key)){if(i.has(x.reverse.key))throw new Error(`Inconsistent exits: ${x.key} | ${x.reverse.key}`);i.set(x.key,x),i.set(x.reverse.key,x.reverse),n.get(x.loc).push(x),n.get(x.reverse.loc).push(x.reverse)}}function o(g,...y){let x=[];for(let E of n.get(g))for(let I of y)if(Pr(E,I)){x.push(E);break}return x}for(let g of o(t.ValleyOfWind,"door","windmill"))g.area="windmill";for(let g of o(t.AngrySea,100))g.area="lighthouse";o(t.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(g,...y){for(let x of o(g,...y))x.shuffle=!0}function l(...g){let y=new Set(g);for(let x of g)for(let E of n.get(x))y.has(E.reverse.loc)||(E.shuffle=!0)}if(l(t.Leaf_OutsideStart),a(t.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(t.WindmillCave),l(t.EastCave1,t.EastCave2,t.EastCave3),l(t.ZebuCave,t.MtSabreWest_Cave1),l(t.CordelPlainWest,t.CordelPlainEast),l(t.WaterfallValleyNorth,t.WaterfallValleySouth),l(t.KirisaMeadow),l(t.LimeTreeLake),a(t.Portoa_FishermanIsland,"edge:right"),a(t.PortoaPalace_ThroneRoom,"door"),a(t.Joel,"edge:bottom"),l(t.JoelSecretPassage),a(t.EvilSpiritIsland1,"stair:up"),a(t.ZombieTown,"cave"),a(t.AngrySea,"edge:top"),l(t.SwanGate),a(t.GoaValley,"edge:left"),l(t.Desert1),l(t.GoaFortressBasement),l(t.DesertCave1),l(t.SaharaOutsideCave),l(t.DesertCave2),a(t.Desert2,"stair:down"),!s.shuffleHouses()){let g=[[t.ZombieTown,"fortress"],[t.MtHydra,"gate"],[t.Desert2,"fortress"],[t.Goa,"edge:top"],[t.Portoa,"fortress"],[t.Shyron,"fortress"],[t.GoaValley,"fortress"],[t.OasisCave_Entrance,"stair:up"],[t.MtHydra_OutsideShyron,"gate"],[t.Crypt_Entrance,"crypt"]];for(let[y,x]of g){let[E]=o(y,x);E.conn="F",E.shuffle=!0}}{let[g]=o(t.Oak,"edge:bottom");g.conn="X",g.shuffle=!0}let c=new pe;for(let g of i.values())g.shuffle||c.union([g.area,g.reverse.area]);let d=new D(()=>[]);for(let g of i.values())!g.shuffle||d.get(g.area=c.find(g.area)).push(g);let f=n.get(t.MezameShrine)[0].area;function u(){let g=new Set,y=new Map,x=[];for(let I of[f,...d.keys()]){if(g.has(I))continue;let F=new Set([I]),w=[];for(let k of F){g.add(k);for(let M of d.get(k))y.set(M,x.length),w.push(M),!(M.oneWay||g.has(M.reverse.area))&&F.add(M.reverse.area)}x.push(w)}let E=0;for(let I=1;I<x.length;I++)x[I].length<x[E].length&&(E=I);return[x.length,y,x[E]]}let h=new D(()=>[]);for(let g of i.values())!g.shuffle||!g.conn||h.get(g.conn).push(g);for(let g of"NWCF"){let y=h.get(g),x=e.shuffle([...y]).map(E=>E.reverse);for(let E=0;E<x.length;E++){let I=y[E],F=x[E];[I.reverse,F.reverse]=[F,I]}}let p=0,[m,b,C]=u();for(;p-- >0||m>1;){let g=e.pick(C),y=h.get(g.conn);if(m>1){let F=b.get(g);y=y.filter(w=>b.get(w)!==F)}let x=e.pick(y),E=g.reverse,I=x.reverse;if(g.reverse=I,I.reverse=g,x.reverse=E,E.reverse=x,[m,b,C]=u(),p<-10)debugger}for(let g of i.values()){if(g.reverse!==g.origRev){let y=function(x){return`${x.loc.name} ${x.type}(${x.pos.toString(16)})`};console.log(`${y(g)}  =>  ${y(g.reverse)}  (was ${y(g.origRev)})`)}g.loc.meta.attach(g.pos,g.reverse.loc.meta,g.reverse.pos,g.type,g.reverse.type)}}function Br(r){for(let s of r.locations){let e=new Set;for(let t of s.spawns)if(!!t.isTrigger()&&e.has(t.coord))throw new Error(`Overlapping triggers on ${s} at ${t.coord.toString(16)}`)}}var hi=!0,_r=Mi("asm");function Yf(r){return r?/^[0-9a-f]{1,8}$/i.test(r)?Number.parseInt(r,16):Ht(r):tt.newSeed()}var{}={watchArray:ki};function $o(r,s){let e={_ALLOW_TELEPORT_OUT_OF_BOSS:r.hardcoreMode()&&r.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:r.audibleWallCues(s),_AUTO_EQUIP_BRACELET:r.autoEquipBracelet(s),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:r.buffDeosPendant(),_BUFF_DYNA:r.buffDyna(),_CHARGE_SHOT_ONLY:r.chargeShotsOnly(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:r.controllerShortcuts(s),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:r.disableShopGlitch(),_DISABLE_STATUE_GLITCH:r.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:r.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:r.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:r.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:hi,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:r.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:r.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:r.maxScalingInTower(),_MONEY_AT_START:r.shuffleHouses()||r.shuffleAreas(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:r.neverDie(),_NORMALIZE_SHOP_PRICES:r.shuffleShops(),_OOPS_ALL_MIMICS:r.alwaysMimics(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:r.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_REQUIRE_HEALED_DOLPHIN_TO_RIDE:r.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:r.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:r.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:r.teleportOnThunderSword(),_TINK_MODE:!r.guaranteeMatchingSword(),_TRAINER:r.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:r.unidentifiedItems(),_ENEMY_HP:r.shouldUpdateHud(),_UPDATE_HUD:r.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:r.zebuStudentGivesItem()};return Object.keys(e).filter(t=>e[t]).map(t=>`.define ${t} ${e[t]}
`).join("")}function Ho(r,s){for(let e of s)Ve.applyPatch(e,r,hi)}async function Zf(r,s,e,t,i,n){let o=16+(r[6]&4?512:0)+(r[4]<<14)+(r[5]<<13);if(r.length>o&&(r=r.slice(0,o)),hi&&r.length<524288){if(r.length<524288){let h=new Uint8Array(r.length+262144);h.subarray(0,262160).set(r.subarray(0,262160)),h.subarray(524304).set(r.subarray(262160)),h[4]<<=1,r=h}let u=r.subarray(16);u.subarray(507904,524288).set(u.subarray(245760,262144))}let a=r.slice(16);if(rr(r.subarray(16)),typeof s!="number")throw new Error("Bad seed");let l=Ht(s.toString(16).padStart(8,"0")+String(e.filterOptional()))>>>0,c=new tt(l),d=t||[],f=[];for(let u=0;u<5;u++)try{return await qo(r,e,s,c,i,n,d,a)}catch(h){f.push(h),console.error(`Attempt ${u+1} failed: ${h.stack}`)}throw new Error(`Shuffle failed: ${f.map(u=>u.stack).join(`

`)}`)}async function qo(r,s,e,t,i,n,o,a){let l=String(s),c=s.filterRandom(t),d=new Fi(r),f=String(c);d.flags.defrag(),tr(d),sr(d),typeof window=="object"&&(window.rom=d),d.spoiler=new ys(d),i&&(i.spoiler=d.spoiler),f!==l&&(d.spoiler.flags=f),nr(d,c),Ti(d),wt(d,wt.generateOptions(c,t)),d.scalingLevels=48,c.shuffleShops()&&jo(d,c,t),c.shuffleGoaFloors()&&br(d,t),Ko(d),Vo(d,c,t),ir(d,t),c.nerfWildWarp()&&d.wildWarp.locations.fill(0),c.randomizeWildWarp()&&Yo(d,c,t),c.randomizeThunderTeleport()&&xr(d,t),gr(d,c,t),Ir(d,c,t),Tr(d,c,t),ar(d,c,t),c.shuffleHouses()&&yr(d,c,t),c.shuffleAreas()&&Lr(d,c,t),hr(d),c.randomizeMaps()&&Oi(d,c,t),Fr(d),Cr(d,t),c.shuffleMimics()&&Sr(d,c,t),c.shuffleMonsters()&&vr(d,c,t);let u=new xs(d,c),h=new cs([u.getLocationList()]);if(!c.noShuffle()){let g=await h.shuffle(c,t,void 0,n,d.spoiler);if(g){for(let[y,x]of g)d.slots[y&255]=x&255;d.slots.setCheckCount(g.size)}else return[r,-1]}c.shuffleShops()&&sa(d,c.bargainHunting()?t:void 0),c.buffMedicalHerb()&&(d.items.MedicalHerb.value=80,d.items.FruitOfPower.value=56),c.storyMode()&&Qo(d),c.blackoutMode()&&Jo(d),Uo(d,c,t),cr(d),ur(d),Br(d),c.buffDyna()&&Zo(d,c),c.trainer()&&(d.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),c.randomizeMusic("early")&&Dr(d,c,t),c.shuffleTilePalettes("early")&&ai(d,c,t),ta(d,c),t.shuffle(d.randomNumbers.values);async function p(g){let y=$o(c,g),x=new gi(Rt.P02,{overwriteMode:"forbid"}),E=new wi;E.enter(xi.concat(new Ts(y,"flags.s"),...yi().map(({filename:k,contents:M})=>new Ts(Us(M,Rt.P02,a),k,{lineContinuations:!0}))));let I=new bi(E,x);x.tokens(I);let F=Ci(),w=[];for(let k of F.labels)x.definedSymbol(k.name)||((w.length!==k.segments.length||w.some((M,N)=>M!==k.segments[N]))&&x.segment(...w=k.segments),x.org(k.org),x.label(k.name));for(let k of F.refs){let M=k.offset+(k.offset>=245760?262144:0);if(!x.isWritten(M))if((w.length!==k.segments.length||w.some((N,Z)=>N!==k.segments[Z]))&&x.segment(...w=k.segments),x.org(k.org),k.bytes===1)x.byte(k.expr);else if(k.bytes===2)x.word(k.expr);else throw new Error(`bad bytes: ${k.bytes}`)}return x.module()}d.messages.compress();let m=r.slice(16);d.modules.set(_r,await p("early")),d.writeData(m),d.modules.set(_r,await p("late"));let b=o?.some(g=>Ve.isCustom(g))||!1,C=ea(r,e,l,m,b);return c.randomizeMusic("late")&&Dr(d,c,t),c.noMusic("late")&&Xo(d),c.shuffleTilePalettes("late")&&ai(d,c,t),pr(d),d.writeData(),Ho(r,o),[r,C]}function Uo(r,s,e){let{}={rom:r,flags:s,random:e};r.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,r.messages.parts[0][14].text="It's dangerous to go alone! Take this.",r.messages.parts[0][14].fixText()}function jo(r,s,e){let t={[0]:{contents:[],shops:[]},[1]:{contents:[],shops:[]}};for(let i of r.shops){if(!i.used||i.location===255)continue;let n=t[i.type];n&&(n.contents.push(...i.contents.filter(o=>o!==255)),n.shops.push(i),i.contents=[])}for(let i of Object.values(t)){let n=null,o=[...i.contents];for(e.shuffle(o);o.length;){(!n||!n.length)&&(n&&o.shift(),n=[...i.shops,...i.shops,...i.shops,...i.shops],e.shuffle(n));let a=o[0],l=n[0];l.contents.length<4&&!l.contents.includes(a)&&(l.contents.push(a),o.shift()),n.shift()}}for(let i of Object.values(t))for(let n of i.shops){for(;n.contents.length<4;)n.contents.push(255);n.contents.sort((o,a)=>o-a)}}function Ko(r){for(let s of r.locations)if(!!s.used){for(let e of s.spawns)if(e.isWall()){let t=e.id&15;e.id=t|t<<4;let i=e.isShootingWall(s);e.data[2]=i?51:35}}}function Vo(r,s,e){if(!s.randomizeWalls())return;let t=[[5,56],[17],[106],[20]];function i(o){return o.data[2]&32?o.id>>>4&3:o.id&3}let n=new D(()=>[]);for(let o of r.locations)n.get(o.data.area).push(o);for(let o of n.values()){let a=e.nextInt(4),l=e.pick(t[a]),c=!1;for(let d of o)for(let f of d.spawns)if(f.isWall()){let u=i(f);if(u===2)continue;if(u===3){let h=e.nextInt(4);r.spoiler&&r.spoiler.addWall(d.name,u,h),f.data[2]|=32,f.id=48|h}else!c&&r.spoiler&&(r.spoiler.addWall(d.name,u,a),c=!0),f.data[2]|=32,f.id=u<<4|a,d.tilePalettes[2]=l}}}function Xo(r){for(let s of[...r.locations,...r.bosses.musics])s.bgm=0}function Dr(r,s,e){let t=new D(()=>[]),i=new Set;for(let a of r.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;i.add(a.bgm),t.get(l).push(a)}for(let a of r.bosses.musics)t.set(a,[a]),i.add(a.bgm);let n=[...i],o=new Set;for(let a of t.values()){let l=e.pick(n);for(let c of a)c.bgm=l,o.add(c)}}function Yo(r,s,e){let t=[];for(let i of r.locations)i&&i.used&&i.id&&!i.isShop()&&i!==r.locations.EvilSpiritIsland1&&i!==r.locations.UndergroundChannel&&(i.id&248)!==88&&i!==r.locations.Crypt_Draygon2&&i!==r.locations.Crypt_Teleporter&&i!==r.locations.MesiaShrine&&i!==r.locations.LimeTreeLake&&t.push(i);e.shuffle(t),r.wildWarp.locations=[];for(let i of[...t.slice(0,15).sort((n,o)=>n.id-o.id)])r.wildWarp.locations.push(i.id),r.spoiler&&r.spoiler.addWildWarp(i.id,i.name);r.wildWarp.locations.push(0)}function Zo(r,s){r.objects[184].collisionPlane=1,r.objects[184].immobile=!0,r.objects[185].collisionPlane=1,r.objects[185].immobile=!0,r.objects[51].collisionPlane=2,r.adHocSpawns[40].slotRangeLower=28,r.adHocSpawns[41].slotRangeUpper=28,r.adHocSpawns[42].slotRangeUpper=28}function Jo(r){let s=new Set([r.metatilesets.cave.tilesetId,r.metatilesets.fortress.tilesetId,r.metatilesets.iceCave.tilesetId,r.metatilesets.labyrinth.tilesetId,r.metatilesets.pyramid.tilesetId]);for(let e of r.locations)s.has(e.tileset)&&e.tilePalettes.fill(154)}var Qo=r=>{let s=[r.flags.Kelbesque1.id,r.flags.Sabera1.id,r.flags.Mado1.id,r.flags.Kelbesque2.id,r.flags.Sabera2.id,r.flags.Mado2.id,r.flags.Karmine.id,r.flags.Draygon1.id,r.flags.SwordOfWind.id,r.flags.SwordOfFire.id,r.flags.SwordOfWater.id,r.flags.SwordOfThunder.id];r.npcs[203].spawnConditions.get(166).push(...s)};function ea(r,s,e,t,i){let n=Ht(t),o=n.toString(16).padStart(8,"0").toUpperCase(),a=zs==="unstable"?$i.substring(0,7).padStart(7,"0").toUpperCase()+"     ":zi.substring(0,12).padEnd(12," "),l=s.toString(16).padStart(8,"0").toUpperCase(),c=(u,...h)=>{u+=16;for(let p of h)if(typeof p=="string")for(let m of p)r[u++]=m.charCodeAt(0);else if(typeof p=="number")r[u++]=p;else throw new Error(`Bad value: ${p}`)},d=(u,h)=>{let p=[];for(let m=0;m<u.length||m<h.length;m++)p.push(u[m]||" "),p.push(h[m]||" ");return p.join("")};c(161743,d("  VERSION     SEED      ",`  ${a}${l}`));let f;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");f=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),c(161791,d(e.substring(0,23),e.substring(23))),f&&c(161839,d(f.substring(0,23),f.substring(23))),i&&c(161923,126),c(161925,d(o.substring(0,4),o.substring(4))),c(153366,"RANDOMIZER"),zs==="unstable"&&c(153404,"BETA"),n}function ta(r,s){s.decreaseEnemyDamage()&&r.scaling.setPhpFormula(e=>16+6*e),r.scaling.setExpScalingFactor(s.expScalingFactor()),s.disableShopGlitch()?r.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:r.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],r.items.CarapaceShield.defense=r.items.TannedHide.defense=3,r.items.PlatinumShield.defense=r.items.BronzeArmor.defense=9,r.items.MirroredShield.defense=r.items.PlatinumArmor.defense=13,r.items.PsychoArmor.defense=r.items.PsychoShield.defense=20,r.items.CeramicSuit.defense=r.items.BattleShield.defense=32,r.items.CarapaceShield.defense=r.items.TannedHide.defense=2,r.items.PlatinumShield.defense=r.items.BronzeArmor.defense=10,r.items.MirroredShield.defense=r.items.PlatinumArmor.defense=14,r.items.BattleArmor.defense=24}var sa=(r,s)=>{for(let t of r.shops)if(t.type!==3)for(let i=0,n=t.prices.length;i<n;i++)t.contents[i]<128?t.prices[i]=s?s.nextNormal(1,.3,.5,1.5):1:t.type!==2?t.prices[i]=0:t.prices[i]=s?s.nextNormal(1,.5,.375,1.625):1;let e=te(48,t=>t);r.shops.rescale=!0,r.shops.toolShopScaling=e.map(t=>Math.round(8*2**(t/10))),r.shops.armorShopScaling=e.map(t=>Math.round(8*2**((47-t)/12)));for(let t=13;t<39;t++)r.items[t].basePrice=ia[t]},ia={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300},[]=[V];export{Ht as a,le as b,de as c,et as d,nn as e,zs as f,zi as g,ql as h,$i as i,Ul as j,jl as k,Vl as l,Ve as m,ls as n,cn as o,Yf as p,Zf as q};
