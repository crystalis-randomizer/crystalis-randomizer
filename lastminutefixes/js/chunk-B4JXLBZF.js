var b=class{constructor(){this.element=document.createElement("div"),this.element.classList.add("main");let t=document.createElement("div"),s=document.createElement("div");this.element.appendChild(t),t.classList.add("canvas"),t.appendChild(s),this.canvas=document.createElement("canvas"),s.appendChild(this.canvas),this.buffer=null,this.highlights=[],this.controls=document.createElement("div"),this.element.appendChild(this.controls),this.controls.classList.add("controls"),this.options={},this.animated=null,this.scale=0,this.handlers={},this.floater=null,this.advanceAnimation=null,this.annotations=4294967295,document.body.addEventListener("keyup",e=>S(this,e)),this.element.addEventListener("click",e=>L(this,e)),document.body.addEventListener("mouseover",e=>{let a=e.target;for(;a&&!a.dataset.overlay;)a=a.parentElement;if(!!a&&a.dataset.overlay)for(let n of document.querySelectorAll(`[data-overlay="${a.dataset.overlay}"]`))n.classList.add("show")}),document.body.addEventListener("mouseout",e=>{let a=e.target;for(;a&&!a.dataset.overlay;)a=a.parentElement;if(!!a&&a.dataset.overlay)for(let n of document.querySelectorAll(`[data-overlay="${a.dataset.overlay}"]`))n.classList.remove("show")}),this.canvas.parentElement.addEventListener("mousemove",e=>{let a=e.offsetX,n=e.offsetY,l=e.target;for(;l&&l!=this.canvas.parentElement;)a+=l.offsetLeft,n+=l.offsetTop,l=l.parentElement;this.mousemove(a,n)}),this.canvas.parentElement.addEventListener("mouseout",e=>{this.floater&&this.floater.remove()})}setControls(t){let s=document.createElement("div"),e=0;for(;this.canvas.nextSibling;)this.canvas.nextSibling.remove();this.options={};let a=t.split(`
`);for(let n of a){let l=document.createElement("div");n.startsWith("#")&&(n=n.replace(/^#\s+/,""),l.style.fontSize="125%");let c=0,r=n.indexOf("[",c);for(;r>=0;){l.appendChild(document.createTextNode(n.substring(c,r)));let C=n.indexOf("]",r);if(C<0)throw new Error("Could not find close bracket.");let x=n.substring(r+1,C);c=C+1;let d;if(d=/^([a-zA-Z0-9_$.]*)(?:<([^>]*)>)?:(.*)$/.exec(x)){let f=d[1],u=d[2]||null,p=d[3].split(",");for(let m=0;m<p.length;m++){let w=p.length>1?f+"."+m:f,o=p[m];if(m==p.length-1&&o=="")continue;let[E,N]=$(this,w);E[N]=g(o);let h=document.createElement("input");h.dataset.name=w,u=="checkbox"?(h.type="checkbox",h.checked=!!E[N]):(h.value=o,h.type="text",h.dataset.fmt=o.length>1?o[0]:"",h.style.width=`${Math.max(2,h.value.length)}em`,u&&(h.dataset.range=u)),l.appendChild(h)}}else if(d=/^(#[^:]*):(.*)$/.exec(x)){let f=document.createElement("a");f.href=d[1],f.textContent=d[2],l.appendChild(f)}else if(d=/^@([0-9]+)x([0-9]+)\+([0-9]+)x([0-9]+)$/.exec(x)){let[f,u,p,m,w]=d,o=document.createElement("div"),E=document.createElement("div");o.appendChild(E),o.classList.add("overlay"),Object.assign(o.style,{left:`${u}px`,top:`${p}px`,width:`${m}px`,height:`${w}px`}),this.canvas.parentElement.appendChild(o),l.dataset.overlay=e,o.dataset.overlay=e,e++}else throw new Error(`Bad field spec: ${x}`);r=n.indexOf("[",c)}c<n.length-1&&l.appendChild(document.createTextNode(n.substring(c))),s.appendChild(l)}A(this.controls,s)}handle(t,s){this.handlers[t]=s}draw(t){if(this.animated=null,this.scale){let n=2/(this.scale+2),l=(1-n)*50;this.canvas.parentElement.style.transform=`translate(-${l}%,-${l}%) scale(${n})`}else this.canvas.parentElement.style.transform="";if(t.root)throw new Error("Cannot show subarray");if(!t.w||!t.h)return;this.canvas.width=t.w,this.canvas.height=t.h,this.buffer=t.data.slice();for(let n of this.highlights)n.apply(t.w,this.buffer);let s=new Uint8Array(this.buffer.buffer),e=this.canvas.getContext("2d"),a=e.getImageData(0,0,t.w,t.h);a.data.set(s),e.putImageData(a,0,0)}highlight(){return new k(this)}update(){throw new Error("abstract")}animate(t,s=!1){let e=0,a=this.animated={},n=()=>{this.animated==a&&(e=e+255&255,t(e,(...l)=>{this.draw(...l),this.animated=a}),this.requestAnimationFrame(()=>n(),s))};n()}requestAnimationFrame(t,s){s?this.advanceAnimation=t:requestAnimationFrame(t)}showFloater(t,s,e){this.floater&&this.floater.parentElement!=this.canvas.parentElement&&(this.floater=null),this.floater||(this.floater=document.createElement("div"),this.canvas.parentElement.appendChild(this.floater),this.floater.classList.add("floater")),this.floater.style.left=`${t+16}px`,this.floater.style.top=`${s+12}px`;let a=(this.scale+2)/2;this.floater.style.fontSize=`${100*a}%`,this.floater.textContent=e}mousemove(t,s){}},k=class{constructor(t){t.highlights.push(this),this.x=0,this.y=0,this.w=0,this.h=0}move(t,s,e,a){this.x=t,this.y=s,this.w=e,this.h=a}apply(t,s){for(let e=0;e<this.w;e++)s[t*this.y+this.x+e]^=16777215,s[t*(this.y+this.h-1)+this.x+e]^=16777215;for(let e=0;e<this.h;e++)s[t*(this.y+e)+this.x]^=16777215,s[t*(this.y+e)+this.x+this.h-1]^=16777215}remove(){v.highlights.remove(this)}},L=(i,t)=>{if(t.target.tagName=="INPUT"&&t.target.dataset.name&&t.target.type=="checkbox"){let[s,e]=$(i,t.target.dataset.name);s[e]=t.target.checked,i.update()}},S=(i,t)=>{if(i.element.offsetParent!=null)if(t.target.tagName=="INPUT"&&t.target.type=="text"&&t.target.dataset.name){let[s,e]=$(i,t.target.dataset.name),a=-1/0,n=1/0,l=1;if(t.target.dataset.range){let r=t.target.dataset.range.split(":");r.length==2&&(r=[r[0],"1",r[1]]),r[0]!=""&&(a=g(r[0])),l=g(r[1]),r[2]!=""&&(n=g(r[2]))}let c=!0;if(t.key=="ArrowUp")s[e]=Math.min(s[e]+l,n);else if(t.key=="ArrowDown")s[e]=Math.max(s[e]-l,a);else if(t.key=="Enter"||t.key=="Tab")s[e]=Math.max(a,Math.min(g(t.target.value),n));else if(t.key=="Escape")c=!1;else return;switch(t.target.dataset.fmt){case"$":t.target.value="$"+s[e].toString(16);break;case"%":t.target.value="%"+s[e].toString(2);break;case"0":t.target.value=s[e]?"0"+s[e].toString(8):"0";break;default:t.target.value=s[e].toString()}c&&i.update({[t.target.dataset.name]:!0})}else if(t.key=="s")i.scale==9?i.scale=30:i.scale==30?i.scale=0:i.scale=(i.scale+1)%10,i.update();else if(t.key=="l"){if(i.advanceAnimation){let s=i.advanceAnimation;i.advanceAnimation=null,s()}}else t.key in i.handlers&&i.handlers[t.key].call(i,t)},$=(i,t)=>{let s=t.split("."),e=i.options;for(let a=0;a<s.length-1;a++){let n=s[a],l=/^[0-9]+$/.test(s[a+1]);e=e[n]||(e[n]=l?[]:{})}return[e,s[s.length-1]]},g=i=>i.startsWith("$")?Number.parseInt(i.substring(1),16):i.startsWith("%")?Number.parseInt(i.substring(1),2):i.startsWith("0")?Number.parseInt(i.substring(1)||i,8):Number.parseInt(i),A=(i,t)=>{let s=i.firstChild,e=t.firstChild;for(;s&&e;){let a=s,n=e;if(s=a.nextSibling,e=n.nextSibling,!(a instanceof Element&&n instanceof Element)||a.tagName!=n.tagName){i.replaceChild(n,a);continue}if(a.tagName=="INPUT"){if(a.type!=n.type){i.replaceChild(n,a);continue}a.value=n.value}else a.tagName=="A"&&(a.href=n.href);for(let l in a.dataset)l in n.dataset||delete a.dataset[l];for(let l in n.dataset)a.dataset[l]=n.dataset[l];A(a,n)}for(;s;){let a=s;s=a.nextSibling,i.removeChild(a)}for(;e;){let a=e;e=a.nextSibling,i.appendChild(a)}};var y=class{constructor(t,s,e,a,n){if(this.root=t&&t.root?t.root:t,this.data=t?t.data:new Uint32Array(a*n),s==null)throw new Error("bad x");this.x=s,this.y=e,this.w=a,this.h=n}static create(t,s){return new y(null,0,0,t,s)}fill(t){if(this.root)for(let s=0;s<this.h;s++){let e=(this.y+s)*this.root.w+this.x;this.data.subarray(e,e+this.w).fill(t)}else this.data.fill(t|4278190080);return this}draw(t,s,e){if(t<0||t>=this.w||s<0||s>=this.h)return;let a=this.root?this.root.w:this.w;this.data[(this.y+s)*a+this.x+t]=e|4278190080}shift(t,s,e=this.w-t,a=this.h-s){return I(this,this.x+t,this.y+s,e,a),new y(this,this.x+t,this.y+s,e,a)}},I=(i,t,s,e=1,a=1)=>{if(t<i.x||t>=i.x+i.w||s<i.y||s>=i.y+i.h||t+e>i.x+i.w||e<1||s+a>i.y+i.h||a<1)throw new Error(`Out of bounds: ${[t,s,e,a]} vs ${[i.x,i.y,i.w,i.h]}`)};export{b as a,y as b};
