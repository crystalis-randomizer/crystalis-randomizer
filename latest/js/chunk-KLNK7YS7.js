import{A as xe,B as ne,C as Ue,D as it,E as ki,F as vi,G as $,H as ge,I as qt,J as Rt,K as Ls,L as Be,M as ke,N as Ci,O as Ti,P as Ei,Q as Ii,R as Ri,e as gi,f as bi,g as O,h as se,i as Wt,j as It,k as Rs,l as wi,m as Ms,n as Fs,o as Gs,p as zt,q as S,r as mt,s as As,t as yi,u as te,v as V,w as Si,x as pt,y as Ps,z as Re}from"./chunk-335NWOVR.js";var $t,zr=()=>{let n;$t=new Uint32Array(256);for(let s=0;s<256;s++){n=s;for(let e=0;e<8;e++)n=n&1?3988292384^n>>>1:n>>>1;$t[s]=n}};var qr=n=>n.split("").map(s=>s.charCodeAt(0)),Ht=n=>{$t||zr(),typeof n=="string"&&(n=qr(n));let s=-1;for(let e=0,t=n.length;e<t;e++)s=s>>>8^$t[(s^n[e])&255];return(s^-1)>>>0};var $r=4656613057391769e-25,Ai=2147483563-1,Mi=40014,Hr=40692,Ut=53668,Fi=52774,Gi=12211,Ur=3791,jt=32,jr=1+Math.floor(Ai/jt),Kr=12e-8,Vr=1-Kr,rt=class{constructor(s=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(s)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(s){this.idum=Math.max(1,Math.floor(s)),this.idum2=this.idum,this.iy=0,this.iv=new Array(jt).fill(0);for(let e=jt+7;e>=0;e--){let t=Math.floor(this.idum/Ut);this.idum=Mi*(this.idum-t*Ut)-t*Gi,this.idum<0&&(this.idum+=2147483563),e<jt&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let s=Math.floor(this.idum/Ut);this.idum=Mi*(this.idum-s*Ut)-s*Gi,this.idum<0&&(this.idum+=2147483563),s=Math.floor(this.idum2/Fi),this.idum2=Hr*(this.idum2-s*Fi)-s*Ur,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/jr);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=Ai),Math.min($r*this.iy,Vr)}nextInt(s){return Math.floor(this.next()*s)}nextNormal(s=0,e=1,t=-1/0,i=1/0){for(;;){let r=this.z1;if(r==null){let o=Math.sqrt(-2*Math.log(this.next())),a=Yr*this.next();r=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(r=s+r*e,r>=t&&r<=i)return r}}shuffle(s){for(let e=s.length;e;){let t=this.nextInt(e--);[s[e],s[t]]=[s[t],s[e]]}return s}*ishuffle(s){let e=[];if(!Array.isArray(s))if(Xr(s)){let t=s[Symbol.iterator]();for(let i=0;i<s.size;i++){let r=i+this.nextInt(s.size-i);for(;e.length<=r;)e.push(t.next().value);yield e[r],e[r]=e[i]}return}else s=[...s];if(!Array.isArray(s))throw new Error("impossible");for(let t=0;t<s.length;t++){let i=t+this.nextInt(s.length-t);yield i in e?e[i]:s[i],e[i]=t in e?e[t]:s[t]}}pick(s){if(!s.length)throw new Error("empty array");return s[this.nextInt(s.length)]}pickWeighted(s){if(!s.length)throw new Error("empty array");let e=0;for(let[i]of s)e+=i;let t=this.next()*e;for(let[i,r]of s){if(t<i)return r;t-=i}throw new Error("bad weights")}pickAndRemove(...s){let e=0;for(let i of s)e+=i.length;if(!e)throw new Error("empty arrays");let t=this.nextInt(e);for(let i of s){if(t<i.length)return i.splice(t,1)[0];t-=i.length}throw new Error("impossible")}bitGenerator(){let s=0,e=0;return()=>{s||(s=32,e=this.nextInt(4294967296)),s--;let t=!(e&1);return e>>>=1,t}}};function Xr(n){return"size"in n}var Yr=2*Math.PI;var Me=class{constructor(s,e){this.height=s;this.width=e;this._coords=void 0;this.data=new Array((s<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let s=[];for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++)s.push(e<<12|t<<4);return this._coords=s}index(s){return((s&248)>>3)+this.row*(s>>>11)}index2(s,e){return(this.row<<1)*s+2*e}yx(s){let e=s%this.row;return[(s-e)/this.row/2,e/2]}coord(s){let e=s%this.row;return(s-e)/this.row<<11|e<<3}get(s){return this.data[this.index(s)]}set(s,e){this.data[this.index(s)]=e}get2(s,e){return this.data[this.index2(s,e)]}set2(s,e,t){this.data[this.index2(s,e)]=t}plus(s,e,t){return s+(this.row<<1)*e+2*t}x(s){return s%this.row/2}y(s){return Math.floor(s/this.row)/2}border(s,e){let t,i;return s&1?(i=e<<12|2048,t=s&2?this.width<<4:0):(i=s&2?this.height<<12:0,t=e<<4|8),i|t}randomBorder(s,e){let t,i;if(e!=null)e&1?(i=s.nextInt(this.height)<<12|2048,t=e&2?this.width<<4:0):(i=e&2?this.height<<12:0,t=s.nextInt(this.width)<<4|8);else{let r=this.width+this.height,o=s.nextInt(r<<1)-r,a=!1;o<0&&(o=~o,a=!0),o<this.width?(t=o<<4|8,i=a?this.height<<12:0):(i=o-this.width<<12|2048,t=a?this.width<<4:0)}return i|t}oppositeBorder(s){return s&8?s^this.height<<12:s^this.width<<4}furthestBorder(s){return(this.height<<12|this.width<<4)-s}edgeCoordination(s,e){let t=0;if((s&2056)!==2056)throw new Error(`Bad tile: ${V(s)}`);for(let i of[8,-8,2048,-2048]){let r=this.get(s+i);(e?r===e:r)&&t++}return t}isBorder(s){if(s&8){if(s&2048)return!1;let e=s>>>12;return!e||e===this.height}else if(s&2048){let e=s>>>4&15;return!e||e===this.width}return!1}partition(s){let e=new xe;for(let t=0;t<this.data.length;t+=this.row)for(let i=0;i<this.row;i++){let r=t+i,o=this.coord(r);if(!(s?.get(o)??this.data[r]))continue;e.find(o);let l=o-2048;t&&(s?.get(l)??this.data[r-this.row])&&e.union([o,l]);let c=o-8;i&&(s?.get(c)??this.data[r-1])&&e.union([o,c])}return e.map()}show(){let s=[];for(let e=0;e<this.data.length;e+=this.row){let t="";for(let i=0;i<this.row;i++)t+=this.data[e+i]||" ";s.push(t)}return s.join(`
`)}static writeGrid2d(s,e,t){let i=s.index(e);for(let r=0;r<t.length;r++){let o=t[r];for(let a=0;a<o.length;a++){let l=o[a];s.data[i+r*s.row+a]=l!==" "?l:""}}}};function Pi(n){return n>>4&15|n>>8&240}function je(n,s=1){return n-s*8}function ve(n,s=1){return n+s*8}function ce(n,s=1){return n-s*2048}function Q(n,s=1){return n+s*2048}var[]=[V],R={ok:!0,value:void 0},Kt=class{constructor(s,e){this.rom=s;this.random=e;this.shuffles=[]}add(...s){this.shuffles.push(...s)}shuffleAll(){for(let s of this.shuffles)s.shuffle(this.random);for(let s of this.shuffles)s.meta&&s.finish();for(let s of this.rom.locations)s.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((s,e)=>(s.badness||0)-(e.badness||0)).join(`
`)}},Vt=class{constructor(s,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new Me(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=s,this.orig=s.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let s=this.pickHeight(),e=this.pickWidth(),t=this.pickSize(),i=new Me(s,e);i.data.fill(""),Object.assign(this,{h:s,w:e,size:t,grid:i,fixed:new Set,count:0,exitMap:[]})}shuffle(s){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:s});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let s=[];for(let[e,t,i]of this.exitMap)for(let[r,o,a]of s)if(e(r,o)){s.push([t,i,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,t,i]of s){let r=this.meta.rom.locations[i[0]>>>8].meta,o=i[0]&255,a=i[1];this.meta.attach(e,r,o,t,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(s,e){let t=this.posToGrid(s);for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=t+i*2048+r*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[i*3+r])return!1}for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=t+i*2048+r*8;this.grid.set(o,e[i*3+r])}return!0}posToGrid(s,e=0){let t=s>>>4,i=s&15;return(t<<12|i<<4)+e}insertPattern(s,{top:e=0,bottom:t=0,left:i=0,right:r=0}={}){let o=s.length-1>>>1,a=s[0].length-1>>>1,l=e+t,c=i+r;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+c)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,f=this.random.nextInt(this.w-a-1-l)+i,u=d+1<<12|f+1<<4;Me.writeGrid2d(this.grid,u,s);for(let h=12288;h<=20480;h+=2048)for(let p=48;p<=64;p+=8)this.fixed.add(u+(h|p));return{ok:!0,value:void 0}}extract(s,e,{h:t=3,w:i=3,replace:r=void 0}={}){let o=s.index(e),a="",l=o+t*s.row,{row:c}=s;for(let d=o;d<l;d+=c)for(let f=d;f<d+i;f++){if(r){let u=r.get(s.coord(f));if(u!=null){a+=u||" ";continue}}a+=s.data[f]||" "}return a}canSet(s,e){return this.canSetAll(new Map([[s,e]]))}canSetAll(s){let e=new Set;for(let t of s.keys()){if(this.fixed.has(t))return!1;let i=t&-2057,r=i>>>12,o=i>>>4&15;o<this.w&&r<this.h&&e.add(i),!(t&8)&&r<this.h&&o&&e.add(i-16),!(t&2048)&&o<this.w&&r&&e.add(i-4096),!(t&2056)&&o&&r&&e.add(i-4112)}for(let t of e){let i=this.extract(this.grid,t,{replace:s});if(!this.orig.tileset.getMetascreensFromTileString(i).length)return!1}return!0}addAllFixed(){for(let s=0;s<this.grid.data.length;s++)this.grid.data[s]&&this.fixed.add(this.grid.coord(s))}};var[]=[V],C=class extends Vt{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let t={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let i of e.rom.locations[e.id].spawns)i.isMonster()&&i.monsterId===143&&t.features.statue++;for(let i of e.allPos()){let r=e.get(i);(!r.isEmpty()||r.data.exits?.length)&&t.size++;for(let o of r.data.exits??[]){let{type:a}=o;if(a==="edge:top"){i>>>4===0&&t.edges[0]++;continue}else if(a==="edge:left"){(i&15)===0&&t.edges[1]++;continue}else if(a==="edge:bottom"){i>>>4===e.height-1&&t.edges[2]++;continue}else if(a==="edge:right"){(i&15)===e.width-1&&t.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);t.stairs[o.dir>>>1]++;continue}}}r.hasFeature("arena")&&t.features.arena++,r.hasFeature("bridge")&&t.features.bridge++,r.hasFeature("overpass")&&t.features.over++,r.hasFeature("pit")&&t.features.pit++,r.hasFeature("ramp")&&t.features.ramp++,r.hasFeature("spikes")&&t.features.spike++,r.hasFeature("underpass")&&t.features.under++,r.hasFeature("wall")&&t.features.wall++,r.hasFeature("river")&&t.features.river++,r.hasFeature("wide")&&t.features.wide++}return t.size<2&&(e.width>1||e.height>1)&&(t.size=2),t}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let t=this.inferScreens();return t.ok?(e=this.refineMetascreens(t.value),!e.ok||(e=this.checkMetascreens(t.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(t.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=t.value,R)):t}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:R):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),R}fillCave(e){for(let t=.5;t<this.h;t++)for(let i=.5;i<this.w;i++)t>1&&this.grid.set2(t-.5,i,e),i>1&&this.grid.set2(t,i-.5,e),this.grid.set2(t,i,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return R;for(let e=0;e<4;e++){let t=this.params.edges[e]||0;if(!t)continue;let i=te(e&1?this.h:this.w,r=>this.grid.border(e,r));for(let r of this.random.ishuffle(i))if(!this.grid.get(r)&&(e&1?e===1?this.addLeftEdge(r)&&t--:this.addRightEdge(r)&&t--:e===0?this.addUpEdge(r)&&t--:this.addDownEdge(r)&&t--,!t))break;if(t)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${t} ${e}`}}return R}addUpEdge(e){let t=e+2048,i=t-8,o=i-8-8,a=t+8,c=a+8+8;if(this.grid.isBorder(i)){if(this.grid.get(i))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(c)&&this.grid.get(c))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(i,""),this.grid.set(a,""),!0}addDownEdge(e){let t=e-2048,i=t-8,r=t+8;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(i,""),this.grid.set(r,""),!0)}addLeftEdge(e){let t=e+8,i=t-2048,r=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let t=e-8,i=t-2048,r=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?R:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?R:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056;if(!this.isEligibleArena(r))continue;let o=this.extract(this.grid,i),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(r),t.set(r,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let t=this.grid,i=e-8,r=i-8,o=e+8,a=o+8;return!(t.get(e)!=="c"&&t.get(e)!=="w"||t.get(i)||t.get(o)||!t.isBorder(i)&&t.get(r)||!t.isBorder(o)&&t.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let t=0;for(;e;){let i=this.random.nextInt(this.h-2)+1,r=this.random.nextInt(this.w-2)+1,o=i<<12|r<<4|2056;if(this.grid.get(o)!=="c"){if(++t>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,t,i){if(!e)return!0;for(let r of this.random.ishuffle(this.grid.screens())){let o=r|2056;if(this.grid.get(o)!=="c")continue;if(i){let d=o-i,f=o+i;if(this.grid.get(d)||this.grid.get(f))continue}let a=this.extract(this.grid,r),l=a.substring(0,4)+t+a.substring(5);if(!!this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,t),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let t=0;for(;e>0;){if(++t>20)return!1;let i=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;i<e-1&&i>this.minSpikes;)this.random.next()<.2&&i--;let r=i>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);i>e-this.minSpikes&&(i>=this.h-2?i=this.h-2:i=e);let a=this.random.nextInt(this.h-i-2)+1<<12|r<<4|2056,l=a+(i-1<<12);for(let f=a-4096;i&&f<=l+4096;f+=2048)this.grid.get(f)!=="c"&&(i=0);if(!i)continue;let c=[a-8,a+8,l-8,l+8],d=this.tryClear(c);if(!!d.length){for(let f of d)this.grid.set(f,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let f=a;f<=l;f+=2048)this.fixed.add(f),this.grid.set(f,"s");e-=i,t=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let t=new Map;for(let c of e){if(this.fixed.has(c))return[];t.set(c,"")}let i=this.grid.partition(t),[r]=i.values();if(r.size===i.size)return[...e];let o=new Set,a=new Set(i.values());for(let c of this.fixed)o.add(i.get(c));if(o.size>this.maxPartitions)return[];let l=[...e];for(let c of a)o.has(c)||l.push(...c);return l}refine(){let e=new Set;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]&&e.add(this.grid.coord(i));let t=0;for(;this.count>this.size;){if(t++>50)throw new Error("refine failed: attempts");let i=0;for(let r of this.random.ishuffle([...e])){if(this.grid.isBorder(r)||!this.canRemove(this.grid.get(r))||this.fixed.has(r))continue;if(i>3)break;let o=this.grid.partition(this.removalMap(r)),[a]=o.values();if(a.size===o.size&&o.size>1)i++,e.delete(r),(r&2056)===2056&&this.count--,this.grid.set(r,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let c=[...l].filter(d=>(d&2056)==2056).length;if(c<this.size)continue;i++,e=l,this.count=c,this.grid.set(r,"");for(let[d,f]of o)f!==l&&this.grid.set(d,"")}}if(!i)return this.looseRefine?R:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return R}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let t=this.grid.partition(new Map),i=t.size,r=new Set(t.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===r)&&a.size===i-1&&(i--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|2056|t<<4;if(this.grid.get(i))continue;let r=i-2048,o=i+2048,a=i-8,l=i+8;(this.grid.get(r)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(r,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let t=e<<12|2048;for(let i=0;i<this.w-1;i++){let r=t|i<<4|8;this.isTightLoop(r)&&this.breakTightLoop(r)}}}isTightLoop(e){for(let t=0;t<6144;t+=2048)for(let i=0;i<24;i+=8){let r=t|i;if(r!==2056&&this.grid.get(e+r)!=="c")return!1}return!0}breakTightLoop(e){let t=this.random.nextInt(65536),i=t&1?t&4096|8:t&16|2048;this.grid.set(e+i,"")}addStairs(e=0,t=0){let i=[e,t];if(!i[0]&&!i[1])return R;for(let r of this.random.ishuffle(this.grid.screens()))if(!!this.tryAddStair(r,i)&&!i[0]&&!i[1])return R;return{ok:!1,fail:"stairs"}}addEarlyStair(e,t){let i=[],r=e-8,o=e+8,a=e-2048,l=e+2048,c=[e-8,e+8];if(t==="<"){if(c.push(l),i.push([a,""]),this.grid.get(r)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return i.push([l,""],[e,"<"]),i}else t===">"&&(c.push(a),i.push([l,""]));if(c=c.filter(f=>this.grid.get(f)==="c"),!c.length)return[];let d=this.random.nextInt(c.length);for(let f=0;f<c.length;f++)f!==d&&i.push([c[f],""]);return i.push([e,t]),i}tryAddStair(e,t){if(this.fixed.has(e|2056))return!1;let i=this.extract(this.grid,e),r=t[0]&&t[1],o=t[0]+t[1],a=this.random.nextInt(o)<t[0],l=[a?0:1];r&&l.push(a?1:0);for(let c of l){let d="<>"[c],f=i.substring(0,4)+d+i.substring(5);if(this.orig.tileset.getMetascreensFromTileString(f).length)return this.grid.set(e|2056,d),t[c]--,!0}return!1}tryConnect(e,t,i,r=1){for(;r-- >0;){let o=new Map,a=e;if((e&t&2056)!==2056)throw new Error(`bad start ${V(e)} or end ${V(t)}`);for(o.set(a,i);a!==t;){let l=[];for(let h of[8,-8,2048,-2048]){let p=a+h,m=a+2*h;this.fixed.has(m)||(o.get(m)??this.grid.get(m))||this.grid.isBorder(p)||l.push(h)}if(!l.length)break;let c=(t>>12)-(a>>12),d=(t&240)-(a&240),f=new Set(l);c<0&&f.delete(2048),c>0&&f.delete(-2048),d<0&&f.delete(8),d>0&&f.delete(-8),l.push(...f,...f);let u=this.random.pick(l);o.set(a+u,i),o.set(a=a+2*u,i)}if(a===t){for(let[l,c]of o)this.grid.set(l,c),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,t=1){let i=new xe;for(let l=0;l<this.grid.data.length;l++){let c=this.grid.coord(l);this.grid.get(c)||this.grid.isBorder(c)||(this.grid.get(ve(c))||i.union([c,ve(c)]),this.grid.get(Q(c))||i.union([c,Q(c)]))}let r=new O(()=>[]);for(let l of this.grid.screens()){let c=l+2056;if(!!this.grid.get(c))for(let d of[8,-8,2048,-2048]){let f=c+d;if(this.grid.isBorder(f)||this.grid.get(f))continue;let u=c+2*d;if(this.grid.get(u))continue;let h=new Map([[f,e]]),p=this.extract(this.grid,l,{replace:h});this.orig.tileset.getMetascreensFromTileString(p).length&&r.get(i.find(u)).push([f,u])}}let o=new Map;for(let l of r.values())if(!(l.length<2))for(let[c]of l)o.set(c,l);let a=[...o.values()];if(!a.length)return!1;for(;t-- >0;){let l=this.random.pick(a),[[c,d],[f,u]]=this.random.ishuffle(l);if(this.grid.set(c,e),this.grid.set(f,e),this.tryConnect(d,u,e,5))return!0;this.grid.set(c,""),this.grid.set(f,"")}return!1}tryExtrude(e,t,i=1){for(;i--;)for(let r of this.random.ishuffle(this.grid.screens())){let o=r+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,r);for(let l of this.random.ishuffle([0,1,2,3])){let c=o+xt[l],d=o+2*xt[l];if(this.grid.get(c)||this.grid.isBorder(c)||this.grid.get(d))continue;let f=Bs[l],u=a.substring(0,f)+e+a.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(u).length){this.grid.set(c,e),this.grid.set(d,e);let h=this.tryContinueExtrude(e,t,d);if(h)return h;this.grid.set(d,""),this.grid.set(c,"")}}}return 0}tryContinueExtrude(e,t,i){let r=this.extract(this.grid,i-2056),o=this.orig.tileset.getMetascreensFromTileString(r).length>0;if(t===1)return o?1:0;if(o&&!this.random.nextInt(t))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=i+xt[a],c=i+2*xt[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(c))continue;let d=Bs[a],f=r.substring(0,d)+e+r.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(l,e),this.grid.set(c,e);let u=this.tryContinueExtrude(e,t-1,c);if(u)return u+1;this.grid.set(c,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let t=this.orig.tileset,{attempts:i=1,char:r="c",start:o,loop:a=!1}=e;for(let l=0;l<i;l++){let c=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of c){let f=d+2056;if(!this.grid.get(f))continue;let u=this.extract(this.grid,d);for(let h of this.random.ishuffle([0,1,2,3])){let p=f+xt[h],m=f+2*xt[h];if(this.fixed.has(p)||this.fixed.has(m))continue;let b=this.grid.get(p),v=this.grid.get(m);if(b&&(v||b!==r)||this.grid.isBorder(p))continue;if(!a){let x=this.extract(this.grid,m-2056,{replace:new Map([[p,""]])});if(/\S/.test(x))continue}let g=Bs[h],w=u.substring(0,g)+r+u.substring(g+1);if(t.getMetascreensFromTileString(w).length){this.count++,this.grid.set(p,r),this.grid.set(m,r);let x=this.extract(this.grid,m-2056);if(t.getMetascreensFromTileString(x).length)return 1;this.grid.set(m,v),this.grid.set(p,b),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:R}preinferSpikes(){return R}inferScreens(){let e=[];for(let r of this.grid.screens()){let o=this.extract(this.grid,r),a=this.orig.tileset.getMetascreensFromTileString(o).filter(c=>!c.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${V(r)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let t=!0,i=new ge(this.params.id,this.orig.tileset,this.h,this.w);for(let r=0;r<this.h;r++)for(let o=0;o<this.w;o++){let a=e[r*this.w+o];if(i.set(r<<4|o,a),a.isEmpty()||(t=!1),r){let l=i.get(r-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${r}${o}: ${l.name} ${a.name}`}}if(o){let l=i.get(r<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${r}${o}: ${l.name} ${a.name}`}}}return t?{ok:!1,fail:"all screens empty"}:{ok:!0,value:i}}refineMetascreens(e){let t=this.params.features?.bridge||0,i=this.params.features?.wall||0;for(let r of this.random.ishuffle(e.allPos())){let o=(r<<8|r<<4)&61680,a=this.extract(this.grid,o),l=e.get(r);if(!(this.bridges<=t&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<i&&!l.hasFeature("wall")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==t?{ok:!1,fail:`refineMeta bridges want ${t} got ${this.bridges}
${e.show()}`}:this.walls!==i?{ok:!1,fail:`refineMeta walls want ${i} got ${this.walls}
${e.show()}`}:R}tryMeta(e,t,i){for(let r of i)if(!!this.checkMeta(e,new Map([[t,r]])))return e.set(t,r),!0;return!1}checkMeta(e,t){let i=t?{with:t}:{},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let t=!1,i=!1;for(let r of e.allPos()){let o=e.get(r);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(t=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(i=!0),t&&i)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return R;let t=0;for(let i of e.allPos()){let r=e.get(i);t+=r.data.statues?.length||0}return t<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:R}},nt=class extends C{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,t=super.addEdges();if(!t.ok)return t;let i=this.params.features?.arena;if(!i)return R;let r=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&r.push(a)}if(r.length<i)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(r)){if(!i)break;let a=o-8,l=a-8,c=l-8,d=l-2048,f=l+2048,u=o+8,h=u+8,p=h+8,m=h-2048,b=h+2048;!e.isBorder(a)&&(e.isBorder(c)&&e.get(c)||e.isBorder(d)&&e.get(d)||e.isBorder(f)&&e.get(f))||!e.isBorder(u)&&(e.isBorder(p)&&e.get(p)||e.isBorder(m)&&e.get(m)||e.isBorder(b)&&e.get(b))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(u,""),e.set(h,""),this.grid.set(o,"a"),i--)}return R}addArenas(){return!0}},Xt=class extends C{refineMetascreens(s){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)this.grid.get(e<<12|t<<4|2056)==="a"&&s.set(e<<4|t,s.rom.metascreens.cryptArena_statues);return super.refineMetascreens(s)}isEligibleArena(s){return!this.grid.get(s-2048)&&super.isEligibleArena(s)}},Bs=[1,3,7,5],xt=[-2048,-8,2048,8];function Yt(n,s,e=!1){let t=new _s(n,s,e),i=new Ds(s,t,e);return[t,i]}var Ds=class extends C{constructor(e,t,i){super(e);this.location=e;this.under=t;this.reverse=i;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,t]of se.zip(this.under.upStairs,this.downStairs))this.meta.attach(t,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let t=16,i=0,r=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let c=l>>>4,d=l&15;t=Math.min(d,t),i=Math.max(d,i),r=Math.min(c-a,r),o=Math.max(c+a,o)}e:for(let l=0;l<10;l++){let c=[],d=this.random.nextInt(this.w-(i-t))+t,u=this.random.nextInt(this.h-(o-r))+r-r<<4+(d-t);for(let h of this.under.underBridges){let p=h+u,m=p>>>4,b=p&15,v=m<<12|b<<4|2056;if(this.grid.get(v)!=="c")continue e;c.push([v,"b"]),c.push([v-8,""]),c.push([v+8,""])}for(let h of this.under.upStairsEffective){let p=h+u,m=p>>>4,b=p&15,v=m<<12|b<<4|2056;if(this.grid.get(v)!=="c")continue e;c.push([v,this.reverse?"<":">"]),c.push([v+(this.reverse?-2048:2048),""]);let g=this.addEarlyStair(v,this.reverse?"<":">");if(!g.length)continue e;c.push(...g)}for(let[h,p]of c)p&&this.fixed.add(h),(p==="<"||p===">")&&this.downStairs.push(Pi(h)),this.grid.set(h,p);return R}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,t=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,t):super.addStairs(e,t-this.under.upStairs.length)}addOverpasses(){return!0}},_s=class extends C{constructor(e,t,i){super(e);this.loc=e;this.overpass=t;this.reverse=i;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let t=this.reverse?"stair:down":"stair:up";for(let r of this.meta.allPos()){let o=this.meta.get(r);if(o.hasFeature("underpass")&&this.underBridges.push(r),o.hasFeature(t)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(r+a),this.upStairs.push(r)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let i=0;for(let[,r,[o]]of this.orig.exits())r===t&&o>>>8===this.overpass.id&&i++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,i),R}};var ot=class extends C{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let i=0;i<this.h;i++)for(let r=0;r<this.w;r++){let o=i<<12|r<<4|2056;this.grid.get(o)&&e.push(o)}let t=e.filter(i=>this.tryClear([i]).length===1);if(!t.length)return{ok:!1,fail:"all critical?"};for(let i=0;i<t.length;i++)for(let r=0;r<i;r++)if(this.tryClear([t[i],t[r]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},Zt=class extends ot{removeTightLoops(){}};var De=class{constructor(s,e,t){this.h=s;this.w=e;this.valid=t;this.fixed=new Set;this.size=0;this.data=new Uint8Array(s*e)}fill(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e;s>0&&(this.data[t]|=1),e>0&&(this.data[t]|=2),s<this.h-1&&(this.data[t]|=4),e<this.w-1&&(this.data[t]|=8)}}isBorder(s,e){let t=s%this.w,i=(s-t)/this.w;return this.isBorder2(i,t,e)}isBorder2(s,e,t){if(t===0)return!s;if(t===1)return!e;if(t===2)return s>=this.h-1;if(t===3)return e>=this.w-1;throw new Error("bad direction")}delete2(s,e,t=s*this.w+e){if(this.fixed.has(t))return!1;let i=new Map;i.set(t,0);for(let r=0;r<4;r++){if(this.isBorder2(s,e,r))continue;let o=t+this.delta(r),a=this.data[o],l=a&~(1<<(r^2));if(a!==l){if(this.fixed.has(o))return!1;i.set(o,l)}}return this.try(i)}delete(s){let e=s%this.w,t=(s-e)/this.w;return this.delete2(t,e,s)}deleteEdge2(s,e,t,i=s*this.w+e){if(this.fixed.has(i))return!1;if(this.isBorder2(s,e,t))return this.data[i]&=~(1<<t),!0;let r=new Map,o=i+this.delta(t);return this.fixed.has(o)?!1:(r.set(i,this.data[i]&~(1<<t)),r.set(o,this.data[o]&~(1<<(t^2))),this.try(r))}deleteEdge(s,e){let t=s%this.w,i=(s-t)/this.w;return this.deleteEdge2(i,t,e,s)}refine(s,e){let t=0,i=new Set;for(let r=0;r<this.data.length;r++)this.data[r]&&t++,this.fixed.has(r)||i.add(r);for(;t>e;){let r=!1;for(let o of s.ishuffle(i)){if(t<=e)break;if(!this.data[o]){t--;continue}this.delete(o)&&(r=!0,t--)}if(!r)return!1}return!0}validate(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e,i=this.data[t];if(s&&!(this.data[t-this.w]&4)!=!(i&1))throw new Error(`invalid above ${s}${e}`);if(e&&!(this.data[t-1]&8)!=!(i&2))throw new Error(`invalid left of ${s}${e}`)}}addEdge(s,e,t){let i=s*this.w+e;this.data[i]|=1<<t,this.isBorder2(s,e,t)||(this.data[i+this.delta(t)]|=1<<(t^2))}consolidate(s,e){let t=new Rs;for(let r=0;r<this.data.length;r++)!this.fixed.has(r)&&this.data[r]&&t.add(this.data[r]);let i=1e3;for(;t.unique()>e&&--i;){let r=[...t].sort((c,d)=>d[1]-c[1]),o=r[e][1],a=new Set(r.filter(c=>c[1]<=o).map(c=>c[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[c,d]of s.pick(l))this.data[c]&&t.delete(this.data[c]),d&&t.add(d),this.data[c]=d}return i?[...t].map(r=>r[0]):[]}consolidateFixed(s,e){let t=new Rs;for(let r=0;r<this.data.length;r++){let o=this.data[r];!this.fixed.has(r)&&e.has(o)&&t.add(o)}let i=1e3;for(;t.unique()&&--i;){let r=this.findEligibleConsolidates(e);if(!r.length)return!1;for(let[o,a]of s.pick(r)){let l=this.data[o];e.has(l)&&t.delete(l),e.has(a)&&t.add(a),this.data[o]=a}}return!!i}findEligibleConsolidates(s){let e=[],t=[];for(let i=0;i<this.data.length;i++){if(this.fixed.has(i))continue;let r=this.data[i];if(!!s.has(r))for(let o=0;o<4;o++){if(this.isBorder(i,o))continue;let a=this.delta(o);if(this.fixed.has(i+a))continue;let l=1<<o;if(s.has(r^l))continue;let c=1<<(o^2),d=this.data[i+a],f=new Map([[i,r^l],[i+a,d^c]]);if(!!this.check(f)&&(e.push(f),!s.has(d^c)&&s.has(d))){t.push(f);break}}}return t.length?t:e}try(s){if(!this.check(s))return!1;for(let[e,t]of s)this.data[e]=t;return!0}check(s){let e=new xe;for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let r=t*this.w+i,o=s?.get(r)??this.data[r];o&&e.union([r]),t>0&&o&1&&e.union([r,r-this.w]),i>0&&o&2&&e.union([r,r-1]),t<this.h-1&&o&4&&e.union([r,r+this.w]),i<this.w-1&&o&8&&e.union([r,r+1])}return e.roots().length===1}addPath(s,e){let t,i;if(!this.size)t=s.nextInt(this.h),i=s.nextInt(this.w);else{let c=[];for(let f=0;f<this.data.length;f++)this.data[f]&&this.data[f]!==15&&c.push(f);if(!c.length)return!1;let d=s.pick(c);i=d%this.w,t=(d-i)/this.w}let r=new Map,o=t*this.w+i,a=0,l=!0;for(;;){let c=!1,d=r.get(o)??this.data[o],f=!1;for(let u of s.ishuffle([0,1,2,3])){let h=1<<u;if(d&h)continue;let p=d|h;if(this.valid&&!this.valid.has(p))continue;let m=t+Zr[u],b=i+Jr[u];if(m<0||b<0||m>=this.h||b>=this.w)continue;let v=m*this.w+b,g=r.get(v)??this.data[v],w=g|1<<(u^2);if(g){if(g===w||this.valid&&!this.valid.has(w))continue;c=!0}l=!this.valid||this.valid.has(w),r.set(o,p),r.set(v,w),i=b,t=m,o=v,f=!0;break}if(!f||c||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&s.nextInt(15)<a++)break}if(!r.size||!l)return!1;for(let[c,d]of r)this.data[c]=d;return!0}toGrid(s){let e=new Me(this.h,this.w);for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let r=t*this.w+i,o=this.data[r];if(!o)continue;let a=t<<12|i<<4|2056;e.set(a,s);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let c=l&1?8:2048;e.set(l&2?a+c:a-c,s)}}return e}delta(s){return(s&2?1:-1)*(s&1?1:this.w)}show(){let s=[];for(let e=0;e<this.h;e++){let t="";for(let i=0;i<this.w;i++)t+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+i]];s.push(t)}return s.join(`
`)}},Jt=class{constructor(s,e,t){this.grid=s;this._i=e*s.w+t}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(s){let e=this.grid.delta(s),t=this._i+e,i=1<<s,r=1<<(s^2);this.grid.data[this._i]|=i,this.grid.data[this._i=t]|=r}directedPath(s,e,t){for(;;){let i=this.y,r=this.x,o=[];if(e<i&&o.push(0),t<r&&o.push(1),e>i&&o.push(2),t>r&&o.push(3),!o.length)return;this.go(s.pick(o))}}},Zr=[-1,0,1,0],Jr=[0,-1,0,1];var Mt=class extends C{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(t=>this.grid.get(t+2056)).length,R)}initialFillEarly(){let e=new De(this.h,this.w,this.getValidEarlyScreens()),t=0,i=this.targetEarly();for(;t++<20&&e.size<i;)e.addPath(this.random,i)&&(t=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),R}initialFillLate(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|t<<4|2056;this.grid.get(i)||this.grid.set(i,"c")}for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)for(let i of[8,2048]){let r=e<<12|t<<4|2056,o=r+i,a=r+2*i;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(r)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let t of[8,2048]){let i=e|2056,r=i+t,o=i+2*t;if(this.grid.isBorder(r)||this.grid.get(r))continue;this.grid.set(r,"c");let a=this.extract(this.grid,i-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(r,"")}return R}pruneDisconnected(){let e=new Set(this.grid.partition().values()),t=0;for(let i of e)if([...i].some(o=>this.grid.get(o)===this.early))t+=[...i].filter(o=>(o&2056)===2056).length;else for(let o of i){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${V(o)} disconnected`};this.grid.set(o,"")}return t<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):R}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let t of this.orig.tileset){let i=t.edgeIndex(this.early);i!=null&&e.add(i)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},Qt=class extends Mt{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new De(this.h,this.w);e.fill();let t=te(e.data.length).slice(e.w),i=this.random.pick(t);if(!e.deleteEdge(i,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,3))return{ok:!1,fail:"initial stair"};e.fixed.add(i);let r=new Set(t);r.delete(i);let o=[];for(let d of this.random.ishuffle(r)){let f=function(b){return e.delete(b)?(e.fixed.add(b),!0):!1},u=this.params.features?.arena??0;if(o.length>=u)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let h=!e.isBorder(d,1),p=!e.isBorder(d,3);if(h&&e.fixed.has(d-1)||p&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!f(d-e.w))return{ok:!1,fail:"initial arena"};if(h&&!f(d-1))return{ok:!1,fail:"initial arena"};if(p&&!f(d+1))return{ok:!1,fail:"initial arena"};let m=d+e.w;if((e.data[m]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(m+e.w,2),e.fixed.add(m),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,f)=>{let u=d%e.w,p=(d-u)/e.w<<12|u<<4|2056;this.grid.set(p,f);for(let m of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(p+m)};l(i,">");for(let d of o)l(d,"a");let c=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&c++;return this.size=c,R}addStairs(e,t){return super.addStairs(e,t?t-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let t=e<<12|2056;for(let i=0;i<this.w;i++){let r=t|i<<4;this.grid.get(r)==="a"&&this.grid.set(r-2048,"c")}}return R}preinfer(){let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="w"&&e.set(this.grid.coord(r),"");let t=this.grid.partition(e),i=new Set;for(let[r,o]of t)this.grid.get(r)==="<"&&i.add(o);return i.size<2?{ok:!1,fail:"stairs bunched"}:R}refineMetascreens(e){for(let t of e.allPos())e.get(t).hasFeature("arena")&&e.set(t,e.rom.metascreens.fortressArena_through);return R}refineEdges(){return!0}};var _e=class extends Mt{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return R;let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="r"&&e.set(this.grid.coord(r),"");let t=this.grid.partition(e),i=[];for(let r=0;r<this.grid.data.length;r++)(this.grid.data[r]==="<"||this.grid.data[r]===">"||this.grid.data[r]&&this.grid.isBorder(this.grid.coord(r)))&&i.push(t.get(this.grid.coord(r)));return new Set(i).size<i.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return R}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056,o=r-8,a=o-8,l=r+8,c=l+8,d=r-2048,f=r+2048;if(t.get(r)!=="c"||t.get(d)!=="c"||t.get(f)!=="c")continue;let u=t.isBorder(o)?"":this.extract(t,a-2056),h=t.isBorder(l)?"":this.extract(t,c-2056);if(!/[^ c]/.test(u+h)&&(t.isBorder(o)||(t.set(o,""),t.set(a,""),t.set(a-8,""),t.set(a-2048,""),t.set(a+2048,"")),t.isBorder(l)||(t.set(l,""),t.set(c,""),t.set(c+8,""),t.set(c-2048,""),t.set(c+2048,"")),this.fixed.add(r),this.fixed.add(d),this.fixed.add(f),t.set(r,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},es=class extends _e{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new De(this.h,this.w,this.getValidEarlyScreens()),t=2+this.random.nextInt(this.w-4),i=2+this.random.nextInt(this.w-4),r=new Jt(e,this.h-1,i);return r.go(0),r.directedPath(this.random,1,t),r.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),R}addEdges(){let e=-1,t=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(t|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let i=t|this.random.nextInt(e)<<4,r=t|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.grid.set(r,">"),this.grid.set(r-8,""),this.grid.set(r+8,""),this.fixed.add(i),this.fixed.add(r),R}addStairs(){return R}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}},ts=class extends C{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new O(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let f=0;for(let u=0;u<4;u++)d.data.edges[u]==="s"&&(f|=1<<u);e.get(f).push(...d.gridTiles())}let t=1+this.random.nextInt(this.w-2),i=1+this.random.nextInt(this.h-2),r=i<<4|t,o=this.posToGrid(r,2056),a=i<this.h/2?2:0;this.insertTile(r,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){r+=Qr[a],o=o+Ns[a];let f=a^2,u=[];for(let[p,m]of e){if(!(p&1<<f))continue;let b=p&~(1<<f);if(!(d?!b:b))for(let v of m)u.push(p)}let h;for(let p of this.random.ishuffle(u))if(!this.grid.isBorder(o+Ns[p])&&this.insertTile(r,this.random.pick(e.get(p)))){h=31-Math.clz32(p&~(1<<f));break}if(h==null)return{ok:!1,fail:"spikes"};a=h}let l=[];for(let d=3;d<this.h-3;d++)for(let f=1;f<this.w-1;f++)l.push(d<<12|f<<4|2056);let c=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let f of Ns){if(this.grid.get(d+f)!=="c")continue;this.grid.set(d,"r");let u=2056&~Math.abs(f);this.grid.set(d+u,"r"),this.grid.set(d-u,"r");let h=this.random.pick([-u,u]);this.grid.set(d+2*h,"r"),this.grid.set(d+3*h,"r"),this.grid.set(d+2*h-f,"c"),c=!0;break}if(c)break}if(!c)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return R}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}refine(){return R}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){return[...new Set(a.values())].filter(c=>{for(let d of c)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:R}},Ns=[-2048,-8,2048,8],Qr=[-16,-1,16,1],ss=class extends _e{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],t=0;for(let l of this.random.ishuffle(te(this.w-2,c=>c+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let c=this.h-1<<12|l<<4|2056;if(this.grid.set(c,"c"),this.grid.set(ce(c),"c"),this.grid.set(Q(c),"n"),this.fixed.add(c),this.fixed.add(ce(c)),this.fixed.add(Q(c)),e.push(l),t++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let i=this.w,r=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*r+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;i<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};i+=l,t+=l}let a=this.params.size;for(;t<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};t+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(l){let c=0;for(let d of new Set(l.values()))for(let f of d)if(e.exitType(f)==="edge:bottom"){c+=d.size;break}return c}let r=i(e.traverse({noFlagged:!0})),o=i(e.traverse());if(r===o)return{ok:!1,fail:"bridge didn't matter"};let a=i(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:R}},is=class extends _e{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let r=0;r<this.grid.data.length;r++)if(this.grid.data[r]==="r"){e=this.grid.coord(r)-2056;break}if(e==null)throw new Error("no corner");let t=[];for(let r=0;r<this.pattern.length;r++)for(let o=1;o<this.pattern[r].length-1;o++)!((o^r)&1)||this.pattern[r][o]===" "&&t.push(e+(r<<11|o<<3));let i=this.random.shuffle([..."ccrrrrrrrr"]);for(let r of this.random.ishuffle(t)){let o=i[i.length-1];if(!(o==="c"&&[...this.extract(this.grid,r-2056)].filter(a=>a==="r").length<4)&&(this.canSet(r,o)&&this.grid.set(r,i.pop()),!i.length))break}for(let r=0;r<6;r++)this.tryAdd({char:"c"});return R}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let r=this.addStairs(...e);if(!r.ok)return r}let t=0;for(let r of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,r).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(r+8)&&(this.grid.set(r+2056,"<"),e[0]--),this.fixed.add(r+2056),++t>=2))break;let i=this.grid.partition();return new Set(i.values()).size>1?{ok:!1,fail:"orphans"}:R}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:R}checkMeta(e,t){let i=e.traverse(t?{with:t}:{}),r=[];for(let o of new Set(i.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;r.push(a)}return r.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){let l=0;for(let c of new Set(a.values()))for(let d of c)if(e.exitType(d)){l+=c.size;break}return l}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:R}};var rs=class extends C{build(){let{h:s,w:e}=this,t=this.orig.rom,i=new De(s,e);i.fill();let r=s*e<28?0:this.random.nextInt(s-1),o=this.random.nextInt(e),a=new Set;function l(y,M){i.delete2(y,M),a.add(y*i.w+M)}function c(y){return!y.startsWith("edge")}a.add(r*i.w+o),o&&l(r,o-1),o<i.w-1&&l(r,o+1),r&&(l(r-1,o),o&&l(r-1,o-1),o<i.w-1&&l(r-1,o+1));for(let y of a)i.fixed.add(y);let d=new Set;for(let y=0;y<4;y++){let M=y&1?s:e,L=this.random.shuffle(te(M)),K=y&2?M:0,Y=this.params.edges?.[y]??0;for(;Y&&L.length;){let J=y&1?L.pop():K,oe=y&1?K:L.pop(),U=J*i.w+oe;!i.data[U]||i.fixed.has(U)||(i.addEdge(J,oe,y),d.add(J<<4|oe),Y--)}if(Y)return{ok:!1,fail:`could not add all edges: ${y} ${Y}
${i.toGrid("c").show()}
${i.data}`}}let f=0,u=i.h*i.w*(this.random.next()*.15+.4);for(let y of this.random.ishuffle(te(i.data.length<<2))){let M=y>>>2,L=y&3;if(!i.isBorder(M,L)&&i.deleteEdge(M,L)&&++f>=u)break}let h=new Set,p=new Set,m=[],b=[],v;for(let y of this.orig.tileset){if(y.hasFeature("arena")){v=y;continue}else if(y.hasFeature("empty")){m[0]=y;continue}let M=y.edgeIndex("s");if(M==null)throw new Error("bad edges");let L=y.data.exits?.some(K=>c(K.type));(L?b:m)[M]=y,(y.sid<0?p:h).add(y.sid)}if(!v)throw new Error("never found arena");let g=i.consolidate(this.random,h.size),w=new Set(g.map(y=>m[y].sid));if(!w.size)return{ok:!1,fail:"consolidate failed"};let x=[...p].filter(y=>w.has(y)),T=[...h].filter(y=>!w.has(y));if(x.length>T.length)throw new Error("out of space");if(x.length){let y=-1;for(;t.metascreens.getById(y).length;)y--;let M=y;for(let L=0;L<x.length;L++)t.metascreens.renumber(T[L],y),t.metascreens.renumber(x[L],T[L]),y=x[L];t.metascreens.renumber(M,x[x.length-1])}let E=new ge(this.orig.id,this.orig.tileset,s,e);for(let y=0;y<i.h;y++)for(let M=0;M<i.w;M++){let L=y===r&&M===o;E.set(y<<4|M,L?v:m[i.data[y*i.w+M]])}let F=[...this.orig.exits()].filter(y=>c(y[1])).length;for(let y of this.random.ishuffle(E.allPos())){if(!F)break;if(d.has(y))continue;let M=y&15,L=y>>>4,K=b[i.data[L*i.w+M]];!K||(E.set(y,K),F--)}return F?{ok:!1,fail:"could not place all doors"}:R}};function Li(n){let{swamp:s}=n.metatilesets,e=n.metascreens,t=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[i,r,o]of t)s.getTile(i).copyFrom(r).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var ns=class extends C{initialFill(){let e=this.size+3,t=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(je(t))||this.fixed.add(je(t,2)),this.grid.isBorder(ve(t))||this.fixed.add(ve(t,2)),this.grid.set(t,">"),this.fixed.add(t),this.grid.set(ce(t),"w"),this.fixed.add(ce(t)),this.fixed.add(je(t)),this.fixed.add(ve(t));let i=this.random.nextInt(this.w)<<4|2056,r=Q(i,2);if(this.grid.set(i,"<"),this.fixed.add(i),this.grid.set(Q(i),"w"),this.fixed.add(Q(i)),this.grid.set(r,"w"),this.fixed.add(r),this.grid.set(Q(r),"w"),this.fixed.add(Q(r)),this.fixed.add(je(r)),this.fixed.add(ve(r)),!this.tryConnect(ce(t,2),Q(r,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<e;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return R}refine(){return R}refineEdges(){return!0}addArenas(){return!0}addStairs(){return R}refineMetascreens(e){console.log(e.show());for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++){let o=i<<4|r,a=e.get(o),l=a.edgeIndex("w");if(a.hasFeature("arena"))this.arena=o+16<<8|1;else if(l===5){if(o<16||!e.get(o-16).hasFeature("arena")){e.set(o,e.rom.metascreens.goaWideHallNS_stairs);let c=(o<<8|o<<4)&61680|2056;this.grid.set(c,"H")}}else l===1&&(this.stair=o<<8|2)}if(this.reachable=void 0,!this.checkMeta(e))return{ok:!1,fail:"initial meta check"};console.log(e.show());let t=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let i=0;i<e.width;i++)for(let r=0;r<e.height;r++){let o=r<<12|i<<4|2056,a=0;for(;r+a<e.height&&this.grid.get(o+a*4096)==="H";)a++;if(!a)continue;let l=[new Map,new Map];for(let d=0;d<a;d++)l[d&1].set(r+d<<4|i,t);let c=!1;for(let d of this.random.ishuffle(l)){if(!d.size){c=!0;continue}if(!!this.checkMeta(e,d)){for(let[f,u]of d)e.set(f,u),this.grid.set(o+4096*((f>>4)-r),"=");c=!0;break}}if(!c)return{ok:!1,fail:"could not rectify hallway"};r+=a}return super.refineMetascreens(e)}checkMeta(e,t){let i=t?{with:t}:{},r=e.traverse(i),o=r.get(this.stair);return o!==r.get(this.arena)?(console.log(`stair not connected to arena
${e.show()}`),!1):this.reachable==null?o&&o.size<r.size*.95?(console.log("too small"),!1):(this.reachable=o?.size,!0):o?.size>this.reachable*.95}};function Bi(n,s){let{metatilesets:{cave:e,fortress:t,iceCave:i,labyrinth:r,pyramid:o}}=n;n.metascreens.registerFix(14,1);{for(let l of[r,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[t,r,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[i,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);r.getTile(23).copyFrom(198).setAlternative(197),r.getTile(24).copyFrom(196).setAlternative(197)}let a=new O(()=>[]);for(let l of n.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,c]of a){let d=n.screens[l],f=c.map(p=>p.data.tilesets.labyrinth?.removeWall),[u,...h]=new Set(f.filter(p=>p!=null));if(u!=null){if(d.set2d(u,[[197,197],[208,197]]),h.length)throw new Error("bad remove");for(let p=0;p<f.length;p++)f[p]==null&&(c[p].data.tilesets.labyrinth.addWall=[u])}if(!(c.length<2)){if(c.length>2){let p=s.pick(c.filter(m=>m.data.tilesets.labyrinth?.addWall));c.splice(c.indexOf(p),1),p.remove()}for(let p of c){let m=p.data.tilesets.labyrinth?.addWall;if(m!=null){p.data.mod="block";for(let b of m)d.set2d(b,[[23,23],[24,24]])}else p.flag="always"}}}}var os=class{constructor(s){this.location=s}shuffle(s){if(this.meta)throw new Error("impossible");let e=this.location.meta;tn(e,s),s.nextInt(2)&&sn(this.location.rom);let t=[...e.exits()].filter(a=>a[1]==="stair:up"),i=[...e.exits()].filter(a=>a[1]==="stair:down");s.shuffle(t),s.shuffle(i);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?t:i).pop();e.setExit(l[0],l[1],a[2])}if(t.length!==i.length)throw new Error("length mismatch");let r=s.shuffle([...i]);for(let a=0;a<i.length;a++)i[a]===r[a]&&(s.shuffle(r),a=-1);let o=this.location.id<<8;for(let a=0;a<t.length;a++)e.setExitOneWay(t[a][0],t[a][1],[o|i[a][0],i[a][1]]),e.setExitOneWay(r[a][0],r[a][1],[o|t[a][0],t[a][1]]);this.meta=e}finish(){}};function tn(n,s){let e=s.nextInt(2)+6,t=s.nextInt(3)+2;if(e===7&&t===3)return;let{branchNWSE:i,branchNWE:r,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:c}=n.rom.metascreens,d=e<<4|t,f=o;e===7&&t===1&&(f=c),e===7&&t===5&&(f=l),n.set2d(99,[[i],[i],[i]]),n.set2d(d-16,[[r],[a],[f]]),n.moveExit(115,d)}function sn(n){let s=n.locations.Pyramid_Draygon.meta,e=n.locations.Pyramid_Main.meta,{metascreens:{hallSE:t,deadEndW_downStair:i,wideHallNE:r,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=n;s.width=2,s.set2d(0,[[null,l],[null,a],[r,o]]),s.moveExit(32,1),e.set2d(3,[[t,i]]),e.moveExit(3,4),e.attach(4,s,1)}function Di(n,s,e){let t=new Os(n),i=new Ws(s,t),r=new zs(e,i);return[t,i,r]}var Os=class extends C{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let t=this.insertPattern(e,{top:1,bottom:1});if(!t.ok)return t;this.addAllFixed();for(let i=0;i<this.grid.data.length;i++){if(this.grid.data[i]!==">")continue;let r=this.grid.coord(i);this.stair=r>>>8&240|r>>>4&15}return R}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let t of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,t)===" c  c  c "){this.grid.set(t+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return R}addLateFeatures(){return R}addStairs(){return R}},Ws=class extends C{constructor(e,t){super(e);this.location=e;this.upper=t;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],t=!0,i=this.upper.meta,r=this.upper.stair;if(i.get(r).isEmpty()||(r+=16,t=!1),r==null)throw new Error("no stair found");for(let x of i.allPos())i.get(x).hasFeature("overpass")&&e.push(x);this.random.shuffle(e);let o=r>>>4,a=r&15,l=a,c=o;for(let x of e){let T=x>>>4,E=x&15;o=Math.min(o,T),a=Math.min(a,E),l=Math.max(l,E),c=Math.max(c,T)}let d=c-o+1,f=l-a+1,u=o<<4|a,h=1+this.random.nextInt(this.w-f-2),m=(this.random.nextInt(this.h-d-(t?1:0))<<4|h)-u,b=(r&15)-a<f/2;r+=m;for(let x=0;x<e.length;x++)e[x]+=m;let v=t?"    <  c ":b?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(r,v)){let x=[-1,1,16,-16,15,17,-15,-17],T=!1;for(let E of this.random.ishuffle(x))if(this.insertTile(r+E,v)){r+=E,T=!0;break}if(!T)throw new Error("Could not insert stair")}this.stair=r,this.addAllFixed(),this.count=3;let g=b?1:-1,w=t?16:g;return!e.includes(r+g)&&!this.tryConnect(this.posToGrid(r+w,2056),this.posToGrid(e[0]-g,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+g,2056),this.posToGrid(e[1]+g,2056),"c",10)?R:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"could not populate"}}refine(){return R}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let t=e+2056;if(!(this.fixed.has(t)||this.grid.get(t))&&!(this.grid.get(je(t,2))||this.grid.get(ve(t,2)))&&this.grid.get(Q(t,2))==="c"&&!!this.canSetAll(new Map([[Q(t),"c"],[t,"a"],[ce(t),"c"],[ce(t,2),"c"]])))return this.grid.set(Q(t),"c"),this.grid.set(t,"a"),this.grid.set(ce(t),"c"),this.fixed.add(t),this.fixed.add(ce(t,2)),!0}return!1}addStairs(e=0,t=0){return super.addStairs(e-1,t)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,t=this.upper.stair,i=this.stair;t!=null&&i!=null&&this.meta.attach(i,e,t,"stair:up","stair:down")}},zs=class extends C{constructor(e,t){super(e);this.main=t}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let t of e.allPos())if(e.get(t).hasFeature("arena"))return t;throw new Error("never found arena")}initialFill(){let e=this.main.meta,t=this.findArena(e),i=this.posToGrid(t,2056);return this.grid.set(i,"a"),this.grid.set(ce(i),"c"),this.grid.set(Q(i),"c"),this.fixed.add(i),this.fixed.add(Q(i)),this.fixed.add(Q(i,2)),R}addEdges(){let e=10,t=2+this.random.nextInt(2);for(;this.count<t&&e;)this.tryAdd()||e--;return e?R:{ok:!1,fail:"addEdges"}}refine(){return R}addLateFeatures(){return R}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let t=e.value,i=this.findArena(t),r=this.main.meta;return t.set(i+15,this.orig.tileset.unreachableVariant(r.get(i+15))),t.set(i+16,this.orig.tileset.unreachableVariant(r.get(i+16))),t.set(i+17,this.orig.tileset.unreachableVariant(r.get(i+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,t=this.findArena(this.meta);super.finishInternal(),e.setExit(t,"seamless:up",[this.meta.id<<8|t,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},qs=class extends C{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return Me.writeGrid2d(this.grid,0,qs.PATTERN),this.count=36,R}addSpikes(){let e=this.random.nextInt(4);for(let r=1;r<10;r++)for(let o=0;o<4;o++){let a=2*o+5+r*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),r===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let t=0;for(let r of this.random.ishuffle(this.grid.screens())){if(t===3)break;let o=r|2056,a=ce(o),l=ce(o,2),c=Q(o),d=Q(o,2),f=je(o),u=ve(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(c)==="s"||this.grid.get(d)==="s")continue;let h=[],p=[];for(let m of[c,f,u])this.grid.get(m)==="c"&&(this.grid.get(2*m-o)==="s"?p.push(m):h.push(m));if(!(p.length>1)&&!(!h.length&&!p.length)){for(;h.length+p.length>1&&!(h.length+p.length===2&&!h.includes(c)&&!p.includes(c));){let[m]=h.splice(this.random.nextInt(h.length),1);this.grid.set(m,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),t++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return R}},Ft=qs;Ft.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "];function _i(n,s,e){let t=n.locations;rn(n,e);let i=new Kt(n,e);i.add(),i.shuffles.length||i.add(new C(t.EastCave1),new C(t.EastCave2),new C(t.EastCave3),...Yt(t.SealedCave1,t.SealedCave2),new C(t.SealedCave3),new C(t.SealedCave4),new C(t.SealedCave5),new C(t.SealedCave6),new C(t.SealedCave7),new C(t.SealedCave8),new C(t.WindmillCave),new C(t.ZebuCave),new rs(t.Swamp),new C(t.MtSabreWest_Cave1),new C(t.MtSabreWest_Cave2),new C(t.MtSabreWest_Cave3),new C(t.MtSabreWest_Cave4),new C(t.MtSabreWest_Cave5),new C(t.MtSabreWest_Cave6),new ot(t.MtSabreWest_Cave7),new C(t.MtSabreNorth_Cave1),new C(t.MtSabreNorth_Cave2),new C(t.MtSabreNorth_Cave3),new C(t.MtSabreNorth_Cave4),new C(t.MtSabreNorth_Cave5),new C(t.MtSabreNorth_Cave6),new C(t.MtSabreNorth_Cave7),new C(t.MtSabreNorth_Cave8),new C(t.MtSabreNorth_Cave9),new C(t.MtSabreNorth_LeftCell2),new C(t.MtSabreNorth_SummitCave),new C(t.KirisaPlantCave1),new C(t.KirisaPlantCave2),new C(t.KirisaPlantCave3),new C(t.FogLampCave1),new C(t.FogLampCave2),new C(t.FogLampCave3),new Zt(t.FogLampCaveDeadEnd),...Yt(t.FogLampCave5,t.FogLampCave4,!0),...Yt(t.FogLampCave7,t.FogLampCave6),new ot(t.WaterfallCave1),new C(t.WaterfallCave2),new nt(t.WaterfallCave3),new es(t.WaterfallCave4),new _e(t.EvilSpiritIsland2).requirePitDestination(),new ot(t.EvilSpiritIsland3),new _e(t.EvilSpiritIsland4),new Qt(t.SaberaPalace1).requirePitDestination(),new C(t.SaberaPalace2),new C(t.SaberaPalace2_West),new C(t.JoelSecretPassage),new C(t.MtHydra_Cave1),new C(t.MtHydra_Cave2),new C(t.MtHydra_Cave3),new C(t.MtHydra_Cave4),new C(t.MtHydra_Cave5),new C(t.MtHydra_Cave6),new nt(t.MtHydra_Cave7),new C(t.MtHydra_Cave8),new C(t.MtHydra_Cave9),new C(t.MtHydra_Cave10),new nt(t.Styx1).setUpEdgeType("c"),new ss(t.Styx2).requirePitDestination(),new C(t.Styx3),new is(t.OasisCaveMain),new C(t.DesertCave1),new C(t.DesertCave2),new C(t.Pyramid_Branch),new os(t.Pyramid_Main),new Xt(t.Crypt_Entrance),new nt(t.Crypt_Hall1).setUpEdgeType("c"),new C(t.Crypt_DeadEndLeft),new C(t.Crypt_DeadEndRight),new C(t.Crypt_Branch),new C(t.Crypt_Hall2),new ns(t.GoaFortress_Kelbesque),new _e(t.GoaFortress_Sabera),new C(t.GoaFortress_Mado1).requirePitDestination(),new C(t.GoaFortress_Mado2),new C(t.GoaFortress_Mado3),new C(t.GoaFortress_Karmine1),new C(t.GoaFortress_Karmine2),new C(t.GoaFortress_Karmine4),new Ft(t.GoaFortress_Karmine6),...Di(t.GoaFortress_Karmine3,t.GoaFortress_Karmine5,t.GoaFortress_Kensu),new ts(t.OasisCave_Entrance)),i.shuffleAll(),console.log(String(i))}function rn(n,s=new rt(1)){Ei(n),Li(n),Bi(n,s)}var Gt=typeof __VERSION__=="object"?__VERSION__:{},$s=Gt.STATUS||"unstable",Ni=Gt.VERSION||"HEAD",$l=Gt.LABEL||"HEAD",Oi=Gt.HASH||"HEAD",Hl=Gt.DATE||new Date;var Hs=class{constructor(s,e,t,i){this.filename=s,this.chrdata=Array.from(new Uint8Array(e)),this.palette=t,this.rendered=Array.from(new Uint8Array(i.data))}};async function Ul(n){let s=document.createElement("canvas");s.width=112,s.height=100;let e=s.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,s.width,s.height);let t=new ImageData(new Uint8ClampedArray(n.rendered),128,128),i=await createImageBitmap(t,{resizeQuality:"pixelated"});return e.drawImage(i,0,0,16,24,24,2,16*4,24*4),s.toDataURL("image/png")}async function on(n,s){let e=n.byteLength/16,t=8,i=0,r=document.createElement("canvas");r.width=128,r.height=128;let a=r.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(n);for(let c=0;c<e;++c){let d=c*16,f=c%16*8,u=Math.floor(c/16)*8;for(let h=0;h<t;++h){let p=l[d+h],m=l[d+h+8];for(let b=0;b<t;++b){let v=7-b,g=p>>v&1,w=(m>>v&1)<<1,x=(g|w)+i*4,T=cn[s[x]],E=(f+b)*4+(u+h)*4*128;a.data[0+E]=T[0],a.data[1+E]=T[1],a.data[2+E]=T[2],a.data[3+E]=x==0?0:255}}}return a}var ls=class{constructor(s,e,t,i){this.name=s,this.converter=e,this.nssdata=t,this.description=i}static async init(s,e,t,i){let r=await t;return new ls(s,e,r,i)}static applyPatch(s,e,t){if(!ls.isCustom(s))return;let i=t?262144:0;for(let[r,o]of at.getChr(s.converter))for(let a of o)for(let l=0;l<16;++l)e[a+l+i]=s.nssdata.chrdata[r*16+l];for(let[r,o]of at.getPalette(s.converter))for(let a of o)switch(r){case"color0":e[a]=s.nssdata.palette[0];break;case"color1":e[a]=s.nssdata.palette[1];break;case"color2":e[a]=s.nssdata.palette[2];break;case"color3":e[a]=s.nssdata.palette[3];break;case"metasprite":e[a+i]=0;break}}},Ke=ls;Ke.isCustom=s=>s.name!="Simea";var as=class{constructor(){this.simeaReplacements=new Map;this.mapping=new Map;this.simeaReplacements.set("Simea",Ke.init("Simea","simea",Wi("images/spritesheets/Simea.nss"),"The original main character of Crystalis")),this.simeaReplacements.set("Mesia",Ke.init("Mesia","simea",Wi("images/spritesheets/Mesia.nss"),"Secondary protagonist Mesia takes the spotlight! Artwork by jroweboy")),this.mapping.set("simea",this.simeaReplacements)}static get(s){return this.instance||(this.instance=new as),this.instance.mapping.get(s)}};function k(n,s,e){return 262160+n*8192+s*4096+e*16}var at=class{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.simeaChrMapping=this.generateSimeaMapping(),this.simeaPaletteMapping=this.generateSimeaPalette(),this.chrMapping.set("simea",this.simeaChrMapping),this.paletteMapping.set("simea",this.simeaPaletteMapping)}static getChr(s){return this.instance||(this.instance=new at),this.instance.chrMapping.get(s)}static getPalette(s){return this.instance||(this.instance=new at),this.instance.paletteMapping.get(s)}generateSimeaPalette(){let s=new Map,e=27888+16;return s.set("color0",[e+0]),s.set("color1",[e+1]),s.set("color2",[e+2]),s.set("color3",[e+3]),s.set("metasprite",[245844+16]),s}generateSimeaMapping(){let t=new Map;t.set(0,[k(8,0,26)]),t.set(1,[k(8,0,27)]),t.set(16,[k(8,0,0)]),t.set(17,[k(8,0,1)]),t.set(32,[k(8,0,32)]),t.set(33,[k(8,0,33)]),t.set(2,[k(8,0,28)]),t.set(3,[k(8,0,29)]),t.set(18,[k(8,0,2)]),t.set(19,[k(8,0,3)]),t.set(20,[k(8,0,4)]),t.set(21,[k(8,0,5)]),t.set(34,[k(8,0,34)]),t.set(35,[k(8,0,35)]),t.set(36,[k(8,0,36)]),t.set(37,[k(8,0,37)]),t.set(6,[k(8,0,30)]),t.set(7,[k(8,0,31)]),t.set(22,[k(8,0,6)]),t.set(23,[k(8,0,7)]),t.set(38,[k(8,0,38)]),t.set(39,[k(8,0,39)]),t.set(64,[k(8,0,20)]),t.set(65,[k(8,0,21)]),t.set(80,[k(8,0,52)]),t.set(81,[k(8,0,53)]),t.set(50,[k(8,0,60)]),t.set(51,[k(8,0,61)]),t.set(66,[k(8,0,24)]),t.set(67,[k(8,0,25)]),t.set(82,[k(8,0,56)]),t.set(68,[k(8,0,22)]),t.set(69,[k(8,0,23)]),t.set(84,[k(8,0,54)]),t.set(112,[k(8,0,14)]),t.set(113,[k(8,0,15)]),t.set(128,[k(8,0,46)]),t.set(129,[k(8,0,47)]),t.set(114,[k(8,0,18)]),t.set(115,[k(8,0,19)]),t.set(130,[k(8,0,48)]),t.set(131,[k(8,0,51)]),t.set(116,[k(8,0,16)]),t.set(117,[k(8,0,17)]),t.set(133,[k(8,0,49)]),t.set(160,[k(8,0,8)]),t.set(161,[k(8,0,9)]),t.set(176,[k(8,0,40)]),t.set(146,[k(8,0,58)]),t.set(147,[k(8,0,59)]),t.set(162,[k(8,0,12)]),t.set(163,[k(8,0,13)]),t.set(178,[k(8,0,44)]),t.set(179,[k(8,0,45)]),t.set(164,[k(8,0,10)]),t.set(165,[k(8,0,11)]),t.set(181,[k(8,0,43)]);let i=new Map(t);for(let[o,a]of i){let l=o+8,c=a.map(d=>d+1024);t.set(l,c)}t.set(192,[k(11,1,0)]),t.set(193,[k(11,1,1)]),t.set(208,[k(11,1,2)]),t.set(209,[k(11,1,3)]),t.set(224,[k(11,1,4)]),t.set(225,[k(11,1,5)]),t.set(194,[k(11,1,36)]),t.set(195,[k(11,1,37)]),t.set(210,[k(11,1,6)]),t.set(211,[k(11,1,7)]),t.set(226,[k(11,1,38)]),t.set(227,[k(11,1,39)]),t.set(196,[k(11,1,32)]),t.set(197,[k(11,1,33)]),t.set(212,[k(11,1,34)]),t.set(213,[k(11,1,35)]),t.set(214,[k(11,1,20)]),t.set(215,[k(11,1,21)]),t.set(230,[k(11,1,22)]),t.set(231,[k(11,1,23)]),t.set(54,[k(11,1,12)]),t.set(55,[k(11,1,13)]),t.set(70,[k(11,1,50)]),t.set(71,[k(11,1,51)]),t.set(86,[k(11,1,46)]),t.set(87,[k(11,1,47)]),t.set(102,[k(11,1,18)]),t.set(103,[k(11,1,19)]),t.set(118,[k(11,1,8)]),t.set(119,[k(11,1,9)]),t.set(134,[k(11,1,40)]),t.set(135,[k(11,1,41)]),t.set(150,[k(11,1,44)]),t.set(151,[k(11,1,45)]),t.set(166,[k(11,1,10)]),t.set(167,[k(11,1,11)]),t.set(182,[k(11,1,42)]),t.set(183,[k(11,1,43)]);let r=o=>[k(8,0,o)+1024*2,k(8,0,o)+1024*3,k(8,1,o),k(8,1,o)+1024,k(8,1,o)+1024*2];return t.set(240,r(16)),t.set(241,r(17)),t.set(242,r(18)),t.set(243,r(19)),t.set(244,r(20)),t.set(245,r(21)),t.set(246,r(22)),t.set(247,r(23)),t.set(248,[k(8,1,237)]),t.set(249,r(25)),t.set(250,r(26)),t.set(252,r(48)),t.set(253,r(49)),t.set(254,r(50)),t.set(255,r(51)),t}};async function Wi(n){let s=await(await fetch(n)).text(),e=n.replace(/^.*[\\\/]/,"");return dn(e,s)}function zi(n){let s="",e="",t=0;for(;t<n.length;)if(n[t]==="["){++t;let i=n.indexOf("]",t),r=parseInt(n.slice(t,i),16)-1;s+=e.repeat(r),t=i+1}else e=n.slice(t,t+2),s+=e,t+=2;return s}function qi(n,s){return n.match(new RegExp(".{1,"+s+"}","g"))||[]}function an(n){let s=qi(n,2).map(e=>parseInt(e,16));return new Uint8Array(s)}function ln(n){return n.map(s=>parseInt(s,16))}async function dn(n,s){let e=new Map(s.split(`
`).filter(a=>a.includes("=")).map(a=>a.split("=")).map(a=>[a[0],a[1]])),t=e.get("Palette")||"",i=ln(qi(zi(t).slice(0,32),2)),r=an(zi(e.get("CHRMain")||"")),o=await on(new Uint8ClampedArray(r),i);return new Hs(n,r,i,o)}var cn=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]];var fn=!1,Ve=class{constructor(s){this.overloads=s}canOverload(){return this.overloads[this.overloads.length-1].canOverload()}append(s){if(!this.canOverload()){let e=this.overloads[this.overloads.length-1].definition,i=(e?S.at(e):"").replace(/at/,"previously defined at"),r=s.overloads[0].definition,o=r?S.nameAt(r):"";throw new Error(`Non-overloadable: ${o}${i}`)}this.overloads.push(...s.overloads)}expand(s,e){let t=[];for(let i of this.overloads){let r=i.expand(s,e);if(Array.isArray(r))return r;t.push(r)}fn&&console.error(t.join(`
`))}static from(s){if(!S.eq(s[0],S.DEFINE))throw new Error("invalid");if(s[1]?.token!=="ident")throw new Error("invalid");let e=s[2],t;if(!e)t=new At([],[],s[1]);else if(e.token==="grp")t=new At(e.inner,s.slice(3),s[1]);else if(e.token==="lp"){let i=S.findBalanced(s,2);if(i<0)throw new Error(`Expected close paren ${S.nameAt(s[2])}`);t=new Us(S.identsFromCList(s.slice(3,i)),s.slice(i+1),s[1])}else t=new At([],s.slice(2),s[1]);return new Ve([t])}};function $i(n,s,e,t,i){let r=[],o=[],a=r;for(let l of i){if(l.token==="ident"){let d=t.get(l.str);if(d){a.push(...d);continue}}else if(S.eq(l,S.DOT_EOL)){o.push(a=[]);continue}let c=l.source&&n[0].source?{...l.source,parent:n[0].source}:l.source||n[0].source;a.push(c?{...l,source:c}:l)}return o=o.filter(l=>l.length),o.length&&e<n.length?"cannot expand .eol without consuming to end of line":(n.splice(s,e-s,...r),o)}var Us=class{constructor(s,e,t){this.params=s;this.production=e;this.definition=t}expand(s,e){let t=e+1,i=this.params.length?s.length:e,r=i,o=new Map;if(e<s.length&&S.eq(S.LP,s[t])){if(r=S.findBalanced(s,t),r<0)return"missing close paren for enclosed C-style expansion";i=r+1,t++}let a=S.parseArgList(s,t,r);if(a.length>this.params.length)return"too many args";for(t=0;t<this.params.length;t++){let l=a[t]||[],c=l[0];l.length===1&&c.token==="grp"&&(l=c.inner),o.set(this.params[t],l)}return $i(s,e,i,o,this.production)}canOverload(){return Boolean(this.params.length)}},At=class{constructor(s,e,t){this.pattern=s;this.production=e;this.definition=t}expand(s,e){let t=e+1,i=new Map;for(let r=0;r<this.pattern.length;r++){let o=this.pattern[r];if(o.token==="ident"){let a=this.pattern[r+1];if(!a||a?.token==="ident"){let l=s[t++];if(!l)return`missing undelimited argument ${S.name(o)}`;i.set(o.str,l.token==="grp"?l.inner:[l])}else{let l=S.eq(a,S.DOT_EOL)?s.length:S.find(s,a,t);if(l<0)return`could not find delimiter ${S.name(a)}`;i.set(o.str,s.slice(t,l)),t=l}}else if(S.eq(o,S.DOT_EOL)){if(t<s.length)return"could not match .eol"}else if(!S.eq(s[t++],o))return`could not match: ${S.name(o)}`}return $i(s,e,t,i,this.production)}canOverload(){return Boolean(this.pattern.length)}};var Xe=class{constructor(s,e){this.params=s;this.production=e}static from(s,e){if(!S.eq(s[0],S.MACRO))throw new Error("invalid");if(s[1]?.token!=="ident")throw new Error("invalid");let t=S.identsFromCList(s.slice(2)),i=[],r;for(;r=e.next();){if(S.eq(r[0],S.ENDMACRO))return new Xe(t,i);if(S.eq(r[0],S.ENDMAC))return new Xe(t,i);i.push(r)}throw new Error(`EOF looking for .endmacro: ${S.nameAt(s[1])}`)}expand(s,e){let t=1,i=new Map,r=[];for(let a of this.params){let l=S.findComma(s,t),c=s.slice(t,l);t=l+1,c.length===1&&c[0].token==="grp"&&(c=c[0].inner),i.set(a,c)}if(t<s.length)throw new Error(`Too many macro parameters: ${S.nameAt(s[t])}`);let o=new Map;for(let a of this.production){let l=function(c){let d=[];for(let f of c){if(f.token==="ident"){let h=i.get(f.str);if(h){d.push(...h);continue}let p=o.get(f.str);if(p){d.push({token:"ident",str:p});continue}}else if(f.token==="grp"){d.push({token:"grp",inner:l(f.inner)});continue}let u=f.source&&s[0].source?{...f.source,parent:s[0].source}:f.source||s[0].source;d.push(u?{...f,source:u}:f)}return d};if(S.eq(a[0],S.LOCAL))for(let c of S.identsFromCList(a.slice(1)))o.set(c,`${c}@${e.next()}`);r.push(l(a))}return r}};var hn=100,Hi=new WeakMap;function un(n){let s=Hi.get(n);return s||Hi.set(n,s=(e=>({next:()=>e++}))(0)),s}var ds=class extends zt.Abstract{constructor(e,t,i){super();this.stream=e;this.env=t;this.repeats=[];this.runDirectives={".define":e=>this.parseDefine(e),".undefine":e=>this.parseUndefine(e),".else":([e])=>Pt(".if",e),".elseif":([e])=>Pt(".if",e),".endif":([e])=>Pt(".if",e),".endmac":([e])=>Pt(".macro",e),".endmacro":([e])=>Pt(".macro",e),".endrep":e=>this.parseEndRepeat(e),".endrepeat":e=>this.parseEndRepeat(e),".exitmacro":([,e])=>{mn(e),this.stream.exit()},".if":([e,...t])=>this.parseIf(!!this.evaluateConst(js(t,e))),".ifdef":([e,...t])=>this.parseIf(this.macros.has(Ye(t,e))),".ifndef":([e,...t])=>this.parseIf(!this.macros.has(Ye(t,e))),".ifblank":([,...e])=>this.parseIf(!e.length),".ifnblank":([,...e])=>this.parseIf(!!e.length),".ifref":([e,...t])=>this.parseIf(this.env.referencedSymbol(Ye(t,e))),".ifnref":([e,...t])=>this.parseIf(!this.env.referencedSymbol(Ye(t,e))),".ifsym":([e,...t])=>this.parseIf(this.env.definedSymbol(Ye(t,e))),".ifnsym":([e,...t])=>this.parseIf(!this.env.definedSymbol(Ye(t,e))),".ifconst":([e,...t])=>this.parseIf(this.env.constantSymbol(Ye(t,e))),".ifnconst":([e,...t])=>this.parseIf(!this.env.constantSymbol(Ye(t,e))),".macro":e=>this.parseMacro(e),".repeat":e=>this.parseRepeat(e)};this.macros=i?i.macros:new Map}*pump(){let e=this.readLine();if(e==null)return void(yield e);for(;e.length;){let t=e[0];switch(t.token){case"ident":if(S.eq(e[1],S.COLON)){yield e.splice(0,2);break}this.tryExpandMacro(e)||(yield e);return;case"cs":this.tryRunDirective(e)||(yield e);return;case"op":if(/^[-+]+$/.test(t.str)){let i=[t],r=e[1];r&&S.eq(r,S.COLON)?(i.push(r),e.splice(0,2)):(i.push({token:"op",str:":"}),e.splice(0,1)),yield i;break}else if(t.str===":"){yield e.splice(0,1);break}default:throw new Error(`Unexpected: ${S.nameAt(e[0])}`)}}}readLine(){let e=this.stream.next();return e==null?e:this.expandLine(e)}expandLine(e,t=0){let i=e[0],r=0,o=0;for(;t<e.length;){if(t>o)o=t,r=0;else if(r++>hn)throw new Error(`Maximum expansion depth reached: ${e.map(S.name).join(" ")}${S.at(i)}`);t=this.expandToken(e,t)}return e}expandToken(e,t){let i=e[t];if(i.token==="ident"){let r=this.macros.get(i.str);if(r instanceof Ve){let o=r.expand(e,t);if(o)return o.length&&this.stream.unshift(...o),t}}else if(i.token==="cs")return this.expandDirective(i.str,e,t);return t+1}tryExpandMacro(e){let[t]=e;if(t.token!=="ident")throw new Error("impossible");let i=this.macros.get(t.str);if(!(i instanceof Xe))return!1;let r=i.expand(e,un(this.env));return this.stream.enter(),this.stream.unshift(...r),!0}expandDirective(e,t,i){switch(e){case".define":case".ifdef":case".ifndef":case".undefine":return this.skipIdentifier(t,i);case".skip":return this.skip(t,i);case".noexpand":return this.noexpand(t,i);case".tcount":return this.parseArgs(t,i,1,this.tcount);case".ident":return this.parseArgs(t,i,1,this.ident);case".string":return this.parseArgs(t,i,1,this.string);case".concat":return this.parseArgs(t,i,0,this.concat);case".sprintf":return this.parseArgs(t,i,0,this.sprintf);case".cond":return this.parseArgs(t,i,0,this.cond);case".def":case".defined":return this.parseArgs(t,i,1,this.defined);case".definedsymbol":return this.parseArgs(t,i,1,this.definedSymbol);case".constantsymbol":return this.parseArgs(t,i,1,this.constantSymbol);case".referencedsymbol":return this.parseArgs(t,i,1,this.referencedSymbol)}return i+1}skip(e,t){e.splice(t,1);let i=e[t];return i?.token==="grp"?this.expandToken(i.inner,0):this.expandToken(e,t+1),t}noexpand(e,t){let i=e[t+1];return i.token==="grp"?(e.splice(t,2,...i.inner),t+=i.inner.length-1):e.splice(t,1),t+1}parseArgs(e,t,i,r){let o=e[t];S.expect(S.LP,e[t+1],o);let a=S.findBalanced(e,t+1),l=S.parseArgList(e,t+2,a).map(d=>(d.length===1&&d[0].token==="grp"&&(d=d[0].inner),this.expandLine(d)));if(i&&l.length!==i)throw new Error(`Expected ${i} parameters: ${S.nameAt(o)}`);let c=r.call(this,o,...l);return e.splice(t,a+1-t,...c),t}tcount(e,t){return[{token:"num",num:S.count(t),source:e.source}]}ident(e,t){let i=S.expectString(t[0],e);return S.expectEol(t[1],"a single token"),[{token:"ident",str:i,source:t[0].source}]}string(e,t){let i=S.expectIdentifier(t[0],e);return S.expectEol(t[1],"a single token"),[{token:"str",str:i,source:t[0].source}]}concat(e,...t){return[{token:"str",str:t.map(r=>{let o=S.expectString(r[0]);return S.expectEol(r[1],"a single string"),o}).join(""),source:e.source}]}sprintf(e,t,...i){let r=S.expectString(t[0],e);S.expectEol(t[1],"a single format string");let[]=[r];throw new Error("unimplemented")}cond(e,...t){throw new Error("unimplemented")}defined(e,t){let i=S.expectIdentifier(t[0],e);return S.expectEol(t[1],"a single identifier"),[{token:"num",num:this.macros.has(i)?1:0}]}definedSymbol(e,t){let i=S.expectIdentifier(t[0],e);return S.expectEol(t[1],"a single identifier"),[{token:"num",num:this.env.definedSymbol(i)?1:0}]}constantSymbol(e,t){let i=S.expectIdentifier(t[0],e);return S.expectEol(t[1],"a single identifier"),[{token:"num",num:this.env.constantSymbol(i)?1:0}]}referencedSymbol(e,t){let i=S.expectIdentifier(t[0],e);return S.expectEol(t[1],"a single identifier"),[{token:"num",num:this.env.referencedSymbol(i)?1:0}]}skipIdentifier(e,t){return e[t+1]?.token==="ident"?t+2:t+1}tryRunDirective(e){let t=e[0];if(t.token!=="cs")throw new Error("impossible");let i=this.runDirectives[t.str];return i?(i(e),!0):!1}evaluateConst(e){if(e=mt.traversePost(e,mt.evaluate),e.op==="num"&&!e.meta?.rel)return e.num;let t=S.at(e);throw new Error(`Expected a constant${t}`)}parseDefine(e){let t=S.expectIdentifier(e[1],e[0]),i=Ve.from(e),r=this.macros.get(t);if(r instanceof Ve)r.append(i);else{if(r)throw new Error(`Already defined: ${t}`);this.macros.set(t,i)}}parseUndefine(e){let[t,i,r]=e,o=S.expectIdentifier(i,t);if(S.expectEol(r),!this.macros.has(o))throw new Error(`Not defined: ${S.nameAt(i)}`);this.macros.delete(o)}parseMacro(e){let t=S.expectIdentifier(e[1],e[0]),i=Xe.from(e,this.stream);if(this.macros.get(t))throw new Error(`Already defined: ${t}`);this.macros.set(t,i)}parseRepeat(e){let[t,i]=mt.parse(e,1),r=e[1]||e[0];if(!t)throw new Error(`Expected expression: ${S.nameAt(r)}`);let o=this.evaluateConst(t);if(o==null)throw new Error(`Expected a constant${S.at(t)}`);let a;if(i<e.length){if(!S.eq(e[i],S.COMMA))throw new Error(`Expected comma: ${S.nameAt(e[i])}`);a=S.expectIdentifier(e[i+1]),S.expectEol(e[i+2])}let l=[],c=1;for(;c>0;)e=this.stream.next()??pn(".repeat with no .endrep"),S.eq(e[0],S.REPEAT)&&c++,S.eq(e[0],S.ENDREPEAT)&&c--,S.eq(e[0],S.ENDREP)&&c--,l.push(e);this.repeats.push([l,o,-1,a]),this.parseEndRepeat(e)}parseEndRepeat(e){S.expectEol(e[1]);let t=this.repeats.pop();if(!t)throw new Error(`.endrep with no .repeat${S.at(e[0])}`);++t[2]>=t[1]||(this.repeats.push(t),this.stream.unshift(...t[0].map(i=>i.map(r=>{if(r.token!=="ident"||r.str!==t[3])return r;let o={token:"num",num:t[2]};return r.source&&(o.source=r.source),o}))))}parseIf(e){let t=1,i=!1,r=[];for(;t>0;){let o=this.stream.next();if(!o)throw new Error("EOF looking for .endif");let a=o[0];if(S.eq(a,S.ENDIF)){if(t--,!t)break}else if(a.token==="cs"&&a.str.startsWith(".if"))t++;else if(t===1&&!i){if(e&&(S.eq(a,S.ELSE)||S.eq(a,S.ELSEIF))){e=!1,i=!0;continue}else if(S.eq(a,S.ELSEIF)){e=!!this.evaluateConst(js(o.slice(1),a));continue}else if(S.eq(a,S.ELSE)){e=!0;continue}}e&&r.push(o)}this.stream.unshift(...r)}};function Ye(n,s){let e=js(n,s);return mt.identifier(e)}function js(n,s){if(!n.length)throw s?new Error(`Expected expression: ${S.nameAt(s)}`):new Error("Expected expression");return mt.parseOnly(n)}function mn(n){if(n)throw new Error(`garbage at end of line: ${S.nameAt(n)}`)}function Pt(n,s){throw new Error(`${S.name(s)} with no ${n}${S.at(s)}`)}function pn(n){throw new Error(n)}var xn=100,cs=class{constructor(){this.stack=[]}next(){for(;this.stack.length;){let[s,e]=this.stack[this.stack.length-1];if(e.length)return e.pop();let t=s?.next();if(t)return t;this.stack.pop()}}unshift(...s){if(!this.stack.length)throw new Error("Cannot unshift after EOF");let e=this.stack[this.stack.length-1][1];for(let t=s.length-1;t>=0;t--)e.push(s[t])}enter(s){let e=[void 0,[]];if(s&&(e[0]=s),this.stack.push(e),this.stack.length>xn)throw new Error("Stack overflow")}exit(){this.stack.pop()}};var be={of:(...n)=>{let s=0n;for(let e of n)s|=1n<<BigInt(e);return s},from:n=>{let s=0n;for(let e of n)s|=1n<<BigInt(e);return s},containsAll:(n,s)=>!(s&~n),with:(n,s)=>n|1n<<BigInt(s),without:(n,s)=>n&~(1n<<BigInt(s)),has:(n,s)=>!!(n&1n<<BigInt(s)),bits:n=>{let s=[],e=0;for(;n;){let t=Number(n&0xffffffffn),i=32;for(;t;){let r=Math.clz32(t)+1;i-=r,t<<=r,r===32&&(t=0),s.push(e|i)}n>>=32n,e+=32}return s},clone:n=>n,empty:n=>!n,difference:(n,s)=>n&~s};var fs=class{constructor(s){this.worlds=s;let e=new Set,t=new Set,i=new Map,r=new Map;for(let f=0;f<s.length;f++){let u=s[f],h=f<<24;for(let[p,m]of u.requirements){e.add(h|p);for(let b of m)for(let v of b)t.add(h|v)}for(let[p,m]of u.items)r.set(h|p,m);for(let[p,m]of u.slots)i.set(h|p,m)}this.itemInfos=new Map(r),this.slotInfos=new Map(i),this.progression=new Set(t);for(let f of r.keys())t.add(f);let o=new Set,a=new Set,l=new Set;for(let f of t)(e.has(f)?o:l).add(f);for(let f of e)t.has(f)||a.add(f);this.common=o.size,this.slots=new Fs([...o,...a]),this.items=new Fs([...o,...l]);let c=[],d=[];for(let f=0;f<s.length;f++){let u=f<<24;for(let[h,p]of s[f].requirements){let m=this.slots.index(u|h);if(m==null)throw new Error(`Provided a non-slot? ${V(h)}`);for(let b of p){let v=[...b].map(g=>this.items.index(u|g)??Re());(c[m]||(c[m]=[])).push(be.from(v));for(let g of v)(d[g]||(d[g]=new Set)).add(m)}}}for(let f=0;f<this.slots.length;f++)if(!c[f]||!c[f].length){let u=this.slots.get(f)??NaN,h=this.checkName(u);console.error(`Nothing provided $${V(u)}: ${h} (index ${f})`)}this.graph=new Ms(c),this.unlocks=new Ms(d.map(Wt))}async shuffle(s,e,t=200,i,r){i&&i.addTasks(Math.floor(t/10));for(let o=0;o<t;o++){i&&o%10===9&&(i.addCompleted(1),await new Promise(requestAnimationFrame));let a=new Gs;this.prefill(a,e);let l=this.compressFill(a),c=this.itemPool(l.values(),e),d=be.from(new Set(c)),f=Math.floor(o/5);if(!this.fillInternal(l,c,d,e,s,f))continue;let u=r?[]:void 0,h=this.traverse(m=>l.get(m),be.of(),u);if(h.size!==this.slots.length){let m=w=>`${String(w).padStart(3)} ${this.slots.get(w).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(w))}`,b=w=>`${String(w).padStart(3)} ${this.items.get(w).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(w))}`,v=new Set([...this.slots].map(w=>w[0]));for(let w of h)v.delete(w);let g=new Map;for(let w of v)g.set(m(w),this.graph.get(w).map(x=>`
    `+be.bits(x).map(b).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...g.keys()].sort().map(w=>w+g.get(w)).join(`
  `)}`);continue}this.expandFill(l,a);let p=this.fillNonProgression(a,s,e);if(p!=null){if(i&&i.addCompleted(Math.floor((t-o)/100)),r){for(let[m,b]of a){let v=this.checkName(m).replace(/^[0-9a-f]{3} /,"");r.addSlot(m,v,b)}if(u)for(let[m,...b]of u)(m<this.common||l.has(m))&&r.addCheck(this.slots.get(m),b.map(v=>this.items.get(v)))}return p}}return null}fillInternal(s,e,t,i,r,o){let a=new Set(s.keys());for(let l=e.pop();l!=null;l=e.pop()){if(!be.has(t,l))continue;let c=this.itemInfoFromIndex(l);t=be.without(t,l);let d=this.expandReachable(this.traverse(h=>s.get(h),t),r);i.shuffle(d);let f=!1,u=new Set(s.keys());for(let h of d){if(u.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!(!p||!this.fits(p,c,r))){s.set(h,l),f=!0;break}}if(!f){if(u.clear(),o-- >0){for(let h of d){if(u.has(h)||!s.has(h)||a.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!p||!this.fits(p,c,r))continue;let m=s.replace(h,l)??Re();t=be.with(t,m),e.push(m),i.shuffle(e),f=!0;break}if(f)continue}return!1}}return!0}expandReachable(s,e){let t=[];for(let i of s){let r=this.slotInfoFromIndex(i);!r||e.preserveUniqueChecks()&&!r.unique||Ui(t,i,r.weight||1)}return t}itemPool(s,e){let t=new Set(s),i=[];for(let[r,o]of this.itemInfos){let a=this.items.index(r);a!=null&&(!this.progression.has(r)||t.has(a)||Ui(i,a,o.weight||1))}return e.shuffle(i)}fits(s,e,t){if(t.preserveUniqueChecks()&&e.unique&&!s.unique)return!1;let i=e.preventLoss||s.preventLoss;return!(s.lossy&&e.losable&&i)}fillNonProgression(s,e,t){let i=[[],[],[]],r=[[],[]];for(let[c,d]of this.itemInfos){if(s.hasValue(c))continue;let f=2;d.losable&&d.preventLoss&&(f=1),e.preserveUniqueChecks()&&d.unique&&(f=0),i[f].push(c)}for(let[c,d]of this.slotInfos){if(s.has(c))continue;let f=d.lossy&&d.preventLoss?0:1;r[f].push(c)}for(let c of[...i,...r])t.shuffle(c);let o=c=>this.checkName(c),a=se.count(se.concat(...r)),l=se.count(se.concat(...i));if(l>a)throw console.log(`Slots ${a}:
  ${[...se.concat(...r)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...se.concat(...i)].map(o).join(`
  `)}`),new Error("Too many items");for(let c of se.concat(...i)){let d=!1;for(let f of[...r]){if(d)break;for(let u=0;u<f.length;u++)if(this.fits(this.slotInfos.get(f[u]),this.itemInfos.get(c),e)){s.set(f[u],c),d=!0,f.splice(u,1);break}}if(!d)return console.log(`Slots:
  ${[...se.concat(...r)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(c)}`),null}return new Map(s)}traverse(s,e,t){e=be.clone(e);let i=new Set,r=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}r.add(o)}for(let o of r){if(r.delete(o),i.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,c=a.length;l<c;l++){if(!be.containsAll(e,a[l]))continue;t&&t.push([o,...be.bits(a[l])]),i.add(o);let d=[];o<this.common&&d.push(o);let f=s(o);f!=null&&d.push(f);for(let u of d){e=be.with(e,u);for(let h of this.unlocks.get(u)||[]){if(this.graph.get(h)==null)throw console.dir(this),new Error(`Adding bad node ${h} from unlock ${u}`);r.add(h)}}break}}return i}expandFill(s,e){for(let[t,i]of s){let r=this.slots.get(t),o=this.items.get(i);if(r==null||o==null)throw new Error("missing");e.replace(r,o)}}compressFill(s){let e=new Gs;for(let[t,i]of s){let r=this.slots.index(t),o=this.items.index(i);if(r==null||o==null)throw new Error(`Bad slot/item: ${t} ${r} ${i} ${o}`);e.set(r,o)}return e}checkName(s){return this.worlds[s>>>24].checkName(s&16777215)}prefill(s,e){for(let t=0;t<this.worlds.length;t++){let i=t<<24,r=this.worlds[t].prefill(e);for(let[o,a]of r)s.set(i|o,i|a)}}itemInfoFromIndex(s){let e=this.items.get(s);if(e==null)throw new Error(`Bad item: ${s}`);return this.itemInfoFromId(e)}itemInfoFromId(s){let e=this.itemInfos.get(s);if(e==null)throw new Error(`Missing info: ${V(s)}`);return e}slotInfoFromIndex(s){let e=this.slots.get(s);if(e==null)throw new Error(`Bad slot: ${s}`);return this.slotInfoFromId(e)}slotInfoFromId(s){let e=this.slotInfos.get(s);if(e!=null)return e}};function Ui(n,s,e){for(let t=0;t<e;t++)n.push(s)}var hs=class{constructor(s,e,t,i=1){this.rom=s;this._width=t,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Re(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=te(i,()=>new Uint32Array(t*e)),this.data=this.layers[0];for(let r=0;r<256;r++)for(let o=0;o<4;o++){let a=gn[s.palettes[r].color(o)];this.palettes[r<<2|o]=a|4278190080}}useLayer(s){this.data=this.layers[s]||Re(`Bad layer: ${s}`)}resizeWidth(s,e){let t=new Uint32Array(e*this._height),i=Math.min(e,this._width);for(let r=0;r<this._height;r++)t.subarray(r*e,r+e+i).set(s.subarray(r*this._width,r*this._width+i));return t}resizeHeight(s,e){let t=new Uint32Array(this._width*e),i=this._width*Math.min(e,this._height);return t.subarray(0,i).set(s.subarray(0,i)),t}get width(){return this._width}set width(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],s);this._width=s,this.canvas.width=s}get height(){return this._height}set height(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],s);this._height=s,this.canvas.height=s}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(s){this.data.fill(s)}clear(s){let e=s!=null?this.palettes[s<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let t=1;t<this.layers.length;t++)this.layers[t].fill(0)}toDataUrl(s=!1){return this.canvas.toDataURL("image/png")}render(){let s=this.canvas,e=this.ctx;for(let t=0;t<this.layers.length;t++){t&&(s=document.createElement("canvas"),s.width=this.canvas.width,s.height=this.canvas.height,e=s.getContext("2d")||Re());let i=new Uint8Array(this.layers[t].buffer),r=e.getImageData(0,0,this._width,this._height);r.data.set(i),e.putImageData(r,0,0),t&&this.ctx.drawImage(s,0,0)}}rect(s,e,t,i,r){let o=Math.max(0,s),a=Math.max(0,e),l=Math.min(this._height,s+t),c=Math.min(this._width,e+i);for(s=o;s<l;s++)for(e=a;e<c;e++)this.data[s*this._width+e]=r}tile(s,e,t,i){if(e<0||s<0||e+8>=this._width||s+8>=this._height)return;let r=this.rom.patterns.get(t).flip(i<<6);for(let o=0;o<8;o++){let a=r.pixels[8|o]<<1,l=r.pixels[o];for(let c=7;c>=0;c--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(s+o)*this._width+e+c]=this.palettes[i&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,s),this._maxY=Math.max(this._maxY,s+8)}metatile(s,e,t,i,r=0){let o=this.rom.locations[i],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[r&7]);let l=[...o.tilePalettes,127],c=this.rom.tilesets[o.tileset],d=l[c.attrs[t]];for(let f=0;f<2;f++)for(let u=0;u<2;u++){let h=c.tiles[f<<1|u][t],p=a[h&128?1:0]<<6|h&127,m=e+(u<<3),b=s+(f<<3);this.tile(b,m,p,d<<2)}}metasprite(s,e,t,i,r=0,o=0){let a=this.rom.locations[i],l=this.rom.metasprites[t],c=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],f=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],f=!0),!l||!l.used)return;let u=o&l.frameMask;for(let[h,p,m,b]of l.sprites[u]){if(h==128)break;h=ji(h),p=ji(p),b=b+r&255;let v=c[b>>6],g=d[m&3]+176&255,w=v<<6|b&63;f&&(h=-8-h,m^=64),this.tile(s+p,e+h,w,g<<2|m>>6)}}text(s,e,t,i=18){for(let r=0;r<t.length;r++)this.tile(s,e+8*r,t.charCodeAt(r)|3840,i<<2)}},gn=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];function ji(n){return n<128?n:n-256}function W(n){return n}(e=>{function n({id:t},{x:i,y:r}){let o=i>>>8,a=i>>>4&15,l=r>>>8,c=r>>>4&15;return t<<16|l<<12|o<<8|c<<4|a}e.from=n;function s(t,i,r){let o=t;if(i){let a=(o&240)+(i<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(r){let a=(o&15)+r;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=s})(W||(W={}));var Ki=Symbol("[LocationMap data]"),Ze=class extends hs{constructor(e,t=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let i=e.locations[t];this.width=(i.used?i.width:1)*256,this.height=(i.used?i.height:1)*240,this.location=i;let r=o=>{let a=o.offsetX,l=o.offsetY,c=o.target;for(;c&&c!==this.element;)c=c.parentElement;if(!c)return;let d=a>>8,f=Math.floor(l/240),u=a-256*d>>4,h=l-240*f>>4,m=this.location.id<<16|f<<12|d<<8|h<<4|u;Ze.setData(o,{tile:m,target:this})};this.element.addEventListener("mousemove",r),this.element.addEventListener("mousedown",r),this.element.addEventListener("mouseup",r),this.element.addEventListener("click",r),this.redraw()}static getData(e){return e[Ki]}static setData(e,t){e[Ki]=t}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,t=(1-e)*50;this.element.style.transform=`translate(-${t}%,-${t}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,t,i){for(let r of e){if(r>>>16!==this.location.id)continue;let o=r>>>12&15,a=r>>>8&15,l=r>>>4&15,c=r&15,d=240*o+16*l,f=256*a+16*c;i!=null&&(this.useLayer(3),this.rect(d-1,f-1,18,18,0)),this.useLayer(1),e.has(W.add(r,-1,0))||this.rect(d-1,f-1,2,18,t),e.has(W.add(r,0,-1))||this.rect(d-1,f-1,18,2,t),e.has(W.add(r,1,0))||this.rect(d+15,f-1,2,18,t),e.has(W.add(r,0,1))||this.rect(d-1,f+15,18,2,t)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let t=0;t<this.location.width;t++){let i=this.location.screens[e][t];this.drawScreen(this.rom.screens[i],e,t)}this.useLayer(2);for(let e of this.location.spawns){let t=0,{x:i,y:r}=e;r-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;i+=8,r+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(t+=64),o!=null&&this.metasprite(r,i,o,this.location.id,t)}this.render()}drawScreen(e,t,i){let r=t*240,o=i*256,a=this.rom.tilesets[this.location.tileset],l,c=!1;for(let d of this.location.flags)if(d.xs===i&&d.ys===t){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(c=!0);break}for(let d=0;d<240;d+=16)for(let f=0;f<16;f++){let u=e.tiles[d|f];u<32&&(this.flags.has(l)||c)&&(u=a.alternates[u]),this.metatile(r+d,o+f*16,u,this.location.id,0)}}};var G;(d=>{function n(...f){return[[].concat(...f.map(([u])=>u))]}d.and=n;function s(...f){let u=[];for(let h of f){if(h===d.OPEN)return d.OPEN;h!==d.CLOSED&&u.push(...t(h))}return u.length?u:d.CLOSED}d.or=s;function e(f,u){if(f===d.OPEN)return t(u);if(u===d.OPEN)return t(f);if(f===d.CLOSED||u===d.CLOSED)return d.CLOSED;let h=new c;for(let p of f)for(let m of u)h.addList([...p,...m]);return t(h)}d.meet=e;function t(f){return f instanceof c?[...se.map(f,u=>[...u])]:f}d.freeze=t;function i(f){return f instanceof c?f.label():f.map(u=>u.join("&")).join("|")}d.label=i;function r(f){let u=f[Symbol.iterator](),{value:h,done:p}=u.next();if(p||!u.next().done)return!1;let m=h[Symbol.iterator]();return Boolean(m.next().done)}d.isOpen=r;function o(f){let u=f[Symbol.iterator]();return Boolean(u.next().done)}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class c{constructor(u){this.self=u;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(u,h){for(let p of h)if(Array.isArray(p))throw new Error;if(h.has(this.self)||this.map.has(u))return!1;for(let[p,m]of this.map){if(Vi(h,m))return!1;Vi(m,h)&&this.map.delete(p)}return this.map.set(u,h),!0}addRoute(u){return this.addInternal(u[us],u.deps)}addAll(u){for(let h of u)this.addList(h)}addList(u){let h=[...new Set(u)].sort(),p=new Set(h);this.addInternal(h.join("&"),p)}restrict(u){let h=[...this.map.values()];this.map.clear();for(let p of h)for(let m of u)this.addList([...p,...m])}label(){return[this.map.keys()].join("|")}}d.Builder=c})(G||(G={}));function Vi(n,s){if(n.size<s.size)return!1;for(let e of s)if(!n.has(e))return!1;return!0}var us=Symbol("depsLabel"),Fe=class{constructor(s,e){this.target=s;let t=[...new Set(e)].sort();this.deps=new Set(t),this[us]=t.join("&"),this.label=`${this.target}:${this[us]}`}};us;var ms=class{constructor(s){this.rom=s;this.tiles=new O(s=>bn(this.rom,s));this.bosses=new O(s=>new Vs(s));this.statues=new Map;this.flags=new O(s=>new O(e=>new O(t=>new Zs(s,e,t))));this.meets=new O(s=>new O(e=>new Js(s,e)));this._seamless=new O(s=>new Ks(s))}tile(s){return s&4?void 0:this.tiles.get(s)}boss(s,e){return e?this.rage||(this.rage=new Ys(s,this.rom.flags.RageSkip.id)):this.bosses.get(s)}statue(s){let e=G.label(s),t=this.statues.get(e);return t||this.statues.set(e,t=new Xs(s)),t}flag(s,e,t){return s||(s=wn),this.flags.get(s).get(e).get(t)}meet(s,e){return this.meets.get(s).get(e)}seamless(s){return this._seamless.get(s)}label(s,e){return s.label?s.label(e):"Terrain"}},z;(f=>{f.FLY=2,f.BLOCKED=4,f.SLOPE=32,f.PAIN=128,f.BITS=166,f.SWAMP=256,f.BARRIER=512,f.SLOPE8=1024,f.SLOPE9=2048,f.DOLPHIN=4096;function d(u,h){return u.label?.(h)??"Terrain"}f.label=d})(z||(z={}));var Ks=class{constructor(s){this._delegate=s;this.enter=s.enter,this.exit=s.exit}label(s){return`Seamless(${z.label(this._delegate,s)})`}},lt=class{constructor(s,e=G.OPEN){this.enter=s;this.exit=[[15,e]]}get kind(){return"Simple"}label(s){let e=[];return G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`),G.isOpen(this.exit[0][1])||e.push(`exit = ${we(this.exit[0][1],s)}`),`${this.kind}(${e.join(", ")})`}},ps=class{constructor(s,e,t=4){this.enter=s;this.exit=e?[[15&~t,e],[t,G.OPEN]]:[[15,G.OPEN]]}get kind(){return"South"}label(s){if(this.exit.length===1)return lt.prototype.label.call(this,s);let e=[];return G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`),G.isOpen(this.exit[0][1])||e.push(`other = ${we(this.exit[0][1],s)}`),G.isOpen(this.exit[1][1])||e.push(`south = ${we(this.exit[1][1],s)}`),`${this.kind}(${e.join(", ")})`}};function bn(n,s){let e=G.OPEN,t,i=4;return s&z.DOLPHIN&&s&z.FLY?(s&z.SLOPE&&(t=n.flags.ClimbWaterfall.r),e=[[n.flags.CurrentlyRidingDolphin.c],[n.flags.Flight.c]]):(s&z.SLOPE9?t=n.flags.ClimbSlope9.r:s&z.SLOPE8?t=n.flags.ClimbSlope8.r:s&z.SLOPE&&(t=n.flags.ClimbSlope10.r),s&z.FLY&&(e=n.flags.Flight.r)),s&z.SWAMP&&(e=e.map(r=>[n.flags.TravelSwamp.c,...r])),s&z.PAIN&&(e=e.map(r=>[n.flags.CrossPain.c,...r])),s&z.BARRIER&&(e=e.map(r=>[n.flags.ShootingStatue.c,...r]),t=n.flags.ShootingStatueSouth.r,i=1),new ps(e,t,i)}var Vs=class extends lt{constructor(e){super(G.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},Xs=class extends ps{constructor(e){super(G.OPEN,e);this._req=e}get kind(){return"Statue"}},Ys=class{constructor(s,e){this._rageFlag=s;this._rageSkipFlag=e;this.enter=G.OPEN;this.exit=[[11,[[s],[e]]],[4,G.OPEN]]}label(){return"Rage"}},Zs=class extends lt{constructor(s,e,t){if(s.exit.length!==1||t.exit.length!==1)throw console.error(s,t),new Error("bad flag");let i=[[e]],r=e>=0?G.meet(t.enter,i):t.enter,o=e>=0?G.meet(t.exit[0][1],i):t.exit[0][1];super(G.or(s.enter,r),G.or(s.exit[0][1],o))}get kind(){return"Flag"}},wn=new lt(G.CLOSED,G.CLOSED);function Xi(n){let s=[];for(let e=0;e<n.exit.length;e++)for(let t=0;t<4;t++)n.exit[e][0]&1<<t&&(s[t]=e);for(let e=0;e<4;e++)if(s[e]==null)throw new Error(`Bad terrain: ${n.exit.map(t=>t[0]).join(",")}`);return s}var Js=class{constructor(s,e){this.left=s;this.right=e;let t=Xi(s),i=Xi(e),r=new Set,o=[];for(let a=0;a<4;a++)r.add(t[a]<<2|i[a]);for(let a of r){let[l,c]=s.exit[a>>2],[d,f]=e.exit[a&3];o.push([l&d,G.meet(c,f)])}this.enter=G.meet(s.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(s){if(this.exit.length===1)return lt.prototype.label.call(this,s);let e=[];G.isOpen(this.enter)||e.push(`enter = ${we(this.enter,s)}`);for(let[t,i]of this.exit){let r=[t&1?"N":"",t&2?"W":"",t&4?"S":"",t&8?"E":""].join("");e.push(`exit${r} = ${we(i,s)}`)}return`${this.kind}(${e.join(", ")})`}};function we(n,s){let e=[...n],t=e.map(i=>se.isEmpty(i)?"open":[...i].map(r=>s.flags[r]?.debug).join(" & ")).join(") | (");return e.length>1?`(${t})`:e.length?t:"never"}z.debugLabel=we;typeof window=="object"&&(window.debugLabel=we);var xs=class{constructor(s,e){this.rom=s;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",t=>this.click(t)),this.element.addEventListener("mousemove",t=>this.move(t)),this.renderArea(0)}click(s){let e=Ze.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t!=null){if(t.area===this.area){let i=t.exit!=null?this.world.tiles.get(t.exit):null;i&&i.area!==this.area&&(t=i)}t.area&&t.area!==this.area&&this.renderArea(t.area.id)}}move(s){let e=Ze.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t==null)return;let i=t.exit!=null&&!this.area.tiles.has(t.exit);e.target.element.style.cursor=i?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(s){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let i of this.rom.locations){if(!i.used)continue;let r=this.world.locations[i.id]?.areas[Symbol.iterator]().next().value;if(r==null)continue;let o=document.createElement("option");o.textContent=`${V(i.id)} ${i.name}`,o.value=String(r.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[s];let t=document.createElement("pre");t.textContent=`Area ${s}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${z.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([i,r])=>`${i.debug}: ${we(r,this.rom)}`))].join(`
  `)}
Routes:
  ${we(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(t);for(let i of this.area.locations){let r=this.rom.locations[i],o=document.createElement("h2");o.textContent=r.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,r))}}makeLocation(s,e){let t=new Ze(this.rom,e.id);t.maxWidth=574,t.overlayShade(1426063360);for(let i of this.world.locations[e.id].areas)i!==s&&t.overlayArea(i.tiles,4294901760);return t.overlayArea(s.tiles,4278255615,0),t.render(),t.element}};var Lt;(o=>{function n(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=n;function s(){return[0,1,2,3]}o.all=s,o.North=0,o.West=1,o.South=2,o.East=3})(Lt||(Lt={}));var Ce;(i=>{function n(r,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let c of[-16,0]){let d=a+c;for(let f of[-16,0]){let u=l+f;yield W.from(r,{x:d,y:u})}}}}}i.trigger=n;function s(r,...o){let a=new Set,l=[...r];for(let[c,d]of o)for(let f of l)a.add(W.add(f,c,d));return a}i.adjust=s;function e(r){let o=[];for(let a=0;a<240;a++)o.push(r&-256|a);return o}i.screen=e;function t(r,...o){let a=new Set,l=[...r];for(let c of o)for(let d of l)a.add(d&65535|c.id<<16);return a}i.atLocation=t})(Ce||(Ce={}));function dt(n){return n}(e=>{e.from=(t,i)=>typeof t=="number"||!i?Number(t)>>>8:t.id<<8|i.y>>>8<<4|i.x>>>8;function s(t){return t>>>8}e.fromTile=s})(dt||(dt={}));function he(n){return n}(e=>{function n(t,i){return t*(1<<24)+i}e.of=n;function s(t){return[Math.floor(t/(1<<24)),t%(1<<24)]}e.split=s})(he||(he={}));var[]=[V],gs=class{constructor(s,e,t=!1){this.rom=s;this.flagset=e;this.tracker=t;this.terrainFactory=new ms(this.rom);this.terrains=new Map;this.checks=new O(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new O(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new xe;this.neighbors=new O(()=>0);this.routes=new O(()=>new G.Builder);this.routeEdges=new O(()=>new It);this.requirementMap=new O(s=>new G.Builder(s));this.limeTreeEntranceLocation=-1;for(let i of s.items)for(let r of i.itemUseData)r.kind==="expect"?this.itemUses.get(r.want).push([i,r]):r.kind==="location"&&this.itemUses.get(~r.want).push([i,r]);this.aliases=new Map([[s.flags.ChangeAkahana,s.flags.Change],[s.flags.ChangeSoldier,s.flags.Change],[s.flags.ChangeStom,s.flags.Change],[s.flags.ChangeWoman,s.flags.Change],[s.flags.ParalyzedKensuInDanceHall,s.flags.Paralysis],[s.flags.ParalyzedKensuInTavern,s.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let i of s.locations)this.processLocation(i);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:s,MezameShrine:e,Oak:t,Shyron_ToolShop:i},flags:{AbleToRideDolphin:r,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:c,Barrier:d,BlizzardBracelet:f,BowOfMoon:u,BowOfSun:h,BreakStone:p,BreakIce:m,BreakIron:b,BrokenStatue:v,BuyHealing:g,BuyWarp:w,ClimbWaterfall:x,ClimbSlope8:T,ClimbSlope9:E,ClimbSlope10:F,CrossPain:y,CurrentlyRidingDolphin:M,Flight:L,FlameBracelet:K,FormBridge:Y,GasMask:J,GlowingLamp:oe,InjuredDolphin:U,LeadingChild:fe,LeatherBoots:D,Money:P,OpenedCrypt:Ae,RabbitBoots:Pe,Refresh:q,RepairedStatue:pe,RescuedChild:de,ShellFlute:qe,ShieldRing:ht,ShootingStatue:Se,ShootingStatueSouth:Le,StormBracelet:ie,Sword:Cs,SwordOfFire:St,SwordOfThunder:kt,SwordOfWater:ut,SwordOfWind:vt,TornadoBracelet:Ts,TravelSwamp:st,TriggerSkip:B,WildWarp:Es},items:{MedicalHerb:$e,WarpBoots:Ct}}=this.rom,A=this.entrance(e),re=this.entrance(t);this.addCheck([A],Je(u,h),[Ae.id]),this.addCheck([A],Je(r,qe),[M.id]),this.addCheck([re],Je(fe),[de.id]),this.addItemCheck([A],Je(oe,v),pe.id,{lossy:!0,unique:!0});for(let Ie of this.rom.shops){if(Ie.location===s.id||Ie.location===i.id||!Ie.used||Ie.type!==1)continue;let _t=[Ie.location<<16|136];for(let Nt of Ie.contents)Nt===$e.id?this.addCheck(_t,P.r,[g.id]):Nt===Ct.id&&this.addCheck(_t,P.r,[w.id])}let ae=vt.r,He=St.r,Tt=ut.r,Et=kt.r;if(!this.flagset.orbsOptional()){let Ie=Ne(c,Ts),_t=Ne(o,K),Nt=Ne(l,f),Or=Ne(a,ie);if(ae=G.meet(ae,Ie),He=G.meet(He,_t),Tt=G.meet(Tt,Nt),Et=G.meet(Et,Or),this.flagset.assumeSwordChargeGlitch()){let Ot=function(xi){return Wr.map(Is=>Is[0]===xi.c?Is:[xi.c,...Is])},Wr=G.or(ae,He,Tt,Et);ae=Ot(vt),He=Ot(St),Tt=Ot(ut),Et=Ot(kt)}}this.addCheck([A],ae,[p.id]),this.addCheck([A],He,[m.id]),this.addCheck([A],Tt,[Y.id]),this.addCheck([A],Et,[b.id]),this.addCheck([A],Ne(vt,St,ut,kt),[Cs.id]),this.addCheck([A],L.r,[x.id,F.id]),this.addCheck([A],Ne(L,Pe),[T.id]),this.addCheck([A],Ne(L,Pe),[E.id]),this.addCheck([A],d.r,[Se.id,Le.id]),this.addCheck([A],J.r,[st.id]);let Nr=this.flagset.changeGasMaskToHazmatSuit()?J:D;if(this.addCheck([A],Ne(L,Pe,Nr),[y.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([A],D.r,[T.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([A],Je(M,Pe),[x.id]),this.flagset.fogLampNotRequired()){let Ie=this.flagset.requireHealedDolphinToRide();this.addCheck([A],Ie?U.r:[[]],[r.id])}this.flagset.guaranteeBarrier()||this.addCheck([A],[[P.c,g.c],[P.c,ht.c],[P.c,q.c]],[Se.id,Le.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([A],[[P.c,L.c]],[Se.id]),this.flagset.guaranteeGasMask()||this.addCheck([A],[[P.c,g.c],[P.c,q.c]],[st.id,y.id]),this.flagset.assumeWildWarp()&&this.addCheck([A],G.OPEN,[Es.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([A],G.OPEN,[B.id]),this.addCheck([A],B.r,[y.id,T.id,E.id]))}addExtraRoutes(){let{flags:{BuyWarp:s,SwordOfThunder:e,Teleport:t,WildWarp:i},locations:{MezameShrine:r}}=this.rom;if(this.addRoute(new Fe(this.entrance(r),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new Fe(this.entrance(o[0],o[1]&31),[e.c,s.c])),this.addRoute(new Fe(this.entrance(o[0],o[1]&31),[e.c,t.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Re("bad entrance");for(let c of l.enter)this.addRoute(new Fe(a,[i.c,...c]))}}consolidateChecks(){for(let[s,e]of this.checks){let t=this.tiles.find(s);if(s!==t){for(let i of e)this.checks.get(t).add(i);this.checks.delete(s)}}}buildRequirementMap(){for(let[e,t]of this.checks)for(let{checks:i,requirement:r}of t)for(let o of i){let a=this.requirementMap.get(o);for(let l of r)for(let c of this.routes.get(e)||[])a.addList([...l,...c])}if(!Yi)return;let s=[];for(let[e,t]of this.requirementMap){let i=r=>this.rom.flags[r].name;for(let r of t)s.push(`${i(e)}: ${[...r].map(i).join(" & ")}
`)}s.sort((e,t)=>e<t?-1:e>t?1:0),console.log(s.join(""))}getLocationList(s="Crystalis"){let e=Yi?t=>t.debug:t=>t.name;return{worldName:s,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:t=>e(this.rom.flags[t]),prefill:t=>{let{Crystalis:i,MesiaInTower:r,LeafElder:o}=this.rom.flags,a=new Map([[r.id,i.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|t.nextInt(4)),a}}}processLocation(s){!s.used||(this.processLocationTiles(s),this.processLocationSpawns(s),this.processLocationItemUses(s))}unionNeighbors(){for(let[s,e]of this.terrains){let t=W.add(s,0,1);this.terrains.get(t)===e&&this.tiles.union([s,t]);let i=W.add(s,1,0);this.terrains.get(i)===e&&this.tiles.union([s,i])}}addAllRoutes(){this.addExtraRoutes();for(let[s,e]of this.neighbors){let[t,i]=he.split(s),r=this.terrains.get(t),o=this.terrains.get(i);if(!r||!o)throw new Error(`missing terrain ${V(r?t:i)}`);for(let[a,l]of r.exit)if(!!(a&e))for(let c of l)for(let d of o.enter)this.addRoute(new Fe(i,[...c,...d]),t)}if(typeof document=="object"){let s=document.getElementById("debug");s&&s.appendChild(new xs(this.rom,this.getWorldData()).element)}}getWorldData(){let s=0,e=new O(()=>({})),t=te(256,()=>({areas:new Set,tiles:new Set})),i=[];for(let r of this.tiles.sets()){let o=this.tiles.find(se.first(r)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?G.freeze(this.routes.get(o)):[];if(!l.length)continue;let c={checks:[],id:s++,locations:new Set,routes:l,terrain:a,tiles:new Set};i.push(c);for(let d of r){let f=d>>>16;c.locations.add(f),c.tiles.add(d),t[f].areas.add(c),t[f].tiles.add(d),e.get(d).area=c}}for(let[r,o]of this.exits)e.has(r)&&(e.get(r).exit=o);for(let[r,o]of this.checks){let a=e.get(r).area;if(!!a)for(let{checks:l,requirement:c}of o)for(let d of l){let f=this.rom.flags[d]||Re();a.checks.push([f,c])}}return{tiles:e,areas:i,locations:t}}addRoute(s,e){if(e!=null){this.routeEdges.get(e).add(s);for(let a of this.routes.get(e))this.addRoute(new Fe(s.target,[...a,...s.deps]));return}let t=new It,i=new It,r=s;t.add(r);let o=t[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;i.add(a),t.delete(a);let c=new It,d=a.target;if(this.routes.get(d).addRoute(a))for(let u of this.routeEdges.get(d))c.add(new Fe(u.target,[...a.deps,...u.deps]));for(let u of c)i.has(u)||(t.delete(u),t.add(u))}}recordExits(){for(let[s,e]of this.exits)this.exitSet.add(he.of(this.tiles.find(s),this.tiles.find(e)));for(let s of this.exitSet){let[e,t]=he.split(s);if(this.terrains.get(e)!==this.terrains.get(t))continue;let i=he.of(t,e);this.exitSet.has(i)&&(this.tiles.union([e,t]),this.exitSet.delete(s),this.exitSet.delete(i))}}buildNeighbors(){for(let[s,e]of this.terrains){if(!e)continue;let t=W.add(s,1,0),i=this.terrains.get(t);i&&i!==e&&this.handleAdjacentNeighbors(s,t,Lt.North);let r=W.add(s,0,1),o=this.terrains.get(r);o&&o!==e&&this.handleAdjacentNeighbors(s,r,Lt.West)}for(let s of this.exitSet){let[e,t]=he.split(s);if(!this.terrains.has(e)||!this.terrains.has(t))continue;let i=he.of(this.tiles.find(e),this.tiles.find(t));this.neighbors.set(i,this.neighbors.get(i)|1)}}handleAdjacentNeighbors(s,e,t){let i=this.tiles.find(s),r=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=he.of(r,i);this.neighbors.set(o,this.neighbors.get(o)|1<<t)}if(!this.seamlessExits.has(s)){let o=t^2,a=he.of(i,r);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(s){let e=new Map,t=new Set,i=(s.id&248)===88;for(let c of s.spawns)if(c.isWall())e.set(dt.from(s,c),c.id&3);else if(c.isMonster()&&c.id===63){let d=dt.from(s,c)<<8|c.yt<<4;for(let f=4;f<=11;f++)for(let u=-3;u<=3;u++)t.add(W.add(d,u,f))}let r=this.rom.tilesets[s.tileset],o=this.rom.tileEffects[s.tileEffects-179],a=c=>{let d=s.screens[(c&61440)>>>12][(c&3840)>>>8];return o.effects[this.rom.screens[d].tiles[c&255]]},l=(c,d,f)=>{if(c&=z.BITS,s.id===26&&(c|=z.SWAMP),(s.id===96||s.id===104)&&(c|=z.DOLPHIN),s.id===100&&(d&61680)<4144&&(c|=z.DOLPHIN),f&&(c|=z.BARRIER),!(c&z.DOLPHIN)&&c&z.SLOPE){let u=d,h=0;for(;a(u)&z.SLOPE;)u=W.add(u,1,0),h++;h<6?c&=~z.SLOPE:h<9?c|=z.SLOPE8:h<10&&(c|=z.SLOPE9)}if(c&z.PAIN){for(let u of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a(W.add(d,...u))&(z.PAIN|z.FLY))){c&=~z.PAIN;break}}return this.terrainFactory.tile(c)};for(let c=0,d=s.height;c<d;c++){let f=s.screens[c],u=s.id<<8|c<<4;for(let h=0,p=s.width;h<p;h++){let m=this.rom.screens[f[h]],b=u|h,v=b&255,g=e.get(b),w=i?this.rom.flags.AlwaysTrue.id:g!=null?this.wallCapability(g):s.flags.find(E=>E.screen===v)?.flag,x=s.pits.find(E=>E.fromScreen===b);x&&this.exits.set(b<<8|136,x.toScreen<<8|136);let T=this.rom.flags[w]?.logic??{};for(let E=0;E<240;E++){let F=b<<8|E,y=m.tiles[E];T.assumeTrue&&y<32&&(y=r.alternates[y]);let M=s.isShop()?0:o.effects[y],L=t.has(F),K=l(M,F,L);if(y<32&&r.alternates[y]!==y&&w!=null&&!T.assumeTrue&&!T.assumeFalse){let Y=l(o.effects[r.alternates[y]],F,L);Y&&(K=this.terrainFactory.flag(K,T.track?w:-1,Y))}K&&this.terrains.set(F,K)}}}for(let c of s.exits){let{dest:d,entrance:f}=c,u=W.from(s,c),h;if(c.isSeamless()){h=u&65535|d<<16;let p=W.from(s,c);this.seamlessExits.add(p);let m=this.terrains.get(p);m&&this.terrains.set(p,this.terrainFactory.seamless(m))}else h=this.entrance(this.rom.locations[d],f&31);this.exits.set(u,h),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[f].y>160&&(this.limeTreeEntranceLocation=s.id)}}processLocationSpawns(s){for(let e of s.spawns)e.isTrigger()?this.processTrigger(s,e):e.isNpc()?this.processNpc(s,e):e.isBoss()?this.processBoss(s,e):e.isChest()?this.processChest(s,e):e.isMonster()?this.processMonster(s,e):e.type===3&&e.id===224&&this.processKeyUse(Ce.screen(W.from(s,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(s,e){let t=this.rom.trigger(e.id);if(!t)throw new Error(`Missing trigger ${e.id.toString(16)}`);let i=this.filterRequirements(t.conditions),r=this.filterAntiRequirements(t.conditions),o=W.from(s,e),a=Ce.trigger(s,e),l=[];for(let c of t.flags){let d=this.flag(c);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,i,l),t.message.action){case 25:t.id===134&&!this.flagset.assumeRabbitSkip()?a=Ce.adjust(a,[0,-1],[0,1]):t.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=Ce.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(r=G.or(r,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(r));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,i);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,i,t.id);break;case 24:{let c=this.flagset.chargeShotsOnly()?G.meet(i,Je(this.rom.flags.WarpBoots)):i;this.addItemCheck(a,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,i,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,s,i);break;case 27:s===this.rom.locations.Portoa_PalaceEntrance&&(a=Ce.adjust(a,[-2,0]),r=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,s,r);break}for(let[c,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([W.from(s,e)],G.OPEN,c,d)}processNpc(s,e){let t=this.rom.npcs[e.id];if(!t||!t.used)throw new Error(`Unknown npc: ${V(e.id)}`);let i=t.spawnConditions.get(s.id)||[],r=this.filterRequirements(i),o=W.from(s,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,f]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,r,d,f);if(t===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,r),t.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(i),t===this.rom.npcs.Rage?(a=Ce.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=Ce.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):t===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=G.or(this.rom.flags.MesiaRecording.r,Je(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):t===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(t===this.rom.npcs.FortuneTeller&&(a=Ce.adjust(a,[0,0],[2,0])),G.isClosed(r))return;let[[...l]]=r;for(let d of t.globalDialogs){let f=this.flag(~d.condition),u=this.flag(d.condition);if(f?.logic.assumeFalse||u?.logic.assumeTrue)return;f?.logic.track&&l.push(f.id)}let c=t.localDialogs.get(s.id)??t.localDialogs.get(-1)??[];for(let d of c){let f=[...l],u=this.flag(d.condition),h=this.flag(~d.condition);if(u?.logic.track&&f.push(u.id),!u?.logic.assumeFalse&&!h?.logic.assumeTrue&&this.processDialog(a,t,f,d),u?.logic.assumeTrue||h?.logic.assumeFalse)break;h?.logic.track&&l.push(h.id)}}processDialog(s,e,t,i){this.addCheckFromFlags(s,[t],i.flags);let r={lossy:!0,unique:!0};switch(i.message.action){case 8:this.processKeyUse(s,[t]);break;case 20:this.addItemCheck(s,[t],this.rom.flags.SlimedKensu.id,r);break;case 16:this.addItemCheck(s,[t],this.rom.flags.AsinaInBackRoom.id,r);break;case 17:this.addItemCheck(s,[t],256|e.data[1],r);break;case 3:case 10:this.addItemCheck(s,[t],256|e.data[0],r);break;case 9:let o=e.data[1];o!==255&&this.addItemCheck(s,[t],256|o,r);break;case 25:this.addItemCheck(s,[t],this.rom.flags.AkahanaFluteOfLimeTradein.id,r);break;case 26:this.addItemCheck(s,[t],this.rom.flags.Rage.id,r);break;case 27:break}}processLocationItemUses(s){for(let[e,t]of this.itemUses.get(~s.id))this.processItemUse([this.entrance(s)],G.OPEN,e,t)}handleMovingGuard(s,e,t){if(this.flagset.assumeStatueGlitch())return;let i=[];for(let r of e.spawns.slice(0,2))if(r.isNpc()&&this.rom.npcs[r.id].isParalyzable()){i.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&i.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(s,this.terrainFactory.statue([...t,...i].map(Wt)))}handleBoat(s,e,t){let i=this.walkableNeighbor(s);if(i==null)throw new Error("Could not find walkable neighbor.");let r=s>>8&240|s>>4&15,o=s>>4&240|s&15,a;for(let u of e.exits)u.yt===r&&u.xt<o&&(a=u);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let c=l.entrances[a.entrance],d=W.from(l,c),f=d;for(;;){f=W.add(f,0,-1);let u=this.walkableNeighbor(f);if(u!=null){let h={enter:G.freeze(t),exit:[[15,G.OPEN]]};this.addTerrain([i],h),this.exits.set(i,u),this.exitSet.add(he.of(i,u)),this.exits.set(d,u),this.exitSet.add(he.of(d,u)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(s,e,t){let i=this.itemGrant(t),r=256|i;if(i==null)throw new Error(`missing item grant for ${t.toString(16)}`);let o=t>=128;this.addItemCheck(s,e,r,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(s,e){for(let t of s){let i=this.terrains.get(t);i!=null&&this.terrains.set(t,this.terrainFactory.meet(i,e))}}addCheck(s,e,t){if(G.isClosed(e))return;let i={requirement:G.freeze(e),checks:t};for(let r of s)!this.terrains.has(r)||this.checks.get(r).add(i)}addItemCheck(s,e,t,i){this.addCheck(s,e,[t]),this.slots.set(t,i);let r=this.rom.itemGets[this.rom.slots[t&255]],o=this.rom.items[r.itemId],a=o?.unique,l=r.isLosable(),c=a||o===this.rom.items.OpelStatue,d=1;o===this.rom.items.SwordOfWind&&(d=5),o===this.rom.items.SwordOfFire&&(d=5),o===this.rom.items.SwordOfWater&&(d=10),o===this.rom.items.SwordOfThunder&&(d=15),o===this.rom.items.Flight&&(d=15),this.items.set(512|r.id,{unique:a,losable:l,preventLoss:c,weight:d})}addCheckFromFlags(s,e,t){let i=[];for(let r of t){let o=this.flag(r);o?.logic.track&&i.push(o.id)}i.length&&this.addCheck(s,e,i)}walkableNeighbor(s){if(this.isWalkable(s))return s;for(let e of[-1,1]){let t=W.add(s,e,0),i=W.add(s,0,e);if(this.isWalkable(t))return t;if(this.isWalkable(i))return i}}isWalkable(s){return!(this.getEffects(s)&z.BITS)}ensurePassable(s){return this.isWalkable(s)?s:this.walkableNeighbor(s)??s}getEffects(s){let e=this.rom.locations[s>>>16],t=this.rom.tileEffects[e.tileEffects-179].effects,i=e.screens[(s&61440)>>>12][(s&3840)>>>8];return t[this.rom.screens[i].tiles[s&255]]}processBoss(s,e){if(e.id===201||e.id===202)return;let t=e.id===195,i=t?this.rom.bosses.Rage:this.rom.bosses.fromLocation(s.id),r=W.from(s,e);if(!i||!i.flag)throw new Error(`Bad boss at ${s.name}`);let o=r&-256,a=this.terrainFactory.boss(i.flag.id,t),l=te(240,c=>o|c);this.addTerrain(l,a),this.addBossCheck(l,i)}addBossCheck(s,e,t=G.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let i=G.meet(t,this.bossRequirements(e));e===this.rom.bosses.Draygon2?this.addCheck(s,i,[e.flag.id]):this.addItemCheck(s,i,e.flag.id,{lossy:!1,unique:!0})}processChest(s,e){if(this.rom.slots[e.id]>=112)return;let t=256|e.id,i=this.rom.slots[e.id];if(i>=112)return;let r=this.rom.items[i],o=this.flagset.preserveUniqueChecks()?!!r?.unique:!0;this.addItemCheck([W.from(s,e)],G.OPEN,t,{lossy:!1,unique:o})}processMonster(s,e){let t=this.rom.objects[e.monsterId];if(!(t instanceof Ue))return;let{Money:i,RageSkip:r,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:c,SwordOfThunder:d}=this.rom.flags;if(s.id===this.limeTreeEntranceLocation&&t.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(s)],G.OPEN,[r.id]),!t.goldDrop)return;let f=[W.from(s,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(f,o.r,[i.id]);return}let u=[a,l,c,d].filter((h,p)=>t.elements&1<<p);this.addCheck(f,Ne(...u),[i.id])}processItemUse(s,e,t,i){s=new Set([...s].map(a=>this.walkableNeighbor(a)??a));let r=[[512|t.id]];t.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&r[0].push(this.rom.flags.Change.c),t===this.rom.items.MedicalHerb&&(r[0][0]=this.rom.flags.BuyHealing.c);let o=G.meet(e,r);switch(this.addCheckFromFlags(s,o,i.flags),i.message.action){case 16:this.processKeyUse(s,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(s,o,t.id);break;case 2:this.addItemCheck(s,o,256|this.rom.npcs[i.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(s,e){let[t,...i]=new Set([...s].map(a=>dt.from(a)));if(t==null||i.length)throw new Error("Expected one screen");let o=this.rom.locations[t>>>8].flags.find(a=>a.screen===(t&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(s,e,[o.flag])}bossRequirements(s){if(s===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=s.object,t=new G.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())t.addAll(this.rom.flags.Sword.r);else{let r=this.flagset.guaranteeSwordMagic()?s.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&t.addAll(this.swordRequirement(a,r))}let i=[];if(s.npc!=null&&s.location!=null){let r=s.npc.spawns(this.rom.locations[s.location]);i.push(...this.filterRequirements(r)[0])}return s===this.rom.bosses.Insect?i.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):s===this.rom.bosses.Draygon2&&i.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&i.push(this.rom.flags.Refresh.c),t.restrict([i]),G.freeze(t)}swordRequirement(s,e){let t=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][s];if(e===1)return t.r;let i=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][s];return e===3?Je(t,...i):i.map(r=>[t.c,r.c])}itemGrant(s){for(let[e,t]of this.rom.itemGets.actionGrants)if(e===s)return t;throw new Error(`Could not find item grant ${s.toString(16)}`)}filterRequirements(s){let e=[];for(let t of s)if(t<0){if(this.flag(~t)?.logic?.assumeTrue)return G.CLOSED}else{let i=this.flag(t);if(i?.logic.assumeFalse)return G.CLOSED;i?.logic.track&&e.push(i.id)}return[e]}filterAntiRequirements(s){let e=[];for(let t of s)if(t>=0){if(this.flag(~t)?.logic?.assumeFalse)return G.OPEN}else{let i=this.flag(~t);if(i?.logic.assumeTrue)return G.OPEN;i?.logic.track&&e.push([i.id])}return e}flag(s){let e=s,t=this.rom.flags[e];return this.aliases.get(t)??t}entrance(s,e=0){return typeof s=="number"&&(s=this.rom.locations[s]),this.tiles.find(W.from(s,s.entrances[e]))}wallCapability(s){switch(s){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${s}`)}}};function Je(...n){return[n.map(s=>s.id)]}function Ne(...n){return n.map(s=>[s.id])}var Yi=!1;function Ji(n){if(!n.compressedMapData){n.compressedMapData=!0;for(let s=0;s<3;s++)n.metascreens.renumber(256|s,320|s),delete n.screens[256|s]}}function Qi(n){if(!n.compressedMapData)throw new Error("Must compress first");let{grass:s,town:e,cave:t,dolphinCave:i,pyramid:r,river:o,sea:a,lime:l,mountain:c,shrine:d,desert:f,mountainRiver:u,swamp:h,house:p,fortress:m,labyrinth:b,iceCave:v,tower:g}=n.metatilesets;n.moveScreens([h],4),n.moveScreens([p],4),n.moveScreens([e],4),n.moveScreens([l],4),n.moveScreens([d],4),n.moveScreens([g],4),n.moveScreens([c,u],4),n.moveScreens([t,r,m,b,v],5);let[]=[a,i,s,o,f]}var[]=[qt];function er(n,s){let o=n.objects[159],a=n.objects[127],l=n.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((f,u)=>l.data[u]=f),l.data[3]=a.data[3];let c=new Set([127-80,141-80]),d=new Set([126-80,159-80]);for(let f of n.locations){if(!f.pits.length)continue;let u=s.nextInt(3)<1;for(let h of f.spawns)!h.isMonster()||(d.has(h.id)&&(h.id=(u?159:126)-80),c.has(h.id)&&(h.id=(u?141:127)-80))}}var[]=[V];function Te(n,s,...e){let t=s,i=0,r;for(;(r=e[i++])!=null;)if(typeof r=="number")n[t++]=r;else if(typeof r=="string")for(let o of r)n[t++]=o.charCodeAt(0);else throw new Error("bad data")}function tr(n){n[107924]=255,n[118213]=168,n[106870]=255,n[108620]=255,n[120899]=160,n[122987]&=7,n[122991]&=7,n[122995]&=7,n[122999]&=7,n[123003]&=7,n[123012]&=7,n[123035]&=7,n[123065]&=7,n[123141]=47,n[123511]=0,n[123750]=64,n[123761]=0,n[123783]=0,n[123793]=0,Te(n,106856,51,51),Te(n,107662,51,51),n[105393]=112,n[105397]=113,n[105079]=114,n[105963]=115,n[106565]=116,n[106721]=117,n[106725]=118,n[106729]=119,n[108037]=120,n[107457]=121,n[107461]=122,n[107465]=123,Te(n,123063,192,0),Te(n,123690,192,0),Te(n,123696,192,0),Te(n,123702,192,0),Te(n,123104,192,0),Te(n,123110,192,0),n[116739]=0,Te(n,116749,162,179),n[109190]=254,Te(n,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(let s of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])n[s]|=1;Te(n,157038,"Simea",16,0,"     ",16,0)}function sr(n,s){Vn(n),Tn(n),vn(n),Cn(n),En(n,s),ro(n),no(n),io(n),Rn(n),Mn(n),Pn(n),In(n),qn(n),Ln(n),Qn(n,s),Zn(n),s.requireHealedDolphinToRide()&&_n(n),s.saharaRabbitsRequireTelepathy()&&Nn(n),zn(n,s),Bn(n,s),Dn(n),s.teleportOnThunderSword()?(On(n),n.townWarp.thunderSwordWarp=[n.locations.Shyron.id,65]):Wn(n),Gn(n),s.fogLampNotRequired()&&An(n,s),Xn(n),Yn(n),$n(n),Hn(n,s),s.disableRabbitSkip()&&Un(n),s.disableFlightStatueSkip()&&jn(n),Jn(n,s),Fn(n),s.chargeShotsOnly()&&eo(n),s.orbsOptional()&&to(n),s.noBowMode()&&so(n),Kn(n),s.hardcoreMode()&&oo(n),s.shouldUpdateHud()&&(kn(n),n.writeMonsterNames=!0),s.shouldColorSwordElements()&&Sn(n),s.hasStatTracking()&&yn(n)}function yn(n){for(let x=0;x<4;x++)n.patterns.set(5376,41+x,ke.BLANK_TILES[x]);if(n.prg[143082]===40)return;n.prg[143082]=40;let t=143364,i=144132,r=128-1;for(let x=t;x<i;x++)n.prg[x]>=41&&n.prg[x]<=45&&(n.prg[x]+=r);let o=42,a=160;for(let x=t;x<i;x+=192)n.prg[x+a]=o;let l=new Map([[66,a]]),c=142469,d=142546;for(let x=c;x<d;x++)l.has(n.prg[x])&&(n.prg[x]=l.get(n.prg[x]));for(let x=t;x<i;x+=192)for(let T=123;T<=127;T++)n.prg[x+T]==o+r&&(n.prg[x+T]=o);let f=3,u=2,h=144376,p=144440;for(let x=h;x<p;x++){let T=n.prg[x];for(let E=0;E<8;E+=2){let F=f<<E,y=u<<E;(T&F)==F&&(T=T&(255^3<<E)|y)}n.prg[x]=T}let m=144440,b=4*f,v=[15,48,15,17];for(let x=0;x<v.length;x++)n.prg[m+b+x]=v[x];n.prg[m+u*4+3]=8;let g=145114,w=145222;for(let x=g;x<w;x+=4)n.prg[x]+=128}function Sn(n){function s(e,t){for(let i=0;i<=10;i++){if(i===8)continue;let r=n.patterns.get(i|e),o=[...r.pixels];for(let a=0;a<r.pixels.length;a++)r.pixels[a]=o[a^8],a>>>3===t&&(r.pixels[a]|=o[a])}}s(4240),s(4304),s(4368),s(4432),s(4496)}function kn(n){n.patterns.set(3584,0,ke.HUD_LF),n.patterns.set(3584,1,ke.HUD_PW),n.patterns.set(3584,2,ke.HUD_EY),n.patterns.set(3584,3,ke.HUD_LV),n.patterns.set(3584,4,ke.HUD_DL),n.patterns.set(3584,5,ke.HUD_MP),n.patterns.set(3584,6,ke.HUD_EX),n.patterns.set(3584,26,ke.HUD_CLOSE_LEFT),n.patterns.set(3584,27,ke.HUD_CLOSE_RIGHT)}function vn(n){n.items.GlowingLamp.itemUseData[0].message.action=11}function Cn(n){let s=n.nextFreeTrigger("mezame");s.used=!0,s.conditions=[~n.flags.AlwaysTrue.id],s.message=Rt.of({action:4}),s.flags=[n.flags.AlwaysTrue.id],n.locations.MezameShrine.spawns.push($.of({tile:136,type:2,id:s.id}))}function Tn(n){let s=new Set([129,139,144,153,166,167,168,169,170,171,172,n.allocatedTriggers.get("zombie warp")]);for(let e of n.locations)!e.used||(e.spawns=e.spawns.filter(t=>!t.isTrigger()||!s.has(t.id)))}function En(n,s){if(n.objects[16].atk=3,n.objects[17].atk=6,n.objects[18].atk=8,n.objects[24].atk=3,n.objects[19].atk=5,n.objects[25].atk=5,n.objects[23].atk=7,n.objects[26].atk=7,n.objects[20].atk=3,n.objects[21].atk=6,n.objects[22].atk=8,n.objects[28].atk=3,n.objects[29].atk=3,n.objects[30].atk=5,n.objects[27].atk=7,n.objects[31].atk=7,s.slowDownTornado()){let e=n.objects[18];e.speed=7,e.data[12]=96}}function In(n){let s=n.trigger(160);s.used=!0,s.conditions=[],s.flags=[],s.message=Rt.of({part:0,index:0,action:21}),n.objects[94].data[13]=254,n.items.InsectFlute.itemUseData[0].flags=[n.flags.UsedInsectFlute.id]}function Rn(n){n.items.OpelStatue.selectedItemValue=0}function Mn(n){for(let s of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])n.patterns.set(s<<6,e,n.patterns.get(94<<6,e).pixels);n.objects[12].metasprite=169}function Fn(n){for(let s in[4,5,8,9])n.tileEffects[188-179].effects[s]=24,n.tileEffects[181-179].effects[s]=24}function Gn(n){let{tiles:s}=n.screens[161];s[40]=159,s[55]=35,s[56]=35,s[57]=33,s[71]=141,s[72]=143,s[86]=153,s[87]=154,s[88]=140}function An(n,s){let{flags:{AlwaysTrue:e,InjuredDolphin:t,FogLamp:i,KensuInCabin:r,ReturnedFogLamp:o},items:{ShellFlute:a},locations:{BoatHouse:l,Portoa_FishermanHouse:c},npcs:d}=n,f=s.requireHealedDolphinToRide();a.itemUseData[0].want=f?t.id:e.id,d.KensuInCabin.data[0]=103,d.KensuInCabin.localDialogs.get(-1)[0].message.action=10,d.KensuInCabin.localDialogs.get(-1)[0].flags=[],d.KensuInCabin.spawnConditions.set(l.id,[o.id,~r.id]),d.Fisherman.spawnConditions.set(c.id,[i.id]),n.itemGets[100].flags=[],n.itemGets[103].copyFrom(n.itemGets[100])}function Pn(n){for(let s of n.locations)for(let e of s.spawns)e.isChest()&&(e.timed=!1)}function Ln(n){let s=n.locations;s.GoaFortress_Kelbesque.spawns[0].x-=16,s.GoaFortress_Zebu.spawns.splice(1,1),s.GoaFortress_Tornel.spawns.splice(2,1),s.GoaFortress_Asina.spawns.splice(2,1),s.GoaFortress_Kensu.spawns.splice(3,1),s.GoaFortress_Kensu.spawns.splice(1,1)}function Bn(n,s){let{items:{AlarmFlute:e},flags:{TalkedToZebuStudent:t,ZebuStudent:i},locations:{MezameShrine:r,Leaf_StudentHouse:o,WaterfallCave4:a,ZebuCave:l},npcs:{WindmillGuard:c,Zebu:d}}=n;if(n.itemGets[49].inventoryRowStart=32,e.unique=!0,e.basePrice=0,s.zebuStudentGivesItem())c.data[1]=49;else{c.data[1]=255;let h=c.dialog(o)[0];h.condition=~t.id,h.flags.push(t.id),ir(d.spawns(l),i.id,t.id),r.spawns.push($.of({screen:0,tile:155,type:2,id:49})),r.spawns.push($.of({screen:0,tile:149,type:2,id:73})),n.itemGets[73].itemId=n.items.MedicalHerb.id}let f=[[33,.72],[31,.9]],u=0;for(let h of n.shops)if(h.type===1)for(let p=0,m=h.contents.length;p<m;p++){if(h.contents[p]!==49)continue;let[b,v]=f[u++%f.length];h.contents[p]=b,n.shopDataTablesAddress&&(h.prices[p]=Math.round(h.prices[p]*v))}n.itemGets[91].itemId=29,a.spawn(25).id=16}function Dn(n){let{flags:{Karmine:s,Mado1:e},npcs:{Brokahana:t}}=n,i=wi(t.localDialogs.get(-1))[0];if(i.condition!==~s.id)throw new Error(`Bad brokahana condition: ${i.condition}`);i.condition=~e.id}function _n(n){let{flags:{InjuredDolphin:s,ShellFlute:e},npcs:{Fisherman:t,FishermanDaughter:i}}=n;t.spawnConditions.set(214,[e.id,s.id]);let r=i.localDialogs.get(-1);r.unshift(r[0].clone()),r[0].condition=~s.id,r[1].condition=~e.id}function Nn(n){let{flags:{Telepathy:s},npcs:{Deo:e,SaharaBunny:t}}=n;t.globalDialogs.push(Ls.of(~s.id,[26,18])),e.globalDialogs.push(Ls.of(~s.id,[26,19]))}function On(n){let{flags:{WarpShyron:s}}=n;n.itemGets[3].flags.push(s.id)}function Wn(n){n.itemGets[3].acquisitionAction.action=22}function zn(n,s){if(s.leatherBootsGiveSpeed()){let e=n.items[47];if(e.menuName="Speed Boots",e.messageName="Speed Boots",s.changeGasMaskToHazmatSuit()){let t=n.items[41];t.menuName="Hazmat Suit",t.messageName="Hazmat Suit"}}for(let e=5;e<12;e+=2)n.items[e].menuName=n.items[e].menuName.replace("Ball","Orb"),n.items[e].messageName=n.items[e].messageName.replace("Ball","Orb")}function qn(n){let{flags:{BallOfWind:s,TornadoBracelet:e},npcs:{Tornel:t}}=n,i=t.localDialogs.get(33),r=[i[0],i[2],i[2].clone(),i[1]];r[1].condition=~e.id,r[2].condition=~s.id,r[3].condition=-1,t.localDialogs.set(33,r)}function $n(n){let{CordelPlainEast:s,KirisaMeadow:e,UndergroundChannel:t}=n.locations;for(let i of[s,e,t])for(let r of i.spawns)r.isChest()&&(r.data[2]|=32)}function Hn(n,s){let{CordelPlainEast:e,CordelPlainWest:t}=n.locations;for(let i of e.spawns)(i.isChest()||s.disableTeleportSkip()&&i.isTrigger())&&t.spawns.push(i.clone())}function Un(n){for(let s of n.locations.MtSabreNorth_Main.spawns)s.isTrigger()&&s.id===134&&s.x===1856&&(s.x+=16,s.y+=16)}function jn(n){let s=n.hitboxes[n.objects.guardianStatueMissile.hitbox],e=n.hitboxes[6];n.objects.guardianStatueMissile.hitbox=e.id,e.x0=s.x0-6,e.w=s.w+12,e.y0=s.y0-2,e.h=s.h+4}function Kn(n){n.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function Vn(n){let{flags:{WarpZombie:s},locations:{ZombieTown:e}}=n;n.flags.insertZombieWarpFlag();let t=n.messages.parts[33][0];t.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let i=n.nextFreeTrigger("zombie warp");i.used=!0,i.conditions=[],i.message=Rt.of({}),i.flags=[s.id];for(let r of e.spawns)r.isTrigger()&&r.id===138&&(r.id=i.id);if(n.townWarp.locations.splice(7,0,e.id),n.townWarp.locations.pop()!==255)throw new Error("unexpected")}function Xn(n){n.trigger(138).conditions=[~n.flags.CurrentlyRidingDolphin.id],n.messages.parts[29][16].text=`The cave entrance appears
to be underwater. You'll
need to swim.`}function Yn(n){let s=n.nextFreeTrigger("channel item");s.used=!0,s.conditions=[n.flags.CurrentlyRidingDolphin.id,~n.flags.UndergroundChannelUnderwaterChest.id];let e=n.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",s.message=Rt.of({part:e.part,index:e.id,action:15});let t=n.locations.UndergroundChannel.spawns.find(i=>i.isChest());t.data[2]=2,t.yt++,t.id=s.id,n.itemGets.actionGrants.set(s.id,59)}function Zn(n){let e=n.npcs[13].localDialogs.get(53)[0];e.message.action=23}function Jn(n,s){let e=n.locations.LimeTreeLake,t=n.screens[n.metascreens.limeTreeLake.sid];if(s.disableRageSkip()){t.set2d(32,t.get2d(0,143)),t.set2d(42,t.get2d(58,1)),t.set2d(16,t.get2d(32,4)),t.set2d(26,t.get2d(42,5)),t.set2d(27,t.get2d(0,16));for(let r of e.spawns)r.tile+=32;let i=n.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(r=>r+32)}else t.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function Qn(n,s){function e(A,re){let ae=A.indexOf(re);if(ae<0)throw new Error(`Could not find element ${re} in ${A}`);A.splice(ae,1)}function t(A,re){let ae=A.findIndex(re);if(ae<0)throw new Error(`Could not find element in ${A}`);A.splice(ae,1)}let{locations:{BoatHouse:i,Brynmaer:r,Crypt_Draygon2:o,Joel_Shed:a,Leaf_ElderHouse:l,MtSabreNorth_SummitCave:c,MtSabreWest_Upper:d,PortoaPalace_ThroneRoom:f,Portoa_PalaceEntrance:u,Portoa_AsinaRoom:h,Portoa_FortuneTeller:p,Shyron_Temple:m,StomHouse:b,Swan_DanceHall:v,Swan_Tavern:g,WindmillCave:w,WaterfallCave4:x,WaterfallValleyNorth:T,ZebuCave:E,ZombieTown_HouseBasement:F},items:{GlowingLamp:y,KeyToPrison:M,LovePendant:L,StatueOfOnyx:K},npcs:{Akahana:Y,AkahanaInBrynmaer:J,Asina:oe,AztecaInShyron:U,Clark:fe,Draygon:D,FortuneTeller:P,Kensu:Ae,KensuInCabin:Pe,KensuInSwan:q,LeafElder:pe,LeafRabbit:de,OakChild:qe,OakElder:ht,OakMother:Se,PortoaPalaceFrontGuard:Le,PortoaQueen:ie,PortoaThroneRoomBackDoorGuard:Cs,Rage:St,Stom:kt,StonedAkahana:ut,Tornel:vt,WindmillGuard:Ts,Zebu:st},flags:B}=n;Ae.localDialogs.delete(g.id),q.link(Ae.id),q.used=!0,q.data=[...Ae.data],Ae.data[0]=y.id,v.spawns.find(A=>A.isNpc()&&A.id===Ae.id).id=q.id,L.itemUseData[0].want=256|q.id,ut.linkDialog(Y.id),J.used=!0,J.link(Y.id),J.data=[...Y.data],r.spawns.find(A=>A.isNpc()&&A.id===Y.id).id=J.id,K.itemUseData[0].want=256|J.id,pe.dialog(l).splice(0,0,...pe.dialog(l).splice(2,1)),de.dialog()[2].condition=B.RescuedLeafElder.id,de.dialog()[2].flags.push(B.TalkedToLeafRabbit.id),de.dialog()[3].flags.push(B.TalkedToLeafRabbit.id),Ts.spawns(w)[1]=~B.WindmillGuardAlarmFluteTradein.id,e(Y.spawns(x),~B.BehindWhirlpool.id),e(ut.spawns(x),~B.BehindWhirlpool.id);function Es(A){A.reverse();for(let re=0;re<A.length;re++){let ae=A[re+1];A[re].condition=ae?~ae.condition:-1}}for(let A=0;A<4;A++){let re=ht.dialog()[A];re.condition!==n.flags.OakElder.id&&(re.message.action=3)}(()=>{let[A,re,ae,He]=Se.dialog();He.condition=~B.RescuedChild.id,re.condition=-1,Se.dialog().splice(0,4,He,ae,A,re)})();for(let A of[32,33,34,124,125])Es(n.npcs[A].dialog());qe.dialog().unshift(...qe.dialog().splice(1,1)),Cs.spawnConditions.set(f.id,[~B.QueenNotInThroneRoom.id,~B.MesiaRecording.id]),Le.dialog()[1].condition=B.MesiaRecording.id,ie.dialog()[3].condition=B.SwordOfWater.id,ie.dialog()[3].message.action=3,ie.dialog()[4].flags.push(B.PortoaQueenGoingAway.id),ie.spawns(f)[1]=~B.MesiaRecording.id,ie.spawns(h)[0]=B.MesiaRecording.id,ie.dialog()[1].condition=B.MesiaRecording.id,P.spawns(p)[1]=~B.MesiaRecording.id,fe.spawnConditions.set(F.id,[~B.Clark.id]),fe.spawnConditions.set(a.id,[B.Clark.id]),st.localDialogs.set(E.id,[Be.of(~B.TalkedToZebuInCave.id,[0,26],[B.TalkedToZebuInCave.id]),Be.of(B.LeafVillagersRescued.id,[0,29]),Be.of(B.LeafAbduction.id,[0,28]),Be.of(B.ZebuAtWindmill.id,[0,29]),Be.of(B.UsedWindmillKey.id,[0,27,3]),Be.of(-1,[0,29])]),e(st.spawns(E),~B.BehindWhirlpool.id),vt.spawnConditions.delete(d.id),kt.spawnConditions.delete(b.id),e(oe.spawns(h),~B.CalmedAngrySea.id);let $e=n.npcs[52];$e.spawnConditions.set(f.id,[B.MesiaRecording.id,~B.PortoaQueen.id]),$e.localDialogs.set(u.id,$e.localDialogs.get(-1)),$e.data[0]=n.items.FluteOfLime.id;let Ct=n.messages.alloc();Ct.text="The queen left this for you.",$e.localDialogs.set(f.id,[Be.of(~B.PortoaQueen.id,[Ct.part,Ct.id,3]),Be.of(-1,[10,14])]),f.spawns.push($.of({yt:3,xt:12,type:1,patternBank:1,id:$e.id})),ie.localDialogs.set(h.id,ie.dialog().splice(0,2)),ie.localDialogs.set(f.id,ie.dialog()),ie.localDialogs.delete(-1),Pe.spawnConditions.set(i.id,[~B.AbleToRideDolphin.id,B.ReturnedFogLamp.id]),Pe.dialog()[0].message.action=2,U.spawns(m).push(~B.ShyronMassacre.id),n.trigger(130).conditions.push(~B.ShyronMassacre.id),St.dialog()[0].condition=B.SwordOfWater.id,D.spawnConditions.set(o.id,[~B.Draygon2.id]),st.dialog(m).unshift(...st.dialog(m).splice(1,1)),n.trigger(128).conditions=[~B.ShyronMassacre.id,B.TalkedToZebuInShyron.id,B.SwordOfThunder.id],n.trigger(129).conditions=[],s.barrierRequiresCalmSea()&&n.trigger(132).conditions.push(B.CalmedAngrySea.id),n.trigger(140).conditions.push(B.TalkedToZebuInCave.id),n.trigger(141).used=!1;for(let A of c.spawns)A.isTrigger()&&A.id===141&&(A.id=178);t(T.spawns,A=>A.isTrigger()&&A.id===141),n.trigger(178).conditions.push(B.Kelbesque1.id),n.trigger(178).flags.push(~B.LeafVillagersCurrentlyAbducted.id,~B.LeafElderCurrentlyAbducted.id,B.LeafVillagersRescued.id),n.trigger(140).conditions.push(~B.Kelbesque1.id),n.trigger(134).conditions.push(~B.Kelbesque1.id),e(M.itemUseData[0].flags,~B.LeafVillagersCurrentlyAbducted.id),ir(n.trigger(187).conditions,~B.Rage.id,~B.MesiaRecording.id)}function eo(n){for(let s of[8,9,39])n.objects[s].collisionPlane=0;n.npcs.Brokahana.data[0]=n.items.FruitOfLime.id}function to(n){for(let s of[16,20,24,29])n.objects[s].terrainSusceptibility&=-5,n.objects[s].level=2}function so(n){let{flags:{UsedBowOfTruth:s},locations:{Crypt_Draygon2:e,MezameShrine:t}}=n,i;for(let r of t.spawns)r.isTrigger()&&r.tile===136&&(i=n.trigger(r.id));if(!i)throw new Error("Could not find start trigger");i.flags.push(s.id),n.tileEffects[185-179].effects[88]=0,t.meta.setExit(0,"door",[e.meta.id<<8|16,"edge:bottom"])}function io(n){n.objects[51].elements=15}function ro(n){n.tileEffects[181-179].effects[116]=6,n.tileEffects[182-179].effects[70]=6}function no(n){for(let s of n.objects)s instanceof Ue&&(s.isProjectile()||s.isBoss()||s.isFlyer()||s!==n.objects.mimic&&(s.terrainSusceptibility|=3))}function ir(n,s,e){for(let t=0;t<n.length;t++)if(n[t]===s){n[t]=e;return}throw new Error(`Could not find ${s} in ${n.join(",")}`)}function oo(n){for(let s of n.locations)s.checkpoint=s.saveable=!1}function rr(n,s,e){if(!s.randomizeTrades())return;let{items:{StatueOfOnyx:t,FogLamp:i,LovePendant:r,KirisaPlant:o,IvoryStatue:a},locations:{Swan_DanceHall:l,PortoaPalace_ThroneRoom:c},npcs:{KensuInSwan:d}}=n,f=new Map,u=[[t,0,"Akahana"],[i,0,"Fisherman"],[r,0,"Kensu"],[o,0,"Aryllis"],[a,0,"Slimed Kensu"]],h=u.map(([b,v,g])=>{if(b.trades.indexOf(v)<0||v>=b.itemUseData.length)throw new Error(`not a trade: ${b} ${v}`);return[b.itemUseData[v],b.id,g]});e.shuffle(h);for(let[b,v]of u){let[g,w,x]=h.pop();b.itemUseData[v]=g,n.spoiler&&n.spoiler.addTrade(b.id,b.messageName,x),g.want===356&&s.fogLampNotRequired()&&([...n.npcs[100].spawnConditions.values()][0][0]=512|b.id),f.set(w,b.id)}n.itemGets.actionGrants=new Map([...n.itemGets.actionGrants].map(([b,v])=>[f.get(b)??b,v]));let p=n.items[e.nextInt(4)];n.npcs[195].localDialogs.get(-1)[0].condition=512|p.id,n.spoiler&&n.spoiler.addTrade(p.id,p.messageName,"Rage"),n.npcs.PortoaQueen.dialog(c)[1].condition=512|p.id;let m=n.items[e.nextInt(4)*2+6];for(let b of n.npcs[95].localDialogs.values())for(let v=2;v<b.length;v++)if(b[v].message.action===3){b[v-2].condition=~(512|m.id-1),b[v-1].condition=~(512|m.id),n.spoiler&&n.spoiler.addTrade(m.id,m.messageName,"Tornel");break}d.dialog(l)[0].message.mid="13:00"}function nr(n){let s=new Map;for(let e of n.items)for(let t of e.trades)s.set(e.itemUseData[t].want&255,e.id);return s}function ar(n){let{flags:{AkahanaStatueOfOnyxTradein:s,AsinaInBackRoom:e,BehindWhirlpool:t,KensuInSwan:i,MtSabreNorthSummit:r,MtSabreWestTornel:o,PortoaQueen:a,Rage:l,RepairedStatue:c,SlimedKensu:d,StomFightReward:f,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:h},npcs:{AkahanaInBrynmaer:p,Aryllis:m,Fisherman:b,PortoaQueen:v},locations:{PortoaPalace_ThroneRoom:g}}=n;P("03:06",",","");let w=nr(n);function x(q){let pe=w.get(q.id);if(!pe)throw new Error(`No trade-in for ${q.name}`);return n.items[pe]}h.item.isMagic()||fe("00:1b"),P("00:1b","[41:Refresh]",D(h.item));let T=x(p);P("02:01","an unusual statue",or(T)),P("02:02","a statue",`the ${bs(T)}`),P("02:02","[29:Gas Mask]",D(s)),f.item.isMagic()||fe("03:01"),P("03:01","[43:Telepathy]",D(f));let E=co(n);P("03:01","[06:Tornado Bracelet]",D(E)),P("05:0a","[06:Tornado Bracelet]",D(E)),P("05:0a","[44:Teleport]",D(o));let F=x(b);P("09:01","[35:Fog Lamp]",D(F)),P("09:04","[35:Fog Lamp]",D(F)),P("09:05","[35:Fog Lamp]",D(F)),P("09:06","lamp",bs(F));let y=v.dialog(g)[1].condition;P("0a:0c","[28:Flute of Lime]",D(a)),P("0a:0d","[02:Sword of Water]",D(y)),e.item.isMagic()||fe("0b:01"),P("0b:01","[45:Recover]",D(e)),t.item.isMagic()||(fe("0b:01"),fe("1d:12")),P("0b:01","[46:Barrier]",D(t)),P("1d:12","[46:Barrier]",D(t));let M=Ae(79,78,77,76,71,70,69,68,75,74,73,72);M?P("0d:00","[35:Fog Lamp]",D(M)):P("0d:00","that a [35:Fog Lamp] was","there was treasure");let L=n.npcs.Rage.dialog()[0].condition;P("0e:03","[02:Sword of Water]",D(L)),P("0e:03","[09:Ball of Water]",D(l)),P("10:0c","that's","is"),P("10:0c",/, is in the\+lighthouse/,"");let K=x(m);P("12:05","[3c:Kirisa Plant]",D(K)),P("12:10","the plant",`the ${bs(K)}`),P("12:10","[3c:Kirisa Plant]",D(K));let Y=`Our illustrious chief seeks ${or(K)}.`;P("12:09",/[^]*/,Y),P("12:0a",/[^]*/,Y);let J=x(n.npcs.KensuInSwan);P("13:02","[3b:Love Pendant]",D(J)),P("13:00","pendant",bs(J)),i.item.isMagic()||fe("13:02"),P("13:02","[47:Change]",D(i));let oe=x(n.npcs.SlimedKensu);P("18:06","[3d:Ivory Statue]",D(oe)),P("18:07","[3d:Ivory Statue]",D(oe)),P("18:06","It's in a room","{0b:Karmine} is"),d.item.isMagic()||P("18:07","teach","give"),P("18:07","[48:Flight]",D(d)),r.item.isMagic()||fe("1c:10"),P("1c:10","[42:Paralysis]",D(r)),P("20:06","Statue of Gold",D(c));let U=n.allocatedTriggers.get("channel item");U!=null&&P(n.trigger(U).message.mid,"[3b:Love Pendant]",D(u));{let q=n.messages.alloc();n.trigger(134).message.mid=q.mid,q.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",n.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function fe(q){P(q,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function D(q){return typeof q=="number"?q=n.items[n.itemGets[q&255].itemId]:q instanceof Ci||(q=q.item),`[${V(q.id)}:${q.messageName}]`}function P(q,pe,de){let[qe,ht]=q.split(":").map(Le=>parseInt(Le,16)),Se=n.messages.parts[qe][ht];Se.text=Se.text.replace(pe,de)}function Ae(...q){let pe=[de=>ao.has(de),de=>lo.has(de),de=>Pe(de).unique];for(let de of pe)for(let qe of q){let Se=[...n.locations[qe].spawns].reverse();for(let Le of Se){if(!Le.isChest())continue;let ie=n.slots[Le.id];if(ie<=72&&de(ie))return n.items[ie]}}}function Pe(q){let pe=n.itemGets[q];return n.items[pe.itemId]}}var ao=new Set([62,63,64]),lo=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function co(n){let{Tornel:s}=n.npcs;for(let e of s.localDialogs.values())for(let t=2;t<e.length;t++){let i=~e[t].condition;if(i>516&&i<=524&&!(i&1))return n.items[i&255]}return n.items.TornadoBracelet}function or(n){let s=n.rom.items;switch(n){case s.StatueOfOnyx:return"an unusual statue";case s.FluteOfLime:return"a rare instrument";case s.FogLamp:return"a brilliant lamp";case s.LovePendant:return"a beautiful charm";case s.KirisaPlant:return"a fragrant plant";case s.IvoryStatue:return"an exotic statue"}return Ps(),"a valuable item"}function bs(n){let s=n.rom.items;switch(n){case s.StatueOfOnyx:return"statue";case s.FluteOfLime:return"instrument";case s.FogLamp:return"lamp";case s.LovePendant:return"pendant";case s.KirisaPlant:return"plant";case s.IvoryStatue:return"statue"}return Ps(),"item"}function dr(n){let{locations:{Portoa:s,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:t,UndergroundChannel:i,WaterfallCave2:r,WaterfallCave3:o}}=n;Qs(t,"edge:bottom",183,s),Qs(e,"door",146,i),Qs(r,"stair:up",191,o),ho(n)}function Qs(n,s,e,t){let[i,...r]=[...n.meta.exits()].filter(([,b])=>b===s);if(!i)throw new Error(`Could not find ${s} in ${n}`);if(r.length)throw new Error(`Ambiguous ${s} in ${n}`);let[o,a]=i[2],l=o>>>8;if(l===t.id)return;let c=o&255,d=n.rom.locations[l],u=d.meta.get(c).data.exits.find(b=>b.type===a);if(!u)throw new Error(`Bad entrance in ${d}`);let h=((u.entrance&61440)>>>8|(u.entrance&240)>>>4)+fo[u.dir];d.spawns.length>17&&d.spawns.pop();let p=t.spawns.findIndex(b=>b.isTrigger()&&b.id===e),m=p>=0?t.spawns.splice(p,1)[0]:$.of({type:2,id:e});m.xt=(c&15)<<4|h&15,m.yt=c&240|h>>>4,d.spawns.push(m)}var fo=[16,0,0,0];function ho(n){let{locations:{MtSabreNorth_Main:s,ValleyOfWind:e}}=n;for(let t of lr(e,17)){let i=n.locations[t>>>8],r=t&255;ws(i,r,n.flags.OpenedSealedCave)}for(let t of lr(s,4)){let i=n.locations[t>>>8];if(i.data.fixed||i.spawns.length>15)continue;let r=t&255;ws(i,r,n.flags.OpenedPrison);let o=i.meta.get(r).findExitByType("cave").entrance,a=$.of({screen:r,coord:o,type:2,id:173});if(i.spawns.push(a),i.spawns.length>15)continue;let l=$.of({screen:r,coord:o-4112,type:4,id:44});i.spawns.splice(1,0,l)}}function lr(n,s){let e=new Set([n,n.id<<8|s]),t=new Set;for(let r of n.meta.exits())r[0]===s&&(r[1]==="cave"||r[1]==="gate")&&t.add(r[2]);let i=[];for(let r of t){if(e.has(r[0]))continue;let o=n.rom.locations[r[0]>>>8],a=r[0]&255;if(!o.meta.customFlags.has(a)){if(r[1]==="cave"||r[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?i.push(r[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||t.add(l[2])}}}return console.log(`From ${n}: ${i.map(r=>r.toString(16))}`),i}function ws(n,s,e,t){e?n.meta.customFlags.set(s,e):n.meta.customFlags.delete(s),!t&&(n===n.rom.locations.CordelPlainEast?ws(n.rom.locations.CordelPlainWest,s,e,!0):n===n.rom.locations.CordelPlainWest&&ws(n.rom.locations.CordelPlainEast,s,e,!0))}function cr(n){uo(n)}function uo(n){let{locations:{AngrySea:s},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:t,beachCave:i,beachExitN:r,boatChannel:o}}=n;e.spawnScripts=[];let a=new Set(te(16,l=>l));for(let l=0;l<s.entrances.length;l++){let c=s.entrances[l],d=s.meta.get(c.screen),f;if(d===o){if(s.meta.get(c.screen-1)!==t)throw new Error(`Bad boatChannel entrance ${c}`);c=it.of({screen:c.screen-1,tile:0}),d=t}d===t?f={entrance:it.of({screen:c.screen-17,coord:47336}),movement:5}:d===i?f={entrance:it.of({screen:c.screen,coord:59400}),movement:8}:d===r&&(f={entrance:it.of({screen:c.screen,coord:55544}),movement:9}),f&&(a.delete(l),e.spawnScripts[l]=f)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:it.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:it.of({x:424,y:120}),movement:7}}function hr(n){let s=new Set;for(let e of n.locations)for(let t of e.pits??[])s.add(t.dest<<8|t.toScreen);for(let e of s){let t=n.locations[e>>8],i=e&255,r=t.exits.filter(d=>d.screen===i),o=t.entrances.filter(d=>d.screen===i),a=new Map(r.map(d=>[d.tile,d])),l=new xe;for(let d of a.keys())for(let f of fr)a.has(d+f)&&l.union([d,d+f]);let c=l.map();for(let d of o)for(let f of fr){let u=c.get(d.tile+f);for(let h of u??[]){let p=a.get(h),m=ki.of({screen:e&255,tile:h+f,dest:p.dest,entrance:p.entrance});t.exits.push(m)}}}}var fr=[1,-1,16,-16];function ur(n,s){let e=[...n.townWarp.locations].filter(l=>l!==255),t=s.nextInt(e.length),i=e[t],r=64;(i===n.locations.Shyron.id||i===n.locations.Shyron_Temple.id)&&(r=65),n.townWarp.thunderSwordWarp=[i,r];let o=768-e.length+t,a=n.itemGets[3].flags;for(let l=0;l<a.length;l++)if(a[l]===765){a[l]=o;return}a.push(o)}function mr(n,s,e){let t=new Set(te(256,o=>o).filter(o=>o in n.objects));for(let[o]of ct)t.delete(o);for(let[o,a]of ct)for(let l of t)n.objects[o].base===n.objects[l].base&&(ct.set(l,a),t.delete(o));for(let o of[200,249,250])n.objects[o].attackType=o>240?254:255,n.objects[o].statusEffect=0;n.objects[125].elements|=8;let i=new Set([87,94,104,125,136,151,155,158]),r=new Set([80,83,95,105]);for(let[o,{sdef:a,swrd:l,hits:c,satk:d,dgld:f,sexp:u}]of ct){let h=n.objects[o].data,p=i.has(o)?1:0;if(h[2]|=128,h[6]=c,h[7]=d,h[8]=a|l<<4,h[16]=h[16]&15|f<<4,h[17]=u,(p?s.shuffleBossElements():s.shuffleMonsterElements())&&!r.has(o)){let m=[...n.objects[o].elements.toString(2).padStart(4,"0")];e.shuffle(m),n.objects[o].elements=Number.parseInt(m.join(""),2)}}if(s.shuffleMonsterElements()){let o=e.nextInt(4);for(let a of r)n.objects[a].elements=1<<o}}var ct=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([n,s,e,t=0,i=0,r=0,o=0,a=0,l=0])=>[n,{id:n,type:s,name:e,sdef:t,swrd:i,hits:r,satk:o,dgld:a,sexp:l}]));function mo(n){console.log("flip sabera entrance");let s=n[0];s.set2d(113,[[s.rom.metascreens.deadEndE_upStair],[s.rom.metascreens.caveEmpty]]),s.moveExits([129,"stair:down",113,"stair:up"]),n[1]=113,n[2]="stair:up"}function po(n,s){console.log("flip karmine entrance");let e=n[0],t=e.rom.metascreens;e.set2d(32,[[t.caveEmpty,t.hallNS],[t.deadEndE_upStair,t.hallNW]]),e.replaceMonsters(s),e.moveExits([48,"stair:down",48,"stair:up"]),n[2]="stair:up"}function xo(n){console.log("flip karmine exit");let s=n[0],e=s.rom.metascreens;s.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),s.moveExits([2,"stair:down",1,"stair:up"]),n[1]=1,n[2]="stair:up"}function ei(n){console.log("flip generic exit");let s=n[0],e=s.rom.metascreens;s.width<2&&(s.width=2),s.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),s.moveExits([0,"stair:up",1,"stair:down"]),n[1]=1,n[2]="stair:down"}function ti(n,s){n[3](n,s),n[3]=void 0}function pr(n,s){let e=n.locations,t=[0,1,2,3];s.shuffle(t);let i=[[e.GoaFortress_Kelbesque.meta,131,"stair:down"],[e.GoaFortress_Sabera.meta,129,"stair:down",mo],[e.GoaFortress_Mado1.meta,114,"stair:down"],[e.GoaFortress_Karmine1.meta,48,"stair:down",po]],r=[[e.GoaFortress_Zebu.meta,0,"stair:up",ei],[e.GoaFortress_Tornel.meta,0,"stair:up",ei],[e.GoaFortress_Asina.meta,0,"stair:up",ei],[e.GoaFortress_Kensu.meta,2,"stair:down",xo]],o=[[e.GoaFortress_Entrance.meta,0,"edge:top"]],a=[],l=!0,c=o[0];for(let d of t){let f=l||i[d][3]||o[o.length-1][3],u=f?s.pick([!1,!0]):!0;console.log(`FLOOR ${d}: up ${l} flexible ${!!f} reverse ${u}`);let h=u?r[d]:i[d];console.log(`push b ${n.locations[h[0].id].name}`),a.push(h),l!==(h[2]==="stair:down")&&(h[3]?ti(h,s):ti(c,s)),o.push(c=u?i[d]:r[d]),console.log(`push a ${n.locations[c[0].id].name}`),l=c[2]==="stair:up"}l&&ti(c,s),a.push([e.GoaFortress_Exit.meta,1,"stair:up"]);for(let d=0;d<o.length;d++)o[d][0].attach(o[d][1],a[d][0],a[d][1],o[d][2],a[d][2])}var go=6,bo=33,si=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),wo=new Set(["inn","armor","tool","pawn"]),xr=new Set([...wo,"house","tavern"]);function gr(n,s,e){let{locations:{Crypt_Hall1:t,Goa:i,GoaFortress_Exit:r,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:c}}=n,d=new Set([i.id,o.id]),f=new Set([a.data.id,l.data.id,c.data.id]);if(s.shuffleAreas())for(let w of[i,r,o,t])w.data.houseType="palace";let u=new O(()=>[]),h=new O(()=>[]),p=new O(()=>new Set);for(let w of n.locations){if(!w.used||w.data.houseType==null)continue;let x;for(let[T,E,F]of w.meta.exits()){let y=(T&240)<<4|w.meta.get(T).findExitByType(E).entrance>>>8;(!x||y>x[3])&&(x=[T,E,F,y])}for(let[T,E,F]of[x]){let y={type:w.data.houseType,inside:[w.id<<8|T,E],outside:F},M=F[0];h.get(M).push(y),u.get(w.data.houseType).push(y);let L=n.locations[M>>>8].screens[M>>>4&15][M&15];p.get(L).add(M)}}let m=new Map,b=new Map;for(let[w,x]of e.ishuffle(p))x.size>=2||f.has(w)?b.set(w,x):m.set(w,x);let v=new Set,g=u.get("inn");for(let[,w]of[...b,...m]){let x=new Map,T=!0;for(let E of w){for(let F of h.get(E)){let y=T&&xr.has(F.type)?[...xr].map(D=>u.get(D)):[u.get(x.get(F.outside[1])??F.type)];y=y.filter(D=>D.length),F.type==="palace"&&d.has(F.outside[0]>>>8)&&(y=y.map(D=>D.filter(P=>!d.has(P.inside[0]>>>8))));let M=[...w].every(D=>!v.has(D>>>8));!M&&y.length>1?y=y.filter(D=>D!==g):M&&y.some(D=>D===g)&&(y=[g]);let L=e.pickAndRemove(...y);if(L.type==="inn")for(let D of w)v.add(D>>>8);if(x.set(F.outside[1],L.type),n.spoiler&&n.spoiler.addHouse(L.inside[0]>>>8,F.outside[0]>>>8),ge.connect(n,F.outside,L.inside),!T||si.get(F.type)===si.get(L.type))continue;let K=n.locations[F.outside[0]>>>8];if(K.meta.tileset!==n.metatilesets.town)continue;let Y=ge.findExitTiles(n,F.outside);if(Y.length>1)continue;let J=Y[0]-32;(Y[0]&240)<32&&(J-=3856);let oe=J>>8,U=J&255,fe=si.get(L.type)??(K.meta.get(oe).data.tallHouses?.includes(U)?bo:go);n.screens[K.screens[oe>>4][oe&15]].tiles[U]=fe}T=!1}}}function br(n,s,e){let t=[],i=[];for(let r of n.locations)if(!yo.has(r.id)){for(let o of r.spawns)if(o.isChest()){let a=n.slots[o.id];if(a>=112&&i.push(o.id),s.preserveUniqueChecks()){let l=n.itemGets[a];if(n.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;t.push(o.id)}}e.shuffle(t),n.slots.setMimicCount(i.length),[...se.zip(i,t,(r,o)=>n.slots.swap(r,o))]}var yo=new Set([182]);function wr(n,s){for(let e of n.locations)(e.id&248)!==88&&e.meta.replaceMonsters(s)}var ys=class{constructor(s){this.rom=s;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new O(()=>[]);for(let t of s.locations)if(!!t.used)for(let i=0;i<t.spawns.length;i++){let r=t.spawns[i];!r.used||(r.isMonster()?e.get(r.monsterId).push([t,i,r]):(r.isNpc()||r.isBoss())&&e.get(~r.id).push([t,i,r]))}for(let[t,i]of e)if(t<0){let r=s.npcs[~t],o=[r.data[3]];if(!s.metasprites[o[0]])throw new Error(`bad NPC: ${~t}`);r.data[2]===208&&o.push(192);let l=r.data[2]<128?r.data[2]&112:0,c=this.computeConstraint(o,i,!0,l);~t===95&&(c=c.ignorePalette()),this.npcConstraints.set(~t,c)}else{let r=ne.ALL,o=this.rom.objects[t];for(let a of ii(s,o)){let c=s.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(c(a),i,a.id===t,a.data[1]),f=r.meet(d);if(!f)throw new Error(`Bad meet for ${t} with ${a.id}`);if(f&&(r=f),a.data[4]&2){let u=this.computeConstraint([a.data[20]],i,!1,a.data[1]),h=r.meet(u);if(!h)throw new Error(`Bad meet for ${t} bonus ${a.id}`);r=h}}this.monsterConstraints.set(o.id,r),o.constraint=r}}getMonsterConstraint(s,e){let t=this.monsterConstraints.get(e)||ne.NONE;return(s&88)===88||!this.rom.objects[e].goldDrop?t:t.meet(ne.COIN)||ne.NONE}getNpcConstraint(s,e){let t=this.npcConstraints.get(e)||ne.NONE;return s===30&&e===96?t.meet(ne.STOM_FIGHT):s===160&&e===201?t.meet(ne.GUARDIAN_STATUE):t}shufflePalettes(s){let e=[...this.allSpritePalettes];for(let[t,i]of this.monsterConstraints)this.monsterConstraints.set(t,i.shufflePalette(s,e));for(let[t,i]of this.npcConstraints)this.npcConstraints.set(t,i.shufflePalette(s,e))}configure(s,e){if(!e.used)return;let t=this.rom.slots[e.id],i=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):e.isChest()?t<112?ne.TREASURE_CHEST:ne.MIMIC:void 0;if(!!i){if(i.shift===3||i.float.length>=2)throw new Error("don't know what to do with two floats");if(!i.float.length)e.patternBank=Number(i.shift===2);else if(i.float[0].has(s.spritePatterns[0]))e.patternBank=0;else if(i.float[0].has(s.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(s,e,t,i=0){let r=new Set,o=new Set;for(let c of s.map(d=>this.rom.metasprites[d])){for(let d of c.palettes())o.add(d);for(let d of c.patternBanks(i))r.add(d)}t=t&&r.size==1&&[...r][0]===2;let a=new Map;for(let[c,,d]of e)a.set(d.patternBank&&t?~c.id:c.id,d);let l;for(let[c,d]of a){let f=this.rom.locations[c<0?~c:c];for(let h of o)h>1&&this.allSpritePalettes.add(f.spritePalettes[h-2]);let u=ne.fromSpawn(o,r,f,d,t);l=l?l.join(u):u,!t&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}};function*ii(n,s){yield s;let e=s.spawnedReplacement();e&&(yield*ii(n,e));let t=s.spawnedChild();t&&(yield*ii(n,t)),s.id===80&&(yield n.objects.largeBlueSlime),s.id===83&&(yield n.objects.largeRedSlime)}function Sr(n,s,e){let t=new ys(n);s.shuffleSpritePalettes()&&t.shufflePalettes(e);let i=new ni(s,{});for(let r of n.locations)r.used&&i.populate(r);i.shuffle(e,t)}var ni=class{constructor(s,e){this.flags=s;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(s){let{maxFlyers:e=0,nonFlyers:t={},skip:i=!1,tower:r=!1,fixedSlots:o={},...a}=yr[s.id]||{};for(let u of Object.keys(a))throw new Error(`Unexpected property '${u}' in MONSTER_ADJUSTMENTS[${s.id}]`);let l=i===!0||!this.flags.shuffleTowerMonsters()&&r||!s.spritePatterns||!s.spritePalettes,c=[],d=[],f=12;for(let u of l?[]:s.spawns){if(++f,!u.used||!u.isMonster())continue;let h=u.monsterId;if(!ct.has(h)||ct.get(h).type!=="m")continue;let p=s.rom.objects[h];if(!(p instanceof Ue))continue;let m=u.patternBank,b=s.spritePatterns[m],v=p.palettes(!0),g=v.includes(2)?s.spritePalettes[0]:void 0,w=v.includes(3)?s.spritePalettes[1]:void 0;c.push({id:h,pat:b,pal2:g,pal3:w,patBank:m}),(this.report[`start-${h.toString(16)}`]=this.report[`start-${h.toString(16)}`]||[]).push("$"+s.id.toString(16)),d.push(f)}(!c.length||i)&&(d=[]),this.locations.push({location:s,slots:d}),this.monsters.push(...c)}shuffle(s,e){let t=e.rom;for(this.report["pre-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(i=>i.id),s.shuffle(this.locations),s.shuffle(this.monsters),this.report["post-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["post-shuffle monsters"]=this.monsters.map(i=>i.id);this.locations.length;){let{location:i,slots:r}=this.locations.pop(),o=this.report["$"+i.id.toString(16).padStart(2,"0")]=[],{maxFlyers:a=0,nonFlyers:l={},tower:c=!1}=yr[i.id]||{};if(c)continue;let d=a,f=ne.forLocation(i.id);i.bossId()!=null;for(let m of i.spawns)if(m.isChest()&&!m.isInvisible())t.slots[m.id]<112?f=f.meet(ne.TREASURE_CHEST,!0):f=f.meet(ne.MIMIC,!0);else if(m.isNpc()||m.isBoss()){let b=e.getNpcConstraint(i.id,m.id);f=f.meet(b,!0),m.isNpc()&&(m.id===107||m.id===104)&&(f=f.meet(ne.KENSU_CHEST,!0))}else if(m.isMonster()&&!(t.objects[m.monsterId]instanceof Ue)){let b=e.getMonsterConstraint(i.id,m.monsterId);f=f.meet(b,!0)}else m.isShootingWall(i)&&(f=f.meet(ne.SHOOTING_WALL,!0));o.push(`Initial pass: ${f.fixed.map(m=>m.size<1/0?"["+[...m].join(", ")+"]":"all")}`);let u=new Map,h=m=>{let b=t.objects[m.id];if(b.monsterClass){let M=u.get(b.monsterClass);if(M!=null&&M!==m.id)return!1}let v=ri.has(m.id),g=So.has(m.id);if(v){if(!d)return!1;--d}let w=e.getMonsterConstraint(i.id,m.id),x=f.tryMeet(w);if(!x&&f.pal2.size<1/0&&f.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(x=f.tryMeet(w,!0)),!x)return!1;let T;if(p){let M=t.objects[m.id];if(!(M instanceof Ue))throw new Error(`non-monster: ${M}`);if(T=p(M),T==null)return!1}o.push(`  Adding ${m.id.toString(16)}: ${x}`),f=x,b.monsterClass&&u.set(b.monsterClass,m.id);let E=0;if(v||g){for(let M=0;M<r.length;M++)if(r[M]in l){E=M;break}}else for(let M=0;M<r.length;M++)if(!(r[M]in l)){E=M;break}(this.report[`mon-${m.id.toString(16)}`]=this.report[`mon-${m.id.toString(16)}`]||[]).push("$"+i.id.toString(16));let F=r[E],y=i.spawns[F-13];return v?(y.data[0]=253,y.data[1]=255):p?(y.screen=T>>>8,y.tile=T&255):F in l&&(y.y+=l[F][0]*16,y.x+=l[F][1]*16),y.monsterId=m.id,o.push(`    slot ${F.toString(16)}: ${y}`),r.splice(E,1),!0},p=i.monstersMoved||r.length&&this.flags.randomizeMaps()?i.monsterPlacer(s):null;if(d&&r.length)for(let m=0;m<Math.min(40,this.monsters.length);m++)ri.has(this.monsters[m].id)&&h(this.monsters[m])&&this.monsters.splice(m,1);for(let m=0;m<this.monsters.length&&r.length;m++)if(h(this.monsters[m])){let[b]=this.monsters.splice(m,1);ri.has(b.id)||this.used.push(b),m--}for(let m=0;m<this.used.length&&r.length;m++)h(this.used[m])&&(this.used.push(...this.used.splice(m,1)),m--);if(f.fix(i,s),r.length){console.error(`Failed to fill location ${i.id.toString(16)} ${i.name}: ${r.length} remaining`);for(let m of r){let b=i.spawns[m-13];b.x=b.y=0,b.id=176,b.data[0]=254}}for(let m of i.spawns)e.configure(i,m)}}},ri=new Set([89,92,110,111,129,138,163,196]),So=new Set([85,93,124,188,193]),yr={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};function ai(n,s,e){new oi(n,s,e).shuffle()}var oi=class{constructor(s,e,t){this.rom=s;this.flags=e;this.random=t}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let s=new O(()=>[]);for(let t of this.rom.locations)!t.tilePalettes.some(i=>i!==154)||s.get(t.colorGroup).push(t);let e=[new Map,new Map];for(let t of s.values())for(let i of t)for(let r=0;r<2;r++)for(let o=0;o<2;o++){let a=e[r].get(i.tilePatterns[o]);a||e[r].set(i.tilePatterns[o],a=new Set),a.add(i.tilePalettes[r])}for(let t of s.values()){let i=t[0],r=[new Set,new Set];for(let l=0;l<2;l++)r[l]=new Set([...e[l].get(i.tilePatterns[0]),...e[l].get(i.tilePatterns[1])]);let o=this.random.pick([...r[0]]),a=this.random.pick([...r[1]]);for(let l of t)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}};function gt(n,s){s.eastCave?ko(n,s.eastCave):s.classicLimeTreeToLeaf&&vo(n),Co(n),To(n),Ro(n),Mo(n),Eo(n)}(s=>{function n(e,t){let i={};if(e.addEastCave()){i.eastCave={};let r=["cordel","lime","goa","desert"],o=t.nextInt(4);[i.eastCave.exit1]=r.splice(o,1),i.eastCave.exit2=t.pick(r)}else e.connectLimeTreeToLeaf()&&(i.classicLimeTreeToLeaf=!0);return i}s.generateOptions=n})(gt||(gt={}));function ko(n,s){let{locations:{EastCave1:e,EastCave2:t,EastCave3:i,SealedCave1:r,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:c,branchNWSE:d,branchNWS:f,branchWSE:u,caveEmpty:h,deadEndE:p,deadEndE_downStair:m,deadEndE_upStair:b,deadEndN_stairs:v,deadEndS:g,deadEndS_stairs:w,deadEndW:x,deadEndW_downStair:T,hallNE:E,hallNS:F,hallNW:y,hallSE:M,hallWS:L,hallWE:K,hallNS_entrance:Y,hallNS_ramp:J,hallNS_wall:oe}}=n;n.locations.allocate(e),n.locations.allocate(t),s.exit2&&n.locations.allocate(i);for(let U of[e,t,i])U.bgm=U.originalBgm=23,U.entrances=[],U.exits=[],U.pits=[],U.spawns=[],U.flags=[],U.width=U.height=1,U.screens=[[128]],U.tilePalettes=[26,27,5],U.originalTilePalettes=[26,27,5],U.tileset=136,U.tileEffects=181,U.tilePatterns=[20,2],U.spritePatterns=[...r.spritePatterns],U.spritePalettes=[...r.spritePalettes];e.meta=new ge(e.id,n.metatilesets.cave,5,5),e.meta.set2d(0,[[p,L,h,M,x],[h,F,M,y,h],[M,d,f,h,h],[F,J,E,K,L],[Y,E,x,b,y]]),t.meta=new ge(t.id,n.metatilesets.cave,5,5),t.meta.set2d(0,[[p,L,g,h,g],[h,F,F,h,F],[h,l,c,u,y],[h,J,h,E,L],[p,y,h,h,v]]),o.meta.set2d(51,[[a]]),n.tileEffects[0].effects[192]=0,e.meta.attach(67,t.meta,68),e.meta.attach(64,o.meta,51),s.exit1&&(e.meta.set2d(4,[[T]]),kr(e,4,s.exit1)),s.exit2&&(i.meta=new ge(i.id,n.metatilesets.cave,3,1),i.meta.set2d(0,[[w],[oe],[Y]]),i.spawns.push($.from([24,7,35,0])),i.flags.push(vi.of({screen:16,flag:n.flags.alloc(512)})),t.meta.set2d(64,[[m]]),t.meta.attach(64,i.meta,0),kr(i,32,s.exit2)),e.spawns.push($.of({screen:33,tile:135,timed:!0,id:2}),$.of({screen:18,tile:136,timed:!1,id:2}),$.of({screen:19,tile:137,timed:!0,id:2}),$.of({screen:50,tile:104,timed:!1,id:2}),$.of({screen:65,tile:136,timed:!0,id:2}),$.of({screen:51,tile:152,timed:!0,id:2}),$.of({screen:3,tile:136,timed:!0,id:2})),t.spawns.push($.of({screen:1,tile:136,timed:!0,id:2}),$.of({screen:17,tile:72,timed:!1,id:2}),$.of({screen:18,tile:119,timed:!0,id:2}),$.of({screen:20,tile:40,timed:!1,id:2}),$.of({screen:35,tile:133,timed:!0,id:2}),$.of({screen:49,tile:136,timed:!0,id:2}),$.of({screen:51,tile:138,timed:!1,id:2}),$.of({screen:52,tile:152,timed:!0,id:2}),$.of({screen:65,tile:130,timed:!0,id:2}),$.of({y:272,x:1144,type:2,id:89}),$.of({y:112,x:264,type:2,id:124})),n.slots.swap(49,89)}function kr(n,s,e){let{locations:{CordelPlainEast:t,CordelPlainWest:i,Desert2:r,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:c,boundaryN_trees:d,boundaryW_cave:f,cornerNE:u,cornerNW:h,cornerSE:p,cornerSE_cave:m,cornerSW:b}}=n.rom,v,g;switch(e){case"lime":v=a,g=16,v.resizeScreens(0,1,0,0),v.meta.spliceColumns(0,1,2,[[h,d],[f,c],[b,p]]);break;case"cordel":let w=[[f,c],[b,p]];v=t,g=85,v.meta.set2d(85,w),i.meta.set2d(85,w);break;case"goa":v=o,g=17,v.meta.set2d(1,[[h,u],[f,l]]);break;case"desert":v=r,g=83,v.meta.set2d(83,[[m]]);break}n.meta.attach(s,v.meta,g)}function vo(n){let{locations:{ValleyOfWind:s,LimeTreeValley:e},metascreens:{exitE:t,exitW_southwest:i,overworldEmpty_alt:r}}=n;s.meta.set2d(84,[[t]]),e.meta.set2d(16,[[i],[r]]),s.meta.attach(84,e.meta,16)}function Co(n){let{TowerEntrance:s,Crypt_Teleporter:e}=n.locations;e.meta.attach(0,s.meta,0,"teleporter","teleporter")}function To(n){let{flags:{OpenedSwanGate:s},locations:{SwanGate:e},npcs:{SoldierGuard:t}}=n;e.spawns.push($.of({xt:10,yt:2,type:1,id:45}),$.of({xt:11,yt:2,type:1,id:45})),t.localDialogs.get(e.id)[0].flags.push(s.id)}function Eo(n){Io(n.locations.SaberaPalace2_West,n.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function Io(n,s,...e){n.rom.locations.allocate(n,s),n.bgm=s.bgm,n.entrances=[],n.exits=[],n.pits=[],n.spawns=[],n.flags=[],n.width=n.height=1,n.screens=[[128]],n.tilePalettes=pt(s.tilePalettes),n.originalTilePalettes=pt(s.originalTilePalettes),n.tileset=s.tileset,n.tileEffects=s.tileEffects,n.tilePatterns=pt(s.tilePatterns),n.spritePatterns=pt(s.spritePatterns),n.spritePalettes=pt(s.spritePalettes);let i=0,r=0;for(let a of e)i=Math.max(i,(a>>>4)+1),r=Math.max(r,(a&15)+1);n.meta=new ge(n.id,s.meta.tileset,i,r);for(let a of e)n.meta.set(a,s.meta.get(a)),s.meta.set(a,s.meta.tileset.empty);let o=new Set(e);n.flags=s.flags.filter(a=>o.has(a.screen)),s.flags=s.flags.filter(a=>!o.has(a.screen)),n.spawns=s.spawns.filter(a=>o.has(a.screen)),s.spawns=s.spawns.filter(a=>!o.has(a.screen)),s.meta.moveExitsAndPitsTo(n.meta)}function Ro(n){let s=n.locations.GoaFortress_Kensu.meta;for(let[e,t]of s.exits())e<16||t.startsWith("seamless")||s.deleteExit(e,t)}function Mo(n){n.locations.ZebuCave.spawns.find(s=>s.isTrigger()).yt+=3}var Fo=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Piano Key","Encryption Key","Private Key","Public Key","Key Card","Any Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Major Key","Minor Key","Cookie","Turkey","Monkey","Ctrl Key","Escape Key","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key"],Go=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power"],Ao=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Flashlight","Search Light","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Tanning Bed","CRT"],Po=["!Random Statue","!Rusty Statue","!Forbidden Statue","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","CodeGorilla Trophy"],Lo=["!Random Bow","Crossbow","Autocrossbow","Long Bow","Compound Bow","Silver Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Derek","Bo Diddley","Bo Dallas","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn"];function vr(n,s,e){if(!s.unidentifiedItems())return;let t=(...c)=>c.map(d=>n.items[d]),i=t(50,51,52),r=t(39,40,49,54),o=t(53,57),a=t(37,56,58,61),l=t(62,63,64);for(let[c,[...d]]of[[i,Fo],[r,Go],[o,Ao],[a,Po],[l,Lo]]){let f=(s.communityJokes()?d:d.filter(h=>h.startsWith("!"))).map(h=>h.replace(/^!/,""));e.shuffle(f);let u=e.shuffle([0,1,2,3]);for(let h of c){let p=f.pop();n.spoiler&&n.spoiler.addUnidentifiedItem(h.id,h.messageName,p),h.menuName=h.messageName=p,h.palette=u.pop()}}}var Bo=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),Do=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),_o=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac"]]]);function Cr(n,s,e){!s.communityJokes()||(No(n,s,e),Wo(n,e),zo(n,e))}function No(n,s,e){if(s.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let t=e.next()<.05?n.items:[n.items[e.nextInt(72)]];for(let i of t){if(!i)continue;let r=Bo.get(i.messageName)||[],o=Math.floor(e.nextInt(3*r.length+1)/3);o<r.length?i.messageName=i.menuName=r[o]:i.messageName===i.menuName&&(i.messageName=i.menuName=li(i.messageName,e))}}function li(n,s){let e=n.split(""),t=s.nextInt(e.length-1);return e[t]===" "||e[t+1]===" "?n:(e[t].toUpperCase()===e[t]?e.splice(t+1,1):[e[t],e[t+1]]=[e[t+1],e[t]],e.join(""))}function Tr(n,s){for(let e of n.messages.parts)for(let t of e)t.text=s(t.text);n.messages.personNames=n.messages.personNames.map(s),Oo(n,s)}function Er(n,s){return e=>e.includes(n)?e.split(n).join(s):e}function Oo(n,s){for(let e of n.objects)e.displayName&&(e.displayName=s(e.displayName))}function Wo(n,s){let e=n.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let t=[...Do].flatMap(([a,l])=>["",...l,...l].map(c=>[a,c])),[i,r]=s.pick(t),o=r||li(i,s);o!==i&&Tr(n,Er(i,o))}function zo(n,s){for(let e=0;e<10;e++){let[t,i]=s.pick([..._o]),o=s.pick(["",...i,...i,...i])||li(t,s);o!==t&&Tr(n,Er(t,o))}}function Ir(n){let{locations:s}=n,{CordelPlainEast:e,CordelPlainWest:t,WaterfallValleyNorth:i,WaterfallValleySouth:r,MezameShrine:o,MtSabreWest_Cave1:a}=s;e.meta.reconcileExits(t.meta);for(let l of i.meta.allPos()){let c=i.meta.get(l),d=r.meta.get(l);c.isEmpty()&&!d.isEmpty()?i.meta.set(l,d):d.isEmpty()&&!c.isEmpty()&&r.meta.set(l,c)}for(let l of s)!l.used||(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of s)!l.used||l!==a&&(l.meta.write(),l===t&&a.used&&a.meta.write())}var Ss=class{constructor(s){this.rom=s;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(s,e){this.route.push(new di(this,s,e))}addSlot(s,e,t){this.slots[s&255]=new ci(this.rom,s&255,e,t&255)}addMaze(s,e,t){this.mazes.push({id:s,name:e,maze:t})}addTrade(s,e,t){this.trades.push({itemId:s,item:e,npc:t})}addUnidentifiedItem(s,e,t){this.unidentifiedItems.push({itemId:s,oldName:e,newName:t})}addWall(s,e,t){this.walls.push({location:s,oldElement:e,newElement:t})}addWildWarp(s,e){this.wildWarps.push({id:s,name:e})}addHouse(s,e){this.houses.push({houseId:s,townId:e,house:this.rom.locations[s].name,town:this.rom.locations[e].name})}formatCondition(s){return this.rom.flags[s]?.name}formatConditionList(s){let e=[];for(let t of s){let i=this.rom.flags[t];i?.logic.track&&e.push(i.name)}return e.join(", ")}},di=class{constructor(s,e,t){this.spoiler=s;this.condition=e;this.deps=t}toString(){let s=0;return(this.condition&-128)===256&&(s=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${s?` (${this.spoiler.formatCondition(s)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},ci=class{constructor(s,e,t,i){this.slot=e;this.slotName=t;this.item=i;this.itemName=Rr(s,i),this.originalItem=Rr(s,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};function Rr(n,s){return s>=112?"Mimic":n.items[n.itemGets[s].itemId].messageName}var Mr=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),fi=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);function qo(n,[s,e,[t,i]]){let r=Mr.get(e)||fi.get(Mr.get(i)),o=!1,a=n.id.toString(16),l=(n.id<<8|s).toString(16)+" "+e,c=n.rom.locations[t>>>8],d=t&255,f=t.toString(16)+" "+i,u=c.id.toString(16),h={loc:c,pos:d,type:i,area:u,key:f,reverse:null,origRev:null,get conn(){return fi.get(r)},set conn(m){r=fi.get(m)},get shuffle(){return o},set shuffle(m){if(m&&!r)throw new Error("shuffle without conn");o=m}},p={loc:n,pos:s,type:e,key:l,reverse:h,area:a,origRev:h,get conn(){return r},set conn(m){r=m},get shuffle(){return o},set shuffle(m){if(m&&!r)throw new Error("shuffle without conn");o=m}};return h.reverse=h.origRev=p,p}function Fr(n,s){return typeof s=="string"?n.type===s:typeof s=="number"?n.pos===s:s instanceof qt?n.reverse.loc===s:s.every(e=>Fr(n,e))}function Gr(n,s,e){if(!s.shuffleAreas())return;let{locations:t}=n,i=new Map,r=new O(()=>[]);for(let g of n.locations)for(let w of g.meta.exits()){if(g===t.CordelPlainEast&&(w[0]&15)<5||g===t.CordelPlainWest&&(w[0]&15)>4||g.isTower())continue;let x=qo(g,w);if(x.loc!==t.Portoa_FortuneTeller&&x.reverse.loc!==t.Portoa_FortuneTeller&&!i.has(x.key)){if(i.has(x.reverse.key))throw new Error(`Inconsistent exits: ${x.key} | ${x.reverse.key}`);i.set(x.key,x),i.set(x.reverse.key,x.reverse),r.get(x.loc).push(x),r.get(x.reverse.loc).push(x.reverse)}}function o(g,...w){let x=[];for(let T of r.get(g))for(let E of w)if(Fr(T,E)){x.push(T);break}return x}for(let g of o(t.ValleyOfWind,"door","windmill"))g.area="windmill";for(let g of o(t.AngrySea,100))g.area="lighthouse";o(t.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(g,...w){for(let x of o(g,...w))x.shuffle=!0}function l(...g){let w=new Set(g);for(let x of g)for(let T of r.get(x))w.has(T.reverse.loc)||(T.shuffle=!0)}if(l(t.Leaf_OutsideStart),a(t.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(t.WindmillCave),l(t.EastCave1,t.EastCave2,t.EastCave3),l(t.ZebuCave,t.MtSabreWest_Cave1),l(t.CordelPlainWest,t.CordelPlainEast),l(t.WaterfallValleyNorth,t.WaterfallValleySouth),l(t.KirisaMeadow),l(t.LimeTreeLake),a(t.Portoa_FishermanIsland,"edge:right"),a(t.PortoaPalace_ThroneRoom,"door"),a(t.Joel,"edge:bottom"),l(t.JoelSecretPassage),a(t.EvilSpiritIsland1,"stair:up"),a(t.ZombieTown,"cave"),a(t.AngrySea,"edge:top"),l(t.SwanGate),a(t.GoaValley,"edge:left"),l(t.Desert1),l(t.GoaFortressBasement),l(t.DesertCave1),l(t.SaharaOutsideCave),l(t.DesertCave2),a(t.Desert2,"stair:down"),!s.shuffleHouses()){let g=[[t.ZombieTown,"fortress"],[t.MtHydra,"gate"],[t.Desert2,"fortress"],[t.Goa,"edge:top"],[t.Portoa,"fortress"],[t.Shyron,"fortress"],[t.GoaValley,"fortress"],[t.OasisCave_Entrance,"stair:up"],[t.MtHydra_OutsideShyron,"gate"],[t.Crypt_Entrance,"crypt"]];for(let[w,x]of g){let[T]=o(w,x);T.conn="F",T.shuffle=!0}}{let[g]=o(t.Oak,"edge:bottom");g.conn="X",g.shuffle=!0}let c=new xe;for(let g of i.values())g.shuffle||c.union([g.area,g.reverse.area]);let d=new O(()=>[]);for(let g of i.values())!g.shuffle||d.get(g.area=c.find(g.area)).push(g);let f=r.get(t.MezameShrine)[0].area;function u(){let g=new Set,w=new Map,x=[];for(let E of[f,...d.keys()]){if(g.has(E))continue;let F=new Set([E]),y=[];for(let M of F){g.add(M);for(let L of d.get(M))w.set(L,x.length),y.push(L),!(L.oneWay||g.has(L.reverse.area))&&F.add(L.reverse.area)}x.push(y)}let T=0;for(let E=1;E<x.length;E++)x[E].length<x[T].length&&(T=E);return[x.length,w,x[T]]}let h=new O(()=>[]);for(let g of i.values())!g.shuffle||!g.conn||h.get(g.conn).push(g);for(let g of"NWCF"){let w=h.get(g),x=e.shuffle([...w]).map(T=>T.reverse);for(let T=0;T<x.length;T++){let E=w[T],F=x[T];[E.reverse,F.reverse]=[F,E]}}let p=0,[m,b,v]=u();for(;p-- >0||m>1;){let g=e.pick(v),w=h.get(g.conn);if(m>1){let F=b.get(g);w=w.filter(y=>b.get(y)!==F)}let x=e.pick(w),T=g.reverse,E=x.reverse;if(g.reverse=E,E.reverse=g,x.reverse=T,T.reverse=x,[m,b,v]=u(),p<-10)debugger}for(let g of i.values()){if(g.reverse!==g.origRev){let w=function(x){return`${x.loc.name} ${x.type}(${x.pos.toString(16)})`};console.log(`${w(g)}  =>  ${w(g.reverse)}  (was ${w(g.origRev)})`)}g.loc.meta.attach(g.pos,g.reverse.loc.meta,g.reverse.pos,g.type,g.reverse.type)}}function Ar(n){for(let s of n.locations){let e=new Set;for(let t of s.spawns)if(!!t.isTrigger()&&e.has(t.coord))throw new Error(`Overlapping triggers on ${s} at ${t.coord.toString(16)}`)}}var hi=!0,Pr=Ii("asm");function Zf(n){return n?/^[0-9a-f]{1,8}$/i.test(n)?Number.parseInt(n,16):Ht(n):rt.newSeed()}var{}={watchArray:Si};function $o(n,s){let e={_ALLOW_TELEPORT_OUT_OF_BOSS:n.hardcoreMode()&&n.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:n.audibleWallCues(s),_AUTO_EQUIP_BRACELET:n.autoEquipBracelet(s),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:n.buffDeosPendant(),_BUFF_DYNA:n.buffDyna(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:n.controllerShortcuts(s),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:n.disableShopGlitch(),_DISABLE_STATUE_GLITCH:n.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:n.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:n.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:n.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:hi,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:n.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:n.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:n.maxScalingInTower(),_MONEY_AT_START:n.shuffleHouses()||n.shuffleAreas(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:n.neverDie(),_NORMALIZE_SHOP_PRICES:n.shuffleShops(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:n.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_REQUIRE_HEALED_DOLPHIN_TO_RIDE:n.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:n.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:n.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:n.teleportOnThunderSword(),_TINK_MODE:!n.guaranteeMatchingSword(),_TRAINER:n.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:n.unidentifiedItems(),_ENEMY_HP:n.shouldUpdateHud(),_UPDATE_HUD:n.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:n.zebuStudentGivesItem()};return Object.keys(e).filter(t=>e[t]).map(t=>`.define ${t} ${e[t]}
`).join("")}function Ho(n,s){for(let e of s)Ke.applyPatch(e,n,hi)}async function Jf(n,s,e,t,i,r,o){let a=16+(n[6]&4?512:0)+(n[4]<<14)+(n[5]<<13);if(n.length>a&&(n=n.slice(0,a)),hi&&n.length<524288){if(n.length<524288){let h=new Uint8Array(n.length+262144);h.subarray(0,262160).set(n.subarray(0,262160)),h.subarray(524304).set(n.subarray(262160)),h[4]<<=1,n=h}let u=n.subarray(16);u.subarray(507904,524288).set(u.subarray(245760,262144))}if(tr(n.subarray(16)),typeof s!="number")throw new Error("Bad seed");let l=Ht(s.toString(16).padStart(8,"0")+String(e.filterOptional()))>>>0,c=new rt(l),d=i||[],f=[];for(let u=0;u<5;u++)try{return await Uo(n,e,s,c,t,r,o,d)}catch(h){f.push(h),console.error(`Attempt ${u+1} failed: ${h.stack}`)}throw new Error(`Shuffle failed: ${f.map(u=>u.stack).join(`

`)}`)}async function Uo(n,s,e,t,i,r,o,a){let l=String(s),c=s.filterRandom(t),d=new Ri(n),f=String(c);d.flags.defrag(),Ji(d),Qi(d),typeof window=="object"&&(window.rom=d),d.spoiler=new Ss(d),r&&(r.spoiler=d.spoiler),f!==l&&(d.spoiler.flags=f),sr(d,c),Ti(d),gt(d,gt.generateOptions(c,t)),d.scalingLevels=48,c.shuffleShops()&&Ko(d,c,t),c.shuffleGoaFloors()&&pr(d,t),Vo(d),Xo(d,c,t),er(d,t),c.nerfWildWarp()&&d.wildWarp.locations.fill(0),c.randomizeWildWarp()&&Zo(d,c,t),c.randomizeThunderTeleport()&&ur(d,t),mr(d,c,t),vr(d,c,t),Cr(d,c,t),rr(d,c,t),c.shuffleHouses()&&gr(d,c,t),c.shuffleAreas()&&Gr(d,c,t),dr(d),c.randomizeMaps()&&_i(d,c,t),Ir(d),wr(d,t),c.shuffleMimics()&&br(d,c,t),c.shuffleMonsters()&&Sr(d,c,t);let u=new gs(d,c),h=new fs([u.getLocationList()]);if(!c.noShuffle()){let g=await h.shuffle(c,t,void 0,o,d.spoiler);if(g){for(let[w,x]of g)d.slots[w&255]=x&255;d.slots.setCheckCount(g.size)}else return[n,-1]}c.shuffleShops()&&ia(d,c.bargainHunting()?t:void 0),c.buffMedicalHerb()&&(d.items.MedicalHerb.value=80,d.items.FruitOfPower.value=56),c.storyMode()&&ea(d),c.blackoutMode()&&Qo(d),jo(d,c,t),ar(d),cr(d),Ar(d),c.buffDyna()&&Jo(d,c),c.trainer()&&(d.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),c.randomizeMusic("early")&&Lr(d,c,t),c.shuffleTilePalettes("early")&&ai(d,c,t),sa(d,c),t.shuffle(d.randomNumbers.values);async function p(g){async function w(y){return new As(await i.read(y),y,{lineContinuations:!0})}let x=$o(c,g),T=new yi(gi.P02),E=new cs;E.enter(zt.concat(new As(x,"flags.s"),await w("init.s"),await w("alloc.s"),await w("stattracker.s"),await w("preshuffle.s"),await w("postparse.s"),await w("postshuffle.s")));let F=new ds(E,T);return T.tokens(F),T.module()}d.messages.compress();let m=n.slice(16);d.modules.set(Pr,await p("early")),d.writeData(m),d.modules.set(Pr,await p("late"));let b=a?.some(g=>Ke.isCustom(g))||!1,v=ta(n,e,l,m,b);return c.randomizeMusic("late")&&Lr(d,c,t),c.noMusic("late")&&Yo(d),c.shuffleTilePalettes("late")&&ai(d,c,t),hr(d),d.writeData(),Ho(n,a),[n,v]}function jo(n,s,e){let{}={rom:n,flags:s,random:e};n.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,n.messages.parts[0][14].text="It's dangerous to go alone! Take this.",n.messages.parts[0][14].fixText()}function Ko(n,s,e){let t={[0]:{contents:[],shops:[]},[1]:{contents:[],shops:[]}};for(let i of n.shops){if(!i.used||i.location===255)continue;let r=t[i.type];r&&(r.contents.push(...i.contents.filter(o=>o!==255)),r.shops.push(i),i.contents=[])}for(let i of Object.values(t)){let r=null,o=[...i.contents];for(e.shuffle(o);o.length;){(!r||!r.length)&&(r&&o.shift(),r=[...i.shops,...i.shops,...i.shops,...i.shops],e.shuffle(r));let a=o[0],l=r[0];l.contents.length<4&&!l.contents.includes(a)&&(l.contents.push(a),o.shift()),r.shift()}}for(let i of Object.values(t))for(let r of i.shops){for(;r.contents.length<4;)r.contents.push(255);r.contents.sort((o,a)=>o-a)}}function Vo(n){for(let s of n.locations)if(!!s.used){for(let e of s.spawns)if(e.isWall()){let t=e.id&15;e.id=t|t<<4;let i=e.isShootingWall(s);e.data[2]=i?51:35}}}function Xo(n,s,e){if(!s.randomizeWalls())return;let t=[[5,56],[17],[106],[20]];function i(o){return o.data[2]&32?o.id>>>4&3:o.id&3}let r=new O(()=>[]);for(let o of n.locations)r.get(o.data.area).push(o);for(let o of r.values()){let a=e.nextInt(4),l=e.pick(t[a]),c=!1;for(let d of o)for(let f of d.spawns)if(f.isWall()){let u=i(f);if(u===2)continue;if(u===3){let h=e.nextInt(4);n.spoiler&&n.spoiler.addWall(d.name,u,h),f.data[2]|=32,f.id=48|h}else!c&&n.spoiler&&(n.spoiler.addWall(d.name,u,a),c=!0),f.data[2]|=32,f.id=u<<4|a,d.tilePalettes[2]=l}}}function Yo(n){for(let s of[...n.locations,...n.bosses.musics])s.bgm=0}function Lr(n,s,e){let t=new O(()=>[]),i=new Set;for(let a of n.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;i.add(a.bgm),t.get(l).push(a)}for(let a of n.bosses.musics)t.set(a,[a]),i.add(a.bgm);let r=[...i],o=new Set;for(let a of t.values()){let l=e.pick(r);for(let c of a)c.bgm=l,o.add(c)}}function Zo(n,s,e){let t=[];for(let i of n.locations)i&&i.used&&i.id&&!i.isShop()&&(i.id&248)!==88&&i!==n.locations.Crypt_Draygon2&&i!==n.locations.Crypt_Teleporter&&i!==n.locations.MesiaShrine&&i!==n.locations.LimeTreeLake&&t.push(i);e.shuffle(t),n.wildWarp.locations=[];for(let i of[...t.slice(0,15).sort((r,o)=>r.id-o.id)])n.wildWarp.locations.push(i.id),n.spoiler&&n.spoiler.addWildWarp(i.id,i.name);n.wildWarp.locations.push(0)}function Jo(n,s){n.objects[184].collisionPlane=1,n.objects[184].immobile=!0,n.objects[185].collisionPlane=1,n.objects[185].immobile=!0,n.objects[51].collisionPlane=2,n.adHocSpawns[40].slotRangeLower=28,n.adHocSpawns[41].slotRangeUpper=28,n.adHocSpawns[42].slotRangeUpper=28}function Qo(n){let s=new Set([n.metatilesets.cave.tilesetId,n.metatilesets.fortress.tilesetId,n.metatilesets.iceCave.tilesetId,n.metatilesets.labyrinth.tilesetId,n.metatilesets.pyramid.tilesetId]);for(let e of n.locations)s.has(e.tileset)&&e.tilePatterns.fill(154)}var ea=n=>{let s=[n.flags.Kelbesque1.id,n.flags.Sabera1.id,n.flags.Mado1.id,n.flags.Kelbesque2.id,n.flags.Sabera2.id,n.flags.Mado2.id,n.flags.Karmine.id,n.flags.Draygon1.id,n.flags.SwordOfWind.id,n.flags.SwordOfFire.id,n.flags.SwordOfWater.id,n.flags.SwordOfThunder.id];n.npcs[203].spawnConditions.get(166).push(...s)};function ta(n,s,e,t,i){let r=Ht(t),o=r.toString(16).padStart(8,"0").toUpperCase(),a=$s==="unstable"?Oi.substring(0,7).padStart(7,"0").toUpperCase()+"     ":Ni.substring(0,12).padEnd(12," "),l=s.toString(16).padStart(8,"0").toUpperCase(),c=(u,...h)=>{u+=16;for(let p of h)if(typeof p=="string")for(let m of p)n[u++]=m.charCodeAt(0);else if(typeof p=="number")n[u++]=p;else throw new Error(`Bad value: ${p}`)},d=(u,h)=>{let p=[];for(let m=0;m<u.length||m<h.length;m++)p.push(u[m]||" "),p.push(h[m]||" ");return p.join("")};c(161743,d("  VERSION     SEED      ",`  ${a}${l}`));let f;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");f=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),c(161791,d(e.substring(0,23),e.substring(23))),f&&c(161839,d(f.substring(0,23),f.substring(23))),i&&c(161923,126),c(161925,d(o.substring(0,4),o.substring(4))),c(153366,"RANDOMIZER"),$s==="unstable"&&c(153404,"BETA"),r}function sa(n,s){s.decreaseEnemyDamage()&&n.scaling.setPhpFormula(e=>16+6*e),n.scaling.setExpScalingFactor(s.expScalingFactor()),s.disableShopGlitch()?n.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:n.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],n.items.CarapaceShield.defense=n.items.TannedHide.defense=3,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=9,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=13,n.items.PsychoArmor.defense=n.items.PsychoShield.defense=20,n.items.CeramicSuit.defense=n.items.BattleShield.defense=32,n.items.CarapaceShield.defense=n.items.TannedHide.defense=2,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=10,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=14,n.items.BattleArmor.defense=24}var ia=(n,s)=>{for(let t of n.shops)if(t.type!==3)for(let i=0,r=t.prices.length;i<r;i++)t.contents[i]<128?t.prices[i]=s?s.nextNormal(1,.3,.5,1.5):1:t.type!==2?t.prices[i]=0:t.prices[i]=s?s.nextNormal(1,.5,.375,1.625):1;let e=te(48,t=>t);n.shops.rescale=!0,n.shops.toolShopScaling=e.map(t=>Math.round(8*2**(t/10))),n.shops.armorShopScaling=e.map(t=>Math.round(8*2**((47-t)/12)));for(let t=13;t<39;t++)n.items[t].basePrice=ra[t]},ra={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300},[]=[V];var ks=n=>"",ui=n=>n===!0?!1:n,mi=class{constructor(s,e){this.flag=s;this.opts=e;mi.flags.set(s,this)}static all(){return[...this.flags.values()]}},ye=mi;ye.flags=new Map;var ue=class{constructor(s,e,t,i){this.name=e;this.description=t;this.flags=i.map(r=>r instanceof ye?[r,!0]:r),s.presets.set(Br(e),this)}static all(){return ze.instance||(ze.instance=new ze),[...ze.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new yt(`@${this.name}`))),this._flagString}};function Br(n){return n.toLowerCase().replace(/[^a-z]/g,"")}var ze=class{constructor(){this.presets=new Map;this.Casual=new ue(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[H.PreserveUniqueChecks,H.NoShuffleMimics,H.DecreaseEnemyDamage,H.GuaranteeRefresh,H.GuaranteeStartingSword,H.ExperienceScalesFaster,H.NoCommunityJokes,N.NoThunderSwordWarp,j.Shops,j.Dyna,[j.Maps,"!"],[j.WildWarp,"!"],le.SpoilerLog]);this.Classic=new ue(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[H.GuaranteeStartingSword,H.NoCommunityJokes,_.StatueGlitch,[N.NoThunderSwordWarp,"!"],[j.Maps,"!"],le.SpoilerLog]);this.Standard=new ue(this,"Standard",`
      Well-balanced, standard race flags.`,[ee.RandomizeWeaknesses,N.StoryMode,le.SpoilerLog]);this.NoBowMode=new ue(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[ee.RandomizeWeaknesses,ee.TowerRobots,X.MaxScalingInTower,N.NoBowMode,le.SpoilerLog]);this.Advanced=new ue(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[_.GhettoFlight,_.MtSabreRequirementSkip,_.StatueGlitch,[_.SwordChargeGlitch,"!"],Z.Barrier,Z.BattleMagic,Z.GasMask,X.MaxScalingInTower,ee.RandomizeWeaknesses,ee.TowerRobots,N.OrbsNotRequired,N.StoryMode,I.RandomizeMaps,I.ShuffleAreas,I.ShuffleHouses,I.RandomizeTrades,I.RandomizeWallElements,I.UnidentifiedKeyItems,le.SpoilerLog]);this.WildWarp=new ue(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[H.GuaranteeRefresh,I.RandomizeWildWarp,ee.RandomizeWeaknesses,ee.TowerRobots,N.OrbsNotRequired,N.StoryMode,le.SpoilerLog]);this.Mystery=new ue(this,"Mystery",`
      Even the options are random.`,[[I.ShuffleAreas,"?"],[I.ShuffleHouses,"?"],[I.RandomizeMaps,"?"],[I.RandomizeTrades,"?"],[I.UnidentifiedKeyItems,"?"],[I.RandomizeWallElements,"?"],[I.ShuffleGoaFloors,"?"],[I.RandomizeSpriteColors,"?"],[I.RandomizeWildWarp,"?"],[N.OrbsNotRequired,"?"],[N.NoBowMode,"?"],[N.StoryMode,"?"],[N.VanillaDolphin,"?"],[N.NoThunderSwordWarp,"?"],[_.RageSkip,"?"],[_.TriggerSkip,"?"],[_.StatueGlitch,"?"],[_.GhettoFlight,"?"],[_.SwordChargeGlitch,"?"],[_.MtSabreRequirementSkip,"?"],[Ge.RandomizeMusic,"?"],[Ge.RandomizeMapColors,"?"],[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],[H.NoShuffleMimics,"?"],[H.PreserveUniqueChecks,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],[Z.GasMask,"?"],[j.Dyna,"?"],[j.BonusItems,"?"],[j.Maps,"?"],le.SpoilerLog]);this.Hardcore=new ue(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[Z.Barrier,Z.BattleMagic,X.ExperienceScalesSlower,X.MaxScalingInTower,X.Permadeath,N.OrbsNotRequired,N.StoryMode,I.RandomizeMaps,I.ShuffleAreas,I.ShuffleHouses,I.RandomizeTrades,I.RandomizeWallElements,I.UnidentifiedKeyItems]);this.FullStupid=new ue(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[Z.Barrier,Z.BattleMagic,X.Blackout,X.ExperienceScalesSlower,X.MaxScalingInTower,X.Permadeath,ee.RandomizeWeaknesses,ee.TowerRobots,N.OrbsNotRequired,N.StoryMode,I.RandomizeMaps,I.ShuffleAreas,I.ShuffleHouses,I.RandomizeTrades,I.RandomizeWallElements,I.ShuffleGoaFloors,I.UnidentifiedKeyItems]);this.Tournament2022Early=new ue(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[H.GuaranteeStartingSword,_.StatueGlitch,_.StatueGauntletSkip,[ee.RandomizeWeaknesses,"?"],N.OrbsNotRequired,N.StoryMode,[N.VanillaDolphin,"?"],[N.NoThunderSwordWarp,"?"],[I.RandomizeWallElements,"?"],[I.ShuffleGoaFloors,"?"],[I.RandomizeSpriteColors,"?"],[I.RandomizeTrades,"?"],[I.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new ue(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[H.GuaranteeStartingSword,"?"],[_.GhettoFlight,"?"],[_.StatueGlitch,"?"],[_.MtSabreRequirementSkip,"?"],[_.StatueGauntletSkip,"?"],X.MaxScalingInTower,[X.NoBuffMedicalHerb,"?"],[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],N.StoryMode,[N.VanillaDolphin,"?"],[N.OrbsNotRequired,"?"],[N.NoThunderSwordWarp,"?"],[I.RandomizeWallElements,"?"],[I.ShuffleGoaFloors,"?"],[I.RandomizeSpriteColors,"?"],[I.RandomizeTrades,"?"],[I.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new ue(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[H.GuaranteeStartingSword,"?"],_.GhettoFlight,_.StatueGlitch,_.MtSabreRequirementSkip,_.StatueGauntletSkip,X.NoBuffMedicalHerb,X.MaxScalingInTower,[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],Z.Barrier,Z.BattleMagic,N.StoryMode,[N.VanillaDolphin,"?"],[N.OrbsNotRequired,"?"],[N.NoThunderSwordWarp,"?"],I.ShuffleHouses,[I.RandomizeWallElements,"?"],[I.ShuffleGoaFloors,"?"],[I.RandomizeSpriteColors,"?"],[I.RandomizeTrades,"?"],[I.UnidentifiedKeyItems,"?"]])}static get(s){return this.instance||(this.instance=new ze),this.instance.presets.get(Br(s))}},pi=class{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(s,e){pi.sections.add(this.instance||(this.instance=new this));let t=new ye(s,e);if(!s.startsWith(this.instance.prefix))throw new Error(`bad flag ${s} ${e}`);return this.instance.flags.set(s,t),t}},me=pi;me.sections=new Set;var Ee=class extends me{constructor(){super(...arguments);this.prefix="W";this.name="World"}},I=Ee;I.RandomizeMaps=Ee.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0}),I.ShuffleAreas=Ee.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0}),I.ShuffleHouses=Ee.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0}),I.RandomizeTrades=Ee.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog
           Lamp, and Flute of Lime (for Akahana).  Rage will expect a
           random sword, and Tornel will expect a random bracelet.`,hard:!0}),I.UnidentifiedKeyItems=Ee.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0}),I.RandomizeWallElements=Ee.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`}),I.ShuffleGoaFloors=Ee.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."}),I.RandomizeSpriteColors=Ee.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`}),I.RandomizeWildWarp=Ee.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]});var ft=class extends me{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}},N=ft;N.StoryMode=ft.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`}),N.NoBowMode=ft.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`}),N.OrbsNotRequired=ft.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."}),N.NoThunderSwordWarp=ft.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"}),N.VanillaDolphin=ft.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`});var Oe=class extends me{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}},_=Oe;_.GhettoFlight=Oe.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`}),_.StatueGlitch=Oe.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"}),_.MtSabreRequirementSkip=Oe.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"}),_.StatueGauntletSkip=Oe.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"}),_.SwordChargeGlitch=Oe.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"}),_.TriggerSkip=Oe.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"}),_.RageSkip=Oe.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"});var Bt=class extends me{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}},Ge=Bt;Ge.RandomizeMusic=Bt.flag("Am",{name:"Randomize background music",modes:"!",optional:ui}),Ge.NoMusic=Bt.flag("As",{name:"No background music",optional:ks}),Ge.RandomizeMapColors=Bt.flag("Ac",{name:"Randomize map colors",modes:"!",optional:ui});var vs=class extends me{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}},ee=vs;ee.RandomizeWeaknesses=vs.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."}),ee.TowerRobots=vs.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0});var We=class extends me{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}},H=We;H.NoShuffleMimics=We.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."}),H.PreserveUniqueChecks=We.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`}),H.DecreaseEnemyDamage=We.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`}),H.GuaranteeStartingSword=We.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`}),H.GuaranteeRefresh=We.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`}),H.ExperienceScalesFaster=We.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]}),H.NoCommunityJokes=We.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`});var bt=class extends me{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}},Z=bt;Z.BattleMagic=bt.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0}),Z.MatchingSword=bt.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0}),Z.Barrier=bt.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0}),Z.GasMask=bt.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0});var Qe=class extends me{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}},X=Qe;X.NoBuffMedicalHerb=Qe.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0}),X.MaxScalingInTower=Qe.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0}),X.ExperienceScalesSlower=Qe.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0}),X.ChargeShotsOnly=Qe.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0}),X.Blackout=Qe.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0}),X.Permadeath=Qe.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});var et=class extends me{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}},j=et;j.Dyna=et.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`}),j.BonusItems=et.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`}),j.Maps=et.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"}),j.Shops=et.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`}),j.WildWarp=et.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"}),j.Hud=et.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:ui});var Dt=class extends me{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}},tt=Dt;tt.NoAutoEquip=Dt.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:ks}),tt.NoControllerShortcuts=Dt.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:ks}),tt.AudibleWallCues=Dt.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:ks});var wt=class extends me{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}},le=wt;le.SpoilerLog=wt.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`}),le.TrainerMode=wt.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`}),le.NeverDie=wt.flag("Di",{name:"Player never dies"}),le.NoShuffle=wt.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`});var yt=class{constructor(s="@Casual"){if(typeof s!="string"){this.flags=new Map;for(let[i,r]of s)this.set(i.flag,r);return}if(s.startsWith("@")){let i=ze.get(s.substring(1));if(!i)throw new bi(`Unknown preset: ${s}`);this.flags=new Map(i.flags);return}this.flags=new Map,s=s.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,t;for(;t=e.exec(s);){let[,i,r]=t,o=/([!?]|^)([a-z0-9]+)/g;for(;t=o.exec(r);){let[,a,l]=t;for(let c of l)this.set(i+c,a||!0)}}}filterOptional(){return new yt(new Map([...this.flags].map(([s,e])=>[s,s.opts.optional?s.opts.optional(e):e])))}filterRandom(s){function e(t,i){return i!=="?"?i:s.pick([!0,!1,...t.opts.modes||""])}return new yt(new Map([...this.flags].map(([t,i])=>[t,e(t,i)])))}toString(){let s=new O(()=>new O(()=>[]));for(let[t,i]of this.flags){if(t.flag.length!==2)throw new Error(`Bad flag ${t.flag}`);if(!i)continue;let r=s.get(t.flag[0]),o=i===!0?"":i;r.get(o).push(t.flag[1])}let e=[];for(let[t,i]of s.sortedEntries()){let r=t;for(let[o,a]of i.sortedEntries())r+=o+a.sort().join("");e.push(r)}return e.join(" ")}toggle(s){let e=ye.flags.get(s);if(!e)return console.error(`Bad flag: ${s}`),!1;let t=this.flags.get(e)||!1,i=[!1,!0,...e.opts.modes||"","?",!1],r=i.indexOf(t);if(r<0)throw new Error(`Bad current mode ${t}`);let o=i[r+1];return this.flags.set(e,o),o}set(s,e){let t=ye.flags.get(s);if(!t){console.error(`Bad flag: ${s}`);return}if(!e)this.flags.delete(t);else if(e===!0||e==="?"||t.opts.modes?.includes(e))this.flags.set(t,e);else{console.error(`Bad flag mode: ${s[0]}${e}${s.substring(1)}`);return}for(let i of t.opts.excludes||[])this.flags.delete(ye.flags.get(i))}check(s,...e){let t=s instanceof ye?s:ye.flags.get(s);return e.length||e.push(!0),e.includes(t&&this.flags.get(t)||!1)}get(s){let e=s instanceof ye?s:ye.flags.get(s);return e&&this.flags.get(e)||!1}preserveUniqueChecks(){return this.check(H.PreserveUniqueChecks)}shuffleMimics(){return this.check(H.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(j.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(j.BonusItems,!1)}slowDownTornado(){return this.check(j.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(j.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(j.BonusItems,!1)}shuffleSpritePalettes(){return this.check(I.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(j.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(ee.TowerRobots)}shuffleMonsterElements(){return this.check(ee.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(X.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check(H.DecreaseEnemyDamage)}trainer(){return this.check(le.TrainerMode)}neverDie(){return this.check(le.NeverDie)}noShuffle(){return this.check(le.NoShuffle)}chargeShotsOnly(){return this.check(X.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(j.Maps,"!")}addEastCave(){return this.check(j.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(N.VanillaDolphin,!1)}storyMode(){return this.check(N.StoryMode)}noBowMode(){return this.check(N.NoBowMode)}requireHealedDolphinToRide(){return this.check(N.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(N.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(N.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(N.OrbsNotRequired)}shuffleGoaFloors(){return this.check(I.ShuffleGoaFloors)}shuffleHouses(){return this.check(I.ShuffleHouses)}shuffleAreas(){return this.check(I.ShuffleAreas)}randomizeMaps(){return this.check(I.RandomizeMaps)}randomizeTrades(){return this.check(I.RandomizeTrades)}unidentifiedItems(){return this.check(I.UnidentifiedKeyItems)}randomizeWalls(){return this.check(I.RandomizeWallElements)}guaranteeSword(){return this.check(H.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(Z.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(Z.MatchingSword,!1)}guaranteeGasMask(){return this.check(Z.GasMask,!1)}guaranteeBarrier(){return this.check(Z.Barrier,!1)}guaranteeRefresh(){return this.check(H.GuaranteeRefresh)}communityJokes(){return this.check(H.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(_.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(_.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(_.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(j.Shops,!1)}disableStatueGlitch(){return this.check(_.StatueGlitch,!1)}disableRageSkip(){return this.check(_.RageSkip,!1)}disableTriggerGlitch(){return this.check(_.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(_.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(_.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(_.GhettoFlight)}assumeTeleportSkip(){return this.check(_.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(_.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(_.StatueGlitch)}assumeTriggerGlitch(){return this.check(_.TriggerSkip)}assumeFlightStatueSkip(){return this.check(_.StatueGauntletSkip)}assumeWildWarp(){return this.check(j.WildWarp,!0)||this.check(I.RandomizeWildWarp)}assumeRageSkip(){return this.check(_.RageSkip)}nerfWildWarp(){return this.check(j.WildWarp,!1)&&this.check(I.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(I.RandomizeWildWarp,!0)}blackoutMode(){return this.check(X.Blackout)}hardcoreMode(){return this.check(X.Permadeath)}buffDyna(){return!this.check(j.Dyna)}maxScalingInTower(){return this.check(X.MaxScalingInTower)}expScalingFactor(){return this.check(X.ExperienceScalesSlower)?.25:this.check(H.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(s){return s==="early"||this.check(tt.NoAutoEquip,!1)}controllerShortcuts(s){return s==="early"||this.check(tt.NoControllerShortcuts,!1)}randomizeMusic(s){return this.check(Ge.RandomizeMusic,s==="early"?"!":!0)}shuffleTilePalettes(s){return this.check(Ge.RandomizeMapColors,s==="early"?"!":!0)}noMusic(s){return s==="late"&&this.check(Ge.NoMusic)}audibleWallCues(s){return s==="late"&&this.check(tt.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(j.Hud,!1)}hasStatTracking(){return!0}};var Dr=class{constructor(s="asm/"){this.path=s}async read(s){return s in _r?_r[s]:await(await fetch(this.path+s)).text()}},_r={};export{Ht as a,rn as b,$s as c,Ni as d,$l as e,Oi as f,Hl as g,Ul as h,Ke as i,as as j,dn as k,Zf as l,Jf as m,ue as n,me as o,yt as p,Dr as q};
