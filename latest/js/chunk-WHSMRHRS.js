import{A as wi,B as yi,C as H,D as xe,E as Nt,F as Rt,G as Ms,H as Be,I as Se,J as Si,K as Ci,L as ki,M as vi,N as Ei,a as Cs,b as hi,c as D,d as se,e as Dt,f as It,g as ks,h as ui,i as vs,j as Es,k as Is,l as mi,m as Rs,n as pi,o as xi,p as gi,q as te,r as V,s as bi,t as ct,u as Ts,v as Re,w as pe,x as ne,y as He,z as Je}from"./chunk-FQPPXMKV.js";var Wt,_r=()=>{let n;Wt=new Uint32Array(256);for(let s=0;s<256;s++){n=s;for(let e=0;e<8;e++)n=n&1?3988292384^n>>>1:n>>>1;Wt[s]=n}};var Dr=n=>n.split("").map(s=>s.charCodeAt(0)),Ot=n=>{Wt||_r(),typeof n=="string"&&(n=Dr(n));let s=-1;for(let e=0,t=n.length;e<t;e++)s=s>>>8^Wt[(s^n[e])&255];return(s^-1)>>>0};var Nr=4656613057391769e-25,Mi=2147483563-1,Ii=40014,Wr=40692,zt=53668,Ri=52774,Ti=12211,Or=3791,$t=32,zr=1+Math.floor(Mi/$t),$r=12e-8,Hr=1-$r,Qe=class{constructor(s=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(s)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(s){this.idum=Math.max(1,Math.floor(s)),this.idum2=this.idum,this.iy=0,this.iv=new Array($t).fill(0);for(let e=$t+7;e>=0;e--){let t=Math.floor(this.idum/zt);this.idum=Ii*(this.idum-t*zt)-t*Ti,this.idum<0&&(this.idum+=2147483563),e<$t&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let s=Math.floor(this.idum/zt);this.idum=Ii*(this.idum-s*zt)-s*Ti,this.idum<0&&(this.idum+=2147483563),s=Math.floor(this.idum2/Ri),this.idum2=Wr*(this.idum2-s*Ri)-s*Or,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/zr);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=Mi),Math.min(Nr*this.iy,Hr)}nextInt(s){return Math.floor(this.next()*s)}nextNormal(s=0,e=1,t=-1/0,i=1/0){for(;;){let r=this.z1;if(r==null){let o=Math.sqrt(-2*Math.log(this.next())),a=Ur*this.next();r=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(r=s+r*e,r>=t&&r<=i)return r}}shuffle(s){for(let e=s.length;e;){let t=this.nextInt(e--);[s[e],s[t]]=[s[t],s[e]]}return s}*ishuffle(s){let e=[];if(!Array.isArray(s))if(qr(s)){let t=s[Symbol.iterator]();for(let i=0;i<s.size;i++){let r=i+this.nextInt(s.size-i);for(;e.length<=r;)e.push(t.next().value);yield e[r],e[r]=e[i]}return}else s=[...s];if(!Array.isArray(s))throw new Error("impossible");for(let t=0;t<s.length;t++){let i=t+this.nextInt(s.length-t);yield i in e?e[i]:s[i],e[i]=t in e?e[t]:s[t]}}pick(s){if(!s.length)throw new Error("empty array");return s[this.nextInt(s.length)]}pickWeighted(s){if(!s.length)throw new Error("empty array");let e=0;for(let[i]of s)e+=i;let t=this.next()*e;for(let[i,r]of s){if(t<i)return r;t-=i}throw new Error("bad weights")}pickAndRemove(...s){let e=0;for(let i of s)e+=i.length;if(!e)throw new Error("empty arrays");let t=this.nextInt(e);for(let i of s){if(t<i.length)return i.splice(t,1)[0];t-=i.length}throw new Error("impossible")}bitGenerator(){let s=0,e=0;return()=>{s||(s=32,e=this.nextInt(4294967296)),s--;let t=!(e&1);return e>>>=1,t}}};function qr(n){return"size"in n}var Ur=2*Math.PI;var Te=class{constructor(s,e){this.height=s;this.width=e;this._coords=void 0;this.data=new Array((s<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let s=[];for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++)s.push(e<<12|t<<4);return this._coords=s}index(s){return((s&248)>>3)+this.row*(s>>>11)}index2(s,e){return(this.row<<1)*s+2*e}yx(s){let e=s%this.row;return[(s-e)/this.row/2,e/2]}coord(s){let e=s%this.row;return(s-e)/this.row<<11|e<<3}get(s){return this.data[this.index(s)]}set(s,e){this.data[this.index(s)]=e}get2(s,e){return this.data[this.index2(s,e)]}set2(s,e,t){this.data[this.index2(s,e)]=t}plus(s,e,t){return s+(this.row<<1)*e+2*t}x(s){return s%this.row/2}y(s){return Math.floor(s/this.row)/2}border(s,e){let t,i;return s&1?(i=e<<12|2048,t=s&2?this.width<<4:0):(i=s&2?this.height<<12:0,t=e<<4|8),i|t}randomBorder(s,e){let t,i;if(e!=null)e&1?(i=s.nextInt(this.height)<<12|2048,t=e&2?this.width<<4:0):(i=e&2?this.height<<12:0,t=s.nextInt(this.width)<<4|8);else{let r=this.width+this.height,o=s.nextInt(r<<1)-r,a=!1;o<0&&(o=~o,a=!0),o<this.width?(t=o<<4|8,i=a?this.height<<12:0):(i=o-this.width<<12|2048,t=a?this.width<<4:0)}return i|t}oppositeBorder(s){return s&8?s^this.height<<12:s^this.width<<4}furthestBorder(s){return(this.height<<12|this.width<<4)-s}edgeCoordination(s,e){let t=0;if((s&2056)!==2056)throw new Error(`Bad tile: ${V(s)}`);for(let i of[8,-8,2048,-2048]){let r=this.get(s+i);(e?r===e:r)&&t++}return t}isBorder(s){if(s&8){if(s&2048)return!1;let e=s>>>12;return!e||e===this.height}else if(s&2048){let e=s>>>4&15;return!e||e===this.width}return!1}partition(s){let e=new pe;for(let t=0;t<this.data.length;t+=this.row)for(let i=0;i<this.row;i++){let r=t+i,o=this.coord(r);if(!(s?.get(o)??this.data[r]))continue;e.find(o);let l=o-2048;t&&(s?.get(l)??this.data[r-this.row])&&e.union([o,l]);let f=o-8;i&&(s?.get(f)??this.data[r-1])&&e.union([o,f])}return e.map()}show(){let s=[];for(let e=0;e<this.data.length;e+=this.row){let t="";for(let i=0;i<this.row;i++)t+=this.data[e+i]||" ";s.push(t)}return s.join(`
`)}static writeGrid2d(s,e,t){let i=s.index(e);for(let r=0;r<t.length;r++){let o=t[r];for(let a=0;a<o.length;a++){let l=o[a];s.data[i+r*s.row+a]=l!==" "?l:""}}}};function Fi(n){return n>>4&15|n>>8&240}function qe(n,s=1){return n-s*8}function Ce(n,s=1){return n+s*8}function de(n,s=1){return n-s*2048}function Q(n,s=1){return n+s*2048}var[]=[V],T={ok:!0,value:void 0},Ht=class{constructor(s,e){this.rom=s;this.random=e;this.shuffles=[]}add(...s){this.shuffles.push(...s)}shuffleAll(){for(let s of this.shuffles)s.shuffle(this.random);for(let s of this.shuffles)s.meta&&s.finish();for(let s of this.rom.locations)s.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((s,e)=>(s.badness||0)-(e.badness||0)).join(`
`)}},qt=class{constructor(s,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new Te(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=s,this.orig=s.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let s=this.pickHeight(),e=this.pickWidth(),t=this.pickSize(),i=new Te(s,e);i.data.fill(""),Object.assign(this,{h:s,w:e,size:t,grid:i,fixed:new Set,count:0,exitMap:[]})}shuffle(s){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:s});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let s=[];for(let[e,t,i]of this.exitMap)for(let[r,o,a]of s)if(e(r,o)){s.push([t,i,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,t,i]of s){let r=this.meta.rom.locations[i[0]>>>8].meta,o=i[0]&255,a=i[1];this.meta.attach(e,r,o,t,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(s,e){let t=this.posToGrid(s);for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=t+i*2048+r*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[i*3+r])return!1}for(let i=0;i<3;i++)for(let r=0;r<3;r++){let o=t+i*2048+r*8;this.grid.set(o,e[i*3+r])}return!0}posToGrid(s,e=0){let t=s>>>4,i=s&15;return(t<<12|i<<4)+e}insertPattern(s,{top:e=0,bottom:t=0,left:i=0,right:r=0}={}){let o=s.length-1>>>1,a=s[0].length-1>>>1,l=e+t,f=i+r;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+f)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,c=this.random.nextInt(this.w-a-1-l)+i,u=d+1<<12|c+1<<4;Te.writeGrid2d(this.grid,u,s);for(let h=12288;h<=20480;h+=2048)for(let p=48;p<=64;p+=8)this.fixed.add(u+(h|p));return{ok:!0,value:void 0}}extract(s,e,{h:t=3,w:i=3,replace:r=void 0}={}){let o=s.index(e),a="",l=o+t*s.row,{row:f}=s;for(let d=o;d<l;d+=f)for(let c=d;c<d+i;c++){if(r){let u=r.get(s.coord(c));if(u!=null){a+=u||" ";continue}}a+=s.data[c]||" "}return a}canSet(s,e){return this.canSetAll(new Map([[s,e]]))}canSetAll(s){let e=new Set;for(let t of s.keys()){if(this.fixed.has(t))return!1;let i=t&-2057,r=i>>>12,o=i>>>4&15;o<this.w&&r<this.h&&e.add(i),!(t&8)&&r<this.h&&o&&e.add(i-16),!(t&2048)&&o<this.w&&r&&e.add(i-4096),!(t&2056)&&o&&r&&e.add(i-4112)}for(let t of e){let i=this.extract(this.grid,t,{replace:s});if(!this.orig.tileset.getMetascreensFromTileString(i).length)return!1}return!0}addAllFixed(){for(let s=0;s<this.grid.data.length;s++)this.grid.data[s]&&this.fixed.add(this.grid.coord(s))}};var[]=[V],k=class extends qt{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let t={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let i of e.rom.locations[e.id].spawns)i.isMonster()&&i.monsterId===143&&t.features.statue++;for(let i of e.allPos()){let r=e.get(i);(!r.isEmpty()||r.data.exits?.length)&&t.size++;for(let o of r.data.exits??[]){let{type:a}=o;if(a==="edge:top"){i>>>4===0&&t.edges[0]++;continue}else if(a==="edge:left"){(i&15)===0&&t.edges[1]++;continue}else if(a==="edge:bottom"){i>>>4===e.height-1&&t.edges[2]++;continue}else if(a==="edge:right"){(i&15)===e.width-1&&t.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);t.stairs[o.dir>>>1]++;continue}}}r.hasFeature("arena")&&t.features.arena++,r.hasFeature("bridge")&&t.features.bridge++,r.hasFeature("overpass")&&t.features.over++,r.hasFeature("pit")&&t.features.pit++,r.hasFeature("ramp")&&t.features.ramp++,r.hasFeature("spikes")&&t.features.spike++,r.hasFeature("underpass")&&t.features.under++,r.hasFeature("wall")&&t.features.wall++,r.hasFeature("river")&&t.features.river++,r.hasFeature("wide")&&t.features.wide++}return t.size<2&&(e.width>1||e.height>1)&&(t.size=2),t}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let t=this.inferScreens();return t.ok?(e=this.refineMetascreens(t.value),!e.ok||(e=this.checkMetascreens(t.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(t.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=t.value,T)):t}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:T):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),T}fillCave(e){for(let t=.5;t<this.h;t++)for(let i=.5;i<this.w;i++)t>1&&this.grid.set2(t-.5,i,e),i>1&&this.grid.set2(t,i-.5,e),this.grid.set2(t,i,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return T;for(let e=0;e<4;e++){let t=this.params.edges[e]||0;if(!t)continue;let i=te(e&1?this.h:this.w,r=>this.grid.border(e,r));for(let r of this.random.ishuffle(i))if(!this.grid.get(r)&&(e&1?e===1?this.addLeftEdge(r)&&t--:this.addRightEdge(r)&&t--:e===0?this.addUpEdge(r)&&t--:this.addDownEdge(r)&&t--,!t))break;if(t)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${t} ${e}`}}return T}addUpEdge(e){let t=e+2048,i=t-8,o=i-8-8,a=t+8,f=a+8+8;if(this.grid.isBorder(i)){if(this.grid.get(i))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(f)&&this.grid.get(f))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(i,""),this.grid.set(a,""),!0}addDownEdge(e){let t=e-2048,i=t-8,r=t+8;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(i,""),this.grid.set(r,""),!0)}addLeftEdge(e){let t=e+8,i=t-2048,r=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let t=e-8,i=t-2048,r=t+2048;return!this.grid.get(t)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(r)&&this.grid.get(r)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?T:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?T:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056;if(!this.isEligibleArena(r))continue;let o=this.extract(this.grid,i),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(r),t.set(r,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let t=this.grid,i=e-8,r=i-8,o=e+8,a=o+8;return!(t.get(e)!=="c"&&t.get(e)!=="w"||t.get(i)||t.get(o)||!t.isBorder(i)&&t.get(r)||!t.isBorder(o)&&t.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let t=0;for(;e;){let i=this.random.nextInt(this.h-2)+1,r=this.random.nextInt(this.w-2)+1,o=i<<12|r<<4|2056;if(this.grid.get(o)!=="c"){if(++t>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,t,i){if(!e)return!0;for(let r of this.random.ishuffle(this.grid.screens())){let o=r|2056;if(this.grid.get(o)!=="c")continue;if(i){let d=o-i,c=o+i;if(this.grid.get(d)||this.grid.get(c))continue}let a=this.extract(this.grid,r),l=a.substring(0,4)+t+a.substring(5);if(!!this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,t),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let t=0;for(;e>0;){if(++t>20)return!1;let i=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;i<e-1&&i>this.minSpikes;)this.random.next()<.2&&i--;let r=i>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);i>e-this.minSpikes&&(i>=this.h-2?i=this.h-2:i=e);let a=this.random.nextInt(this.h-i-2)+1<<12|r<<4|2056,l=a+(i-1<<12);for(let c=a-4096;i&&c<=l+4096;c+=2048)this.grid.get(c)!=="c"&&(i=0);if(!i)continue;let f=[a-8,a+8,l-8,l+8],d=this.tryClear(f);if(!!d.length){for(let c of d)this.grid.set(c,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let c=a;c<=l;c+=2048)this.fixed.add(c),this.grid.set(c,"s");e-=i,t=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let t=new Map;for(let f of e){if(this.fixed.has(f))return[];t.set(f,"")}let i=this.grid.partition(t),[r]=i.values();if(r.size===i.size)return[...e];let o=new Set,a=new Set(i.values());for(let f of this.fixed)o.add(i.get(f));if(o.size>this.maxPartitions)return[];let l=[...e];for(let f of a)o.has(f)||l.push(...f);return l}refine(){let e=new Set;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]&&e.add(this.grid.coord(i));let t=0;for(;this.count>this.size;){if(t++>50)throw new Error("refine failed: attempts");let i=0;for(let r of this.random.ishuffle([...e])){if(this.grid.isBorder(r)||!this.canRemove(this.grid.get(r))||this.fixed.has(r))continue;if(i>3)break;let o=this.grid.partition(this.removalMap(r)),[a]=o.values();if(a.size===o.size&&o.size>1)i++,e.delete(r),(r&2056)===2056&&this.count--,this.grid.set(r,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let f=[...l].filter(d=>(d&2056)==2056).length;if(f<this.size)continue;i++,e=l,this.count=f,this.grid.set(r,"");for(let[d,c]of o)c!==l&&this.grid.set(d,"")}}if(!i)return this.looseRefine?T:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return T}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let t=this.grid.partition(new Map),i=t.size,r=new Set(t.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===r)&&a.size===i-1&&(i--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|2056|t<<4;if(this.grid.get(i))continue;let r=i-2048,o=i+2048,a=i-8,l=i+8;(this.grid.get(r)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(r,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let t=e<<12|2048;for(let i=0;i<this.w-1;i++){let r=t|i<<4|8;this.isTightLoop(r)&&this.breakTightLoop(r)}}}isTightLoop(e){for(let t=0;t<6144;t+=2048)for(let i=0;i<24;i+=8){let r=t|i;if(r!==2056&&this.grid.get(e+r)!=="c")return!1}return!0}breakTightLoop(e){let t=this.random.nextInt(65536),i=t&1?t&4096|8:t&16|2048;this.grid.set(e+i,"")}addStairs(e=0,t=0){let i=[e,t];if(!i[0]&&!i[1])return T;for(let r of this.random.ishuffle(this.grid.screens()))if(!!this.tryAddStair(r,i)&&!i[0]&&!i[1])return T;return{ok:!1,fail:"stairs"}}addEarlyStair(e,t){let i=[],r=e-8,o=e+8,a=e-2048,l=e+2048,f=[e-8,e+8];if(t==="<"){if(f.push(l),i.push([a,""]),this.grid.get(r)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return i.push([l,""],[e,"<"]),i}else t===">"&&(f.push(a),i.push([l,""]));if(f=f.filter(c=>this.grid.get(c)==="c"),!f.length)return[];let d=this.random.nextInt(f.length);for(let c=0;c<f.length;c++)c!==d&&i.push([f[c],""]);return i.push([e,t]),i}tryAddStair(e,t){if(this.fixed.has(e|2056))return!1;let i=this.extract(this.grid,e),r=t[0]&&t[1],o=t[0]+t[1],a=this.random.nextInt(o)<t[0],l=[a?0:1];r&&l.push(a?1:0);for(let f of l){let d="<>"[f],c=i.substring(0,4)+d+i.substring(5);if(this.orig.tileset.getMetascreensFromTileString(c).length)return this.grid.set(e|2056,d),t[f]--,!0}return!1}tryConnect(e,t,i,r=1){for(;r-- >0;){let o=new Map,a=e;if((e&t&2056)!==2056)throw new Error(`bad start ${V(e)} or end ${V(t)}`);for(o.set(a,i);a!==t;){let l=[];for(let h of[8,-8,2048,-2048]){let p=a+h,m=a+2*h;this.fixed.has(m)||(o.get(m)??this.grid.get(m))||this.grid.isBorder(p)||l.push(h)}if(!l.length)break;let f=(t>>12)-(a>>12),d=(t&240)-(a&240),c=new Set(l);f<0&&c.delete(2048),f>0&&c.delete(-2048),d<0&&c.delete(8),d>0&&c.delete(-8),l.push(...c,...c);let u=this.random.pick(l);o.set(a+u,i),o.set(a=a+2*u,i)}if(a===t){for(let[l,f]of o)this.grid.set(l,f),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,t=1){let i=new pe;for(let l=0;l<this.grid.data.length;l++){let f=this.grid.coord(l);this.grid.get(f)||this.grid.isBorder(f)||(this.grid.get(Ce(f))||i.union([f,Ce(f)]),this.grid.get(Q(f))||i.union([f,Q(f)]))}let r=new D(()=>[]);for(let l of this.grid.screens()){let f=l+2056;if(!!this.grid.get(f))for(let d of[8,-8,2048,-2048]){let c=f+d;if(this.grid.isBorder(c)||this.grid.get(c))continue;let u=f+2*d;if(this.grid.get(u))continue;let h=new Map([[c,e]]),p=this.extract(this.grid,l,{replace:h});this.orig.tileset.getMetascreensFromTileString(p).length&&r.get(i.find(u)).push([c,u])}}let o=new Map;for(let l of r.values())if(!(l.length<2))for(let[f]of l)o.set(f,l);let a=[...o.values()];if(!a.length)return!1;for(;t-- >0;){let l=this.random.pick(a),[[f,d],[c,u]]=this.random.ishuffle(l);if(this.grid.set(f,e),this.grid.set(c,e),this.tryConnect(d,u,e,5))return!0;this.grid.set(f,""),this.grid.set(c,"")}return!1}tryExtrude(e,t,i=1){for(;i--;)for(let r of this.random.ishuffle(this.grid.screens())){let o=r+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,r);for(let l of this.random.ishuffle([0,1,2,3])){let f=o+ft[l],d=o+2*ft[l];if(this.grid.get(f)||this.grid.isBorder(f)||this.grid.get(d))continue;let c=Fs[l],u=a.substring(0,c)+e+a.substring(c+1);if(this.orig.tileset.getMetascreensFromTileString(u).length){this.grid.set(f,e),this.grid.set(d,e);let h=this.tryContinueExtrude(e,t,d);if(h)return h;this.grid.set(d,""),this.grid.set(f,"")}}}return 0}tryContinueExtrude(e,t,i){let r=this.extract(this.grid,i-2056),o=this.orig.tileset.getMetascreensFromTileString(r).length>0;if(t===1)return o?1:0;if(o&&!this.random.nextInt(t))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=i+ft[a],f=i+2*ft[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(f))continue;let d=Fs[a],c=r.substring(0,d)+e+r.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(c).length){this.grid.set(l,e),this.grid.set(f,e);let u=this.tryContinueExtrude(e,t-1,f);if(u)return u+1;this.grid.set(f,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let t=this.orig.tileset,{attempts:i=1,char:r="c",start:o,loop:a=!1}=e;for(let l=0;l<i;l++){let f=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of f){let c=d+2056;if(!this.grid.get(c))continue;let u=this.extract(this.grid,d);for(let h of this.random.ishuffle([0,1,2,3])){let p=c+ft[h],m=c+2*ft[h];if(this.fixed.has(p)||this.fixed.has(m))continue;let g=this.grid.get(p),C=this.grid.get(m);if(g&&(C||g!==r)||this.grid.isBorder(p))continue;if(!a){let x=this.extract(this.grid,m-2056,{replace:new Map([[p,""]])});if(/\S/.test(x))continue}let b=Fs[h],w=u.substring(0,b)+r+u.substring(b+1);if(t.getMetascreensFromTileString(w).length){this.count++,this.grid.set(p,r),this.grid.set(m,r);let x=this.extract(this.grid,m-2056);if(t.getMetascreensFromTileString(x).length)return 1;this.grid.set(m,C),this.grid.set(p,g),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:T}preinferSpikes(){return T}inferScreens(){let e=[];for(let r of this.grid.screens()){let o=this.extract(this.grid,r),a=this.orig.tileset.getMetascreensFromTileString(o).filter(f=>!f.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${V(r)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let t=!0,i=new xe(this.params.id,this.orig.tileset,this.h,this.w);for(let r=0;r<this.h;r++)for(let o=0;o<this.w;o++){let a=e[r*this.w+o];if(i.set(r<<4|o,a),a.isEmpty()||(t=!1),r){let l=i.get(r-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${r}${o}: ${l.name} ${a.name}`}}if(o){let l=i.get(r<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${r}${o}: ${l.name} ${a.name}`}}}return t?{ok:!1,fail:"all screens empty"}:{ok:!0,value:i}}refineMetascreens(e){let t=this.params.features?.bridge||0,i=this.params.features?.wall||0;for(let r of this.random.ishuffle(e.allPos())){let o=(r<<8|r<<4)&61680,a=this.extract(this.grid,o),l=e.get(r);if(!(this.bridges<=t&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<i&&!l.hasFeature("wall")&&this.tryMeta(e,r,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==t?{ok:!1,fail:`refineMeta bridges want ${t} got ${this.bridges}
${e.show()}`}:this.walls!==i?{ok:!1,fail:`refineMeta walls want ${i} got ${this.walls}
${e.show()}`}:T}tryMeta(e,t,i){for(let r of i)if(!!this.checkMeta(e,new Map([[t,r]])))return e.set(t,r),!0;return!1}checkMeta(e,t){let i=t?{with:t}:{},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let t=!1,i=!1;for(let r of e.allPos()){let o=e.get(r);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(t=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(i=!0),t&&i)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return T;let t=0;for(let i of e.allPos()){let r=e.get(i);t+=r.data.statues?.length||0}return t<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:T}},et=class extends k{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,t=super.addEdges();if(!t.ok)return t;let i=this.params.features?.arena;if(!i)return T;let r=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&r.push(a)}if(r.length<i)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(r)){if(!i)break;let a=o-8,l=a-8,f=l-8,d=l-2048,c=l+2048,u=o+8,h=u+8,p=h+8,m=h-2048,g=h+2048;!e.isBorder(a)&&(e.isBorder(f)&&e.get(f)||e.isBorder(d)&&e.get(d)||e.isBorder(c)&&e.get(c))||!e.isBorder(u)&&(e.isBorder(p)&&e.get(p)||e.isBorder(m)&&e.get(m)||e.isBorder(g)&&e.get(g))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(u,""),e.set(h,""),this.grid.set(o,"a"),i--)}return T}addArenas(){return!0}},Ut=class extends k{refineMetascreens(s){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)this.grid.get(e<<12|t<<4|2056)==="a"&&s.set(e<<4|t,s.rom.metascreens.cryptArena_statues);return super.refineMetascreens(s)}isEligibleArena(s){return!this.grid.get(s-2048)&&super.isEligibleArena(s)}},Fs=[1,3,7,5],ft=[-2048,-8,2048,8];function jt(n,s,e=!1){let t=new As(n,s,e),i=new Gs(s,t,e);return[t,i]}var Gs=class extends k{constructor(e,t,i){super(e);this.location=e;this.under=t;this.reverse=i;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,t]of se.zip(this.under.upStairs,this.downStairs))this.meta.attach(t,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let t=16,i=0,r=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let f=l>>>4,d=l&15;t=Math.min(d,t),i=Math.max(d,i),r=Math.min(f-a,r),o=Math.max(f+a,o)}e:for(let l=0;l<10;l++){let f=[],d=this.random.nextInt(this.w-(i-t))+t,u=this.random.nextInt(this.h-(o-r))+r-r<<4+(d-t);for(let h of this.under.underBridges){let p=h+u,m=p>>>4,g=p&15,C=m<<12|g<<4|2056;if(this.grid.get(C)!=="c")continue e;f.push([C,"b"]),f.push([C-8,""]),f.push([C+8,""])}for(let h of this.under.upStairsEffective){let p=h+u,m=p>>>4,g=p&15,C=m<<12|g<<4|2056;if(this.grid.get(C)!=="c")continue e;f.push([C,this.reverse?"<":">"]),f.push([C+(this.reverse?-2048:2048),""]);let b=this.addEarlyStair(C,this.reverse?"<":">");if(!b.length)continue e;f.push(...b)}for(let[h,p]of f)p&&this.fixed.add(h),(p==="<"||p===">")&&this.downStairs.push(Fi(h)),this.grid.set(h,p);return T}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,t=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,t):super.addStairs(e,t-this.under.upStairs.length)}addOverpasses(){return!0}},As=class extends k{constructor(e,t,i){super(e);this.loc=e;this.overpass=t;this.reverse=i;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let t=this.reverse?"stair:down":"stair:up";for(let r of this.meta.allPos()){let o=this.meta.get(r);if(o.hasFeature("underpass")&&this.underBridges.push(r),o.hasFeature(t)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(r+a),this.upStairs.push(r)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let i=0;for(let[,r,[o]]of this.orig.exits())r===t&&o>>>8===this.overpass.id&&i++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,i),T}};var tt=class extends k{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let i=0;i<this.h;i++)for(let r=0;r<this.w;r++){let o=i<<12|r<<4|2056;this.grid.get(o)&&e.push(o)}let t=e.filter(i=>this.tryClear([i]).length===1);if(!t.length)return{ok:!1,fail:"all critical?"};for(let i=0;i<t.length;i++)for(let r=0;r<i;r++)if(this.tryClear([t[i],t[r]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},Kt=class extends tt{removeTightLoops(){}};var Le=class{constructor(s,e,t){this.h=s;this.w=e;this.valid=t;this.fixed=new Set;this.size=0;this.data=new Uint8Array(s*e)}fill(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e;s>0&&(this.data[t]|=1),e>0&&(this.data[t]|=2),s<this.h-1&&(this.data[t]|=4),e<this.w-1&&(this.data[t]|=8)}}isBorder(s,e){let t=s%this.w,i=(s-t)/this.w;return this.isBorder2(i,t,e)}isBorder2(s,e,t){if(t===0)return!s;if(t===1)return!e;if(t===2)return s>=this.h-1;if(t===3)return e>=this.w-1;throw new Error("bad direction")}delete2(s,e,t=s*this.w+e){if(this.fixed.has(t))return!1;let i=new Map;i.set(t,0);for(let r=0;r<4;r++){if(this.isBorder2(s,e,r))continue;let o=t+this.delta(r),a=this.data[o],l=a&~(1<<(r^2));if(a!==l){if(this.fixed.has(o))return!1;i.set(o,l)}}return this.try(i)}delete(s){let e=s%this.w,t=(s-e)/this.w;return this.delete2(t,e,s)}deleteEdge2(s,e,t,i=s*this.w+e){if(this.fixed.has(i))return!1;if(this.isBorder2(s,e,t))return this.data[i]&=~(1<<t),!0;let r=new Map,o=i+this.delta(t);return this.fixed.has(o)?!1:(r.set(i,this.data[i]&~(1<<t)),r.set(o,this.data[o]&~(1<<(t^2))),this.try(r))}deleteEdge(s,e){let t=s%this.w,i=(s-t)/this.w;return this.deleteEdge2(i,t,e,s)}refine(s,e){let t=0,i=new Set;for(let r=0;r<this.data.length;r++)this.data[r]&&t++,this.fixed.has(r)||i.add(r);for(;t>e;){let r=!1;for(let o of s.ishuffle(i)){if(t<=e)break;if(!this.data[o]){t--;continue}this.delete(o)&&(r=!0,t--)}if(!r)return!1}return!0}validate(){for(let s=0;s<this.h;s++)for(let e=0;e<this.w;e++){let t=s*this.w+e,i=this.data[t];if(s&&!(this.data[t-this.w]&4)!=!(i&1))throw new Error(`invalid above ${s}${e}`);if(e&&!(this.data[t-1]&8)!=!(i&2))throw new Error(`invalid left of ${s}${e}`)}}addEdge(s,e,t){let i=s*this.w+e;this.data[i]|=1<<t,this.isBorder2(s,e,t)||(this.data[i+this.delta(t)]|=1<<(t^2))}consolidate(s,e){let t=new ks;for(let r=0;r<this.data.length;r++)!this.fixed.has(r)&&this.data[r]&&t.add(this.data[r]);let i=1e3;for(;t.unique()>e&&--i;){let r=[...t].sort((f,d)=>d[1]-f[1]),o=r[e][1],a=new Set(r.filter(f=>f[1]<=o).map(f=>f[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[f,d]of s.pick(l))this.data[f]&&t.delete(this.data[f]),d&&t.add(d),this.data[f]=d}return i?[...t].map(r=>r[0]):[]}consolidateFixed(s,e){let t=new ks;for(let r=0;r<this.data.length;r++){let o=this.data[r];!this.fixed.has(r)&&e.has(o)&&t.add(o)}let i=1e3;for(;t.unique()&&--i;){let r=this.findEligibleConsolidates(e);if(!r.length)return!1;for(let[o,a]of s.pick(r)){let l=this.data[o];e.has(l)&&t.delete(l),e.has(a)&&t.add(a),this.data[o]=a}}return!!i}findEligibleConsolidates(s){let e=[],t=[];for(let i=0;i<this.data.length;i++){if(this.fixed.has(i))continue;let r=this.data[i];if(!!s.has(r))for(let o=0;o<4;o++){if(this.isBorder(i,o))continue;let a=this.delta(o);if(this.fixed.has(i+a))continue;let l=1<<o;if(s.has(r^l))continue;let f=1<<(o^2),d=this.data[i+a],c=new Map([[i,r^l],[i+a,d^f]]);if(!!this.check(c)&&(e.push(c),!s.has(d^f)&&s.has(d))){t.push(c);break}}}return t.length?t:e}try(s){if(!this.check(s))return!1;for(let[e,t]of s)this.data[e]=t;return!0}check(s){let e=new pe;for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let r=t*this.w+i,o=s?.get(r)??this.data[r];o&&e.union([r]),t>0&&o&1&&e.union([r,r-this.w]),i>0&&o&2&&e.union([r,r-1]),t<this.h-1&&o&4&&e.union([r,r+this.w]),i<this.w-1&&o&8&&e.union([r,r+1])}return e.roots().length===1}addPath(s,e){let t,i;if(!this.size)t=s.nextInt(this.h),i=s.nextInt(this.w);else{let f=[];for(let c=0;c<this.data.length;c++)this.data[c]&&this.data[c]!==15&&f.push(c);if(!f.length)return!1;let d=s.pick(f);i=d%this.w,t=(d-i)/this.w}let r=new Map,o=t*this.w+i,a=0,l=!0;for(;;){let f=!1,d=r.get(o)??this.data[o],c=!1;for(let u of s.ishuffle([0,1,2,3])){let h=1<<u;if(d&h)continue;let p=d|h;if(this.valid&&!this.valid.has(p))continue;let m=t+jr[u],g=i+Kr[u];if(m<0||g<0||m>=this.h||g>=this.w)continue;let C=m*this.w+g,b=r.get(C)??this.data[C],w=b|1<<(u^2);if(b){if(b===w||this.valid&&!this.valid.has(w))continue;f=!0}l=!this.valid||this.valid.has(w),r.set(o,p),r.set(C,w),i=g,t=m,o=C,c=!0;break}if(!c||f||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&s.nextInt(15)<a++)break}if(!r.size||!l)return!1;for(let[f,d]of r)this.data[f]=d;return!0}toGrid(s){let e=new Te(this.h,this.w);for(let t=0;t<this.h;t++)for(let i=0;i<this.w;i++){let r=t*this.w+i,o=this.data[r];if(!o)continue;let a=t<<12|i<<4|2056;e.set(a,s);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let f=l&1?8:2048;e.set(l&2?a+f:a-f,s)}}return e}delta(s){return(s&2?1:-1)*(s&1?1:this.w)}show(){let s=[];for(let e=0;e<this.h;e++){let t="";for(let i=0;i<this.w;i++)t+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+i]];s.push(t)}return s.join(`
`)}},Vt=class{constructor(s,e,t){this.grid=s;this._i=e*s.w+t}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(s){let e=this.grid.delta(s),t=this._i+e,i=1<<s,r=1<<(s^2);this.grid.data[this._i]|=i,this.grid.data[this._i=t]|=r}directedPath(s,e,t){for(;;){let i=this.y,r=this.x,o=[];if(e<i&&o.push(0),t<r&&o.push(1),e>i&&o.push(2),t>r&&o.push(3),!o.length)return;this.go(s.pick(o))}}},jr=[-1,0,1,0],Kr=[0,-1,0,1];var Tt=class extends k{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(t=>this.grid.get(t+2056)).length,T)}initialFillEarly(){let e=new Le(this.h,this.w,this.getValidEarlyScreens()),t=0,i=this.targetEarly();for(;t++<20&&e.size<i;)e.addPath(this.random,i)&&(t=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),T}initialFillLate(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){let i=e<<12|t<<4|2056;this.grid.get(i)||this.grid.set(i,"c")}for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++)for(let i of[8,2048]){let r=e<<12|t<<4|2056,o=r+i,a=r+2*i;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(r)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let t of[8,2048]){let i=e|2056,r=i+t,o=i+2*t;if(this.grid.isBorder(r)||this.grid.get(r))continue;this.grid.set(r,"c");let a=this.extract(this.grid,i-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(r,"")}return T}pruneDisconnected(){let e=new Set(this.grid.partition().values()),t=0;for(let i of e)if([...i].some(o=>this.grid.get(o)===this.early))t+=[...i].filter(o=>(o&2056)===2056).length;else for(let o of i){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${V(o)} disconnected`};this.grid.set(o,"")}return t<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):T}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let t of this.orig.tileset){let i=t.edgeIndex(this.early);i!=null&&e.add(i)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},Xt=class extends Tt{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new Le(this.h,this.w);e.fill();let t=te(e.data.length).slice(e.w),i=this.random.pick(t);if(!e.deleteEdge(i,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,3))return{ok:!1,fail:"initial stair"};e.fixed.add(i);let r=new Set(t);r.delete(i);let o=[];for(let d of this.random.ishuffle(r)){let c=function(g){return e.delete(g)?(e.fixed.add(g),!0):!1},u=this.params.features?.arena??0;if(o.length>=u)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let h=!e.isBorder(d,1),p=!e.isBorder(d,3);if(h&&e.fixed.has(d-1)||p&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!c(d-e.w))return{ok:!1,fail:"initial arena"};if(h&&!c(d-1))return{ok:!1,fail:"initial arena"};if(p&&!c(d+1))return{ok:!1,fail:"initial arena"};let m=d+e.w;if((e.data[m]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(m+e.w,2),e.fixed.add(m),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,c)=>{let u=d%e.w,p=(d-u)/e.w<<12|u<<4|2056;this.grid.set(p,c);for(let m of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(p+m)};l(i,">");for(let d of o)l(d,"a");let f=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&f++;return this.size=f,T}addStairs(e,t){return super.addStairs(e,t?t-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let t=e<<12|2056;for(let i=0;i<this.w;i++){let r=t|i<<4;this.grid.get(r)==="a"&&this.grid.set(r-2048,"c")}}return T}preinfer(){let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="w"&&e.set(this.grid.coord(r),"");let t=this.grid.partition(e),i=new Set;for(let[r,o]of t)this.grid.get(r)==="<"&&i.add(o);return i.size<2?{ok:!1,fail:"stairs bunched"}:T}refineMetascreens(e){for(let t of e.allPos())e.get(t).hasFeature("arena")&&e.set(t,e.rom.metascreens.fortressArena_through);return T}refineEdges(){return!0}};var _e=class extends Tt{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return T;let e=new Map;for(let r=0;r<this.grid.data.length;r++)this.grid.data[r]==="r"&&e.set(this.grid.coord(r),"");let t=this.grid.partition(e),i=[];for(let r=0;r<this.grid.data.length;r++)(this.grid.data[r]==="<"||this.grid.data[r]===">"||this.grid.data[r]&&this.grid.isBorder(this.grid.coord(r)))&&i.push(t.get(this.grid.coord(r)));return new Set(i).size<i.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return T}addArenas(e){if(!e)return!0;let t=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let r=i|2056,o=r-8,a=o-8,l=r+8,f=l+8,d=r-2048,c=r+2048;if(t.get(r)!=="c"||t.get(d)!=="c"||t.get(c)!=="c")continue;let u=t.isBorder(o)?"":this.extract(t,a-2056),h=t.isBorder(l)?"":this.extract(t,f-2056);if(!/[^ c]/.test(u+h)&&(t.isBorder(o)||(t.set(o,""),t.set(a,""),t.set(a-8,""),t.set(a-2048,""),t.set(a+2048,"")),t.isBorder(l)||(t.set(l,""),t.set(f,""),t.set(f+8,""),t.set(f-2048,""),t.set(f+2048,"")),this.fixed.add(r),this.fixed.add(d),this.fixed.add(c),t.set(r,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},Yt=class extends _e{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new Le(this.h,this.w,this.getValidEarlyScreens()),t=2+this.random.nextInt(this.w-4),i=2+this.random.nextInt(this.w-4),r=new Vt(e,this.h-1,i);return r.go(0),r.directedPath(this.random,1,t),r.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),T}addEdges(){let e=-1,t=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(t|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let i=t|this.random.nextInt(e)<<4,r=t|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.grid.set(r,">"),this.grid.set(r-8,""),this.grid.set(r+8,""),this.fixed.add(i),this.fixed.add(r),T}addStairs(){return T}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}},Zt=class extends k{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new D(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let c=0;for(let u=0;u<4;u++)d.data.edges[u]==="s"&&(c|=1<<u);e.get(c).push(...d.gridTiles())}let t=1+this.random.nextInt(this.w-2),i=1+this.random.nextInt(this.h-2),r=i<<4|t,o=this.posToGrid(r,2056),a=i<this.h/2?2:0;this.insertTile(r,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){r+=Vr[a],o=o+Ps[a];let c=a^2,u=[];for(let[p,m]of e){if(!(p&1<<c))continue;let g=p&~(1<<c);if(!(d?!g:g))for(let C of m)u.push(p)}let h;for(let p of this.random.ishuffle(u))if(!this.grid.isBorder(o+Ps[p])&&this.insertTile(r,this.random.pick(e.get(p)))){h=31-Math.clz32(p&~(1<<c));break}if(h==null)return{ok:!1,fail:"spikes"};a=h}let l=[];for(let d=3;d<this.h-3;d++)for(let c=1;c<this.w-1;c++)l.push(d<<12|c<<4|2056);let f=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let c of Ps){if(this.grid.get(d+c)!=="c")continue;this.grid.set(d,"r");let u=2056&~Math.abs(c);this.grid.set(d+u,"r"),this.grid.set(d-u,"r");let h=this.random.pick([-u,u]);this.grid.set(d+2*h,"r"),this.grid.set(d+3*h,"r"),this.grid.set(d+2*h-c,"c"),f=!0;break}if(f)break}if(!f)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return T}checkMeta(e,t){let i=t?{flight:!0,with:t}:{flight:!0},r=e.traverse(i);return new Set(r.values()).size===this.maxPartitions}refine(){return T}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){return[...new Set(a.values())].filter(f=>{for(let d of f)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:T}},Ps=[-2048,-8,2048,8],Vr=[-16,-1,16,1],Jt=class extends _e{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],t=0;for(let l of this.random.ishuffle(te(this.w-2,f=>f+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let f=this.h-1<<12|l<<4|2056;if(this.grid.set(f,"c"),this.grid.set(de(f),"c"),this.grid.set(Q(f),"n"),this.fixed.add(f),this.fixed.add(de(f)),this.fixed.add(Q(f)),e.push(l),t++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let i=this.w,r=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*r+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;i<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};i+=l,t+=l}let a=this.params.size;for(;t<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};t+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let t=super.refineMetascreens(e);if(!t.ok)return t;function i(l){let f=0;for(let d of new Set(l.values()))for(let c of d)if(e.exitType(c)==="edge:bottom"){f+=d.size;break}return f}let r=i(e.traverse({noFlagged:!0})),o=i(e.traverse());if(r===o)return{ok:!1,fail:"bridge didn't matter"};let a=i(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:T}},Qt=class extends _e{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let r=0;r<this.grid.data.length;r++)if(this.grid.data[r]==="r"){e=this.grid.coord(r)-2056;break}if(e==null)throw new Error("no corner");let t=[];for(let r=0;r<this.pattern.length;r++)for(let o=1;o<this.pattern[r].length-1;o++)!((o^r)&1)||this.pattern[r][o]===" "&&t.push(e+(r<<11|o<<3));let i=this.random.shuffle([..."ccrrrrrrrr"]);for(let r of this.random.ishuffle(t)){let o=i[i.length-1];if(!(o==="c"&&[...this.extract(this.grid,r-2056)].filter(a=>a==="r").length<4)&&(this.canSet(r,o)&&this.grid.set(r,i.pop()),!i.length))break}for(let r=0;r<6;r++)this.tryAdd({char:"c"});return T}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let r=this.addStairs(...e);if(!r.ok)return r}let t=0;for(let r of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,r).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(r+8)&&(this.grid.set(r+2056,"<"),e[0]--),this.fixed.add(r+2056),++t>=2))break;let i=this.grid.partition();return new Set(i.values()).size>1?{ok:!1,fail:"orphans"}:T}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:T}checkMeta(e,t){let i=e.traverse(t?{with:t}:{}),r=[];for(let o of new Set(i.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;r.push(a)}return r.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let t=super.refineMetascreens(e);if(!t.ok)return t;function i(a){let l=0;for(let f of new Set(a.values()))for(let d of f)if(e.exitType(d)){l+=f.size;break}return l}let r=i(e.traverse()),o=i(e.traverse({flight:!0}));return r===o?{ok:!1,fail:"flight not required"}:T}};var es=class extends k{build(){let{h:s,w:e}=this,t=this.orig.rom,i=new Le(s,e);i.fill();let r=s*e<28?0:this.random.nextInt(s-1),o=this.random.nextInt(e),a=new Set;function l(y,I){i.delete2(y,I),a.add(y*i.w+I)}function f(y){return!y.startsWith("edge")}a.add(r*i.w+o),o&&l(r,o-1),o<i.w-1&&l(r,o+1),r&&(l(r-1,o),o&&l(r-1,o-1),o<i.w-1&&l(r-1,o+1));for(let y of a)i.fixed.add(y);let d=new Set;for(let y=0;y<4;y++){let I=y&1?s:e,G=this.random.shuffle(te(I)),K=y&2?I:0,Y=this.params.edges?.[y]??0;for(;Y&&G.length;){let J=y&1?G.pop():K,oe=y&1?K:G.pop(),U=J*i.w+oe;!i.data[U]||i.fixed.has(U)||(i.addEdge(J,oe,y),d.add(J<<4|oe),Y--)}if(Y)return{ok:!1,fail:`could not add all edges: ${y} ${Y}
${i.toGrid("c").show()}
${i.data}`}}let c=0,u=i.h*i.w*(this.random.next()*.15+.4);for(let y of this.random.ishuffle(te(i.data.length<<2))){let I=y>>>2,G=y&3;if(!i.isBorder(I,G)&&i.deleteEdge(I,G)&&++c>=u)break}let h=new Set,p=new Set,m=[],g=[],C;for(let y of this.orig.tileset){if(y.hasFeature("arena")){C=y;continue}else if(y.hasFeature("empty")){m[0]=y;continue}let I=y.edgeIndex("s");if(I==null)throw new Error("bad edges");let G=y.data.exits?.some(K=>f(K.type));(G?g:m)[I]=y,(y.sid<0?p:h).add(y.sid)}if(!C)throw new Error("never found arena");let b=i.consolidate(this.random,h.size),w=new Set(b.map(y=>m[y].sid));if(!w.size)return{ok:!1,fail:"consolidate failed"};let x=[...p].filter(y=>w.has(y)),v=[...h].filter(y=>!w.has(y));if(x.length>v.length)throw new Error("out of space");if(x.length){let y=-1;for(;t.metascreens.getById(y).length;)y--;let I=y;for(let G=0;G<x.length;G++)t.metascreens.renumber(v[G],y),t.metascreens.renumber(x[G],v[G]),y=x[G];t.metascreens.renumber(I,x[x.length-1])}let E=new xe(this.orig.id,this.orig.tileset,s,e);for(let y=0;y<i.h;y++)for(let I=0;I<i.w;I++){let G=y===r&&I===o;E.set(y<<4|I,G?C:m[i.data[y*i.w+I]])}let M=[...this.orig.exits()].filter(y=>f(y[1])).length;for(let y of this.random.ishuffle(E.allPos())){if(!M)break;if(d.has(y))continue;let I=y&15,G=y>>>4,K=g[i.data[G*i.w+I]];!K||(E.set(y,K),M--)}return M?{ok:!1,fail:"could not place all doors"}:T}};function Gi(n){let{swamp:s}=n.metatilesets,e=n.metascreens,t=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[i,r,o]of t)s.getTile(i).copyFrom(r).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var ts=class extends k{initialFill(){let e=this.size+3,t=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(qe(t))||this.fixed.add(qe(t,2)),this.grid.isBorder(Ce(t))||this.fixed.add(Ce(t,2)),this.grid.set(t,">"),this.fixed.add(t),this.grid.set(de(t),"w"),this.fixed.add(de(t)),this.fixed.add(qe(t)),this.fixed.add(Ce(t));let i=this.random.nextInt(this.w)<<4|2056,r=Q(i,2);if(this.grid.set(i,"<"),this.fixed.add(i),this.grid.set(Q(i),"w"),this.fixed.add(Q(i)),this.grid.set(r,"w"),this.fixed.add(r),this.grid.set(Q(r),"w"),this.fixed.add(Q(r)),this.fixed.add(qe(r)),this.fixed.add(Ce(r)),!this.tryConnect(de(t,2),Q(r,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<e;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return T}refine(){return T}refineEdges(){return!0}addArenas(){return!0}addStairs(){return T}refineMetascreens(e){console.log(e.show());for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++){let o=i<<4|r,a=e.get(o),l=a.edgeIndex("w");if(a.hasFeature("arena"))this.arena=o+16<<8|1;else if(l===5){if(o<16||!e.get(o-16).hasFeature("arena")){e.set(o,e.rom.metascreens.goaWideHallNS_stairs);let f=(o<<8|o<<4)&61680|2056;this.grid.set(f,"H")}}else l===1&&(this.stair=o<<8|2)}if(this.reachable=void 0,!this.checkMeta(e))return{ok:!1,fail:"initial meta check"};console.log(e.show());let t=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let i=0;i<e.width;i++)for(let r=0;r<e.height;r++){let o=r<<12|i<<4|2056,a=0;for(;r+a<e.height&&this.grid.get(o+a*4096)==="H";)a++;if(!a)continue;let l=[new Map,new Map];for(let d=0;d<a;d++)l[d&1].set(r+d<<4|i,t);let f=!1;for(let d of this.random.ishuffle(l)){if(!d.size){f=!0;continue}if(!!this.checkMeta(e,d)){for(let[c,u]of d)e.set(c,u),this.grid.set(o+4096*((c>>4)-r),"=");f=!0;break}}if(!f)return{ok:!1,fail:"could not rectify hallway"};r+=a}return super.refineMetascreens(e)}checkMeta(e,t){let i=t?{with:t}:{},r=e.traverse(i),o=r.get(this.stair);return o!==r.get(this.arena)?(console.log(`stair not connected to arena
${e.show()}`),!1):this.reachable==null?o&&o.size<r.size*.95?(console.log("too small"),!1):(this.reachable=o?.size,!0):o?.size>this.reachable*.95}};function Ai(n,s){let{metatilesets:{cave:e,fortress:t,iceCave:i,labyrinth:r,pyramid:o}}=n;n.metascreens.registerFix(14,1);{for(let l of[r,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[t,r,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[i,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);r.getTile(23).copyFrom(198).setAlternative(197),r.getTile(24).copyFrom(196).setAlternative(197)}let a=new D(()=>[]);for(let l of n.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,f]of a){let d=n.screens[l],c=f.map(p=>p.data.tilesets.labyrinth?.removeWall),[u,...h]=new Set(c.filter(p=>p!=null));if(u!=null){if(d.set2d(u,[[197,197],[208,197]]),h.length)throw new Error("bad remove");for(let p=0;p<c.length;p++)c[p]==null&&(f[p].data.tilesets.labyrinth.addWall=[u])}if(!(f.length<2)){if(f.length>2){let p=s.pick(f.filter(m=>m.data.tilesets.labyrinth?.addWall));f.splice(f.indexOf(p),1),p.remove()}for(let p of f){let m=p.data.tilesets.labyrinth?.addWall;if(m!=null){p.data.mod="block";for(let g of m)d.set2d(g,[[23,23],[24,24]])}else p.flag="always"}}}}var ss=class{constructor(s){this.location=s}shuffle(s){if(this.meta)throw new Error("impossible");let e=this.location.meta;Yr(e,s),s.nextInt(2)&&Zr(this.location.rom);let t=[...e.exits()].filter(a=>a[1]==="stair:up"),i=[...e.exits()].filter(a=>a[1]==="stair:down");s.shuffle(t),s.shuffle(i);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?t:i).pop();e.setExit(l[0],l[1],a[2])}if(t.length!==i.length)throw new Error("length mismatch");let r=s.shuffle([...i]);for(let a=0;a<i.length;a++)i[a]===r[a]&&(s.shuffle(r),a=-1);let o=this.location.id<<8;for(let a=0;a<t.length;a++)e.setExitOneWay(t[a][0],t[a][1],[o|i[a][0],i[a][1]]),e.setExitOneWay(r[a][0],r[a][1],[o|t[a][0],t[a][1]]);this.meta=e}finish(){}};function Yr(n,s){let e=s.nextInt(2)+6,t=s.nextInt(3)+2;if(e===7&&t===3)return;let{branchNWSE:i,branchNWE:r,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:f}=n.rom.metascreens,d=e<<4|t,c=o;e===7&&t===1&&(c=f),e===7&&t===5&&(c=l),n.set2d(99,[[i],[i],[i]]),n.set2d(d-16,[[r],[a],[c]]),n.moveExit(115,d)}function Zr(n){let s=n.locations.Pyramid_Draygon.meta,e=n.locations.Pyramid_Main.meta,{metascreens:{hallSE:t,deadEndW_downStair:i,wideHallNE:r,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=n;s.width=2,s.set2d(0,[[null,l],[null,a],[r,o]]),s.moveExit(32,1),e.set2d(3,[[t,i]]),e.moveExit(3,4),e.attach(4,s,1)}function Pi(n,s,e){let t=new Bs(n),i=new Ls(s,t),r=new _s(e,i);return[t,i,r]}var Bs=class extends k{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let t=this.insertPattern(e,{top:1,bottom:1});if(!t.ok)return t;this.addAllFixed();for(let i=0;i<this.grid.data.length;i++){if(this.grid.data[i]!==">")continue;let r=this.grid.coord(i);this.stair=r>>>8&240|r>>>4&15}return T}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let t of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,t)===" c  c  c "){this.grid.set(t+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return T}addLateFeatures(){return T}addStairs(){return T}},Ls=class extends k{constructor(e,t){super(e);this.location=e;this.upper=t;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],t=!0,i=this.upper.meta,r=this.upper.stair;if(i.get(r).isEmpty()||(r+=16,t=!1),r==null)throw new Error("no stair found");for(let x of i.allPos())i.get(x).hasFeature("overpass")&&e.push(x);this.random.shuffle(e);let o=r>>>4,a=r&15,l=a,f=o;for(let x of e){let v=x>>>4,E=x&15;o=Math.min(o,v),a=Math.min(a,E),l=Math.max(l,E),f=Math.max(f,v)}let d=f-o+1,c=l-a+1,u=o<<4|a,h=1+this.random.nextInt(this.w-c-2),m=(this.random.nextInt(this.h-d-(t?1:0))<<4|h)-u,g=(r&15)-a<c/2;r+=m;for(let x=0;x<e.length;x++)e[x]+=m;let C=t?"    <  c ":g?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(r,C)){let x=[-1,1,16,-16,15,17,-15,-17],v=!1;for(let E of this.random.ishuffle(x))if(this.insertTile(r+E,C)){r+=E,v=!0;break}if(!v)throw new Error("Could not insert stair")}this.stair=r,this.addAllFixed(),this.count=3;let b=g?1:-1,w=t?16:b;return!e.includes(r+b)&&!this.tryConnect(this.posToGrid(r+w,2056),this.posToGrid(e[0]-b,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+b,2056),this.posToGrid(e[1]+b,2056),"c",10)?T:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"could not populate"}}refine(){return T}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let t=e+2056;if(!(this.fixed.has(t)||this.grid.get(t))&&!(this.grid.get(qe(t,2))||this.grid.get(Ce(t,2)))&&this.grid.get(Q(t,2))==="c"&&!!this.canSetAll(new Map([[Q(t),"c"],[t,"a"],[de(t),"c"],[de(t,2),"c"]])))return this.grid.set(Q(t),"c"),this.grid.set(t,"a"),this.grid.set(de(t),"c"),this.fixed.add(t),this.fixed.add(de(t,2)),!0}return!1}addStairs(e=0,t=0){return super.addStairs(e-1,t)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,t=this.upper.stair,i=this.stair;t!=null&&i!=null&&this.meta.attach(i,e,t,"stair:up","stair:down")}},_s=class extends k{constructor(e,t){super(e);this.main=t}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let t of e.allPos())if(e.get(t).hasFeature("arena"))return t;throw new Error("never found arena")}initialFill(){let e=this.main.meta,t=this.findArena(e),i=this.posToGrid(t,2056);return this.grid.set(i,"a"),this.grid.set(de(i),"c"),this.grid.set(Q(i),"c"),this.fixed.add(i),this.fixed.add(Q(i)),this.fixed.add(Q(i,2)),T}addEdges(){let e=10,t=2+this.random.nextInt(2);for(;this.count<t&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"addEdges"}}refine(){return T}addLateFeatures(){return T}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let t=e.value,i=this.findArena(t),r=this.main.meta;return t.set(i+15,this.orig.tileset.unreachableVariant(r.get(i+15))),t.set(i+16,this.orig.tileset.unreachableVariant(r.get(i+16))),t.set(i+17,this.orig.tileset.unreachableVariant(r.get(i+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,t=this.findArena(this.meta);super.finishInternal(),e.setExit(t,"seamless:up",[this.meta.id<<8|t,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},Ds=class extends k{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return Te.writeGrid2d(this.grid,0,Ds.PATTERN),this.count=36,T}addSpikes(){let e=this.random.nextInt(4);for(let r=1;r<10;r++)for(let o=0;o<4;o++){let a=2*o+5+r*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),r===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let t=0;for(let r of this.random.ishuffle(this.grid.screens())){if(t===3)break;let o=r|2056,a=de(o),l=de(o,2),f=Q(o),d=Q(o,2),c=qe(o),u=Ce(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(f)==="s"||this.grid.get(d)==="s")continue;let h=[],p=[];for(let m of[f,c,u])this.grid.get(m)==="c"&&(this.grid.get(2*m-o)==="s"?p.push(m):h.push(m));if(!(p.length>1)&&!(!h.length&&!p.length)){for(;h.length+p.length>1&&!(h.length+p.length===2&&!h.includes(f)&&!p.includes(f));){let[m]=h.splice(this.random.nextInt(h.length),1);this.grid.set(m,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),t++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return T}},Mt=Ds;Mt.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "];function Bi(n,s,e){let t=n.locations;Jr(n,e);let i=new Ht(n,e);i.add(),i.shuffles.length||i.add(new k(t.EastCave1),new k(t.EastCave2),new k(t.EastCave3),...jt(t.SealedCave1,t.SealedCave2),new k(t.SealedCave3),new k(t.SealedCave4),new k(t.SealedCave5),new k(t.SealedCave6),new k(t.SealedCave7),new k(t.SealedCave8),new k(t.WindmillCave),new k(t.ZebuCave),new es(t.Swamp),new k(t.MtSabreWest_Cave1),new k(t.MtSabreWest_Cave2),new k(t.MtSabreWest_Cave3),new k(t.MtSabreWest_Cave4),new k(t.MtSabreWest_Cave5),new k(t.MtSabreWest_Cave6),new tt(t.MtSabreWest_Cave7),new k(t.MtSabreNorth_Cave1),new k(t.MtSabreNorth_Cave2),new k(t.MtSabreNorth_Cave3),new k(t.MtSabreNorth_Cave4),new k(t.MtSabreNorth_Cave5),new k(t.MtSabreNorth_Cave6),new k(t.MtSabreNorth_Cave7),new k(t.MtSabreNorth_Cave8),new k(t.MtSabreNorth_Cave9),new k(t.MtSabreNorth_LeftCell2),new k(t.MtSabreNorth_SummitCave),new k(t.KirisaPlantCave1),new k(t.KirisaPlantCave2),new k(t.KirisaPlantCave3),new k(t.FogLampCave1),new k(t.FogLampCave2),new k(t.FogLampCave3),new Kt(t.FogLampCaveDeadEnd),...jt(t.FogLampCave5,t.FogLampCave4,!0),...jt(t.FogLampCave7,t.FogLampCave6),new tt(t.WaterfallCave1),new k(t.WaterfallCave2),new et(t.WaterfallCave3),new Yt(t.WaterfallCave4),new _e(t.EvilSpiritIsland2).requirePitDestination(),new tt(t.EvilSpiritIsland3),new _e(t.EvilSpiritIsland4),new Xt(t.SaberaPalace1).requirePitDestination(),new k(t.SaberaPalace2),new k(t.SaberaPalace2_West),new k(t.JoelSecretPassage),new k(t.MtHydra_Cave1),new k(t.MtHydra_Cave2),new k(t.MtHydra_Cave3),new k(t.MtHydra_Cave4),new k(t.MtHydra_Cave5),new k(t.MtHydra_Cave6),new et(t.MtHydra_Cave7),new k(t.MtHydra_Cave8),new k(t.MtHydra_Cave9),new k(t.MtHydra_Cave10),new et(t.Styx1).setUpEdgeType("c"),new Jt(t.Styx2).requirePitDestination(),new k(t.Styx3),new Qt(t.OasisCaveMain),new k(t.DesertCave1),new k(t.DesertCave2),new k(t.Pyramid_Branch),new ss(t.Pyramid_Main),new Ut(t.Crypt_Entrance),new et(t.Crypt_Hall1).setUpEdgeType("c"),new k(t.Crypt_DeadEndLeft),new k(t.Crypt_DeadEndRight),new k(t.Crypt_Branch),new k(t.Crypt_Hall2),new ts(t.GoaFortress_Kelbesque),new _e(t.GoaFortress_Sabera),new k(t.GoaFortress_Mado1).requirePitDestination(),new k(t.GoaFortress_Mado2),new k(t.GoaFortress_Mado3),new k(t.GoaFortress_Karmine1),new k(t.GoaFortress_Karmine2),new k(t.GoaFortress_Karmine4),new Mt(t.GoaFortress_Karmine6),...Pi(t.GoaFortress_Karmine3,t.GoaFortress_Karmine5,t.GoaFortress_Kensu),new Zt(t.OasisCave_Entrance)),i.shuffleAll(),console.log(String(i))}function Jr(n,s=new Qe(1)){ki(n),Gi(n),Ai(n,s)}var ht=typeof __VERSION__=="object"?__VERSION__:{},Ns=ht.STATUS||"unstable",Li=ht.VERSION||"HEAD",Ll=ht.LABEL||"HEAD",_i=ht.HASH||"HEAD",_l=ht.DATE||new Date,Dl=ht.PREV||"";var Ws=class{constructor(s,e,t,i){this.filename=s,this.chrdata=Array.from(new Uint8Array(e)),this.palette=t,this.rendered=Array.from(new Uint8Array(i.data))}};async function Nl(n){let s=document.createElement("canvas");s.width=112,s.height=100;let e=s.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,s.width,s.height);let t=new ImageData(new Uint8ClampedArray(n.rendered),128,128),i=await createImageBitmap(t,{resizeQuality:"pixelated"});return e.drawImage(i,0,0,16,24,24,2,16*4,24*4),s.toDataURL("image/png")}async function en(n,s){let e=n.byteLength/16,t=8,i=0,r=document.createElement("canvas");r.width=128,r.height=128;let a=r.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(n);for(let f=0;f<e;++f){let d=f*16,c=f%16*8,u=Math.floor(f/16)*8;for(let h=0;h<t;++h){let p=l[d+h],m=l[d+h+8];for(let g=0;g<t;++g){let C=7-g,b=p>>C&1,w=(m>>C&1)<<1,x=(b|w)+i*4,v=nn[s[x]],E=(c+g)*4+(u+h)*4*128;a.data[0+E]=v[0],a.data[1+E]=v[1],a.data[2+E]=v[2],a.data[3+E]=x==0?0:255}}}return a}var rs=class{constructor(s,e,t,i){this.name=s,this.converter=e,this.nssdata=t,this.description=i}static async init(s,e,t,i){let r=await t;return new rs(s,e,r,i)}static applyPatch(s,e,t){if(!rs.isCustom(s))return;let i=t?262144:0;for(let[r,o]of st.getChr(s.converter))for(let a of o)for(let l=0;l<16;++l)e[a+l+i]=s.nssdata.chrdata[r*16+l];for(let[r,o]of st.getPalette(s.converter))for(let a of o)switch(r){case"color0":e[a]=s.nssdata.palette[0];break;case"color1":e[a]=s.nssdata.palette[1];break;case"color2":e[a]=s.nssdata.palette[2];break;case"color3":e[a]=s.nssdata.palette[3];break;case"metasprite":e[a+i]=0;break}}},Ue=rs;Ue.isCustom=s=>s.name!="Simea";var is=class{constructor(){this.simeaReplacements=new Map;this.mapping=new Map;this.simeaReplacements.set("Simea",Ue.init("Simea","simea",Di("images/spritesheets/Simea.nss"),"The original main character of Crystalis")),this.simeaReplacements.set("Mesia",Ue.init("Mesia","simea",Di("images/spritesheets/Mesia.nss"),"Secondary protagonist Mesia takes the spotlight! Artwork by jroweboy")),this.mapping.set("simea",this.simeaReplacements)}static get(s){return this.instance||(this.instance=new is),this.instance.mapping.get(s)}};function S(n,s,e){return 262160+n*8192+s*4096+e*16}var st=class{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.simeaChrMapping=this.generateSimeaMapping(),this.simeaPaletteMapping=this.generateSimeaPalette(),this.chrMapping.set("simea",this.simeaChrMapping),this.paletteMapping.set("simea",this.simeaPaletteMapping)}static getChr(s){return this.instance||(this.instance=new st),this.instance.chrMapping.get(s)}static getPalette(s){return this.instance||(this.instance=new st),this.instance.paletteMapping.get(s)}generateSimeaPalette(){let s=new Map,e=27888+16;return s.set("color0",[e+0]),s.set("color1",[e+1]),s.set("color2",[e+2]),s.set("color3",[e+3]),s.set("metasprite",[245844+16]),s}generateSimeaMapping(){let t=new Map;t.set(0,[S(8,0,26)]),t.set(1,[S(8,0,27)]),t.set(16,[S(8,0,0)]),t.set(17,[S(8,0,1)]),t.set(32,[S(8,0,32)]),t.set(33,[S(8,0,33)]),t.set(2,[S(8,0,28)]),t.set(3,[S(8,0,29)]),t.set(18,[S(8,0,2)]),t.set(19,[S(8,0,3)]),t.set(20,[S(8,0,4)]),t.set(21,[S(8,0,5)]),t.set(34,[S(8,0,34)]),t.set(35,[S(8,0,35)]),t.set(36,[S(8,0,36)]),t.set(37,[S(8,0,37)]),t.set(6,[S(8,0,30)]),t.set(7,[S(8,0,31)]),t.set(22,[S(8,0,6)]),t.set(23,[S(8,0,7)]),t.set(38,[S(8,0,38)]),t.set(39,[S(8,0,39)]),t.set(64,[S(8,0,20)]),t.set(65,[S(8,0,21)]),t.set(80,[S(8,0,52)]),t.set(81,[S(8,0,53)]),t.set(50,[S(8,0,60)]),t.set(51,[S(8,0,61)]),t.set(66,[S(8,0,24)]),t.set(67,[S(8,0,25)]),t.set(82,[S(8,0,56)]),t.set(68,[S(8,0,22)]),t.set(69,[S(8,0,23)]),t.set(84,[S(8,0,54)]),t.set(112,[S(8,0,14)]),t.set(113,[S(8,0,15)]),t.set(128,[S(8,0,46)]),t.set(129,[S(8,0,47)]),t.set(114,[S(8,0,18)]),t.set(115,[S(8,0,19)]),t.set(130,[S(8,0,48)]),t.set(131,[S(8,0,51)]),t.set(116,[S(8,0,16)]),t.set(117,[S(8,0,17)]),t.set(133,[S(8,0,49)]),t.set(160,[S(8,0,8)]),t.set(161,[S(8,0,9)]),t.set(176,[S(8,0,40)]),t.set(146,[S(8,0,58)]),t.set(147,[S(8,0,59)]),t.set(162,[S(8,0,12)]),t.set(163,[S(8,0,13)]),t.set(178,[S(8,0,44)]),t.set(179,[S(8,0,45)]),t.set(164,[S(8,0,10)]),t.set(165,[S(8,0,11)]),t.set(181,[S(8,0,43)]);let i=new Map(t);for(let[o,a]of i){let l=o+8,f=a.map(d=>d+1024);t.set(l,f)}t.set(192,[S(11,1,0)]),t.set(193,[S(11,1,1)]),t.set(208,[S(11,1,2)]),t.set(209,[S(11,1,3)]),t.set(224,[S(11,1,4)]),t.set(225,[S(11,1,5)]),t.set(194,[S(11,1,36)]),t.set(195,[S(11,1,37)]),t.set(210,[S(11,1,6)]),t.set(211,[S(11,1,7)]),t.set(226,[S(11,1,38)]),t.set(227,[S(11,1,39)]),t.set(196,[S(11,1,32)]),t.set(197,[S(11,1,33)]),t.set(212,[S(11,1,34)]),t.set(213,[S(11,1,35)]),t.set(214,[S(11,1,20)]),t.set(215,[S(11,1,21)]),t.set(230,[S(11,1,22)]),t.set(231,[S(11,1,23)]),t.set(54,[S(11,1,12)]),t.set(55,[S(11,1,13)]),t.set(70,[S(11,1,50)]),t.set(71,[S(11,1,51)]),t.set(86,[S(11,1,46)]),t.set(87,[S(11,1,47)]),t.set(102,[S(11,1,18)]),t.set(103,[S(11,1,19)]),t.set(118,[S(11,1,8)]),t.set(119,[S(11,1,9)]),t.set(134,[S(11,1,40)]),t.set(135,[S(11,1,41)]),t.set(150,[S(11,1,44)]),t.set(151,[S(11,1,45)]),t.set(166,[S(11,1,10)]),t.set(167,[S(11,1,11)]),t.set(182,[S(11,1,42)]),t.set(183,[S(11,1,43)]);let r=o=>[S(8,0,o)+1024*2,S(8,0,o)+1024*3,S(8,1,o),S(8,1,o)+1024,S(8,1,o)+1024*2];return t.set(240,r(16)),t.set(241,r(17)),t.set(242,r(18)),t.set(243,r(19)),t.set(244,r(20)),t.set(245,r(21)),t.set(246,r(22)),t.set(247,r(23)),t.set(248,[S(8,1,237)]),t.set(249,r(25)),t.set(250,r(26)),t.set(252,r(48)),t.set(253,r(49)),t.set(254,r(50)),t.set(255,r(51)),t}};async function Di(n){let s=await(await fetch(n)).text(),e=n.replace(/^.*[\\\/]/,"");return rn(e,s)}function Ni(n){let s="",e="",t=0;for(;t<n.length;)if(n[t]==="["){++t;let i=n.indexOf("]",t),r=parseInt(n.slice(t,i),16)-1;s+=e.repeat(r),t=i+1}else e=n.slice(t,t+2),s+=e,t+=2;return s}function Wi(n,s){return n.match(new RegExp(".{1,"+s+"}","g"))||[]}function tn(n){let s=Wi(n,2).map(e=>parseInt(e,16));return new Uint8Array(s)}function sn(n){return n.map(s=>parseInt(s,16))}async function rn(n,s){let e=new Map(s.split(`
`).filter(a=>a.includes("=")).map(a=>a.split("=")).map(a=>[a[0],a[1]])),t=e.get("Palette")||"",i=sn(Wi(Ni(t).slice(0,32),2)),r=tn(Ni(e.get("CHRMain")||"")),o=await en(new Uint8ClampedArray(r),i);return new Ws(n,r,i,o)}var nn=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]];function zi(n,s,e){return new Os(s,e).smudge(n)}function*on(n){let s=0;for(;s<n.length;){let e=n.indexOf(`
`,s)+1||n.length;yield n.substring(s,e),s=e}}var Os=class{constructor(s,e){this.cpu=s;this.prg=e}smudge(s){let e="";for(let t of on(s))e+=this.smudgeLine(t);return e}smudgeLine(s){let e=/^([^;]*?)<@([0-9a-f]+)(?: (.*?))?@>(.*\n?)$/i.exec(s);if(e){let[,i,r,o,a]=e,l=parseInt(r,16),f=an(this.cpu,this.prg,l,o);return i+f+a}let t="";for(;;){let i=/^([^;]*?)\[@([0-9a-f]+)(:[0-9]+|:[wdb])?@\](.*\n?)/i.exec(s);if(!i){t+=s;break}let[,r,o,a,l]=i;s=l,t+=r;let f=parseInt(o,16);t+=ln(this.prg,f,a)}return t}};function an(n,s,e,t){let i=t,[r,o]=n.disasm(s[e])||["brk","imp"],a=n.argLen(o);return i||(a>0&&(i=s[e+1]),a>1&&(i=i|s[e+2]<<8)),r+(a?" "+n.format(o,i):"")}function ln(n,s,e){let t=n[s];if(e===":w")return t|=n[s+1]<<8,`($${Oi(t,4)})`;if(/:\d+/.test(e)){let i=parseInt(e.substring(1)),r='"';for(let o=0;o<i;o++){let a=String.fromCharCode(n[s+o]);'"\\'.includes(a)&&(a="\\"+a),r+=a}return r+='"',r}else return e===":d"?String(t):e===":b"?`%${t.toString(2).padStart(8,"0")}`:`$${Oi(t,2)}`}var zs=class{constructor(s){this.plain=s}fix(s,e,t){}format(s,e){return this.plain}},it=class extends zs{constructor(e){super("");this.fix=e}static set(e){return new it(t=>t.set(e))}},ut=it;ut.push=new it(e=>e.push()),ut.alt=new it(e=>e.alt()),ut.pop=new it(e=>e.pop()),ut.merge=new it(e=>e.merge());function Oi(n,s=2){return n.toString(16).padStart(s,"0")}var ge={of:(...n)=>{let s=0n;for(let e of n)s|=1n<<BigInt(e);return s},from:n=>{let s=0n;for(let e of n)s|=1n<<BigInt(e);return s},containsAll:(n,s)=>!(s&~n),with:(n,s)=>n|1n<<BigInt(s),without:(n,s)=>n&~(1n<<BigInt(s)),has:(n,s)=>!!(n&1n<<BigInt(s)),bits:n=>{let s=[],e=0;for(;n;){let t=Number(n&0xffffffffn),i=32;for(;t;){let r=Math.clz32(t)+1;i-=r,t<<=r,r===32&&(t=0),s.push(e|i)}n>>=32n,e+=32}return s},clone:n=>n,empty:n=>!n,difference:(n,s)=>n&~s};var ns=class{constructor(s){this.worlds=s;let e=new Set,t=new Set,i=new Map,r=new Map;for(let c=0;c<s.length;c++){let u=s[c],h=c<<24;for(let[p,m]of u.requirements){e.add(h|p);for(let g of m)for(let C of g)t.add(h|C)}for(let[p,m]of u.items)r.set(h|p,m);for(let[p,m]of u.slots)i.set(h|p,m)}this.itemInfos=new Map(r),this.slotInfos=new Map(i),this.progression=new Set(t);for(let c of r.keys())t.add(c);let o=new Set,a=new Set,l=new Set;for(let c of t)(e.has(c)?o:l).add(c);for(let c of e)t.has(c)||a.add(c);this.common=o.size,this.slots=new Es([...o,...a]),this.items=new Es([...o,...l]);let f=[],d=[];for(let c=0;c<s.length;c++){let u=c<<24;for(let[h,p]of s[c].requirements){let m=this.slots.index(u|h);if(m==null)throw new Error(`Provided a non-slot? ${V(h)}`);for(let g of p){let C=[...g].map(b=>this.items.index(u|b)??Re());(f[m]||(f[m]=[])).push(ge.from(C));for(let b of C)(d[b]||(d[b]=new Set)).add(m)}}}for(let c=0;c<this.slots.length;c++)if(!f[c]||!f[c].length){let u=this.slots.get(c)??NaN,h=this.checkName(u);console.error(`Nothing provided $${V(u)}: ${h} (index ${c})`)}this.graph=new vs(f),this.unlocks=new vs(d.map(Dt))}async shuffle(s,e,t=200,i,r){i&&i.addTasks(Math.floor(t/10));for(let o=0;o<t;o++){i&&o%10===9&&(i.addCompleted(1),await new Promise(requestAnimationFrame));let a=new Is;this.prefill(a,e);let l=this.compressFill(a),f=this.itemPool(l.values(),e),d=ge.from(new Set(f)),c=Math.floor(o/5);if(!this.fillInternal(l,f,d,e,s,c))continue;let u=r?[]:void 0,h=this.traverse(m=>l.get(m),ge.of(),u);if(h.size!==this.slots.length){let m=w=>`${String(w).padStart(3)} ${this.slots.get(w).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(w))}`,g=w=>`${String(w).padStart(3)} ${this.items.get(w).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(w))}`,C=new Set([...this.slots].map(w=>w[0]));for(let w of h)C.delete(w);let b=new Map;for(let w of C)b.set(m(w),this.graph.get(w).map(x=>`
    `+ge.bits(x).map(g).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...b.keys()].sort().map(w=>w+b.get(w)).join(`
  `)}`);continue}this.expandFill(l,a);let p=this.fillNonProgression(a,s,e);if(p!=null){if(i&&i.addCompleted(Math.floor((t-o)/100)),r){for(let[m,g]of a){let C=this.checkName(m).replace(/^[0-9a-f]{3} /,"");r.addSlot(m,C,g)}if(u)for(let[m,...g]of u)(m<this.common||l.has(m))&&r.addCheck(this.slots.get(m),g.map(C=>this.items.get(C)))}return p}}return null}fillInternal(s,e,t,i,r,o){let a=new Set(s.keys());for(let l=e.pop();l!=null;l=e.pop()){if(!ge.has(t,l))continue;let f=this.itemInfoFromIndex(l);t=ge.without(t,l);let d=this.expandReachable(this.traverse(h=>s.get(h),t),r);i.shuffle(d);let c=!1,u=new Set(s.keys());for(let h of d){if(u.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!(!p||!this.fits(p,f,r))){s.set(h,l),c=!0;break}}if(!c){if(u.clear(),o-- >0){for(let h of d){if(u.has(h)||!s.has(h)||a.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!p||!this.fits(p,f,r))continue;let m=s.replace(h,l)??Re();t=ge.with(t,m),e.push(m),i.shuffle(e),c=!0;break}if(c)continue}return!1}}return!0}expandReachable(s,e){let t=[];for(let i of s){let r=this.slotInfoFromIndex(i);!r||e.preserveUniqueChecks()&&!r.unique||$i(t,i,r.weight||1)}return t}itemPool(s,e){let t=new Set(s),i=[];for(let[r,o]of this.itemInfos){let a=this.items.index(r);a!=null&&(!this.progression.has(r)||t.has(a)||$i(i,a,o.weight||1))}return e.shuffle(i)}fits(s,e,t){if(t.preserveUniqueChecks()&&e.unique&&!s.unique)return!1;let i=e.preventLoss||s.preventLoss;return!(s.lossy&&e.losable&&i)}fillNonProgression(s,e,t){let i=[[],[],[]],r=[[],[]];for(let[f,d]of this.itemInfos){if(s.hasValue(f))continue;let c=2;d.losable&&d.preventLoss&&(c=1),e.preserveUniqueChecks()&&d.unique&&(c=0),i[c].push(f)}for(let[f,d]of this.slotInfos){if(s.has(f))continue;let c=d.lossy&&d.preventLoss?0:1;r[c].push(f)}for(let f of[...i,...r])t.shuffle(f);let o=f=>this.checkName(f),a=se.count(se.concat(...r)),l=se.count(se.concat(...i));if(l>a)throw console.log(`Slots ${a}:
  ${[...se.concat(...r)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...se.concat(...i)].map(o).join(`
  `)}`),new Error("Too many items");for(let f of se.concat(...i)){let d=!1;for(let c of[...r]){if(d)break;for(let u=0;u<c.length;u++)if(this.fits(this.slotInfos.get(c[u]),this.itemInfos.get(f),e)){s.set(c[u],f),d=!0,c.splice(u,1);break}}if(!d)return console.log(`Slots:
  ${[...se.concat(...r)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(f)}`),null}return new Map(s)}traverse(s,e,t){e=ge.clone(e);let i=new Set,r=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}r.add(o)}for(let o of r){if(r.delete(o),i.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,f=a.length;l<f;l++){if(!ge.containsAll(e,a[l]))continue;t&&t.push([o,...ge.bits(a[l])]),i.add(o);let d=[];o<this.common&&d.push(o);let c=s(o);c!=null&&d.push(c);for(let u of d){e=ge.with(e,u);for(let h of this.unlocks.get(u)||[]){if(this.graph.get(h)==null)throw console.dir(this),new Error(`Adding bad node ${h} from unlock ${u}`);r.add(h)}}break}}return i}expandFill(s,e){for(let[t,i]of s){let r=this.slots.get(t),o=this.items.get(i);if(r==null||o==null)throw new Error("missing");e.replace(r,o)}}compressFill(s){let e=new Is;for(let[t,i]of s){let r=this.slots.index(t),o=this.items.index(i);if(r==null||o==null)throw new Error(`Bad slot/item: ${t} ${r} ${i} ${o}`);e.set(r,o)}return e}checkName(s){return this.worlds[s>>>24].checkName(s&16777215)}prefill(s,e){for(let t=0;t<this.worlds.length;t++){let i=t<<24,r=this.worlds[t].prefill(e);for(let[o,a]of r)s.set(i|o,i|a)}}itemInfoFromIndex(s){let e=this.items.get(s);if(e==null)throw new Error(`Bad item: ${s}`);return this.itemInfoFromId(e)}itemInfoFromId(s){let e=this.itemInfos.get(s);if(e==null)throw new Error(`Missing info: ${V(s)}`);return e}slotInfoFromIndex(s){let e=this.slots.get(s);if(e==null)throw new Error(`Bad slot: ${s}`);return this.slotInfoFromId(e)}slotInfoFromId(s){let e=this.slotInfos.get(s);if(e!=null)return e}};function $i(n,s,e){for(let t=0;t<e;t++)n.push(s)}var os=class{constructor(s,e,t,i=1){this.rom=s;this._width=t,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Re(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=te(i,()=>new Uint32Array(t*e)),this.data=this.layers[0];for(let r=0;r<256;r++)for(let o=0;o<4;o++){let a=dn[s.palettes[r].color(o)];this.palettes[r<<2|o]=a|4278190080}}useLayer(s){this.data=this.layers[s]||Re(`Bad layer: ${s}`)}resizeWidth(s,e){let t=new Uint32Array(e*this._height),i=Math.min(e,this._width);for(let r=0;r<this._height;r++)t.subarray(r*e,r+e+i).set(s.subarray(r*this._width,r*this._width+i));return t}resizeHeight(s,e){let t=new Uint32Array(this._width*e),i=this._width*Math.min(e,this._height);return t.subarray(0,i).set(s.subarray(0,i)),t}get width(){return this._width}set width(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],s);this._width=s,this.canvas.width=s}get height(){return this._height}set height(s){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],s);this._height=s,this.canvas.height=s}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(s){this.data.fill(s)}clear(s){let e=s!=null?this.palettes[s<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let t=1;t<this.layers.length;t++)this.layers[t].fill(0)}toDataUrl(s=!1){return this.canvas.toDataURL("image/png")}render(){let s=this.canvas,e=this.ctx;for(let t=0;t<this.layers.length;t++){t&&(s=document.createElement("canvas"),s.width=this.canvas.width,s.height=this.canvas.height,e=s.getContext("2d")||Re());let i=new Uint8Array(this.layers[t].buffer),r=e.getImageData(0,0,this._width,this._height);r.data.set(i),e.putImageData(r,0,0),t&&this.ctx.drawImage(s,0,0)}}rect(s,e,t,i,r){let o=Math.max(0,s),a=Math.max(0,e),l=Math.min(this._height,s+t),f=Math.min(this._width,e+i);for(s=o;s<l;s++)for(e=a;e<f;e++)this.data[s*this._width+e]=r}tile(s,e,t,i){if(e<0||s<0||e+8>=this._width||s+8>=this._height)return;let r=this.rom.patterns.get(t).flip(i<<6);for(let o=0;o<8;o++){let a=r.pixels[8|o]<<1,l=r.pixels[o];for(let f=7;f>=0;f--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(s+o)*this._width+e+f]=this.palettes[i&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,s),this._maxY=Math.max(this._maxY,s+8)}metatile(s,e,t,i,r=0){let o=this.rom.locations[i],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[r&7]);let l=[...o.tilePalettes,127],f=this.rom.tilesets[o.tileset],d=l[f.attrs[t]];for(let c=0;c<2;c++)for(let u=0;u<2;u++){let h=f.tiles[c<<1|u][t],p=a[h&128?1:0]<<6|h&127,m=e+(u<<3),g=s+(c<<3);this.tile(g,m,p,d<<2)}}metasprite(s,e,t,i,r=0,o=0){let a=this.rom.locations[i],l=this.rom.metasprites[t],f=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],c=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],c=!0),!l||!l.used)return;let u=o&l.frameMask;for(let[h,p,m,g]of l.sprites[u]){if(h==128)break;h=Hi(h),p=Hi(p),g=g+r&255;let C=f[g>>6],b=d[m&3]+176&255,w=C<<6|g&63;c&&(h=-8-h,m^=64),this.tile(s+p,e+h,w,b<<2|m>>6)}}text(s,e,t,i=18){for(let r=0;r<t.length;r++)this.tile(s,e+8*r,t.charCodeAt(r)|3840,i<<2)}},dn=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];function Hi(n){return n<128?n:n-256}function O(n){return n}(e=>{function n({id:t},{x:i,y:r}){let o=i>>>8,a=i>>>4&15,l=r>>>8,f=r>>>4&15;return t<<16|l<<12|o<<8|f<<4|a}e.from=n;function s(t,i,r){let o=t;if(i){let a=(o&240)+(i<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(r){let a=(o&15)+r;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=s})(O||(O={}));var qi=Symbol("[LocationMap data]"),je=class extends os{constructor(e,t=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let i=e.locations[t];this.width=(i.used?i.width:1)*256,this.height=(i.used?i.height:1)*240,this.location=i;let r=o=>{let a=o.offsetX,l=o.offsetY,f=o.target;for(;f&&f!==this.element;)f=f.parentElement;if(!f)return;let d=a>>8,c=Math.floor(l/240),u=a-256*d>>4,h=l-240*c>>4,m=this.location.id<<16|c<<12|d<<8|h<<4|u;je.setData(o,{tile:m,target:this})};this.element.addEventListener("mousemove",r),this.element.addEventListener("mousedown",r),this.element.addEventListener("mouseup",r),this.element.addEventListener("click",r),this.redraw()}static getData(e){return e[qi]}static setData(e,t){e[qi]=t}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,t=(1-e)*50;this.element.style.transform=`translate(-${t}%,-${t}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,t,i){for(let r of e){if(r>>>16!==this.location.id)continue;let o=r>>>12&15,a=r>>>8&15,l=r>>>4&15,f=r&15,d=240*o+16*l,c=256*a+16*f;i!=null&&(this.useLayer(3),this.rect(d-1,c-1,18,18,0)),this.useLayer(1),e.has(O.add(r,-1,0))||this.rect(d-1,c-1,2,18,t),e.has(O.add(r,0,-1))||this.rect(d-1,c-1,18,2,t),e.has(O.add(r,1,0))||this.rect(d+15,c-1,2,18,t),e.has(O.add(r,0,1))||this.rect(d-1,c+15,18,2,t)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let t=0;t<this.location.width;t++){let i=this.location.screens[e][t];this.drawScreen(this.rom.screens[i],e,t)}this.useLayer(2);for(let e of this.location.spawns){let t=0,{x:i,y:r}=e;r-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;i+=8,r+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(t+=64),o!=null&&this.metasprite(r,i,o,this.location.id,t)}this.render()}drawScreen(e,t,i){let r=t*240,o=i*256,a=this.rom.tilesets[this.location.tileset],l,f=!1;for(let d of this.location.flags)if(d.xs===i&&d.ys===t){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(f=!0);break}for(let d=0;d<240;d+=16)for(let c=0;c<16;c++){let u=e.tiles[d|c];u<32&&(this.flags.has(l)||f)&&(u=a.alternates[u]),this.metatile(r+d,o+c*16,u,this.location.id,0)}}};var F;(d=>{function n(...c){return[[].concat(...c.map(([u])=>u))]}d.and=n;function s(...c){let u=[];for(let h of c){if(h===d.OPEN)return d.OPEN;h!==d.CLOSED&&u.push(...t(h))}return u.length?u:d.CLOSED}d.or=s;function e(c,u){if(c===d.OPEN)return t(u);if(u===d.OPEN)return t(c);if(c===d.CLOSED||u===d.CLOSED)return d.CLOSED;let h=new f;for(let p of c)for(let m of u)h.addList([...p,...m]);return t(h)}d.meet=e;function t(c){return c instanceof f?[...se.map(c,u=>[...u])]:c}d.freeze=t;function i(c){return c instanceof f?c.label():c.map(u=>u.join("&")).join("|")}d.label=i;function r(c){let u=c[Symbol.iterator](),{value:h,done:p}=u.next();if(p||!u.next().done)return!1;let m=h[Symbol.iterator]();return Boolean(m.next().done)}d.isOpen=r;function o(c){let u=c[Symbol.iterator]();return Boolean(u.next().done)}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class f{constructor(u){this.self=u;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(u,h){for(let p of h)if(Array.isArray(p))throw new Error;if(h.has(this.self)||this.map.has(u))return!1;for(let[p,m]of this.map){if(Ui(h,m))return!1;Ui(m,h)&&this.map.delete(p)}return this.map.set(u,h),!0}addRoute(u){return this.addInternal(u[as],u.deps)}addAll(u){for(let h of u)this.addList(h)}addList(u){let h=[...new Set(u)].sort(),p=new Set(h);this.addInternal(h.join("&"),p)}restrict(u){let h=[...this.map.values()];this.map.clear();for(let p of h)for(let m of u)this.addList([...p,...m])}label(){return[this.map.keys()].join("|")}}d.Builder=f})(F||(F={}));function Ui(n,s){if(n.size<s.size)return!1;for(let e of s)if(!n.has(e))return!1;return!0}var as=Symbol("depsLabel"),Me=class{constructor(s,e){this.target=s;let t=[...new Set(e)].sort();this.deps=new Set(t),this[as]=t.join("&"),this.label=`${this.target}:${this[as]}`}};as;var ls=class{constructor(s){this.rom=s;this.tiles=new D(s=>cn(this.rom,s));this.bosses=new D(s=>new Hs(s));this.statues=new Map;this.flags=new D(s=>new D(e=>new D(t=>new js(s,e,t))));this.meets=new D(s=>new D(e=>new Ks(s,e)));this._seamless=new D(s=>new $s(s))}tile(s){return s&4?void 0:this.tiles.get(s)}boss(s,e){return e?this.rage||(this.rage=new Us(s,this.rom.flags.RageSkip.id)):this.bosses.get(s)}statue(s){let e=F.label(s),t=this.statues.get(e);return t||this.statues.set(e,t=new qs(s)),t}flag(s,e,t){return s||(s=fn),this.flags.get(s).get(e).get(t)}meet(s,e){return this.meets.get(s).get(e)}seamless(s){return this._seamless.get(s)}label(s,e){return s.label?s.label(e):"Terrain"}},z;(c=>{c.FLY=2,c.BLOCKED=4,c.SLOPE=32,c.PAIN=128,c.BITS=166,c.SWAMP=256,c.BARRIER=512,c.SLOPE8=1024,c.SLOPE9=2048,c.DOLPHIN=4096;function d(u,h){return u.label?.(h)??"Terrain"}c.label=d})(z||(z={}));var $s=class{constructor(s){this._delegate=s;this.enter=s.enter,this.exit=s.exit}label(s){return`Seamless(${z.label(this._delegate,s)})`}},rt=class{constructor(s,e=F.OPEN){this.enter=s;this.exit=[[15,e]]}get kind(){return"Simple"}label(s){let e=[];return F.isOpen(this.enter)||e.push(`enter = ${be(this.enter,s)}`),F.isOpen(this.exit[0][1])||e.push(`exit = ${be(this.exit[0][1],s)}`),`${this.kind}(${e.join(", ")})`}},ds=class{constructor(s,e,t=4){this.enter=s;this.exit=e?[[15&~t,e],[t,F.OPEN]]:[[15,F.OPEN]]}get kind(){return"South"}label(s){if(this.exit.length===1)return rt.prototype.label.call(this,s);let e=[];return F.isOpen(this.enter)||e.push(`enter = ${be(this.enter,s)}`),F.isOpen(this.exit[0][1])||e.push(`other = ${be(this.exit[0][1],s)}`),F.isOpen(this.exit[1][1])||e.push(`south = ${be(this.exit[1][1],s)}`),`${this.kind}(${e.join(", ")})`}};function cn(n,s){let e=F.OPEN,t,i=4;return s&z.DOLPHIN&&s&z.FLY?(s&z.SLOPE&&(t=n.flags.ClimbWaterfall.r),e=[[n.flags.CurrentlyRidingDolphin.c],[n.flags.Flight.c]]):(s&z.SLOPE9?t=n.flags.ClimbSlope9.r:s&z.SLOPE8?t=n.flags.ClimbSlope8.r:s&z.SLOPE&&(t=n.flags.ClimbSlope10.r),s&z.FLY&&(e=n.flags.Flight.r)),s&z.SWAMP&&(e=e.map(r=>[n.flags.TravelSwamp.c,...r])),s&z.PAIN&&(e=e.map(r=>[n.flags.CrossPain.c,...r])),s&z.BARRIER&&(e=e.map(r=>[n.flags.ShootingStatue.c,...r]),t=n.flags.ShootingStatueSouth.r,i=1),new ds(e,t,i)}var Hs=class extends rt{constructor(e){super(F.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},qs=class extends ds{constructor(e){super(F.OPEN,e);this._req=e}get kind(){return"Statue"}},Us=class{constructor(s,e){this._rageFlag=s;this._rageSkipFlag=e;this.enter=F.OPEN;this.exit=[[11,[[s],[e]]],[4,F.OPEN]]}label(){return"Rage"}},js=class extends rt{constructor(s,e,t){if(s.exit.length!==1||t.exit.length!==1)throw console.error(s,t),new Error("bad flag");let i=[[e]],r=e>=0?F.meet(t.enter,i):t.enter,o=e>=0?F.meet(t.exit[0][1],i):t.exit[0][1];super(F.or(s.enter,r),F.or(s.exit[0][1],o))}get kind(){return"Flag"}},fn=new rt(F.CLOSED,F.CLOSED);function ji(n){let s=[];for(let e=0;e<n.exit.length;e++)for(let t=0;t<4;t++)n.exit[e][0]&1<<t&&(s[t]=e);for(let e=0;e<4;e++)if(s[e]==null)throw new Error(`Bad terrain: ${n.exit.map(t=>t[0]).join(",")}`);return s}var Ks=class{constructor(s,e){this.left=s;this.right=e;let t=ji(s),i=ji(e),r=new Set,o=[];for(let a=0;a<4;a++)r.add(t[a]<<2|i[a]);for(let a of r){let[l,f]=s.exit[a>>2],[d,c]=e.exit[a&3];o.push([l&d,F.meet(f,c)])}this.enter=F.meet(s.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(s){if(this.exit.length===1)return rt.prototype.label.call(this,s);let e=[];F.isOpen(this.enter)||e.push(`enter = ${be(this.enter,s)}`);for(let[t,i]of this.exit){let r=[t&1?"N":"",t&2?"W":"",t&4?"S":"",t&8?"E":""].join("");e.push(`exit${r} = ${be(i,s)}`)}return`${this.kind}(${e.join(", ")})`}};function be(n,s){let e=[...n],t=e.map(i=>se.isEmpty(i)?"open":[...i].map(r=>s.flags[r]?.debug).join(" & ")).join(") | (");return e.length>1?`(${t})`:e.length?t:"never"}z.debugLabel=be;typeof window=="object"&&(window.debugLabel=be);var cs=class{constructor(s,e){this.rom=s;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",t=>this.click(t)),this.element.addEventListener("mousemove",t=>this.move(t)),this.renderArea(0)}click(s){let e=je.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t!=null){if(t.area===this.area){let i=t.exit!=null?this.world.tiles.get(t.exit):null;i&&i.area!==this.area&&(t=i)}t.area&&t.area!==this.area&&this.renderArea(t.area.id)}}move(s){let e=je.getData(s);if(!e)return;let t=this.world.tiles.get(e.tile);if(t==null)return;let i=t.exit!=null&&!this.area.tiles.has(t.exit);e.target.element.style.cursor=i?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(s){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let i of this.rom.locations){if(!i.used)continue;let r=this.world.locations[i.id]?.areas[Symbol.iterator]().next().value;if(r==null)continue;let o=document.createElement("option");o.textContent=`${V(i.id)} ${i.name}`,o.value=String(r.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[s];let t=document.createElement("pre");t.textContent=`Area ${s}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${z.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([i,r])=>`${i.debug}: ${be(r,this.rom)}`))].join(`
  `)}
Routes:
  ${be(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(t);for(let i of this.area.locations){let r=this.rom.locations[i],o=document.createElement("h2");o.textContent=r.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,r))}}makeLocation(s,e){let t=new je(this.rom,e.id);t.maxWidth=574,t.overlayShade(1426063360);for(let i of this.world.locations[e.id].areas)i!==s&&t.overlayArea(i.tiles,4294901760);return t.overlayArea(s.tiles,4278255615,0),t.render(),t.element}};var Ft;(o=>{function n(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=n;function s(){return[0,1,2,3]}o.all=s,o.North=0,o.West=1,o.South=2,o.East=3})(Ft||(Ft={}));var ke;(i=>{function n(r,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let f of[-16,0]){let d=a+f;for(let c of[-16,0]){let u=l+c;yield O.from(r,{x:d,y:u})}}}}}i.trigger=n;function s(r,...o){let a=new Set,l=[...r];for(let[f,d]of o)for(let c of l)a.add(O.add(c,f,d));return a}i.adjust=s;function e(r){let o=[];for(let a=0;a<240;a++)o.push(r&-256|a);return o}i.screen=e;function t(r,...o){let a=new Set,l=[...r];for(let f of o)for(let d of l)a.add(d&65535|f.id<<16);return a}i.atLocation=t})(ke||(ke={}));function nt(n){return n}(e=>{e.from=(t,i)=>typeof t=="number"||!i?Number(t)>>>8:t.id<<8|i.y>>>8<<4|i.x>>>8;function s(t){return t>>>8}e.fromTile=s})(nt||(nt={}));function fe(n){return n}(e=>{function n(t,i){return t*(1<<24)+i}e.of=n;function s(t){return[Math.floor(t/(1<<24)),t%(1<<24)]}e.split=s})(fe||(fe={}));var[]=[V],fs=class{constructor(s,e,t=!1){this.rom=s;this.flagset=e;this.tracker=t;this.terrainFactory=new ls(this.rom);this.terrains=new Map;this.checks=new D(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new D(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new pe;this.neighbors=new D(()=>0);this.routes=new D(()=>new F.Builder);this.routeEdges=new D(()=>new It);this.requirementMap=new D(s=>new F.Builder(s));this.limeTreeEntranceLocation=-1;for(let i of s.items)for(let r of i.itemUseData)r.kind==="expect"?this.itemUses.get(r.want).push([i,r]):r.kind==="location"&&this.itemUses.get(~r.want).push([i,r]);this.aliases=new Map([[s.flags.ChangeAkahana,s.flags.Change],[s.flags.ChangeSoldier,s.flags.Change],[s.flags.ChangeStom,s.flags.Change],[s.flags.ChangeWoman,s.flags.Change],[s.flags.ParalyzedKensuInDanceHall,s.flags.Paralysis],[s.flags.ParalyzedKensuInTavern,s.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let i of s.locations)this.processLocation(i);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:s,MezameShrine:e,Oak:t,Shyron_ToolShop:i},flags:{AbleToRideDolphin:r,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:f,Barrier:d,BlizzardBracelet:c,BowOfMoon:u,BowOfSun:h,BreakStone:p,BreakIce:m,BreakIron:g,BrokenStatue:C,BuyHealing:b,BuyWarp:w,ClimbWaterfall:x,ClimbSlope8:v,ClimbSlope9:E,ClimbSlope10:M,CrossPain:y,CurrentlyRidingDolphin:I,Flight:G,FlameBracelet:K,FormBridge:Y,GasMask:J,GlowingLamp:oe,InjuredDolphin:U,LeadingChild:ce,LeatherBoots:B,Money:A,OpenedCrypt:Ge,RabbitBoots:Ae,Refresh:$,RepairedStatue:me,RescuedChild:le,ShellFlute:ze,ShieldRing:lt,ShootingStatue:ye,ShootingStatueSouth:Pe,StormBracelet:ie,Sword:bs,SwordOfFire:bt,SwordOfThunder:wt,SwordOfWater:dt,SwordOfWind:yt,TornadoBracelet:ws,TravelSwamp:Ze,TriggerSkip:P,UsedBowOfMoon:ys,UsedBowOfSun:$e,WildWarp:St},items:{MedicalHerb:W,WarpBoots:re}}=this.rom,N=this.entrance(e),Pt=this.entrance(t);this.addCheck([N],Ke(u,h),[Ge.id]),this.addCheck([N],u.r,[ys.id]),this.addCheck([N],h.r,[$e.id]),this.addCheck([N],Ke(r,ze),[I.id]),this.addCheck([Pt],Ke(ce),[le.id]),this.addItemCheck([N],Ke(oe,C),me.id,{lossy:!0,unique:!0});for(let Ie of this.rom.shops){if(Ie.location===s.id||Ie.location===i.id||!Ie.used||Ie.type!==1)continue;let Bt=[Ie.location<<16|136];for(let Lt of Ie.contents)Lt===W.id?this.addCheck(Bt,A.r,[b.id]):Lt===re.id&&this.addCheck(Bt,A.r,[w.id])}let Ct=yt.r,kt=bt.r,vt=dt.r,Et=wt.r;if(!this.flagset.orbsOptional()){let Ie=De(f,ws),Bt=De(o,K),Lt=De(l,c),Br=De(a,ie);if(Ct=F.meet(Ct,Ie),kt=F.meet(kt,Bt),vt=F.meet(vt,Lt),Et=F.meet(Et,Br),this.flagset.assumeSwordChargeGlitch()){let _t=function(fi){return Lr.map(Ss=>Ss[0]===fi.c?Ss:[fi.c,...Ss])},Lr=F.or(Ct,kt,vt,Et);Ct=_t(yt),kt=_t(bt),vt=_t(dt),Et=_t(wt)}}this.addCheck([N],Ct,[p.id]),this.addCheck([N],kt,[m.id]),this.addCheck([N],vt,[Y.id]),this.addCheck([N],Et,[g.id]),this.addCheck([N],De(yt,bt,dt,wt),[bs.id]),this.addCheck([N],G.r,[x.id,M.id]),this.addCheck([N],De(G,Ae),[v.id]),this.addCheck([N],De(G,Ae),[E.id]),this.addCheck([N],d.r,[ye.id,Pe.id]),this.addCheck([N],J.r,[Ze.id]);let Pr=this.flagset.changeGasMaskToHazmatSuit()?J:B;if(this.addCheck([N],De(G,Ae,Pr),[y.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([N],B.r,[v.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([N],Ke(I,Ae),[x.id]),this.flagset.fogLampNotRequired()){let Ie=this.flagset.requireHealedDolphinToRide();this.addCheck([N],Ie?U.r:[[]],[r.id])}this.flagset.guaranteeBarrier()||this.addCheck([N],[[A.c,b.c],[A.c,lt.c],[A.c,$.c]],[ye.id,Pe.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([N],[[A.c,G.c]],[ye.id]),this.flagset.guaranteeGasMask()||this.addCheck([N],[[A.c,b.c],[A.c,$.c]],[Ze.id,y.id]),this.flagset.assumeWildWarp()&&this.addCheck([N],F.OPEN,[St.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([N],F.OPEN,[P.id]),this.addCheck([N],P.r,[y.id,v.id,E.id]))}addExtraRoutes(){let{flags:{BuyWarp:s,SwordOfThunder:e,Teleport:t,WildWarp:i},locations:{MezameShrine:r}}=this.rom;if(this.addRoute(new Me(this.entrance(r),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new Me(this.entrance(o[0],o[1]&31),[e.c,s.c])),this.addRoute(new Me(this.entrance(o[0],o[1]&31),[e.c,t.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Re("bad entrance");for(let f of l.enter)this.addRoute(new Me(a,[i.c,...f]))}}consolidateChecks(){for(let[s,e]of this.checks){let t=this.tiles.find(s);if(s!==t){for(let i of e)this.checks.get(t).add(i);this.checks.delete(s)}}}buildRequirementMap(){for(let[e,t]of this.checks)for(let{checks:i,requirement:r}of t)for(let o of i){let a=this.requirementMap.get(o);for(let l of r)for(let f of this.routes.get(e)||[])a.addList([...l,...f])}if(!Ki)return;let s=[];for(let[e,t]of this.requirementMap){let i=r=>this.rom.flags[r].name;for(let r of t)s.push(`${i(e)}: ${[...r].map(i).join(" & ")}
`)}s.sort((e,t)=>e<t?-1:e>t?1:0),console.log(s.join(""))}getLocationList(s="Crystalis"){let e=Ki?t=>t.debug:t=>t.name;return{worldName:s,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:t=>e(this.rom.flags[t]),prefill:t=>{let{Crystalis:i,MesiaInTower:r,LeafElder:o}=this.rom.flags,a=new Map([[r.id,i.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|t.nextInt(4)),a}}}processLocation(s){!s.used||(this.processLocationTiles(s),this.processLocationSpawns(s),this.processLocationItemUses(s))}unionNeighbors(){for(let[s,e]of this.terrains){let t=O.add(s,0,1);this.terrains.get(t)===e&&this.tiles.union([s,t]);let i=O.add(s,1,0);this.terrains.get(i)===e&&this.tiles.union([s,i])}}addAllRoutes(){this.addExtraRoutes();for(let[s,e]of this.neighbors){let[t,i]=fe.split(s),r=this.terrains.get(t),o=this.terrains.get(i);if(!r||!o)throw new Error(`missing terrain ${V(r?t:i)}`);for(let[a,l]of r.exit)if(!!(a&e))for(let f of l)for(let d of o.enter)this.addRoute(new Me(i,[...f,...d]),t)}if(typeof document=="object"){let s=document.getElementById("debug");s&&s.appendChild(new cs(this.rom,this.getWorldData()).element)}}getWorldData(){let s=0,e=new D(()=>({})),t=te(256,()=>({areas:new Set,tiles:new Set})),i=[];for(let r of this.tiles.sets()){let o=this.tiles.find(se.first(r)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?F.freeze(this.routes.get(o)):[];if(!l.length)continue;let f={checks:[],id:s++,locations:new Set,routes:l,terrain:a,tiles:new Set};i.push(f);for(let d of r){let c=d>>>16;f.locations.add(c),f.tiles.add(d),t[c].areas.add(f),t[c].tiles.add(d),e.get(d).area=f}}for(let[r,o]of this.exits)e.has(r)&&(e.get(r).exit=o);for(let[r,o]of this.checks){let a=e.get(r).area;if(!!a)for(let{checks:l,requirement:f}of o)for(let d of l){let c=this.rom.flags[d]||Re();a.checks.push([c,f])}}return{tiles:e,areas:i,locations:t}}addRoute(s,e){if(e!=null){this.routeEdges.get(e).add(s);for(let a of this.routes.get(e))this.addRoute(new Me(s.target,[...a,...s.deps]));return}let t=new It,i=new It,r=s;t.add(r);let o=t[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;i.add(a),t.delete(a);let f=new It,d=a.target;if(this.routes.get(d).addRoute(a))for(let u of this.routeEdges.get(d))f.add(new Me(u.target,[...a.deps,...u.deps]));for(let u of f)i.has(u)||(t.delete(u),t.add(u))}}recordExits(){for(let[s,e]of this.exits)this.exitSet.add(fe.of(this.tiles.find(s),this.tiles.find(e)));for(let s of this.exitSet){let[e,t]=fe.split(s);if(this.terrains.get(e)!==this.terrains.get(t))continue;let i=fe.of(t,e);this.exitSet.has(i)&&(this.tiles.union([e,t]),this.exitSet.delete(s),this.exitSet.delete(i))}}buildNeighbors(){for(let[s,e]of this.terrains){if(!e)continue;let t=O.add(s,1,0),i=this.terrains.get(t);i&&i!==e&&this.handleAdjacentNeighbors(s,t,Ft.North);let r=O.add(s,0,1),o=this.terrains.get(r);o&&o!==e&&this.handleAdjacentNeighbors(s,r,Ft.West)}for(let s of this.exitSet){let[e,t]=fe.split(s);if(!this.terrains.has(e)||!this.terrains.has(t))continue;let i=fe.of(this.tiles.find(e),this.tiles.find(t));this.neighbors.set(i,this.neighbors.get(i)|1)}}handleAdjacentNeighbors(s,e,t){let i=this.tiles.find(s),r=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=fe.of(r,i);this.neighbors.set(o,this.neighbors.get(o)|1<<t)}if(!this.seamlessExits.has(s)){let o=t^2,a=fe.of(i,r);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(s){let e=new Map,t=new Set,i=(s.id&248)===88;for(let f of s.spawns)if(f.isWall())e.set(nt.from(s,f),f.id&3);else if(f.isMonster()&&f.id===63){let d=nt.from(s,f)<<8|f.yt<<4;for(let c=4;c<=11;c++)for(let u=-3;u<=3;u++)t.add(O.add(d,u,c))}let r=this.rom.tilesets[s.tileset],o=this.rom.tileEffects[s.tileEffects-179],a=f=>{let d=s.screens[(f&61440)>>>12][(f&3840)>>>8];return o.effects[this.rom.screens[d].tiles[f&255]]},l=(f,d,c)=>{if(f&=z.BITS,s.id===26&&(f|=z.SWAMP),(s.id===96||s.id===104)&&(f|=z.DOLPHIN),s.id===100&&(d&61680)<4144&&(f|=z.DOLPHIN),c&&(f|=z.BARRIER),!(f&z.DOLPHIN)&&f&z.SLOPE){let u=d,h=0;for(;a(u)&z.SLOPE;)u=O.add(u,1,0),h++;h<6?f&=~z.SLOPE:h<9?f|=z.SLOPE8:h<10&&(f|=z.SLOPE9)}if(f&z.PAIN){for(let u of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a(O.add(d,...u))&(z.PAIN|z.FLY))){f&=~z.PAIN;break}}return this.terrainFactory.tile(f)};for(let f=0,d=s.height;f<d;f++){let c=s.screens[f],u=s.id<<8|f<<4;for(let h=0,p=s.width;h<p;h++){let m=this.rom.screens[c[h]],g=u|h,C=g&255,b=e.get(g),w=i?this.rom.flags.AlwaysTrue.id:b!=null?this.wallCapability(b):s.flags.find(E=>E.screen===C)?.flag,x=s.pits.find(E=>E.fromScreen===g);x&&this.exits.set(g<<8|136,x.toScreen<<8|136);let v=this.rom.flags[w]?.logic??{};for(let E=0;E<240;E++){let M=g<<8|E,y=m.tiles[E];v.assumeTrue&&y<32&&(y=r.alternates[y]);let I=s.isShop()?0:o.effects[y],G=t.has(M),K=l(I,M,G);if(y<32&&r.alternates[y]!==y&&w!=null&&!v.assumeTrue&&!v.assumeFalse){let Y=l(o.effects[r.alternates[y]],M,G);Y&&(K=this.terrainFactory.flag(K,v.track?w:-1,Y))}K&&this.terrains.set(M,K)}}}for(let f of s.exits){let{dest:d,entrance:c}=f,u=O.from(s,f),h;if(f.isSeamless()){h=u&65535|d<<16;let p=O.from(s,f);this.seamlessExits.add(p);let m=this.terrains.get(p);m&&this.terrains.set(p,this.terrainFactory.seamless(m))}else h=this.entrance(this.rom.locations[d],c&31);this.exits.set(u,h),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[c].y>160&&(this.limeTreeEntranceLocation=s.id)}}processLocationSpawns(s){for(let e of s.spawns)e.isTrigger()?this.processTrigger(s,e):e.isNpc()?this.processNpc(s,e):e.isBoss()?this.processBoss(s,e):e.isChest()?this.processChest(s,e):e.isMonster()?this.processMonster(s,e):e.type===3&&e.id===224&&this.processKeyUse(ke.screen(O.from(s,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(s,e){let t=this.rom.trigger(e.id);if(!t)throw new Error(`Missing trigger ${e.id.toString(16)}`);let i=this.filterRequirements(t.conditions),r=this.filterAntiRequirements(t.conditions),o=O.from(s,e),a=ke.trigger(s,e),l=[];for(let f of t.flags){let d=this.flag(f);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,i,l),t.message.action){case 25:t.id===134&&!this.flagset.assumeRabbitSkip()?a=ke.adjust(a,[0,-1],[0,1]):t.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=ke.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(r=F.or(r,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(r));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,i);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,i,t.id);break;case 24:{let f=this.flagset.chargeShotsOnly()?F.meet(i,Ke(this.rom.flags.WarpBoots)):i;this.addItemCheck(a,f,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,i,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,s,i);break;case 27:s===this.rom.locations.Portoa_PalaceEntrance&&(a=ke.adjust(a,[-2,0]),r=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,s,r);break}for(let[f,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([O.from(s,e)],F.OPEN,f,d)}processNpc(s,e){let t=this.rom.npcs[e.id];if(!t||!t.used)throw new Error(`Unknown npc: ${V(e.id)}`);let i=t.spawnConditions.get(s.id)||[],r=this.filterRequirements(i),o=O.from(s,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,c]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,r,d,c);if(t===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,r),t.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(i),t===this.rom.npcs.Rage?(a=ke.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=ke.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):t===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=F.or(this.rom.flags.MesiaRecording.r,Ke(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):t===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(t===this.rom.npcs.FortuneTeller&&(a=ke.adjust(a,[0,0],[2,0])),F.isClosed(r))return;let[[...l]]=r;for(let d of t.globalDialogs){let c=this.flag(~d.condition),u=this.flag(d.condition);if(c?.logic.assumeFalse||u?.logic.assumeTrue)return;c?.logic.track&&l.push(c.id)}let f=t.localDialogs.get(s.id)??t.localDialogs.get(-1)??[];for(let d of f){let c=[...l],u=this.flag(d.condition),h=this.flag(~d.condition);if(u?.logic.track&&c.push(u.id),!u?.logic.assumeFalse&&!h?.logic.assumeTrue&&this.processDialog(a,t,c,d),u?.logic.assumeTrue||h?.logic.assumeFalse)break;h?.logic.track&&l.push(h.id)}}processDialog(s,e,t,i){this.addCheckFromFlags(s,[t],i.flags);let r={lossy:!0,unique:!0};switch(i.message.action){case 8:this.processKeyUse(s,[t]);break;case 20:this.addItemCheck(s,[t],this.rom.flags.SlimedKensu.id,r);break;case 16:this.addItemCheck(s,[t],this.rom.flags.AsinaInBackRoom.id,r);break;case 17:this.addItemCheck(s,[t],256|e.data[1],r);break;case 3:case 10:this.addItemCheck(s,[t],256|e.data[0],r);break;case 9:let o=e.data[1];o!==255&&this.addItemCheck(s,[t],256|o,r);break;case 25:this.addItemCheck(s,[t],this.rom.flags.AkahanaFluteOfLimeTradein.id,r);break;case 26:this.addItemCheck(s,[t],this.rom.flags.Rage.id,r);break;case 27:break}}processLocationItemUses(s){for(let[e,t]of this.itemUses.get(~s.id))this.processItemUse([this.entrance(s)],F.OPEN,e,t)}handleMovingGuard(s,e,t){if(this.flagset.assumeStatueGlitch())return;let i=[];for(let r of e.spawns.slice(0,2))if(r.isNpc()&&this.rom.npcs[r.id].isParalyzable()){i.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&i.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(s,this.terrainFactory.statue([...t,...i].map(Dt)))}handleBoat(s,e,t){let i=this.walkableNeighbor(s);if(i==null)throw new Error("Could not find walkable neighbor.");let r=s>>8&240|s>>4&15,o=s>>4&240|s&15,a;for(let u of e.exits)u.yt===r&&u.xt<o&&(a=u);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let f=l.entrances[a.entrance],d=O.from(l,f),c=d;for(;;){c=O.add(c,0,-1);let u=this.walkableNeighbor(c);if(u!=null){let h={enter:F.freeze(t),exit:[[15,F.OPEN]]};this.addTerrain([i],h),this.exits.set(i,u),this.exitSet.add(fe.of(i,u)),this.exits.set(d,u),this.exitSet.add(fe.of(d,u)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(s,e,t){let i=this.itemGrant(t),r=256|i;if(i==null)throw new Error(`missing item grant for ${t.toString(16)}`);let o=t>=128;this.addItemCheck(s,e,r,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(s,e){for(let t of s){let i=this.terrains.get(t);i!=null&&this.terrains.set(t,this.terrainFactory.meet(i,e))}}addCheck(s,e,t){if(F.isClosed(e))return;let i={requirement:F.freeze(e),checks:t};for(let r of s)!this.terrains.has(r)||this.checks.get(r).add(i)}addItemCheck(s,e,t,i){this.addCheck(s,e,[t]),this.slots.set(t,i);let r=this.rom.itemGets[this.rom.slots[t&255]],o=this.rom.items[r.itemId],a=o?.unique,l=r.isLosable(),f=a||o===this.rom.items.OpelStatue,d=1;o===this.rom.items.SwordOfWind&&(d=5),o===this.rom.items.SwordOfFire&&(d=5),o===this.rom.items.SwordOfWater&&(d=10),o===this.rom.items.SwordOfThunder&&(d=15),o===this.rom.items.Flight&&(d=15),this.items.set(512|r.id,{unique:a,losable:l,preventLoss:f,weight:d})}addCheckFromFlags(s,e,t){let i=[];for(let r of t){let o=this.flag(r);o?.logic.track&&i.push(o.id)}i.length&&this.addCheck(s,e,i)}walkableNeighbor(s){if(this.isWalkable(s))return s;for(let e of[-1,1]){let t=O.add(s,e,0),i=O.add(s,0,e);if(this.isWalkable(t))return t;if(this.isWalkable(i))return i}}isWalkable(s){return!(this.getEffects(s)&z.BITS)}ensurePassable(s){return this.isWalkable(s)?s:this.walkableNeighbor(s)??s}getEffects(s){let e=this.rom.locations[s>>>16],t=this.rom.tileEffects[e.tileEffects-179].effects,i=e.screens[(s&61440)>>>12][(s&3840)>>>8];return t[this.rom.screens[i].tiles[s&255]]}processBoss(s,e){let{bosses:t}=this.rom,{Rage:i,StatueOfSun:r,StatueOfMoon:o}=t,a=e.id===201,l=e.id===202,f=e.id===195,d=f?i:a?o:l?r:t.fromLocation(s.id),c=O.from(s,e);if(!d||!d.flag)throw new Error(`Bad boss at ${s.name}`);let u=c&-256,h=this.terrainFactory.boss(d.flag.id,f),p=te(240,m=>u|m);this.addTerrain(p,h),!a&&!l&&this.addBossCheck(p,d)}addBossCheck(s,e,t=F.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let i=F.meet(t,this.bossRequirements(e));e===this.rom.bosses.Draygon2?this.addCheck(s,i,[e.flag.id]):this.addItemCheck(s,i,e.flag.id,{lossy:!1,unique:!0})}processChest(s,e){if(this.rom.slots[e.id]>=112)return;let t=256|e.id,i=this.rom.slots[e.id];if(i>=112)return;let r=this.rom.items[i],o=this.flagset.preserveUniqueChecks()?!!r?.unique:!0;this.addItemCheck([O.from(s,e)],F.OPEN,t,{lossy:!1,unique:o})}processMonster(s,e){let t=this.rom.objects[e.monsterId];if(!(t instanceof He))return;let{Money:i,RageSkip:r,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:f,SwordOfThunder:d}=this.rom.flags;if(s.id===this.limeTreeEntranceLocation&&t.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(s)],F.OPEN,[r.id]),!t.goldDrop)return;let c=[O.from(s,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(c,o.r,[i.id]);return}let u=[a,l,f,d].filter((h,p)=>t.elements&1<<p);this.addCheck(c,De(...u),[i.id])}processItemUse(s,e,t,i){s=new Set([...s].map(a=>this.walkableNeighbor(a)??a));let r=[[512|t.id]];t.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&r[0].push(this.rom.flags.Change.c),t===this.rom.items.MedicalHerb&&(r[0][0]=this.rom.flags.BuyHealing.c);let o=F.meet(e,r);switch(this.addCheckFromFlags(s,o,i.flags),i.message.action){case 16:this.processKeyUse(s,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(s,o,t.id);break;case 2:this.addItemCheck(s,o,256|this.rom.npcs[i.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(s,e){let[t,...i]=new Set([...s].map(a=>nt.from(a)));if(t==null||i.length)throw new Error("Expected one screen");let o=this.rom.locations[t>>>8].flags.find(a=>a.screen===(t&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(s,e,[o.flag])}bossRequirements(s){if(s===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=s.object,t=new F.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())t.addAll(this.rom.flags.Sword.r);else{let r=this.flagset.guaranteeSwordMagic()?s.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&t.addAll(this.swordRequirement(a,r))}let i=[];if(s.npc!=null&&s.location!=null){let r=s.npc.spawns(this.rom.locations[s.location]);i.push(...this.filterRequirements(r)[0])}return s===this.rom.bosses.Insect?i.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):s===this.rom.bosses.Draygon2&&i.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&i.push(this.rom.flags.Refresh.c),t.restrict([i]),F.freeze(t)}swordRequirement(s,e){let t=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][s];if(e===1)return t.r;let i=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][s];return e===3?Ke(t,...i):i.map(r=>[t.c,r.c])}itemGrant(s){for(let[e,t]of this.rom.itemGets.actionGrants)if(e===s)return t;throw new Error(`Could not find item grant ${s.toString(16)}`)}filterRequirements(s){let e=[];for(let t of s)if(t<0){if(this.flag(~t)?.logic?.assumeTrue)return F.CLOSED}else{let i=this.flag(t);if(i?.logic.assumeFalse)return F.CLOSED;i?.logic.track&&e.push(i.id)}return[e]}filterAntiRequirements(s){let e=[];for(let t of s)if(t>=0){if(this.flag(~t)?.logic?.assumeFalse)return F.OPEN}else{let i=this.flag(~t);if(i?.logic.assumeTrue)return F.OPEN;i?.logic.track&&e.push([i.id])}return e}flag(s){let e=s,t=this.rom.flags[e];return this.aliases.get(t)??t}entrance(s,e=0){return typeof s=="number"&&(s=this.rom.locations[s]),this.tiles.find(O.from(s,s.entrances[e]))}wallCapability(s){switch(s){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${s}`)}}};function Ke(...n){return[n.map(s=>s.id)]}function De(...n){return n.map(s=>[s.id])}var Ki=!1;function Xi(n){if(!n.compressedMapData){n.compressedMapData=!0;for(let s=0;s<3;s++)n.metascreens.renumber(256|s,320|s),delete n.screens[256|s]}}function Yi(n){if(!n.compressedMapData)throw new Error("Must compress first");let{grass:s,town:e,cave:t,dolphinCave:i,pyramid:r,river:o,sea:a,lime:l,mountain:f,shrine:d,desert:c,mountainRiver:u,swamp:h,house:p,fortress:m,labyrinth:g,iceCave:C,tower:b}=n.metatilesets;n.moveScreens([h],4),n.moveScreens([p],4),n.moveScreens([e],4),n.moveScreens([l],4),n.moveScreens([d],4),n.moveScreens([b],4),n.moveScreens([f,u],4),n.moveScreens([t,r,m,g,C],5);let[]=[a,i,s,o,c]}var[]=[Nt];function Zi(n,s){let o=n.objects[159],a=n.objects[127],l=n.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((c,u)=>l.data[u]=c),l.data[3]=a.data[3];let f=new Set([127-80,141-80]),d=new Set([126-80,159-80]);for(let c of n.locations){if(!c.pits.length)continue;let u=s.nextInt(3)<1;for(let h of c.spawns)!h.isMonster()||(d.has(h.id)&&(h.id=(u?159:126)-80),f.has(h.id)&&(h.id=(u?141:127)-80))}}var[]=[V];function ve(n,s,...e){let t=s,i=0,r;for(;(r=e[i++])!=null;)if(typeof r=="number")n[t++]=r;else if(typeof r=="string")for(let o of r)n[t++]=o.charCodeAt(0);else throw new Error("bad data")}function Ji(n){n[107924]=255,n[118213]=168,n[106870]=255,n[108620]=255,n[120899]=160,n[122987]&=7,n[122991]&=7,n[122995]&=7,n[122999]&=7,n[123003]&=7,n[123012]&=7,n[123035]&=7,n[123065]&=7,n[123141]=47,n[123511]=0,n[123750]=64,n[123761]=0,n[123783]=0,n[123793]=0,ve(n,106856,51,51),ve(n,107662,51,51),n[105393]=112,n[105397]=113,n[105079]=114,n[105963]=115,n[106565]=116,n[106721]=117,n[106725]=118,n[106729]=119,n[108037]=120,n[107457]=121,n[107461]=122,n[107465]=123,ve(n,123063,192,0),ve(n,123690,192,0),ve(n,123696,192,0),ve(n,123702,192,0),ve(n,123104,192,0),ve(n,123110,192,0),n[116739]=0,ve(n,116749,162,179),n[109190]=254,ve(n,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(let s of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])n[s]|=1;ve(n,157038,"Simea",16,0,"     ",16,0)}function Qi(n,s){On(n),gn(n),pn(n),xn(n),bn(n,s),Yn(n),Zn(n),Xn(n),yn(n),Sn(n),En(n),wn(n),Bn(n),In(n),Un(n,s),Hn(n),s.requireHealedDolphinToRide()&&Mn(n),s.saharaRabbitsRequireTelepathy()&&Fn(n),Pn(n,s),Rn(n,s),Tn(n),s.teleportOnThunderSword()?(Gn(n),n.townWarp.thunderSwordWarp=[n.locations.Shyron.id,65]):An(n),kn(n),s.fogLampNotRequired()&&vn(n,s),zn(n),$n(n),Ln(n),_n(n,s),s.disableRabbitSkip()&&Dn(n),s.disableFlightStatueSkip()&&Nn(n),qn(n,s),Cn(n),s.chargeShotsOnly()&&jn(n),s.orbsOptional()&&Kn(n),s.noBowMode()&&Vn(n),Wn(n),s.hardcoreMode()&&Jn(n),s.shouldUpdateHud()&&(mn(n),n.writeMonsterNames=!0),s.shouldColorSwordElements()&&un(n),s.hasStatTracking()&&hn(n)}function hn(n){for(let x=0;x<4;x++)n.patterns.set(5376,41+x,Se.BLANK_TILES[x]);if(n.prg[143082]===40)return;n.prg[143082]=40;let t=143364,i=144132,r=128-1;for(let x=t;x<i;x++)n.prg[x]>=41&&n.prg[x]<=45&&(n.prg[x]+=r);let o=42,a=160;for(let x=t;x<i;x+=192)n.prg[x+a]=o;let l=new Map([[66,a]]),f=142469,d=142546;for(let x=f;x<d;x++)l.has(n.prg[x])&&(n.prg[x]=l.get(n.prg[x]));for(let x=t;x<i;x+=192)for(let v=123;v<=127;v++)n.prg[x+v]==o+r&&(n.prg[x+v]=o);let c=3,u=2,h=144376,p=144440;for(let x=h;x<p;x++){let v=n.prg[x];for(let E=0;E<8;E+=2){let M=c<<E,y=u<<E;(v&M)==M&&(v=v&(255^3<<E)|y)}n.prg[x]=v}let m=144440,g=4*c,C=[15,48,15,17];for(let x=0;x<C.length;x++)n.prg[m+g+x]=C[x];n.prg[m+u*4+3]=8;let b=145114,w=145222;for(let x=b;x<w;x+=4)n.prg[x]+=128}function un(n){function s(e,t){for(let i=0;i<=10;i++){if(i===8)continue;let r=n.patterns.get(i|e),o=[...r.pixels];for(let a=0;a<r.pixels.length;a++)r.pixels[a]=o[a^8],a>>>3===t&&(r.pixels[a]|=o[a])}}s(4240),s(4304),s(4368),s(4432),s(4496)}function mn(n){n.patterns.set(3584,0,Se.HUD_LF),n.patterns.set(3584,1,Se.HUD_PW),n.patterns.set(3584,2,Se.HUD_EY),n.patterns.set(3584,3,Se.HUD_LV),n.patterns.set(3584,4,Se.HUD_DL),n.patterns.set(3584,5,Se.HUD_MP),n.patterns.set(3584,6,Se.HUD_EX),n.patterns.set(3584,26,Se.HUD_CLOSE_LEFT),n.patterns.set(3584,27,Se.HUD_CLOSE_RIGHT)}function pn(n){n.items.GlowingLamp.itemUseData[0].message.action=11}function xn(n){let s=n.nextFreeTrigger("mezame");s.used=!0,s.conditions=[~n.flags.AlwaysTrue.id],s.message=Rt.of({action:4}),s.flags=[n.flags.AlwaysTrue.id],n.locations.MezameShrine.spawns.push(H.of({tile:136,type:2,id:s.id}))}function gn(n){let s=new Set([129,139,144,153,166,167,168,169,170,171,172,n.allocatedTriggers.get("zombie warp")]);for(let e of n.locations)!e.used||(e.spawns=e.spawns.filter(t=>!t.isTrigger()||!s.has(t.id)))}function bn(n,s){if(n.objects[16].atk=3,n.objects[17].atk=6,n.objects[18].atk=8,n.objects[24].atk=3,n.objects[19].atk=5,n.objects[25].atk=5,n.objects[23].atk=7,n.objects[26].atk=7,n.objects[20].atk=3,n.objects[21].atk=6,n.objects[22].atk=8,n.objects[28].atk=3,n.objects[29].atk=3,n.objects[30].atk=5,n.objects[27].atk=7,n.objects[31].atk=7,s.slowDownTornado()){let e=n.objects[18];e.speed=7,e.data[12]=96}}function wn(n){let s=n.trigger(160);s.used=!0,s.conditions=[],s.flags=[],s.message=Rt.of({part:0,index:0,action:21}),n.objects[94].data[13]=254,n.items.InsectFlute.itemUseData[0].flags=[n.flags.UsedInsectFlute.id]}function yn(n){n.items.OpelStatue.selectedItemValue=0}function Sn(n){for(let s of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])n.patterns.set(s<<6,e,n.patterns.get(94<<6,e).pixels);n.objects[12].metasprite=169}function Cn(n){for(let s in[4,5,8,9])n.tileEffects[188-179].effects[s]=24,n.tileEffects[181-179].effects[s]=24}function kn(n){let{tiles:s}=n.screens[161];s[40]=159,s[55]=35,s[56]=35,s[57]=33,s[71]=141,s[72]=143,s[86]=153,s[87]=154,s[88]=140}function vn(n,s){let{flags:{AlwaysTrue:e,InjuredDolphin:t,FogLamp:i,KensuInCabin:r,ReturnedFogLamp:o},items:{ShellFlute:a},locations:{BoatHouse:l,Portoa_FishermanHouse:f},npcs:d}=n,c=s.requireHealedDolphinToRide();a.itemUseData[0].want=c?t.id:e.id,d.KensuInCabin.data[0]=103,d.KensuInCabin.localDialogs.get(-1)[0].message.action=10,d.KensuInCabin.localDialogs.get(-1)[0].flags=[],d.KensuInCabin.spawnConditions.set(l.id,[o.id,~r.id]),d.Fisherman.spawnConditions.set(f.id,[i.id]),n.itemGets[100].flags=[],n.itemGets[103].copyFrom(n.itemGets[100])}function En(n){for(let s of n.locations)for(let e of s.spawns)e.isChest()&&(e.timed=!1)}function In(n){let s=n.locations;s.GoaFortress_Kelbesque.spawns[0].x-=16,s.GoaFortress_Zebu.spawns.splice(1,1),s.GoaFortress_Tornel.spawns.splice(2,1),s.GoaFortress_Asina.spawns.splice(2,1),s.GoaFortress_Kensu.spawns.splice(3,1),s.GoaFortress_Kensu.spawns.splice(1,1)}function Rn(n,s){let{items:{AlarmFlute:e},flags:{TalkedToZebuStudent:t,ZebuStudent:i},locations:{MezameShrine:r,Leaf_StudentHouse:o,WaterfallCave4:a,ZebuCave:l},npcs:{WindmillGuard:f,Zebu:d}}=n;if(n.itemGets[49].inventoryRowStart=32,e.unique=!0,e.basePrice=0,s.zebuStudentGivesItem())f.data[1]=49;else{f.data[1]=255;let h=f.dialog(o)[0];h.condition=~t.id,h.flags.push(t.id),er(d.spawns(l),i.id,t.id),r.spawns.push(H.of({screen:0,tile:155,type:2,id:49})),r.spawns.push(H.of({screen:0,tile:149,type:2,id:73})),n.itemGets[73].itemId=n.items.MedicalHerb.id}let c=[[33,.72],[31,.9]],u=0;for(let h of n.shops)if(h.type===1)for(let p=0,m=h.contents.length;p<m;p++){if(h.contents[p]!==49)continue;let[g,C]=c[u++%c.length];h.contents[p]=g,n.shopDataTablesAddress&&(h.prices[p]=Math.round(h.prices[p]*C))}n.itemGets[91].itemId=29,a.spawn(25).id=16}function Tn(n){let{flags:{Karmine:s,Mado1:e},npcs:{Brokahana:t}}=n,i=ui(t.localDialogs.get(-1))[0];if(i.condition!==~s.id)throw new Error(`Bad brokahana condition: ${i.condition}`);i.condition=~e.id}function Mn(n){let{flags:{InjuredDolphin:s,ShellFlute:e},npcs:{Fisherman:t,FishermanDaughter:i}}=n;t.spawnConditions.set(214,[e.id,s.id]);let r=i.localDialogs.get(-1);r.unshift(r[0].clone()),r[0].condition=~s.id,r[1].condition=~e.id}function Fn(n){let{flags:{Telepathy:s},npcs:{Deo:e,SaharaBunny:t}}=n;t.globalDialogs.push(Ms.of(~s.id,[26,18])),e.globalDialogs.push(Ms.of(~s.id,[26,19]))}function Gn(n){let{flags:{WarpShyron:s}}=n;n.itemGets[3].flags.push(s.id)}function An(n){n.itemGets[3].acquisitionAction.action=22}function Pn(n,s){if(s.leatherBootsGiveSpeed()){let e=n.items[47];if(e.menuName="Speed Boots",e.messageName="Speed Boots",s.changeGasMaskToHazmatSuit()){let t=n.items[41];t.menuName="Hazmat Suit",t.messageName="Hazmat Suit"}}for(let e=5;e<12;e+=2)n.items[e].menuName=n.items[e].menuName.replace("Ball","Orb"),n.items[e].messageName=n.items[e].messageName.replace("Ball","Orb")}function Bn(n){let{flags:{BallOfWind:s,TornadoBracelet:e},npcs:{Tornel:t}}=n,i=t.localDialogs.get(33),r=[i[0],i[2],i[2].clone(),i[1]];r[1].condition=~e.id,r[2].condition=~s.id,r[3].condition=-1,t.localDialogs.set(33,r)}function Ln(n){let{CordelPlainEast:s,KirisaMeadow:e,UndergroundChannel:t}=n.locations;for(let i of[s,e,t])for(let r of i.spawns)r.isChest()&&(r.data[2]|=32)}function _n(n,s){let{CordelPlainEast:e,CordelPlainWest:t}=n.locations;for(let i of e.spawns)(i.isChest()||s.disableTeleportSkip()&&i.isTrigger())&&t.spawns.push(i.clone())}function Dn(n){for(let s of n.locations.MtSabreNorth_Main.spawns)s.isTrigger()&&s.id===134&&s.x===1856&&(s.x+=16,s.y+=16)}function Nn(n){let s=n.hitboxes[n.objects.guardianStatueMissile.hitbox],e=n.hitboxes[6];n.objects.guardianStatueMissile.hitbox=e.id,e.x0=s.x0-6,e.w=s.w+12,e.y0=s.y0-2,e.h=s.h+4}function Wn(n){n.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function On(n){let{flags:{WarpZombie:s},locations:{ZombieTown:e}}=n;n.flags.insertZombieWarpFlag();let t=n.messages.parts[33][0];t.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let i=n.nextFreeTrigger("zombie warp");i.used=!0,i.conditions=[],i.message=Rt.of({}),i.flags=[s.id];for(let r of e.spawns)r.isTrigger()&&r.id===138&&(r.id=i.id);if(n.townWarp.locations.splice(7,0,e.id),n.townWarp.locations.pop()!==255)throw new Error("unexpected")}function zn(n){n.trigger(138).conditions=[~n.flags.CurrentlyRidingDolphin.id],n.messages.parts[29][16].text=`The cave entrance appears
to be underwater. You'll
need to swim.`}function $n(n){let s=n.nextFreeTrigger("channel item");s.used=!0,s.conditions=[n.flags.CurrentlyRidingDolphin.id,~n.flags.UndergroundChannelUnderwaterChest.id];let e=n.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",s.message=Rt.of({part:e.part,index:e.id,action:15});let t=n.locations.UndergroundChannel.spawns.find(i=>i.isChest());t.data[2]=2,t.yt++,t.id=s.id,n.itemGets.actionGrants.set(s.id,59)}function Hn(n){let e=n.npcs[13].localDialogs.get(53)[0];e.message.action=23}function qn(n,s){let e=n.locations.LimeTreeLake,t=n.screens[n.metascreens.limeTreeLake.sid];if(s.disableRageSkip()){t.set2d(32,t.get2d(0,143)),t.set2d(42,t.get2d(58,1)),t.set2d(16,t.get2d(32,4)),t.set2d(26,t.get2d(42,5)),t.set2d(27,t.get2d(0,16));for(let r of e.spawns)r.tile+=32;let i=n.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(r=>r+32)}else t.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function Un(n,s){function e(W,re){let N=W.indexOf(re);if(N<0)throw new Error(`Could not find element ${re} in ${W}`);W.splice(N,1)}function t(W,re){let N=W.findIndex(re);if(N<0)throw new Error(`Could not find element in ${W}`);W.splice(N,1)}let{locations:{BoatHouse:i,Brynmaer:r,Crypt_Draygon2:o,Joel_Shed:a,Leaf_ElderHouse:l,MtSabreNorth_SummitCave:f,MtSabreWest_Upper:d,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:u,Portoa_AsinaRoom:h,Portoa_FortuneTeller:p,Shyron_Temple:m,StomHouse:g,Swan_DanceHall:C,Swan_Tavern:b,WindmillCave:w,WaterfallCave4:x,WaterfallValleyNorth:v,ZebuCave:E,ZombieTown_HouseBasement:M},items:{GlowingLamp:y,KeyToPrison:I,LovePendant:G,StatueOfOnyx:K},npcs:{Akahana:Y,AkahanaInBrynmaer:J,Asina:oe,AztecaInShyron:U,Clark:ce,Draygon:B,FortuneTeller:A,Kensu:Ge,KensuInCabin:Ae,KensuInSwan:$,LeafElder:me,LeafRabbit:le,OakChild:ze,OakElder:lt,OakMother:ye,PortoaPalaceFrontGuard:Pe,PortoaQueen:ie,PortoaThroneRoomBackDoorGuard:bs,Rage:bt,Stom:wt,StonedAkahana:dt,Tornel:yt,WindmillGuard:ws,Zebu:Ze},flags:P}=n;Ge.localDialogs.delete(b.id),$.link(Ge.id),$.used=!0,$.data=[...Ge.data],Ge.data[0]=y.id,C.spawns.find(W=>W.isNpc()&&W.id===Ge.id).id=$.id,G.itemUseData[0].want=256|$.id,dt.linkDialog(Y.id),J.used=!0,J.link(Y.id),J.data=[...Y.data],r.spawns.find(W=>W.isNpc()&&W.id===Y.id).id=J.id,K.itemUseData[0].want=256|J.id,me.dialog(l).splice(0,0,...me.dialog(l).splice(2,1)),le.dialog()[2].condition=P.RescuedLeafElder.id,le.dialog()[2].flags.push(P.TalkedToLeafRabbit.id),le.dialog()[3].flags.push(P.TalkedToLeafRabbit.id),ws.spawns(w)[1]=~P.WindmillGuardAlarmFluteTradein.id,e(Y.spawns(x),~P.BehindWhirlpool.id),e(dt.spawns(x),~P.BehindWhirlpool.id);function ys(W){W.reverse();for(let re=0;re<W.length;re++){let N=W[re+1];W[re].condition=N?~N.condition:-1}}for(let W=0;W<4;W++){let re=lt.dialog()[W];re.condition!==n.flags.OakElder.id&&(re.message.action=3)}(()=>{let[W,re,N,Pt]=ye.dialog();Pt.condition=~P.RescuedChild.id,re.condition=-1,ye.dialog().splice(0,4,Pt,N,W,re)})();for(let W of[32,33,34,124,125])ys(n.npcs[W].dialog());ze.dialog().unshift(...ze.dialog().splice(1,1)),bs.spawnConditions.set(c.id,[~P.QueenNotInThroneRoom.id,~P.MesiaRecording.id]),Pe.dialog()[1].condition=P.MesiaRecording.id,ie.dialog()[3].condition=P.SwordOfWater.id,ie.dialog()[3].message.action=3,ie.dialog()[4].flags.push(P.PortoaQueenGoingAway.id),ie.spawns(c)[1]=~P.MesiaRecording.id,ie.spawns(h)[0]=P.MesiaRecording.id,ie.dialog()[1].condition=P.MesiaRecording.id,A.spawns(p)[1]=~P.MesiaRecording.id,ce.spawnConditions.set(M.id,[~P.Clark.id]),ce.spawnConditions.set(a.id,[P.Clark.id]),Ze.localDialogs.set(E.id,[Be.of(~P.TalkedToZebuInCave.id,[0,26],[P.TalkedToZebuInCave.id]),Be.of(P.LeafVillagersRescued.id,[0,29]),Be.of(P.LeafAbduction.id,[0,28]),Be.of(P.ZebuAtWindmill.id,[0,29]),Be.of(P.UsedWindmillKey.id,[0,27,3]),Be.of(-1,[0,29])]),e(Ze.spawns(E),~P.BehindWhirlpool.id),yt.spawnConditions.delete(d.id),wt.spawnConditions.delete(g.id),e(oe.spawns(h),~P.CalmedAngrySea.id);let $e=n.npcs[52];$e.spawnConditions.set(c.id,[P.MesiaRecording.id,~P.PortoaQueen.id]),$e.localDialogs.set(u.id,$e.localDialogs.get(-1)),$e.data[0]=n.items.FluteOfLime.id;let St=n.messages.alloc();St.text="The queen left this for you.",$e.localDialogs.set(c.id,[Be.of(~P.PortoaQueen.id,[St.part,St.id,3]),Be.of(-1,[10,14])]),c.spawns.push(H.of({yt:3,xt:12,type:1,patternBank:1,id:$e.id})),ie.localDialogs.set(h.id,ie.dialog().splice(0,2)),ie.localDialogs.set(c.id,ie.dialog()),ie.localDialogs.delete(-1),Ae.spawnConditions.set(i.id,[~P.AbleToRideDolphin.id,P.ReturnedFogLamp.id]),Ae.dialog()[0].message.action=2,U.spawns(m).push(~P.ShyronMassacre.id),n.trigger(130).conditions.push(~P.ShyronMassacre.id),bt.dialog()[0].condition=P.SwordOfWater.id,B.spawnConditions.set(o.id,[~P.Draygon2.id]),Ze.dialog(m).unshift(...Ze.dialog(m).splice(1,1)),n.trigger(128).conditions=[~P.ShyronMassacre.id,P.TalkedToZebuInShyron.id,P.SwordOfThunder.id],n.trigger(129).conditions=[],s.barrierRequiresCalmSea()&&n.trigger(132).conditions.push(P.CalmedAngrySea.id),n.trigger(140).conditions.push(P.TalkedToZebuInCave.id),n.trigger(141).used=!1;for(let W of f.spawns)W.isTrigger()&&W.id===141&&(W.id=178);t(v.spawns,W=>W.isTrigger()&&W.id===141),n.trigger(178).conditions.push(P.Kelbesque1.id),n.trigger(178).flags.push(~P.LeafVillagersCurrentlyAbducted.id,~P.LeafElderCurrentlyAbducted.id,P.LeafVillagersRescued.id),n.trigger(140).conditions.push(~P.Kelbesque1.id),n.trigger(134).conditions.push(~P.Kelbesque1.id),e(I.itemUseData[0].flags,~P.LeafVillagersCurrentlyAbducted.id),er(n.trigger(187).conditions,~P.Rage.id,~P.MesiaRecording.id)}function jn(n){for(let s of[8,9,39])n.objects[s].collisionPlane=0;n.npcs.Brokahana.data[0]=n.items.FruitOfLime.id}function Kn(n){for(let s of[16,20,24,29])n.objects[s].terrainSusceptibility&=-5,n.objects[s].level=2}function Vn(n){let{flags:{UsedBowOfTruth:s},locations:{Crypt_Draygon2:e,MezameShrine:t}}=n,i;for(let r of t.spawns)r.isTrigger()&&r.tile===136&&(i=n.trigger(r.id));if(!i)throw new Error("Could not find start trigger");i.flags.push(s.id),n.tileEffects[185-179].effects[88]=0,t.meta.setExit(0,"door",[e.meta.id<<8|16,"edge:bottom"])}function Xn(n){n.objects[51].elements=15}function Yn(n){n.tileEffects[181-179].effects[116]=6,n.tileEffects[182-179].effects[70]=6}function Zn(n){for(let s of n.objects)s instanceof He&&(s.isProjectile()||s.isBoss()||s.isFlyer()||s!==n.objects.mimic&&(s.terrainSusceptibility|=3))}function er(n,s,e){for(let t=0;t<n.length;t++)if(n[t]===s){n[t]=e;return}throw new Error(`Could not find ${s} in ${n.join(",")}`)}function Jn(n){for(let s of n.locations)s.checkpoint=s.saveable=!1}function tr(n,s,e){if(!s.randomizeTrades())return;let{items:{StatueOfOnyx:t,FogLamp:i,LovePendant:r,KirisaPlant:o,IvoryStatue:a},locations:{Swan_DanceHall:l,PortoaPalace_ThroneRoom:f},npcs:{KensuInSwan:d}}=n,c=new Map,u=[[t,0,"Akahana"],[i,0,"Fisherman"],[r,0,"Kensu"],[o,0,"Aryllis"],[a,0,"Slimed Kensu"]],h=u.map(([g,C,b])=>{if(g.trades.indexOf(C)<0||C>=g.itemUseData.length)throw new Error(`not a trade: ${g} ${C}`);return[g.itemUseData[C],g.id,b]});e.shuffle(h);for(let[g,C]of u){let[b,w,x]=h.pop();g.itemUseData[C]=b,n.spoiler&&n.spoiler.addTrade(g.id,g.messageName,x),b.want===356&&s.fogLampNotRequired()&&([...n.npcs[100].spawnConditions.values()][0][0]=512|g.id),c.set(w,g.id)}n.itemGets.actionGrants=new Map([...n.itemGets.actionGrants].map(([g,C])=>[c.get(g)??g,C]));let p=n.items[e.nextInt(4)];n.npcs[195].localDialogs.get(-1)[0].condition=512|p.id,n.spoiler&&n.spoiler.addTrade(p.id,p.messageName,"Rage"),n.npcs.PortoaQueen.dialog(f)[1].condition=512|p.id;let m=n.items[e.nextInt(4)*2+6];for(let g of n.npcs[95].localDialogs.values())for(let C=2;C<g.length;C++)if(g[C].message.action===3){g[C-2].condition=~(512|m.id-1),g[C-1].condition=~(512|m.id),n.spoiler&&n.spoiler.addTrade(m.id,m.messageName,"Tornel");break}d.dialog(l)[0].message.mid="13:00"}function sr(n){let s=new Map;for(let e of n.items)for(let t of e.trades)s.set(e.itemUseData[t].want&255,e.id);return s}function rr(n){let{flags:{AkahanaStatueOfOnyxTradein:s,AsinaInBackRoom:e,BehindWhirlpool:t,KensuInSwan:i,MtSabreNorthSummit:r,MtSabreWestTornel:o,PortoaQueen:a,Rage:l,RepairedStatue:f,SlimedKensu:d,StomFightReward:c,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:h},npcs:{AkahanaInBrynmaer:p,Aryllis:m,Fisherman:g,PortoaQueen:C},locations:{PortoaPalace_ThroneRoom:b}}=n;A("03:06",",","");let w=sr(n);function x($){let me=w.get($.id);if(!me)throw new Error(`No trade-in for ${$.name}`);return n.items[me]}h.item.isMagic()||ce("00:1b"),A("00:1b","[41:Refresh]",B(h.item));let v=x(p);A("02:01","an unusual statue",ir(v)),A("02:02","a statue",`the ${hs(v)}`),A("02:02","[29:Gas Mask]",B(s)),c.item.isMagic()||ce("03:01"),A("03:01","[43:Telepathy]",B(c));let E=to(n);A("03:01","[06:Tornado Bracelet]",B(E)),A("05:0a","[06:Tornado Bracelet]",B(E)),A("05:0a","[44:Teleport]",B(o));let M=x(g);A("09:01","[35:Fog Lamp]",B(M)),A("09:04","[35:Fog Lamp]",B(M)),A("09:05","[35:Fog Lamp]",B(M)),A("09:06","lamp",hs(M));let y=C.dialog(b)[1].condition;A("0a:0c","[28:Flute of Lime]",B(a)),A("0a:0d","[02:Sword of Water]",B(y)),e.item.isMagic()||ce("0b:01"),A("0b:01","[45:Recover]",B(e)),t.item.isMagic()||(ce("0b:01"),ce("1d:12")),A("0b:01","[46:Barrier]",B(t)),A("1d:12","[46:Barrier]",B(t));let I=Ge(79,78,77,76,71,70,69,68,75,74,73,72);I?A("0d:00","[35:Fog Lamp]",B(I)):A("0d:00","that a [35:Fog Lamp] was","there was treasure");let G=n.npcs.Rage.dialog()[0].condition;A("0e:03","[02:Sword of Water]",B(G)),A("0e:03","[09:Ball of Water]",B(l)),A("10:0c","that's","is"),A("10:0c",/, is in the\+lighthouse/,"");let K=x(m);A("12:05","[3c:Kirisa Plant]",B(K)),A("12:10","the plant",`the ${hs(K)}`),A("12:10","[3c:Kirisa Plant]",B(K));let Y=`Our illustrious chief seeks ${ir(K)}.`;A("12:09",/[^]*/,Y),A("12:0a",/[^]*/,Y);let J=x(n.npcs.KensuInSwan);A("13:02","[3b:Love Pendant]",B(J)),A("13:00","pendant",hs(J)),i.item.isMagic()||ce("13:02"),A("13:02","[47:Change]",B(i));let oe=x(n.npcs.SlimedKensu);A("18:06","[3d:Ivory Statue]",B(oe)),A("18:07","[3d:Ivory Statue]",B(oe)),A("18:06","It's in a room","{0b:Karmine} is"),d.item.isMagic()||A("18:07","teach","give"),A("18:07","[48:Flight]",B(d)),r.item.isMagic()||ce("1c:10"),A("1c:10","[42:Paralysis]",B(r)),A("20:06","Statue of Gold",B(f));let U=n.allocatedTriggers.get("channel item");U!=null&&A(n.trigger(U).message.mid,"[3b:Love Pendant]",B(u));{let $=n.messages.alloc();n.trigger(134).message.mid=$.mid,$.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",n.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function ce($){A($,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function B($){return typeof $=="number"?$=n.items[n.itemGets[$&255].itemId]:$ instanceof Si||($=$.item),`[${V($.id)}:${$.messageName}]`}function A($,me,le){let[ze,lt]=$.split(":").map(Pe=>parseInt(Pe,16)),ye=n.messages.parts[ze][lt];ye.text=ye.text.replace(me,le)}function Ge(...$){let me=[le=>Qn.has(le),le=>eo.has(le),le=>Ae(le).unique];for(let le of me)for(let ze of $){let ye=[...n.locations[ze].spawns].reverse();for(let Pe of ye){if(!Pe.isChest())continue;let ie=n.slots[Pe.id];if(ie<=72&&le(ie))return n.items[ie]}}}function Ae($){let me=n.itemGets[$];return n.items[me.itemId]}}var Qn=new Set([62,63,64]),eo=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function to(n){let{Tornel:s}=n.npcs;for(let e of s.localDialogs.values())for(let t=2;t<e.length;t++){let i=~e[t].condition;if(i>516&&i<=524&&!(i&1))return n.items[i&255]}return n.items.TornadoBracelet}function ir(n){let s=n.rom.items;switch(n){case s.StatueOfOnyx:return"an unusual statue";case s.FluteOfLime:return"a rare instrument";case s.FogLamp:return"a brilliant lamp";case s.LovePendant:return"a beautiful charm";case s.KirisaPlant:return"a fragrant plant";case s.IvoryStatue:return"an exotic statue"}return Ts(),"a valuable item"}function hs(n){let s=n.rom.items;switch(n){case s.StatueOfOnyx:return"statue";case s.FluteOfLime:return"instrument";case s.FogLamp:return"lamp";case s.LovePendant:return"pendant";case s.KirisaPlant:return"plant";case s.IvoryStatue:return"statue"}return Ts(),"item"}function or(n){let{locations:{Portoa:s,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:t,UndergroundChannel:i,WaterfallCave2:r,WaterfallCave3:o}}=n;Vs(t,"edge:bottom",183,s),Vs(e,"door",146,i),Vs(r,"stair:up",191,o),io(n)}function Vs(n,s,e,t){let[i,...r]=[...n.meta.exits()].filter(([,g])=>g===s);if(!i)throw new Error(`Could not find ${s} in ${n}`);if(r.length)throw new Error(`Ambiguous ${s} in ${n}`);let[o,a]=i[2],l=o>>>8;if(l===t.id)return;let f=o&255,d=n.rom.locations[l],u=d.meta.get(f).data.exits.find(g=>g.type===a);if(!u)throw new Error(`Bad entrance in ${d}`);let h=((u.entrance&61440)>>>8|(u.entrance&240)>>>4)+so[u.dir];d.spawns.length>17&&d.spawns.pop();let p=t.spawns.findIndex(g=>g.isTrigger()&&g.id===e),m=p>=0?t.spawns.splice(p,1)[0]:H.of({type:2,id:e});m.xt=(f&15)<<4|h&15,m.yt=f&240|h>>>4,d.spawns.push(m)}var so=[16,0,0,0];function io(n){let{locations:{MtSabreNorth_Main:s,ValleyOfWind:e}}=n;for(let t of nr(e,17)){let i=n.locations[t>>>8],r=t&255;us(i,r,n.flags.OpenedSealedCave)}for(let t of nr(s,4)){let i=n.locations[t>>>8];if(i.data.fixed||i.spawns.length>15)continue;let r=t&255;us(i,r,n.flags.OpenedPrison);let o=i.meta.get(r).findExitByType("cave").entrance,a=H.of({screen:r,coord:o,type:2,id:173});if(i.spawns.push(a),i.spawns.length>15)continue;let l=H.of({screen:r,coord:o-4112,type:4,id:44});i.spawns.splice(1,0,l)}}function nr(n,s){let e=new Set([n,n.id<<8|s]),t=new Set;for(let r of n.meta.exits())r[0]===s&&(r[1]==="cave"||r[1]==="gate")&&t.add(r[2]);let i=[];for(let r of t){if(e.has(r[0]))continue;let o=n.rom.locations[r[0]>>>8],a=r[0]&255;if(!o.meta.customFlags.has(a)){if(r[1]==="cave"||r[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?i.push(r[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||t.add(l[2])}}}return console.log(`From ${n}: ${i.map(r=>r.toString(16))}`),i}function us(n,s,e,t){e?n.meta.customFlags.set(s,e):n.meta.customFlags.delete(s),!t&&(n===n.rom.locations.CordelPlainEast?us(n.rom.locations.CordelPlainWest,s,e,!0):n===n.rom.locations.CordelPlainWest&&us(n.rom.locations.CordelPlainEast,s,e,!0))}function ar(n){ro(n)}function ro(n){let{locations:{AngrySea:s},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:t,beachCave:i,beachExitN:r,boatChannel:o}}=n;e.spawnScripts=[];let a=new Set(te(16,l=>l));for(let l=0;l<s.entrances.length;l++){let f=s.entrances[l],d=s.meta.get(f.screen),c;if(d===o){if(s.meta.get(f.screen-1)!==t)throw new Error(`Bad boatChannel entrance ${f}`);f=Je.of({screen:f.screen-1,tile:0}),d=t}d===t?c={entrance:Je.of({screen:f.screen-17,coord:47336}),movement:5}:d===i?c={entrance:Je.of({screen:f.screen,coord:59400}),movement:8}:d===r&&(c={entrance:Je.of({screen:f.screen,coord:55544}),movement:9}),c&&(a.delete(l),e.spawnScripts[l]=c)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:Je.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:Je.of({x:424,y:120}),movement:7}}function dr(n){let s=new Set;for(let e of n.locations)for(let t of e.pits??[])s.add(t.dest<<8|t.toScreen);for(let e of s){let t=n.locations[e>>8],i=e&255,r=t.exits.filter(d=>d.screen===i),o=t.entrances.filter(d=>d.screen===i),a=new Map(r.map(d=>[d.tile,d])),l=new pe;for(let d of a.keys())for(let c of lr)a.has(d+c)&&l.union([d,d+c]);let f=l.map();for(let d of o)for(let c of lr){let u=f.get(d.tile+c);for(let h of u??[]){let p=a.get(h),m=wi.of({screen:e&255,tile:h+c,dest:p.dest,entrance:p.entrance});t.exits.push(m)}}}}var lr=[1,-1,16,-16];function cr(n,s){let e=[...n.townWarp.locations].filter(l=>l!==255),t=s.nextInt(e.length),i=e[t],r=64;(i===n.locations.Shyron.id||i===n.locations.Shyron_Temple.id)&&(r=65),n.townWarp.thunderSwordWarp=[i,r];let o=768-e.length+t,a=n.itemGets[3].flags;for(let l=0;l<a.length;l++)if(a[l]===765){a[l]=o;return}a.push(o)}function fr(n,s,e){let t=new Set(te(256,o=>o).filter(o=>o in n.objects));for(let[o]of ot)t.delete(o);for(let[o,a]of ot)for(let l of t)n.objects[o].base===n.objects[l].base&&(ot.set(l,a),t.delete(o));for(let o of[200,249,250])n.objects[o].attackType=o>240?254:255,n.objects[o].statusEffect=0;n.objects[125].elements|=8;let i=new Set([87,94,104,125,136,151,155,158]),r=new Set([80,83,95,105]);for(let[o,{sdef:a,swrd:l,hits:f,satk:d,dgld:c,sexp:u}]of ot){let h=n.objects[o].data,p=i.has(o)?1:0;if(h[2]|=128,h[6]=f,h[7]=d,h[8]=a|l<<4,h[16]=h[16]&15|c<<4,h[17]=u,(p?s.shuffleBossElements():s.shuffleMonsterElements())&&!r.has(o)){let m=[...n.objects[o].elements.toString(2).padStart(4,"0")];e.shuffle(m),n.objects[o].elements=Number.parseInt(m.join(""),2)}}if(s.shuffleMonsterElements()){let o=e.nextInt(4);for(let a of r)n.objects[a].elements=1<<o}}var ot=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([n,s,e,t=0,i=0,r=0,o=0,a=0,l=0])=>[n,{id:n,type:s,name:e,sdef:t,swrd:i,hits:r,satk:o,dgld:a,sexp:l}]));function no(n){console.log("flip sabera entrance");let s=n[0];s.set2d(113,[[s.rom.metascreens.deadEndE_upStair],[s.rom.metascreens.caveEmpty]]),s.moveExits([129,"stair:down",113,"stair:up"]),n[1]=113,n[2]="stair:up"}function oo(n,s){console.log("flip karmine entrance");let e=n[0],t=e.rom.metascreens;e.set2d(32,[[t.caveEmpty,t.hallNS],[t.deadEndE_upStair,t.hallNW]]),e.replaceMonsters(s),e.moveExits([48,"stair:down",48,"stair:up"]),n[2]="stair:up"}function ao(n){console.log("flip karmine exit");let s=n[0],e=s.rom.metascreens;s.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),s.moveExits([2,"stair:down",1,"stair:up"]),n[1]=1,n[2]="stair:up"}function Xs(n){console.log("flip generic exit");let s=n[0],e=s.rom.metascreens;s.width<2&&(s.width=2),s.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),s.moveExits([0,"stair:up",1,"stair:down"]),n[1]=1,n[2]="stair:down"}function Ys(n,s){n[3](n,s),n[3]=void 0}function hr(n,s){let e=n.locations,t=[0,1,2,3];s.shuffle(t);let i=[[e.GoaFortress_Kelbesque.meta,131,"stair:down"],[e.GoaFortress_Sabera.meta,129,"stair:down",no],[e.GoaFortress_Mado1.meta,114,"stair:down"],[e.GoaFortress_Karmine1.meta,48,"stair:down",oo]],r=[[e.GoaFortress_Zebu.meta,0,"stair:up",Xs],[e.GoaFortress_Tornel.meta,0,"stair:up",Xs],[e.GoaFortress_Asina.meta,0,"stair:up",Xs],[e.GoaFortress_Kensu.meta,2,"stair:down",ao]],o=[[e.GoaFortress_Entrance.meta,0,"edge:top"]],a=[],l=!0,f=o[0];for(let d of t){let c=l||i[d][3]||o[o.length-1][3],u=c?s.pick([!1,!0]):!0;console.log(`FLOOR ${d}: up ${l} flexible ${!!c} reverse ${u}`);let h=u?r[d]:i[d];console.log(`push b ${n.locations[h[0].id].name}`),a.push(h),l!==(h[2]==="stair:down")&&(h[3]?Ys(h,s):Ys(f,s)),o.push(f=u?i[d]:r[d]),console.log(`push a ${n.locations[f[0].id].name}`),l=f[2]==="stair:up"}l&&Ys(f,s),a.push([e.GoaFortress_Exit.meta,1,"stair:up"]);for(let d=0;d<o.length;d++)o[d][0].attach(o[d][1],a[d][0],a[d][1],o[d][2],a[d][2])}var lo=6,co=33,Zs=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),fo=new Set(["inn","armor","tool","pawn"]),ur=new Set([...fo,"house","tavern"]);function mr(n,s,e){let{locations:{Crypt_Hall1:t,Goa:i,GoaFortress_Exit:r,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:f}}=n,d=new Set([i.id,o.id]),c=new Set([a.data.id,l.data.id,f.data.id]);if(s.shuffleAreas())for(let w of[i,r,o,t])w.data.houseType="palace";let u=new D(()=>[]),h=new D(()=>[]),p=new D(()=>new Set);for(let w of n.locations){if(!w.used||w.data.houseType==null)continue;let x;for(let[v,E,M]of w.meta.exits()){let y=(v&240)<<4|w.meta.get(v).findExitByType(E).entrance>>>8;(!x||y>x[3])&&(x=[v,E,M,y])}for(let[v,E,M]of[x]){let y={type:w.data.houseType,inside:[w.id<<8|v,E],outside:M},I=M[0];h.get(I).push(y),u.get(w.data.houseType).push(y);let G=n.locations[I>>>8].screens[I>>>4&15][I&15];p.get(G).add(I)}}let m=new Map,g=new Map;for(let[w,x]of e.ishuffle(p))x.size>=2||c.has(w)?g.set(w,x):m.set(w,x);let C=new Set,b=u.get("inn");for(let[,w]of[...g,...m]){let x=new Map,v=!0;for(let E of w){for(let M of h.get(E)){let y=v&&ur.has(M.type)?[...ur].map(B=>u.get(B)):[u.get(x.get(M.outside[1])??M.type)];y=y.filter(B=>B.length),M.type==="palace"&&d.has(M.outside[0]>>>8)&&(y=y.map(B=>B.filter(A=>!d.has(A.inside[0]>>>8))));let I=[...w].every(B=>!C.has(B>>>8));!I&&y.length>1?y=y.filter(B=>B!==b):I&&y.some(B=>B===b)&&(y=[b]);let G=e.pickAndRemove(...y);if(G.type==="inn")for(let B of w)C.add(B>>>8);if(x.set(M.outside[1],G.type),n.spoiler&&n.spoiler.addHouse(G.inside[0]>>>8,M.outside[0]>>>8),xe.connect(n,M.outside,G.inside),!v||Zs.get(M.type)===Zs.get(G.type))continue;let K=n.locations[M.outside[0]>>>8];if(K.meta.tileset!==n.metatilesets.town)continue;let Y=xe.findExitTiles(n,M.outside);if(Y.length>1)continue;let J=Y[0]-32;(Y[0]&240)<32&&(J-=3856);let oe=J>>8,U=J&255,ce=Zs.get(G.type)??(K.meta.get(oe).data.tallHouses?.includes(U)?co:lo);n.screens[K.screens[oe>>4][oe&15]].tiles[U]=ce}v=!1}}}function pr(n,s,e){let t=[],i=[];for(let r of n.locations)if(!ho.has(r.id)){for(let o of r.spawns)if(o.isChest()){let a=n.slots[o.id];if(a>=112&&i.push(o.id),s.preserveUniqueChecks()){let l=n.itemGets[a];if(n.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;t.push(o.id)}}e.shuffle(t),n.slots.setMimicCount(i.length),[...se.zip(i,t,(r,o)=>n.slots.swap(r,o))]}var ho=new Set([182]);function xr(n,s){for(let e of n.locations)(e.id&248)!==88&&e.meta.replaceMonsters(s)}var ms=class{constructor(s){this.rom=s;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new D(()=>[]);for(let t of s.locations)if(!!t.used)for(let i=0;i<t.spawns.length;i++){let r=t.spawns[i];!r.used||(r.isMonster()?e.get(r.monsterId).push([t,i,r]):(r.isNpc()||r.isBoss())&&e.get(~r.id).push([t,i,r]))}for(let[t,i]of e)if(t<0){let r=s.npcs[~t],o=[r.data[3]];if(!s.metasprites[o[0]])throw new Error(`bad NPC: ${~t}`);r.data[2]===208&&o.push(192);let l=r.data[2]<128?r.data[2]&112:0,f=this.computeConstraint(o,i,!0,l);~t===95&&(f=f.ignorePalette()),this.npcConstraints.set(~t,f)}else{let r=ne.ALL,o=this.rom.objects[t];for(let a of Js(s,o)){let f=s.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(f(a),i,a.id===t,a.data[1]),c=r.meet(d);if(!c)throw new Error(`Bad meet for ${t} with ${a.id}`);if(c&&(r=c),a.data[4]&2){let u=this.computeConstraint([a.data[20]],i,!1,a.data[1]),h=r.meet(u);if(!h)throw new Error(`Bad meet for ${t} bonus ${a.id}`);r=h}}this.monsterConstraints.set(o.id,r),o.constraint=r}}getMonsterConstraint(s,e){let t=this.monsterConstraints.get(e)||ne.NONE;return(s&88)===88||!this.rom.objects[e].goldDrop?t:t.meet(ne.COIN)||ne.NONE}getNpcConstraint(s,e){let t=this.npcConstraints.get(e)||ne.NONE;return s===30&&e===96?t.meet(ne.STOM_FIGHT):s===160&&e===201?t.meet(ne.GUARDIAN_STATUE):t}shufflePalettes(s){let e=[...this.allSpritePalettes];for(let[t,i]of this.monsterConstraints)this.monsterConstraints.set(t,i.shufflePalette(s,e));for(let[t,i]of this.npcConstraints)this.npcConstraints.set(t,i.shufflePalette(s,e))}configure(s,e){if(!e.used)return;let t=this.rom.slots[e.id],i=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):e.isChest()?t<112?ne.TREASURE_CHEST:ne.MIMIC:void 0;if(!!i){if(i.shift===3||i.float.length>=2)throw new Error("don't know what to do with two floats");if(!i.float.length)e.patternBank=Number(i.shift===2);else if(i.float[0].has(s.spritePatterns[0]))e.patternBank=0;else if(i.float[0].has(s.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(s,e,t,i=0){let r=new Set,o=new Set;for(let f of s.map(d=>this.rom.metasprites[d])){for(let d of f.palettes())o.add(d);for(let d of f.patternBanks(i))r.add(d)}t=t&&r.size==1&&[...r][0]===2;let a=new Map;for(let[f,,d]of e)a.set(d.patternBank&&t?~f.id:f.id,d);let l;for(let[f,d]of a){let c=this.rom.locations[f<0?~f:f];for(let h of o)h>1&&this.allSpritePalettes.add(c.spritePalettes[h-2]);let u=ne.fromSpawn(o,r,c,d,t);l=l?l.join(u):u,!t&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}};function*Js(n,s){yield s;let e=s.spawnedReplacement();e&&(yield*Js(n,e));let t=s.spawnedChild();t&&(yield*Js(n,t)),s.id===80&&(yield n.objects.largeBlueSlime),s.id===83&&(yield n.objects.largeRedSlime)}function br(n,s,e){let t=new ms(n);s.shuffleSpritePalettes()&&t.shufflePalettes(e);let i=new ei(s,{});for(let r of n.locations)r.used&&i.populate(r);i.shuffle(e,t)}var ei=class{constructor(s,e){this.flags=s;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(s){let{maxFlyers:e=0,nonFlyers:t={},skip:i=!1,tower:r=!1,fixedSlots:o={},...a}=gr[s.id]||{};for(let u of Object.keys(a))throw new Error(`Unexpected property '${u}' in MONSTER_ADJUSTMENTS[${s.id}]`);let l=i===!0||!this.flags.shuffleTowerMonsters()&&r||!s.spritePatterns||!s.spritePalettes,f=[],d=[],c=12;for(let u of l?[]:s.spawns){if(++c,!u.used||!u.isMonster())continue;let h=u.monsterId;if(!ot.has(h)||ot.get(h).type!=="m")continue;let p=s.rom.objects[h];if(!(p instanceof He))continue;let m=u.patternBank,g=s.spritePatterns[m],C=p.palettes(!0),b=C.includes(2)?s.spritePalettes[0]:void 0,w=C.includes(3)?s.spritePalettes[1]:void 0;f.push({id:h,pat:g,pal2:b,pal3:w,patBank:m}),(this.report[`start-${h.toString(16)}`]=this.report[`start-${h.toString(16)}`]||[]).push("$"+s.id.toString(16)),d.push(c)}(!f.length||i)&&(d=[]),this.locations.push({location:s,slots:d}),this.monsters.push(...f)}shuffle(s,e){let t=e.rom;for(this.report["pre-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(i=>i.id),s.shuffle(this.locations),s.shuffle(this.monsters),this.report["post-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["post-shuffle monsters"]=this.monsters.map(i=>i.id);this.locations.length;){let{location:i,slots:r}=this.locations.pop(),o=this.report["$"+i.id.toString(16).padStart(2,"0")]=[],{maxFlyers:a=0,nonFlyers:l={},tower:f=!1}=gr[i.id]||{};if(f)continue;let d=a,c=ne.forLocation(i.id);i.bossId()!=null;for(let m of i.spawns)if(m.isChest()&&!m.isInvisible())t.slots[m.id]<112?c=c.meet(ne.TREASURE_CHEST,!0):c=c.meet(ne.MIMIC,!0);else if(m.isNpc()||m.isBoss()){let g=e.getNpcConstraint(i.id,m.id);c=c.meet(g,!0),m.isNpc()&&(m.id===107||m.id===104)&&(c=c.meet(ne.KENSU_CHEST,!0))}else if(m.isMonster()&&!(t.objects[m.monsterId]instanceof He)){let g=e.getMonsterConstraint(i.id,m.monsterId);c=c.meet(g,!0)}else m.isShootingWall(i)&&(c=c.meet(ne.SHOOTING_WALL,!0));o.push(`Initial pass: ${c.fixed.map(m=>m.size<1/0?"["+[...m].join(", ")+"]":"all")}`);let u=new Map,h=m=>{let g=t.objects[m.id];if(g.monsterClass){let I=u.get(g.monsterClass);if(I!=null&&I!==m.id)return!1}let C=Qs.has(m.id),b=uo.has(m.id);if(C){if(!d)return!1;--d}let w=e.getMonsterConstraint(i.id,m.id),x=c.tryMeet(w);if(!x&&c.pal2.size<1/0&&c.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(x=c.tryMeet(w,!0)),!x)return!1;let v;if(p){let I=t.objects[m.id];if(!(I instanceof He))throw new Error(`non-monster: ${I}`);if(v=p(I),v==null)return!1}o.push(`  Adding ${m.id.toString(16)}: ${x}`),c=x,g.monsterClass&&u.set(g.monsterClass,m.id);let E=0;if(C||b){for(let I=0;I<r.length;I++)if(r[I]in l){E=I;break}}else for(let I=0;I<r.length;I++)if(!(r[I]in l)){E=I;break}(this.report[`mon-${m.id.toString(16)}`]=this.report[`mon-${m.id.toString(16)}`]||[]).push("$"+i.id.toString(16));let M=r[E],y=i.spawns[M-13];return C?(y.data[0]=253,y.data[1]=255):p?(y.screen=v>>>8,y.tile=v&255):M in l&&(y.y+=l[M][0]*16,y.x+=l[M][1]*16),y.monsterId=m.id,o.push(`    slot ${M.toString(16)}: ${y}`),r.splice(E,1),!0},p=i.monstersMoved||r.length&&this.flags.randomizeMaps()?i.monsterPlacer(s):null;if(d&&r.length)for(let m=0;m<Math.min(40,this.monsters.length);m++)Qs.has(this.monsters[m].id)&&h(this.monsters[m])&&this.monsters.splice(m,1);for(let m=0;m<this.monsters.length&&r.length;m++)if(h(this.monsters[m])){let[g]=this.monsters.splice(m,1);Qs.has(g.id)||this.used.push(g),m--}for(let m=0;m<this.used.length&&r.length;m++)h(this.used[m])&&(this.used.push(...this.used.splice(m,1)),m--);if(c.fix(i,s),r.length){console.error(`Failed to fill location ${i.id.toString(16)} ${i.name}: ${r.length} remaining`);for(let m of r){let g=i.spawns[m-13];g.x=g.y=0,g.id=176,g.data[0]=254}}for(let m of i.spawns)e.configure(i,m)}}},Qs=new Set([89,92,110,111,129,138,163,196]),uo=new Set([85,93,124,188,193]),gr={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};function si(n,s,e){new ti(n,s,e).shuffle()}var ti=class{constructor(s,e,t){this.rom=s;this.flags=e;this.random=t}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let s=new D(()=>[]);for(let t of this.rom.locations)!t.tilePalettes.some(i=>i!==154)||s.get(t.colorGroup).push(t);let e=[new Map,new Map];for(let t of s.values())for(let i of t)for(let r=0;r<2;r++)for(let o=0;o<2;o++){let a=e[r].get(i.tilePatterns[o]);a||e[r].set(i.tilePatterns[o],a=new Set),a.add(i.tilePalettes[r])}for(let t of s.values()){let i=t[0],r=[new Set,new Set];for(let l=0;l<2;l++)r[l]=new Set([...e[l].get(i.tilePatterns[0]),...e[l].get(i.tilePatterns[1])]);let o=this.random.pick([...r[0]]),a=this.random.pick([...r[1]]);for(let l of t)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}};function mt(n,s){s.eastCave?mo(n,s.eastCave):s.classicLimeTreeToLeaf&&po(n),xo(n),go(n),yo(n),So(n),bo(n)}(s=>{function n(e,t){let i={};if(e.addEastCave()){i.eastCave={};let r=["cordel","lime","goa","desert"],o=t.nextInt(4);[i.eastCave.exit1]=r.splice(o,1),i.eastCave.exit2=t.pick(r)}else e.connectLimeTreeToLeaf()&&(i.classicLimeTreeToLeaf=!0);return i}s.generateOptions=n})(mt||(mt={}));function mo(n,s){let{locations:{EastCave1:e,EastCave2:t,EastCave3:i,SealedCave1:r,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:f,branchNWSE:d,branchNWS:c,branchWSE:u,caveEmpty:h,deadEndE:p,deadEndE_downStair:m,deadEndE_upStair:g,deadEndN_stairs:C,deadEndS:b,deadEndS_stairs:w,deadEndW:x,deadEndW_downStair:v,hallNE:E,hallNS:M,hallNW:y,hallSE:I,hallWS:G,hallWE:K,hallNS_entrance:Y,hallNS_ramp:J,hallNS_wall:oe}}=n;n.locations.allocate(e),n.locations.allocate(t),s.exit2&&n.locations.allocate(i);for(let U of[e,t,i])U.bgm=U.originalBgm=23,U.entrances=[],U.exits=[],U.pits=[],U.spawns=[],U.flags=[],U.width=U.height=1,U.screens=[[128]],U.tilePalettes=[26,27,5],U.originalTilePalettes=[26,27,5],U.tileset=136,U.tileEffects=181,U.tilePatterns=[20,2],U.spritePatterns=[...r.spritePatterns],U.spritePalettes=[...r.spritePalettes];e.meta=new xe(e.id,n.metatilesets.cave,5,5),e.meta.set2d(0,[[p,G,h,I,x],[h,M,I,y,h],[I,d,c,h,h],[M,J,E,K,G],[Y,E,x,g,y]]),t.meta=new xe(t.id,n.metatilesets.cave,5,5),t.meta.set2d(0,[[p,G,b,h,b],[h,M,M,h,M],[h,l,f,u,y],[h,J,h,E,G],[p,y,h,h,C]]),o.meta.set2d(51,[[a]]),n.tileEffects[0].effects[192]=0,e.meta.attach(67,t.meta,68),e.meta.attach(64,o.meta,51),s.exit1&&(e.meta.set2d(4,[[v]]),wr(e,4,s.exit1)),s.exit2&&(i.meta=new xe(i.id,n.metatilesets.cave,3,1),i.meta.set2d(0,[[w],[oe],[Y]]),i.spawns.push(H.from([24,7,35,0])),i.flags.push(yi.of({screen:16,flag:n.flags.alloc(512)})),t.meta.set2d(64,[[m]]),t.meta.attach(64,i.meta,0),wr(i,32,s.exit2)),e.spawns.push(H.of({screen:33,tile:135,timed:!0,id:2}),H.of({screen:18,tile:136,timed:!1,id:2}),H.of({screen:19,tile:137,timed:!0,id:2}),H.of({screen:50,tile:104,timed:!1,id:2}),H.of({screen:65,tile:136,timed:!0,id:2}),H.of({screen:51,tile:152,timed:!0,id:2}),H.of({screen:3,tile:136,timed:!0,id:2})),t.spawns.push(H.of({screen:1,tile:136,timed:!0,id:2}),H.of({screen:17,tile:72,timed:!1,id:2}),H.of({screen:18,tile:119,timed:!0,id:2}),H.of({screen:20,tile:40,timed:!1,id:2}),H.of({screen:35,tile:133,timed:!0,id:2}),H.of({screen:49,tile:136,timed:!0,id:2}),H.of({screen:51,tile:138,timed:!1,id:2}),H.of({screen:52,tile:152,timed:!0,id:2}),H.of({screen:65,tile:130,timed:!0,id:2}),H.of({y:272,x:1144,type:2,id:89}),H.of({y:112,x:264,type:2,id:124})),n.slots.swap(49,89)}function wr(n,s,e){let{locations:{CordelPlainEast:t,CordelPlainWest:i,Desert2:r,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:f,boundaryN_trees:d,boundaryW_cave:c,cornerNE:u,cornerNW:h,cornerSE:p,cornerSE_cave:m,cornerSW:g}}=n.rom,C,b;switch(e){case"lime":C=a,b=16,C.resizeScreens(0,1,0,0),C.meta.spliceColumns(0,1,2,[[h,d],[c,f],[g,p]]);break;case"cordel":let w=[[c,f],[g,p]];C=t,b=85,C.meta.set2d(85,w),i.meta.set2d(85,w);break;case"goa":C=o,b=17,C.meta.set2d(1,[[h,u],[c,l]]);break;case"desert":C=r,b=83,C.meta.set2d(83,[[m]]);break}n.meta.attach(s,C.meta,b)}function po(n){let{locations:{ValleyOfWind:s,LimeTreeValley:e},metascreens:{exitE:t,exitW_southwest:i,overworldEmpty_alt:r}}=n;s.meta.set2d(84,[[t]]),e.meta.set2d(16,[[i],[r]]),s.meta.attach(84,e.meta,16)}function xo(n){let{TowerEntrance:s,Crypt_Teleporter:e}=n.locations;e.meta.attach(0,s.meta,0,"teleporter","teleporter")}function go(n){let{flags:{OpenedSwanGate:s},locations:{SwanGate:e},npcs:{SoldierGuard:t}}=n;e.spawns.push(H.of({xt:10,yt:2,type:1,id:45}),H.of({xt:11,yt:2,type:1,id:45})),t.localDialogs.get(e.id)[0].flags.push(s.id)}function bo(n){wo(n.locations.SaberaPalace2_West,n.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function wo(n,s,...e){n.rom.locations.allocate(n,s),n.bgm=s.bgm,n.entrances=[],n.exits=[],n.pits=[],n.spawns=[],n.flags=[],n.width=n.height=1,n.screens=[[128]],n.tilePalettes=ct(s.tilePalettes),n.originalTilePalettes=ct(s.originalTilePalettes),n.tileset=s.tileset,n.tileEffects=s.tileEffects,n.tilePatterns=ct(s.tilePatterns),n.spritePatterns=ct(s.spritePatterns),n.spritePalettes=ct(s.spritePalettes);let i=0,r=0;for(let a of e)i=Math.max(i,(a>>>4)+1),r=Math.max(r,(a&15)+1);n.meta=new xe(n.id,s.meta.tileset,i,r);for(let a of e)n.meta.set(a,s.meta.get(a)),s.meta.set(a,s.meta.tileset.empty);let o=new Set(e);n.flags=s.flags.filter(a=>o.has(a.screen)),s.flags=s.flags.filter(a=>!o.has(a.screen)),n.spawns=s.spawns.filter(a=>o.has(a.screen)),s.spawns=s.spawns.filter(a=>!o.has(a.screen)),s.meta.moveExitsAndPitsTo(n.meta)}function yo(n){let s=n.locations.GoaFortress_Kensu.meta;for(let[e,t]of s.exits())e<16||t.startsWith("seamless")||s.deleteExit(e,t)}function So(n){n.locations.ZebuCave.spawns.find(s=>s.isTrigger()).yt+=3}var Co=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Piano Key","Encryption Key","Private Key","Public Key","Key Card","Any Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Major Key","Minor Key","Cookie","Turkey","Monkey","Ctrl Key","Escape Key","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key"],ko=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power"],vo=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Flashlight","Search Light","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Tanning Bed","CRT"],Eo=["!Random Statue","!Rusty Statue","!Forbidden Statue","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","CodeGorilla Trophy"],Io=["!Random Bow","Crossbow","Autocrossbow","Long Bow","Compound Bow","Silver Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Derek","Bo Diddley","Bo Dallas","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn"];function yr(n,s,e){if(!s.unidentifiedItems())return;let t=(...f)=>f.map(d=>n.items[d]),i=t(50,51,52),r=t(39,40,49,54),o=t(53,57),a=t(37,56,58,61),l=t(62,63,64);for(let[f,[...d]]of[[i,Co],[r,ko],[o,vo],[a,Eo],[l,Io]]){let c=(s.communityJokes()?d:d.filter(h=>h.startsWith("!"))).map(h=>h.replace(/^!/,""));e.shuffle(c);let u=e.shuffle([0,1,2,3]);for(let h of f){let p=c.pop();n.spoiler&&n.spoiler.addUnidentifiedItem(h.id,h.messageName,p),h.menuName=h.messageName=p,h.palette=u.pop()}}}var Ro=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),To=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),Mo=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac"]]]);function Sr(n,s,e){!s.communityJokes()||(Fo(n,s,e),Ao(n,e),Po(n,e))}function Fo(n,s,e){if(s.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let t=e.next()<.05?n.items:[n.items[e.nextInt(72)]];for(let i of t){if(!i)continue;let r=Ro.get(i.messageName)||[],o=Math.floor(e.nextInt(3*r.length+1)/3);o<r.length?i.messageName=i.menuName=r[o]:i.messageName===i.menuName&&(i.messageName=i.menuName=ii(i.messageName,e))}}function ii(n,s){let e=n.split(""),t=s.nextInt(e.length-1);return e[t]===" "||e[t+1]===" "?n:(e[t].toUpperCase()===e[t]?e.splice(t+1,1):[e[t],e[t+1]]=[e[t+1],e[t]],e.join(""))}function Cr(n,s){for(let e of n.messages.parts)for(let t of e)t.text=s(t.text);n.messages.personNames=n.messages.personNames.map(s),Go(n,s)}function kr(n,s){return e=>e.includes(n)?e.split(n).join(s):e}function Go(n,s){for(let e of n.objects)e.displayName&&(e.displayName=s(e.displayName))}function Ao(n,s){let e=n.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let t=[...To].flatMap(([a,l])=>["",...l,...l].map(f=>[a,f])),[i,r]=s.pick(t),o=r||ii(i,s);o!==i&&Cr(n,kr(i,o))}function Po(n,s){for(let e=0;e<10;e++){let[t,i]=s.pick([...Mo]),o=s.pick(["",...i,...i,...i])||ii(t,s);o!==t&&Cr(n,kr(t,o))}}function vr(n){let{locations:s}=n,{CordelPlainEast:e,CordelPlainWest:t,WaterfallValleyNorth:i,WaterfallValleySouth:r,MezameShrine:o,MtSabreWest_Cave1:a}=s;e.meta.reconcileExits(t.meta);for(let l of i.meta.allPos()){let f=i.meta.get(l),d=r.meta.get(l);f.isEmpty()&&!d.isEmpty()?i.meta.set(l,d):d.isEmpty()&&!f.isEmpty()&&r.meta.set(l,f)}for(let l of s)!l.used||(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of s)!l.used||l!==a&&(l.meta.write(),l===t&&a.used&&a.meta.write())}var ps=class{constructor(s){this.rom=s;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(s,e){this.route.push(new ri(this,s,e))}addSlot(s,e,t){this.slots[s&255]=new ni(this.rom,s&255,e,t&255)}addMaze(s,e,t){this.mazes.push({id:s,name:e,maze:t})}addTrade(s,e,t){this.trades.push({itemId:s,item:e,npc:t})}addUnidentifiedItem(s,e,t){this.unidentifiedItems.push({itemId:s,oldName:e,newName:t})}addWall(s,e,t){this.walls.push({location:s,oldElement:e,newElement:t})}addWildWarp(s,e){this.wildWarps.push({id:s,name:e})}addHouse(s,e){this.houses.push({houseId:s,townId:e,house:this.rom.locations[s].name,town:this.rom.locations[e].name})}formatCondition(s){return this.rom.flags[s]?.name}formatConditionList(s){let e=[];for(let t of s){let i=this.rom.flags[t];i?.logic.track&&e.push(i.name)}return e.join(", ")}},ri=class{constructor(s,e,t){this.spoiler=s;this.condition=e;this.deps=t}toString(){let s=0;return(this.condition&-128)===256&&(s=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${s?` (${this.spoiler.formatCondition(s)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},ni=class{constructor(s,e,t,i){this.slot=e;this.slotName=t;this.item=i;this.itemName=Er(s,i),this.originalItem=Er(s,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};function Er(n,s){return s>=112?"Mimic":n.items[n.itemGets[s].itemId].messageName}var Ir=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),oi=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);function Bo(n,[s,e,[t,i]]){let r=Ir.get(e)||oi.get(Ir.get(i)),o=!1,a=n.id.toString(16),l=(n.id<<8|s).toString(16)+" "+e,f=n.rom.locations[t>>>8],d=t&255,c=t.toString(16)+" "+i,u=f.id.toString(16),h={loc:f,pos:d,type:i,area:u,key:c,reverse:null,origRev:null,get conn(){return oi.get(r)},set conn(m){r=oi.get(m)},get shuffle(){return o},set shuffle(m){if(m&&!r)throw new Error("shuffle without conn");o=m}},p={loc:n,pos:s,type:e,key:l,reverse:h,area:a,origRev:h,get conn(){return r},set conn(m){r=m},get shuffle(){return o},set shuffle(m){if(m&&!r)throw new Error("shuffle without conn");o=m}};return h.reverse=h.origRev=p,p}function Rr(n,s){return typeof s=="string"?n.type===s:typeof s=="number"?n.pos===s:s instanceof Nt?n.reverse.loc===s:s.every(e=>Rr(n,e))}function Tr(n,s,e){if(!s.shuffleAreas())return;let{locations:t}=n,i=new Map,r=new D(()=>[]);for(let b of n.locations)for(let w of b.meta.exits()){if(b===t.CordelPlainEast&&(w[0]&15)<5||b===t.CordelPlainWest&&(w[0]&15)>4||b.isTower())continue;let x=Bo(b,w);if(x.loc!==t.Portoa_FortuneTeller&&x.reverse.loc!==t.Portoa_FortuneTeller&&!i.has(x.key)){if(i.has(x.reverse.key))throw new Error(`Inconsistent exits: ${x.key} | ${x.reverse.key}`);i.set(x.key,x),i.set(x.reverse.key,x.reverse),r.get(x.loc).push(x),r.get(x.reverse.loc).push(x.reverse)}}function o(b,...w){let x=[];for(let v of r.get(b))for(let E of w)if(Rr(v,E)){x.push(v);break}return x}for(let b of o(t.ValleyOfWind,"door","windmill"))b.area="windmill";for(let b of o(t.AngrySea,100))b.area="lighthouse";o(t.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(b,...w){for(let x of o(b,...w))x.shuffle=!0}function l(...b){let w=new Set(b);for(let x of b)for(let v of r.get(x))w.has(v.reverse.loc)||(v.shuffle=!0)}if(l(t.Leaf_OutsideStart),a(t.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(t.WindmillCave),l(t.EastCave1,t.EastCave2,t.EastCave3),l(t.ZebuCave,t.MtSabreWest_Cave1),l(t.CordelPlainWest,t.CordelPlainEast),l(t.WaterfallValleyNorth,t.WaterfallValleySouth),l(t.KirisaMeadow),l(t.LimeTreeLake),a(t.Portoa_FishermanIsland,"edge:right"),a(t.PortoaPalace_ThroneRoom,"door"),a(t.Joel,"edge:bottom"),l(t.JoelSecretPassage),a(t.EvilSpiritIsland1,"stair:up"),a(t.ZombieTown,"cave"),a(t.AngrySea,"edge:top"),l(t.SwanGate),a(t.GoaValley,"edge:left"),l(t.Desert1),l(t.GoaFortressBasement),l(t.DesertCave1),l(t.SaharaOutsideCave),l(t.DesertCave2),a(t.Desert2,"stair:down"),!s.shuffleHouses()){let b=[[t.ZombieTown,"fortress"],[t.MtHydra,"gate"],[t.Desert2,"fortress"],[t.Goa,"edge:top"],[t.Portoa,"fortress"],[t.Shyron,"fortress"],[t.GoaValley,"fortress"],[t.OasisCave_Entrance,"stair:up"],[t.MtHydra_OutsideShyron,"gate"],[t.Crypt_Entrance,"crypt"]];for(let[w,x]of b){let[v]=o(w,x);v.conn="F",v.shuffle=!0}}{let[b]=o(t.Oak,"edge:bottom");b.conn="X",b.shuffle=!0}let f=new pe;for(let b of i.values())b.shuffle||f.union([b.area,b.reverse.area]);let d=new D(()=>[]);for(let b of i.values())!b.shuffle||d.get(b.area=f.find(b.area)).push(b);let c=r.get(t.MezameShrine)[0].area;function u(){let b=new Set,w=new Map,x=[];for(let E of[c,...d.keys()]){if(b.has(E))continue;let M=new Set([E]),y=[];for(let I of M){b.add(I);for(let G of d.get(I))w.set(G,x.length),y.push(G),!(G.oneWay||b.has(G.reverse.area))&&M.add(G.reverse.area)}x.push(y)}let v=0;for(let E=1;E<x.length;E++)x[E].length<x[v].length&&(v=E);return[x.length,w,x[v]]}let h=new D(()=>[]);for(let b of i.values())!b.shuffle||!b.conn||h.get(b.conn).push(b);for(let b of"NWCF"){let w=h.get(b),x=e.shuffle([...w]).map(v=>v.reverse);for(let v=0;v<x.length;v++){let E=w[v],M=x[v];[E.reverse,M.reverse]=[M,E]}}let p=0,[m,g,C]=u();for(;p-- >0||m>1;){let b=e.pick(C),w=h.get(b.conn);if(m>1){let M=g.get(b);w=w.filter(y=>g.get(y)!==M)}let x=e.pick(w),v=b.reverse,E=x.reverse;if(b.reverse=E,E.reverse=b,x.reverse=v,v.reverse=x,[m,g,C]=u(),p<-10)debugger}for(let b of i.values()){if(b.reverse!==b.origRev){let w=function(x){return`${x.loc.name} ${x.type}(${x.pos.toString(16)})`};console.log(`${w(b)}  =>  ${w(b.reverse)}  (was ${w(b.origRev)})`)}b.loc.meta.attach(b.pos,b.reverse.loc.meta,b.reverse.pos,b.type,b.reverse.type)}}function Mr(n){for(let s of n.locations){let e=new Set;for(let t of s.spawns)if(!!t.isTrigger()&&e.has(t.coord))throw new Error(`Overlapping triggers on ${s} at ${t.coord.toString(16)}`)}}var ai=!0,Fr=vi("asm");function Df(n){return n?/^[0-9a-f]{1,8}$/i.test(n)?Number.parseInt(n,16):Ot(n):Qe.newSeed()}var{}={watchArray:bi};function Lo(n,s){let e={_ALLOW_TELEPORT_OUT_OF_BOSS:n.hardcoreMode()&&n.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:n.audibleWallCues(s),_AUTO_EQUIP_BRACELET:n.autoEquipBracelet(s),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:n.buffDeosPendant(),_BUFF_DYNA:n.buffDyna(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:n.controllerShortcuts(s),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:n.disableShopGlitch(),_DISABLE_STATUE_GLITCH:n.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:n.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:n.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:n.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:ai,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:n.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:n.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:n.maxScalingInTower(),_MONEY_AT_START:n.shuffleHouses()||n.shuffleAreas(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:n.neverDie(),_NORMALIZE_SHOP_PRICES:n.shuffleShops(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:n.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_REQUIRE_HEALED_DOLPHIN_TO_RIDE:n.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:n.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:n.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:n.teleportOnThunderSword(),_TINK_MODE:!n.guaranteeMatchingSword(),_TRAINER:n.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:n.unidentifiedItems(),_ENEMY_HP:n.shouldUpdateHud(),_UPDATE_HUD:n.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:n.zebuStudentGivesItem()};return Object.keys(e).filter(t=>e[t]).map(t=>`.define ${t} ${e[t]}
`).join("")}function _o(n,s){for(let e of s)Ue.applyPatch(e,n,ai)}async function Nf(n,s,e,t,i,r,o){let a=16+(n[6]&4?512:0)+(n[4]<<14)+(n[5]<<13);if(n.length>a&&(n=n.slice(0,a)),ai&&n.length<524288){if(n.length<524288){let p=new Uint8Array(n.length+262144);p.subarray(0,262160).set(n.subarray(0,262160)),p.subarray(524304).set(n.subarray(262160)),p[4]<<=1,n=p}let h=n.subarray(16);h.subarray(507904,524288).set(h.subarray(245760,262144))}let l=n.slice(16);if(Ji(n.subarray(16)),typeof s!="number")throw new Error("Bad seed");let f=Ot(s.toString(16).padStart(8,"0")+String(e.filterOptional()))>>>0,d=new Qe(f),c=i||[],u=[];for(let h=0;h<5;h++)try{return await Do(n,e,s,d,t,r,o,c,l)}catch(p){u.push(p),console.error(`Attempt ${h+1} failed: ${p.stack}`)}throw new Error(`Shuffle failed: ${u.map(h=>h.stack).join(`

`)}`)}async function Do(n,s,e,t,i,r,o,a,l){let f=String(s),d=s.filterRandom(t),c=new Ei(n),u=String(d);c.flags.defrag(),Xi(c),Yi(c),typeof window=="object"&&(window.rom=c),c.spoiler=new ps(c),r&&(r.spoiler=c.spoiler),u!==f&&(c.spoiler.flags=u),Qi(c,d),Ci(c),mt(c,mt.generateOptions(d,t)),c.scalingLevels=48,d.shuffleShops()&&Wo(c,d,t),d.shuffleGoaFloors()&&hr(c,t),Oo(c),zo(c,d,t),Zi(c,t),d.nerfWildWarp()&&c.wildWarp.locations.fill(0),d.randomizeWildWarp()&&Ho(c,d,t),d.randomizeThunderTeleport()&&cr(c,t),fr(c,d,t),yr(c,d,t),Sr(c,d,t),tr(c,d,t),d.shuffleHouses()&&mr(c,d,t),d.shuffleAreas()&&Tr(c,d,t),or(c),d.randomizeMaps()&&Bi(c,d,t),vr(c),xr(c,t),d.shuffleMimics()&&pr(c,d,t),d.shuffleMonsters()&&br(c,d,t);let h=new fs(c,d),p=new ns([h.getLocationList()]);if(!d.noShuffle()){let w=await p.shuffle(d,t,void 0,o,c.spoiler);if(w){for(let[x,v]of w)c.slots[x&255]=v&255;c.slots.setCheckCount(w.size)}else return[n,-1]}d.shuffleShops()&&Xo(c,d.bargainHunting()?t:void 0),d.buffMedicalHerb()&&(c.items.MedicalHerb.value=80,c.items.FruitOfPower.value=56),d.storyMode()&&jo(c),d.blackoutMode()&&Uo(c),No(c,d,t),rr(c),ar(c),Mr(c),d.buffDyna()&&qo(c,d),d.trainer()&&(c.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),d.randomizeMusic("early")&&Gr(c,d,t),d.shuffleTilePalettes("early")&&si(c,d,t),Vo(c,d),t.shuffle(c.randomNumbers.values);async function m(w){async function x(I){let G=zi(await i.read(I),Cs.P02,l);return new Rs(G,I,{lineContinuations:!0})}let v=Lo(d,w),E=new pi(Cs.P02),M=new gi;M.enter(mi.concat(new Rs(v,"flags.s"),await x("init.s"),await x("alloc.s"),await x("stattracker.s"),await x("preshuffle.s"),await x("postparse.s"),await x("postshuffle.s")));let y=new xi(M,E);return E.tokens(y),E.module()}c.messages.compress();let g=n.slice(16);c.modules.set(Fr,await m("early")),c.writeData(g),c.modules.set(Fr,await m("late"));let C=a?.some(w=>Ue.isCustom(w))||!1,b=Ko(n,e,f,g,C);return d.randomizeMusic("late")&&Gr(c,d,t),d.noMusic("late")&&$o(c),d.shuffleTilePalettes("late")&&si(c,d,t),dr(c),c.writeData(),_o(n,a),[n,b]}function No(n,s,e){let{}={rom:n,flags:s,random:e};n.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,n.messages.parts[0][14].text="It's dangerous to go alone! Take this.",n.messages.parts[0][14].fixText()}function Wo(n,s,e){let t={[0]:{contents:[],shops:[]},[1]:{contents:[],shops:[]}};for(let i of n.shops){if(!i.used||i.location===255)continue;let r=t[i.type];r&&(r.contents.push(...i.contents.filter(o=>o!==255)),r.shops.push(i),i.contents=[])}for(let i of Object.values(t)){let r=null,o=[...i.contents];for(e.shuffle(o);o.length;){(!r||!r.length)&&(r&&o.shift(),r=[...i.shops,...i.shops,...i.shops,...i.shops],e.shuffle(r));let a=o[0],l=r[0];l.contents.length<4&&!l.contents.includes(a)&&(l.contents.push(a),o.shift()),r.shift()}}for(let i of Object.values(t))for(let r of i.shops){for(;r.contents.length<4;)r.contents.push(255);r.contents.sort((o,a)=>o-a)}}function Oo(n){for(let s of n.locations)if(!!s.used){for(let e of s.spawns)if(e.isWall()){let t=e.id&15;e.id=t|t<<4;let i=e.isShootingWall(s);e.data[2]=i?51:35}}}function zo(n,s,e){if(!s.randomizeWalls())return;let t=[[5,56],[17],[106],[20]];function i(o){return o.data[2]&32?o.id>>>4&3:o.id&3}let r=new D(()=>[]);for(let o of n.locations)r.get(o.data.area).push(o);for(let o of r.values()){let a=e.nextInt(4),l=e.pick(t[a]),f=!1;for(let d of o)for(let c of d.spawns)if(c.isWall()){let u=i(c);if(u===2)continue;if(u===3){let h=e.nextInt(4);n.spoiler&&n.spoiler.addWall(d.name,u,h),c.data[2]|=32,c.id=48|h}else!f&&n.spoiler&&(n.spoiler.addWall(d.name,u,a),f=!0),c.data[2]|=32,c.id=u<<4|a,d.tilePalettes[2]=l}}}function $o(n){for(let s of[...n.locations,...n.bosses.musics])s.bgm=0}function Gr(n,s,e){let t=new D(()=>[]),i=new Set;for(let a of n.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;i.add(a.bgm),t.get(l).push(a)}for(let a of n.bosses.musics)t.set(a,[a]),i.add(a.bgm);let r=[...i],o=new Set;for(let a of t.values()){let l=e.pick(r);for(let f of a)f.bgm=l,o.add(f)}}function Ho(n,s,e){let t=[];for(let i of n.locations)i&&i.used&&i.id&&!i.isShop()&&(i.id&248)!==88&&i!==n.locations.Crypt_Draygon2&&i!==n.locations.Crypt_Teleporter&&i!==n.locations.MesiaShrine&&i!==n.locations.LimeTreeLake&&t.push(i);e.shuffle(t),n.wildWarp.locations=[];for(let i of[...t.slice(0,15).sort((r,o)=>r.id-o.id)])n.wildWarp.locations.push(i.id),n.spoiler&&n.spoiler.addWildWarp(i.id,i.name);n.wildWarp.locations.push(0)}function qo(n,s){n.objects[184].collisionPlane=1,n.objects[184].immobile=!0,n.objects[185].collisionPlane=1,n.objects[185].immobile=!0,n.objects[51].collisionPlane=2,n.adHocSpawns[40].slotRangeLower=28,n.adHocSpawns[41].slotRangeUpper=28,n.adHocSpawns[42].slotRangeUpper=28}function Uo(n){let s=new Set([n.metatilesets.cave.tilesetId,n.metatilesets.fortress.tilesetId,n.metatilesets.iceCave.tilesetId,n.metatilesets.labyrinth.tilesetId,n.metatilesets.pyramid.tilesetId]);for(let e of n.locations)s.has(e.tileset)&&e.tilePalettes.fill(154)}var jo=n=>{let s=[n.flags.Kelbesque1.id,n.flags.Sabera1.id,n.flags.Mado1.id,n.flags.Kelbesque2.id,n.flags.Sabera2.id,n.flags.Mado2.id,n.flags.Karmine.id,n.flags.Draygon1.id,n.flags.SwordOfWind.id,n.flags.SwordOfFire.id,n.flags.SwordOfWater.id,n.flags.SwordOfThunder.id];n.npcs[203].spawnConditions.get(166).push(...s)};function Ko(n,s,e,t,i){let r=Ot(t),o=r.toString(16).padStart(8,"0").toUpperCase(),a=Ns==="unstable"?_i.substring(0,7).padStart(7,"0").toUpperCase()+"     ":Li.substring(0,12).padEnd(12," "),l=s.toString(16).padStart(8,"0").toUpperCase(),f=(u,...h)=>{u+=16;for(let p of h)if(typeof p=="string")for(let m of p)n[u++]=m.charCodeAt(0);else if(typeof p=="number")n[u++]=p;else throw new Error(`Bad value: ${p}`)},d=(u,h)=>{let p=[];for(let m=0;m<u.length||m<h.length;m++)p.push(u[m]||" "),p.push(h[m]||" ");return p.join("")};f(161743,d("  VERSION     SEED      ",`  ${a}${l}`));let c;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");c=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),f(161791,d(e.substring(0,23),e.substring(23))),c&&f(161839,d(c.substring(0,23),c.substring(23))),i&&f(161923,126),f(161925,d(o.substring(0,4),o.substring(4))),f(153366,"RANDOMIZER"),Ns==="unstable"&&f(153404,"BETA"),r}function Vo(n,s){s.decreaseEnemyDamage()&&n.scaling.setPhpFormula(e=>16+6*e),n.scaling.setExpScalingFactor(s.expScalingFactor()),s.disableShopGlitch()?n.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:n.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],n.items.CarapaceShield.defense=n.items.TannedHide.defense=3,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=9,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=13,n.items.PsychoArmor.defense=n.items.PsychoShield.defense=20,n.items.CeramicSuit.defense=n.items.BattleShield.defense=32,n.items.CarapaceShield.defense=n.items.TannedHide.defense=2,n.items.PlatinumShield.defense=n.items.BronzeArmor.defense=10,n.items.MirroredShield.defense=n.items.PlatinumArmor.defense=14,n.items.BattleArmor.defense=24}var Xo=(n,s)=>{for(let t of n.shops)if(t.type!==3)for(let i=0,r=t.prices.length;i<r;i++)t.contents[i]<128?t.prices[i]=s?s.nextNormal(1,.3,.5,1.5):1:t.type!==2?t.prices[i]=0:t.prices[i]=s?s.nextNormal(1,.5,.375,1.625):1;let e=te(48,t=>t);n.shops.rescale=!0,n.shops.toolShopScaling=e.map(t=>Math.round(8*2**(t/10))),n.shops.armorShopScaling=e.map(t=>Math.round(8*2**((47-t)/12)));for(let t=13;t<39;t++)n.items[t].basePrice=Yo[t]},Yo={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300},[]=[V];var xs=n=>"",li=n=>n===!0?!1:n,di=class{constructor(s,e){this.flag=s;this.opts=e;di.flags.set(s,this)}static all(){return[...this.flags.values()]}},we=di;we.flags=new Map;var he=class{constructor(s,e,t,i){this.name=e;this.description=t;this.flags=i.map(r=>r instanceof we?[r,!0]:r),s.presets.set(Ar(e),this)}static all(){return Oe.instance||(Oe.instance=new Oe),[...Oe.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new gt(`@${this.name}`))),this._flagString}};function Ar(n){return n.toLowerCase().replace(/[^a-z]/g,"")}var Oe=class{constructor(){this.presets=new Map;this.Casual=new he(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[q.PreserveUniqueChecks,q.NoShuffleMimics,q.DecreaseEnemyDamage,q.GuaranteeRefresh,q.GuaranteeStartingSword,q.ExperienceScalesFaster,q.NoCommunityJokes,_.NoThunderSwordWarp,j.Shops,j.Dyna,[j.Maps,"!"],[j.WildWarp,"!"],ae.SpoilerLog]);this.Classic=new he(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[q.GuaranteeStartingSword,q.NoCommunityJokes,L.StatueGlitch,[_.NoThunderSwordWarp,"!"],[j.Maps,"!"],ae.SpoilerLog]);this.Standard=new he(this,"Standard",`
      Well-balanced, standard race flags.`,[ee.RandomizeWeaknesses,_.StoryMode,ae.SpoilerLog]);this.NoBowMode=new he(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[ee.RandomizeWeaknesses,ee.TowerRobots,X.MaxScalingInTower,_.NoBowMode,ae.SpoilerLog]);this.Advanced=new he(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[L.GhettoFlight,L.MtSabreRequirementSkip,L.StatueGlitch,[L.SwordChargeGlitch,"!"],Z.Barrier,Z.BattleMagic,Z.GasMask,X.MaxScalingInTower,ee.RandomizeWeaknesses,ee.TowerRobots,_.OrbsNotRequired,_.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.UnidentifiedKeyItems,ae.SpoilerLog]);this.WildWarp=new he(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[q.GuaranteeRefresh,R.RandomizeWildWarp,ee.RandomizeWeaknesses,ee.TowerRobots,_.OrbsNotRequired,_.StoryMode,ae.SpoilerLog]);this.Mystery=new he(this,"Mystery",`
      Even the options are random.`,[[R.ShuffleAreas,"?"],[R.ShuffleHouses,"?"],[R.RandomizeMaps,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeWildWarp,"?"],[_.OrbsNotRequired,"?"],[_.NoBowMode,"?"],[_.StoryMode,"?"],[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[L.RageSkip,"?"],[L.TriggerSkip,"?"],[L.StatueGlitch,"?"],[L.GhettoFlight,"?"],[L.SwordChargeGlitch,"?"],[L.MtSabreRequirementSkip,"?"],[Fe.RandomizeMusic,"?"],[Fe.RandomizeMapColors,"?"],[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],[q.NoShuffleMimics,"?"],[q.PreserveUniqueChecks,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],[Z.GasMask,"?"],[j.Dyna,"?"],[j.BonusItems,"?"],[j.Maps,"?"],ae.SpoilerLog]);this.Hardcore=new he(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[Z.Barrier,Z.BattleMagic,X.ExperienceScalesSlower,X.MaxScalingInTower,X.Permadeath,_.OrbsNotRequired,_.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.UnidentifiedKeyItems]);this.FullStupid=new he(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[Z.Barrier,Z.BattleMagic,X.Blackout,X.ExperienceScalesSlower,X.MaxScalingInTower,X.Permadeath,ee.RandomizeWeaknesses,ee.TowerRobots,_.OrbsNotRequired,_.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.ShuffleGoaFloors,R.UnidentifiedKeyItems]);this.Tournament2022Early=new he(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[q.GuaranteeStartingSword,L.StatueGlitch,L.StatueGauntletSkip,[ee.RandomizeWeaknesses,"?"],_.OrbsNotRequired,_.StoryMode,[_.VanillaDolphin,"?"],[_.NoThunderSwordWarp,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new he(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[q.GuaranteeStartingSword,"?"],[L.GhettoFlight,"?"],[L.StatueGlitch,"?"],[L.MtSabreRequirementSkip,"?"],[L.StatueGauntletSkip,"?"],X.MaxScalingInTower,[X.NoBuffMedicalHerb,"?"],[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new he(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[q.GuaranteeStartingSword,"?"],L.GhettoFlight,L.StatueGlitch,L.MtSabreRequirementSkip,L.StatueGauntletSkip,X.NoBuffMedicalHerb,X.MaxScalingInTower,[ee.RandomizeWeaknesses,"?"],[ee.TowerRobots,"?"],Z.Barrier,Z.BattleMagic,_.StoryMode,[_.VanillaDolphin,"?"],[_.OrbsNotRequired,"?"],[_.NoThunderSwordWarp,"?"],R.ShuffleHouses,[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]])}static get(s){return this.instance||(this.instance=new Oe),this.instance.presets.get(Ar(s))}},ci=class{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(s,e){ci.sections.add(this.instance||(this.instance=new this));let t=new we(s,e);if(!s.startsWith(this.instance.prefix))throw new Error(`bad flag ${s} ${e}`);return this.instance.flags.set(s,t),t}},ue=ci;ue.sections=new Set;var Ee=class extends ue{constructor(){super(...arguments);this.prefix="W";this.name="World"}},R=Ee;R.RandomizeMaps=Ee.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0}),R.ShuffleAreas=Ee.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0}),R.ShuffleHouses=Ee.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0}),R.RandomizeTrades=Ee.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog
           Lamp, and Flute of Lime (for Akahana).  Rage will expect a
           random sword, and Tornel will expect a random bracelet.`,hard:!0}),R.UnidentifiedKeyItems=Ee.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0}),R.RandomizeWallElements=Ee.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`}),R.ShuffleGoaFloors=Ee.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."}),R.RandomizeSpriteColors=Ee.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`}),R.RandomizeWildWarp=Ee.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]});var at=class extends ue{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}},_=at;_.StoryMode=at.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`}),_.NoBowMode=at.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`}),_.OrbsNotRequired=at.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."}),_.NoThunderSwordWarp=at.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"}),_.VanillaDolphin=at.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`});var Ne=class extends ue{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}},L=Ne;L.GhettoFlight=Ne.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`}),L.StatueGlitch=Ne.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"}),L.MtSabreRequirementSkip=Ne.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"}),L.StatueGauntletSkip=Ne.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"}),L.SwordChargeGlitch=Ne.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"}),L.TriggerSkip=Ne.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"}),L.RageSkip=Ne.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"});var Gt=class extends ue{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}},Fe=Gt;Fe.RandomizeMusic=Gt.flag("Am",{name:"Randomize background music",modes:"!",optional:li}),Fe.NoMusic=Gt.flag("As",{name:"No background music",optional:xs}),Fe.RandomizeMapColors=Gt.flag("Ac",{name:"Randomize map colors",modes:"!",optional:li});var gs=class extends ue{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}},ee=gs;ee.RandomizeWeaknesses=gs.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."}),ee.TowerRobots=gs.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0});var We=class extends ue{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}},q=We;q.NoShuffleMimics=We.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."}),q.PreserveUniqueChecks=We.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`}),q.DecreaseEnemyDamage=We.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`}),q.GuaranteeStartingSword=We.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`}),q.GuaranteeRefresh=We.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`}),q.ExperienceScalesFaster=We.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]}),q.NoCommunityJokes=We.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`});var pt=class extends ue{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}},Z=pt;Z.BattleMagic=pt.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0}),Z.MatchingSword=pt.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0}),Z.Barrier=pt.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0}),Z.GasMask=pt.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0});var Ve=class extends ue{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}},X=Ve;X.NoBuffMedicalHerb=Ve.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0}),X.MaxScalingInTower=Ve.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0}),X.ExperienceScalesSlower=Ve.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0}),X.ChargeShotsOnly=Ve.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0}),X.Blackout=Ve.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0}),X.Permadeath=Ve.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});var Xe=class extends ue{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}},j=Xe;j.Dyna=Xe.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`}),j.BonusItems=Xe.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`}),j.Maps=Xe.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"}),j.Shops=Xe.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`}),j.WildWarp=Xe.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"}),j.Hud=Xe.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:li});var At=class extends ue{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}},Ye=At;Ye.NoAutoEquip=At.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:xs}),Ye.NoControllerShortcuts=At.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:xs}),Ye.AudibleWallCues=At.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:xs});var xt=class extends ue{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}},ae=xt;ae.SpoilerLog=xt.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`}),ae.TrainerMode=xt.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`}),ae.NeverDie=xt.flag("Di",{name:"Player never dies"}),ae.NoShuffle=xt.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`});var gt=class{constructor(s="@Casual"){if(typeof s!="string"){this.flags=new Map;for(let[i,r]of s)this.set(i.flag,r);return}if(s.startsWith("@")){let i=Oe.get(s.substring(1));if(!i)throw new hi(`Unknown preset: ${s}`);this.flags=new Map(i.flags);return}this.flags=new Map,s=s.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,t;for(;t=e.exec(s);){let[,i,r]=t,o=/([!?]|^)([a-z0-9]+)/g;for(;t=o.exec(r);){let[,a,l]=t;for(let f of l)this.set(i+f,a||!0)}}}filterOptional(){return new gt(new Map([...this.flags].map(([s,e])=>[s,s.opts.optional?s.opts.optional(e):e])))}filterRandom(s){function e(t,i){return i!=="?"?i:s.pick([!0,!1,...t.opts.modes||""])}return new gt(new Map([...this.flags].map(([t,i])=>[t,e(t,i)])))}toString(){let s=new D(()=>new D(()=>[]));for(let[t,i]of this.flags){if(t.flag.length!==2)throw new Error(`Bad flag ${t.flag}`);if(!i)continue;let r=s.get(t.flag[0]),o=i===!0?"":i;r.get(o).push(t.flag[1])}let e=[];for(let[t,i]of s.sortedEntries()){let r=t;for(let[o,a]of i.sortedEntries())r+=o+a.sort().join("");e.push(r)}return e.join(" ")}toggle(s){let e=we.flags.get(s);if(!e)return console.error(`Bad flag: ${s}`),!1;let t=this.flags.get(e)||!1,i=[!1,!0,...e.opts.modes||"","?",!1],r=i.indexOf(t);if(r<0)throw new Error(`Bad current mode ${t}`);let o=i[r+1];return this.flags.set(e,o),o}set(s,e){let t=we.flags.get(s);if(!t){console.error(`Bad flag: ${s}`);return}if(!e)this.flags.delete(t);else if(e===!0||e==="?"||t.opts.modes?.includes(e))this.flags.set(t,e);else{console.error(`Bad flag mode: ${s[0]}${e}${s.substring(1)}`);return}for(let i of t.opts.excludes||[])this.flags.delete(we.flags.get(i))}check(s,...e){let t=s instanceof we?s:we.flags.get(s);return e.length||e.push(!0),e.includes(t&&this.flags.get(t)||!1)}get(s){let e=s instanceof we?s:we.flags.get(s);return e&&this.flags.get(e)||!1}preserveUniqueChecks(){return this.check(q.PreserveUniqueChecks)}shuffleMimics(){return this.check(q.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(j.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(j.BonusItems,!1)}slowDownTornado(){return this.check(j.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(j.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(j.BonusItems,!1)}shuffleSpritePalettes(){return this.check(R.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(j.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(ee.TowerRobots)}shuffleMonsterElements(){return this.check(ee.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(X.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check(q.DecreaseEnemyDamage)}trainer(){return this.check(ae.TrainerMode)}neverDie(){return this.check(ae.NeverDie)}noShuffle(){return this.check(ae.NoShuffle)}chargeShotsOnly(){return this.check(X.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(j.Maps,"!")}addEastCave(){return this.check(j.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(_.VanillaDolphin,!1)}storyMode(){return this.check(_.StoryMode)}noBowMode(){return this.check(_.NoBowMode)}requireHealedDolphinToRide(){return this.check(_.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(_.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(_.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(_.OrbsNotRequired)}shuffleGoaFloors(){return this.check(R.ShuffleGoaFloors)}shuffleHouses(){return this.check(R.ShuffleHouses)}shuffleAreas(){return this.check(R.ShuffleAreas)}randomizeMaps(){return this.check(R.RandomizeMaps)}randomizeTrades(){return this.check(R.RandomizeTrades)}unidentifiedItems(){return this.check(R.UnidentifiedKeyItems)}randomizeWalls(){return this.check(R.RandomizeWallElements)}guaranteeSword(){return this.check(q.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(Z.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(Z.MatchingSword,!1)}guaranteeGasMask(){return this.check(Z.GasMask,!1)}guaranteeBarrier(){return this.check(Z.Barrier,!1)}guaranteeRefresh(){return this.check(q.GuaranteeRefresh)}communityJokes(){return this.check(q.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(L.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(L.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(L.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(j.Shops,!1)}disableStatueGlitch(){return this.check(L.StatueGlitch,!1)}disableRageSkip(){return this.check(L.RageSkip,!1)}disableTriggerGlitch(){return this.check(L.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(L.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(L.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(L.GhettoFlight)}assumeTeleportSkip(){return this.check(L.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(L.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(L.StatueGlitch)}assumeTriggerGlitch(){return this.check(L.TriggerSkip)}assumeFlightStatueSkip(){return this.check(L.StatueGauntletSkip)}assumeWildWarp(){return this.check(j.WildWarp,!0)||this.check(R.RandomizeWildWarp)}assumeRageSkip(){return this.check(L.RageSkip)}nerfWildWarp(){return this.check(j.WildWarp,!1)&&this.check(R.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(R.RandomizeWildWarp,!0)}blackoutMode(){return this.check(X.Blackout)}hardcoreMode(){return this.check(X.Permadeath)}buffDyna(){return!this.check(j.Dyna)}maxScalingInTower(){return this.check(X.MaxScalingInTower)}expScalingFactor(){return this.check(X.ExperienceScalesSlower)?.25:this.check(q.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(s){return s==="early"||this.check(Ye.NoAutoEquip,!1)}controllerShortcuts(s){return s==="early"||this.check(Ye.NoControllerShortcuts,!1)}randomizeMusic(s){return this.check(Fe.RandomizeMusic,s==="early"?"!":!0)}shuffleTilePalettes(s){return this.check(Fe.RandomizeMapColors,s==="early"?"!":!0)}noMusic(s){return s==="late"&&this.check(Fe.NoMusic)}audibleWallCues(s){return s==="late"&&this.check(Ye.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(j.Hud,!1)}hasStatTracking(){return!0}};export{Ot as a,Jr as b,Ns as c,Li as d,Ll as e,_i as f,_l as g,Dl as h,Nl as i,Ue as j,is as k,rn as l,Df as m,Nf as n,he as o,ue as p,gt as q};
