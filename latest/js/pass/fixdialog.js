import { Item } from '../rom/item.js';
import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    const { flags: { AkahanaStatueOfOnyxTradein, AsinaInBackRoom, BehindWhirlpool, KensuInSwan, MtSabreNorthSummit, MtSabreWestTornel, PortoaQueen: PortoaQueenItem, Rage, RepairedStatue, SlimedKensu, StomFightReward, UndergroundChannelUnderwaterChest, ZebuAtWindmill, }, npcs: { AkahanaInBrynmaer, Aryllis, Fisherman, PortoaQueen, }, locations: { PortoaPalace_ThroneRoom, }, } = rom;
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    function tradeIn(npc) {
        const trade = tradeIns.get(npc.id);
        if (!trade)
            throw new Error(`No trade-in for ${npc.name}`);
        return rom.items[trade];
    }
    if (!ZebuAtWindmill.item.isMagic())
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(ZebuAtWindmill.item));
    const akahanaWant = tradeIn(AkahanaInBrynmaer);
    replaceMessage('02:01', 'an unusual statue', vague(akahanaWant));
    replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaWant)}`);
    replaceMessage('02:02', '[29:Gas Mask]', item(AkahanaStatueOfOnyxTradein));
    if (!StomFightReward.item.isMagic())
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(StomFightReward));
    const tornelWant = findTornelTradeIn(rom);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[44:Teleport]', item(MtSabreWestTornel));
    const fogLampWant = tradeIn(Fisherman);
    replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:06', 'lamp', commonNoun(fogLampWant));
    const queenWant = PortoaQueen.dialog(PortoaPalace_ThroneRoom)[1].condition;
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(PortoaQueenItem));
    replaceMessage('0a:0d', '[02:Sword of Water]', item(queenWant));
    if (!AsinaInBackRoom.item.isMagic())
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(AsinaInBackRoom));
    if (!BehindWhirlpool.item.isMagic()) {
        unmagic('0b:01');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(BehindWhirlpool));
    replaceMessage('1d:12', '[46:Barrier]', item(BehindWhirlpool));
    let fogLampCaveLoot = findLoot(0x4f, 0x4e, 0x4d, 0x4c, 0x47, 0x46, 0x45, 0x44, 0x4b, 0x4a, 0x49, 0x48);
    if (fogLampCaveLoot) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageWant = rom.npcs.Rage.dialog()[0].condition;
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageWant));
    replaceMessage('0e:03', '[09:Ball of Water]', item(Rage));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisWant = tradeIn(Aryllis);
    replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisWant));
    replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisWant)}`);
    replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisWant));
    const aryllisClue = `Our illustrious chief seeks ${vague(aryllisWant)}.`;
    replaceMessage('12:09', /[^]*/, aryllisClue);
    replaceMessage('12:0a', /[^]*/, aryllisClue);
    const lovePendantWant = tradeIn(rom.npcs.KensuInSwan);
    replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantWant));
    replaceMessage('13:00', 'pendant', commonNoun(lovePendantWant));
    if (!KensuInSwan.item.isMagic()) {
        unmagic('13:02');
    }
    replaceMessage('13:02', '[47:Change]', item(KensuInSwan));
    const ivoryStatueWant = tradeIn(rom.npcs.SlimedKensu);
    replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    if (!SlimedKensu.item.isMagic())
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(SlimedKensu));
    if (!MtSabreNorthSummit.item.isMagic())
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(MtSabreNorthSummit));
    replaceMessage('20:06', 'Statue of Gold', item(RepairedStatue));
    const dolphinChannelTrigger = rom.allocatedTriggers.get('channel item');
    if (dolphinChannelTrigger != null) {
        replaceMessage(rom.trigger(dolphinChannelTrigger).message.mid, '[3b:Love Pendant]', item(UndergroundChannelUnderwaterChest));
    }
    {
        const msg = rom.messages.alloc();
        rom.trigger(0x86).message.mid = msg.mid;
        msg.text =
            '{:HERO:}, there\'s nothing to see here! Return to Zebu at once!';
        rom.messages.parts[0x1c][0x0f].text =
            '{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!';
    }
    function unmagic(mid) {
        replaceMessage(mid, /teach\s+you\s+the\s+magic\s+of/, 'bestow upon you the');
    }
    function item(item) {
        if (typeof item === 'number') {
            item = rom.items[rom.itemGets[item & 0xff].itemId];
        }
        else if (!(item instanceof Item))
            item = item.item;
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        const conditions = [
            (item) => BOWS.has(item),
            (item) => SWORD_OR_MAGIC.has(item),
            (item) => itemget(item).unique,
        ];
        for (const cond of conditions) {
            for (const id of locs) {
                const loc = rom.locations[id];
                const spawns = [...loc.spawns].reverse();
                for (const spawn of spawns) {
                    if (!spawn.isChest())
                        continue;
                    const item = rom.slots[spawn.id];
                    if (item <= 0x48 && cond(item)) {
                        return rom.items[item];
                    }
                }
            }
        }
        return undefined;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
const BOWS = new Set([0x3e, 0x3f, 0x40]);
const SWORD_OR_MAGIC = new Set([0x00, 0x01, 0x02, 0x03, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48]);
function findTornelTradeIn(rom) {
    const { Tornel } = rom.npcs;
    for (const ds of Tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1)) {
                return rom.items[item & 0xff];
            }
        }
    }
    return rom.items.TornadoBracelet;
}
function vague(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'an unusual statue';
        case items.FluteOfLime: return 'a rare instrument';
        case items.FogLamp: return 'a brilliant lamp';
        case items.LovePendant: return 'a beautiful charm';
        case items.KirisaPlant: return 'a fragrant plant';
        case items.IvoryStatue: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'statue';
        case items.FluteOfLime: return 'instrument';
        case items.FogLamp: return 'lamp';
        case items.LovePendant: return 'pendant';
        case items.KirisaPlant: return 'plant';
        case items.IvoryStatue: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFHbEMsTUFBTSxVQUFVLFNBQVMsQ0FBQyxHQUFRO0lBQ2hDLE1BQU0sRUFDSixLQUFLLEVBQUUsRUFDTCwwQkFBMEIsRUFDMUIsZUFBZSxFQUNmLGVBQWUsRUFDZixXQUFXLEVBQ1gsa0JBQWtCLEVBQ2xCLGlCQUFpQixFQUNqQixXQUFXLEVBQUUsZUFBZSxFQUM1QixJQUFJLEVBQ0osY0FBYyxFQUNkLFdBQVcsRUFDWCxlQUFlLEVBQ2YsaUNBQWlDLEVBQ2pDLGNBQWMsR0FDZixFQUNELElBQUksRUFBRSxFQUNKLGlCQUFpQixFQUNqQixPQUFPLEVBQ1AsU0FBUyxFQUNULFdBQVcsR0FDWixFQUNELFNBQVMsRUFBRSxFQUNULHVCQUF1QixHQUN4QixHQUNGLEdBQUcsR0FBRyxDQUFDO0lBR1IsY0FBYyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFakMsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RDLFNBQVMsT0FBTyxDQUFDLEdBQVE7UUFDdkIsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUs7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzRCxP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QUFFLENBQUM7SUFDUCxPQUFPLGlCQUFpQixDQUFDO0FBQzNCLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFVO0lBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO0lBQzdCLFFBQVEsSUFBSSxFQUFFO1FBQ1osS0FBSyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxRQUFRLENBQUM7UUFDekMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxZQUFZLENBQUM7UUFDN0MsS0FBSyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQU0sT0FBTyxNQUFNLENBQUM7UUFDdkMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxTQUFTLENBQUM7UUFDMUMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxPQUFPLENBQUM7UUFDeEMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxRQUFRLENBQUM7S0FDMUM7SUFDRCxJQUFJLEVBQUUsQ0FBQztJQUNQLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RmxhZ30gZnJvbSAnLi4vcm9tL2ZsYWdzLmpzJztcbmltcG9ydCB7SXRlbX0gZnJvbSAnLi4vcm9tL2l0ZW0uanMnO1xuaW1wb3J0IHtOcGN9IGZyb20gJy4uL3JvbS9ucGMuanMnO1xuaW1wb3J0IHtoZXh9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7YnVpbGRUcmFkZUluTWFwfSBmcm9tICcuL3NodWZmbGV0cmFkZXMuanMnO1xuaW1wb3J0IHtmYWlsfSBmcm9tICcuLi9hc3NlcnQuanMnO1xuXG4vKiogRmluZHMgcmVmZXJlbmNlcyB0byBnaXZlbiBpdGVtcyBhbmQgcmVwbGFjZXMgaXQgd2l0aCB0aGUgYWN0dWFsIGl0ZW1zLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpeERpYWxvZyhyb206IFJvbSkge1xuICBjb25zdCB7XG4gICAgZmxhZ3M6IHtcbiAgICAgIEFrYWhhbmFTdGF0dWVPZk9ueXhUcmFkZWluLFxuICAgICAgQXNpbmFJbkJhY2tSb29tLFxuICAgICAgQmVoaW5kV2hpcmxwb29sLFxuICAgICAgS2Vuc3VJblN3YW4sXG4gICAgICBNdFNhYnJlTm9ydGhTdW1taXQsXG4gICAgICBNdFNhYnJlV2VzdFRvcm5lbCxcbiAgICAgIFBvcnRvYVF1ZWVuOiBQb3J0b2FRdWVlbkl0ZW0sXG4gICAgICBSYWdlLFxuICAgICAgUmVwYWlyZWRTdGF0dWUsXG4gICAgICBTbGltZWRLZW5zdSxcbiAgICAgIFN0b21GaWdodFJld2FyZCxcbiAgICAgIFVuZGVyZ3JvdW5kQ2hhbm5lbFVuZGVyd2F0ZXJDaGVzdCxcbiAgICAgIFplYnVBdFdpbmRtaWxsLFxuICAgIH0sXG4gICAgbnBjczoge1xuICAgICAgQWthaGFuYUluQnJ5bm1hZXIsXG4gICAgICBBcnlsbGlzLFxuICAgICAgRmlzaGVybWFuLFxuICAgICAgUG9ydG9hUXVlZW4sXG4gICAgfSxcbiAgICBsb2NhdGlvbnM6IHtcbiAgICAgIFBvcnRvYVBhbGFjZV9UaHJvbmVSb29tLFxuICAgIH0sXG4gIH0gPSByb207XG5cbiAgLy8gU3RvbSdzIFwiSSdsbCwgYmUgd2FpdGluZy4uLlwiIGRpYWxvZyAtIHRoZSBjb21tYSBpcyBqdXN0IHdyb25nLlxuICByZXBsYWNlTWVzc2FnZSgnMDM6MDYnLCAnLCcsICcnKTtcblxuICBjb25zdCB0cmFkZUlucyA9IGJ1aWxkVHJhZGVJbk1hcChyb20pO1xuICBmdW5jdGlvbiB0cmFkZUluKG5wYzogTnBjKTogSXRlbSB7XG4gICAgY29uc3QgdHJhZGUgPSB0cmFkZUlucy5nZXQobnBjLmlkKTtcbiAgICBpZiAoIXRyYWRlKSB0aHJvdyBuZXcgRXJyb3IoYE5vIHRyYWRlLWluIGZvciAke25wYy5uYW1lfWApO1xuICAgIHJldHVybiByb20uaXRlbXNbdHJhZGVdO1xuICB9XG4gIC8vIE5PVEU6IHdlIG5lZWQgdG8gaGFyZGNvZGUgb3JpZ2luYWwgbmFtZXMgaW4gY2FzZSB0aGV5IHdlcmUgc2h1ZmZsZWQuXG5cbiAgaWYgKCFaZWJ1QXRXaW5kbWlsbC5pdGVtLmlzTWFnaWMoKSkgdW5tYWdpYygnMDA6MWInKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAwOjFiJywgJ1s0MTpSZWZyZXNoXScsIGl0ZW0oWmVidUF0V2luZG1pbGwuaXRlbSkpO1xuXG4gIGNvbnN0IGFrYWhhbmFXYW50ID0gdHJhZGVJbihBa2FoYW5hSW5CcnlubWFlcik7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMScsICdhbiB1bnVzdWFsIHN0YXR1ZScsIHZhZ3VlKGFrYWhhbmFXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdhIHN0YXR1ZScsIGB0aGUgJHtjb21tb25Ob3VuKGFrYWhhbmFXYW50KX1gKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAyOjAyJywgJ1syOTpHYXMgTWFza10nLCBpdGVtKEFrYWhhbmFTdGF0dWVPZk9ueXhUcmFkZWluKSk7XG5cbiAgaWYgKCFTdG9tRmlnaHRSZXdhcmQuaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzAzOjAxJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMzowMScsICdbNDM6VGVsZXBhdGh5XScsIGl0ZW0oU3RvbUZpZ2h0UmV3YXJkKSk7XG5cbiAgY29uc3QgdG9ybmVsV2FudCA9IGZpbmRUb3JuZWxUcmFkZUluKHJvbSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMzowMScsICdbMDY6VG9ybmFkbyBCcmFjZWxldF0nLCBpdGVtKHRvcm5lbFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA1OjBhJywgJ1swNjpUb3JuYWRvIEJyYWNlbGV0XScsIGl0ZW0odG9ybmVsV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDU6MGEnLCAnWzQ0OlRlbGVwb3J0XScsIGl0ZW0oTXRTYWJyZVdlc3RUb3JuZWwpKTtcblxuICBjb25zdCBmb2dMYW1wV2FudCA9IHRyYWRlSW4oRmlzaGVybWFuKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA5OjAxJywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwOTowNCcsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDk6MDUnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA2JywgJ2xhbXAnLCBjb21tb25Ob3VuKGZvZ0xhbXBXYW50KSk7XG5cbiAgY29uc3QgcXVlZW5XYW50ID0gUG9ydG9hUXVlZW4uZGlhbG9nKFBvcnRvYVBhbGFjZV9UaHJvbmVSb29tKVsxXS5jb25kaXRpb247XG4gIHJlcGxhY2VNZXNzYWdlKCcwYTowYycsICdbMjg6Rmx1dGUgb2YgTGltZV0nLCBpdGVtKFBvcnRvYVF1ZWVuSXRlbSkpO1xuICByZXBsYWNlTWVzc2FnZSgnMGE6MGQnLCAnWzAyOlN3b3JkIG9mIFdhdGVyXScsIGl0ZW0ocXVlZW5XYW50KSk7XG4gIC8vIFRPRE8gLSBjb25zaWRlciByZXBsYWNpbmcgMGE6MGQgYnV0IHdlIG5lZWQgdG8gYWxzbyByZXBsYWNlIGNvbmRpdGlvbj9cbiAgaWYgKCFBc2luYUluQmFja1Jvb20uaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzBiOjAxJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDU6UmVjb3Zlcl0nLCBpdGVtKEFzaW5hSW5CYWNrUm9vbSkpO1xuXG4gIGlmICghQmVoaW5kV2hpcmxwb29sLml0ZW0uaXNNYWdpYygpKSB7XG4gICAgdW5tYWdpYygnMGI6MDEnKTtcbiAgICB1bm1hZ2ljKCcxZDoxMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDY6QmFycmllcl0nLCBpdGVtKEJlaGluZFdoaXJscG9vbCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMWQ6MTInLCAnWzQ2OkJhcnJpZXJdJywgaXRlbShCZWhpbmRXaGlybHBvb2wpKTtcblxuICAvLyBMb29rIGZvciBhIGtleSBpdGVtIGluIHRoZSBmb2cgbGFtcC9raXJpc2EgcGxhbnQgY2F2ZXMuXG4gIC8vIE9yZGVyIGlzIGJhY2sgb2YgZm9nIGxhbXAsIGtpcmlzYSBiYWNrLXRvLWZyb250LCB0aGVuIGZyb250IG9mIGZvZyBsYW1wXG4gIGxldCBmb2dMYW1wQ2F2ZUxvb3QgPSBmaW5kTG9vdCgweDRmLCAweDRlLCAweDRkLCAweDRjLCAweDQ3LCAweDQ2LCAweDQ1LCAweDQ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMHg0YiwgMHg0YSwgMHg0OSwgMHg0OCk7XG4gIGlmIChmb2dMYW1wQ2F2ZUxvb3QpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGQ6MDAnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcENhdmVMb290KSk7XG4gIH0gZWxzZSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzBkOjAwJywgJ3RoYXQgYSBbMzU6Rm9nIExhbXBdIHdhcycsICd0aGVyZSB3YXMgdHJlYXN1cmUnKTtcbiAgfVxuXG4gIGNvbnN0IHJhZ2VXYW50ID0gcm9tLm5wY3MuUmFnZS5kaWFsb2coKVswXS5jb25kaXRpb247XG4gIHJlcGxhY2VNZXNzYWdlKCcwZTowMycsICdbMDI6U3dvcmQgb2YgV2F0ZXJdJywgaXRlbShyYWdlV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMGU6MDMnLCAnWzA5OkJhbGwgb2YgV2F0ZXJdJywgaXRlbShSYWdlKSk7XG5cbiAgLy8gVE9ETyAtIG1lc3NhZ2UgMTA6MGMgaXMgb25seSBoYWxmLWNvcnJlY3QuICBJZiBpdGVtIG5hbWVzIGFyZSByYW5kb21pemVkXG4gIC8vIHRoZW4gZXZlbiB3aXRob3V0IGEgbG9jYXRpb24gdGhlIG1lc3NhZ2UgaXMgc3RpbGwgdXNlZnVsLiAgU28ganVzdCBkbyB0aGF0XG4gIC8vIGZvciBub3csIGFuZCB3ZSBjYW4gZmluZCBhIHdheSB0byBoaW50IGxhdGVyLlxuICByZXBsYWNlTWVzc2FnZSgnMTA6MGMnLCAndGhhdFxcJ3MnLCAnaXMnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEwOjBjJywgLywgaXMgaW4gdGhlXFwrbGlnaHRob3VzZS8sICcnKTtcblxuICBjb25zdCBhcnlsbGlzV2FudCA9IHRyYWRlSW4oQXJ5bGxpcyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjowNScsICdbM2M6S2lyaXNhIFBsYW50XScsIGl0ZW0oYXJ5bGxpc1dhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ3RoZSBwbGFudCcsIGB0aGUgJHtjb21tb25Ob3VuKGFyeWxsaXNXYW50KX1gKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ1szYzpLaXJpc2EgUGxhbnRdJywgaXRlbShhcnlsbGlzV2FudCkpO1xuICAvLyBUT0RPIC0gcmVmcyBpbiAxMjowOSBhbmQgMTI6MGEgaGF2ZSBsb2NhdGlvbiwgdG9vLlxuICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgLy8gcmVwbGFjZU1lc3NhZ2UoJzEyOjBhJywgL1xccypcXG4uKi8sICcuJyk7XG4gIGNvbnN0IGFyeWxsaXNDbHVlID0gYE91ciBpbGx1c3RyaW91cyBjaGllZiBzZWVrcyAke3ZhZ3VlKGFyeWxsaXNXYW50KX0uYDtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjA5JywgL1teXSovLCBhcnlsbGlzQ2x1ZSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9bXl0qLywgYXJ5bGxpc0NsdWUpO1xuXG4gIGNvbnN0IGxvdmVQZW5kYW50V2FudCA9IHRyYWRlSW4ocm9tLm5wY3MuS2Vuc3VJblN3YW4pO1xuICByZXBsYWNlTWVzc2FnZSgnMTM6MDInLCAnWzNiOkxvdmUgUGVuZGFudF0nLCBpdGVtKGxvdmVQZW5kYW50V2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMTM6MDAnLCAncGVuZGFudCcsIGNvbW1vbk5vdW4obG92ZVBlbmRhbnRXYW50KSk7XG4gIGlmICghS2Vuc3VJblN3YW4uaXRlbS5pc01hZ2ljKCkpIHtcbiAgICB1bm1hZ2ljKCcxMzowMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICdbNDc6Q2hhbmdlXScsIGl0ZW0oS2Vuc3VJblN3YW4pKTtcblxuICBjb25zdCBpdm9yeVN0YXR1ZVdhbnQgPSB0cmFkZUluKHJvbS5ucGNzLlNsaW1lZEtlbnN1KTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgYEl0J3MgaW4gYSByb29tYCwgJ3swYjpLYXJtaW5lfSBpcycpO1xuICBpZiAoIVNsaW1lZEtlbnN1Lml0ZW0uaXNNYWdpYygpKSByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAndGVhY2gnLCAnZ2l2ZScpO1xuICByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAnWzQ4OkZsaWdodF0nLCBpdGVtKFNsaW1lZEtlbnN1KSk7XG5cbiAgaWYgKCFNdFNhYnJlTm9ydGhTdW1taXQuaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzFjOjEwJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxYzoxMCcsICdbNDI6UGFyYWx5c2lzXScsIGl0ZW0oTXRTYWJyZU5vcnRoU3VtbWl0KSk7XG5cbiAgLy8gVE9ETyAtIHNodWZmbGUgd2hpY2ggaXRlbSByZWNvbnN0cnVjdHMgd2hpY2ggb3RoZXI/XG4gIHJlcGxhY2VNZXNzYWdlKCcyMDowNicsICdTdGF0dWUgb2YgR29sZCcsIGl0ZW0oUmVwYWlyZWRTdGF0dWUpKTtcblxuICAvLyBGaW5kIHRoZSBkb2xwaGluIHVuZGVyZ3JvdW5kIGNoYW5uZWwgbWVzc2FnZS5cbiAgY29uc3QgZG9scGhpbkNoYW5uZWxUcmlnZ2VyID0gcm9tLmFsbG9jYXRlZFRyaWdnZXJzLmdldCgnY2hhbm5lbCBpdGVtJyk7XG4gIGlmIChkb2xwaGluQ2hhbm5lbFRyaWdnZXIgIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKHJvbS50cmlnZ2VyKGRvbHBoaW5DaGFubmVsVHJpZ2dlcikubWVzc2FnZS5taWQsXG4gICAgICAgICAgICAgICAgICAgJ1szYjpMb3ZlIFBlbmRhbnRdJyxcbiAgICAgICAgICAgICAgICAgICBpdGVtKFVuZGVyZ3JvdW5kQ2hhbm5lbFVuZGVyd2F0ZXJDaGVzdCkpO1xuICB9XG5cbiAgLy8gVE9ETyAtIGNvbnNpZGVyIHdhcnBpbmcgb24gYSByYW5kb20gc3dvcmQ/IC0gbWVzc2FnZSAxYzoxMVxuXG4gIC8vIFNwbGl0IHRoZSBtZXNzYWdlIG9uIGVpdGhlciBzaWRlIG9mIFNhYnJlIE4gZW50cmFuY2UuXG4gIHtcbiAgICBjb25zdCBtc2cgPSByb20ubWVzc2FnZXMuYWxsb2MoKTtcbiAgICByb20udHJpZ2dlcigweDg2KS5tZXNzYWdlLm1pZCA9IG1zZy5taWQ7IC8vIHJhYmJpdFxuICAgIG1zZy50ZXh0ID1cbiAgICAgICAgJ3s6SEVSTzp9LCB0aGVyZVxcJ3Mgbm90aGluZyB0byBzZWUgaGVyZSEgUmV0dXJuIHRvIFplYnUgYXQgb25jZSEnO1xuICAgIC8vIHJvbS50cmlnZ2VyKDB4YmEpIC8vIHRlbGVwb3J0XG4gICAgLy8gVE9ETyAtIHNlZSBpZiBpdCdzIGNoYW5nZWQ/XG4gICAgcm9tLm1lc3NhZ2VzLnBhcnRzWzB4MWNdWzB4MGZdLnRleHQgPVxuICAgICAgICAnezpIRVJPOn0sIHlvdSBjYW5ub3QgY2xpbWIgdGhpcyB5ZXQhIFNlZWsgb3V0IFs0NDpUZWxlcG9ydF0gYXQgb25jZSEnO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGZ1bmN0aW9uIHVubWFnaWMobWlkOiBzdHJpbmcpIHtcbiAgICByZXBsYWNlTWVzc2FnZShtaWQsIC90ZWFjaFxccyt5b3VcXHMrdGhlXFxzK21hZ2ljXFxzK29mLywgJ2Jlc3RvdyB1cG9uIHlvdSB0aGUnKTtcbiAgfVxuICBmdW5jdGlvbiBpdGVtKGl0ZW06IG51bWJlcnxGbGFnfEl0ZW0pOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGl0ZW0gPSByb20uaXRlbXNbcm9tLml0ZW1HZXRzW2l0ZW0gJiAweGZmXS5pdGVtSWRdO1xuICAgIH0gZWxzZSBpZiAoIShpdGVtIGluc3RhbmNlb2YgSXRlbSkpIGl0ZW0gPSBpdGVtLml0ZW0gYXMgSXRlbTtcbiAgICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuICB9XG4gIGZ1bmN0aW9uIHJlcGxhY2VNZXNzYWdlKG1pZDogc3RyaW5nLCBwYXQ6IHN0cmluZyB8IFJlZ0V4cCwgcmVwbDogc3RyaW5nKSB7XG4gICAgY29uc3QgW3BhcnQsIGluZGV4XSA9IG1pZC5zcGxpdCgnOicpLm1hcCh4ID0+IHBhcnNlSW50KHgsIDE2KSk7XG4gICAgY29uc3QgbXNnID0gcm9tLm1lc3NhZ2VzLnBhcnRzW3BhcnRdW2luZGV4XTtcbiAgICBtc2cudGV4dCA9IG1zZy50ZXh0LnJlcGxhY2UocGF0LCByZXBsKTtcbiAgfVxuICBmdW5jdGlvbiBmaW5kTG9vdCguLi5sb2NzOiBudW1iZXJbXSk6IEl0ZW18dW5kZWZpbmVkIHtcbiAgICBjb25zdCBjb25kaXRpb25zID0gW1xuICAgICAgKGl0ZW06IG51bWJlcikgPT4gQk9XUy5oYXMoaXRlbSksXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBTV09SRF9PUl9NQUdJQy5oYXMoaXRlbSksXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBpdGVtZ2V0KGl0ZW0pLnVuaXF1ZSxcbiAgICBdO1xuXG4gICAgZm9yIChjb25zdCBjb25kIG9mIGNvbmRpdGlvbnMpIHtcbiAgICAgIGZvciAoY29uc3QgaWQgb2YgbG9jcykge1xuICAgICAgICBjb25zdCBsb2MgPSByb20ubG9jYXRpb25zW2lkXTtcbiAgICAgICAgLy8gTk9URTogRm9nIExhbXAgQ2F2ZSAzIGhhcyB0aGUgc3Bhd25zIGluIG9yZGVyLCBzbyB3ZSBuZWVkIHRvXG4gICAgICAgIC8vIGNoZWNrIGZvciB0aGUgc3Bhd25zIGluIHJldmVyc2Ugb3JkZXIgdG8gZ28gZGVlcGVyLWZpcnN0LlxuICAgICAgICBjb25zdCBzcGF3bnMgPSBbLi4ubG9jLnNwYXduc10ucmV2ZXJzZSgpO1xuICAgICAgICBmb3IgKGNvbnN0IHNwYXduIG9mIHNwYXducykge1xuICAgICAgICAgIGlmICghc3Bhd24uaXNDaGVzdCgpKSBjb250aW51ZTtcbiAgICAgICAgICBjb25zdCBpdGVtID0gcm9tLnNsb3RzW3NwYXduLmlkXTtcbiAgICAgICAgICBpZiAoaXRlbSA8PSAweDQ4ICYmIGNvbmQoaXRlbSkpIHtcbiAgICAgICAgICAgIHJldHVybiByb20uaXRlbXNbaXRlbV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgZnVuY3Rpb24gaXRlbWdldChpZDogbnVtYmVyKTogSXRlbSB7XG4gICAgY29uc3QgaXRlbWdldCA9IHJvbS5pdGVtR2V0c1tpZF07XG4gICAgcmV0dXJuIHJvbS5pdGVtc1tpdGVtZ2V0Lml0ZW1JZF07XG4gIH1cbn1cblxuY29uc3QgQk9XUyA9IG5ldyBTZXQoWzB4M2UsIDB4M2YsIDB4NDBdKTtcbmNvbnN0IFNXT1JEX09SX01BR0lDID0gbmV3IFNldChbMHgwMCwgMHgwMSwgMHgwMiwgMHgwMywgMHg0MSwgMHg0MiwgMHg0MywgMHg0NCwgMHg0NSwgMHg0NiwgMHg0NywgMHg0OF0pO1xuXG5mdW5jdGlvbiBmaW5kVG9ybmVsVHJhZGVJbihyb206IFJvbSk6IEl0ZW0ge1xuICAvLyBFeHBlY3RlZCBzdHJ1Y3R1cmU6XG4gIC8vICAgLi4uXG4gIC8vICAgTk9UIGJyYWNlbGV0IC0+IC4uLlxuICAvLyAgIE5PVCBiYWxsIC0+IC4uLlxuICAvLyAgIC0+IGdpdmUgaXRlbVxuICBjb25zdCB7VG9ybmVsfSA9IHJvbS5ucGNzO1xuICBmb3IgKGNvbnN0IGRzIG9mIFRvcm5lbC5sb2NhbERpYWxvZ3MudmFsdWVzKCkpIHtcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpdGVtID0gfmRzW2ldLmNvbmRpdGlvbjtcbiAgICAgIC8vIExvb2sgZm9yIGFueSBuZWdhdGl2ZSBjb25kaXRpb24gb24gYSBicmFjZWxldCAoZG9lc24ndCBtYXR0ZXIgd2hlcmUpXG4gICAgICBpZiAoaXRlbSA+IDB4MjA0ICYmIGl0ZW0gPD0gMHgyMGMgJiYgIShpdGVtICYgMSkpIHtcbiAgICAgICAgcmV0dXJuIHJvbS5pdGVtc1tpdGVtICYgMHhmZl07XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiByb20uaXRlbXMuVG9ybmFkb0JyYWNlbGV0OyAvLyBkZWZhdWx0IHRvIHRvcm5hZG8gYnJhY2VsZXRcbn1cblxuZnVuY3Rpb24gdmFndWUoaXRlbTogSXRlbSk6IHN0cmluZyB7XG4gIGNvbnN0IGl0ZW1zID0gaXRlbS5yb20uaXRlbXM7XG4gIHN3aXRjaCAoaXRlbSkge1xuICAgIGNhc2UgaXRlbXMuU3RhdHVlT2ZPbnl4OiByZXR1cm4gJ2FuIHVudXN1YWwgc3RhdHVlJztcbiAgICBjYXNlIGl0ZW1zLkZsdXRlT2ZMaW1lOiAgcmV0dXJuICdhIHJhcmUgaW5zdHJ1bWVudCc7XG4gICAgY2FzZSBpdGVtcy5Gb2dMYW1wOiAgICAgIHJldHVybiAnYSBicmlsbGlhbnQgbGFtcCc7XG4gICAgY2FzZSBpdGVtcy5Mb3ZlUGVuZGFudDogIHJldHVybiAnYSBiZWF1dGlmdWwgY2hhcm0nO1xuICAgIGNhc2UgaXRlbXMuS2lyaXNhUGxhbnQ6ICByZXR1cm4gJ2EgZnJhZ3JhbnQgcGxhbnQnO1xuICAgIGNhc2UgaXRlbXMuSXZvcnlTdGF0dWU6ICByZXR1cm4gJ2FuIGV4b3RpYyBzdGF0dWUnO1xuICAgIC8vIFRPRE8gLSBzdGF0dWUgb2YgZ29sZFxuICB9XG4gIGZhaWwoKTtcbiAgcmV0dXJuICdhIHZhbHVhYmxlIGl0ZW0nO1xufVxuXG5mdW5jdGlvbiBjb21tb25Ob3VuKGl0ZW06IEl0ZW0pOiBzdHJpbmcge1xuICBjb25zdCBpdGVtcyA9IGl0ZW0ucm9tLml0ZW1zO1xuICBzd2l0Y2ggKGl0ZW0pIHtcbiAgICBjYXNlIGl0ZW1zLlN0YXR1ZU9mT255eDogcmV0dXJuICdzdGF0dWUnO1xuICAgIGNhc2UgaXRlbXMuRmx1dGVPZkxpbWU6ICByZXR1cm4gJ2luc3RydW1lbnQnO1xuICAgIGNhc2UgaXRlbXMuRm9nTGFtcDogICAgICByZXR1cm4gJ2xhbXAnO1xuICAgIGNhc2UgaXRlbXMuTG92ZVBlbmRhbnQ6ICByZXR1cm4gJ3BlbmRhbnQnO1xuICAgIGNhc2UgaXRlbXMuS2lyaXNhUGxhbnQ6ICByZXR1cm4gJ3BsYW50JztcbiAgICBjYXNlIGl0ZW1zLkl2b3J5U3RhdHVlOiAgcmV0dXJuICdzdGF0dWUnO1xuICB9XG4gIGZhaWwoKTtcbiAgcmV0dXJuICdpdGVtJztcbn1cblxuLy8gZnVuY3Rpb24gcmVwbGFjZURpYWxvZyhucGM6IE5wYywgb3JpZzogbnVtYmVyIHwgUmVnRXhwLCByZXBsYWNlbWVudElkOiBudW1iZXIpIHtcbi8vICAgY29uc3Qgcm9tID0gbnBjLnJvbTtcbi8vICAgY29uc3QgcGF0ID0gb3JpZyBpbnN0YW5jZW9mIFJlZ0V4cCA/IG9yaWcgOiBwYXR0ZXJuKHJvbS5pdGVtc1tvcmlnXSk7XG4vLyAgIGNvbnN0IHJlcGwgPSByZXBsYWNlbWVudChyb20uaXRlbXNbcmVwbGFjZW1lbnRJZF0pO1xuLy8gICBmb3IgKGNvbnN0IGRzIG9mIG5wYy5sb2NhbERpYWxvZ3MudmFsdWVzKCkpIHtcbi8vICAgICBmb3IgKGNvbnN0IGQgb2YgZHMpIHtcbi8vICAgICAgIGNvbnN0IG1pZCA9IGQubWVzc2FnZTtcbi8vICAgICAgIHJlcGxhY2VNZXNzYWdlKHJvbSwgbWlkLnBhcnQsIG1pZC5pbmRleCwgcGF0LCByZXBsKTtcbi8vICAgICB9XG4vLyAgIH1cbi8vIH1cblxuLy8gY29uc3QgcGF0dGVybjogeyhpZDogbnVtYmVyLCBuYW1lOiBzdHJpbmcpOiBSZWdFeHA7XG4vLyAgICAgICAgICAgICAgICAgKGl0ZW06IEl0ZW0pOiBSZWdFeHB9ID1cbi8vICAgICAoaXRlbTogbnVtYmVyIHwgSXRlbSwgbmFtZT86IHN0cmluZykgPT4ge1xuLy8gICAgICAgbmFtZSA9IG5hbWUgfHwgKGl0ZW0gYXMgSXRlbSkubWVzc2FnZU5hbWU7XG4vLyAgICAgICBjb25zdCBpZCA9IGhleChpdGVtIGluc3RhbmNlb2YgSXRlbSA/IGl0ZW0uaWQgOiBpdGVtKTtcbi8vICAgICAgIHJldHVybiBuZXcgUmVnRXhwKGBcXFxcWyR7aWR9OlteXFxcXF1dKlxcXFxdfCR7bmFtZS5yZXBsYWNlKC9cXHMrL2csICdcXFxccysnKX1gLFxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgJ2cnKTtcbi8vICAgICB9O1xuXG4vLyBmdW5jdGlvbiByZXBsYWNlbWVudChpdGVtOiBJdGVtKTogc3RyaW5nIHtcbi8vICAgcmV0dXJuIGBbJHtoZXgoaXRlbS5pZCl9OiR7aXRlbS5tZXNzYWdlTmFtZX1dYDtcbi8vIH1cbiJdfQ==