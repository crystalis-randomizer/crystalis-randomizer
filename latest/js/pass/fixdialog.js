import { Item } from '../rom/item.js';
import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    const { flags: { AkahanaStatueOfOnyxTradein, AsinaInBackRoom, BehindWhirlpool, KensuInSwan, MtSabreNorthSummit, MtSabreWestTornel, PortoaQueen, Rage, RepairedStatue, SlimedKensu, StomFightReward, ZebuAtWindmill, }, npcs: { AkahanaInBrynmaer, Aryllis, Fisherman, }, } = rom;
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    function tradeIn(npc) {
        const trade = tradeIns.get(npc.id);
        if (!trade)
            throw new Error(`No trade-in for ${npc.name}`);
        return rom.items[trade];
    }
    if (!ZebuAtWindmill.item.isMagic())
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(ZebuAtWindmill.item));
    const akahanaWant = tradeIn(AkahanaInBrynmaer);
    replaceMessage('02:01', 'an unusual statue', vague(akahanaWant));
    replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaWant)}`);
    replaceMessage('02:02', '[29:Gas Mask]', item(AkahanaStatueOfOnyxTradein));
    if (!StomFightReward.item.isMagic())
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(StomFightReward));
    const tornelWant = findTornelTradeIn(rom);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[44:Teleport]', item(MtSabreWestTornel));
    const fogLampWant = tradeIn(Fisherman);
    replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:06', 'lamp', commonNoun(fogLampWant));
    const queenWant = rom.npcs.PortoaQueen.dialog()[3].condition;
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(PortoaQueen));
    replaceMessage('0a:0d', '[02:Sword of Water]', item(queenWant));
    if (!AsinaInBackRoom.item.isMagic())
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(AsinaInBackRoom));
    if (!BehindWhirlpool.item.isMagic()) {
        unmagic('0b:01');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(BehindWhirlpool));
    replaceMessage('1d:12', '[46:Barrier]', item(BehindWhirlpool));
    let fogLampCaveLoot = findLoot(0x4f, 0x4e, 0x4d, 0x4c, 0x47, 0x46, 0x45, 0x44, 0x4b, 0x4a, 0x49, 0x48);
    if (fogLampCaveLoot) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageWant = rom.npcs.Rage.dialog()[0].condition;
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageWant));
    replaceMessage('0e:03', '[09:Ball of Water]', item(Rage));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisWant = tradeIn(Aryllis);
    replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisWant));
    replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisWant)}`);
    replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisWant));
    const aryllisClue = `Our illustrious chief seeks ${vague(aryllisWant)}.`;
    replaceMessage('12:09', /[^]*/, aryllisClue);
    replaceMessage('12:0a', /[^]*/, aryllisClue);
    const lovePendantWant = tradeIn(rom.npcs.KensuInSwan);
    replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantWant));
    replaceMessage('13:00', 'pendant', commonNoun(lovePendantWant));
    if (!KensuInSwan.item.isMagic()) {
        unmagic('13:02');
    }
    replaceMessage('13:02', '[47:Change]', item(KensuInSwan));
    const ivoryStatueWant = tradeIn(rom.npcs.SlimedKensu);
    replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    if (!SlimedKensu.item.isMagic())
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(SlimedKensu));
    if (!MtSabreNorthSummit.item.isMagic())
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(MtSabreNorthSummit));
    replaceMessage('20:06', 'Statue of Gold', item(RepairedStatue));
    {
        const msg = rom.messages.alloc();
        rom.trigger(0x86).message.mid = msg.mid;
        msg.text =
            '{:HERO:}, there\'s nothing to see here! Return to Zebu at once!';
        rom.messages.parts[0x1c][0x0f].text =
            '{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!';
    }
    function unmagic(mid) {
        replaceMessage(mid, /teach\s+you\s+the\s+magic\s+of/, 'bestow upon you the');
    }
    function item(item) {
        if (typeof item === 'number') {
            item = rom.items[rom.itemGets[item & 0xff].itemId];
        }
        else if (!(item instanceof Item))
            item = item.item;
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        const conditions = [
            (item) => BOWS.has(item),
            (item) => SWORD_OR_MAGIC.has(item),
            (item) => itemget(item).unique,
        ];
        for (const cond of conditions) {
            for (const id of locs) {
                const loc = rom.locations[id];
                for (const spawn of loc.spawns) {
                    if (!spawn.isChest())
                        continue;
                    const item = rom.slots[spawn.id];
                    if (item <= 0x48 && cond(item)) {
                        return rom.items[item];
                    }
                }
            }
        }
        return undefined;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
const BOWS = new Set([0x3e, 0x3f, 0x40]);
const SWORD_OR_MAGIC = new Set([0x00, 0x01, 0x02, 0x03, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48]);
function findTornelTradeIn(rom) {
    const { Tornel } = rom.npcs;
    for (const ds of Tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1)) {
                return rom.items[item & 0xff];
            }
        }
    }
    return rom.items.TornadoBracelet;
}
function vague(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'an unusual statue';
        case items.FluteOfLime: return 'a rare instrument';
        case items.FogLamp: return 'a brilliant lamp';
        case items.LovePendant: return 'a beautiful charm';
        case items.KirisaPlant: return 'a fragrant plant';
        case items.IvoryStatue: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'statue';
        case items.FluteOfLime: return 'instrument';
        case items.FogLamp: return 'lamp';
        case items.LovePendant: return 'pendant';
        case items.KirisaPlant: return 'plant';
        case items.IvoryStatue: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFHbEMsTUFBTSxVQUFVLFNBQVMsQ0FBQyxHQUFRO0lBQ2hDLE1BQU0sRUFDSixLQUFLLEVBQUUsRUFDTCwwQkFBMEIsRUFDMUIsZUFBZSxFQUNmLGVBQWUsRUFDZixXQUFXLEVBQ1gsa0JBQWtCLEVBQ2xCLGlCQUFpQixFQUNqQixXQUFXLEVBQ1gsSUFBSSxFQUNKLGNBQWMsRUFDZCxXQUFXLEVBQ1gsZUFBZSxFQUNmLGNBQWMsR0FDZixFQUNELElBQUksRUFBRSxFQUNKLGlCQUFpQixFQUNqQixPQUFPLEVBQ1AsU0FBUyxHQUNWLEdBQ0YsR0FBRyxHQUFHLENBQUM7SUFHUixjQUFjLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUVqQyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEMsU0FBUyxPQUFPLENBQUMsR0FBUTtRQUN2QixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsS0FBSztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzNELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBR0QsSUFBSSxDQUFDLGNB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S0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxPQUFPLENBQUM7UUFDeEMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxRQUFRLENBQUM7S0FDMUM7SUFDRCxJQUFJLEVBQUUsQ0FBQztJQUNQLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RmxhZ30gZnJvbSAnLi4vcm9tL2ZsYWdzLmpzJztcbmltcG9ydCB7SXRlbX0gZnJvbSAnLi4vcm9tL2l0ZW0uanMnO1xuaW1wb3J0IHtOcGN9IGZyb20gJy4uL3JvbS9ucGMuanMnO1xuaW1wb3J0IHtoZXh9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7YnVpbGRUcmFkZUluTWFwfSBmcm9tICcuL3NodWZmbGV0cmFkZXMuanMnO1xuaW1wb3J0IHtmYWlsfSBmcm9tICcuLi9hc3NlcnQuanMnO1xuXG4vKiogRmluZHMgcmVmZXJlbmNlcyB0byBnaXZlbiBpdGVtcyBhbmQgcmVwbGFjZXMgaXQgd2l0aCB0aGUgYWN0dWFsIGl0ZW1zLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpeERpYWxvZyhyb206IFJvbSkge1xuICBjb25zdCB7XG4gICAgZmxhZ3M6IHtcbiAgICAgIEFrYWhhbmFTdGF0dWVPZk9ueXhUcmFkZWluLFxuICAgICAgQXNpbmFJbkJhY2tSb29tLFxuICAgICAgQmVoaW5kV2hpcmxwb29sLFxuICAgICAgS2Vuc3VJblN3YW4sXG4gICAgICBNdFNhYnJlTm9ydGhTdW1taXQsXG4gICAgICBNdFNhYnJlV2VzdFRvcm5lbCxcbiAgICAgIFBvcnRvYVF1ZWVuLFxuICAgICAgUmFnZSxcbiAgICAgIFJlcGFpcmVkU3RhdHVlLFxuICAgICAgU2xpbWVkS2Vuc3UsXG4gICAgICBTdG9tRmlnaHRSZXdhcmQsXG4gICAgICBaZWJ1QXRXaW5kbWlsbCxcbiAgICB9LFxuICAgIG5wY3M6IHtcbiAgICAgIEFrYWhhbmFJbkJyeW5tYWVyLFxuICAgICAgQXJ5bGxpcyxcbiAgICAgIEZpc2hlcm1hbixcbiAgICB9LFxuICB9ID0gcm9tO1xuXG4gIC8vIFN0b20ncyBcIkknbGwsIGJlIHdhaXRpbmcuLi5cIiBkaWFsb2cgLSB0aGUgY29tbWEgaXMganVzdCB3cm9uZy5cbiAgcmVwbGFjZU1lc3NhZ2UoJzAzOjA2JywgJywnLCAnJyk7XG5cbiAgY29uc3QgdHJhZGVJbnMgPSBidWlsZFRyYWRlSW5NYXAocm9tKTtcbiAgZnVuY3Rpb24gdHJhZGVJbihucGM6IE5wYyk6IEl0ZW0ge1xuICAgIGNvbnN0IHRyYWRlID0gdHJhZGVJbnMuZ2V0KG5wYy5pZCk7XG4gICAgaWYgKCF0cmFkZSkgdGhyb3cgbmV3IEVycm9yKGBObyB0cmFkZS1pbiBmb3IgJHtucGMubmFtZX1gKTtcbiAgICByZXR1cm4gcm9tLml0ZW1zW3RyYWRlXTtcbiAgfVxuICAvLyBOT1RFOiB3ZSBuZWVkIHRvIGhhcmRjb2RlIG9yaWdpbmFsIG5hbWVzIGluIGNhc2UgdGhleSB3ZXJlIHNodWZmbGVkLlxuXG4gIGlmICghWmVidUF0V2luZG1pbGwuaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzAwOjFiJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMDoxYicsICdbNDE6UmVmcmVzaF0nLCBpdGVtKFplYnVBdFdpbmRtaWxsLml0ZW0pKTtcblxuICBjb25zdCBha2FoYW5hV2FudCA9IHRyYWRlSW4oQWthaGFuYUluQnJ5bm1hZXIpO1xuICByZXBsYWNlTWVzc2FnZSgnMDI6MDEnLCAnYW4gdW51c3VhbCBzdGF0dWUnLCB2YWd1ZShha2FoYW5hV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDI6MDInLCAnYSBzdGF0dWUnLCBgdGhlICR7Y29tbW9uTm91bihha2FoYW5hV2FudCl9YCk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdbMjk6R2FzIE1hc2tdJywgaXRlbShBa2FoYW5hU3RhdHVlT2ZPbnl4VHJhZGVpbikpO1xuXG4gIGlmICghU3RvbUZpZ2h0UmV3YXJkLml0ZW0uaXNNYWdpYygpKSB1bm1hZ2ljKCcwMzowMScpO1xuICByZXBsYWNlTWVzc2FnZSgnMDM6MDEnLCAnWzQzOlRlbGVwYXRoeV0nLCBpdGVtKFN0b21GaWdodFJld2FyZCkpO1xuXG4gIGNvbnN0IHRvcm5lbFdhbnQgPSBmaW5kVG9ybmVsVHJhZGVJbihyb20pO1xuICByZXBsYWNlTWVzc2FnZSgnMDM6MDEnLCAnWzA2OlRvcm5hZG8gQnJhY2VsZXRdJywgaXRlbSh0b3JuZWxXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwNTowYScsICdbMDY6VG9ybmFkbyBCcmFjZWxldF0nLCBpdGVtKHRvcm5lbFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA1OjBhJywgJ1s0NDpUZWxlcG9ydF0nLCBpdGVtKE10U2FicmVXZXN0VG9ybmVsKSk7XG5cbiAgY29uc3QgZm9nTGFtcFdhbnQgPSB0cmFkZUluKEZpc2hlcm1hbik7XG4gIHJlcGxhY2VNZXNzYWdlKCcwOTowMScsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDk6MDQnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA1JywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwOTowNicsICdsYW1wJywgY29tbW9uTm91bihmb2dMYW1wV2FudCkpO1xuXG4gIGNvbnN0IHF1ZWVuV2FudCA9IHJvbS5ucGNzLlBvcnRvYVF1ZWVuLmRpYWxvZygpWzNdLmNvbmRpdGlvbjtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBhOjBjJywgJ1syODpGbHV0ZSBvZiBMaW1lXScsIGl0ZW0oUG9ydG9hUXVlZW4pKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBhOjBkJywgJ1swMjpTd29yZCBvZiBXYXRlcl0nLCBpdGVtKHF1ZWVuV2FudCkpO1xuICAvLyBUT0RPIC0gY29uc2lkZXIgcmVwbGFjaW5nIDBhOjBkIGJ1dCB3ZSBuZWVkIHRvIGFsc28gcmVwbGFjZSBjb25kaXRpb24/XG4gIGlmICghQXNpbmFJbkJhY2tSb29tLml0ZW0uaXNNYWdpYygpKSB1bm1hZ2ljKCcwYjowMScpO1xuICByZXBsYWNlTWVzc2FnZSgnMGI6MDEnLCAnWzQ1OlJlY292ZXJdJywgaXRlbShBc2luYUluQmFja1Jvb20pKTtcblxuICBpZiAoIUJlaGluZFdoaXJscG9vbC5pdGVtLmlzTWFnaWMoKSkge1xuICAgIHVubWFnaWMoJzBiOjAxJyk7XG4gICAgdW5tYWdpYygnMWQ6MTInKTtcbiAgfVxuICByZXBsYWNlTWVzc2FnZSgnMGI6MDEnLCAnWzQ2OkJhcnJpZXJdJywgaXRlbShCZWhpbmRXaGlybHBvb2wpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzFkOjEyJywgJ1s0NjpCYXJyaWVyXScsIGl0ZW0oQmVoaW5kV2hpcmxwb29sKSk7XG5cbiAgLy8gTG9vayBmb3IgYSBrZXkgaXRlbSBpbiB0aGUgZm9nIGxhbXAva2lyaXNhIHBsYW50IGNhdmVzLlxuICAvLyBPcmRlciBpcyBiYWNrIG9mIGZvZyBsYW1wLCBraXJpc2EgYmFjay10by1mcm9udCwgdGhlbiBmcm9udCBvZiBmb2cgbGFtcFxuICBsZXQgZm9nTGFtcENhdmVMb290ID0gZmluZExvb3QoMHg0ZiwgMHg0ZSwgMHg0ZCwgMHg0YywgMHg0NywgMHg0NiwgMHg0NSwgMHg0NCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDB4NGIsIDB4NGEsIDB4NDksIDB4NDgpO1xuICBpZiAoZm9nTGFtcENhdmVMb290KSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzBkOjAwJywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBDYXZlTG9vdCkpO1xuICB9IGVsc2Uge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwZDowMCcsICd0aGF0IGEgWzM1OkZvZyBMYW1wXSB3YXMnLCAndGhlcmUgd2FzIHRyZWFzdXJlJyk7XG4gIH1cblxuICBjb25zdCByYWdlV2FudCA9IHJvbS5ucGNzLlJhZ2UuZGlhbG9nKClbMF0uY29uZGl0aW9uO1xuICByZXBsYWNlTWVzc2FnZSgnMGU6MDMnLCAnWzAyOlN3b3JkIG9mIFdhdGVyXScsIGl0ZW0ocmFnZVdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBlOjAzJywgJ1swOTpCYWxsIG9mIFdhdGVyXScsIGl0ZW0oUmFnZSkpO1xuXG4gIC8vIFRPRE8gLSBtZXNzYWdlIDEwOjBjIGlzIG9ubHkgaGFsZi1jb3JyZWN0LiAgSWYgaXRlbSBuYW1lcyBhcmUgcmFuZG9taXplZFxuICAvLyB0aGVuIGV2ZW4gd2l0aG91dCBhIGxvY2F0aW9uIHRoZSBtZXNzYWdlIGlzIHN0aWxsIHVzZWZ1bC4gIFNvIGp1c3QgZG8gdGhhdFxuICAvLyBmb3Igbm93LCBhbmQgd2UgY2FuIGZpbmQgYSB3YXkgdG8gaGludCBsYXRlci5cbiAgcmVwbGFjZU1lc3NhZ2UoJzEwOjBjJywgJ3RoYXRcXCdzJywgJ2lzJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMDowYycsIC8sIGlzIGluIHRoZVxcK2xpZ2h0aG91c2UvLCAnJyk7XG5cbiAgY29uc3QgYXJ5bGxpc1dhbnQgPSB0cmFkZUluKEFyeWxsaXMpO1xuICByZXBsYWNlTWVzc2FnZSgnMTI6MDUnLCAnWzNjOktpcmlzYSBQbGFudF0nLCBpdGVtKGFyeWxsaXNXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjoxMCcsICd0aGUgcGxhbnQnLCBgdGhlICR7Y29tbW9uTm91bihhcnlsbGlzV2FudCl9YCk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjoxMCcsICdbM2M6S2lyaXNhIFBsYW50XScsIGl0ZW0oYXJ5bGxpc1dhbnQpKTtcbiAgLy8gVE9ETyAtIHJlZnMgaW4gMTI6MDkgYW5kIDEyOjBhIGhhdmUgbG9jYXRpb24sIHRvby5cbiAgLy8gcmVwbGFjZU1lc3NhZ2UoJzEyOjA5JywgL1xccypcXG4uKi8sICcuJyk7XG4gIC8vIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9cXHMqXFxuLiovLCAnLicpO1xuICBjb25zdCBhcnlsbGlzQ2x1ZSA9IGBPdXIgaWxsdXN0cmlvdXMgY2hpZWYgc2Vla3MgJHt2YWd1ZShhcnlsbGlzV2FudCl9LmA7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjowOScsIC9bXl0qLywgYXJ5bGxpc0NsdWUpO1xuICByZXBsYWNlTWVzc2FnZSgnMTI6MGEnLCAvW15dKi8sIGFyeWxsaXNDbHVlKTtcblxuICBjb25zdCBsb3ZlUGVuZGFudFdhbnQgPSB0cmFkZUluKHJvbS5ucGNzLktlbnN1SW5Td2FuKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAyJywgJ1szYjpMb3ZlIFBlbmRhbnRdJywgaXRlbShsb3ZlUGVuZGFudFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAwJywgJ3BlbmRhbnQnLCBjb21tb25Ob3VuKGxvdmVQZW5kYW50V2FudCkpO1xuICBpZiAoIUtlbnN1SW5Td2FuLml0ZW0uaXNNYWdpYygpKSB7XG4gICAgdW5tYWdpYygnMTM6MDInKTtcbiAgfVxuICByZXBsYWNlTWVzc2FnZSgnMTM6MDInLCAnWzQ3OkNoYW5nZV0nLCBpdGVtKEtlbnN1SW5Td2FuKSk7XG5cbiAgY29uc3QgaXZvcnlTdGF0dWVXYW50ID0gdHJhZGVJbihyb20ubnBjcy5TbGltZWRLZW5zdSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxODowNicsICdbM2Q6SXZvcnkgU3RhdHVlXScsIGl0ZW0oaXZvcnlTdGF0dWVXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxODowNycsICdbM2Q6SXZvcnkgU3RhdHVlXScsIGl0ZW0oaXZvcnlTdGF0dWVXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxODowNicsIGBJdCdzIGluIGEgcm9vbWAsICd7MGI6S2FybWluZX0gaXMnKTtcbiAgaWYgKCFTbGltZWRLZW5zdS5pdGVtLmlzTWFnaWMoKSkgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ3RlYWNoJywgJ2dpdmUnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ1s0ODpGbGlnaHRdJywgaXRlbShTbGltZWRLZW5zdSkpO1xuXG4gIGlmICghTXRTYWJyZU5vcnRoU3VtbWl0Lml0ZW0uaXNNYWdpYygpKSB1bm1hZ2ljKCcxYzoxMCcpO1xuICByZXBsYWNlTWVzc2FnZSgnMWM6MTAnLCAnWzQyOlBhcmFseXNpc10nLCBpdGVtKE10U2FicmVOb3J0aFN1bW1pdCkpO1xuXG4gIC8vIFRPRE8gLSBzaHVmZmxlIHdoaWNoIGl0ZW0gcmVjb25zdHJ1Y3RzIHdoaWNoIG90aGVyP1xuICByZXBsYWNlTWVzc2FnZSgnMjA6MDYnLCAnU3RhdHVlIG9mIEdvbGQnLCBpdGVtKFJlcGFpcmVkU3RhdHVlKSk7XG5cbiAgLy8gVE9ETyAtIGNvbnNpZGVyIHdhcnBpbmcgb24gYSByYW5kb20gc3dvcmQ/IC0gbWVzc2FnZSAxYzoxMVxuXG4gIC8vIFNwbGl0IHRoZSBtZXNzYWdlIG9uIGVpdGhlciBzaWRlIG9mIFNhYnJlIE4gZW50cmFuY2UuXG4gIHtcbiAgICBjb25zdCBtc2cgPSByb20ubWVzc2FnZXMuYWxsb2MoKTtcbiAgICByb20udHJpZ2dlcigweDg2KS5tZXNzYWdlLm1pZCA9IG1zZy5taWQ7IC8vIHJhYmJpdFxuICAgIG1zZy50ZXh0ID1cbiAgICAgICAgJ3s6SEVSTzp9LCB0aGVyZVxcJ3Mgbm90aGluZyB0byBzZWUgaGVyZSEgUmV0dXJuIHRvIFplYnUgYXQgb25jZSEnO1xuICAgIC8vIHJvbS50cmlnZ2VyKDB4YmEpIC8vIHRlbGVwb3J0XG4gICAgLy8gVE9ETyAtIHNlZSBpZiBpdCdzIGNoYW5nZWQ/XG4gICAgcm9tLm1lc3NhZ2VzLnBhcnRzWzB4MWNdWzB4MGZdLnRleHQgPVxuICAgICAgICAnezpIRVJPOn0sIHlvdSBjYW5ub3QgY2xpbWIgdGhpcyB5ZXQhIFNlZWsgb3V0IFs0NDpUZWxlcG9ydF0gYXQgb25jZSEnO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGZ1bmN0aW9uIHVubWFnaWMobWlkOiBzdHJpbmcpIHtcbiAgICByZXBsYWNlTWVzc2FnZShtaWQsIC90ZWFjaFxccyt5b3VcXHMrdGhlXFxzK21hZ2ljXFxzK29mLywgJ2Jlc3RvdyB1cG9uIHlvdSB0aGUnKTtcbiAgfVxuICBmdW5jdGlvbiBpdGVtKGl0ZW06IG51bWJlcnxGbGFnfEl0ZW0pOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGl0ZW0gPSByb20uaXRlbXNbcm9tLml0ZW1HZXRzW2l0ZW0gJiAweGZmXS5pdGVtSWRdO1xuICAgIH0gZWxzZSBpZiAoIShpdGVtIGluc3RhbmNlb2YgSXRlbSkpIGl0ZW0gPSBpdGVtLml0ZW0gYXMgSXRlbTtcbiAgICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuICB9XG4gIGZ1bmN0aW9uIHJlcGxhY2VNZXNzYWdlKG1pZDogc3RyaW5nLCBwYXQ6IHN0cmluZyB8IFJlZ0V4cCwgcmVwbDogc3RyaW5nKSB7XG4gICAgY29uc3QgW3BhcnQsIGluZGV4XSA9IG1pZC5zcGxpdCgnOicpLm1hcCh4ID0+IHBhcnNlSW50KHgsIDE2KSk7XG4gICAgY29uc3QgbXNnID0gcm9tLm1lc3NhZ2VzLnBhcnRzW3BhcnRdW2luZGV4XTtcbiAgICBtc2cudGV4dCA9IG1zZy50ZXh0LnJlcGxhY2UocGF0LCByZXBsKTtcbiAgfVxuICBmdW5jdGlvbiBmaW5kTG9vdCguLi5sb2NzOiBudW1iZXJbXSk6IEl0ZW18dW5kZWZpbmVkIHtcbiAgICBjb25zdCBjb25kaXRpb25zID0gW1xuICAgICAgKGl0ZW06IG51bWJlcikgPT4gQk9XUy5oYXMoaXRlbSksXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBTV09SRF9PUl9NQUdJQy5oYXMoaXRlbSksXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBpdGVtZ2V0KGl0ZW0pLnVuaXF1ZSxcbiAgICBdO1xuXG4gICAgZm9yIChjb25zdCBjb25kIG9mIGNvbmRpdGlvbnMpIHtcbiAgICAgIGZvciAoY29uc3QgaWQgb2YgbG9jcykge1xuICAgICAgICBjb25zdCBsb2MgPSByb20ubG9jYXRpb25zW2lkXTtcbiAgICAgICAgZm9yIChjb25zdCBzcGF3biBvZiBsb2Muc3Bhd25zKSB7XG4gICAgICAgICAgaWYgKCFzcGF3bi5pc0NoZXN0KCkpIGNvbnRpbnVlO1xuICAgICAgICAgIGNvbnN0IGl0ZW0gPSByb20uc2xvdHNbc3Bhd24uaWRdO1xuICAgICAgICAgIGlmIChpdGVtIDw9IDB4NDggJiYgY29uZChpdGVtKSkge1xuICAgICAgICAgICAgcmV0dXJuIHJvbS5pdGVtc1tpdGVtXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBmdW5jdGlvbiBpdGVtZ2V0KGlkOiBudW1iZXIpOiBJdGVtIHtcbiAgICBjb25zdCBpdGVtZ2V0ID0gcm9tLml0ZW1HZXRzW2lkXTtcbiAgICByZXR1cm4gcm9tLml0ZW1zW2l0ZW1nZXQuaXRlbUlkXTtcbiAgfVxufVxuXG5jb25zdCBCT1dTID0gbmV3IFNldChbMHgzZSwgMHgzZiwgMHg0MF0pO1xuY29uc3QgU1dPUkRfT1JfTUFHSUMgPSBuZXcgU2V0KFsweDAwLCAweDAxLCAweDAyLCAweDAzLCAweDQxLCAweDQyLCAweDQzLCAweDQ0LCAweDQ1LCAweDQ2LCAweDQ3LCAweDQ4XSk7XG5cbmZ1bmN0aW9uIGZpbmRUb3JuZWxUcmFkZUluKHJvbTogUm9tKTogSXRlbSB7XG4gIC8vIEV4cGVjdGVkIHN0cnVjdHVyZTpcbiAgLy8gICAuLi5cbiAgLy8gICBOT1QgYnJhY2VsZXQgLT4gLi4uXG4gIC8vICAgTk9UIGJhbGwgLT4gLi4uXG4gIC8vICAgLT4gZ2l2ZSBpdGVtXG4gIGNvbnN0IHtUb3JuZWx9ID0gcm9tLm5wY3M7XG4gIGZvciAoY29uc3QgZHMgb2YgVG9ybmVsLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSB+ZHNbaV0uY29uZGl0aW9uO1xuICAgICAgLy8gTG9vayBmb3IgYW55IG5lZ2F0aXZlIGNvbmRpdGlvbiBvbiBhIGJyYWNlbGV0IChkb2Vzbid0IG1hdHRlciB3aGVyZSlcbiAgICAgIGlmIChpdGVtID4gMHgyMDQgJiYgaXRlbSA8PSAweDIwYyAmJiAhKGl0ZW0gJiAxKSkge1xuICAgICAgICByZXR1cm4gcm9tLml0ZW1zW2l0ZW0gJiAweGZmXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJvbS5pdGVtcy5Ub3JuYWRvQnJhY2VsZXQ7IC8vIGRlZmF1bHQgdG8gdG9ybmFkbyBicmFjZWxldFxufVxuXG5mdW5jdGlvbiB2YWd1ZShpdGVtOiBJdGVtKTogc3RyaW5nIHtcbiAgY29uc3QgaXRlbXMgPSBpdGVtLnJvbS5pdGVtcztcbiAgc3dpdGNoIChpdGVtKSB7XG4gICAgY2FzZSBpdGVtcy5TdGF0dWVPZk9ueXg6IHJldHVybiAnYW4gdW51c3VhbCBzdGF0dWUnO1xuICAgIGNhc2UgaXRlbXMuRmx1dGVPZkxpbWU6ICByZXR1cm4gJ2EgcmFyZSBpbnN0cnVtZW50JztcbiAgICBjYXNlIGl0ZW1zLkZvZ0xhbXA6ICAgICAgcmV0dXJuICdhIGJyaWxsaWFudCBsYW1wJztcbiAgICBjYXNlIGl0ZW1zLkxvdmVQZW5kYW50OiAgcmV0dXJuICdhIGJlYXV0aWZ1bCBjaGFybSc7XG4gICAgY2FzZSBpdGVtcy5LaXJpc2FQbGFudDogIHJldHVybiAnYSBmcmFncmFudCBwbGFudCc7XG4gICAgY2FzZSBpdGVtcy5Jdm9yeVN0YXR1ZTogIHJldHVybiAnYW4gZXhvdGljIHN0YXR1ZSc7XG4gICAgLy8gVE9ETyAtIHN0YXR1ZSBvZiBnb2xkXG4gIH1cbiAgZmFpbCgpO1xuICByZXR1cm4gJ2EgdmFsdWFibGUgaXRlbSc7XG59XG5cbmZ1bmN0aW9uIGNvbW1vbk5vdW4oaXRlbTogSXRlbSk6IHN0cmluZyB7XG4gIGNvbnN0IGl0ZW1zID0gaXRlbS5yb20uaXRlbXM7XG4gIHN3aXRjaCAoaXRlbSkge1xuICAgIGNhc2UgaXRlbXMuU3RhdHVlT2ZPbnl4OiByZXR1cm4gJ3N0YXR1ZSc7XG4gICAgY2FzZSBpdGVtcy5GbHV0ZU9mTGltZTogIHJldHVybiAnaW5zdHJ1bWVudCc7XG4gICAgY2FzZSBpdGVtcy5Gb2dMYW1wOiAgICAgIHJldHVybiAnbGFtcCc7XG4gICAgY2FzZSBpdGVtcy5Mb3ZlUGVuZGFudDogIHJldHVybiAncGVuZGFudCc7XG4gICAgY2FzZSBpdGVtcy5LaXJpc2FQbGFudDogIHJldHVybiAncGxhbnQnO1xuICAgIGNhc2UgaXRlbXMuSXZvcnlTdGF0dWU6ICByZXR1cm4gJ3N0YXR1ZSc7XG4gIH1cbiAgZmFpbCgpO1xuICByZXR1cm4gJ2l0ZW0nO1xufVxuXG4vLyBmdW5jdGlvbiByZXBsYWNlRGlhbG9nKG5wYzogTnBjLCBvcmlnOiBudW1iZXIgfCBSZWdFeHAsIHJlcGxhY2VtZW50SWQ6IG51bWJlcikge1xuLy8gICBjb25zdCByb20gPSBucGMucm9tO1xuLy8gICBjb25zdCBwYXQgPSBvcmlnIGluc3RhbmNlb2YgUmVnRXhwID8gb3JpZyA6IHBhdHRlcm4ocm9tLml0ZW1zW29yaWddKTtcbi8vICAgY29uc3QgcmVwbCA9IHJlcGxhY2VtZW50KHJvbS5pdGVtc1tyZXBsYWNlbWVudElkXSk7XG4vLyAgIGZvciAoY29uc3QgZHMgb2YgbnBjLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuLy8gICAgIGZvciAoY29uc3QgZCBvZiBkcykge1xuLy8gICAgICAgY29uc3QgbWlkID0gZC5tZXNzYWdlO1xuLy8gICAgICAgcmVwbGFjZU1lc3NhZ2Uocm9tLCBtaWQucGFydCwgbWlkLmluZGV4LCBwYXQsIHJlcGwpO1xuLy8gICAgIH1cbi8vICAgfVxuLy8gfVxuXG4vLyBjb25zdCBwYXR0ZXJuOiB7KGlkOiBudW1iZXIsIG5hbWU6IHN0cmluZyk6IFJlZ0V4cDtcbi8vICAgICAgICAgICAgICAgICAoaXRlbTogSXRlbSk6IFJlZ0V4cH0gPVxuLy8gICAgIChpdGVtOiBudW1iZXIgfCBJdGVtLCBuYW1lPzogc3RyaW5nKSA9PiB7XG4vLyAgICAgICBuYW1lID0gbmFtZSB8fCAoaXRlbSBhcyBJdGVtKS5tZXNzYWdlTmFtZTtcbi8vICAgICAgIGNvbnN0IGlkID0gaGV4KGl0ZW0gaW5zdGFuY2VvZiBJdGVtID8gaXRlbS5pZCA6IGl0ZW0pO1xuLy8gICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoYFxcXFxbJHtpZH06W15cXFxcXV0qXFxcXF18JHtuYW1lLnJlcGxhY2UoL1xccysvZywgJ1xcXFxzKycpfWAsXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAnZycpO1xuLy8gICAgIH07XG5cbi8vIGZ1bmN0aW9uIHJlcGxhY2VtZW50KGl0ZW06IEl0ZW0pOiBzdHJpbmcge1xuLy8gICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuLy8gfVxuIl19