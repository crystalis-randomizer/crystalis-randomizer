function flipSaberaEntrance(exit) {
    console.log(`flip sabera entrance`);
    const loc = exit[0];
    loc.set2d(0x71, [[loc.rom.metascreens.deadEndE_upStair],
        [loc.rom.metascreens.caveEmpty]]);
    loc.moveExits([0x81, 'stair:down', 0x71, 'stair:up']);
    exit[1] = 0x71;
    exit[2] = 'stair:up';
}
function flipKarmineEntrance(exit) {
    console.log(`flip karmine entrance`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    loc.invalidateMonsters();
    loc.set2d(0x20, [[ms.caveEmpty, ms.hallNS],
        [ms.deadEndE_upStair, ms.hallNW]]);
    loc.moveExits([0x30, 'stair:down', 0x30, 'stair:up']);
    exit[2] = 'stair:up';
}
function flipKarmineExit(exit) {
    console.log(`flip karmine exit`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    loc.set2d(0x01, [[ms.deadEndS_stairs, ms.caveEmpty]]);
    loc.moveExits([0x02, 'stair:down', 0x01, 'stair:up']);
    exit[1] = 0x01;
    exit[2] = 'stair:up';
}
function flipExit(exit) {
    console.log(`flip generic exit`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    if (loc.width < 2)
        loc.width = 2;
    loc.set2d(0x00, [[ms.hallSE, ms.deadEndW_downStair]]);
    loc.moveExits([0x00, 'stair:up', 0x01, 'stair:down']);
    exit[1] = 0x01;
    exit[2] = 'stair:down';
}
function flip(e) {
    e[3](e);
    e[3] = undefined;
}
export function shuffleGoa(rom, random) {
    const $ = rom.locations;
    const floors = [0, 1, 2, 3];
    random.shuffle(floors);
    const entrances = [
        [$.GoaFortress_Kelbesque.meta, 0x83, 'stair:down'],
        [$.GoaFortress_Sabera.meta, 0x81, 'stair:down', flipSaberaEntrance],
        [$.GoaFortress_Mado1.meta, 0x72, 'stair:down'],
        [$.GoaFortress_Karmine1.meta, 0x30, 'stair:down', flipKarmineEntrance],
    ];
    const exits = [
        [$.GoaFortress_Zebu.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Tornel.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Asina.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Kensu.meta, 0x02, 'stair:down', flipKarmineExit],
    ];
    const a = [[$.GoaFortress_Entrance.meta, 0x00, 'edge:top']];
    const b = [];
    let up = true;
    let lastA = a[0];
    for (const f of floors) {
        const flexible = up || entrances[f][3] || a[a.length - 1][3];
        const reverse = flexible ? random.pick([false, true]) : true;
        console.log(`FLOOR ${f}: up ${up} flexible ${!!flexible} reverse ${reverse}`);
        const lastB = reverse ? exits[f] : entrances[f];
        console.log(`push b ${rom.locations[lastB[0].id].name}`);
        b.push(lastB);
        if (up !== (lastB[2] === 'stair:down')) {
            if (lastB[3]) {
                flip(lastB);
            }
            else {
                flip(lastA);
            }
        }
        a.push(lastA = reverse ? entrances[f] : exits[f]);
        console.log(`push a ${rom.locations[lastA[0].id].name}`);
        up = lastA[2] === 'stair:up';
    }
    if (up)
        flip(lastA);
    b.push([$.GoaFortress_Exit.meta, 0x01, 'stair:up']);
    for (let i = 0; i < a.length; i++) {
        a[i][0].attach(a[i][1], b[i][0], b[i][1], a[i][2], b[i][2]);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWdvYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVnb2EudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBYUEsU0FBUyxrQkFBa0IsQ0FBQyxJQUFVO0lBQ3BDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNwQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDO1FBQ3RDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDZixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVU7SUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztJQUMvQixHQUFHLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUN6QixHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDO1FBQ3pCLENBQUMsRUFBRSxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxNQUFN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Q0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUM3RDtBQTRFSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU2h1ZmZsZSBmbG9vcnMgb2YgR29hIGZvcnRyZXNzIGFtb25nc3QgZWFjaCBvdGhlci5cbi8vIE9uZSBrZXkgZGlmZmljdWx0eSBpcyB0aGUgZGlyZWN0aW9uIG9mIHRoZSBkb29ycy5cbi8vIFRoZSBkb29yIGF0IHRoZSB0b3Agb2Yga2FybWluZSBwb2ludHMgZG93biwgd2hlcmVhcyBhbGwgb3RoZXJzIGFyZSB1cC5cbi8vIFdlIG5lZWQgYSB3YXkgdG8gY2hhbmdlIHRoZSBkaXJlY3Rpb24gb2YgZWFjaC5cblxuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TWV0YWxvY2F0aW9uLCBQb3N9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHtDb25uZWN0aW9uVHlwZX0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW5kYXRhLmpzJztcblxudHlwZSBFeGl0ID0gW01ldGFsb2NhdGlvbiwgUG9zLCBDb25uZWN0aW9uVHlwZV07XG50eXBlIEV4aXQyID0gW01ldGFsb2NhdGlvbiwgUG9zLCBDb25uZWN0aW9uVHlwZSwgKChlOiBFeGl0KSA9PiB2b2lkKT9dO1xuXG5mdW5jdGlvbiBmbGlwU2FiZXJhRW50cmFuY2UoZXhpdDogRXhpdCkge1xuICBjb25zb2xlLmxvZyhgZmxpcCBzYWJlcmEgZW50cmFuY2VgKTtcbiAgY29uc3QgbG9jID0gZXhpdFswXTtcbiAgbG9jLnNldDJkKDB4NzEsIFtbbG9jLnJvbS5tZXRhc2NyZWVucy5kZWFkRW5kRV91cFN0YWlyXSxcbiAgICAgICAgICAgICAgICAgICBbbG9jLnJvbS5tZXRhc2NyZWVucy5jYXZlRW1wdHldXSk7XG4gIGxvYy5tb3ZlRXhpdHMoWzB4ODEsICdzdGFpcjpkb3duJywgMHg3MSwgJ3N0YWlyOnVwJ10pO1xuICBleGl0WzFdID0gMHg3MTtcbiAgZXhpdFsyXSA9ICdzdGFpcjp1cCc7XG59XG5cbmZ1bmN0aW9uIGZsaXBLYXJtaW5lRW50cmFuY2UoZXhpdDogRXhpdCkge1xuICBjb25zb2xlLmxvZyhgZmxpcCBrYXJtaW5lIGVudHJhbmNlYCk7XG4gIGNvbnN0IGxvYyA9IGV4aXRbMF07XG4gIGNvbnN0IG1zID0gbG9jLnJvbS5tZXRhc2NyZWVucztcbiAgbG9jLmludmFsaWRhdGVNb25zdGVycygpO1xuICBsb2Muc2V0MmQoMHgyMCwgW1ttcy5jYXZlRW1wdHksIG1zLmhhbGxOU10sXG4gICAgICAgICAgICAgICAgICAgW21zLmRlYWRFbmRFX3VwU3RhaXIsIG1zLmhhbGxOV11dKTtcbiAgbG9jLm1vdmVFeGl0cyhbMHgzMCwgJ3N0YWlyOmRvd24nLCAweDMwLCAnc3RhaXI6dXAnXSk7XG4gIGV4aXRbMl0gPSAnc3RhaXI6dXAnO1xufVxuXG5mdW5jdGlvbiBmbGlwS2FybWluZUV4aXQoZXhpdDogRXhpdCkge1xuICBjb25zb2xlLmxvZyhgZmxpcCBrYXJtaW5lIGV4aXRgKTtcbiAgY29uc3QgbG9jID0gZXhpdFswXTtcbiAgY29uc3QgbXMgPSBsb2Mucm9tLm1ldGFzY3JlZW5zO1xuICBsb2Muc2V0MmQoMHgwMSwgW1ttcy5kZWFkRW5kU19zdGFpcnMsIG1zLmNhdmVFbXB0eV1dKTtcbiAgbG9jLm1vdmVFeGl0cyhbMHgwMiwgJ3N0YWlyOmRvd24nLCAweDAxLCAnc3RhaXI6dXAnXSk7XG4gIGV4aXRbMV0gPSAweDAxO1xuICBleGl0WzJdID0gJ3N0YWlyOnVwJztcbn1cblxuZnVuY3Rpb24gZmxpcEV4aXQoZXhpdDogRXhpdCkge1xuICBjb25zb2xlLmxvZyhgZmxpcCBnZW5lcmljIGV4aXRgKTtcbiAgY29uc3QgbG9jID0gZXhpdFswXTtcbiAgY29uc3QgbXMgPSBsb2Mucm9tLm1ldGFzY3JlZW5zO1xuICBpZiAobG9jLndpZHRoIDwgMikgbG9jLndpZHRoID0gMjsgLy8gc2hvdWxkIGFscmVkeSBiZSBmaWxsZWQgdy8gZW1wdHlcbiAgbG9jLnNldDJkKDB4MDAsIFtbbXMuaGFsbFNFLCBtcy5kZWFkRW5kV19kb3duU3RhaXJdXSk7XG4gIGxvYy5tb3ZlRXhpdHMoWzB4MDAsICdzdGFpcjp1cCcsIDB4MDEsICdzdGFpcjpkb3duJ10pO1xuICBleGl0WzFdID0gMHgwMTtcbiAgZXhpdFsyXSA9ICdzdGFpcjpkb3duJztcbn1cblxuZnVuY3Rpb24gZmxpcChlOiBFeGl0Mikge1xuICBlWzNdIShlIGFzIEV4aXQpO1xuICBlWzNdID0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZUdvYShyb206IFJvbSwgcmFuZG9tOiBSYW5kb20pIHtcbiAgY29uc3QgJCA9IHJvbS5sb2NhdGlvbnM7XG4gIGNvbnN0IGZsb29ycyA9IFswLCAxLCAyLCAzXTtcbiAgcmFuZG9tLnNodWZmbGUoZmxvb3JzKTtcblxuICBjb25zdCBlbnRyYW5jZXM6IEV4aXQyW10gPSBbXG4gICAgWyQuR29hRm9ydHJlc3NfS2VsYmVzcXVlLm1ldGEhLCAweDgzLCAnc3RhaXI6ZG93biddLFxuICAgIFskLkdvYUZvcnRyZXNzX1NhYmVyYS5tZXRhISwgMHg4MSwgJ3N0YWlyOmRvd24nLCBmbGlwU2FiZXJhRW50cmFuY2VdLFxuICAgIFskLkdvYUZvcnRyZXNzX01hZG8xLm1ldGEhLCAweDcyLCAnc3RhaXI6ZG93biddLFxuICAgIFskLkdvYUZvcnRyZXNzX0thcm1pbmUxLm1ldGEhLCAweDMwLCAnc3RhaXI6ZG93bicsIGZsaXBLYXJtaW5lRW50cmFuY2VdLFxuICBdO1xuICBjb25zdCBleGl0czogRXhpdDJbXSA9IFtcbiAgICBbJC5Hb2FGb3J0cmVzc19aZWJ1Lm1ldGEhLCAweDAwLCAnc3RhaXI6dXAnLCBmbGlwRXhpdF0sXG4gICAgWyQuR29hRm9ydHJlc3NfVG9ybmVsLm1ldGEhLCAweDAwLCAnc3RhaXI6dXAnLCBmbGlwRXhpdF0sXG4gICAgWyQuR29hRm9ydHJlc3NfQXNpbmEubWV0YSEsIDB4MDAsICdzdGFpcjp1cCcsIGZsaXBFeGl0XSxcbiAgICBbJC5Hb2FGb3J0cmVzc19LZW5zdS5tZXRhISwgMHgwMiwgJ3N0YWlyOmRvd24nLCBmbGlwS2FybWluZUV4aXRdLFxuICBdO1xuXG4gIC8vIFBsYW46IHBpZWNlIGl0IHRvZ2V0aGVyLi4uXG4gIC8vICAtIHByb2JhYmx5IGp1c3QgcmVhcnJhbmdlIHRoZSBhcnJheXMsIHRoZW4gZG8gYWxsIHRoZSBtdXRhdGlvbnMgbGF0ZXI/Pz8/XG4gIGNvbnN0IGE6IEV4aXQyW10gPSBbWyQuR29hRm9ydHJlc3NfRW50cmFuY2UubWV0YSEsIDB4MDAsICdlZGdlOnRvcCddXTtcbiAgY29uc3QgYjogRXhpdDJbXSA9IFtdO1xuICBsZXQgdXAgPSB0cnVlO1xuICBsZXQgbGFzdEE6IEV4aXQyID0gYVswXTtcblxuICBmb3IgKGNvbnN0IGYgb2YgZmxvb3JzKSB7XG4gICAgY29uc3QgZmxleGlibGUgPSB1cCB8fCBlbnRyYW5jZXNbZl1bM10gfHwgYVthLmxlbmd0aCAtIDFdWzNdO1xuICAgIGNvbnN0IHJldmVyc2UgPSBmbGV4aWJsZSA/IHJhbmRvbS5waWNrKFtmYWxzZSwgdHJ1ZV0pIDogdHJ1ZTtcbiAgICBjb25zb2xlLmxvZyhgRkxPT1IgJHtmfTogdXAgJHt1cH0gZmxleGlibGUgJHshIWZsZXhpYmxlfSByZXZlcnNlICR7cmV2ZXJzZX1gKTtcbiAgICBjb25zdCBsYXN0QjogRXhpdDIgPSByZXZlcnNlID8gZXhpdHNbZl0gOiBlbnRyYW5jZXNbZl07XG4gICAgY29uc29sZS5sb2coYHB1c2ggYiAke3JvbS5sb2NhdGlvbnNbbGFzdEJbMF0uaWRdLm5hbWV9YCk7XG4gICAgYi5wdXNoKGxhc3RCKTtcbiAgICBpZiAodXAgIT09IChsYXN0QlsyXSA9PT0gJ3N0YWlyOmRvd24nKSkge1xuICAgICAgaWYgKGxhc3RCWzNdKSB7XG4gICAgICAgIGZsaXAobGFzdEIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmxpcChsYXN0QSk7XG4gICAgICB9XG4gICAgfVxuICAgIGEucHVzaChsYXN0QSA9IHJldmVyc2UgPyBlbnRyYW5jZXNbZl0gOiBleGl0c1tmXSk7XG4gICAgY29uc29sZS5sb2coYHB1c2ggYSAke3JvbS5sb2NhdGlvbnNbbGFzdEFbMF0uaWRdLm5hbWV9YCk7XG4gICAgdXAgPSBsYXN0QVsyXSA9PT0gJ3N0YWlyOnVwJztcbiAgfVxuICBpZiAodXApIGZsaXAobGFzdEEpOyAvLyBOT1RFOiBhbGwgZW50cmFuY2VzIGNhbiBiZSBkb3duLCBvbmx5IHNvbWUgY2FuIGJlIHVwXG4gIGIucHVzaChbJC5Hb2FGb3J0cmVzc19FeGl0Lm1ldGEhLCAweDAxLCAnc3RhaXI6dXAnXSk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gVE9ETyAtIHNpbXBsaWZ5IHRvIHJlbW92ZSBzcGVjaWZpYyB0eXBlXG4gICAgYVtpXVswXS5hdHRhY2goYVtpXVsxXSwgYltpXVswXSwgYltpXVsxXSwgYVtpXVsyXSwgYltpXVsyXSk7XG4gIH1cblxuICAvLyBsZXQgbGFzdCA9IFtleGl0c1swXVswXSwgZXhpdHNbMF1bMV0sICdzdGFpcjp1cCddO1xuICAvLyBmb3IgKGxldCBpID0gMTsgaSA8PSA0OyBpKyspIHtcbiAgLy8gICBjb25zdCBmbG9vciA9IGZsb29yc1tpXTtcbiAgLy8gICAvLyBFYWNoIGZsb29yIG1heSBiZSByZXZlcnNlZC4gIEV4Y2VwdGlvbjogaWYgd2UncmUgY29taW5nIHRocm91Z2ggYSBkb3duXG4gIC8vICAgLy8gc3RhaXIgaW50byBrZWxieSBvciBtYWRvJ3MgYXJlYSB0aGVuIHdlIE1VU1QgYmUgcmV2ZXJzZWQgc2luY2UgdGhlc2VcbiAgLy8gICAvLyBtYXBzIGFyZSBub3QgY29tcGF0aWJsZSB3aXRoIGFuIHVwIHN0YWlyIGF0IHRoZSBzdGFydC5cbiAgLy8gICBjb25zdCByZXZlcnNlID1cbiAgLy8gICAgICAgbGFzdCA9PT0gJ3N0YWlyOnVwJyB8fCAoZmxvb3IgJiAxKSA/IHJhbmRvbS5waWNrKFtmYWxzZSwgdHJ1ZV0pIDogdHJ1ZTtcbiAgLy8gICBjb25zdCBlbnRyYW5jZSA9IChyZXZlcnNlID8gZXhpdHMgOiBlbnRyYW5jZXMpW2Zsb29yXTtcbiAgLy8gICBjb25zdCBleGl0ID0gKHJldmVyc2UgPyBlbnRyYW5jZXMgOiBleGl0cylbZmxvb3JdO1xuICAvLyAgIGlmIChlbnRyYW5jZVsyXSA9PT0gbGFzdCkge1xuICAvLyAgICAgZmxpcChlbnRyYW5jZSk7XG4gIC8vICAgfVxuICAvLyAgIGlmIChpID09PSA0KSB7IC8vIGV4aXQgbXVzdCBiZSBkb3duXG4gIC8vICAgICBpZiAoZXhpdFsyXSAhPT0gJ3N0YWlyOmRvd24nKSBmbGlwKGV4aXQpO1xuICAvLyAgIH0gZWxzZSB7IC8vIGV4aXQgc2hvdWxkIGJlIHVwIGlmIHBvc3NpYmxlLCBidXQgbm90IHJlcXVpcmVkLlxuICAvLyAgICAgaWYgKGV4aXRbMl0gIT09ICdzdGFpcjp1cCcgJiZcbiAgLy8gICAgICAgICBleGl0WzBdICE9PSAkLkdvYUZvcnRyZXNzX0tlbGJlc3F1ZS5tZXRhICYmXG4gIC8vICAgICAgICAgZXhpdFswXSAhPT0gJC5Hb2FGb3J0cmVzc19NYWRvMS5tZXRhKSB7XG4gIC8vICAgICAgIGZsaXAoZXhpdCk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIGNvbnN0IHByZXYgPSBleGl0c1tmbG9vcnNbaSAtIDFdXTtcbiAgLy8gICBwcmV2WzBdLmF0dGFjaChwcmV2WzFdLCBwcmV2WzJdKVxuICAvLyAgIGxhc3QgPSBleGl0WzJdO1xuICAvLyB9XG5cblxuICAvLyAvLyBVcGRhdGUgdGhlIGV4aXQgcG9zaXRpb24gb2YgS2Vuc3UgYW5kIGV4aXRzW2Zsb290c1s0XV0gaWYgbm90IHNhbWVcbiAgLy8gY29uc3QgbGFzdCA9IGZsb29yc1szXTtcbiAgLy8gaWYgKGxhc3QgIT09IDQpIHtcbiAgLy8gICBmbGlwS2FybWluZUV4aXQoKTtcbiAgLy8gICBmbGlwTm9uS2FybWluZUV4aXQobGFzdCk7XG4gIC8vIH1cblxuICAvLyAvLyBOb3cgZ28gdGhyb3VnaCBlYWNoIGFuZCBkbyB0aGUgbGlua3MuXG4gIC8vIC8vIGV4aXRzWzBdIDogZW50cmFuY2VzW2Zsb29yc1swXV1cbiAgLy8gLy8gZXhpdHNbZmxvb3JzWzBdXSA6IGVudHJhbmNlc1tmbG9vcnNbMV1dXG4gIC8vIC8vIC4uLlxuICAvLyAvLyBleGl0c1tmbG9vcnNbM11dIDogZW50cmFuY2VzWzBdXG5cbiAgLy8gZnVuY3Rpb24gY29ubmVjdChmcm9tOiBMb2NhdGlvbiwgZXhpdDogbnVtYmVyLFxuICAvLyAgICAgICAgICAgICAgICAgIHRvOiBMb2NhdGlvbiwgZW50cmFuY2U6IG51bWJlcikge1xuICAvLyAgIC8vIGZpbmQgYWxsIGV4aXRzIGluICdmcm9tJyB0aGF0IG1hcCB0byB0aGUgc2FtZSBlbnRyYW5jZVxuICAvLyAgIGNvbnN0IHdhbnQgPSBmcm9tLmV4aXRzW2V4aXRdO1xuICAvLyAgIGNvbnN0IGZvdW5kID0gW107XG4gIC8vICAgZm9yIChjb25zdCBlIG9mIGZyb20uZXhpdHMpIHtcbiAgLy8gICAgIGlmIChlLmRlc3QgPT09IHdhbnQuZGVzdCAmJiBlLmVudHJhbmNlID09PSB3YW50LmVudHJhbmNlKSBmb3VuZC5wdXNoKGUpO1xuICAvLyAgIH1cbiAgLy8gICBmb3IgKGNvbnN0IGUgb2YgZm91bmQpIHtcbiAgLy8gICAgIGUuZGVzdCA9IHRvLmlkO1xuICAvLyAgICAgZS5lbnRyYW5jZSA9IGVudHJhbmNlO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8vIGZvciAobGV0IGkgPSAwOyBpIDw9IDQ7IGkrKykge1xuICAvLyAgIGNvbnN0IGxvd2VyID0gaSA9PT0gMCA/IDAgOiBmbG9vcnNbaSAtIDFdO1xuICAvLyAgIGNvbnN0IHVwcGVyID0gaSA9PT0gNCA/IDAgOiBmbG9vcnNbaV07XG4gIC8vICAgY29uc3QgW2xvd2VyTG9jLCBsb3dlckluLCBsb3dlck91dF0gPSBleGl0c1tsb3dlcl07XG4gIC8vICAgY29uc3QgW3VwcGVyTG9jLCB1cHBlckluLCB1cHBlck91dF0gPSBlbnRyYW5jZXNbdXBwZXJdO1xuICAvLyAgIGNvbm5lY3QodXBwZXJMb2MsIHVwcGVyT3V0LCBsb3dlckxvYywgbG93ZXJJbik7XG4gIC8vICAgY29ubmVjdChsb3dlckxvYywgbG93ZXJPdXQsIHVwcGVyTG9jLCB1cHBlckluKTtcbiAgLy8gfVxuXG4gIC8vIC8vIEZpeCB0aGUgcGFsZXR0ZXMgYW5kIG11c2ljLlxuICAvLyBmb3IgKGNvbnN0IFtsXSBvZiBleGl0cykge1xuICAvLyAgIGlmICh0eXBlb2YgbC5kYXRhLm11c2ljID09PSAnbnVtYmVyJykge1xuICAvLyAgICAgbC5iZ20gPSBsLm5laWdoYm9yRm9yRW50cmFuY2UobC5kYXRhLm11c2ljIGFzIG51bWJlcikuYmdtO1xuICAvLyAgIH1cbiAgLy8gICBpZiAodHlwZW9mIGwuZGF0YS5wYWxldHRlID09PSAnbnVtYmVyJykge1xuICAvLyAgICAgY29uc3QgbiA9IGwubmVpZ2hib3JGb3JFbnRyYW5jZShsLmRhdGEucGFsZXR0ZSBhcyBudW1iZXIpLnRpbGVQYWxldHRlcztcbiAgLy8gICAgIGwudGlsZVBhbGV0dGVzID0gW25bMF0sIG5bMV0sIG5bMl1dO1xuICAvLyAgIH1cbiAgLy8gfVxufVxuIl19