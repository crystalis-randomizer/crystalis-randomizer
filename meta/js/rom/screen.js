import { Entity } from './entity.js';
import { tuple } from './util.js';
export class Screen extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.used = true;
        const base = (id > 0xff ? 0x40 + id : id) << 8;
        this.tiles = tuple(rom.prg, base, 0xf0);
    }
    clone(newId) {
        const clone = new Screen(this.rom, newId);
        clone.used = this.used;
        clone.tiles = [...this.tiles];
        return clone;
    }
    allTilesSet() {
        return new Set(this.tiles);
    }
    set2d(start, data) {
        const x0 = start & 0xf;
        const y0 = start >>> 4;
        for (let y = 0; y < data.length; y++) {
            const row = data[y];
            for (let x = 0; x < row.length; x++) {
                const tile = row[x];
                if (tile != null)
                    this.tiles[(y0 + y) << 4 | (x0 + x)] = tile;
            }
        }
    }
    assemble(a) {
        const id = this.id.toString(16).padStart(2, '0');
        let tiles = this.tiles;
        if (this.rom.compressedMapData || this.id < 0x100) {
            const seg = (this.id >> 5).toString(16).padStart(2, '0');
            a.segment(seg);
            if (seg === '0a')
                tiles = tiles.slice(0xc0);
        }
        else {
            a.segment('0a');
            tiles = tiles.slice(0, 0xc0);
        }
        a.org(0x8000 | (this.id & 0x3f) << 8, `Screen_${id}`);
        a.byte(...tiles);
    }
}
export class Screens extends Array {
    constructor(rom) {
        super(0x103);
        this.rom = rom;
        this.unallocated = [];
        for (let i = 0; i < 0x103; i++) {
            this[i] = new Screen(rom, i);
        }
    }
    getScreen(id) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        return arr[i] || (arr[i] = new Screen(this.rom, id));
    }
    setScreen(id, screen) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        arr[i] = screen;
    }
    deleteScreen(id) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        delete arr[i];
    }
    write() {
        const a = this.rom.assembler();
        for (const screen of this) {
            if (screen === null || screen === void 0 ? void 0 : screen.used)
                screen.assemble(a);
        }
        return [a.module()];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyZWVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS9zY3JlZW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBRWhDLE1BQU0sT0FBTyxNQUFPLFNBQVEsTUFBTTtJQWdCaEMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUM5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFL0MsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFhO1FBRWpCLE1BQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU5QixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFVRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUdELEtBQUssQ0FBQyxLQUFhLEVBQUUsSUFBaUQ7UUFDcEUsTUFBTSxFQUFFLEdBQUcsS0FBSyxHQUFHLEdBQUcs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LEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxTQUFTLENBQUMsRUFBVSxFQUFFLE1BQWM7UUFDbEMsTUFBTSxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDNUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsWUFBWSxDQUFDLEVBQVU7UUFDckIsTUFBTSxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDNUIsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEIsQ0FBQztJQUVELEtBQUs7UUFDSCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQy9CLEtBQUssTUFBTSxNQUFNLElBQUksSUFBSSxFQUFFO1lBQ3pCLElBQUksTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLElBQUk7Z0JBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0QztRQUNELE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN0QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Fzc2VtYmxlcn0gZnJvbSAnLi4vYXNtL2Fzc2VtYmxlci5qcyc7XG5pbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge3R1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuXG5leHBvcnQgY2xhc3MgU2NyZWVuIGV4dGVuZHMgRW50aXR5IHtcblxuICAvLyBXaGF0IGRvIHdlIG5lZWQgdG8gdHJhY2s/XG4gIC8vICAtIHZhbmlsbGEgSUQgKDAuLiQxMDIpXG4gIC8vICAtIHJlbG9jYXRlZCBJRCAoMC4uJDIwMWYpXG4gIC8vICAtIHRpbGVzZXRzIGl0J3MgYSBwYXJ0IG9mXG4gIC8vICAgIC0gZmxhZyBpbmZvIChzZXBhcmF0ZSBmcm9tIGJyaWRnZS93YWxsKT9cbiAgLy8gICAgLSBicmlkZ2Uvd2FsbC9kb29yIGluZm9cbiAgLy8gICAgLSBzdGFpcnNcbiAgLy8gICAgLSBlZGdlIGFuZCBwYXRoIGluZm9cbiAgLy8gICAgLSByZXF1aXJlZC9hbGxvd2VkIG5laWdoYm9ycz9cbiAgLy8gICAgLSB1cGdyYWRlIHBhdGhzP1xuICAvLyBiYXNlOiBudW1iZXI7XG4gIHRpbGVzOiBudW1iZXJbXTsgLy8gYWx3YXlzIDE1eDE2XG4gIHVzZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcbiAgICB0aGlzLnVzZWQgPSB0cnVlOyAvLyBUT0RPIC0gdHJhY2sgdW51c2VkIHRpbGVzP1xuICAgIGNvbnN0IGJhc2UgPSAoaWQgPiAweGZmID8gMHg0MCArIGlkIDogaWQpIDw8IDg7XG4gICAgLy8gbWV0YXRpbGUgaW5kZXhcbiAgICB0aGlzLnRpbGVzID0gdHVwbGUocm9tLnByZywgYmFzZSwgMHhmMCk7XG4gIH1cblxuICBjbG9uZShuZXdJZDogbnVtYmVyKTogU2NyZWVuIHtcbiAgICAvLyBUT0RPIC0gdXBkYXRlIHRoZSBzZXQgb2Ygc2NyZWVucywgdG9vP1xuICAgIGNvbnN0IGNsb25lID0gbmV3IFNjcmVlbih0aGlzLnJvbSwgbmV3SWQpO1xuICAgIGNsb25lLnVzZWQgPSB0aGlzLnVzZWQ7XG4gICAgY2xvbmUudGlsZXMgPSBbLi4udGhpcy50aWxlc107XG4gICAgLy8gY2xvbmUuYmFzZSA9IHRoaXMuYmFzZTtcbiAgICByZXR1cm4gY2xvbmU7XG4gIH1cblxuICAvLyB0aWxlKHk6IG51bWJlciwgeDogbnVtYmVyKTogbnVtYmVyIHtcbiAgLy8gICByZXR1cm4gdGhpcy50aWxlc1t5IDw8IDQgfCB4XTtcbiAgLy8gfVxuXG4gIC8vIG1ldGF0aWxlKHksIHgpOiBNZXRhdGlsZSB7XG4gIC8vICAgcmV0dXJuIHRoaXMucm9tLm1ldGF0aWxlc1t0aGlzLnRpbGVzW3ldW3hdXTtcbiAgLy8gfVxuXG4gIGFsbFRpbGVzU2V0KCk6IFNldDxudW1iZXI+IHtcbiAgICByZXR1cm4gbmV3IFNldCh0aGlzLnRpbGVzKTtcbiAgfVxuXG4gIC8qKiBXcml0ZSBhIDJkIGJsb2NrIGludG8gdGhlIHRpbGUgYXJyYXkuICovXG4gIHNldDJkKHN0YXJ0OiBudW1iZXIsIGRhdGE6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHlBcnJheTxudW1iZXIgfCBudWxsPj4pIHtcbiAgICBjb25zdCB4MCA9IHN0YXJ0ICYgMHhmO1xuICAgIGNvbnN0IHkwID0gc3RhcnQgPj4+IDQ7XG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCBkYXRhLmxlbmd0aDsgeSsrKSB7XG4gICAgICBjb25zdCByb3cgPSBkYXRhW3ldO1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCByb3cubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgY29uc3QgdGlsZSA9IHJvd1t4XTtcbiAgICAgICAgaWYgKHRpbGUgIT0gbnVsbCkgdGhpcy50aWxlc1soeTAgKyB5KSA8PCA0IHwgKHgwICsgeCldID0gdGlsZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3NlbWJsZShhOiBBc3NlbWJsZXIpIHtcbiAgICBjb25zdCBpZCA9IHRoaXMuaWQudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJyk7XG4gICAgbGV0IHRpbGVzID0gdGhpcy50aWxlcztcbiAgICBpZiAodGhpcy5yb20uY29tcHJlc3NlZE1hcERhdGEgfHwgdGhpcy5pZCA8IDB4MTAwKSB7XG4gICAgICBjb25zdCBzZWcgPSAodGhpcy5pZCA+PiA1KS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKTtcbiAgICAgIGEuc2VnbWVudChzZWcpO1xuICAgICAgaWYgKHNlZyA9PT0gJzBhJykgdGlsZXMgPSB0aWxlcy5zbGljZSgweGMwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYS5zZWdtZW50KCcwYScpO1xuICAgICAgdGlsZXMgPSB0aWxlcy5zbGljZSgwLCAweGMwKTtcbiAgICB9XG4gICAgYS5vcmcoMHg4MDAwIHwgKHRoaXMuaWQgJiAweDNmKSA8PCA4LCBgU2NyZWVuXyR7aWR9YCk7XG4gICAgYS5ieXRlKC4uLnRpbGVzKTtcbiAgfVxuXG4vLyAgIHdyaXRlKHdyaXRlcjogV3JpdGVyKTogdm9pZCB7XG4vLyAgICAgbGV0IGJhc2UgPSB0aGlzLmlkIDw8IDg7XG4vLyAgICAgaWYgKHRoaXMuaWQgPiAweGZmKSB7XG4vLyAgICAgICBpZiAoIXRoaXMucm9tLmNvbXByZXNzZWRNYXBEYXRhKSB7XG4vLyAgICAgICAgIGJhc2UgKz0gMHg0MDAwO1xuLy8gICAgICAgfSBlbHNlIHtcbi8vICAgICAgICAgYmFzZSA9ICh0aGlzLmlkICYgMHhmZjAwKSA8PCA1IHwgKHRoaXMuaWQgJiAweGZmKSA8PCA4O1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgICAvLyB0aGlzLmlkIDw8IDggOiAodGhpcy5pZCA+IDB4ZmYgPyAweDQwICsgdGhpcy5pZCA6IHRoaXMuaWQpIDw8IDg7XG4vLyAgICAgaWYgKChiYXNlICYgMHhmZTAwMCkgIT09IDB4MTQwMDApIHtcbi8vICAgICAgIHdyaXRlci5yb20uc3ViYXJyYXkoYmFzZSwgYmFzZSArIDB4ZjApLnNldCh0aGlzLnRpbGVzKTtcbi8vID4+Pj4+Pj4gYWRkIE5PX0RFUExPWSBmaWxlXG4vLyAgICAgfSBlbHNlIHtcbi8vICAgICAgIGEuc2VnbWVudCgnMGEnKTsgLy8gMTQwMDBcbi8vICAgICAgIGEub3JnKDB4ODAwMCB8ICh0aGlzLmlkICYgMHgzKSA8PCA4KVxuLy8gICAgICAgLy8gd2UgcmV1c2UgdGhlIGxhc3QgMiByb3dzIG9mIGV4dGVuZGVkIHNjcmVlbnMgKGNvdmVyZWQgYnkgSFVEKSBmb3Jcbi8vIDw8PDw8PDwgSEVBRFxuXG5cblxuLy8gICBzZXRUaWxlcyhzdGFydDogbnVtYmVyLCB0aWxlczogQXJyYXk8QXJyYXk8bnVtYmVyfG51bGw+Pikge1xuLy8gICAgIGZvciAoY29uc3Qgcm93IG9mIHRpbGVzKSB7XG4vLyAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvdy5sZW5ndGg7IGkrKykge1xuLy8gICAgICAgICBjb25zdCB0aWxlID0gcm93W2ldO1xuLy8gICAgICAgICBpZiAodGlsZSAhPSBudWxsKSB0aGlzLnRpbGVzW3N0YXJ0ICsgaV0gPSB0aWxlO1xuLy8gICAgICAgfVxuLy8gICAgICAgc3RhcnQgKz0gMTY7XG4vLyB8fHx8fHx8IGNvbnN0cnVjdGVkIG1lcmdlIGJhc2Vcbi8vICAgICAgIC8vIGdsb2JhbCBmbGFncyBpbiB0aGUgcm9tLlxuLy8gICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAweGMwOyBpKyspIHtcbi8vICAgICAgICAgd3JpdGVyLnJvbVt0aGlzLmJhc2UgKyBpXSA9IHRoaXMudGlsZXNbaV07XG4vLyAgICAgICB9XG4vLyA9PT09PT09XG4vLyAgICAgICAvLyBnbG9iYWwgZmxhZ3MgaW4gdGhlIHJvbS4gIC0tIG9ubHkgZm9yIHBhZ2UgMTAuLi4hP1xuXG4vLyAgICAgICAvLyBUT0RPIC0gb25seSBkbyB0aGlzIGZvciBwYWdlIDEwXG5cbi8vICAgICAgIHdyaXRlci5yb20uc3ViYXJyYXkoYmFzZSwgYmFzZSArIDB4YzApLnNldCh0aGlzLnRpbGVzLnNsaWNlKDAsIDB4YzApKTtcbi8vID4+Pj4+Pj4gYWRkIE5PX0RFUExPWSBmaWxlXG4vLyAgICAgfVxuLy8gICB9XG5cbiAgLy8gVE9ETyAtIGFjY2Vzc29ycyBmb3Igd2hpY2ggcGFsZXR0ZXMsIHRpbGVzZXRzLCBhbmQgcGF0dGVybnMgYXJlIHVzZWQvYWxsb3dlZFxufVxuXG4vLyBNZXRhdGlsZSBkb2Vzbid0IG1lYW4gbXVjaCB3aXRob3V0IHRpbGVzZXQsIHBhdHRlcm5zLCBldGMuXG4vLyBtYXkgbmVlZCB0byByZXRoaW5rIHRoaXMgb25lLCBtYWtlIGl0IGEgdHJhbnNpZW50IG9iamVjdCB0aGF0IGRlcHMgb24gb3RoZXJzLlxuLy8gY2xhc3MgTWV0YXRpbGUge1xuLy8gICBjb25zdHJ1Y3Rvcihyb20sIGlkKSB7XG4vLyAgICAgdGhpcy5yb20gPSByb207XG4vLyAgICAgdGhpcy5pZCA9IGlkO1xuLy8gICB9XG4vLyB9XG5cbmV4cG9ydCBjbGFzcyBTY3JlZW5zIGV4dGVuZHMgQXJyYXk8U2NyZWVuPiB7XG4gIHJlYWRvbmx5IHVuYWxsb2NhdGVkOiBBcnJheTxTY3JlZW4+ID0gW107XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgc3VwZXIoMHgxMDMpO1xuICAgIC8vIFRPRE8gLSBpZiBtYXBzIGFscmVhZHkgY29tcGFjdGVkLCByZWFkIHRoYXQgaW5zdGVhZD9cbiAgICAvLyAgLSBuZWVkIGxvY2F0aW9ucyB0byBrbm93IHdoZXJlIHRvIGxvb2shXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAweDEwMzsgaSsrKSB7XG4gICAgICB0aGlzW2ldID0gbmV3IFNjcmVlbihyb20sIGkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIG1vdmVTY3JlZW4ob2xkSWQ6IG51bWJlciwgbmV3SWQ6IG51bWJlcik6IFNjcmVlbiB7XG4gIC8vICAgLy8gRW50aXR5LmlkIGlzIGNvbnN0LCBidXQgbWF5YmUgc2hvdWxkbid0IGJlP1xuICAvLyB9XG5cbiAgZ2V0U2NyZWVuKGlkOiBudW1iZXIpOiBTY3JlZW4ge1xuICAgIGNvbnN0IGFyciA9IGlkIDwgMCA/IHRoaXMudW5hbGxvY2F0ZWQgOiB0aGlzO1xuICAgIGNvbnN0IGkgPSBpZCA8IDAgPyB+aWQgOiBpZDtcbiAgICByZXR1cm4gYXJyW2ldIHx8IChhcnJbaV0gPSBuZXcgU2NyZWVuKHRoaXMucm9tLCBpZCkpO1xuICB9XG5cbiAgc2V0U2NyZWVuKGlkOiBudW1iZXIsIHNjcmVlbjogU2NyZWVuKSB7XG4gICAgY29uc3QgYXJyID0gaWQgPCAwID8gdGhpcy51bmFsbG9jYXRlZCA6IHRoaXM7XG4gICAgY29uc3QgaSA9IGlkIDwgMCA/IH5pZCA6IGlkO1xuICAgIGFycltpXSA9IHNjcmVlbjtcbiAgfVxuXG4gIGRlbGV0ZVNjcmVlbihpZDogbnVtYmVyKSB7XG4gICAgY29uc3QgYXJyID0gaWQgPCAwID8gdGhpcy51bmFsbG9jYXRlZCA6IHRoaXM7XG4gICAgY29uc3QgaSA9IGlkIDwgMCA/IH5pZCA6IGlkO1xuICAgIGRlbGV0ZSBhcnJbaV07XG4gIH1cblxuICB3cml0ZSgpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGZvciAoY29uc3Qgc2NyZWVuIG9mIHRoaXMpIHtcbiAgICAgIGlmIChzY3JlZW4/LnVzZWQpIHNjcmVlbi5hc3NlbWJsZShhKTtcbiAgICB9XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxufVxuIl19