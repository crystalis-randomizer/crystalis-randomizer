import { Define } from './define.js';
import { Expr } from './expr.js';
import { Macro } from './macro.js';
import { Token, TokenSource } from './token.js';
const MAX_STACK_DEPTH = 100;
const ID_MAP = new WeakMap();
function idGen(env) {
    let id = ID_MAP.get(env);
    if (!id)
        ID_MAP.set(env, id = (num => ({ next: () => num++ }))(0));
    return id;
}
export class Preprocessor extends TokenSource.Abstract {
    constructor(stream, env, parent) {
        super();
        this.stream = stream;
        this.env = env;
        this.repeats = [];
        this.runDirectives = {
            '.define': (line) => this.parseDefine(line),
            '.undefine': (line) => this.parseUndefine(line),
            '.else': ([cs]) => badClose('.if', cs),
            '.elseif': ([cs]) => badClose('.if', cs),
            '.endif': ([cs]) => badClose('.if', cs),
            '.endmac': ([cs]) => badClose('.macro', cs),
            '.endmacro': ([cs]) => badClose('.macro', cs),
            '.endrep': (line) => this.parseEndRepeat(line),
            '.endrepeat': (line) => this.parseEndRepeat(line),
            '.exitmacro': ([, a]) => { noGarbage(a); this.stream.exit(); },
            '.if': ([cs, ...args]) => this.parseIf(!!this.evaluateConst(parseOneExpr(args, cs))),
            '.ifdef': ([cs, ...args]) => this.parseIf(this.macros.has(parseOneIdent(args, cs))),
            '.ifndef': ([cs, ...args]) => this.parseIf(!this.macros.has(parseOneIdent(args, cs))),
            '.ifblank': ([, ...args]) => this.parseIf(!args.length),
            '.ifnblank': ([, ...args]) => this.parseIf(!!args.length),
            '.ifref': ([cs, ...args]) => this.parseIf(this.env.referencedSymbol(parseOneIdent(args, cs))),
            '.ifnref': ([cs, ...args]) => this.parseIf(!this.env.referencedSymbol(parseOneIdent(args, cs))),
            '.ifsym': ([cs, ...args]) => this.parseIf(this.env.definedSymbol(parseOneIdent(args, cs))),
            '.ifnsym': ([cs, ...args]) => this.parseIf(!this.env.definedSymbol(parseOneIdent(args, cs))),
            '.ifconst': ([cs, ...args]) => this.parseIf(this.env.constantSymbol(parseOneIdent(args, cs))),
            '.ifnconst': ([cs, ...args]) => this.parseIf(!this.env.constantSymbol(parseOneIdent(args, cs))),
            '.macro': (line) => this.parseMacro(line),
            '.repeat': (line) => this.parseRepeat(line),
        };
        this.macros = parent ? parent.macros : new Map();
    }
    *pump() {
        const line = this.readLine();
        if (line == null)
            return void (yield line);
        while (line.length) {
            const front = line[0];
            switch (front.token) {
                case 'ident':
                    if (Token.eq(line[1], Token.COLON)) {
                        yield line.splice(0, 2);
                        break;
                    }
                    if (!this.tryExpandMacro(line))
                        yield line;
                    return;
                case 'cs':
                    if (!this.tryRunDirective(line))
                        yield line;
                    return;
                case 'op':
                    if (/^[-+]+$/.test(front.str)) {
                        const label = [front];
                        const second = line[1];
                        if (second && Token.eq(second, Token.COLON)) {
                            label.push(second);
                            line.splice(0, 2);
                        }
                        else {
                            label.push({ token: 'op', str: ':' });
                            line.splice(0, 1);
                        }
                        yield label;
                        break;
                    }
                    else if (front.str === ':') {
                        yield line.splice(0, 1);
                        break;
                    }
                default:
                    throw new Error(`Unexpected: ${Token.nameAt(line[0])}`);
            }
        }
    }
    readLine() {
        const line = this.stream.next();
        if (line == null)
            return line;
        return this.expandLine(line);
    }
    expandLine(line, pos = 0) {
        const front = line[0];
        let depth = 0;
        let maxPos = 0;
        while (pos < line.length) {
            if (pos > maxPos) {
                maxPos = pos;
                depth = 0;
            }
            else if (depth++ > MAX_STACK_DEPTH) {
                throw new Error(`Maximum expansion depth reached: ${line.map(Token.name).join(' ')}${Token.at(front)}`);
            }
            pos = this.expandToken(line, pos);
        }
        return line;
    }
    expandToken(line, pos) {
        const front = line[pos];
        if (front.token === 'ident') {
            const define = this.macros.get(front.str);
            if (define instanceof Define) {
                const overflow = define.expand(line, pos);
                if (overflow) {
                    if (overflow.length)
                        this.stream.unshift(...overflow);
                    return pos;
                }
            }
        }
        else if (front.token === 'cs') {
            return this.expandDirective(front.str, line, pos);
        }
        return pos + 1;
    }
    tryExpandMacro(line) {
        const [first] = line;
        if (first.token !== 'ident')
            throw new Error(`impossible`);
        const macro = this.macros.get(first.str);
        if (!(macro instanceof Macro))
            return false;
        const expansion = macro.expand(line, idGen(this.env));
        this.stream.enter();
        this.stream.unshift(...expansion);
        return true;
    }
    expandDirective(directive, line, i) {
        switch (directive) {
            case '.define':
            case '.ifdef':
            case '.ifndef':
            case '.undefine':
                return this.skipIdentifier(line, i);
            case '.skip': return this.skip(line, i);
            case '.noexpand': return this.noexpand(line, i);
            case '.tcount': return this.parseArgs(line, i, 1, this.tcount);
            case '.ident': return this.parseArgs(line, i, 1, this.ident);
            case '.string': return this.parseArgs(line, i, 1, this.string);
            case '.concat': return this.parseArgs(line, i, 0, this.concat);
            case '.sprintf': return this.parseArgs(line, i, 0, this.sprintf);
            case '.cond': return this.parseArgs(line, i, 0, this.cond);
            case '.def':
            case '.defined':
                return this.parseArgs(line, i, 1, this.defined);
            case '.definedsymbol':
                return this.parseArgs(line, i, 1, this.definedSymbol);
            case '.constantsymbol':
                return this.parseArgs(line, i, 1, this.constantSymbol);
            case '.referencedsymbol':
                return this.parseArgs(line, i, 1, this.referencedSymbol);
        }
        return i + 1;
    }
    skip(line, i) {
        line.splice(i, 1);
        const skipped = line[i];
        if ((skipped === null || skipped === void 0 ? void 0 : skipped.token) === 'grp') {
            this.expandToken(skipped.inner, 0);
        }
        else {
            this.expandToken(line, i + 1);
        }
        return i;
    }
    noexpand(line, i) {
        const skip = line[i + 1];
        if (skip.token === 'grp') {
            line.splice(i, 2, ...skip.inner);
            i += skip.inner.length - 1;
        }
        else {
            line.splice(i, 1);
        }
        return i + 1;
    }
    parseArgs(line, i, argCount, fn) {
        const cs = line[i];
        Token.expect(Token.LP, line[i + 1], cs);
        const end = Token.findBalanced(line, i + 1);
        const args = Token.parseArgList(line, i + 2, end).map(ts => {
            if (ts.length === 1 && ts[0].token === 'grp')
                ts = ts[0].inner;
            return this.expandLine(ts);
        });
        if (argCount && args.length !== argCount) {
            throw new Error(`Expected ${argCount} parameters: ${Token.nameAt(cs)}`);
        }
        const expansion = fn.call(this, cs, ...args);
        line.splice(i, end + 1 - i, ...expansion);
        return i;
    }
    tcount(cs, arg) {
        return [{ token: 'num', num: Token.count(arg), source: cs.source }];
    }
    ident(cs, arg) {
        const str = Token.expectString(arg[0], cs);
        Token.expectEol(arg[1], 'a single token');
        return [{ token: 'ident', str, source: arg[0].source }];
    }
    string(cs, arg) {
        const str = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single token');
        return [{ token: 'str', str, source: arg[0].source }];
    }
    concat(cs, ...args) {
        const strs = args.map(ts => {
            const str = Token.expectString(ts[0]);
            Token.expectEol(ts[1], 'a single string');
            return str;
        });
        return [{ token: 'str', str: strs.join(''), source: cs.source }];
    }
    sprintf(cs, fmtToks, ...args) {
        const fmt = Token.expectString(fmtToks[0], cs);
        Token.expectEol(fmtToks[1], 'a single format string');
        const [] = [fmt];
        throw new Error('unimplemented');
    }
    cond(cs, ...args) {
        throw new Error('unimplemented');
    }
    defined(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.macros.has(ident) ? 1 : 0 }];
    }
    definedSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.definedSymbol(ident) ? 1 : 0 }];
    }
    constantSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.constantSymbol(ident) ? 1 : 0 }];
    }
    referencedSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.referencedSymbol(ident) ? 1 : 0 }];
    }
    skipIdentifier(line, i) {
        var _a;
        return ((_a = line[i + 1]) === null || _a === void 0 ? void 0 : _a.token) === 'ident' ? i + 2 : i + 1;
    }
    tryRunDirective(line) {
        const first = line[0];
        if (first.token !== 'cs')
            throw new Error(`impossible`);
        const handler = this.runDirectives[first.str];
        if (!handler)
            return false;
        handler(line);
        return true;
    }
    evaluateConst(expr) {
        var _a;
        expr = Expr.traversePost(expr, Expr.evaluate);
        if (expr.op === 'num' && !((_a = expr.meta) === null || _a === void 0 ? void 0 : _a.rel))
            return expr.num;
        const at = Token.at(expr);
        throw new Error(`Expected a constant${at}`);
    }
    parseDefine(line) {
        const name = Token.expectIdentifier(line[1], line[0]);
        const define = Define.from(line);
        const prev = this.macros.get(name);
        if (prev instanceof Define) {
            prev.append(define);
        }
        else if (prev) {
            throw new Error(`Already defined: ${name}`);
        }
        else {
            this.macros.set(name, define);
        }
    }
    parseUndefine(line) {
        const [cs, ident, eol] = line;
        const name = Token.expectIdentifier(ident, cs);
        Token.expectEol(eol);
        if (!this.macros.has(name)) {
            throw new Error(`Not defined: ${Token.nameAt(ident)}`);
        }
        this.macros.delete(name);
    }
    parseMacro(line) {
        const name = Token.expectIdentifier(line[1], line[0]);
        const macro = Macro.from(line, this.stream);
        const prev = this.macros.get(name);
        if (prev)
            throw new Error(`Already defined: ${name}`);
        this.macros.set(name, macro);
    }
    parseRepeat(line) {
        var _a;
        const [expr, end] = Expr.parse(line, 1);
        const at = line[1] || line[0];
        if (!expr)
            throw new Error(`Expected expression: ${Token.nameAt(at)}`);
        const times = this.evaluateConst(expr);
        if (times == null)
            throw new Error(`Expected a constant${Token.at(expr)}`);
        let ident;
        if (end < line.length) {
            if (!Token.eq(line[end], Token.COMMA)) {
                throw new Error(`Expected comma: ${Token.nameAt(line[end])}`);
            }
            ident = Token.expectIdentifier(line[end + 1]);
            Token.expectEol(line[end + 2]);
        }
        const lines = [];
        let depth = 1;
        while (depth > 0) {
            line = (_a = this.stream.next()) !== null && _a !== void 0 ? _a : fail(`.repeat with no .endrep`);
            if (Token.eq(line[0], Token.REPEAT))
                depth++;
            if (Token.eq(line[0], Token.ENDREPEAT))
                depth--;
            if (Token.eq(line[0], Token.ENDREP))
                depth--;
            lines.push(line);
        }
        this.repeats.push([lines, times, -1, ident]);
        this.parseEndRepeat(line);
    }
    parseEndRepeat(line) {
        Token.expectEol(line[1]);
        const top = this.repeats.pop();
        if (!top)
            throw new Error(`.endrep with no .repeat${Token.at(line[0])}`);
        if (++top[2] >= top[1])
            return;
        this.repeats.push(top);
        this.stream.unshift(...top[0].map(line => line.map(token => {
            if (token.token !== 'ident' || token.str !== top[3])
                return token;
            const t = { token: 'num', num: top[2] };
            if (token.source)
                t.source = token.source;
            return t;
        })));
    }
    parseIf(cond) {
        let depth = 1;
        let done = false;
        const result = [];
        while (depth > 0) {
            const line = this.stream.next();
            if (!line)
                throw new Error(`EOF looking for .endif`);
            const front = line[0];
            if (Token.eq(front, Token.ENDIF)) {
                depth--;
                if (!depth)
                    break;
            }
            else if (front.token === 'cs' && front.str.startsWith('.if')) {
                depth++;
            }
            else if (depth === 1 && !done) {
                if (cond && (Token.eq(front, Token.ELSE) ||
                    Token.eq(front, Token.ELSEIF))) {
                    cond = false;
                    done = true;
                    continue;
                }
                else if (Token.eq(front, Token.ELSEIF)) {
                    cond = !!this.evaluateConst(parseOneExpr(line.slice(1), front));
                    continue;
                }
                else if (Token.eq(front, Token.ELSE)) {
                    cond = true;
                    continue;
                }
            }
            if (cond)
                result.push(line);
        }
        this.stream.unshift(...result);
    }
}
function parseOneIdent(ts, prev) {
    const e = parseOneExpr(ts, prev);
    return Expr.identifier(e);
}
function parseOneExpr(ts, prev) {
    if (!ts.length) {
        if (!prev)
            throw new Error(`Expected expression`);
        throw new Error(`Expected expression: ${Token.nameAt(prev)}`);
    }
    return Expr.parseOnly(ts);
}
function noGarbage(token) {
    if (token)
        throw new Error(`garbage at end of line: ${Token.nameAt(token)}`);
}
function badClose(open, tok) {
    throw new Error(`${Token.name(tok)} with no ${open}${Token.at(tok)}`);
}
function fail(msg) {
    throw new Error(msg);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2FzbS9wcmVwcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxFQUFDLEtBQUssRUFBRSxXQUFXLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFNOUMsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBYzVCLE1BQU0sTUFBTSxHQUFHLElBQUksT0FBTyxFQUF5QixDQUFDO0FBQ3BELFNBQVMsS0FBSyxDQUFDLEdBQVE7SUFDckIsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QixJQUFJLENBQUMsRUFBRTtRQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQVdELE1BQU0sT0FBTyxZQUFhLFNBQVEsV0FBVyxDQUFDLFFBQVE7SUFTcEQsWUFBcUIsTUFBbUIsRUFBVyxHQUFRLEVBQy9DLE1BQXFCO1FBQy9CLEtBQUssRUFBRSxDQUFDO1FBRlcsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUFXLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFMbkQsWUFBTyxHQUFnRCxFQUFFLENBQUM7UUEwUmpELGtCQUFhLEdBQTBDO1lBQ3RFLFNBQVMsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMs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QUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQy9FLENBQUM7QUFXRCxTQUFTLFFBQVEsQ0FBQyxJQUFZLEVBQUUsR0FBVTtJQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEUsQ0FBQztBQUVELFNBQVMsSUFBSSxDQUFDLEdBQVc7SUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEZWZpbmV9IGZyb20gJy4vZGVmaW5lLmpzJztcbmltcG9ydCB7RXhwcn0gZnJvbSAnLi9leHByLmpzJztcbmltcG9ydCB7TWFjcm99IGZyb20gJy4vbWFjcm8uanMnO1xuaW1wb3J0IHtUb2tlbiwgVG9rZW5Tb3VyY2V9IGZyb20gJy4vdG9rZW4uanMnO1xuaW1wb3J0IHtUb2tlblN0cmVhbX0gZnJvbSAnLi90b2tlbnN0cmVhbS5qcyc7XG5cbi8vIFRPRE8gLSBmaWd1cmUgb3V0IGhvdyB0byBhY3R1YWxseSBrZWVwIHRyYWNrIG9mIHN0YWNrIGRlcHRoP1xuLy8gIC0gbWlnaHQgbmVlZCB0byBpbnNlcnQgYSBzcGVjaWFsIHRva2VuIGF0IHRoZSBlbmQgb2YgYW4gZXhwYW5zaW9uXG4vLyAgICB0byBrbm93IHdoZW4gdG8gcmVsZWFzZSB0aGUgZnJhbWU/XG5jb25zdCBNQVhfU1RBQ0tfREVQVEggPSAxMDA7XG5cbi8vIGludGVyZmFjZSBUb2tlblNvdXJjZSB7XG4vLyAgIG5leHQoKTogVG9rZW5bXTtcbi8vICAgaW5jbHVkZShmaWxlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuLy8gICB1bnNoaWZ0KC4uLmxpbmVzOiBUb2tlbltdW10pOiB2b2lkO1xuLy8gICBlbnRlcigpOiB2b2lkO1xuLy8gICBleGl0KCk6IHZvaWQ7XG4vLyAgIC8vb3B0aW9ucygpOiBUb2tlbml6ZXIuT3B0aW9ucztcbi8vIH1cblxuLy8gU2luY2UgdGhlIEVudiBpcyBtb3N0IGNsb3NlbHkgdGllZCB0byB0aGUgQXNzZW1ibGVyLCB3ZSB0aWUgdGhlXG4vLyB1bmlxdWUgSUQgZ2VuZXJhdGlvbiB0byBpdCBhcyB3ZWxsLCB3aXRob3V0IGFkZGluZyBhZGRpdGlvbmFsXG4vLyBjb25zdHJhaW50cyBvbiB0aGUgQXNzZW1ibGVyIEFQSS5cbmNvbnN0IElEX01BUCA9IG5ldyBXZWFrTWFwPEVudiwge25leHQoKTogbnVtYmVyfT4oKTtcbmZ1bmN0aW9uIGlkR2VuKGVudjogRW52KToge25leHQoKTogbnVtYmVyfSB7XG4gIGxldCBpZCA9IElEX01BUC5nZXQoZW52KTtcbiAgaWYgKCFpZCkgSURfTUFQLnNldChlbnYsIGlkID0gKG51bSA9PiAoe25leHQ6ICgpID0+IG51bSsrfSkpKDApKTtcbiAgcmV0dXJuIGlkO1xufVxuXG5pbnRlcmZhY2UgRW52IHtcbiAgLy8gVGhlc2UgbmVlZCB0byBjb21lIGZyb20gUHJvY2Vzc29yIGFuZCB3aWxsIGRlcGVuZCBvbiBzY29wZS4uLlxuICBkZWZpbmVkU3ltYm9sKHN5bTogc3RyaW5nKTogYm9vbGVhbjtcbiAgY29uc3RhbnRTeW1ib2woc3ltOiBzdHJpbmcpOiBib29sZWFuO1xuICByZWZlcmVuY2VkU3ltYm9sKHN5bTogc3RyaW5nKTogYm9vbGVhbjtcbiAgLy8gYWxzbyB3YW50IG1ldGhvZHMgdG8gYXBwbHkgc2h1bnRpbmcgeWFyZCB0byB0b2tlbiBsaXN0P1xuICAvLyAgLSB0dXJuIGl0IGludG8gYSBqc29uIHRyZWUuLi4/XG59XG5cbmV4cG9ydCBjbGFzcyBQcmVwcm9jZXNzb3IgZXh0ZW5kcyBUb2tlblNvdXJjZS5BYnN0cmFjdCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWFjcm9zOiBNYXA8c3RyaW5nLCBEZWZpbmV8TWFjcm8+O1xuXG4gIC8vIGJ1aWxkcyB1cCByZXBlYXRpbmcgdG9rZW5zLi4uXG4gIHByaXZhdGUgcmVwZWF0czogQXJyYXk8W1Rva2VuW11bXSwgbnVtYmVyLCBudW1iZXIsIHN0cmluZz9dPiA9IFtdO1xuICAvLyBOT1RFOiB0aGVyZSBpcyBubyBzY29wZSBoZXJlLi4uIC0gbm90IGZvciBtYWNyb3NcbiAgLy8gIC0gb25seSBzeW1ib2xzIGhhdmUgc2NvcGVcbiAgLy8gVE9ETyAtIGV2YWx1YXRlIGNvbnN0YW50cy4uLlxuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHN0cmVhbTogVG9rZW5TdHJlYW0sIHJlYWRvbmx5IGVudjogRW52LFxuICAgICAgICAgICAgICBwYXJlbnQ/OiBQcmVwcm9jZXNzb3IpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMubWFjcm9zID0gcGFyZW50ID8gcGFyZW50Lm1hY3JvcyA6IG5ldyBNYXAoKTtcbiAgfVxuXG4gIC8vIEZvciB1c2UgYXMgYSB0b2tlbiBzb3VyY2UgaW4gdGhlIG5leHQgc3RhZ2UuXG4gICogcHVtcCgpOiBHZW5lcmF0b3I8VG9rZW5bXXx1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBsaW5lID0gdGhpcy5yZWFkTGluZSgpO1xuICAgIGlmIChsaW5lID09IG51bGwpIHJldHVybiB2b2lkICh5aWVsZCBsaW5lKTsgLy8gRU9GXG4gICAgd2hpbGUgKGxpbmUubGVuZ3RoKSB7XG4gICAgICBjb25zdCBmcm9udCA9IGxpbmVbMF07XG4gICAgICBzd2l0Y2ggKGZyb250LnRva2VuKSB7XG4gICAgICAgIGNhc2UgJ2lkZW50JzpcbiAgICAgICAgICAvLyBQb3NzaWJpbGl0aWVzOiAoMSkgbGFiZWwsICgyKSBpbnN0cnVjdGlvbi9hc3NpZ24sICgzKSBtYWNyb1xuICAgICAgICAgIC8vIExhYmVscyBnZXQgc3BsaXQgb3V0LiAgV2UgZG9uJ3QgZGlzdGluZ3Vpc2ggYXNzaWducyB5ZXQuXG4gICAgICAgICAgaWYgKFRva2VuLmVxKGxpbmVbMV0sIFRva2VuLkNPTE9OKSkge1xuICAgICAgICAgICAgeWllbGQgbGluZS5zcGxpY2UoMCwgMik7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCF0aGlzLnRyeUV4cGFuZE1hY3JvKGxpbmUpKSB5aWVsZCBsaW5lO1xuICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjYXNlICdjcyc6XG4gICAgICAgICAgaWYgKCF0aGlzLnRyeVJ1bkRpcmVjdGl2ZShsaW5lKSkgeWllbGQgbGluZTtcbiAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY2FzZSAnb3AnOlxuICAgICAgICAgIC8vIFByb2JhYmx5IGFuIGFub255bW91cyBsYWJlbC4uLlxuICAgICAgICAgIGlmICgvXlstK10rJC8udGVzdChmcm9udC5zdHIpKSB7XG4gICAgICAgICAgICBjb25zdCBsYWJlbDogVG9rZW5bXSA9IFtmcm9udF07XG4gICAgICAgICAgICBjb25zdCBzZWNvbmQgPSBsaW5lWzFdO1xuICAgICAgICAgICAgaWYgKHNlY29uZCAmJiBUb2tlbi5lcShzZWNvbmQsIFRva2VuLkNPTE9OKSkge1xuICAgICAgICAgICAgICBsYWJlbC5wdXNoKHNlY29uZCk7XG4gICAgICAgICAgICAgIGxpbmUuc3BsaWNlKDAsIDIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbGFiZWwucHVzaCh7dG9rZW46ICdvcCcsIHN0cjogJzonfSk7XG4gICAgICAgICAgICAgIGxpbmUuc3BsaWNlKDAsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgeWllbGQgbGFiZWw7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9IGVsc2UgaWYgKGZyb250LnN0ciA9PT0gJzonKSB7XG4gICAgICAgICAgICB5aWVsZCBsaW5lLnNwbGljZSgwLCAxKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZDogJHtUb2tlbi5uYW1lQXQobGluZVswXSl9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gRXhwYW5kIGEgc2luZ2xlIGxpbmUgb2YgdG9rZW5zIGZyb20gdGhlIGZyb250IG9mIHRva3MuXG4gIHByaXZhdGUgcmVhZExpbmUoKTogVG9rZW5bXXx1bmRlZmluZWQge1xuICAgIC8vIEFwcGx5IC5kZWZpbmUgZXhwYW5zaW9ucyBhcyBuZWNlc3NhcnkuXG4gICAgY29uc3QgbGluZSA9IHRoaXMuc3RyZWFtLm5leHQoKTtcbiAgICBpZiAobGluZSA9PSBudWxsKSByZXR1cm4gbGluZTtcbiAgICByZXR1cm4gdGhpcy5leHBhbmRMaW5lKGxpbmUpO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBFWFBBTlNJT05cblxuICBwcml2YXRlIGV4cGFuZExpbmUobGluZTogVG9rZW5bXSwgcG9zID0gMCk6IFRva2VuW10ge1xuICAgIGNvbnN0IGZyb250ID0gbGluZVswXTtcbiAgICBsZXQgZGVwdGggPSAwO1xuICAgIGxldCBtYXhQb3MgPSAwO1xuICAgIHdoaWxlIChwb3MgPCBsaW5lLmxlbmd0aCkge1xuICAgICAgaWYgKHBvcyA+IG1heFBvcykge1xuICAgICAgICBtYXhQb3MgPSBwb3M7XG4gICAgICAgIGRlcHRoID0gMDtcbiAgICAgIH0gZWxzZSBpZiAoZGVwdGgrKyA+IE1BWF9TVEFDS19ERVBUSCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1heGltdW0gZXhwYW5zaW9uIGRlcHRoIHJlYWNoZWQ6ICR7XG4gICAgICAgICAgICAgICAgICAgICAgICAgbGluZS5tYXAoVG9rZW4ubmFtZSkuam9pbignICcpfSR7VG9rZW4uYXQoZnJvbnQpfWApO1xuICAgICAgfVxuICAgICAgcG9zID0gdGhpcy5leHBhbmRUb2tlbihsaW5lLCBwb3MpO1xuICAgIH1cbiAgICByZXR1cm4gbGluZTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIHRoZSBuZXh0IHBvc2l0aW9uIHRvIGV4cGFuZC4gKi9cbiAgcHJpdmF0ZSBleHBhbmRUb2tlbihsaW5lOiBUb2tlbltdLCBwb3M6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3QgZnJvbnQgPSBsaW5lW3Bvc10hO1xuICAgIGlmIChmcm9udC50b2tlbiA9PT0gJ2lkZW50Jykge1xuICAgICAgY29uc3QgZGVmaW5lID0gdGhpcy5tYWNyb3MuZ2V0KGZyb250LnN0cik7XG4gICAgICBpZiAoZGVmaW5lIGluc3RhbmNlb2YgRGVmaW5lKSB7XG4gICAgICAgIGNvbnN0IG92ZXJmbG93ID0gZGVmaW5lLmV4cGFuZChsaW5lLCBwb3MpO1xuLy9jb25zb2xlLmxvZygncG9zdC1leHBhbmQnLCBsaW5lKTtcbiAgICAgICAgaWYgKG92ZXJmbG93KSB7XG4gICAgICAgICAgaWYgKG92ZXJmbG93Lmxlbmd0aCkgdGhpcy5zdHJlYW0udW5zaGlmdCguLi5vdmVyZmxvdylcbiAgICAgICAgICByZXR1cm4gcG9zO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChmcm9udC50b2tlbiA9PT0gJ2NzJykge1xuICAgICAgcmV0dXJuIHRoaXMuZXhwYW5kRGlyZWN0aXZlKGZyb250LnN0ciwgbGluZSwgcG9zKTtcbiAgICB9XG4gICAgcmV0dXJuIHBvcyArIDE7XG4gIH1cblxuICB0cnlFeHBhbmRNYWNybyhsaW5lOiBUb2tlbltdKTogYm9vbGVhbiB7XG4gICAgY29uc3QgW2ZpcnN0XSA9IGxpbmU7XG4gICAgaWYgKGZpcnN0LnRva2VuICE9PSAnaWRlbnQnKSB0aHJvdyBuZXcgRXJyb3IoYGltcG9zc2libGVgKTtcbiAgICBjb25zdCBtYWNybyA9IHRoaXMubWFjcm9zLmdldChmaXJzdC5zdHIpO1xuICAgIGlmICghKG1hY3JvIGluc3RhbmNlb2YgTWFjcm8pKSByZXR1cm4gZmFsc2U7XG4gICAgY29uc3QgZXhwYW5zaW9uID0gbWFjcm8uZXhwYW5kKGxpbmUsIGlkR2VuKHRoaXMuZW52KSk7XG4gICAgdGhpcy5zdHJlYW0uZW50ZXIoKTtcbiAgICB0aGlzLnN0cmVhbS51bnNoaWZ0KC4uLmV4cGFuc2lvbik7IC8vIHByb2Nlc3MgdGhlbSBhbGwgb3ZlciBhZ2Fpbi4uLlxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBleHBhbmREaXJlY3RpdmUoZGlyZWN0aXZlOiBzdHJpbmcsIGxpbmU6IFRva2VuW10sIGk6IG51bWJlcik6IG51bWJlciB7XG4gICAgc3dpdGNoIChkaXJlY3RpdmUpIHtcbiAgICAgIGNhc2UgJy5kZWZpbmUnOiBcbiAgICAgIGNhc2UgJy5pZmRlZic6ICBcbiAgICAgIGNhc2UgJy5pZm5kZWYnOiBcbiAgICAgIGNhc2UgJy51bmRlZmluZSc6XG4gICAgICAgIHJldHVybiB0aGlzLnNraXBJZGVudGlmaWVyKGxpbmUsIGkpO1xuICAgICAgY2FzZSAnLnNraXAnOiByZXR1cm4gdGhpcy5za2lwKGxpbmUsIGkpO1xuICAgICAgY2FzZSAnLm5vZXhwYW5kJzogcmV0dXJuIHRoaXMubm9leHBhbmQobGluZSwgaSk7XG4gICAgICBjYXNlICcudGNvdW50JzogcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDEsIHRoaXMudGNvdW50KTtcbiAgICAgIGNhc2UgJy5pZGVudCc6IHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAxLCB0aGlzLmlkZW50KTtcbiAgICAgIGNhc2UgJy5zdHJpbmcnOiByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMSwgdGhpcy5zdHJpbmcpO1xuICAgICAgY2FzZSAnLmNvbmNhdCc6IHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAwLCB0aGlzLmNvbmNhdCk7XG4gICAgICBjYXNlICcuc3ByaW50Zic6IHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAwLCB0aGlzLnNwcmludGYpO1xuICAgICAgY2FzZSAnLmNvbmQnOiByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMCwgdGhpcy5jb25kKTtcbiAgICAgIGNhc2UgJy5kZWYnOlxuICAgICAgY2FzZSAnLmRlZmluZWQnOlxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMSwgdGhpcy5kZWZpbmVkKTtcbiAgICAgIGNhc2UgJy5kZWZpbmVkc3ltYm9sJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDEsIHRoaXMuZGVmaW5lZFN5bWJvbCk7XG4gICAgICBjYXNlICcuY29uc3RhbnRzeW1ib2wnOlxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMSwgdGhpcy5jb25zdGFudFN5bWJvbCk7XG4gICAgICBjYXNlICcucmVmZXJlbmNlZHN5bWJvbCc6XG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAxLCB0aGlzLnJlZmVyZW5jZWRTeW1ib2wpO1xuICAgIH1cbiAgICByZXR1cm4gaSArIDE7XG4gIH1cblxuICAvLyBRVUVTVElPTiAtIGRvZXMgc2tpcCBkZXNjZW5kIGludG8gZ3JvdXBzP1xuICAvLyAgICAgICAgICAtIHNlZW1zIGxpa2UgaXQgc2hvdWxkLi4uXG4gIHByaXZhdGUgc2tpcChsaW5lOiBUb2tlbltdLCBpOiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIGV4cGFuZCBpICsgMSwgdGhlbiBzcGxpY2Ugc2VsZiBvdXRcbiAgICBsaW5lLnNwbGljZShpLCAxKTtcbiAgICBjb25zdCBza2lwcGVkID0gbGluZVtpXTtcbiAgICBpZiAoc2tpcHBlZD8udG9rZW4gPT09ICdncnAnKSB7XG4gICAgICB0aGlzLmV4cGFuZFRva2VuKHNraXBwZWQuaW5uZXIsIDApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmV4cGFuZFRva2VuKGxpbmUsIGkgKyAxKTtcbiAgICB9XG4gICAgcmV0dXJuIGk7XG4gIH1cblxuICBwcml2YXRlIG5vZXhwYW5kKGxpbmU6IFRva2VuW10sIGk6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgc2tpcCA9IGxpbmVbaSArIDFdO1xuICAgIGlmIChza2lwLnRva2VuID09PSAnZ3JwJykge1xuICAgICAgbGluZS5zcGxpY2UoaSwgMiwgLi4uc2tpcC5pbm5lcik7XG4gICAgICBpICs9IHNraXAuaW5uZXIubGVuZ3RoIC0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGluZS5zcGxpY2UoaSwgMSk7XG4gICAgfVxuICAgIHJldHVybiBpICsgMTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VBcmdzKGxpbmU6IFRva2VuW10sIGk6IG51bWJlciwgYXJnQ291bnQ6IG51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgZm46ICh0aGlzOiB0aGlzLCBjczogVG9rZW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgLi4uYXJnczogVG9rZW5bXVtdKSA9PiB2b2lkKTogbnVtYmVyIHtcbiAgICBjb25zdCBjcyA9IGxpbmVbaV07XG4gICAgVG9rZW4uZXhwZWN0KFRva2VuLkxQLCBsaW5lW2kgKyAxXSwgY3MpO1xuICAgIGNvbnN0IGVuZCA9IFRva2VuLmZpbmRCYWxhbmNlZChsaW5lLCBpICsgMSk7XG4gICAgY29uc3QgYXJncyA9XG4gICAgICAgIFRva2VuLnBhcnNlQXJnTGlzdChsaW5lLCBpICsgMiwgZW5kKS5tYXAodHMgPT4ge1xuICAgICAgICAgIGlmICh0cy5sZW5ndGggPT09IDEgJiYgdHNbMF0udG9rZW4gPT09ICdncnAnKSB0cyA9IHRzWzBdLmlubmVyO1xuICAgICAgICAgIHJldHVybiB0aGlzLmV4cGFuZExpbmUodHMpO1xuICAgICAgICB9KTtcbiAgICBpZiAoYXJnQ291bnQgJiYgYXJncy5sZW5ndGggIT09IGFyZ0NvdW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkICR7YXJnQ291bnR9IHBhcmFtZXRlcnM6ICR7VG9rZW4ubmFtZUF0KGNzKX1gKTtcbiAgICB9XG4gICAgY29uc3QgZXhwYW5zaW9uID0gZm4uY2FsbCh0aGlzLCBjcywgLi4uYXJncyk7XG4gICAgbGluZS5zcGxpY2UoaSwgZW5kICsgMSAtIGksIC4uLmV4cGFuc2lvbik7XG4gICAgcmV0dXJuIGk7IC8vIGNvbnRpbnVlIGV4cGFuc2lvbiBmcm9tIHNhbWUgc3BvdFxuICB9XG5cbiAgcHJpdmF0ZSB0Y291bnQoY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICByZXR1cm4gW3t0b2tlbjogJ251bScsIG51bTogVG9rZW4uY291bnQoYXJnKSwgc291cmNlOiBjcy5zb3VyY2V9XTtcbiAgfVxuXG4gIHByaXZhdGUgaWRlbnQoY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICBjb25zdCBzdHIgPSBUb2tlbi5leHBlY3RTdHJpbmcoYXJnWzBdLCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGFyZ1sxXSwgJ2Egc2luZ2xlIHRva2VuJyk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdpZGVudCcsIHN0ciwgc291cmNlOiBhcmdbMF0uc291cmNlfV07XG4gIH1cblxuICBwcml2YXRlIHN0cmluZyhjczogVG9rZW4sIGFyZzogVG9rZW5bXSkge1xuICAgIGNvbnN0IHN0ciA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIoYXJnWzBdLCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGFyZ1sxXSwgJ2Egc2luZ2xlIHRva2VuJyk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdzdHInLCBzdHIsIHNvdXJjZTogYXJnWzBdLnNvdXJjZX1dO1xuICB9XG4gICAgXG4gIHByaXZhdGUgY29uY2F0KGNzOiBUb2tlbiwgLi4uYXJnczogVG9rZW5bXVtdKSB7XG4gICAgY29uc3Qgc3RycyA9IGFyZ3MubWFwKHRzID0+IHtcbiAgICAgIGNvbnN0IHN0ciA9IFRva2VuLmV4cGVjdFN0cmluZyh0c1swXSk7XG4gICAgICBUb2tlbi5leHBlY3RFb2wodHNbMV0sICdhIHNpbmdsZSBzdHJpbmcnKTtcbiAgICAgIHJldHVybiBzdHI7XG4gICAgfSk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdzdHInLCBzdHI6IHN0cnMuam9pbignJyksIHNvdXJjZTogY3Muc291cmNlfV07XG4gIH1cblxuICBwcml2YXRlIHNwcmludGYoY3M6IFRva2VuLCBmbXRUb2tzOiBUb2tlbltdLCAuLi5hcmdzOiBUb2tlbltdW10pIHtcbiAgICBjb25zdCBmbXQgPSBUb2tlbi5leHBlY3RTdHJpbmcoZm10VG9rc1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChmbXRUb2tzWzFdLCAnYSBzaW5nbGUgZm9ybWF0IHN0cmluZycpO1xuICAgIC8vIGZpZ3VyZSBvdXQgd2hhdCBwbGFjZWhvbGRlcnMuLi5cbiAgICAvLyBUT0RPIC0gZXZhbHVhdGUgbnVtZXJpYyBhcmdzIGFzIGV4cHJzLCBzdHJpbmdzIGxlZnQgYXMgaXNcbiAgICBjb25zdCBbXSA9IFtmbXRdO1xuICAgIHRocm93IG5ldyBFcnJvcigndW5pbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25kKGNzOiBUb2tlbiwgLi4uYXJnczogVG9rZW5bXVtdKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd1bmltcGxlbWVudGVkJyk7XG4gIH1cblxuICBwcml2YXRlIGRlZmluZWQoY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICBjb25zdCBpZGVudCA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIoYXJnWzBdLCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGFyZ1sxXSwgJ2Egc2luZ2xlIGlkZW50aWZpZXInKTtcbiAgICByZXR1cm4gW3t0b2tlbjogJ251bScsIG51bTogdGhpcy5tYWNyb3MuaGFzKGlkZW50KSA/IDEgOiAwfV07XG4gIH1cblxuICBwcml2YXRlIGRlZmluZWRTeW1ib2woY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICBjb25zdCBpZGVudCA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIoYXJnWzBdLCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGFyZ1sxXSwgJ2Egc2luZ2xlIGlkZW50aWZpZXInKTtcbiAgICByZXR1cm4gW3t0b2tlbjogJ251bScsIG51bTogdGhpcy5lbnYuZGVmaW5lZFN5bWJvbChpZGVudCkgPyAxIDogMH1dO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25zdGFudFN5bWJvbChjczogVG9rZW4sIGFyZzogVG9rZW5bXSkge1xuICAgIGNvbnN0IGlkZW50ID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihhcmdbMF0sIGNzKTtcbiAgICBUb2tlbi5leHBlY3RFb2woYXJnWzFdLCAnYSBzaW5nbGUgaWRlbnRpZmllcicpO1xuICAgIHJldHVybiBbe3Rva2VuOiAnbnVtJywgbnVtOiB0aGlzLmVudi5jb25zdGFudFN5bWJvbChpZGVudCkgPyAxIDogMH1dO1xuICB9XG5cbiAgcHJpdmF0ZSByZWZlcmVuY2VkU3ltYm9sKGNzOiBUb2tlbiwgYXJnOiBUb2tlbltdKSB7XG4gICAgY29uc3QgaWRlbnQgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGFyZ1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChhcmdbMV0sICdhIHNpbmdsZSBpZGVudGlmaWVyJyk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdudW0nLCBudW06IHRoaXMuZW52LnJlZmVyZW5jZWRTeW1ib2woaWRlbnQpID8gMSA6IDB9XTtcbiAgfVxuXG4gIC8vIFRPRE8gLSBkb2VzIC5ieXRlIGV4cGFuZCBpdHMgc3RyaW5ncyBpbnRvIGJ5dGVzIGhlcmU/XG4gIC8vICAgLS0gbWF5YmUgbm90Li4uXG4gIC8vICAgLS0gZG8gd2UgbmVlZCB0byBoYW5kbGUgc3RyaW5nIGV4cHJzIGF0IGFsbD9cbiAgLy8gICAtLSBtYXliZSBub3QgLSBtYXliZSBqdXN0IHRva2Vucz9cblxuICAvKipcbiAgICogSWYgdGhlIGZvbGxvd2luZyBpcyBhbiBpZGVudGlmaWVyLCBza2lwIGl0LiAgVGhpcyBpcyB1c2VkIHdoZW5cbiAgICogZXhwYW5kaW5nIC5kZWZpbmUsIC51bmRlZmluZSwgLmRlZmluZWQsIC5pZmRlZiwgYW5kIC5pZm5kZWYuXG4gICAqIERvZXMgbm90IHNraXAgc2NvcGVkIGlkZW50aWZpZXJzLCBzaW5jZSBtYWNyb3MgY2FuJ3QgYmUgc2NvcGVkLlxuICAgKi9cbiAgcHJpdmF0ZSBza2lwSWRlbnRpZmllcihsaW5lOiBUb2tlbltdLCBpOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBsaW5lW2kgKyAxXT8udG9rZW4gPT09ICdpZGVudCcgPyBpICsgMiA6IGkgKyAxO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBSVU4gRElSRUNUSVZFU1xuXG4gIHRyeVJ1bkRpcmVjdGl2ZShsaW5lOiBUb2tlbltdKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZmlyc3QgPSBsaW5lWzBdO1xuICAgIGlmIChmaXJzdC50b2tlbiAhPT0gJ2NzJykgdGhyb3cgbmV3IEVycm9yKGBpbXBvc3NpYmxlYCk7XG4gICAgY29uc3QgaGFuZGxlciA9IHRoaXMucnVuRGlyZWN0aXZlc1tmaXJzdC5zdHJdO1xuICAgIGlmICghaGFuZGxlcikgcmV0dXJuIGZhbHNlO1xuICAgIGhhbmRsZXIobGluZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBldmFsdWF0ZUNvbnN0KGV4cHI6IEV4cHIpOiBudW1iZXIge1xuICAgIGV4cHIgPSBFeHByLnRyYXZlcnNlUG9zdChleHByLCBFeHByLmV2YWx1YXRlKTtcbiAgICBpZiAoZXhwci5vcCA9PT0gJ251bScgJiYgIWV4cHIubWV0YT8ucmVsKSByZXR1cm4gZXhwci5udW0hO1xuICAgIGNvbnN0IGF0ID0gVG9rZW4uYXQoZXhwcik7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBhIGNvbnN0YW50JHthdH1gKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgcnVuRGlyZWN0aXZlczogUmVjb3JkPHN0cmluZywgKHRzOiBUb2tlbltdKSA9PiB2b2lkPiA9IHtcbiAgICAnLmRlZmluZSc6IChsaW5lKSA9PiB0aGlzLnBhcnNlRGVmaW5lKGxpbmUpLFxuICAgICcudW5kZWZpbmUnOiAobGluZSkgPT4gdGhpcy5wYXJzZVVuZGVmaW5lKGxpbmUpLFxuICAgICcuZWxzZSc6IChbY3NdKSA9PiBiYWRDbG9zZSgnLmlmJywgY3MpLFxuICAgICcuZWxzZWlmJzogKFtjc10pID0+IGJhZENsb3NlKCcuaWYnLCBjcyksXG4gICAgJy5lbmRpZic6IChbY3NdKSA9PiBiYWRDbG9zZSgnLmlmJywgY3MpLFxuICAgICcuZW5kbWFjJzogKFtjc10pID0+IGJhZENsb3NlKCcubWFjcm8nLCBjcyksXG4gICAgJy5lbmRtYWNybyc6IChbY3NdKSA9PiBiYWRDbG9zZSgnLm1hY3JvJywgY3MpLFxuICAgICcuZW5kcmVwJzogKGxpbmUpID0+IHRoaXMucGFyc2VFbmRSZXBlYXQobGluZSksXG4gICAgJy5lbmRyZXBlYXQnOiAobGluZSkgPT4gdGhpcy5wYXJzZUVuZFJlcGVhdChsaW5lKSxcbiAgICAnLmV4aXRtYWNybyc6IChbLCBhXSkgPT4geyBub0dhcmJhZ2UoYSk7IHRoaXMuc3RyZWFtLmV4aXQoKTsgfSxcbiAgICAnLmlmJzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZighIXRoaXMuZXZhbHVhdGVDb25zdChwYXJzZU9uZUV4cHIoYXJncywgY3MpKSksXG4gICAgJy5pZmRlZic6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYodGhpcy5tYWNyb3MuaGFzKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5pZm5kZWYnOiAoW2NzLCAuLi5hcmdzXSkgPT5cbiAgICAgICAgdGhpcy5wYXJzZUlmKCF0aGlzLm1hY3Jvcy5oYXMocGFyc2VPbmVJZGVudChhcmdzLCBjcykpKSxcbiAgICAnLmlmYmxhbmsnOiAoWywgLi4uYXJnc10pID0+IHRoaXMucGFyc2VJZighYXJncy5sZW5ndGgpLFxuICAgICcuaWZuYmxhbmsnOiAoWywgLi4uYXJnc10pID0+IHRoaXMucGFyc2VJZighIWFyZ3MubGVuZ3RoKSxcbiAgICAnLmlmcmVmJzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZih0aGlzLmVudi5yZWZlcmVuY2VkU3ltYm9sKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5pZm5yZWYnOiAoW2NzLCAuLi5hcmdzXSkgPT5cbiAgICAgICAgdGhpcy5wYXJzZUlmKCF0aGlzLmVudi5yZWZlcmVuY2VkU3ltYm9sKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5pZnN5bSc6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYodGhpcy5lbnYuZGVmaW5lZFN5bWJvbChwYXJzZU9uZUlkZW50KGFyZ3MsIGNzKSkpLFxuICAgICcuaWZuc3ltJzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZighdGhpcy5lbnYuZGVmaW5lZFN5bWJvbChwYXJzZU9uZUlkZW50KGFyZ3MsIGNzKSkpLFxuICAgICcuaWZjb25zdCc6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYodGhpcy5lbnYuY29uc3RhbnRTeW1ib2wocGFyc2VPbmVJZGVudChhcmdzLCBjcykpKSxcbiAgICAnLmlmbmNvbnN0JzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZighdGhpcy5lbnYuY29uc3RhbnRTeW1ib2wocGFyc2VPbmVJZGVudChhcmdzLCBjcykpKSxcbiAgICAnLm1hY3JvJzogKGxpbmUpID0+IHRoaXMucGFyc2VNYWNybyhsaW5lKSxcbiAgICAnLnJlcGVhdCc6IChsaW5lKSA9PiB0aGlzLnBhcnNlUmVwZWF0KGxpbmUpLFxuICB9O1xuXG4gIHByaXZhdGUgcGFyc2VEZWZpbmUobGluZTogVG9rZW5bXSkge1xuICAgIGNvbnN0IG5hbWUgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGxpbmVbMV0sIGxpbmVbMF0pO1xuICAgIGNvbnN0IGRlZmluZSA9IERlZmluZS5mcm9tKGxpbmUpO1xuICAgIGNvbnN0IHByZXYgPSB0aGlzLm1hY3Jvcy5nZXQobmFtZSk7XG4gICAgaWYgKHByZXYgaW5zdGFuY2VvZiBEZWZpbmUpIHtcbiAgICAgIHByZXYuYXBwZW5kKGRlZmluZSk7XG4gICAgfSBlbHNlIGlmIChwcmV2KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFscmVhZHkgZGVmaW5lZDogJHtuYW1lfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1hY3Jvcy5zZXQobmFtZSwgZGVmaW5lKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlVW5kZWZpbmUobGluZTogVG9rZW5bXSkge1xuICAgIGNvbnN0IFtjcywgaWRlbnQsIGVvbF0gPSBsaW5lO1xuICAgIGNvbnN0IG5hbWUgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGlkZW50LCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGVvbCk7XG4gICAgaWYgKCF0aGlzLm1hY3Jvcy5oYXMobmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IGRlZmluZWQ6ICR7VG9rZW4ubmFtZUF0KGlkZW50KX1gKTtcbiAgICB9XG4gICAgdGhpcy5tYWNyb3MuZGVsZXRlKG5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZU1hY3JvKGxpbmU6IFRva2VuW10pIHtcbiAgICBjb25zdCBuYW1lID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihsaW5lWzFdLCBsaW5lWzBdKTtcbiAgICBjb25zdCBtYWNybyA9IE1hY3JvLmZyb20obGluZSwgdGhpcy5zdHJlYW0pO1xuICAgIGNvbnN0IHByZXYgPSB0aGlzLm1hY3Jvcy5nZXQobmFtZSk7XG4gICAgaWYgKHByZXYpIHRocm93IG5ldyBFcnJvcihgQWxyZWFkeSBkZWZpbmVkOiAke25hbWV9YCk7XG4gICAgdGhpcy5tYWNyb3Muc2V0KG5hbWUsIG1hY3JvKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VSZXBlYXQobGluZTogVG9rZW5bXSkge1xuICAgIGNvbnN0IFtleHByLCBlbmRdID0gRXhwci5wYXJzZShsaW5lLCAxKTtcbiAgICBjb25zdCBhdCA9IGxpbmVbMV0gfHwgbGluZVswXTtcbiAgICBpZiAoIWV4cHIpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgZXhwcmVzc2lvbjogJHtUb2tlbi5uYW1lQXQoYXQpfWApO1xuICAgIGNvbnN0IHRpbWVzID0gdGhpcy5ldmFsdWF0ZUNvbnN0KGV4cHIpO1xuICAgIGlmICh0aW1lcyA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGEgY29uc3RhbnQke1Rva2VuLmF0KGV4cHIpfWApO1xuICAgIGxldCBpZGVudDogc3RyaW5nfHVuZGVmaW5lZDtcbiAgICBpZiAoZW5kIDwgbGluZS5sZW5ndGgpIHtcbiAgICAgIGlmICghVG9rZW4uZXEobGluZVtlbmRdLCBUb2tlbi5DT01NQSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBjb21tYTogJHtUb2tlbi5uYW1lQXQobGluZVtlbmRdKX1gKTtcbiAgICAgIH1cbiAgICAgIGlkZW50ID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihsaW5lW2VuZCArIDFdKTtcbiAgICAgIFRva2VuLmV4cGVjdEVvbChsaW5lW2VuZCArIDJdKTtcbiAgICB9XG4gICAgY29uc3QgbGluZXM6IFRva2VuW11bXSA9IFtdO1xuICAgIGxldCBkZXB0aCA9IDE7XG4gICAgd2hpbGUgKGRlcHRoID4gMCkge1xuICAgICAgbGluZSA9IHRoaXMuc3RyZWFtLm5leHQoKSA/PyBmYWlsKGAucmVwZWF0IHdpdGggbm8gLmVuZHJlcGApO1xuICAgICAgaWYgKFRva2VuLmVxKGxpbmVbMF0sIFRva2VuLlJFUEVBVCkpIGRlcHRoKys7XG4gICAgICBpZiAoVG9rZW4uZXEobGluZVswXSwgVG9rZW4uRU5EUkVQRUFUKSkgZGVwdGgtLTtcbiAgICAgIGlmIChUb2tlbi5lcShsaW5lWzBdLCBUb2tlbi5FTkRSRVApKSBkZXB0aC0tO1xuICAgICAgbGluZXMucHVzaChsaW5lKTtcbiAgICB9XG4gICAgdGhpcy5yZXBlYXRzLnB1c2goW2xpbmVzLCB0aW1lcywgLTEsIGlkZW50XSk7XG4gICAgdGhpcy5wYXJzZUVuZFJlcGVhdChsaW5lKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VFbmRSZXBlYXQobGluZTogVG9rZW5bXSkge1xuICAgIFRva2VuLmV4cGVjdEVvbChsaW5lWzFdKTtcbiAgICBjb25zdCB0b3AgPSB0aGlzLnJlcGVhdHMucG9wKCk7XG4gICAgaWYgKCF0b3ApIHRocm93IG5ldyBFcnJvcihgLmVuZHJlcCB3aXRoIG5vIC5yZXBlYXQke1Rva2VuLmF0KGxpbmVbMF0pfWApO1xuICAgIGlmICgrK3RvcFsyXSA+PSB0b3BbMV0pIHJldHVybjtcbiAgICB0aGlzLnJlcGVhdHMucHVzaCh0b3ApO1xuICAgIHRoaXMuc3RyZWFtLnVuc2hpZnQoLi4udG9wWzBdLm1hcChsaW5lID0+IGxpbmUubWFwKHRva2VuID0+IHtcbiAgICAgIGlmICh0b2tlbi50b2tlbiAhPT0gJ2lkZW50JyB8fCB0b2tlbi5zdHIgIT09IHRvcFszXSkgcmV0dXJuIHRva2VuO1xuICAgICAgY29uc3QgdDogVG9rZW4gPSB7dG9rZW46ICdudW0nLCBudW06IHRvcFsyXX07XG4gICAgICBpZiAodG9rZW4uc291cmNlKSB0LnNvdXJjZSA9IHRva2VuLnNvdXJjZTtcbiAgICAgIHJldHVybiB0O1xuICAgIH0pKSk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlSWYoY29uZDogYm9vbGVhbikge1xuICAgIGxldCBkZXB0aCA9IDE7XG4gICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICBjb25zdCByZXN1bHQ6IFRva2VuW11bXSA9IFtdO1xuICAgIHdoaWxlIChkZXB0aCA+IDApIHtcbiAgICAgIGNvbnN0IGxpbmUgPSB0aGlzLnN0cmVhbS5uZXh0KCk7XG4gICAgICBpZiAoIWxpbmUpIHRocm93IG5ldyBFcnJvcihgRU9GIGxvb2tpbmcgZm9yIC5lbmRpZmApOyAvLyBUT0RPOiBzdGFydD9cbiAgICAgIGNvbnN0IGZyb250ID0gbGluZVswXTtcbiAgICAgIGlmIChUb2tlbi5lcShmcm9udCwgVG9rZW4uRU5ESUYpKSB7XG4gICAgICAgIGRlcHRoLS07XG4gICAgICAgIGlmICghZGVwdGgpIGJyZWFrO1xuICAgICAgfSBlbHNlIGlmIChmcm9udC50b2tlbiA9PT0gJ2NzJyAmJiBmcm9udC5zdHIuc3RhcnRzV2l0aCgnLmlmJykpIHtcbiAgICAgICAgZGVwdGgrKztcbiAgICAgIH0gZWxzZSBpZiAoZGVwdGggPT09IDEgJiYgIWRvbmUpIHtcbiAgICAgICAgaWYgKGNvbmQgJiYgKFRva2VuLmVxKGZyb250LCBUb2tlbi5FTFNFKSB8fFxuICAgICAgICAgICAgICAgICAgICAgVG9rZW4uZXEoZnJvbnQsIFRva2VuLkVMU0VJRikpKSB7XG4gICAgICAgICAgLy8gaWYgdHJ1ZSAuLi4gZWxzZSAuLi4uLlxuICAgICAgICAgIGNvbmQgPSBmYWxzZTtcbiAgICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfSBlbHNlIGlmIChUb2tlbi5lcShmcm9udCwgVG9rZW4uRUxTRUlGKSkge1xuICAgICAgICAgIC8vIGlmIGZhbHNlIC4uLiBlbHNlIGlmIC4uLi4uXG4gICAgICAgICAgY29uZCA9ICEhdGhpcy5ldmFsdWF0ZUNvbnN0KHBhcnNlT25lRXhwcihsaW5lLnNsaWNlKDEpLCBmcm9udCkpO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9IGVsc2UgaWYgKFRva2VuLmVxKGZyb250LCBUb2tlbi5FTFNFKSkge1xuICAgICAgICAgIC8vIGlmIGZhbHNlIC4uLiBlbHNlIC4uLi4uXG4gICAgICAgICAgY29uZCA9IHRydWU7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGFueXRoaW5nIGVsc2Ugb24gdGhlIGxpbmVcbiAgICAgIGlmIChjb25kKSByZXN1bHQucHVzaChsaW5lKTtcbiAgICB9XG4gICAgLy8gcmVzdWx0IGhhcyB0aGUgZXhwYW5zaW9uOiB1bnNoaWZ0IGl0XG4gICAgdGhpcy5zdHJlYW0udW5zaGlmdCguLi5yZXN1bHQpO1xuICB9XG5cbiAgICAgIC8vIGlmIChmcm9udC5zdHIgPT09ICcuZGVmaW5lJyB8fCBmcm9udC5zdHIgPT09ICcudW5kZWZpbmUnKSB7XG4gICAgICAvLyAgIGNvbnN0IG5leHQgPSBsaW5lW3BvcyArIDFdO1xuICAgICAgLy8gICBpZiAobmV4dD8udG9rZW4gPT09ICdjcycpIHtcbiAgICAgIC8vICAgICB0aGlzLmV4cGFuZFRva2VuKGxpbmUsIHBvcyArIDEpO1xuICAgICAgLy8gICAgIHJldHVybiBwb3M7XG4gICAgICAvLyAgIH0gZWxzZSBpZiAobmV4dD8udG9rZW4gPT09ICdpZGVudCcpIHtcbiAgICAgIC8vICAgICByZXR1cm4gcG9zICsgMjsgLy8gc2tpcCB0aGUgaWRlbnRpZmllclxuICAgICAgLy8gICB9XG4gICAgICAvLyB9IGVsc2UgaWYgKGZyb250LnN0ciA9PT0gJy5za2lwJykge1xuICAgICAgLy8gICBjb25zdCByZXN0ID0gbGluZS5zcGxpY2UocG9zICsgMiwgbGluZS5sZW5ndGggLSBwb3MgLSAyKTtcbiAgICAgIC8vICAgbGluZS5wb3AoKTtcbiAgICAgIC8vICAgdGhpcy5leHBhbmRUb2tlbihyZXN0LCAwKTtcbiAgICAgIC8vICAgbGluZS5wdXNoKC4uLnJlc3QpO1xuICAgICAgLy8gICByZXR1cm4gcG9zO1xuICAgICAgLy8gfSBlbHNlIHtcblxuXG4gIC8vIGRlZmluZWQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIC8vICAgcmV0dXJuIHRoaXMubWFjcm9zLmhhcyhuYW1lKSB8fFxuICAvLyAgICAgICB0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5kZWZpbmVkKG5hbWUpIHx8XG4gIC8vICAgICAgIGZhbHNlO1xuICAvLyB9XG5cbiAgLy8gdW5kZWZpbmUobmFtZTogc3RyaW5nKSB7XG4gIC8vICAgdGhpcy5tYWNyb3MuZGVsZXRlKG5hbWUpO1xuICAvLyB9XG5cbiAgLy8gLy8gRXhwYW5kcyBhIHNpbmdsZSBsaW5lIG9mIHRva2VucyBmcm9tIHRoZSBmcm9udCBvZiB0b2tzLlxuICAvLyAvLyAuZGVmaW5lIG1hY3JvcyBhcmUgZXhwYW5kZWQgaW5saW5lLCBidXQgLm1hY3JvIHN0eWxlIG1hY3Jvc1xuICAvLyAvLyBhcmUgbGVmdCBhcy1pcy4gIERvbid0IGV4cGFuZCBkZWZpbmVzIGluIGNlcnRhaW4gY2lyY3Vtc3RhbmNlcyxcbiAgLy8gLy8gc3VjaCBhcyB3aGVuIHRyeWluZyB0byBvdmVycmlkZS5cbiAgLy8gcHJpdmF0ZSBsaW5lKHRva3M6IERlcXVlPFRva2VuPik6IERlcXVlPFRva2VuPiB7XG4gIC8vICAgLy8gZmluZCB0aGUgbmV4dCBlbmQgb2YgbGluZVxuICAvLyAgIGNvbnN0IGxpbmUgPSBuZXcgRGVxdWU8VG9rZW4+KCk7XG4gIC8vICAgbGV0IGN1cmxpZXMgPSAwO1xuICAvLyAgIHdoaWxlICh0b2tzLmxlbmd0aCkge1xuICAvLyAgICAgY29uc3QgdG9rID0gdG9rcy5zaGlmdCgpO1xuICAvLyAgICAgaWYgKFRva2VuLmVxKFRva2VuLkVPTCwgdG9rKSkgYnJlYWs7XG4gIC8vICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uTEMsIHRvaykpIHtcbiAgLy8gICAgICAgY3VybGllcysrO1xuICAvLyAgICAgfSBlbHNlIGlmIChUb2tlbi5lcShUb2tlbi5SQywgdG9rKSkge1xuICAvLyAgICAgICBpZiAoLS1jdXJsaWVzIDwgMCkgdGhyb3cgbmV3IEVyb3IoYHVuYmFsYW5jZWQgY3VybHlgKTtcbiAgLy8gICAgIH1cbiAgLy8gICAgIGxpbmUucHVzaCh0b2spO1xuICAvLyAgIH1cbiAgLy8gICBpZiAoY3VybGllcykgdGhyb3cgbmV3IEVycm9yKGB1bmJhbGFuY2VkIGN1cmx5YCk7XG4gIC8vICAgLy8gbm93IGRvIHRoZSBlYXJseSBleHBhbnNpb25zXG4gIC8vICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7XG4gIC8vICAgICBjb25zdCB0b2sgPSBsaW5lLmdldChpKSE7XG4gIC8vICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uU0tJUCwgdG9rKSkge1xuICAvLyAgICAgICBjb25zdCBuZXh0ID0gbGluZS5nZXQoaSArIDEpO1xuICAvLyAgICAgICBjb25zdCBjb3VudCA9IG5leHQ/LnRva2VuID09PSAnbnVtJyA/IG5leHQubnVtIDogMTtcbiAgLy8gICAgICAgaSArPSBjb3VudDtcbiAgLy8gICAgICAgY29udGludWU7XG4gIC8vICAgICB9XG4gIC8vICAgICBpZiAodG9rLnRva2VuID09PSAnaWRlbnQnKSB7XG4gIC8vICAgICAgIGNvbnN0IG1hY3JvID0gdGhpcy5tYWNyb3MuZ2V0KHRvay5zdHIpO1xuICAvLyAgICAgICBpZiAobWFjcm8/LmV4cGFuZHNFYXJseSkge1xuICAvLyAgICAgICAgIGlmICghbWFjcm8uZXhwYW5kKGxpbmUsIGkpKSBmYWlsKHRvaywgYENvdWxkIG5vdCBleHBhbmQgJHt0b2suc3RyfWApO1xuICAvLyAgICAgICAgIGkgPSAtMTsgLy8gc3RhcnQgYmFjayBhdCB0aGUgYmVnaW5uaW5nXG4gIC8vICAgICAgICAgY29udGludWU7XG4gIC8vICAgICAgIH1cbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vICAgcmV0dXJuIGxpbmU7XG4gIC8vIH1cblxuICAvLyAqIGxpbmVzKHJlc3Q6IERlcXVlPFRva2VuPiwgZGVwdGggPSAwKTogR2VuZXJhdG9yPExpbmU+IHtcbiAgLy8gICBpZiAoZGVwdGggPiBNQVhfU1RBQ0tfREVQVEgpIHRocm93IG5ldyBFcnJvcihgbWF4IHJlY3Vyc2lvbiBkZXB0aGApO1xuICAvLyAgIHdoaWxlIChyZXN0Lmxlbmd0aCkge1xuICAvLyAgICAgLy8gbGluZXMgc2hvdWxkIGhhdmUgbm8gZGVmaW5lLW1hY3JvcyBpbiBpdCBhdCB0aGlzIHBvaW50XG4gIC8vICAgICBsZXQgbGFiZWxzID0gW107XG4gIC8vICAgICBsZXQgbGluZSA9IHRoaXMubGluZShyZXN0KTtcbiAgLy8gICAgIHdoaWxlIChsaW5lLmxlbmd0aCkge1xuICAvLyAgICAgICAvLyBsb29rIGZvciBsYWJlbHMsIGJ1dCBjb3VsZCBiZSBhIG1uZW1vbmljIG9yIG1hY3JvXG4gIC8vICAgICAgIGNvbnN0IGZyb250ID0gbGluZS5mcm9udCgpITtcbiAgLy8gICAgICAgaWYgKGZyb250LnRva2VuID09PSAnaWRlbnQnKSB7XG4gIC8vICAgICAgICAgaWYgKFRva2VuLmVxKFRva2VuLkNPTE9OLCBsaW5lLmdldCgxKSkpIHtcbiAgLy8gICAgICAgICAgIC8vIGl0J3MgYSBsYWJlbFxuICAvLyAgICAgICAgICAgbGFiZWxzLnB1c2goZnJvbnQuc3RyKTtcbiAgLy8gICAgICAgICAgIGxpbmUuc3BsaWNlKDAsIDIpO1xuICAvLyAgICAgICAgICAgY29udGludWU7XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICAgIC8vIGNoZWNrIGZvciBhIG1hY3JvXG4gIC8vICAgICAgICAgY29uc3QgbWFjcm8gPSB0aGlzLm1hY3Jvcy5nZXQoZnJvbnQuc3RyKTtcbiAgLy8gICAgICAgICBpZiAobWFjcm8pIHtcbiAgLy8gICAgICAgICAgIGlmIChtYWNyby5leHBhbmRzRWFybHkpIHRocm93IG5ldyBFcnJvcihgZWFybHkgbWFjcm8gbGF0ZWApO1xuICAvLyAgICAgICAgICAgaWYgKCFtYWNyby5leHBhbmQobGluZSkpIHRocm93IG5ldyBFcnJvcihgYmFkIGV4cGFuc2lvbmApO1xuICAvLyAgICAgICAgICAgLy8gYnkgcmVjdXJzaW5nIHJhdGhlciB0aGFuIHVuc2hpZnRpbmcgd2UgY2FuIHN1cHBvcnQgLmV4aXRtYWNybz9cbiAgLy8gICAgICAgICAgIHlpZWxkICogdGhpcy5saW5lcyhsaW5lLCBkZXB0aCArIDEpO1xuICAvLyAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICAgIC8vIGl0J3MgYSByZWd1bGFyIG1uZW1vbmljXG4gIC8vICAgICAgICAgeWllbGQge2xhYmVscywgdG9rZW5zOiBbLi4ubGluZV19O1xuICAvLyAgICAgICAgIGJyZWFrO1xuICAvLyAgICAgICB9IGVsc2UgaWYgKFRva2VuLmVxKFRva2VuLkNPTE9OLCBmcm9udCkpIHsgLy8gc3BlY2lhbCBsYWJlbFxuICAvLyAgICAgICAgIGxhYmVscy5wdXNoKCc6Jyk7XG4gIC8vICAgICAgICAgbGluZS5zaGlmdCgpO1xuICAvLyAgICAgICAgIGNvbnRpbnVlO1xuICAvLyAgICAgICB9IGVsc2UgaWYgKGZyb250LnRva2VuID09PSAnb3AnKSB7XG4gIC8vICAgICAgICAgLy8gb3RoZXIgc3BlY2lhbCBsYWJlbHNcbiAgLy8gICAgICAgICBpZiAoL14oXFwrK3wtKykkLy50ZXN0KGZyb250LnN0cikpIHtcbiAgLy8gICAgICAgICAgIGxhYmVscy5wdXNoKGZyb250LnN0cik7XG4gIC8vICAgICAgICAgICBsaW5lLnNoaWZ0KCk7XG4gIC8vICAgICAgICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uQ09MT04sIGxpbmUuZnJvbnQoKSkpIGxpbmUuc2hpZnQoKTtcbiAgLy8gICAgICAgICAgIGNvbnRpbnVlO1xuICAvLyAgICAgICAgIH1cbiAgLy8gICAgICAgICAvLyBvdGhlcndpc2UuLi4gc3ludGF4IGVycm9yPyBhbnkgb3RoZXIgb3BlcmF0b3IgYWxsb3dlZD9cbiAgLy8gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN5bnRheCBlcnJvcjogdW5leHBlY3RlZCAke1Rva2VuLm5hbWVBdChmcm9udCl9YCk7XG4gIC8vICAgICAgIH0gZWxzZSBpZiAoZnJvbnQudG9rZW4gPT09ICdjcycpIHtcbiAgLy8gICAgICAgICBzd2l0Y2ggKGZyb250LnN0cikge1xuICAvLyAgICAgICAgICAgY2FzZSAnLmV4aXRtYWNybyc6XG4gIC8vICAgICAgICAgICAgIGxpbmUgPSBuZXcgRGVxdWUoKTsgLy8gbm8gbW9yZSBleHBhbnNpb25cbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcuaWZkZWYnOlxuICAvLyAgICAgICAgICAgICAvLyBUT0RPIC0gY2FsbCBoZWxwZXIgbWV0aG9kPyBidXQgaG93PyBjbG9zdXJlP1xuICAgICAgICAgICAgICBcbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcuZGVmaW5lJzpcbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcubWFjcm8nOlxuICAvLyAgICAgICAgICAgICBicmVhaztcbiAgLy8gICAgICAgICB9XG4gIC8vICAgICAgIH1cbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vIH1cbn1cblxuLy8gSGFuZGxlcyBzY29wZWQgbmFtZXMsIHRvby5cbmZ1bmN0aW9uIHBhcnNlT25lSWRlbnQodHM6IFRva2VuW10sIHByZXY/OiBUb2tlbik6IHN0cmluZyB7XG4gIGNvbnN0IGUgPSBwYXJzZU9uZUV4cHIodHMsIHByZXYpO1xuICByZXR1cm4gRXhwci5pZGVudGlmaWVyKGUpO1xufVxuXG5mdW5jdGlvbiBwYXJzZU9uZUV4cHIodHM6IFRva2VuW10sIHByZXY/OiBUb2tlbik6IEV4cHIge1xuICBpZiAoIXRzLmxlbmd0aCkge1xuICAgIGlmICghcHJldikgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBleHByZXNzaW9uYCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBleHByZXNzaW9uOiAke1Rva2VuLm5hbWVBdChwcmV2KX1gKTtcbiAgfVxuICByZXR1cm4gRXhwci5wYXJzZU9ubHkodHMpO1xufVxuXG5mdW5jdGlvbiBub0dhcmJhZ2UodG9rZW46IFRva2VufHVuZGVmaW5lZCk6IHZvaWQge1xuICBpZiAodG9rZW4pIHRocm93IG5ldyBFcnJvcihgZ2FyYmFnZSBhdCBlbmQgb2YgbGluZTogJHtUb2tlbi5uYW1lQXQodG9rZW4pfWApO1xufVxuXG4vLyBmdW5jdGlvbiBmYWlsKHQ6IFRva2VuLCBtc2c6IHN0cmluZyk6IG5ldmVyIHtcbi8vICAgY29uc3QgcyA9IHQuc3RyZWFtO1xuLy8gICBpZiAocykge1xuLy8gICAgIG1zZyArPSBgXFxuICBhdCAke3MuZmlsZX06JHtzLmxpbmV9OiR7cy5jb2x1bW59OiBUb2tlbi5uYW1lKHQpYDtcbi8vICAgICAvLyBUT0RPIC0gZXhwYW5kZWQgZnJvbT9cbi8vICAgfVxuLy8gICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbi8vIH1cblxuZnVuY3Rpb24gYmFkQ2xvc2Uob3Blbjogc3RyaW5nLCB0b2s6IFRva2VuKTogbmV2ZXIge1xuICB0aHJvdyBuZXcgRXJyb3IoYCR7VG9rZW4ubmFtZSh0b2spfSB3aXRoIG5vICR7b3Blbn0ke1Rva2VuLmF0KHRvayl9YCk7XG59XG5cbmZ1bmN0aW9uIGZhaWwobXNnOiBzdHJpbmcpOiBuZXZlciB7XG4gIHRocm93IG5ldyBFcnJvcihtc2cpO1xufVxuIl19