(function(){'use strict';var m=m||{};m.scope={};m.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};m.arrayIterator=function(a){return{next:m.arrayIteratorImpl(a)}};m.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):m.arrayIterator(a)};
m.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};m.global=m.getGlobal(this);m.ASSUME_ES5=!1;m.ASSUME_NO_NATIVE_MAP=!1;m.ASSUME_NO_NATIVE_SET=!1;m.SIMPLE_FROUND_POLYFILL=!1;
m.defineProperty=m.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};m.polyfill=function(a,b){if(b){var c=m.global;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&m.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};m.FORCE_POLYFILL_PROMISE=!1;m.SYMBOL_PREFIX="jscomp_symbol_";
m.initSymbol=function(){m.initSymbol=function(){};m.global.Symbol||(m.global.Symbol=m.Symbol)};m.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;m.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};m.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};m.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new m.SymbolClass(m.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
m.initSymbolIterator=function(){m.initSymbol();var a=m.global.Symbol.iterator;a||(a=m.global.Symbol.iterator=m.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&m.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return m.iteratorPrototype(m.arrayIteratorImpl(this))}});m.initSymbolIterator=function(){}};
m.initSymbolAsyncIterator=function(){m.initSymbol();var a=m.global.Symbol.asyncIterator;a||(a=m.global.Symbol.asyncIterator=m.global.Symbol("Symbol.asyncIterator"));m.initSymbolAsyncIterator=function(){}};m.iteratorPrototype=function(a){m.initSymbolIterator();a={next:a};a[m.global.Symbol.iterator]=function(){return this};return a};m.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
m.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:m.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;m.generator={};m.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};
m.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};m.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};m.generator.Context.prototype.stop_=function(){this.isRunning_=!1};
m.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};m.generator.Context.prototype.next_=function(a){this.yieldResult=a};m.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};m.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};
m.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};m.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};m.generator.Context.prototype.yieldAll=function(a,b){a=m.makeIterator(a);var c=a.next();m.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};
m.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};m.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};m.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};m.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};m.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
m.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};m.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
m.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};m.generator.Context.prototype.forIn=function(a){return new m.generator.Context.PropertyIterator(a)};
m.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};m.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};m.generator.Engine_=function(a){this.context_=new m.generator.Context;this.program_=a};
m.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};m.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(a){return{value:a,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
m.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
m.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);m.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
m.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
m.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};m.initSymbolIterator();this[Symbol.iterator]=function(){return this}};m.generator.createGenerator=function(a,b){b=new m.generator.Generator_(new m.generator.Engine_(b));m.setPrototypeOf&&m.setPrototypeOf(b,a.prototype);return b};
m.asyncExecutePromiseGenerator=function(a){function b(b){return a.next(b)}function c(b){return a.throw(b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};m.asyncExecutePromiseGeneratorFunction=function(a){return m.asyncExecutePromiseGenerator(a())};m.asyncExecutePromiseGeneratorProgram=function(a){return m.asyncExecutePromiseGenerator(new m.generator.Generator_(new m.generator.Engine_(a)))};
m.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};m.stringPadding=function(a,b){a=void 0!==a?String(a):" ";return 0<b&&a?a.repeat(Math.ceil(b/a.length)).substring(0,b):""};
m.polyfill("String.prototype.padStart",function(a){return a?a:function(a,c){var b=m.checkStringArgs(this,null,"padStart");return m.stringPadding(c,a-b.length)+b}},"es8","es3");m.iteratorFromArray=function(a,b){m.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
m.polyfill("Array.prototype.values",function(a){return a?a:function(){return m.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");m.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");m.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
m.polyfill("Object.entries",function(a){return a?a:function(a){var b=[],d;for(d in a)m.owns(a,d)&&b.push([d,a[d]]);return b}},"es8","es3");m.polyfill("globalThis",function(a){return a||m.global},"es_2020","es3");m.polyfill("Array.prototype.flatMap",function(a){return a?a:function(a,c){for(var b=[],e=0;e<this.length;e++){var f=a.call(c,this[e],e,this);Array.isArray(f)?b.push.apply(b,f):b.push(f)}return b}},"es9","es5");
m.polyfill("Object.values",function(a){return a?a:function(a){var b=[],d;for(d in a)m.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");m.polyfill("String.prototype.padEnd",function(a){return a?a:function(a,c){var b=m.checkStringArgs(this,null,"padStart");return b+m.stringPadding(c,a-b.length)}},"es8","es3");class aa{constructor(a){this.buffer=Array(16);this.mask=15;this.size=this.end=this.start=0;a&&this.push(...a)}[Symbol.iterator](){let a=0;return{next:()=>a>=this.size?{value:void 0,done:!0}:{value:this.buffer[this.start+a++&this.mask],done:!1},[Symbol.iterator](){return this}}}get length(){return this.size}upsize(a){for(;this.mask<=a;)this.end<this.start&&(this.start+=this.mask+1),this.mask=this.mask<<1|1,this.buffer=this.buffer.concat(this.buffer);this.size=a}push(...a){this.upsize(this.size+a.length);
for(const b of a)this.buffer[this.end]=b,this.end=this.end+1&this.mask}pop(){if(this.size)return this.end=this.end-1&this.mask,this.size--,this.buffer[this.end]}peek(){if(this.size)return this.buffer[this.end-1&this.mask]}unshift(...a){this.upsize(this.size+a.length);let b=this.start=this.start-a.length&this.mask;for(const c of a)this.buffer[b++&this.mask]=c}shift(){if(this.size){var a=this.buffer[this.start];this.start=this.start+1&this.mask;this.size--;return a}}front(){if(this.size)return this.buffer[this.start]}get(a){if(!(a>=
this.size))return this.buffer[this.start+a&this.mask]}slice(a,b=this.size){0>a&&(a+=this.size);0>b&&(b+=this.size);if(b<=a)return[];a=this.start+Math.max(0,Math.min(this.size,a))&this.mask;b=this.start+Math.max(0,Math.min(this.size,b))&this.mask;return a<=b?this.buffer.slice(a,b):this.buffer.slice(a).concat(this.buffer.slice(0,b))}splice(a,b,...c){0>a&&(a+=this.size);a=Math.max(0,Math.min(this.size,a));b=Math.max(0,Math.min(this.size-a,b));var d=a+b;b=c.length-b;const e=this.slice(a,d);this.upsize(this.size+
b);this.size-=b;if(0===a)for(this.start=this.start-b&this.mask,a=0;a<c.length;a++)this.buffer[this.start+a&this.mask]=c[a];else if(d===this.size)for(this.end=this.end+b&this.mask,a+=this.start,d=0;d<c.length;d++)this.buffer[a+d&this.mask]=c[d];else c=[...this.slice(0,a),...c,...this.slice(d)],c.length=this.buffer.length,this.buffer=c,this.start=0,this.end=this.size;this.size+=b;return e}toString(){const a=Array(this.size);for(let b=0;b<this.size;b++)a[b]=this.buffer[this.start+b&this.mask];return`[${a.join(", ")}]`}}
class ca extends Error{}class da extends Map{constructor(a,b){super(b);this.supplier=a}get(a){let b=super.get(a);null==b&&super.set(a,b=this.supplier(a));return b}sortedKeys(a){return[...this.keys()].sort(a)}sortedEntries(a){return this.sortedKeys(a).map(a=>[a,this.get(a)])}}var ha;
(function(a){a.concat=function*(...a){for(const b of a)yield*b};a.isEmpty=function(a){return!!a[Symbol.iterator]().next().done};a.map=function*(a,c){for(const b of a)yield c(b)};a.filter=function*(a,c){for(const b of a)c(b)&&(yield b)};a.flatMap=function*(a,c){for(const b of a)yield*c(b)};a.count=function(a){let b=0;for(const c of a)b++;return b};a.take=function*(a,c){for(const b of a){if(0>--c)break;yield b}};a.first=function(a,c){for(const b of a)return b;if(2>arguments.length)throw Error(`Empty iterable: ${a}`);
return c};a.zip=function(a,c,d=(a,b)=>[a,b]){return{*[Symbol.iterator](){const b=a[Symbol.iterator](),f=c[Symbol.iterator]();let g,h;for(;g=b.next(),h=f.next(),!g.done&&!h.done;)yield d(g.value,h.value)}}}})(ha||(ha={}));function ia(a){return[...a]}class ja{constructor(){this.map=new Map}add(a){this.map.set(a.label,a)}has(a){return this.map.has(a.label)}delete(a){this.map.delete(a.label)}[Symbol.iterator](){return this.map.values()}}const ka=Symbol("Invalidated"),la=Symbol("Size");
class ma{constructor(a,b,c){this.ownerMap=a;this.ownerKey=b;this.currentSet=c}getCurrentSet(){if(!this.currentSet||this.currentSet[ka])this.currentSet=this.ownerMap.get(this.ownerKey)||new Set;return this.currentSet}mutateSet(a){const b=this.getCurrentSet(),c=b.size;try{return a(b)}finally{this.ownerMap[la]+=b.size-c,b.size||(this.ownerMap.delete(this.ownerKey),b[ka]=!0)}}add(a){this.mutateSet(b=>b.add(a));return this}has(a){return this.getCurrentSet().has(a)}clear(){this.mutateSet(a=>a.clear())}delete(a){return this.mutateSet(b=>
b.delete(a))}[Symbol.iterator](){return this.getCurrentSet()[Symbol.iterator]()}values(){return this.getCurrentSet().values()}keys(){return this.getCurrentSet().keys()}entries(){return this.getCurrentSet().entries()}forEach(a,b){this.getCurrentSet().forEach(a,b)}get size(){return this.getCurrentSet().size}get [Symbol.toStringTag](){return"Set"}}Reflect.setPrototypeOf(ma.prototype,Set.prototype);
class na{constructor(a=[]){this.entries=new da(()=>0,a)}add(a){this.entries.set(a,this.entries.get(a)+1)}delete(a){const b=this.entries.get(a)-1;0<b?this.entries.set(a,b):this.entries.delete(a)}unique(){return this.entries.size}count(a){return this.entries.has(a)?this.entries.get(a):0}[Symbol.iterator](){return this.entries.entries()}}function oa(a){throw Error(`non-exhaustive check: ${a}`);}
class pa{constructor(a){this.data=a}get(a){return this.data[a]}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}}
class qa{constructor(a){this.data=a;const b=new Map;for(let c=0;c<a.length;c++)b.set(a[c],c);this.rev=b;this.length=a.length}get(a){return this.data[a]}hasValue(a){return this.rev.has(a)}index(a){const b=this.rev.get(a);if(null==b)throw Error(`Missing index for ${a}`);return b}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}}
class ra{constructor(){this._fwd=[];this._rev=[]}*[Symbol.iterator](){for(let a=0;a<this._fwd.length;a++){const b=this._fwd[a];null!=b&&(yield[a,b])}}*keys(){for(let a=0;a<this._fwd.length;a++)null!=this._fwd[a]&&(yield a)}*values(){for(let a=0;a<this._rev.length;a++)null!=this._rev[a]&&(yield a)}get(a){return this._fwd[a]}has(a){return null!=this._fwd[a]}hasValue(a){return null!=this._rev[a]}index(a){const b=this._rev[a];if(null==b)throw Error(`Missing index for ${a}`);return b}set(a,b){if(this._fwd[a])throw Error(`already has key ${a}`);
if(this._rev[b])throw Error(`already has value ${b}`);this._fwd[a]=b;this._rev[b]=a}replace(a,b){var c=this._rev[b];null!=c&&delete this._fwd[c];c=this._fwd[a];null!=c&&delete this._rev[c];this._fwd[a]=b;this._rev[b]=a;return c}}
class ta{constructor(a){this._map=new Map;if(a)for(const [b,c,d]of a)this.set(b,c,d)}*[Symbol.iterator](){for(const [a,b]of this._map)for(const [c,d]of b)yield[a,c,d]}set(a,b,c){let d=this._map.get(a);d||this._map.set(a,d=new Map);d.set(b,c)}get(a,b){var c;return null===(c=this._map.get(a))||void 0===c?void 0:c.get(b)}has(a,b){var c;return(null===(c=this._map.get(a))||void 0===c?void 0:c.has(b))||!1}delete(a,b){const c=this._map.get(a);c&&(c.delete(b),c.size||this._map.delete(a))}row(a){var b;return null!==
(b=this._map.get(a))&&void 0!==b?b:new Map}}var ua;(function(a){a.NONE={get requested(){return!1},throwIfRequested(){},register(){return{unregister(){}}}};a.CANCELLED={get requested(){return!0},throwIfRequested(){throw Error("cancelled");},register(){return{unregister(){}}}}})(ua||(ua={}));function va(a,b=1){return 0>a?`~${(~a).toString(16).padStart(b,"0")}`:a.toString(16).padStart(b,"0")};class wa{constructor(a){this.table=a}op(a){const b=this.table[a];if(!b)throw Error(`Bad mnemonic: ${a}`);return b}argLen(a){switch(a){case "acc":case "imp":return 0;case "imm":case "rel":case "zpg":case "zpx":case "zpy":case "iny":return 1;case "abs":case "abx":case "aby":case "ind":case "inx":return 2}return oa(a)}}var xa;
(xa||(xa={})).P02=new wa({adc:{abs:109,abx:125,aby:121,imm:105,iny:113,inx:97,zpg:101,zpx:117},and:{abs:45,abx:61,aby:57,imm:41,iny:49,inx:33,zpg:37,zpx:53},asl:{abs:14,abx:30,acc:10,imp:10,zpg:6,zpx:22},bcc:{rel:144},bcs:{rel:176},beq:{rel:240},bit:{abs:44,zpg:36},bmi:{rel:48},bne:{rel:208},bpl:{rel:16},brk:{imp:0},bvc:{rel:80},bvs:{rel:112},clc:{imp:24},cld:{imp:216},cli:{imp:88},clv:{imp:184},cmp:{abs:205,abx:221,aby:217,imm:201,iny:209,inx:193,zpg:197,zpx:213},cpx:{abs:236,imm:224,zpg:228},cpy:{abs:204,
imm:192,zpg:196},dec:{abs:206,abx:222,zpg:198,zpx:214},dex:{imp:202},dey:{imp:136},eor:{abs:77,abx:93,aby:89,imm:73,iny:81,inx:65,zpg:69,zpx:85},inc:{abs:238,abx:254,zpg:230,zpx:246},inx:{imp:232},iny:{imp:200},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{abs:173,abx:189,aby:185,imm:169,iny:177,inx:161,zpg:165,zpx:181},ldx:{abs:174,aby:190,imm:162,zpg:166,zpy:182},ldy:{abs:172,abx:188,imm:160,zpg:164,zpx:180},lsr:{abs:78,abx:94,acc:74,imp:74,zpg:70,zpx:86},nop:{imp:234},ora:{abs:13,abx:29,aby:25,imm:9,
iny:17,inx:1,zpg:5,zpx:21},pha:{imp:72},php:{imp:8},pla:{imp:104},plp:{imp:40},rol:{abs:46,abx:62,acc:42,imp:42,zpg:38,zpx:54},ror:{abs:110,abx:126,acc:106,imp:106,zpg:102,zpx:118},rti:{imp:64},rts:{imp:96},sbc:{abs:237,abx:253,aby:249,imm:233,iny:241,inx:225,zpg:229,zpx:245},sec:{imp:56},sed:{imp:248},sei:{imp:120},sta:{abs:141,abx:157,aby:153,iny:145,inx:129,zpg:133,zpx:149},stx:{abs:142,zpg:134,zpy:150},sty:{abs:140,zpg:132,zpx:148},tax:{imp:170},tay:{imp:168},tsx:{imp:186},txa:{imp:138},txs:{imp:154},
tya:{imp:152}});var ya;(function(a){class b{next(){for(;;){this.sink||(this.sink=this.pump());const {value:a,done:b}=this.sink.next();if(!b)return a;this.sink=void 0}}}a.Abstract=b;a.concat=function(...a){let b;return{next:()=>{for(;;){b||(b=a.shift());if(!b)break;const c=b.next();if(c)return c;b=void 0}}}}})(ya||(ya={}));var p;
(function(a){function b(a,b){return a&&b&&a.token===b.token&&"grp"!==a.token&&a.str===b.str&&a.num===b.num?!0:!1}function c(a){switch(a.token){case "num":return`NUM[$${a.num.toString(16)}]`;case "str":return`STR[$${a.str}]`;case "lb":return"[";case "rb":return"]";case "grp":return"{";case "lc":return"{";case "rc":return"}";case "lp":return"(";case "rp":return")";case "eol":return"EOL";case "eof":return"EOF";case "ident":return a.str;case "cs":case "op":return`${a.str.toUpperCase()}`;default:oa(a)}}
function d(a){a=a.source;if(!a)return"";const b=a.parent?d({source:a.parent}):"";return`\n  at ${a.file}:${a.line}:${a.column}${b}`}function e(a){return c(a)+d(a)}function f(a,b){return g("ident","identifier",a,b)}function g(a,b,c,d){if(!c){if(!d)throw Error(`Expected ${b}`);throw Error(`Expected ${b} after ${e(d)}`);}if(c.token!==a)throw Error(`Expected ${b}: ${e(c)}`);return c.str}function h(a,c,d){for(;d<a.length;d++)if(b(a[d],c))return d;return-1}function k(a){let b=0;for(const c of a)"grp"===
c.token?b+=2+k(c.inner):b++;return b}a.LB={token:"lb"};a.LC={token:"lc"};a.LP={token:"lp"};a.RB={token:"rb"};a.RC={token:"rc"};a.RP={token:"rp"};a.EOL={token:"eol"};a.EOF={token:"eof"};a.DEFINE={token:"cs",str:".define"};a.DOT_EOL={token:"cs",str:".eol"};a.ELSE={token:"cs",str:".else"};a.ELSEIF={token:"cs",str:".elseif"};a.ENDIF={token:"cs",str:".endif"};a.ENDMAC={token:"cs",str:".endmac"};a.ENDMACRO={token:"cs",str:".endmacro"};a.ENDREP={token:"cs",str:".endrep"};a.ENDREPEAT={token:"cs",str:".endrepeat"};
a.ENDPROC={token:"cs",str:".endproc"};a.ENDSCOPE={token:"cs",str:".endscope"};a.LOCAL={token:"cs",str:".local"};a.MACRO={token:"cs",str:".macro"};a.REPEAT={token:"cs",str:".repeat"};a.SET={token:"cs",str:".set"};a.SKIP={token:"cs",str:".skip"};a.BYTE={token:"cs",str:".byte"};a.WORD={token:"cs",str:".word"};a.COLON={token:"op",str:":"};a.COMMA={token:"op",str:","};a.STAR={token:"op",str:"*"};a.IMMEDIATE={token:"op",str:"#"};a.ASSIGN={token:"op",str:"="};a.match=function(a,b){return a.token!==b.token?
!1:"num"===a.token||"str"===a.token?!0:a.str!==b.str?!1:!0};a.eq=b;a.name=c;a.at=d;a.nameAt=e;a.expectEol=function(b,c="end of line"){if(b)throw Error(`Expected ${c}: ${a.nameAt(b)}`);};a.expect=function(a,d,f){if(!d){if(!f)throw Error(`Expected ${c(a)}`);throw Error(`Expected ${c(a)} after ${e(d)}`);}if(!b(a,d))throw Error(`Expected ${c(a)}: ${e(d)}`);};a.expectIdentifier=f;a.expectString=function(a,b){return g("str","constant string",a,b)};a.identsFromCList=function(c){if(!c.length)return[];const d=
[];for(let f=0;f<=c.length;f+=2){const g=c[f];if("ident"!==(null===g||void 0===g?void 0:g.token)){if(g)throw Error(`Expected identifier: ${e(g)}`);throw Error(`Expected identifier after ${e(c[c.length-1])}`);}if(f+1<c.length&&!b(c[f+1],a.COMMA))throw Error(`Expected comma: ${e(c[f+1])}`);d.push(g.str)}return d};a.findBalanced=function(a,b){const c=a[b++].token;if("lp"!==c&&"lb"!==c)throw Error("non-grouping token");const d="lp"===c?"rp":"rb";let e=1;for(;b<a.length;b++){const f=a[b].token;e+=Number(f===
c)-Number(f===d);if(!e)return b}return-1};a.parseArgList=function(c,e=0,f=c.length){let g=[];const h=[g];let k=0;for(;e<f;e++){const f=c[e];if(!k&&b(f,a.COMMA))h.push(g=[]);else if(g.push(f),b(f,a.LP)&&k++,b(f,a.RP)&&0>--k)throw Error(`Unbalanced paren${d(f)}`);}return h};a.parseAttrList=function(c,g){const h=new Map;let k,l=[];if(g>=c.length)return h;if(!b(c[g],a.COLON))throw Error(`Unexpected: ${e(c[g])}`);for(g+=1;g<c.length;g++){const e=c[g];if(b(e,a.COLON)){if(null==k)throw Error(`Missing key${d(e)}`);
h.set(k,l);k=void 0;l=[]}else null==k?k=f(e):l.push(e)}null!=k?h.set(k,l):f(void 0,c[c.length-1]);return h};a.findComma=function(b,c){c=h(b,a.COMMA,c);return 0>c?b.length:c};a.find=h;a.count=k;a.isRegister=function(a,b){return"ident"===a.token&&a.str.toLowerCase()===b};a.str=function(b){switch(b.token){case "cs":case "ident":case "str":case "op":return b.str}throw Error(`Non-string token: ${a.nameAt(b)}`);};a.strip=function(a){delete a.source;return a}})(p||(p={}));new Set(".blank .const .defined .left .match .mid .right .tcount .xmatch".split(" "));var za;
(function(a){function b(a){return a.source?{source:{parent:a.source,file:"js",line:0,column:0}}:{}}function c(a,b){function c(a){return a.args?Object.assign({},a,{args:a.args.map(b=>d(b,a))}):a}function d(a,d){const e=a.source;a=b(a,c,d);e&&!a.source&&(a.source=e);return a}return d(a)}function d(a,b){b=void 0===b?0:b;const [c,d]=e(a,b);if(d<a.length)throw e(a,b),Error(`Garbage after expression: ${p.nameAt(a[d])}`);if(!c)throw Error("No expression?");return c}function e(a,b){function c(){const [a,[,
,b]]=e.pop(),c=f.splice(f.length-b,b);if(c.length!==b)throw Error("shunting parse failed?");f.push(Aa({op:a,args:c}))}b=void 0===b?0:b;const e=[],f=[];for(var g=!0,h=b;h<a.length;h++){var k=a[h];if(g)if("cs"===k.token||"op"===k.token){var l=Ba.get(k.str);if(l=Da.get(null!==l&&void 0!==l?l:k.str))e.push([k.str,l]);else if("cs"===k.token){g=k.str;if(!Ea.has(g))throw Error(`No such function: ${p.nameAt(k)}`);l=a[h+1];if("lp"!==(null===l||void 0===l?void 0:l.token))throw Error(`Bad funcall: ${p.nameAt(null!==
l&&void 0!==l?l:k)}`);k=p.findBalanced(a,h+1);if(0>k)throw Error(`Never closed: ${p.nameAt(l)}`);l=[];for(const b of p.parseArgList(a,h+2,k))l.push(d(b));h=k;f.push(Aa({op:g,args:l}));g=!1}else if(p.eq(k,p.STAR))f.push({op:"sym",sym:"*"}),g=!1;else throw Error(`Unknown prefix operator: ${p.nameAt(k)}`);}else if("lp"===k.token){g=p.findBalanced(a,h);if(0>g)throw Error(`No close paren: ${p.nameAt(k)}`);h=d(a.slice(h+1,g));f.push(h);h=g;g=!1}else if("ident"===k.token)f.push({op:"sym",sym:k.str}),g=!1;
else if("num"===k.token)k=k.num,f.push({op:"num",num:k,meta:Fa(k)}),g=!1;else throw Error(`Bad expression token: ${p.nameAt(k)}`);else{if(p.eq(k,p.COMMA))break;if("cs"===k.token||"op"===k.token){g=Ba.get(k.str);g=Ga.get(null!==g&&void 0!==g?g:k.str);if(!g)break;for(;e.length;){l=e[e.length-1];const a=Ka(l[1],g);if(0>a)break;if(0===a)throw Error(`Mixing ${l[0]} and ${k.str} needs explicit parens.${p.at(k)}`);c()}e.push([k.str,g]);g=!0}else break}}for(;e.length;)c();if(1!==f.length)throw Error("shunting parse failed?");
a[b].source&&(f[0].source=a[b].source);return[f[0],h]}function f(a){if(null!=a)return{op:"num",num:a,meta:Fa(a)}}function g(a,b){const c=a.args[0];if(!n(c))return a;a=b(c.num);return{op:"num",num:a,meta:Fa(a)}}function h(a,b){const [c,d]=a.args;if(!n(c)||!n(d))return a;a=b(c.num,d.num);return{op:"num",num:a,meta:Fa(a)}}function k(a){var b,c,d,e,f,g;const [h,k]=a.args;if("num"!==h.op||"num"!==k.op)return a;const l={op:"num",num:h.num+k.num};if(h.meta||k.meta){if((null===(b=h.meta)||void 0===b?0:b.rel)&&
(null===(c=k.meta)||void 0===c?0:c.rel))return a;if(null===(d=h.meta)||void 0===d?0:d.rel)l.meta=h.meta;else if(null===(e=k.meta)||void 0===e?0:e.rel)l.meta=k.meta}null!==(f=l.meta)&&void 0!==f&&f.rel||null!=(null===(g=l.meta)||void 0===g?void 0:g.size)||((l.meta||(l.meta={})).size=Fa(l.num).size);return l}function l(a){var b,c,d,e,f;const [g,h]=a.args;if("num"!==g.op||"num"!==h.op)return a;const k={op:"num",num:g.num-h.num};if(null===(b=h.meta)||void 0===b?0:b.rel)return(null===(c=g.meta)||void 0===
c?0:c.rel)&&g.meta.chunk===h.meta.chunk?k:a;if(null===(d=g.meta)||void 0===d?0:d.rel)k.meta=g.meta;null!==(e=k.meta)&&void 0!==e&&e.rel||null!=(null===(f=k.meta)||void 0===f?void 0:f.size)||((k.meta||(k.meta={})).size=Fa(k.num).size);return k}function n(a){var b;return"num"===a.op&&!(null===(b=a.meta)||void 0===b?0:b.rel)}a.loByte=function(a){return Object.assign({},{op:"<",args:[a]},b(a))};a.hiByte=function(a){return Object.assign({},{op:">",args:[a]},b(a))};a.traverse=c;a.traversePost=function(a,
b){return c(a,(a,c)=>b(c(a)))};a.evaluate=function(a){var b,c,d,e;switch(a.op){case ".move":case "im":case "sym":return a;case "num":return(null===(b=a.meta)||void 0===b?0:b.rel)&&null!=a.meta.org?(b=Object.assign({},a.meta),b=(delete b.rel,b),{op:"num",num:a.num+b.org,meta:b}):a;case ".max":throw Error();case ".min":throw Error();}if(1===(null===(c=a.args)||void 0===c?void 0:c.length))switch(a.op){case "+":return a.args[0];case "-":return g(a,a=>-a);case "~":return g(a,a=>~a);case "!":return g(a,
a=>+!a);case "<":return g(a,a=>a&255);case ">":return g(a,a=>a>>8&255);case "^":return null!==(e=f(null===(d=a.args[0].meta)||void 0===d?void 0:d.bank))&&void 0!==e?e:a;default:throw Error(`Unknown unary operator: ${a.op}`);}switch(a.op){case "+":return k(a);case "-":return l(a);case "*":return h(a,(a,b)=>a*b);case "/":return h(a,(a,b)=>Math.floor(a/b));case ".mod":return h(a,(a,b)=>a%b);case "&":return h(a,(a,b)=>a&b);case "|":return h(a,(a,b)=>a|b);case "^":return h(a,(a,b)=>a^b);case "<<":return h(a,
(a,b)=>a<<b);case ">>":return h(a,(a,b)=>a>>>b);case "<":return h(a,(a,b)=>+(a<b));case "<=":return h(a,(a,b)=>+(a<=b));case ">":return h(a,(a,b)=>+(a>b));case ">=":return h(a,(a,b)=>+(a>=b));case "=":return h(a,(a,b)=>+(a==b));case "<>":return h(a,(a,b)=>+(a!=b));case "&&":return h(a,(a,b)=>a&&b);case "||":return h(a,(a,b)=>a||b);case ".xor":return h(a,(a,b)=>!a&&b||!b&&a||0);default:throw Error(`Unknown operator: ${a.op}`);}};a.identifier=function(a){if("sym"===a.op&&a.sym)return a.sym;throw Error(`Expected identifier but got op: ${a.op}`);
};a.parseOnly=d;a.parse=e})(za||(za={}));function Ka(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:a[1]!==b[1]?0:a[1]}
const Ga=new Map([["*",[5,4,2]],["/",[5,4,2]],[".mod",[5,3,2]],["&",[5,2,2]],["^",[5,1,2]],["<<",[5,0,2]],[">>",[5,0,2]],["+",[4,2,2]],["-",[4,2,2]],["|",[4,1,2]],["<",[3,0,2]],["<=",[3,0,2]],[">",[3,0,2]],[">=",[3,0,2]],["=",[3,0,2]],["<>",[3,0,2]],["&&",[2,3,2]],[".xor",[2,2,2]],["||",[2,1,2]]]),Da=new Map([["+",[9,-1,1]],["-",[9,-1,1]],["~",[9,-1,1]],["<",[9,-1,1]],[">",[9,-1,1]],["^",[9,-1,1]],["!",[2,-1,1]]]),Ea=new Set([".byteat",".wordat",".max",".min"]),Ba=new Map([[".bitand","&"],[".bitxor",
"^"],[".bitor","|"],[".shl","<<"],[".shr",">>"],[".and","&&"],[".or","||"],[".bitnot","~"],[".lobyte","<"],[".hibyte",">"],[".bankbyte","^"],[".not","!"]]),La=new Map([["^",(...a)=>1===a.length?1:Math.max(...a)],["<",()=>1],[">",()=>1],["!",()=>1],["<=",()=>1],[">=",()=>1],["<>",()=>1],["=",()=>1],["&",Math.max],["&&",Math.max],["|",Math.max],["||",Math.max],[".xor",Math.max],[".max",Math.max],[".min",Math.max]]);
function Aa(a){var b=La.get(a.op);if(b=null===b||void 0===b?void 0:b(...a.args.map(a=>{var b;return Number(null===(b=a.meta)||void 0===b?void 0:b.size)})))(a.meta||(a.meta={})).size=b;return a}function Fa(a){return{size:0<=a&&256>a?1:2}};var Ma;(function(a){a.merge=function(a,c){const b=Object.assign({},a,c);a=[...a.free||[],...c.free||[]];a.length&&(b.free=a);return b}})(Ma||(Ma={}));class Pa{constructor(a,b,c,d,e){this.line=a;this.column=b;this.prefix=c;this.remainder=d;this.match=e}}
class Ra{constructor(a,b=0,c=0){this.content=a;this.line=b;this.column=c;this.prefix="";this.remainder=a}advance(a){const b=this.remainder.substring(0,a.length);if(a!==b)throw Error(`Non-rooted token: '${a}' vs '${b}'`);this.prefix+=a;this.remainder=this.remainder.substring(a.length);a=a.split(/(\r\n|\n|\r)/g);1<a.length&&(this.line+=a.length-1,this.column=0);this.column+=a[a.length-1].length}saveState(){return new Pa(this.line,this.column,this.prefix,this.remainder,this.lastMatch)}restoreState(a){this.line=
a.line;this.column=a.column;this.prefix=a.prefix;this.remainder=a.remainder;this.lastMatch=a.match}skip(a){a=a.exec(this.remainder);if(!a)return!1;this.advance(a[0]);return!0}space(){return this.skip(/^[ \t]+/)}newline(){return this.skip(/^(\r\n|\n|\r)/)}lookingAt(a){return"string"===typeof a?this.remainder.startsWith(a):a.test(this.remainder)}token(a){if("string"===typeof a){if(!this.remainder.startsWith(a))return!1;a=[a]}else a=a.exec(this.remainder);if(!a)return!1;a.line=this.line;a.column=this.column;
this.lastMatch=a;this.advance(a[0]);return!0}lookBehind(a){if("string"===typeof a)return this.prefix.endsWith(a);a=a.exec(this.prefix);if(!a)return!1;a.line=this.line;a.column=this.line;this.lastMatch=a;return!0}match(){return this.lastMatch}group(a=0){var b;return null===(b=this.lastMatch)||void 0===b?void 0:b[a]}eof(){return!this.remainder}};class Ta{constructor(a,b="input.s",c={}){this.file=b;this.opts=c;this.buffer=new Ra(a)}next(){for(var a=this.token();p.eq(a,p.EOL);)a=this.token();var b=[[]];let c=0;for(;!p.eq(a,p.EOL)&&!p.eq(a,p.EOF);){if(p.eq(a,p.LC))b[c++].push(a),b.push([]);else if(p.eq(a,p.RC)){if(!c)throw Error(`Missing open curly: ${p.nameAt(a)}`);var d=b.pop();a=b[--c].pop().source;d={token:"grp",inner:d};a&&(d.source=a);b[c].push(d)}else b[c].push(a);a=this.token()}if(c)throw b=b[c-1].pop(),Error(`Missing close curly: ${p.nameAt(b)}`);
return b[0].length?b[0]:void 0}token(){for(;this.buffer.space()||this.buffer.token(/^;.*/)||this.opts.lineContinuations&&this.buffer.token(/^\\(\r\n|\n|\r)/););if(this.buffer.eof())return p.EOF;var a={file:this.file,line:this.buffer.line,column:this.buffer.column};try{const b=this.tokenInternal();this.opts.skipSourceAnnotations||(b.source=a);return b}catch(b){const {file:c,line:d,column:e}=a;a=(a=this.buffer.group())?` near '${a}'`:"";b.message+=`\n  at ${c}:${d}:${e}${a}`;throw b;}}tokenInternal(){if(this.buffer.newline())return{token:"eol"};
if(this.buffer.token(/^@+[a-z0-9_]*/i)||this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i))return this.strTok("ident");if(this.buffer.token(/^\.[a-z]+/i))return this.strTok("cs");if(this.buffer.token(/^:(\++|-+)/))return this.strTok("ident");if(this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/))return this.strTok("op");if(this.buffer.token("["))return{token:"lb"};if(this.buffer.token("{"))return{token:"lc"};if(this.buffer.token("("))return{token:"lp"};if(this.buffer.token("]"))return{token:"rb"};
if(this.buffer.token("}"))return{token:"rc"};if(this.buffer.token(")"))return{token:"rp"};if(this.buffer.token(/^["']/))return this.tokenizeStr();if(this.buffer.token(/^[$%]?[0-9a-z_]+/i))return this.tokenizeNum();throw Error("Syntax error");}tokenizeStr(){const a=this.buffer,b=a.match()[0];let c="";for(;!a.lookingAt(b);){if(a.eof())throw Error(`EOF while looking for ${b}`);a.token(/^\\u([0-9a-f]{4})/i)?c+=String.fromCodePoint(parseInt(a.group(1),16)):a.token(/^\\x([0-9a-f]{2})/i)?c+=String.fromCharCode(parseInt(a.group(1),
16)):a.token(/^\\(.)/)?c+=a.group(1):(a.token(/^./),c+=a.group(0))}a.token(b);return{token:"str",str:c}}strTok(a){return{token:a,str:this.buffer.group()}}tokenizeNum(a=this.buffer.group()){this.opts.numberSeparators&&(a=a.replace(/_/g,""));if("$"===a[0]){a=a.substring(1);if(!/^[0-9a-f]+$/i.test(a))throw Error(`Bad hex number: $${a}`);return{token:"num",num:Number.parseInt(a,16)}}if("%"===a[0]){a=a.substring(1);if(!/^[01]+$/.test(a))throw Error(`Bad binary number: %${a}`);return{token:"num",num:Number.parseInt(a,
2)}}if("0"===a[0]){if(!/^[0-7]+$/.test(a))throw Error(`Bad octal number: ${a}`);return{token:"num",num:Number.parseInt(a,8)}}if(!/^[0-9]+$/.test(a))throw Error(`Bad decimal number: ${a}`);return{token:"num",num:Number.parseInt(a,10)}}};class Xa{constructor(){this.symbols=new Map}pickScope(a){return[a,this]}resolve(a,b){const [c,d]=this.pickScope(a);let e=d.symbols.get(c);if(e)return c!==a&&(e.scoped=!0),e;if(b)return b={},d.symbols.set(c,b),c!==a&&(b.scoped=!0),b}}
class Ya extends Xa{constructor(a,b){super();this.parent=a;this.kind=b;this.children=new Map;this.anonymousChildren=[];this.global=a?a.global:this}pickScope(a){var b=this;a=a.split(/::/g);const c=a.pop();for(let c=0;c<a.length;c++){if(!c&&!a[c]){b=b.global;continue}let d=b.children.get(a[c]);for(;!c&&b.parent&&!d;)d=(b=b.parent).children.get(a[c]);if(!d)throw b=a.slice(0,c+1).join("::"),Error(`Could not resolve scope ${b}`);b=d}return[c,b]}}
class Za extends Xa{clear(){for(var a of this.symbols){const [b,c]=a;if(!c.expr)throw a=c.ref?p.at(c.ref):"",Error(`Cheap local label never defined: ${b}${a}`);}this.symbols.clear()}}
class $a{constructor(a,b){a=void 0===a?xa.P02:a;b=void 0===b?{}:b;this.cpu=a;this.opts=b;this.segments=["code"];this.segmentData=new Map;this.segmentStack=[];this.symbols=[];this.globals=new Map;this.currentScope=new Ya;this.cheapLocals=new Za;this.anonymousForward=[];this.anonymousReverse=[];this.relativeForward=[];this.relativeReverse=[];this.chunks=[];this._org=this._name=this._chunk=void 0;this._segmentPrefix=""}get chunk(){this.ensureChunk();return this._chunk}ensureChunk(){this._chunk||(this._chunk=
{segments:this.segments,data:[]},null!=this._org&&(this._chunk.org=this._org),this._name&&(this._chunk.name=this._name),this.chunks.push(this._chunk))}definedSymbol(a){let b=this.currentScope;const c=!a.includes("::");do{const c=b.resolve(a,!1);if(c)return!!c.expr}while(c&&(b=b.parent));return!1}constantSymbol(a){a=this.currentScope.resolve(a,!1);return!(!a||!a.expr||0>a.id)}referencedSymbol(a){return null!=this.currentScope.resolve(a,!1)}evaluate(a){var b;a=this.resolve(a);if("num"===a.op&&(null===
(b=a.meta)||void 0===b||!b.rel))return a.num}pc(){var a;const b=this.chunk.data.length,c={rel:!0,chunk:this.chunks.length-1};null!=(null===(a=this._chunk)||void 0===a?void 0:a.org)&&(c.org=this._chunk.org);return za.evaluate({op:"num",num:b,meta:c})}resolve(a){return za.traverse(a,(a,c)=>{for(;"sym"===a.op&&a.sym;)a=this.resolveSymbol(a.sym);return za.evaluate(c(a))})}resolveSymbol(a){if("*"===a)return this.pc();if(/^:\++$/.test(a)){a=a.length-2;var b=this.anonymousForward[a];if(null!=b)return{op:"sym",
num:b};this.anonymousForward[a]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^\++$/.test(a)){b=this.relativeForward[a.length-1];if(null!=b)return{op:"sym",num:b};this.relativeForward[a.length-1]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^:-+$/.test(a))return b=this.anonymousReverse.length-a.length+1,0>b&&this.fail(`Bad anonymous backref: ${a}`),this.anonymousReverse[b];if(/^-+$/.test(a))return b=this.relativeReverse[a.length-1],null==
b&&this.fail(`Bad relative backref: ${a}`),b;a=(a.startsWith("@")?this.cheapLocals:this.currentScope).resolve(a,!0);if(a.expr)return a.expr;null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));return{op:"sym",num:a.id}}chunkData(a){return{org:this.chunks[a].org}}closeScopes(){function a(b){for(var c of b.children.values())a(c);for(const c of b.anonymousChildren)a(c);for(const a of b.symbols){const [d,f]=a;if(!f.expr&&null!=f.id&&b.parent){if(f.scoped)throw Error(`Symbol '${d}' undefined`);
if(c=b.parent.symbols.get(d))if(null!=c.id)f.expr={op:"sym",num:c.id};else if(c.expr)f.expr=c.expr;else throw Error(`Impossible: ${d}`);else b.parent.symbols.set(d,f)}}}this.cheapLocals.clear();if(this.currentScope.parent)throw Error("Scope never closed");a(this.currentScope);for(const a of this.globals){const [b,d]=a;{const a=this.currentScope.symbols.get(b);if("export"===d){if(null===a||void 0===a||!a.expr)throw Error(`Symbol '${b}' undefined`);null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));
a.export=b}else if("import"===d){if(a){if(a.expr)throw Error(`Already defined: ${b}`);a.expr={op:"im",sym:b}}}else oa(d)}}for(const a of this.currentScope.symbols){const [b,d]=a;if(!d.expr)throw Error(`Symbol '${b}' undefined`);}}module(){this.closeScopes();const a=[];for(var b of this.chunks)a.push(Object.assign({},b,{data:Uint8Array.from(b.data)}));b=[];for(var c of this.symbols){if(null==c.expr)throw Error("Symbol undefined");const a={expr:c.expr};null!=c.export&&(a.export=c.export);b.push(a)}c=
[...this.segmentData.values()];return{chunks:a,symbols:b,segments:c}}line(a){this._source=a[0].source;3>a.length&&p.eq(a[a.length-1],p.COLON)?this.label(a[0]):p.eq(a[1],p.ASSIGN)?this.assign(p.str(a[0]),this.parseExpr(a,2)):p.eq(a[1],p.SET)?this.set(p.str(a[0]),this.parseExpr(a,2)):"cs"===a[0].token?this.directive(a):this.instruction(a)}tokens(a){let b;for(;b=a.next();)this.line(b)}tokensAsync(a){const b=this;return m.asyncExecutePromiseGeneratorFunction(function*(){let c;for(;c=yield a.nextAsync();)b.line(c)})}directive(a){switch(p.str(a[0])){case ".org":return this.org(this.parseConst(a));
case ".reloc":return this.parseNoArgs(a),this.reloc();case ".assert":return this.assert(this.parseExpr(a));case ".segment":return this.segment(...this.parseSegmentList(a));case ".byte":return this.byte(...this.parseDataList(a,!0));case ".res":return this.res(...this.parseResArgs(a));case ".word":return this.word(...this.parseDataList(a));case ".free":return this.free(this.parseConst(a),a[0]);case ".segmentprefix":return this.segmentPrefix(this.parseStr(a));case ".import":return this.import(...this.parseIdentifierList(a));
case ".export":return this.export(...this.parseIdentifierList(a));case ".scope":return this.scope(this.parseOptionalIdentifier(a));case ".endscope":return this.parseNoArgs(a),this.endScope();case ".proc":return this.proc(this.parseRequiredIdentifier(a));case ".endproc":return this.parseNoArgs(a),this.endProc();case ".pushseg":return this.pushSeg(...this.parseSegmentList(a));case ".popseg":return this.parseNoArgs(a),this.popSeg();case ".move":return this.move(...this.parseMoveArgs(a))}this.fail(`Unknown directive: ${p.nameAt(a[0])}`)}label(a){let b;
const c=this.pc();if("string"===typeof a)var d=a;else d=p.str(b=a),a.source&&(c.source=a.source);":"===d?(this.anonymousReverse.push(c),d=this.anonymousForward.shift(),null!=d&&(this.symbols[d].expr=c)):/^\++$/.test(d)?(a=this.relativeForward[d.length-1],delete this.relativeForward[d.length-1],null!=a&&(this.symbols[a].expr=c)):/^-+$/.test(d)?this.relativeReverse[d.length-1]=c:(d.startsWith("@")||(this.cheapLocals.clear(),this.chunk.name||this.chunk.data.length||(this.chunk.name=d)),this.assignSymbol(d,
!1,c,b))}assign(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!1,b)}set(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!0,b)}assignSymbol(a,b,c,d){"number"===typeof c&&(c={op:"num",num:c});const e=a.startsWith("@")?this.cheapLocals:this.currentScope;let f=e.resolve(a,!b);if(f&&b!==0>f.id)this.fail(`Cannot change mutability of ${a}`,
d);else if(b&&"num"!=c.op)this.fail("Mutable set requires constant",d);else if(!f){if(!b)throw Error("impossible");e.symbols.set(a,f={id:-1})}else if(!b&&f.expr)throw b=f.expr.source?`\nOriginally defined${p.at(f.expr)}`:"",a=d?p.nameAt(d):a+(this._source?p.at({source:this._source}):""),Error(`Redefining symbol ${a}${b}`);f.expr=c}instruction(...a){var b;let c;1===a.length&&Array.isArray(a[0])?(a=a[0],c=p.expectIdentifier(a[0]).toLowerCase(),a=this.parseArg(a)):"string"===typeof a[1]?(c=a[0],a=new Ta(a[1]),
a=this.parseArg(a.next(),0)):([c,a]=a,a||(a=["imp"]),c=c.toLowerCase());const d=this.cpu.op(c),e=a[0];if("add"===e||"a,x"===e||"a,y"===e){const f=a[1],g=(null===(b=f.meta)||void 0===b?void 0:b.size)||2;if("add"===e&&1===g&&"zpg"in d)return this.opcode(d.zpg,1,f);if("add"===e&&"abs"in d)return this.opcode(d.abs,2,f);if("add"===e&&"rel"in d)return this.relative(d.rel,1,f);if("a,x"===e&&1===g&&"zpx"in d)return this.opcode(d.zpx,1,f);if("a,x"===e&&"abx"in d)return this.opcode(d.abx,2,f);if("a,y"===e&&
1===g&&"zpy"in d)return this.opcode(d.zpy,1,f);if("a,y"===e&&"aby"in d)return this.opcode(d.aby,2,f);this.fail(`Bad address mode ${e} for ${c}`)}if(e in d)return b=this.cpu.argLen(e),"rel"===e?this.relative(d[e],b,a[1]):this.opcode(d[e],b,a[1]);this.fail(`Bad address mode ${e} for ${c}`)}parseArg(a,b){b=void 0===b?1:b;if(a.length===b)return["imp"];const c=a[b];var d=a[b+1];if(a.length===b+1){if(p.isRegister(c,"a"))return["acc"]}else if(p.eq(c,p.IMMEDIATE))return["imm",za.parseOnly(a,b+1)];if(p.eq(c,
p.COLON)&&a.length===b+2&&"op"===d.token&&/^[-+]+$/.test(d.str))return["add",{op:"sym",sym:":"+d.str}];if(a.length===b+1&&"op"===c.token&&/^[-+]+$/.test(c.str))return["add",{op:"sym",sym:c.str}];if(p.eq(c,p.LP)||this.opts.allowBrackets&&p.eq(c,p.LB)){d=p.findBalanced(a,b);0>d&&this.fail(`Unbalanced ${p.name(c)}`,c);const e=p.parseArgList(a,b+1,d);e.length||this.fail("Bad argument",c);const f=za.parseOnly(e[0]);if(1===e.length){if(p.eq(a[d+1],p.COMMA)&&p.isRegister(a[d+2],"y"))return p.expectEol(a[d+
3]),["iny",f];p.expectEol(a[d+1]);return["ind",f]}if(2===e.length&&1===e[1].length&&p.isRegister(e[1][0],"x"))return["inx",f];this.fail("Bad argument",c)}a=p.parseArgList(a,b);a.length||this.fail("Bad arg",c);b=za.parseOnly(a[0]);if(1===a.length)return["add",b];if(2===a.length&&1===a[1].length){if(p.isRegister(a[1][0],"x"))return["a,x",b];if(p.isRegister(a[1][0],"y"))return["a,y",b]}this.fail("Bad arg",c)}relative(a,b,c){var d;const e=this.chunk.data.length+b+1,f={rel:!0,chunk:this.chunks.length-
1};if(null===(d=this._chunk)||void 0===d?0:d.org)f.org=this._chunk.org;d={op:"-",args:[c,{op:"num",num:e,meta:f}]};c.source&&(d.source=c.source);this.opcode(a,b,d)}opcode(a,b,c){b&&(c=this.resolve(c));const {chunk:d}=this;d.data.push(a);b&&this.append(c,b);d.name||(d.name="Code")}append(a,b){var c;const {chunk:d}=this;a=this.resolve(a);let e=a.num;"num"!==a.op||(null===(c=a.meta)||void 0===c?0:c.rel)?(c=d.data.length,(d.subs||(d.subs=[])).push({offset:c,size:b,expr:a}),this.writeNumber(d.data,b)):
this.writeNumber(d.data,b,e)}org(a,b){this._org=a;this._chunk=void 0;this._name=b}reloc(a){this._chunk=this._org=void 0;this._name=a}segment(...a){this.segments=a.map(a=>"string"===typeof a?a:a.name);for(const b of a)"object"===typeof b&&(a=this.segmentData.get(b.name)||{name:b.name},this.segmentData.set(b.name,Ma.merge(a,b)));this._name=this._chunk=void 0}assert(a){a=this.resolve(a);var b=this.evaluate(a);if(null!=b){if(!b){b="";const c=this.chunk;null!=c.org&&(b=` (PC=$${(c.org+c.data.length).toString(16)})`);
this.fail(`Assertion failed${b}`,a)}}else({chunk:b}=this),(b.asserts||(b.asserts=[])).push(a)}byte(...a){const {chunk:b}=this;for(const d of a)if("number"===typeof d)this.writeNumber(b.data,1,d);else if("string"===typeof d){a=b.data;var c=d;for(let b=0;b<c.length;b++)a.push(c.charCodeAt(b))}else this.append(d,1)}res(a,b){a&&this.byte(...Array(a).fill(null!==b&&void 0!==b?b:0))}word(...a){const {chunk:b}=this;for(const c of a)"number"===typeof c?this.writeNumber(b.data,2,c):this.append(c,2)}free(a,
b){null==this._org&&this.fail(".free in .reloc mode",b);var c=1<this.segments.length?this.segments.filter(a=>{a=this.segmentData.get(a);return!a||null==a.memory||null==a.size||a.memory>this._org||a.memory+a.size<=this._org?!1:!0}):this.segments;1!==c.length?this.fail(`.free with non-unique segment: ${this.segments}`,b):0>a&&this.fail(`.free with negative size: ${a}`,b);this._chunk&&(this._org+=this._chunk.data.length);this._chunk=void 0;b=c[0];(c=this.segmentData.get(b))||this.segmentData.set(b,c=
{name:b});(c.free||(c.free=[])).push([this._org,this._org+a]);this._org+=a}segmentPrefix(a){this._segmentPrefix=a}import(...a){for(const b of a)this.globals.set(b,"import")}export(...a){for(const b of a)this.globals.set(b,"export")}scope(a){this.enterScope(a,"scope")}proc(a){this.label(a);this.enterScope(a,"proc")}enterScope(a,b){const c=a?this.currentScope.children.get(a):void 0;if(c){if(this.opts.reentrantScopes){this.currentScope=c;return}this.fail(`Cannot re-enter scope ${a}`)}b=new Ya(this.currentScope,
b);a?this.currentScope.children.set(a,b):this.currentScope.anonymousChildren.push(b);this.currentScope=b}endScope(){this.exitScope("scope")}endProc(){this.exitScope("proc")}exitScope(a){this.currentScope.kind===a&&this.currentScope.parent||this.fail(`.end${a} without .${a}`);this.currentScope=this.currentScope.parent}pushSeg(...a){this.segmentStack.push([this.segments,this._chunk]);this.segment(...a)}popSeg(){this.segmentStack.length||this.fail(".popseg without .pushseg");[this.segments,this._chunk]=
this.segmentStack.pop()}move(a,b){this.append({op:".move",args:[b],meta:{size:a}},a)}parseConst(a,b){b=this.evaluate(za.parseOnly(a,void 0===b?1:b));if(null!=b)return b;this.fail("Expression is not constant",a[1])}parseNoArgs(a){p.expectEol(a[1])}parseExpr(a,b){return za.parseOnly(a,void 0===b?1:b)}parseStr(a,b){b=void 0===b?1:b;const c=p.expectString(a[b]);p.expectEol(a[b+1],"a single string");return c}parseSegmentList(a,b){b=void 0===b?1:b;a.length<b+1&&this.fail("Expected a segment list",a[b-1]);
return p.parseArgList(a,1).map(a=>{var b=this._segmentPrefix+p.expectString(a[0]);if(1===a.length)return b;p.eq(a[1],p.COLON)||this.fail(`Expected comma or colon: ${p.name(a[1])}`,a[1]);b={name:b};a=p.parseAttrList(a,1);for(const c of a){const [a,d]=c;switch(a){case "bank":b.bank=this.parseConst(d,0);break;case "size":b.size=this.parseConst(d,0);break;case "off":b.offset=this.parseConst(d,0);break;case "mem":b.memory=this.parseConst(d,0);break;default:this.fail(`Unknown segment attr: ${a}`)}}return b})}parseResArgs(a){a=
this.parseDataList(a);2<a.length&&this.fail("Expected at most 2 args",a[2]);a.length||this.fail("Expected at least 1 arg");const b=this.evaluate(a[0]);null==b&&this.fail("Expected constant count");const c=a[1]&&this.evaluate(a[1]);a[1]&&null==c&&this.fail("Expected constant value");return[b,c]}parseDataList(a,b){b=void 0===b?!1:b;2>a.length&&this.fail("Expected a data list",a[0]);const c=[];for(const d of p.parseArgList(a,1))b&&1===d.length&&"str"===d[0].token?c.push(d[0].str):c.push(this.resolve(za.parseOnly(d)));
return c}parseIdentifierList(a){2>a.length&&this.fail("Expected identifier(s)",a[0]);const b=[];for(const c of p.parseArgList(a,1))1===c.length&&"ident"===c[0].token||this.fail(`Expected identifier: ${p.name(c[0])}`,c[0]),b.push(p.str(c[0]));return b}parseOptionalIdentifier(a){var b=a[1];if(b)return b=p.expectIdentifier(b),p.expectEol(a[2]),b}parseRequiredIdentifier(a){const b=p.expectIdentifier(a[1]);p.expectEol(a[2]);return b}parseMoveArgs(a){var b;a=p.parseArgList(a,1);2!==a.length&&this.fail("Expected constant number, then identifier");
const c=this.evaluate(za.parseOnly(a[0]));null==c&&this.fail("Expected a constant number");const d=this.resolve(za.parseOnly(a[1]));if("num"===d.op&&null!=(null===(b=d.meta)||void 0===b?void 0:b.chunk))return[c,d];this.fail("Expected a constant offset",a[1][0])}fail(a,b){var c;if(null===b||void 0===b?0:b.source)throw Error(a+p.at(b));if(!this._source&&(null===(c=this._chunk)||void 0===c?0:c.name))throw Error(a+`\n  in ${this._chunk.name}`);throw Error(a+p.at({source:this._source}));}writeNumber(a,
b,c){var d=b<<3;null!=c&&(c<-1<<d||c>=1<<d)&&this.fail(`Not a ${["byte","word","farword","dword"][b-1]}: $${c.toString(16)}`);for(d=0;d<b;d++)a.push(null!=c?c&255:255),null!=c&&(c>>=8)}};class db{constructor(a){this.overloads=a}canOverload(){return this.overloads[this.overloads.length-1].canOverload()}append(a){if(!this.canOverload()){var b=this.overloads[this.overloads.length-1].definition;b=(b?p.at(b):"").replace(/at/,"previously defined at");a=(a=a.overloads[0].definition)?p.nameAt(a):"";throw Error(`Non-overloadable: ${a}${b}`);}this.overloads.push(...a.overloads)}expand(a,b){const c=[];for(const d of this.overloads){const e=d.expand(a,b);if(Array.isArray(e))return e;c.push(e)}}static from(a){var b;
if(!p.eq(a[0],p.DEFINE))throw Error("invalid");if("ident"!==(null===(b=a[1])||void 0===b?void 0:b.token))throw Error("invalid");if(b=a[2])if("grp"===b.token)a=new eb(b.inner,a.slice(3),a[1]);else if("lp"===b.token){b=p.findBalanced(a,2);if(0>b)throw Error(`Expected close paren ${p.nameAt(a[2])}`);a=new gb(p.identsFromCList(a.slice(3,b)),a.slice(b+1),a[1])}else a=new eb([],a.slice(2),a[1]);else a=new eb([],[],a[1]);return new db([a])}}
function hb(a,b,c,d,e){const f=[];let g=[],h=f;for(const b of e){if("ident"===b.token){if(e=d.get(b.str)){h.push(...e);continue}}else if(p.eq(b,p.DOT_EOL)){g.push(h=[]);continue}e=b.source&&a[0].source?Object.assign({},b.source,{parent:a[0].source}):b.source||a[0].source;h.push(e?Object.assign({},b,{source:e}):b)}g=g.filter(a=>a.length);if(g.length&&c<a.length)return"cannot expand .eol without consuming to end of line";a.splice(b,c-b,...f);return g}
class gb{constructor(a,b,c){this.params=a;this.production=b;this.definition=c}expand(a,b){let c=b+1,d=this.params.length?a.length:b;var e=d;const f=new Map;if(b<a.length&&p.eq(p.LP,a[c])){e=p.findBalanced(a,c);if(0>e)return"missing close paren for enclosed C-style expansion";d=e+1;c++}e=p.parseArgList(a,c,e);if(e.length>this.params.length)return"too many args";for(c=0;c<this.params.length;c++){let a=e[c]||[];const b=a[0];1===a.length&&"grp"===b.token&&(a=b.inner);f.set(this.params[c],a)}return hb(a,
b,d,f,this.production)}canOverload(){return!!this.params.length}}
class eb{constructor(a,b,c){this.pattern=a;this.production=b;this.definition=c}expand(a,b){let c=b+1;const d=new Map;for(let b=0;b<this.pattern.length;b++){const f=this.pattern[b];if("ident"===f.token){var e=this.pattern[b+1];if(e&&"ident"!==(null===e||void 0===e?void 0:e.token)){const b=p.eq(e,p.DOT_EOL)?a.length:p.find(a,e,c);if(0>b)return`could not find delimiter ${p.name(e)}`;d.set(f.str,a.slice(c,b));c=b}else{e=a[c++];if(!e)return`missing undelimited argument ${p.name(f)}`;d.set(f.str,"grp"===
e.token?e.inner:[e])}}else if(p.eq(f,p.DOT_EOL)){if(c<a.length)return"could not match .eol"}else if(!p.eq(a[c++],f))return`could not match: ${p.name(f)}`}return hb(a,b,c,d,this.production)}canOverload(){return!!this.pattern.length}};function ib(a,b){if(!a)return-1;var c=b(0),d=b(a-1);if(0>c)return-1;if(0===c)return 0;if(0<d)return~a;if(0===d)return a-1;c=0;for(--a;1<a-c;){d=c+a>>1;const e=b(d);if(0<e)c=d;else if(0>e)a=d;else return d}return~a}function kb(a,b,c){const d=b(c),e=ib(a.length,c=>d<b(a[c])?-1:1);a.splice(~e,0,c)}
class mb{constructor(){this._chunks=[];this._length=0}get length(){return this._length}_find(a){return ib(this._chunks.length,b=>{const [c,d]=this._chunks[b];return a<c?-1:a>=c+d.length?1:0})}apply(a){if(a.length<this._length)throw Error("Target too small.");for(const [b,c]of this._chunks)for(let d=0;d<c.length;d++)a[b+d]=c[d]}chunks(){return this._chunks}get(a){let b=this._find(a);if(!(0>b)){var [c,d]=this._chunks[b];return d[a-c]}}set(a,...b){this.setInternal(a,b)}setInternal(a,b){var c;if(b.length){var d=
a+b.length;this._length=Math.max(this._length,d);var e=this._find(a),f=this._find(d);if(0<=e&&e===f){const [c,d]=this._chunks[e];for(f=0;f<b.length;f++)d[a+f-c]=b[f]}else{var g=this._chunks[~e-1];g&&g[0]+g[1].length===a&&(e=~e-1);(null===(c=this._chunks[~f])||void 0===c?void 0:c[0])===d&&(f=~f);if(0<=e){const [d,k]=this._chunks[e];f===e&&Array.isArray(b)?b.unshift(...k.slice(0,a-d)):(c=k,a-=d,g=c.length,b.length<g||!Array.isArray(b)?(c.splice(a,g-a,...b),b=c):b.unshift(...qb(c,a)));a=d}if(0<=f){const [a,
e]=this._chunks[f];d-=a;c=e;b.length<c.length||!Array.isArray(b)?(c.splice(0,d,...b),b=c):b.push(...rb(c,d))}e=0>e?~e:e;d=0>f?~f:f;0<=f&&d++;Array.isArray(b)||(b=Array.from(b));this._chunks.splice(e,d-e,[a,b])}}}splice(a,b=1){const c=a+b;var d=this._find(a);b=this._find(c);var e=0<=d?this._chunks[d]:void 0;let f=0<=b?this._chunks[b]:void 0;e&&((a-=e[0])?e=[e[0],e===f?e[1].slice(0,a):qb(e[1],a)]:(e=void 0,d=~d));f&&(f=[c,rb(f[1],c-f[0])],f[1].length||(f=void 0,b=~b));a=[];e&&a.push(e);f&&a.push(f);
d=0>d?~d:d;e=0>b?~b:b;0<=b&&e++;this._chunks.splice(d,e-d,...a)}slice(a,b){if(b<=a)return[];const c=this._find(a);if(0>c)throw Error(`Absent: ${a}`);const [d,e]=this._chunks[c];if(d+e.length<b)throw Error(`Absent: ${d+e.length}`);return e.slice(a-d,b-d)}}
class ub extends mb{set(a,...b){this.setInternal(a,b[0]instanceof Uint8Array?b[0]:Uint8Array.from(b))}search(a,b,c){return this.pattern(a).search(b,c)}pattern(a){function b(b){for(let c=b,e=0;c<d;++c,++e)if(a[c]!==a[e])return!1;return!0}function c(b){let c=0;for(let e=b,f=d-1;0<=e&&a[e]===a[f];--e,--f)++c;return c}if(!a.length)return{search:(a=0)=>a};const d=a.length,e=Array(256).fill(d);for(var f=0;f<a.length;f++)e[a[f]]=d-1-f;const g=[];f=d;for(let a=d;0<a;--a){b(a)&&(f=a);g[d-a]=f-a+d;for(let a=
0;a<d-1;++a){const b=c(a);g[b]=d-1-a+b}}return{search:(b=0,c=this._length)=>{if(!this._chunks.length||c<b)return-1;let f=this._find(b),h=0;for(0<=f?h=b-this._chunks[f][0]:f=~f;f<this._chunks.length;){const [k,l]=this._chunks[f++];b=Math.min(c-k,l.length);if(0>b)break;for(let c=d-1+h,f;c<b;){for(f=d-1;a[f]===l[c];--c,--f)if(0===f)return c+k;c+=Math.max(g[d-1-f],e[l[c]])}h=0}return-1}}}addOffset(a){const b=new ub;for(const [c,d]of this._chunks)b._chunks.push([c+a,d]);return b}toIpsPatch(){var a=8;for(var [,
b]of this._chunks)a+=5+b.length;a=new Uint8Array(a);b=5;a[0]=80;a[1]=65;a[2]=84;a[3]=67;a[4]=72;for(const [c,d]of this._chunks){if(65535<d.length)throw Error("Oops!");a[b++]=c>>>16;a[b++]=c>>>8&255;a[b++]=c&255;a[b++]=d.length>>>8;a[b++]=d.length&255;a.subarray(b,b+d.length).set(d);b+=d.length}a[b]=69;a[b+1]=79;a[b+2]=70;return a}toIpsHexString(){const a=[...this.toIpsPatch()],b=[];for(let c=0;c<a.length;c+=16)b.push([c.toString(16).padStart(8,"0")+":",...a.slice(c,c+16).map(a=>a.toString(16).padStart(2,
"0"))].join(" "));return b.join("\n")}}function qb(a,b){const c=a.length;if(b<<1<c)return a.slice(0,b);a.splice(b,c-b);return a}function rb(a,b){return b<<1<a.length?(a.splice(0,b),a):a.slice(b)}
class vb{constructor(){this.data=[]}[Symbol.iterator](){return this.data[Symbol.iterator]()}_find(a){return ib(this.data.length,b=>{b=this.data[b];return a<b[0]?-1:a>=b[1]?1:0})}has(a){return 0<=this._find(a)}add(a,b){var c,d,e=this._find(a);let f=this._find(b);(null===(c=this.data[~e-1])||void 0===c?void 0:c[1])===a&&(e=~e-1);(null===(d=this.data[~f])||void 0===d?void 0:d[0])===b&&(f=~f);a=[a,b];0<=e&&(a[0]=this.data[e][0]);0<=f&&(a[1]=this.data[f][1]);e=0>e?~e:e;b=0>f?~f:f;0<=f&&b++;this.data.splice(e,
b-e,a)}delete(a,b){var c=this._find(a);let d=this._find(b);var e=0<=c?this.data[c]:void 0;let f=0<=d?this.data[d]:void 0;e&&(e=[e[0],Math.min(e[1],a)],e[0]===e[1]&&(e=void 0,c=~c));f&&(f=[Math.max(f[0],b),f[1]],f[0]===f[1]&&(f=void 0,d=~d));a=[];e&&a.push(e);f&&a.push(f);c=0>c?~c:c;e=0>d?~d:d;0<=d&&e++;this.data.splice(c,e-c,...a)}tail(a){let b=this._find(a);0>b&&(b=~b);const c=this.data;return{[Symbol.iterator](){return this},next(){if(b>=c.length)return{value:void 0,done:!0};const d=c[b++];return{value:[Math.max(a,
d[0]),d[1]],done:!1}}}}};class wb{constructor(){this._link=new xb}static link(...a){const b=new wb;for(const c of a)b.read(c);return b.link()}read(a){this._link.readFile(a);return this}base(a,b){this._link.base(a,void 0===b?0:b);return this}link(){return this._link.link()}report(a){console.log(this._link.report(void 0===a?!1:a))}exports(){return this._exports?this._exports:this._exports=this._link.buildExports()}watch(...a){this._link.watches.push(...a)}}function Bb(a){throw Error(a);}
class Cb{constructor(a){var b,c,d,e,f;const g=this.name=a.name;this.bank=null!==(b=a.bank)&&void 0!==b?b:0;this.addressing=null!==(c=a.addressing)&&void 0!==c?c:2;this.size=null!==(d=a.size)&&void 0!==d?d:Bb(`Size must be specified: ${g}`);this.offset=null!==(e=a.offset)&&void 0!==e?e:Bb(`OFfset must be specified: ${g}`);this.memory=null!==(f=a.memory)&&void 0!==f?f:Bb(`OFfset must be specified: ${g}`)}get delta(){return this.offset-this.memory}}
class Db{constructor(a,b,c,d,e){this.linker=a;this.index=b;this.subs=new Set;this.selfSubs=new Set;this.deps=new Set;this.imports=new Set;this.follow=new Map;this.overlaps=!1;this.name=c.name;this.size=c.data.length;this.segments=c.segments;this._data=c.data;for(const a of c.subs||[])this.subs.add(Jb(a,d,e));this.asserts=(c.asserts||[]).map(a=>Kb(a,d,e));c.org&&(this._org=c.org)}get org(){return this._org}get offset(){return this._offset}get segment(){return this._segment}get data(){var a;return null!==
(a=this._data)&&void 0!==a?a:Bb("no data")}initialPlacement(){if(null!=this._org){var a=[];for(const b of this.segments){const c=this.linker.segments.get(b);if(!c)throw Error(`Unknown segment: ${b}`);this._org>=c.memory&&this._org<c.memory+c.size&&a.push(c)}if(1!==a.length)throw Error(`Non-unique segment: [${a}]`);a=a[0];if(this._org>=a.memory+a.size)throw Error(`Chunk does not fit in segment ${a.name}`);this.place(this._org,a)}}place(a,b){var c;this._org=a;this._segment=b;a=this._offset=a+b.delta;
for(var d of this.linker.watches)if(d>=a&&d<a+this.size)debugger;kb(this.linker.placed,a=>a[0],[a,this]);d=this.linker.data;b=null!==(c=this._data)&&void 0!==c?c:Bb("No data");this._data=void 0;if(this.subs.size){d.splice(a,b.length);c=new ub;c.set(0,b);for(const a of this.subs)c.splice(a.offset,a.size);for(const b of c.chunks()){const [c,e]=b;d.set(a+c,...e)}}else d.set(a,b);for(const a of this.follow){const [b,c]=a;c.resolveSub(b,!1)}this.linker.free.delete(this.offset,this.offset+this.size)}resolveSubs(a){a=
void 0===a?!1:a;for(const b of this.selfSubs)this.resolveSub(b,a);for(const b of this.subs)this.resolveSub(b,a)}addDep(a,b){b===this.index&&this.subs.delete(a)&&this.selfSubs.add(a);this.linker.chunks[b].follow.set(a,this);this.deps.add(b)}resolveSub(a,b){var c,d;if(this.subs.has(a)||this.selfSubs.has(a)){a.expr=za.traverse(a.expr,(c,d,e)=>{var f;if(b&&"^"===(null===e||void 0===e?void 0:e.op)&&1===e.args.length&&c.meta)return null==c.meta.bank&&this.addDep(a,c.meta.chunk),c;c=this.linker.resolveLink(za.evaluate(d(c)));
b&&(null===(f=c.meta)||void 0===f?0:f.rel)&&this.addDep(a,c.meta.chunk);return c});var e=!1;if("num"===a.expr.op&&(null===(c=a.expr.meta)||void 0===c||!c.rel))this.writeValue(a.offset,a.expr.num,a.size),e=!0;else if(".move"===a.expr.op){if(1!==a.expr.args.length)throw Error("bad .move");c=a.expr.args[0];"num"===c.op&&null!=(null===(d=c.meta)||void 0===d?void 0:d.offset)&&(d=c.num+(c.meta.offset-(c.meta.rel?0:c.meta.org)),d=this.linker.orig.slice(d,d+a.size),this.writeBytes(a.offset,Uint8Array.from(d)),
e=!0)}e&&(this.subs.delete(a)||this.selfSubs.delete(a),this.subs.size||this.linker.unresolvedChunks.delete(this)&&this.linker.insertResolved(this))}}writeBytes(a,b){if(this._data)this._data.subarray(a,a+b.length).set(b);else if(null!=this._offset)this.linker.data.set(this._offset+a,b);else throw Error("Impossible");}writeValue(a,b,c){var d=c<<3;if(null!=b&&(b<-1<<d||b>=1<<d))throw Error(`Not a ${["byte","word","farword","dword"][c-1]}: $${b.toString(16)} at $${(this.org+a).toString(16)}`);d=new Uint8Array(c);
for(let a=0;a<c;a++)d[a]=b&255,b>>=8;this.writeBytes(a,d)}}function Jb(a,b,c){a=Object.assign({},a);a.expr=Kb(a.expr,b,c);return a}function Kb(a,b,c){var d;a=Object.assign({},a);a.meta&&(a.meta=Object.assign({},a.meta));a.args&&(a.args=a.args.map(a=>Kb(a,b,c)));null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(a.meta.chunk+=b);"sym"===a.op&&null!=a.num&&(a.num+=c);return a}function Lb(a,b,c){a=Object.assign({},a);a.expr&&(a.expr=Kb(a.expr,b,c));return a}
class xb{constructor(){this.data=new ub;this.orig=new ub;this.exports=new Map;this.chunks=[];this.symbols=[];this.free=new vb;this.rawSegments=new Map;this.segments=new Map;this.resolvedChunks=[];this.unresolvedChunks=new Set;this.watches=[];this.placed=[];this.initialReport=""}insertResolved(a){kb(this.resolvedChunks,a=>a.size,a)}base(a,b){b=void 0===b?0:b;this.data.set(b,a);this.orig.set(b,a)}readFile(a){const b=this.chunks.length,c=this.symbols.length;for(var d of a.segments||[])this.addRawSegment(d);
for(const e of a.chunks||[])d=new Db(this,this.chunks.length,e,b,c),this.chunks.push(d);for(const d of a.symbols||[])this.symbols.push(Lb(d,b,c))}resolveLink(a){var b,c,d;if(".orig"===a.op&&1===(null===(b=a.args)||void 0===b?void 0:b.length)){var e=a.args[0];var f=null===(c=e.meta)||void 0===c?void 0:c.offset;if(null!=f&&(e=this.orig.get(f+e.num),null!=e))return{op:"num",num:e}}else"num"===a.op&&null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(c=a.meta,b=this.chunks[c.chunk],b.org!==c.org||
(null===(f=b.segment)||void 0===f?void 0:f.bank)!==c.bank||b.offset!==c.offset)&&(f={org:b.org,offset:b.offset,bank:null===(e=b.segment)||void 0===e?void 0:e.bank},a=za.evaluate(Object.assign({},a,{meta:Object.assign({},c,f)})));return a}resolveExpr(a){var b;a=za.traverse(a,(a,b)=>this.resolveLink(za.evaluate(b(a))));if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=p.at(a);throw Error(`Unable to fully resolve expr${a}`);}link(){for(var a of this.rawSegments){const [c,d]=a;var b=
d[0];for(let a=1;a<d.length;a++)b=Ma.merge(b,d[a]);this.segments.set(c,new Cb(b))}for(var c of this.rawSegments){const [e,f]=c;a=this.segments.get(e);for(var d of f){b=d.free;for(const c of b||[]){const [b,d]=c;this.free.add(b+a.delta,d+a.delta);this.data.splice(b+a.delta,d-b)}}}for(const a of this.chunks)a.initialPlacement();for(c=0;c<this.symbols.length;c++){d=this.symbols[c];if(!d.expr)throw Error(`Symbol ${c} never resolved`);null!=d.export&&this.exports.set(d.export,c)}for(var e of this.symbols)e.expr=
this.resolveSymbols(e.expr);for(var f of this.chunks){for(const a of[...f.subs,...f.selfSubs])a.expr=this.resolveSymbols(a.expr);for(e=0;e<f.asserts.length;e++)f.asserts[e]=this.resolveSymbols(f.asserts[e])}for(const a of this.chunks)a.resolveSubs(!0);f=[...this.chunks];f.sort((a,b)=>b.size-a.size);for(var g of f)g.resolveSubs(),g.subs.size?this.unresolvedChunks.add(g):this.insertResolved(g);for(g=this.resolvedChunks.length+2*this.unresolvedChunks.size;g;){if(f=this.resolvedChunks.pop())this.placeChunk(f);
else{[f]=this.unresolvedChunks;for(var h of f.deps)f=this.chunks[h],null==f.org&&this.placeChunk(f)}f=this.resolvedChunks.length+2*this.unresolvedChunks.size;if(f===g)throw console.error(this.resolvedChunks,this.unresolvedChunks),Error("Not making progress");g=f}h=new ub;for(var k of this.chunks){for(const a of k.asserts)if(!this.resolveExpr(a))throw k=p.at(a),Error(`Assertion failed${k}`);k.overlaps||h.set(k.offset,...this.data.slice(k.offset,k.offset+k.size))}return h}placeChunk(a){if(null==a.org){var b=
a.size;if(!a.subs.size&&!a.selfSubs.size){var c=this.data.pattern(a.data);for(var d of a.segments){var e=this.segments.get(d),f=e.offset;f=c.search(f,f+e.size);if(!(0>f)){a.place(f-e.delta,e);a.overlaps=!0;return}}}for(var g of a.segments){c=this.segments.get(g);f=c.offset;d=f+c.size;let h;e=Infinity;for(const a of this.free.tail(f)){const [c,g]=a;if(c>=d)break;f=Math.min(g,d)-c;!(f<b)&&f<e&&(h=c,e=f)}if(null!=h){a.place(h-c.delta,c);return}}console.log(`After filling:\n${this.report(!0)}`);g=a.name?
`${a.name} `:"";console.log(this.segments.get(a.segments[0]));throw Error(`Could not find space for ${b}-byte chunk ${g}in ${a.segments.join(", ")}`);}}resolveSymbols(a){return za.traverse(a,(b,c)=>{for(;"im"===b.op||"sym"===b.op;)if("im"===b.op){b=b.sym;const d=this.exports.get(b);if(null==d)throw c=p.at(a),Error(`Symbol never exported ${b}${c}`);b=this.symbols[d].expr}else{if(null==b.num)throw Error("Symbol not global");b=this.symbols[b.num].expr}return za.evaluate(c(b))})}addRawSegment(a){let b=
this.rawSegments.get(a.name);b||this.rawSegments.set(a.name,b=[]);b.push(a)}buildExports(){var a,b;const c=new Map;for(const d of this.symbols){if(!d.export)continue;const e=za.traverse(d.expr,(a,b)=>this.resolveLink(za.evaluate(b(a))));if("num"!==e.op)throw Error(`never resolved: ${d.export}`);const f=e.num,g={value:f};null!=(null===(a=e.meta)||void 0===a?void 0:a.offset)&&null!=e.meta.org&&(g.offset=e.meta.offset+f-e.meta.org);null!=(null===(b=e.meta)||void 0===b?void 0:b.bank)&&(g.bank=e.meta.bank);
c.set(d.export,g)}return c}report(a){a=void 0===a?!1:a;var b;let c="";for(var d of this.free){const [a,b]=d;c+=`Free: ${a.toString(16)}..${b.toString(16)}: ${b-a} bytes\n`}if(a)for(const e of this.placed){const [f,g]=e;a=null!==(b=g.name)&&void 0!==b?b:`Chunk ${g.index}`;d=g.offset+g.size;c+=`${f.toString(16).padStart(5,"0")} .. ${d.toString(16).padStart(5,"0")}: ${a} (${d-f} bytes)\n`}return c}};class Mb{constructor(a,b){this.params=a;this.production=b}static from(a,b){var c;if(!p.eq(a[0],p.MACRO))throw Error("invalid");if("ident"!==(null===(c=a[1])||void 0===c?void 0:c.token))throw Error("invalid");c=p.identsFromCList(a.slice(2));const d=[];let e;for(;e=b.next();){if(p.eq(e[0],p.ENDMACRO)||p.eq(e[0],p.ENDMAC))return new Mb(c,d);d.push(e)}throw Error(`EOF looking for .endmacro: ${p.nameAt(a[1])}`);}expand(a,b){let c=1;const d=new Map,e=[];for(const b of this.params){const e=p.findComma(a,
c);let f=a.slice(c,e);c=e+1;1===f.length&&"grp"===f[0].token&&(f=f[0].inner);d.set(b,f)}if(c<a.length)throw Error(`Too many macro parameters: ${p.nameAt(a[c])}`);const f=new Map;for(const c of this.production){var g=function(b){const c=[];for(const e of b){if("ident"===e.token){if(b=d.get(e.str)){c.push(...b);continue}if(b=f.get(e.str)){c.push({token:"ident",str:b});continue}}else if("grp"===e.token){c.push({token:"grp",inner:g(e.inner)});continue}b=e.source&&a[0].source?Object.assign({},e.source,
{parent:a[0].source}):e.source||a[0].source;c.push(b?Object.assign({},e,{source:b}):e)}return c};if(p.eq(c[0],p.LOCAL))for(const a of p.identsFromCList(c.slice(1)))f.set(a,`${a}@${b.next()}`);e.push(g(c))}return e}};const Nb=new WeakMap;function Ob(a){let b=Nb.get(a);b||Nb.set(a,b=(a=>({next:()=>a++}))(0));return b}
class Pb extends ya.Abstract{constructor(a,b,c){super();this.stream=a;this.env=b;this.repeats=[];this.runDirectives={".define":a=>this.parseDefine(a),".undefine":a=>this.parseUndefine(a),".else":([a])=>Wb(".if",a),".elseif":([a])=>Wb(".if",a),".endif":([a])=>Wb(".if",a),".endmac":([a])=>Wb(".macro",a),".endmacro":([a])=>Wb(".macro",a),".endrep":a=>this.parseEndRepeat(a),".endrepeat":a=>this.parseEndRepeat(a),".exitmacro":([,a])=>{if(a)throw Error(`garbage at end of line: ${p.nameAt(a)}`);this.stream.exit()},
".if":([a,...b])=>this.parseIf(!!this.evaluateConst(Xb(b,a))),".ifdef":([a,...b])=>this.parseIf(this.macros.has(Yb(b,a))),".ifndef":([a,...b])=>this.parseIf(!this.macros.has(Yb(b,a))),".ifblank":([,...a])=>this.parseIf(!a.length),".ifnblank":([,...a])=>this.parseIf(!!a.length),".ifref":([a,...b])=>this.parseIf(this.env.referencedSymbol(Yb(b,a))),".ifnref":([a,...b])=>this.parseIf(!this.env.referencedSymbol(Yb(b,a))),".ifsym":([a,...b])=>this.parseIf(this.env.definedSymbol(Yb(b,a))),".ifnsym":([a,
...b])=>this.parseIf(!this.env.definedSymbol(Yb(b,a))),".ifconst":([a,...b])=>this.parseIf(this.env.constantSymbol(Yb(b,a))),".ifnconst":([a,...b])=>this.parseIf(!this.env.constantSymbol(Yb(b,a))),".macro":a=>this.parseMacro(a),".repeat":a=>this.parseRepeat(a)};this.macros=c?c.macros:new Map}*pump(){const a=this.readLine();if(null==a)return void(yield a);for(;a.length;){var b=a[0];switch(b.token){case "ident":if(p.eq(a[1],p.COLON)){yield a.splice(0,2);break}this.tryExpandMacro(a)||(yield a);return;
case "cs":this.tryRunDirective(a)||(yield a);return;case "op":if(/^[-+]+$/.test(b.str)){b=[b];const c=a[1];c&&p.eq(c,p.COLON)?(b.push(c),a.splice(0,2)):(b.push({token:"op",str:":"}),a.splice(0,1));yield b;break}else if(":"===b.str){yield a.splice(0,1);break}default:throw Error(`Unexpected: ${p.nameAt(a[0])}`);}}}readLine(){const a=this.stream.next();return null==a?a:this.expandLine(a)}expandLine(a,b=0){const c=a[0];let d=0,e=0;for(;b<a.length;){if(b>e)e=b,d=0;else if(100<d++)throw Error(`Maximum expansion depth reached: ${a.map(p.name).join(" ")}${p.at(c)}`);
b=this.expandToken(a,b)}return a}expandToken(a,b){var c=a[b];if("ident"===c.token){if(c=this.macros.get(c.str),c instanceof db&&(a=c.expand(a,b)))return a.length&&this.stream.unshift(...a),b}else if("cs"===c.token)return this.expandDirective(c.str,a,b);return b+1}tryExpandMacro(a){var [b]=a;if("ident"!==b.token)throw Error("impossible");b=this.macros.get(b.str);if(!(b instanceof Mb))return!1;a=b.expand(a,Ob(this.env));this.stream.enter();this.stream.unshift(...a);return!0}expandDirective(a,b,c){switch(a){case ".define":case ".ifdef":case ".ifndef":case ".undefine":return this.skipIdentifier(b,
c);case ".skip":return this.skip(b,c);case ".noexpand":return this.noexpand(b,c);case ".tcount":return this.parseArgs(b,c,1,this.tcount);case ".ident":return this.parseArgs(b,c,1,this.ident);case ".string":return this.parseArgs(b,c,1,this.string);case ".concat":return this.parseArgs(b,c,0,this.concat);case ".sprintf":return this.parseArgs(b,c,0,this.sprintf);case ".cond":return this.parseArgs(b,c,0,this.cond);case ".def":case ".defined":return this.parseArgs(b,c,1,this.defined);case ".definedsymbol":return this.parseArgs(b,
c,1,this.definedSymbol);case ".constantsymbol":return this.parseArgs(b,c,1,this.constantSymbol);case ".referencedsymbol":return this.parseArgs(b,c,1,this.referencedSymbol)}return c+1}skip(a,b){a.splice(b,1);const c=a[b];"grp"===(null===c||void 0===c?void 0:c.token)?this.expandToken(c.inner,0):this.expandToken(a,b+1);return b}noexpand(a,b){const c=a[b+1];"grp"===c.token?(a.splice(b,2,...c.inner),b+=c.inner.length-1):a.splice(b,1);return b+1}parseArgs(a,b,c,d){const e=a[b];p.expect(p.LP,a[b+1],e);const f=
p.findBalanced(a,b+1),g=p.parseArgList(a,b+2,f).map(a=>{1===a.length&&"grp"===a[0].token&&(a=a[0].inner);return this.expandLine(a)});if(c&&g.length!==c)throw Error(`Expected ${c} parameters: ${p.nameAt(e)}`);c=d.call(this,e,...g);a.splice(b,f+1-b,...c);return b}tcount(a,b){return[{token:"num",num:p.count(b),source:a.source}]}ident(a,b){a=p.expectString(b[0],a);p.expectEol(b[1],"a single token");return[{token:"ident",str:a,source:b[0].source}]}string(a,b){a=p.expectIdentifier(b[0],a);p.expectEol(b[1],
"a single token");return[{token:"str",str:a,source:b[0].source}]}concat(a,...b){return[{token:"str",str:b.map(a=>{const b=p.expectString(a[0]);p.expectEol(a[1],"a single string");return b}).join(""),source:a.source}]}sprintf(a,b){p.expectString(b[0],a);p.expectEol(b[1],"a single format string");throw Error("unimplemented");}cond(){throw Error("unimplemented");}defined(a,b){a=p.expectIdentifier(b[0],a);p.expectEol(b[1],"a single identifier");return[{token:"num",num:this.macros.has(a)?1:0}]}definedSymbol(a,
b){a=p.expectIdentifier(b[0],a);p.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.definedSymbol(a)?1:0}]}constantSymbol(a,b){a=p.expectIdentifier(b[0],a);p.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.constantSymbol(a)?1:0}]}referencedSymbol(a,b){a=p.expectIdentifier(b[0],a);p.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.referencedSymbol(a)?1:0}]}skipIdentifier(a,b){var c;return"ident"===(null===(c=a[b+1])||void 0===c?void 0:
c.token)?b+2:b+1}tryRunDirective(a){var b=a[0];if("cs"!==b.token)throw Error("impossible");b=this.runDirectives[b.str];if(!b)return!1;b(a);return!0}evaluateConst(a){var b;a=za.traversePost(a,za.evaluate);if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=p.at(a);throw Error(`Expected a constant${a}`);}parseDefine(a){const b=p.expectIdentifier(a[1],a[0]);a=db.from(a);const c=this.macros.get(b);if(c instanceof db)c.append(a);else{if(c)throw Error(`Already defined: ${b}`);this.macros.set(b,
a)}}parseUndefine(a){const [b,c,d]=a;a=p.expectIdentifier(c,b);p.expectEol(d);if(!this.macros.has(a))throw Error(`Not defined: ${p.nameAt(c)}`);this.macros.delete(a)}parseMacro(a){const b=p.expectIdentifier(a[1],a[0]);a=Mb.from(a,this.stream);if(this.macros.get(b))throw Error(`Already defined: ${b}`);this.macros.set(b,a)}parseRepeat(a){var b;const [c,d]=za.parse(a,1);var e=a[1]||a[0];if(!c)throw Error(`Expected expression: ${p.nameAt(e)}`);e=this.evaluateConst(c);if(null==e)throw Error(`Expected a constant${p.at(c)}`);
let f;if(d<a.length){if(!p.eq(a[d],p.COMMA))throw Error(`Expected comma: ${p.nameAt(a[d])}`);f=p.expectIdentifier(a[d+1]);p.expectEol(a[d+2])}const g=[];let h=1;for(;0<h;){if(null!==(b=this.stream.next())&&void 0!==b)a=b;else throw Error(".repeat with no .endrep");p.eq(a[0],p.REPEAT)&&h++;p.eq(a[0],p.ENDREPEAT)&&h--;p.eq(a[0],p.ENDREP)&&h--;g.push(a)}this.repeats.push([g,e,-1,f]);this.parseEndRepeat(a)}parseEndRepeat(a){p.expectEol(a[1]);const b=this.repeats.pop();if(!b)throw Error(`.endrep with no .repeat${p.at(a[0])}`);
++b[2]>=b[1]||(this.repeats.push(b),this.stream.unshift(...b[0].map(a=>a.map(a=>{if("ident"!==a.token||a.str!==b[3])return a;const c={token:"num",num:b[2]};a.source&&(c.source=a.source);return c}))))}parseIf(a){let b=1,c=!1;const d=[];for(;0<b;){const e=this.stream.next();if(!e)throw Error("EOF looking for .endif");const f=e[0];if(p.eq(f,p.ENDIF)){if(b--,!b)break}else if("cs"===f.token&&f.str.startsWith(".if"))b++;else if(1===b&&!c)if(a&&(p.eq(f,p.ELSE)||p.eq(f,p.ELSEIF))){a=!1;c=!0;continue}else if(p.eq(f,
p.ELSEIF)){a=!!this.evaluateConst(Xb(e.slice(1),f));continue}else if(p.eq(f,p.ELSE)){a=!0;continue}a&&d.push(e)}this.stream.unshift(...d)}}function Yb(a,b){a=Xb(a,b);return za.identifier(a)}function Xb(a,b){if(!a.length){if(!b)throw Error("Expected expression");throw Error(`Expected expression: ${p.nameAt(b)}`);}return za.parseOnly(a)}function Wb(a,b){throw Error(`${p.name(b)} with no ${a}${p.at(b)}`);};class Zb{constructor(){this.stack=[]}next(){for(;this.stack.length;){const [a,b]=this.stack[this.stack.length-1];if(b.length)return b.pop();const c=null===a||void 0===a?void 0:a.next();if(c)return c;this.stack.pop()}}unshift(...a){if(!this.stack.length)throw Error("Cannot unshift after EOF");const b=this.stack[this.stack.length-1][1];for(let c=a.length-1;0<=c;c--)b.push(a[c])}enter(a){const b=[void 0,[]];a&&(b[0]=a);this.stack.push(b);if(100<this.stack.length)throw Error("Stack overflow");}exit(){this.stack.pop()}}
;function $b(a){throw Error(a);};const ac={of:(...a)=>{const b=[];for(const c of a)b[c>>>5]=(b[c>>>5]||0)|1<<c;return b},from:a=>{const b=[];for(const c of a)b[c>>>5]=(b[c>>>5]||0)|1<<c;return b},containsAll:(a,b)=>{for(let c=Math.max(a.length,b.length)-1;0<=c;c--)if((b[c]||0)&~(a[c]||0))return!1;return!0},difference:(a,b)=>{const c=Array(Math.max(a.length,b.length));for(let d=Math.max(a.length,b.length)-1;0<=d;d--)c[d]=(a[d]||0)&~(b[d]||0);return c},with:(a,b)=>{a=[...a];a[b>>>5]=(a[b>>>5]||0)|1<<b;return a},without:(a,b)=>{a=[...a];
a[b>>>5]=(a[b>>>5]||0)&~(1<<b);return a},has:(a,b)=>!!((a[b>>>5]||0)&1<<b),bits:a=>{const b=[];for(let c=0;c<a.length;c++){let d=a[c],e=32;for(;d;){const a=Math.clz32(d)+1;e-=a;d<<=a;32===a&&(d=0);b.push(c<<5|e)}}return b},clone:a=>[...a],empty:a=>a.every(a=>!a)};const rc={of:(...a)=>{let b=nc;for(const c of a)b|=oc<<BigInt(c);return b},from:a=>{let b=nc;for(const c of a)b|=oc<<BigInt(c);return b},containsAll:(a,b)=>!(b&~a),with:(a,b)=>a|oc<<BigInt(b),without:(a,b)=>a&~(oc<<BigInt(b)),has:(a,b)=>!!(a&oc<<BigInt(b)),bits:a=>{const b=[];let c=0;for(;a;){let d=Number(a&pc),e=32;for(;d;){const a=Math.clz32(d)+1;e-=a;d<<=a;32===a&&(d=0);b.push(c|e)}a>>=qc;c+=32}return b},clone:a=>a,empty:a=>!a,difference:(a,b)=>a&~b},sc="function"===typeof BigInt&&"bigint"===typeof BigInt(0),
nc=sc&&BigInt(0),oc=sc&&BigInt(1),pc=sc&&BigInt(4294967295),qc=sc&&BigInt(32);const tc=sc?rc:ac;class uc{constructor(a,b,c,d){this.filename=a;this.chrdata=Array.from(new Uint8Array(b));this.palette=c;this.rendered=Array.from(new Uint8Array(d.data))}}
function vc(a){return m.asyncExecutePromiseGeneratorFunction(function*(){const b=document.createElement("canvas");b.width=112;b.height=100;const c=b.getContext("2d");c.imageSmoothingEnabled=!1;c.fillStyle="#155fd9";c.fillRect(0,0,b.width,b.height);var d=new ImageData(new Uint8ClampedArray(a.rendered),128,128);d=yield createImageBitmap(d,{resizeQuality:"pixelated"});c.drawImage(d,0,0,16,24,24,2,64,96);return b.toDataURL("image/png")})}
function wc(a,b){return m.asyncExecutePromiseGeneratorFunction(function*(){const c=a.byteLength/16;var d=document.createElement("canvas");d.width=128;d.height=128;d=d.getContext("2d").createImageData(128,128);const e=new Uint8ClampedArray(a);for(let a=0;a<c;++a){const c=16*a,g=a%16*8,l=8*Math.floor(a/16);for(let a=0;8>a;++a){const h=e[c+a],k=e[c+a+8];for(let c=0;8>c;++c){var f=7-c;f=h>>f&1|(k>>f&1)<<1;const e=Ec[b[f]],q=4*(g+c)+512*(l+a);d.data[0+q]=e[0];d.data[1+q]=e[1];d.data[2+q]=e[2];d.data[3+
q]=0==f?0:255}}}return d})}
class Fc{constructor(a,b,c,d){this.name=a;this.converter=b;this.nssdata=c;this.description=d}static init(a,b,c,d){return m.asyncExecutePromiseGeneratorFunction(function*(){const e=yield c;return new Fc(a,b,e,d)})}static applyPatch(a,b,c){if(Fc.isCustom(a)){c=c?262144:0;for(let d of Gc.getChr(a.converter)){let [e,f]=d;for(let d of f)for(let f=0;16>f;++f)b[d+f+c]=a.nssdata.chrdata[16*e+f]}for(let d of Gc.getPalette(a.converter)){let [e,f]=d;for(let d of f)switch(e){case "color0":b[d]=a.nssdata.palette[0];
break;case "color1":b[d]=a.nssdata.palette[1];break;case "color2":b[d]=a.nssdata.palette[2];break;case "color3":b[d]=a.nssdata.palette[3];break;case "metasprite":b[d+c]=0}}}}}Fc.isCustom=a=>"Simea"!=a.name;
class Hc{constructor(){this.simeaReplacements=new Map;this.mapping=new Map;this.simeaReplacements.set("Simea",Fc.init("Simea","simea",Ic("images/spritesheets/Simea.nss"),"The original main character of Crystalis"));this.simeaReplacements.set("Mesia",Fc.init("Mesia","simea",Ic("images/spritesheets/Mesia.nss"),"Secondary protagonist Mesia takes the spotlight! Artwork by jroweboy"));this.mapping.set("simea",this.simeaReplacements)}static get(a){this.instance||(this.instance=new Hc);return this.instance.mapping.get(a)}}
function r(a,b,c){return 262160+8192*a+4096*b+16*c}
class Gc{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.simeaChrMapping=this.generateSimeaMapping();this.simeaPaletteMapping=this.generateSimeaPalette();this.chrMapping.set("simea",this.simeaChrMapping);this.paletteMapping.set("simea",this.simeaPaletteMapping)}static getChr(a){this.instance||(this.instance=new Gc);return this.instance.chrMapping.get(a)}static getPalette(a){this.instance||(this.instance=new Gc);return this.instance.paletteMapping.get(a)}generateSimeaPalette(){const a=new Map;
a.set("color0",[27904]);a.set("color1",[27905]);a.set("color2",[27906]);a.set("color3",[27907]);a.set("metasprite",[245860]);return a}generateSimeaMapping(){const a=new Map;a.set(0,[r(8,0,26)]);a.set(1,[r(8,0,27)]);a.set(16,[r(8,0,0)]);a.set(17,[r(8,0,1)]);a.set(32,[r(8,0,32)]);a.set(33,[r(8,0,33)]);a.set(2,[r(8,0,28)]);a.set(3,[r(8,0,29)]);a.set(18,[r(8,0,2)]);a.set(19,[r(8,0,3)]);a.set(20,[r(8,0,4)]);a.set(21,[r(8,0,5)]);a.set(34,[r(8,0,34)]);a.set(35,[r(8,0,35)]);a.set(36,[r(8,0,36)]);a.set(37,
[r(8,0,37)]);a.set(6,[r(8,0,30)]);a.set(7,[r(8,0,31)]);a.set(22,[r(8,0,6)]);a.set(23,[r(8,0,7)]);a.set(38,[r(8,0,38)]);a.set(39,[r(8,0,39)]);a.set(64,[r(8,0,20)]);a.set(65,[r(8,0,21)]);a.set(80,[r(8,0,52)]);a.set(81,[r(8,0,53)]);a.set(50,[r(8,0,60)]);a.set(51,[r(8,0,61)]);a.set(66,[r(8,0,24)]);a.set(67,[r(8,0,25)]);a.set(82,[r(8,0,56)]);a.set(68,[r(8,0,22)]);a.set(69,[r(8,0,23)]);a.set(84,[r(8,0,54)]);a.set(112,[r(8,0,14)]);a.set(113,[r(8,0,15)]);a.set(128,[r(8,0,46)]);a.set(129,[r(8,0,47)]);a.set(114,
[r(8,0,18)]);a.set(115,[r(8,0,19)]);a.set(130,[r(8,0,48)]);a.set(131,[r(8,0,51)]);a.set(116,[r(8,0,16)]);a.set(117,[r(8,0,17)]);a.set(133,[r(8,0,49)]);a.set(160,[r(8,0,8)]);a.set(161,[r(8,0,9)]);a.set(176,[r(8,0,40)]);a.set(146,[r(8,0,58)]);a.set(147,[r(8,0,59)]);a.set(162,[r(8,0,12)]);a.set(163,[r(8,0,13)]);a.set(178,[r(8,0,44)]);a.set(179,[r(8,0,45)]);a.set(164,[r(8,0,10)]);a.set(165,[r(8,0,11)]);a.set(181,[r(8,0,43)]);var b=new Map(a);for(var c of b){let [d,e]=c;{b=d+8;const c=e.map(a=>a+1024);
a.set(b,c)}}a.set(192,[r(11,1,0)]);a.set(193,[r(11,1,1)]);a.set(208,[r(11,1,2)]);a.set(209,[r(11,1,3)]);a.set(224,[r(11,1,4)]);a.set(225,[r(11,1,5)]);a.set(194,[r(11,1,36)]);a.set(195,[r(11,1,37)]);a.set(210,[r(11,1,6)]);a.set(211,[r(11,1,7)]);a.set(226,[r(11,1,38)]);a.set(227,[r(11,1,39)]);a.set(196,[r(11,1,32)]);a.set(197,[r(11,1,33)]);a.set(212,[r(11,1,34)]);a.set(213,[r(11,1,35)]);a.set(214,[r(11,1,20)]);a.set(215,[r(11,1,21)]);a.set(230,[r(11,1,22)]);a.set(231,[r(11,1,23)]);a.set(54,[r(11,1,
12)]);a.set(55,[r(11,1,13)]);a.set(70,[r(11,1,50)]);a.set(71,[r(11,1,51)]);a.set(86,[r(11,1,46)]);a.set(87,[r(11,1,47)]);a.set(102,[r(11,1,18)]);a.set(103,[r(11,1,19)]);a.set(118,[r(11,1,8)]);a.set(119,[r(11,1,9)]);a.set(134,[r(11,1,40)]);a.set(135,[r(11,1,41)]);a.set(150,[r(11,1,44)]);a.set(151,[r(11,1,45)]);a.set(166,[r(11,1,10)]);a.set(167,[r(11,1,11)]);a.set(182,[r(11,1,42)]);a.set(183,[r(11,1,43)]);c=a=>[r(8,0,a)+2048,r(8,0,a)+3072,r(8,1,a),r(8,1,a)+1024,r(8,1,a)+2048];a.set(240,c(16));a.set(241,
c(17));a.set(242,c(18));a.set(243,c(19));a.set(244,c(20));a.set(245,c(21));a.set(246,c(22));a.set(247,c(23));a.set(248,[r(8,1,237)]);a.set(249,c(25));a.set(250,c(26));a.set(252,c(48));a.set(253,c(49));a.set(254,c(50));a.set(255,c(51));return a}}function Ic(a){return m.asyncExecutePromiseGeneratorFunction(function*(){const b=yield(yield fetch(a)).text(),c=a.replace(/^.*[\\\/]/,"");return Jc(c,b)})}
function Kc(a){let b="",c="";for(var d=0;d<a.length;)if("["===a[d]){++d;const e=a.indexOf("]",d);d=parseInt(a.slice(d,e),16)-1;b+=c.repeat(d);d=e+1}else c=a.slice(d,d+2),b+=c,d+=2;return b}function Lc(a,b){return a.match(new RegExp(".{1,"+b+"}","g"))||[]}function Mc(a){a=Lc(a,2).map(a=>parseInt(a,16));return new Uint8Array(a)}function $c(a){return a.map(a=>parseInt(a,16))}
function Jc(a,b){return m.asyncExecutePromiseGeneratorFunction(function*(){var c=new Map(b.split("\n").filter(a=>a.includes("=")).map(a=>a.split("=")).map(a=>[a[0],a[1]])),d=c.get("Palette")||"";d=$c(Lc(Kc(d).slice(0,32),2));c=Mc(Kc(c.get("CHRMain")||""));const e=yield wc(new Uint8ClampedArray(c),d);return new uc(a,c,d,e)})}
const Ec=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,
180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]];let ad;const bd=a=>a.split("").map(a=>a.charCodeAt(0)),cd=a=>{if(!ad){ad=new Uint32Array(256);for(let a=0;256>a;a++){var b=a;for(let a=0;8>a;a++)b=b&1?3988292384^b>>>1:b>>>1;ad[a]=b}}"string"===typeof a&&(a=bd(a));b=-1;for(let c=0,d=a.length;c<d;c++)b=b>>>8^ad[(b^a[c])&255];return(b^-1)>>>0};const dd=()=>"",ed=a=>!0===a?!1:a;class fd{constructor(a,b){this.flag=a;this.opts=b;fd.flags.set(a,this)}static all(){return[...this.flags.values()]}}fd.flags=new Map;
class gd{constructor(a,b,c,d){this.name=b;this.description=c;this.flags=d.map(a=>a instanceof fd?[a,!0]:a);a.presets.set(b.toLowerCase().replace(/[^a-z]/g,""),this)}static all(){hd.instance||(hd.instance=new hd);return[...hd.instance.presets.values()]}get flagString(){null==this._flagString&&(this._flagString=String(new id(`@${this.name}`)));return this._flagString}}
class hd{constructor(){this.presets=new Map;this.Casual=new gd(this,"Casual","\n      Basic flags for a relatively easy playthrough.  This is a good\n      place to start.",[jd.PreserveUniqueChecks,jd.NoShuffleMimics,jd.DecreaseEnemyDamage,jd.GuaranteeRefresh,jd.GuaranteeStartingSword,jd.ExperienceScalesFaster,jd.NoCommunityJokes,ud.NoThunderSwordWarp,vd.Shops,vd.Dyna,[vd.Maps,"!"],[vd.WildWarp,"!"],wd.SpoilerLog]);this.Classic=new gd(this,"Classic","\n      Provides a relatively quick playthough with a reasonable amount of\n      challenge.  Similar to older versions.",
[jd.GuaranteeStartingSword,jd.NoCommunityJokes,t.StatueGlitch,[ud.NoThunderSwordWarp,"!"],[vd.Maps,"!"],wd.SpoilerLog]);this.Standard=new gd(this,"Standard","\n      Well-balanced, standard race flags.",[xd.RandomizeWeaknesses,ud.StoryMode,wd.SpoilerLog]);this.NoBowMode=new gd(this,"No Bow Mode","\n      The tower is open from the start, as soon as you're ready for it.",[xd.RandomizeWeaknesses,xd.TowerRobots,yd.MaxScalingInTower,ud.NoBowMode,wd.SpoilerLog]);this.Advanced=new gd(this,"Advanced","\n      A balanced randomization with quite a bit more difficulty.",
[t.GhettoFlight,t.MtSabreRequirementSkip,t.StatueGlitch,[t.SwordChargeGlitch,"!"],zd.Barrier,zd.BattleMagic,zd.GasMask,yd.MaxScalingInTower,xd.RandomizeWeaknesses,xd.TowerRobots,ud.OrbsNotRequired,ud.StoryMode,u.RandomizeMaps,u.ShuffleAreas,u.ShuffleHouses,u.RandomizeTrades,u.RandomizeWallElements,u.UnidentifiedKeyItems,wd.SpoilerLog]);this.WildWarp=new gd(this,"Wild Warp","\n      Significantly opens up the game right from the start with wild\n      warp in logic.",[jd.GuaranteeRefresh,u.RandomizeWildWarp,
xd.RandomizeWeaknesses,xd.TowerRobots,ud.OrbsNotRequired,ud.StoryMode,wd.SpoilerLog]);this.Mystery=new gd(this,"Mystery","\n      Even the options are random.",[[u.ShuffleAreas,"?"],[u.ShuffleHouses,"?"],[u.RandomizeMaps,"?"],[u.RandomizeTrades,"?"],[u.UnidentifiedKeyItems,"?"],[u.RandomizeWallElements,"?"],[u.ShuffleGoaFloors,"?"],[u.RandomizeSpriteColors,"?"],[u.RandomizeWildWarp,"?"],[ud.OrbsNotRequired,"?"],[ud.NoBowMode,"?"],[ud.StoryMode,"?"],[ud.VanillaDolphin,"?"],[ud.NoThunderSwordWarp,"?"],
[t.RageSkip,"?"],[t.TriggerSkip,"?"],[t.StatueGlitch,"?"],[t.GhettoFlight,"?"],[t.SwordChargeGlitch,"?"],[t.MtSabreRequirementSkip,"?"],[Ad.RandomizeMusic,"?"],[Ad.RandomizeMapColors,"?"],[xd.RandomizeWeaknesses,"?"],[xd.TowerRobots,"?"],[jd.NoShuffleMimics,"?"],[jd.PreserveUniqueChecks,"?"],[zd.Barrier,"?"],[zd.BattleMagic,"?"],[zd.GasMask,"?"],[vd.Dyna,"?"],[vd.BonusItems,"?"],[vd.Maps,"?"],wd.SpoilerLog]);this.Hardcore=new gd(this,"Hardcore","\n      Not for the faint of heart.  Good luck.",[zd.Barrier,
zd.BattleMagic,yd.ExperienceScalesSlower,yd.MaxScalingInTower,yd.Permadeath,ud.OrbsNotRequired,ud.StoryMode,u.RandomizeMaps,u.ShuffleAreas,u.ShuffleHouses,u.RandomizeTrades,u.RandomizeWallElements,u.UnidentifiedKeyItems]);this.FullStupid=new gd(this,"The Full Stupid","\n      Only a few noble fools have ever completed this.  Be sure to record this\n      because pics or it didn't happen.",[zd.Barrier,zd.BattleMagic,yd.Blackout,yd.ExperienceScalesSlower,yd.MaxScalingInTower,yd.Permadeath,xd.RandomizeWeaknesses,
xd.TowerRobots,ud.OrbsNotRequired,ud.StoryMode,u.RandomizeMaps,u.ShuffleAreas,u.ShuffleHouses,u.RandomizeTrades,u.RandomizeWallElements,u.ShuffleGoaFloors,u.UnidentifiedKeyItems]);this.Tournament2022Early=new gd(this,"Tournament 2022 Early Rounds","\n      Lots of potential complexity, but within reason.  Requires all swords and\n      bosses, as well as a few glitches, but guarantees a starting sword.",[jd.GuaranteeStartingSword,t.StatueGlitch,t.StatueGauntletSkip,[xd.RandomizeWeaknesses,"?"],ud.OrbsNotRequired,
ud.StoryMode,[ud.VanillaDolphin,"?"],[ud.NoThunderSwordWarp,"?"],[u.RandomizeWallElements,"?"],[u.ShuffleGoaFloors,"?"],[u.RandomizeSpriteColors,"?"],[u.RandomizeTrades,"?"],[u.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new gd(this,"Tournament 2022 Mid Rounds","\n      Some additional challenges compared to the early rounds: some additional\n      mystery flags and glitches, as well as max difficulty scaling in the\n      tower.",[[jd.GuaranteeStartingSword,"?"],[t.GhettoFlight,"?"],[t.StatueGlitch,
"?"],[t.MtSabreRequirementSkip,"?"],[t.StatueGauntletSkip,"?"],yd.MaxScalingInTower,[yd.NoBuffMedicalHerb,"?"],[xd.RandomizeWeaknesses,"?"],[xd.TowerRobots,"?"],[zd.Barrier,"?"],[zd.BattleMagic,"?"],ud.StoryMode,[ud.VanillaDolphin,"?"],[ud.OrbsNotRequired,"?"],[ud.NoThunderSwordWarp,"?"],[u.RandomizeWallElements,"?"],[u.ShuffleGoaFloors,"?"],[u.RandomizeSpriteColors,"?"],[u.RandomizeTrades,"?"],[u.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new gd(this,"Tournament 2022 Finals Round","\n      Many of the more difficult mystery flags from the mid rounds are now\n      always on, plus entrance shuffle.",
[[jd.GuaranteeStartingSword,"?"],t.GhettoFlight,t.StatueGlitch,t.MtSabreRequirementSkip,t.StatueGauntletSkip,yd.NoBuffMedicalHerb,yd.MaxScalingInTower,[xd.RandomizeWeaknesses,"?"],[xd.TowerRobots,"?"],zd.Barrier,zd.BattleMagic,ud.StoryMode,[ud.VanillaDolphin,"?"],[ud.OrbsNotRequired,"?"],[ud.NoThunderSwordWarp,"?"],u.ShuffleHouses,[u.RandomizeWallElements,"?"],[u.ShuffleGoaFloors,"?"],[u.RandomizeSpriteColors,"?"],[u.RandomizeTrades,"?"],[u.UnidentifiedKeyItems,"?"]])}static get(a){this.instance||
(this.instance=new hd);return this.instance.presets.get(a.toLowerCase().replace(/[^a-z]/g,""))}}class Bd{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(a,b){Bd.sections.add(this.instance||(this.instance=new this));const c=new fd(a,b);if(!a.startsWith(this.instance.prefix))throw Error(`bad flag ${a} ${b}`);this.instance.flags.set(a,c);return c}}Bd.sections=new Set;class u extends Bd{constructor(){super(...arguments);this.prefix="W";this.name="World"}}
u.RandomizeMaps=u.flag("Wm",{name:"Randomize maps",text:"Individual maps are randomized.  For now this is only a subset of\n           possible maps.  A randomized map will have all the same features\n           (exits, chests, NPCs, etc) except things are moved around.",hard:!0});u.ShuffleAreas=u.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0});
u.ShuffleHouses=u.flag("Wh",{name:"Shuffle house entrances",text:"Shuffles all the house entrances, as well as a handful of other\n           things, like the palace/fortress-type entrances at the top of\n           several towns, and standalone houses.",hard:!0});
u.RandomizeTrades=u.flag("Wt",{name:"Randomize trade-in items",text:"Items expected by various NPCs will be shuffled: specifically,\n           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog\n           Lamp, and Flute of Lime (for Akahana).  Rage will expect a\n           random sword, and Tornel will expect a random bracelet.",hard:!0});
u.UnidentifiedKeyItems=u.flag("Wu",{name:"Unidentified key items",text:"Item names will be generic and effects will be shuffled.  This\n           includes keys, flutes, lamps, and statues.",hard:!0});u.RandomizeWallElements=u.flag("We",{name:"Randomize elements to break walls",text:'Walls will require a randomized element to break.  Normal rock and\n           ice walls will indicate the required element by the color (light\n           grey or yellow for wind, blue for fire, bright orange ("embers") for\n           water, or dark grey ("steel") for thunder.  The element to break\n           these walls is the same throughout an area.  Iron walls require a\n           one-off random element, with no visual cue, and two walls in the\n           same area may have different requirements.'});
u.ShuffleGoaFloors=u.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."});u.RandomizeSpriteColors=u.flag("Ws",{name:"Randomize sprite colors",text:"Monsters and NPCs will have different colors.  This is not an\n           optional flag because it affects what monsters can be grouped\n           together."});
u.RandomizeWildWarp=u.flag("Ww",{name:"Randomize wild warp",text:"Wild warp will go to Mezame Shrine and 15 other random locations.\n           These locations will be considered in-logic.",excludes:["Vw"]});class ud extends Bd{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}}ud.StoryMode=ud.flag("Rs",{name:"Story Mode",text:"Draygon 2 won't spawn unless you have all four swords and have\n           defeated all major bosses of the tetrarchy."});
ud.NoBowMode=ud.flag("Rb",{name:"No Bow mode",text:"No items are required to finish the game.  An exit is added from\n           Mezame shrine directly to the Draygon 2 fight (and the normal entrance\n           is removed).  Draygon 2 spawns automatically with no Bow of Truth."});ud.OrbsNotRequired=ud.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."});
ud.NoThunderSwordWarp=ud.flag("Rt",{name:"No Sword of Thunder warp",text:'Normally when acquiring the thunder sword, the player is instantly\n           warped to a random town.  This flag disables the warp.  If set as\n           "R!t", then the warp will always go to Shyron, like in vanilla.',modes:"!"});ud.VanillaDolphin=ud.flag("Rd",{name:"Vanilla Dolphin interactions",text:"By default, the randomizer changes a number of dolphin and boat\n           interactions: (1) healing the dolphin and having the Shell Flute\n           is no longer required before the fisherman spawns: instead, he\n           will spawn as soon as you have the item he wants; (2) talking to\n           Kensu in the beach cabin is no longer required for the Shell Flute\n           to work: instead, the Shell Flute will always work, and Kensu will\n           spawn after the Fog Lamp is turned in and will give a key item\n           check.  This flag restores the vanilla interaction where healing\n           and shell flute are required, and Kensu no longer drops an item."});
class t extends Bd{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description="\n      By default, the randomizer disables all known glitches (except ghetto\n      flight).  These flags selectively re-enable certain glitches.  Most of\n      these flags have two modes: normally enabling a glitch will add it as\n      possibly required by logic, but clicking a second time will add a '!'\n      and enable the glitch outside of logic (e.g. \"G!c\")."}}
t.GhettoFlight=t.flag("Gf",{name:"Ghetto flight",text:"Ghetto flight allows using Dolphin and Rabbit Boots to fly up the\n           waterfalls in the Angry Sea (without calming the whirlpools).\n           This is done by swimming up to a diagonal beach and jumping\n           in a different direction immediately before disembarking."});
t.StatueGlitch=t.flag("Gs",{name:"Statue glitch",text:"Statue glitch allows getting behind statues that block certain\n           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,\n           as well as the statues in the Waterfall Cave.  It is done by\n           approaching the statue from the top right and holding down and\n           left on the controller while mashing B.",modes:"!"});
t.MtSabreRequirementSkip=t.flag("Gn",{name:"Mt Sabre requirements skip",text:"Entering Mt Sabre North normally requires (1) having Teleport,\n           and (2) talking to the rabbit in Leaf after the abduction (via\n           Telepathy).  Both of these requirements can be skipped: first by\n           flying over the river in Cordel plain rather than crossing the\n           bridge, and then by threading the needle between the hitboxes in\n           Mt Sabre North.",modes:"!"});
t.StatueGauntletSkip=t.flag("Gg",{name:"Statue gauntlet skip",text:"The shooting statues in front of Goa and Stxy normally require\n           Barrier to pass safely.  With this flag, Flight can also be used\n           by flying around the edge of the statue.",modes:"!"});
t.SwordChargeGlitch=t.flag("Gc",{name:"Sword charge glitch",text:"Sword charge glitch allows charging one sword to the level of\n           another sword by equipping the higher-level sword, re-entering\n           the menu, changing to the lower-level sword without exiting the\n           menu, creating a hard save, resetting, and then continuing.",hard:!0,modes:"!"});
t.TriggerSkip=t.flag("Gt",{name:"Trigger skip",text:"A wide variety of triggers and exit squares can be skipped by\n           using an invalid item every frame while walking.  This allows\n           bypassing both Mt Sabre North entrance triggers, the Evil Spirit\n           Island entrance trigger, triggers for guards to move, slopes,\n           damage tiles, and seamless map transitions.",hard:!0,modes:"!"});
t.RageSkip=t.flag("Gr",{name:"Rage skip",text:"Rage can be skipped by damage-boosting diagonally into the Lime\n           Tree Lake screen.  This provides access to the area beyond the\n           lake if flight or bridges are available.  For simplicity, the\n           logic only assumes this is possible if there's a flyer.",hard:!0,modes:"!"});
class Ad extends Bd{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description='\n      These flags don\'t directly affect gameplay or shuffling, but they do\n      affect the experience significantly enough that there are three modes\n      for each: "off", "optional" (no exclamation point), and "required"\n      (exclamation point).  The first two are equivalent for seed generation\n      purposes, so that you can play the same seed with either setting.\n      Setting it to "!" will change the seed.'}}
Ad.RandomizeMusic=Ad.flag("Am",{name:"Randomize background music",modes:"!",optional:ed});Ad.NoMusic=Ad.flag("As",{name:"No background music",optional:dd});Ad.RandomizeMapColors=Ad.flag("Ac",{name:"Randomize map colors",modes:"!",optional:ed});class xd extends Bd{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}}xd.RandomizeWeaknesses=xd.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."});
xd.TowerRobots=xd.flag("Mt",{name:"Shuffle tower robots",text:"Tower robots will be shuffled into the normal pool.  At some\n           point, normal monsters may be shuffled into the tower as well.",hard:!0});class jd extends Bd{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description="\n      The following options make parts of the game easier."}}jd.NoShuffleMimics=jd.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."});
jd.PreserveUniqueChecks=jd.flag("Eu",{name:"Keep unique items and consumables separate",text:"Normally all items and mimics are shuffled into a single pool and\n           distributed from there.  If this flag is set, unique items\n           (specifically, anything that cannot be sold) will only be found in\n           either (a) checks that held unique items in vanilla, or (b) boss\n           drops.  Chests containing consumables in vanilla may be safely\n           ignored, but chests containing unique items in vanilla may still\n           end up with non-unique items because of bosses like Vampire 2 that\n           drop consumables.  If mimics are shuffled, they will only be in\n           consumable locations."});
jd.DecreaseEnemyDamage=jd.flag("Ed",{name:"Decrease enemy damage",text:"Enemy attack power will be significantly decreased in the early game\n           (by a factor of 3).  The gap will narrow in the mid-game and eventually\n           phase out at scaling level 40."});jd.GuaranteeStartingSword=jd.flag("Es",{name:"Guarantee starting sword",text:"The Leaf elder is guaranteed to give a sword.  It will not be\n           required to deal with any enemies before finding the first sword."});
jd.GuaranteeRefresh=jd.flag("Er",{name:"Guarantee refresh",text:"Guarantees the Refresh spell will be available before fighting\n           Tetrarchs."});jd.ExperienceScalesFaster=jd.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]});jd.NoCommunityJokes=jd.flag("Ec",{name:"No community jokes",text:"Skip community jokes, such as funny/misspelled item, monster, or\n           character names.  This will make it easier to look up information\n           in guides/FAQs if necessary."});
class zd extends Bd{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description="\n      Removes various guarantees from the logic."}}zd.BattleMagic=zd.flag("Nw",{name:"Battle magic not guaranteed",text:"Normally, the logic will guarantee that level 3 sword charges are\n           available before fighting the tetrarchs (with the exception of Karmine,\n           who only requires level 2).  This disables that check.",hard:!0});
zd.MatchingSword=zd.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:'Enables "tink strats", where wrong-element swords will still do a\n           single damage per hit.  Player may be required to fight monsters\n           (including bosses) with tinks.',hard:!0});
zd.Barrier=zd.flag("Nb",{name:"Barrier not guaranteed",text:"Normally, the logic will guarantee Barrier (or else refresh and shield\n           ring) before entering Stxy, the Fortress, or fighting Karmine.  This\n           disables that check.",hard:!0});
zd.GasMask=zd.flag("Ng",{name:"Gas mask not guaranteed",text:"The logic will not guarantee gas mask before needing to enter the swamp,\n           nor will leather boots (or hazmat suit) be guaranteed to cross long\n           stretches of spikes.  Gas mask is still guaranteed to kill the insect.",hard:!0});class yd extends Bd{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}}
yd.NoBuffMedicalHerb=yd.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:"Medical Herb is not buffed to heal 80 damage, which is helpful to make\n           up for cases where Refresh is unavailable early.  Fruit of Power is not\n           buffed to restore 56 MP.",hard:!0});yd.MaxScalingInTower=yd.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0});
yd.ExperienceScalesSlower=yd.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0});yd.ChargeShotsOnly=yd.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0});yd.Blackout=yd.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0});
yd.Permadeath=yd.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});class vd extends Bd{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description="\n      Options to restore vanilla behavior changed by default."}}vd.Dyna=vd.flag("Vd",{name:"Don't buff Dyna",text:"By default, we makes the Dyna fight a bit more of a challenge.\n           Side pods will fire significantly more.  The safe spot has been\n           removed.  The revenge beams pass through barrier.  Side pods can\n           now be killed.  This flag prevents that change."});
vd.BonusItems=vd.flag("Vb",{name:"Don't buff bonus items",text:"Leather Boots are changed to Speed Boots, which increase player walking\n           speed (this allows climbing up the slope to access the Tornado Bracelet\n           chest, which is taken into consideration by the logic).  Deo's pendant\n           restores MP while moving.  Rabbit boots enable sword charging up to\n           level 2 while walking (level 3 still requires being stationary, so as\n           to prevent wasting tons of magic)."});
vd.Maps=vd.flag("Vm",{name:"Vanilla maps",text:'Normally the randomizer adds a new "East Cave" to Valley of Wind,\n           borrowed from the GBC version of the game.  This cave contains two\n           chests (one considered a key item) on the upper floor and exits to\n           two random areas (chosen between Lime Tree Valley, Cordel Plain,\n           Goa Valley, or Desert 2; the quicksand is removed from the entrances\n           to Pyramid and Crypt), one unblocked on the lower floor, and one\n           down the stairs and behind a rock wall from the upper floor.  This\n           flag prevents adding that cave.  If set as "V!m" then a direct path\n           will instead be added between Valley of Wind and Lime Tree Valley\n           (as in earlier versions of the randomizer).',
modes:"!"});vd.Shops=vd.flag("Vs",{name:"Vanilla shops",text:"By default, we disable shop glitch, shuffle shop contents, and tie\n           the prices to the scaling level (item shops and inns increase by a\n           factor of 2 every 10 scaling levels, armor shops decrease by a\n           factor of 2 every 12 scaling levels).  This flag prevents all of\n           these changes, restoring shops to be completely vanilla."});
vd.WildWarp=vd.flag("Vw",{name:"Vanilla wild warp",text:"By default, Wild Warp is nerfed to only return to Mezame Shrine.\n           This flag restores it to work like normal.  Note that this will put\n           all wild warp locations in logic unless the flag is set as (V!w).",modes:"!"});
vd.Hud=vd.flag("Vh",{name:"Vanilla HUD",text:"By default, the blue status bar (HUD) at the bottom of the screen\n           is reorganized a bit, including displaying enemies' names and HP.\n           This can be set either as Vh (which will optionally disable the\n           changes, and will produce the same seed as not setting Vh) or as\n           V!h (which requires all players to disable it to get the same\n            seed).",modes:"!",optional:ed});
class Cd extends Bd{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description="\n      The following quality-of-life flags turn <i>off</i> improvements that\n      are normally on by default.  They are optional and will not affect the\n      seed generation.  They may be toggled freely in race mode."}}
Cd.NoAutoEquip=Cd.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:"Prevents adding a quality-of-life improvement to automatically equip\n           the corresponding orb/bracelet whenever changing swords.",optional:dd});
Cd.NoControllerShortcuts=Cd.flag("Qc",{name:"Disable controller shortcuts",text:"By default, we disable second controller input and instead enable\n           some new shortcuts on controller 1: Start+A+B for wild warp, and\n           Select+B to quickly change swords.  To support this, the action of\n           the start and select buttons is changed slightly.  This flag\n           disables this change and retains normal behavior.",optional:dd});
Cd.AudibleWallCues=Cd.flag("Qw",{name:"Audible wall cues",text:"Provide an audible cue when failing to break a non-iron wall.\n           The intended way to determine which sword is required for normal\n           cave walls is by looking at the color.  This causes the level 3\n           sword sound of the required element to play when the wall fails\n           to break.  Note that fortress walls (iron in vanilla) do not give\n           this hint, since there is no visual cue for them, either.",
optional:dd});class wd extends Bd{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description="\n      These options are helpful for exploring or debugging.  Note that,\n      while they do not directly affect any randomization, they\n      <i>do</i> factor into the seed to prevent cheating, and they\n      will remove the option to generate a seed for racing."}}wd.SpoilerLog=wd.flag("Ds",{name:"Generate a spoiler log",text:"Note: <b>this will change the placement of items</b> compared to a\n           seed generated without this flag turned on."});
wd.TrainerMode=wd.flag("Dt",{name:"Trainer mode",text:"Installs a trainer for practicing certain parts of the game.\n           At the start of the game, the player will have all swords, basic\n           armors and shields, all worn items and magics, a selection of\n           consumables, bow of truth, maximum cash, all warp points activated,\n           and the Shyron massacre will have been triggered.  Wild warp is\n           reconfigured to provide easy access to all bosses.  Additionally,\n           the following button combinations are recognized:<ul>\n             <li>Start+Up: increase player level\n             <li>Start+Down: increase scaling level\n             <li>Start+Left: get all balls\n             <li>Start+Right: get all bracelets\n             <li>Start+B+Down: get a full set of consumable items\n             <li>Start+B+Left: get all advanced armors\n             <li>Start+B+Right: get all advanced shields\n           </ul>"});
wd.NeverDie=wd.flag("Di",{name:"Player never dies"});wd.NoShuffle=wd.flag("Dn",{name:"Do not shuffle items",text:"Items will not be shuffled. WARNING: This disables the logic and\n           is very likely to result in an unwinnable seed"});
class id{constructor(a="@Casual"){if("string"!==typeof a){this.flags=new Map;for(const [b,c]of a)this.set(b.flag,c)}else if(a.startsWith("@")){var b=hd.get(a.substring(1));if(!b)throw new ca(`Unknown preset: ${a}`);this.flags=new Map(b.flags)}else{this.flags=new Map;a=a.replace(/[^A-Za-z0-9!?]/g,"");b=/([A-Z])([a-z0-9!?]+)/g;for(var c;c=b.exec(a);){const [,a,b]=c,f=/([!?]|^)([a-z0-9]+)/g;for(;c=f.exec(b);){const [,b,d]=c;for(const c of d)this.set(a+c,b||!0)}}}}filterOptional(){return new id(new Map([...this.flags].map(([a,
b])=>[a,a.opts.optional?a.opts.optional(b):b])))}filterRandom(a){return new id(new Map([...this.flags].map(([b,c])=>{c="?"!==c?c:a.pick([!0,!1,...b.opts.modes||""]);return[b,c]})))}toString(){var a=new da(()=>new da(()=>[]));for(const [b,d]of this.flags){if(2!==b.flag.length)throw Error(`Bad flag ${b.flag}`);d&&a.get(b.flag[0]).get(!0===d?"":d).push(b.flag[1])}const b=[];for(const [c,d]of a.sortedEntries()){a=c;for(const [b,c]of d.sortedEntries())a+=b+c.sort().join("");b.push(a)}return b.join(" ")}toggle(a){const b=
fd.flags.get(a);if(!b)return console.error(`Bad flag: ${a}`),!1;a=this.flags.get(b)||!1;const c=[!1,!0,...b.opts.modes||"","?",!1],d=c.indexOf(a);if(0>d)throw Error(`Bad current mode ${a}`);a=c[d+1];this.flags.set(b,a);return a}set(a,b){var c;const d=fd.flags.get(a);if(d){if(b)if(!0===b||"?"===b||(null===(c=d.opts.modes)||void 0===c?0:c.includes(b)))this.flags.set(d,b);else{console.error(`Bad flag mode: ${a[0]}${b}${a.substring(1)}`);return}else this.flags.delete(d);for(const a of d.opts.excludes||
[])this.flags.delete(fd.flags.get(a))}else console.error(`Bad flag: ${a}`)}check(a,...b){a=a instanceof fd?a:fd.flags.get(a);b.length||b.push(!0);return b.includes(a&&this.flags.get(a)||!1)}get(a){return(a=a instanceof fd?a:fd.flags.get(a))&&this.flags.get(a)||!1}preserveUniqueChecks(){return this.check(jd.PreserveUniqueChecks)}shuffleMimics(){return this.check(jd.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(vd.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(vd.BonusItems,
!1)}slowDownTornado(){return this.check(vd.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(vd.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(vd.BonusItems,!1)}shuffleSpritePalettes(){return this.check(u.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(vd.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(xd.TowerRobots)}shuffleMonsterElements(){return this.check(xd.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(yd.NoBuffMedicalHerb,
!1)}decreaseEnemyDamage(){return this.check(jd.DecreaseEnemyDamage)}trainer(){return this.check(wd.TrainerMode)}neverDie(){return this.check(wd.NeverDie)}noShuffle(){return this.check(wd.NoShuffle)}chargeShotsOnly(){return this.check(yd.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(vd.Maps,"!")}addEastCave(){return this.check(vd.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(ud.VanillaDolphin,
!1)}storyMode(){return this.check(ud.StoryMode)}noBowMode(){return this.check(ud.NoBowMode)}requireHealedDolphinToRide(){return this.check(ud.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(ud.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(ud.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(ud.OrbsNotRequired)}shuffleGoaFloors(){return this.check(u.ShuffleGoaFloors)}shuffleHouses(){return this.check(u.ShuffleHouses)}shuffleAreas(){return this.check(u.ShuffleAreas)}randomizeMaps(){return this.check(u.RandomizeMaps)}randomizeTrades(){return this.check(u.RandomizeTrades)}unidentifiedItems(){return this.check(u.UnidentifiedKeyItems)}randomizeWalls(){return this.check(u.RandomizeWallElements)}guaranteeSword(){return this.check(jd.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(zd.BattleMagic,
!1)}guaranteeMatchingSword(){return this.check(zd.MatchingSword,!1)}guaranteeGasMask(){return this.check(zd.GasMask,!1)}guaranteeBarrier(){return this.check(zd.Barrier,!1)}guaranteeRefresh(){return this.check(jd.GuaranteeRefresh)}communityJokes(){return this.check(jd.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(t.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(t.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(t.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(vd.Shops,
!1)}disableStatueGlitch(){return this.check(t.StatueGlitch,!1)}disableRageSkip(){return this.check(t.RageSkip,!1)}disableTriggerGlitch(){return this.check(t.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(t.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(t.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(t.GhettoFlight)}assumeTeleportSkip(){return this.check(t.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(t.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(t.StatueGlitch)}assumeTriggerGlitch(){return this.check(t.TriggerSkip)}assumeFlightStatueSkip(){return this.check(t.StatueGauntletSkip)}assumeWildWarp(){return this.check(vd.WildWarp,
!0)||this.check(u.RandomizeWildWarp)}assumeRageSkip(){return this.check(t.RageSkip)}nerfWildWarp(){return this.check(vd.WildWarp,!1)&&this.check(u.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(u.RandomizeWildWarp,!0)}blackoutMode(){return this.check(yd.Blackout)}hardcoreMode(){return this.check(yd.Permadeath)}buffDyna(){return!this.check(vd.Dyna)}maxScalingInTower(){return this.check(yd.MaxScalingInTower)}expScalingFactor(){return this.check(yd.ExperienceScalesSlower)?
.25:this.check(jd.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(a){return"early"===a||this.check(Cd.NoAutoEquip,!1)}controllerShortcuts(a){return"early"===a||this.check(Cd.NoControllerShortcuts,!1)}randomizeMusic(a){return this.check(Ad.RandomizeMusic,"early"===a?"!":!0)}shuffleTilePalettes(a){return this.check(Ad.RandomizeMapColors,"early"===a?"!":!0)}noMusic(a){return"late"===a&&this.check(Ad.NoMusic)}audibleWallCues(a){return"late"===a&&this.check(Cd.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(vd.Hud,
!1)}hasStatTracking(){return!0}};const Dd={of:(...a)=>a.map(a=>a.uid)};class Ed{constructor(a,b){this.graph=a;this.name=b;this.uid=a.nodes.length;a.nodes.push(this)}get nodeType(){return"Node"}toString(){return`${this.nodeType} ${this.name}`}edges(){return[]}write(){}}
class Sd{constructor(a){this.rom=a;this.nodes=[]}traverse({wanted:a,dfs:b=!1}={}){const c=new aa,d=new Map,e=new Map;for(var f of this.nodes)for(var g of f.edges()){var h=g.join(" ");for(let a=1;a<g.length;a++){const b=g[a];e.has(b)||e.set(b,new Map);e.get(b).set(h,g)}1===g.length&&(h=g[0],d.has(h)||(c.push(h),d.set(h,g)))}a=new Set((a||this.nodes).map(a=>a instanceof Ed?a.uid:a));for(f=new Map;a.size&&c.length;){g=b?c.pop():c.shift();a.delete(g);a:for(const a of(e.get(g)||f).values())if(g=a[0],!d.has(g)){for(h=
1;h<a.length;h++)if(!d.has(a[h]))continue a;d.set(g,a);c.push(g)}}return{path:[...d.values()].map(([a,...b])=>{const c=a=>[this.nodes[a]];return[a,[...c(a)," (",b.map(a=>c(a).join("").replace(/\s+\(.*\)/,"")).join(", "),")"].join("")]}),seen:d,win:!a.size}}}
class Td{constructor(a){this.nodes=Array(a).fill(0).map(()=>new Map);this.finalized=Array(a).fill(!1)}addRoute(a){const b=a[0];if(this.finalized[b])throw Error(`Attempted to add a route for finalized node ${b}`);let c=new Set;for(let b=a.length-1;1<=b;b--)c.add(a[b]);for(;;){a=!1;for(var d of c){if(d===b)return[];if(this.finalized[d]){a=this.nodes[d];if(!a.size)return[];c.delete(d);if(1===a.size){for(const b of a.values().next().value)c.add(b);a=!0;break}d=new Map;for(var e of a.values())for(var f of this.addRoute([b,
...c,...e]))d.set(f.label,f);return[...d.values()]}}if(!a)break}e=[...c].sort();c=new Set(e);e=e.join(" ");f=this.nodes[b];if(f.has(e))return[];for(const [a,b]of f){if(Ud(c,b))return[];Ud(b,c)&&f.delete(a)}f.set(e,c);return[{target:b,deps:c,label:`${b}:${e}`}]}finalize(a){if(!this.finalized[a]){this.finalized[a]=!0;for(let b=0;b<this.nodes.length;b++){const c=this.nodes[b];if(c.size)for(const [d,e]of c)if(e.has(a)){const a=this.finalized[b];this.finalized[b]=!1;c.delete(d);this.addRoute([b,...e.values()]);
this.finalized[b]=a}}}}}const Ud=(a,b)=>{if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0};function Vd(a){return a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace(/Of/g,"of").replace(/_/g," - ")}function Wd(a){return Vd(a).replace(/^./,a=>a.toUpperCase())}function w(a,b=a=>a){return Array(a).fill(0).map((a,d)=>b(d))}function Xd(a,b,c){return Array.from(a.slice(b,b+c))}function Yd(a){return 128>a?a:a-256}function Zd(a,b,c,d,e=Infinity,f){f||(f=a=>a);const g=[];for(;b+c<=e&&a[b]!==d;)g.push(f(a.slice(b,b+c))),b+=c;return g}function $d(a,b,c=0){return(a[b]|a[b+1]<<8)+c}
function ae(a,b,c){c||(c=a=>a);return w(Math.max(0,Math.floor(b.length/a)),d=>{var e=c;d*=a;d=b.slice(d,d+a);return e(d)})}function be(a){return 65793*(2050*a&139536|32800*a&558144)>>>16&255}function x(a){return null!=a?a.toString(16).padStart(2,"0"):String(a)}function ce(a){const b=[];for(const c of a)for(const a of c)b.push(a);return b}function de(a,b){return a[b]<<8|a[b+1]}function ee(a,b){return a[b+1]<<8|a[b]}
function fe(a,b,c=0){const d=[];for(;a[b]!=c;)d.push(a[b++]);return String.fromCharCode(...d)}
class ge{constructor(a,b,c=!1){this.last=a;this.clear=b;this.nonEmpty=c}read(a,b=0){const c=[];for(;;){const e=a[b++];var d=a[b++];d|=(e&3)<<8;d=e&this.clear?~d:d;-1!==d&&c.push(d);if(e&this.last)return c}}bytes(a){a=a.filter(a=>-1!==a);this.nonEmpty&&!a.length&&(a=[-1]);const b=[];for(let c=0;c<a.length;c++){let d=a[c];0>d&&(d=this.clear<<8|~d);c===a.length-1&&(d|=this.last<<8);b.push(d>>>8);b.push(d&255)}return b}write(a,b,c=0){b=this.bytes(b);for(let d=0;d<b.length;d++)a[d+c]=b[d]}}
const he=new ge(64,128),ie=new ge(64,128,!0),je=new ge(64,128,!0),ke=new ge(128,32,!0),le=new ge(128,32);function me(){function a(...a){return{tag:b,args:a}}const b=Symbol();a.commit=(a,d)=>{for(const c of Object.getOwnPropertyNames(a)){const e=a[c];e.tag===b&&(a[c]=d(c,...e.args))}};return a}const ne=Symbol("PROP_TAG"),oe=new WeakMap;
function ve(a){let b=oe.get(a);if(!b){b=class extends we{};Object.defineProperties(b,{name:{value:a.name}});Object.assign(b,a);Reflect.setPrototypeOf(b.prototype,a.prototype);const c=new a,d={};for(const [a,b]of Object.entries(c))b&&b[ne]&&(d[a]=b);Object.defineProperties(b.prototype,d);oe.set(a,b);oe.set(b,b)}return b}
class we{constructor(a){this.data=a}static of(a){return Object.assign(new (ve(this))(Array(this.size).fill(0)),a)}static from(a,b=0){const c=ve(this);a=b||a.length!==this.size?Xd(a,b,this.size):a;return new c(a)}[Symbol.iterator](){return this.data[Symbol.iterator]()}hex(){return Array.from(this.data,x).join(" ")}clone(){return new this.constructor(this.data)}prop(...a){return{get(){let b=0;for(const [c,d=255,e=0]of a)b|=(this.data[c]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b},set(b){for(const [c,d=255,
e=0]of a)this.data[c]=this.data[c]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d},[ne]:!0}}booleanProp(a,b){return{get(){return!!(this.data[a]&1<<b)},set(c){const d=1<<b;this.data[a]=c?this.data[a]|d:this.data[a]&~d},[ne]:!0}}}class B{constructor(a,b,c){this.name=a;this.bank=b;this.org=c}get offset(){return(this.bank&31)<<13}}B.$04=new B("04",4,32768);B.$05=new B("05",5,40960);B.$0a=new B("0a",10,32768);B.$0b=new B("0b",11,40960);B.$0c=new B("0c",12,32768);B.$0d=new B("0d",13,40960);B.$0e=new B("0e",14,32768);
B.$0f=new B("0f",15,40960);B.$10=new B("10",16,32768);B.$14=new B("14",20,32768);B.$15=new B("15",21,40960);B.$16_a=new B("16:a",22,40960);B.$17=new B("17",23,40960);B.$18=new B("18",24,32768);B.$19=new B("19",25,40960);B.$1a=new B("1a",26,32768);B.$1b=new B("1b",27,40960);B.$fe=new B("fe",30,49152);B.$ff=new B("ff",31,57344);
class xe{constructor(a,b){this.seg=a;this.delta=b}static of(a,b){return new xe(a,b-a.org)}get offset(){return this.seg.offset+this.delta}get org(){return this.seg.org+this.delta}get segment(){return this.seg.name}plus(a,b){a=this.delta+a;if(8192<=a){if(!b)throw Error("Segment changed");if(this.seg.org&8192)throw Error("Bad segment cross");return new xe(b,a&8191)}return new xe(this.seg,a)}minus(a){if(a.seg!==this.seg)throw Error("Incompatible segments");return this.delta-a.delta}read(a){return a[this.offset]}readLittleEndian(a){const b=
this.offset;return a[b]|a[b+1]<<8}readAddress(a,...b){a=this.readLittleEndian(a);b.length||(b=[this.seg]);for(const c of b)if((a&57344)===(c.org&57344))return xe.of(c,a);throw Error(`Could not find valid segment for ${x(a)}`);}loc(a,b){a.segment(this.segment);a.org(this.org,b)}}function ye(a,b,c,d){a.segment(b.name);a.org(c);a.free(d-c)}function ze(a,b,c){a.segment(...b.map(a=>a.name));a.reloc(c);a.label(c);a.export(c)};class Ae extends Ed{constructor(a,b,c){super(a,c);this.type=b}get nodeType(){return"Tracker"}edges(){return[]}}Ae.OFF_ROUTE=1;Ae.GLITCH=2;Ae.HARD=3;class Be extends Ed{constructor(a,b,c){super(a,b);this.value=c}get nodeType(){return"Option"}edges(){return this.value?[Dd.of(this)]:[]}}
class Ce extends Ed{constructor(a,b,c,d,e=[]){super(a,b);this.item=c;this.slots=e;this.isInvisible=this.requiresUnique=!1;this.slotName=b;this.slotIndex=d;this.slotType=c instanceof De?"magic":"consumable";this.vanillaItemName=c.name;this.itemIndex=d}get nodeType(){return"Slot"}toString(){return`${super.toString()} [${this.vanillaItemName} $${this.slotIndex.toString(16).padStart(2,"0")}]`}edges(){return null!=this.item&&null!=this.itemIndex?[Dd.of(this.item,this)]:[]}isFixed(){return!1}isMimic(){return 112<=
this.itemIndex}requireUnique(){this.requiresUnique=!0;return this}canHoldMimic(){return this instanceof Ee&&!this.isInvisible}needsChest(){const a=this.itemIndex;return 13<=a&&36>=a||38===a||72<a}isChest(){return(this instanceof Ee||this instanceof Fe)&&9!==this.slotIndex}get name2(){return this.item.name===this.vanillaItemName?this.name:`${this.item.name} [${this.vanillaItemName}]`}set(a,b){this.item=a;this.itemIndex=b}write(){if(this.slots){var a=this.graph.rom;if(a)for(const b of this.slots)b(a,
this)}}swap(a){const b=this.item,c=this.itemIndex;this.set(a.item,a.itemIndex);a.set(b,c)}key(){this.slotType="key";return this}bonus(){this.slotType="bonus";return this}direct(a){this.slots.push((b,c)=>{b.prg[a]=c.itemIndex});return this}fromPerson(a,b,c=0){this.slots.push((a,e)=>{a.npcs[b].data[c]=e.itemIndex});return this}npcSpawn(a,b,c=0){this.slots.push((d,e)=>{d=d.npcs[a].spawnConditions;null==b&&(b=Ge(d.keys()));d=d.get(b);if(!d)throw Error(`No spawn found for NPC $${x(a)} @ $${x(b)}`);d[c]=
He(d[c],e)});return this}dialog(a,b,c=0,d){this.slots.push((e,f)=>{e=e.npcs[a].localDialogs;null==b&&(b=Ge(e.keys()));e=e.get(b);if(!e)throw Error(`No dialog found for NPC $${x(a)} @ $${x(b)}`);e=e[c];if(!e)throw Error(`No such dialog ${c}`);null==d?e.condition=He(e.condition,f):e.flags[d]=He(e.flags[d],f)});return this}trigger(a,b=0,c){this.slots.push((d,e)=>{d=d.triggers[a&127];null==c?d.conditions[b]=He(d.conditions[b],e):d.flags[c]=He(d.flags[c],e)});return this}}
class Ie extends Ce{isFixed(){return!0}}class Fe extends Ce{get nodeType(){return"BossDrop"}}
class Ee extends Ce{constructor(a,b,c,d){super(a,b,c,d);this.spawnSlot=null;this.isInvisible=!1}get nodeType(){return"Chest"}objectSlot(a,b){this.spawnSlot=b;this.slots.push((c,d)=>{c=c.locations[a];if(!c||!c.used)throw Error(`No such location: $${x(a)}`);c=c.spawns[b-13];if(!c||!c.isChest())throw Error(`No chest $${x(b)} on $${x(a)}`);c.timed=!1;c.id=Math.min(d.itemIndex,112)});return this}invisible(a){this.isInvisible=!0;return this.direct(a)}}
class Je extends Ed{constructor(a,b,c){super(a,c);this.id=b;this.shufflePriority=1;this.inventoryRow="unique"}get nodeType(){return"ItemGet"}chest(a=this.name+" chest",b=this.id){return new Ee(this.graph,a,this,b)}fromPerson(a,b,c=0){return new Ce(this.graph,a,this,this.id,[(a,e)=>{a.npcs[b].data[c]=e.itemIndex}])}bossDrop(a,b,c=this.id){return new Fe(this.graph,a,this,c,[(a,c)=>{a.bossKills[b].itemDrop=c.itemIndex}])}direct(a,b){return new Ce(this.graph,a,this,this.id,[(a,d)=>{a.prg[b]=d.itemIndex}])}fixed(){return new Ie(this.graph,
this.name,this,this.id)}weight(a){this.shufflePriority=a;return this}consumable(){this.inventoryRow="consumable";return this}armor(){this.inventoryRow="armor";return this}}class C extends Je{get nodeType(){return"Item"}}class De extends Je{get nodeType(){return"Magic"}}
class D extends Ed{constructor(a,b){super(a,b);this.slot=null;this.reqs=[]}get nodeType(){return"Trigger"}edges(){const a=[...this.reqs];this.slot&&a.push(Dd.of(this.slot,this));return a}get(a){if(this.slot)throw Error("already have a slot");this.slot=a;return this}}class Ke extends Ed{constructor(a,b){super(a,b);this.options=[]}get nodeType(){return"Condition"}edges(){return this.options.map(a=>Dd.of(this,...a))}option(...a){this.options.push(a.map(a=>a instanceof Ce?a.item:a));return this}}
class Le extends D{constructor(a,b,c,...d){super(a,c);this.index=b;this.deps=d.map(a=>a instanceof Ce?a.item:a)}get nodeType(){return"Boss"}}class Me extends Ed{get nodeType(){return"Area"}}class Ne{constructor(a,b,c=!1,d=[]){this.from=a;this.to=b;this.bidi=c;this.deps=d.map(a=>a instanceof Ce?a.item:a)}reverse(){return new Ne(this.to,this.from,this.bidi,this.deps)}}
class F extends Ed{constructor(a,b,c,d){super(a,c.name+": "+d);this.id=b;this.area=c;this.connections=[];this.chests=[];this.type=this.bossNode=null;this.isEnd=this.isStart=!1;this.sells=[];this.simpleName=d}get nodeType(){return"Location"}toString(){return`Location ${this.id.toString(16).padStart(2,"0")} ${this.name}`}edges(){const a=[];for(const b of this.connections)a.push(Dd.of(b.to,b.from,...b.deps,...b.from.bossNode?[b.from.bossNode]:[])),b.bidi&&a.push(Dd.of(b.from,b.to,...b.deps,...b.to.bossNode?
[b.to.bossNode]:[]));for(const b of this.chests)a.push(Dd.of(b,this));this.isStart&&a.push(Dd.of(this));return a}addConnection(a){a.from.connections.push(a);a.to.connections.push(a);return this}from(a,...b){return this.addConnection(new Ne(a,this,!1,b))}to(a,...b){return this.addConnection(new Ne(this,a,!1,b))}connect(a,...b){return this.addConnection(new Ne(a,this,!0,b))}connectTo(a,...b){return this.addConnection(new Ne(this,a,!0,b))}chest(a,b,c){a instanceof Ce&&!(a instanceof Ee)&&null!=c&&(a=
a.item);a instanceof Je&&(a=a.chest(void 0,c));b=a.objectSlot(this.id,b);this.chests.push(b);112<=b.itemIndex&&(b.slotType="trap");if(!b.slotName||b.slotName.endsWith(" chest"))b.slotName=a.name+" in "+this.area.name;return this}trigger(a,...b){b=b.map(a=>a instanceof Ce?a.item:a);a.reqs.push(Dd.of(a,this,...b));return this}boss(a){this.bossNode=a;a.reqs.push(Dd.of(a,this,...a.deps));return this}overworld(){this.type="overworld";return this}town(){this.type="town";return this}cave(){this.type="cave";
return this}sea(){this.type="sea";return this}fortress(){this.type="fortress";return this}house(){this.type="house";return this}shop(...a){this.type="house";this.sells=a.map(a=>a instanceof Ce?a.item:a);return this}misc(){this.type="misc";return this}start(){this.isStart=!0;return this}end(){this.isEnd=!0;return this}fullName(){const a=[this.simpleName];this.bossNode&&a.push(this.bossNode.name);return a.join("\\n")}write(){if(this.sells.length){var a=this.graph.rom;if(!a)throw Error("Cannot write without a rom");
for(const b of a.shops)if(b.location===this.id)for(a=0;4>a;a++)b.contents[a]=this.sells[a]?this.sells[a].id:255}}}
class Oe extends Sd{write(){for(const a of this.nodes)a.write()}shuffleShops(a){const b={shops:[],items:[]},c={shops:[],items:[]};for(var d of this.nodes)if(d instanceof F&&d.sells.length){var e="armor"===d.sells[0].inventoryRow?b:c;e.shops.push(d);for(let a=0;4>a;a++)e.items.push(d.sells[a]||null);d.sells=[]}a.shuffle(b.items);a.shuffle(c.items);for(const {shops:f,items:g}of[b,c])for(a=0;g.length&&1E5>a;)d=g.pop(),e=f[a++%f.length],d&&(0<=e.sells.indexOf(d)||4<=e.sells.length?g.push(d):e.sells.push(d));
for(const {shops:a}of[b,c])for(const b of a)b.sells.sort((a,b)=>a.id-b.id)}integrate({tracker:a=!1}={}){var b=!a;const c=new Td(this.nodes.length);var d=[],e=[];const f=new Set,g=new Map;var h=[];const k=[],l=[],n=[],q=[],v=new Set;for(const a of this.nodes)if(a instanceof F){if(a.isStart){const [b]=c.addRoute([a.uid]);g.set(b.label,b)}d[a.uid]=[];e[a.uid]=[];for(const b of a.connections)f.has(b)||(f.add(b),b.bidi&&f.add(b.reverse()));for(const b of a.chests)c.addRoute([b.uid,a.uid])}else if(a instanceof
Je&&"Medical Herb"===a.name&&(c.addRoute([a.uid]),c.finalize(a.uid)),a instanceof Be)h.push(a);else if(a instanceof Ae)k.push(a);else if(a instanceof Ke)l.push(a);else if(a instanceof D)n.push(a);else if(a instanceof Je)q.push(a);else if(a instanceof Ce)v.add(a);else if(!(a instanceof Me))throw Error(`Unknown node type: ${a.nodeType}`);for(const a of f)d[a.from.uid].push(a),e[a.to.uid].push(a);e=b=>{for(const d of b){for(const b of d.edges({tracker:a}))c.addRoute(b);c.finalize(d.uid)}};e(h);b&&e(k);
e(n);for(const a of g.values()){b=a.target;for(const e of d[b]){b=[e.to.uid,...a.deps];for(h=e.deps.length-1;0<=h;h--)b.push(e.deps[h].uid);e.from.bossNode&&b.push(e.from.bossNode.uid);for(const a of c.addRoute(b))g.has(a.label)||g.set(a.label,a)}}e(l);for(d=0;d<this.nodes.length;d++)this.nodes[d]instanceof Je||this.nodes[d]instanceof Ae||c.finalize(d);d=new gf(this);for(const a of v)for(const b of c.nodes[a.uid].values())d.addRoute([a.uid,...b]);return d}}
class gf{constructor(a){this.worldGraph=a;this.uidToLocation=[];this.locationToUid=[];this.uidToItem=[];this.itemToUid=[];this.routes=[];this.unlocks=[];this.win=null}item(a){return this.worldGraph.nodes[this.itemToUid[a]]}location(a){return this.worldGraph.nodes[this.locationToUid[a]]}addRoute(a){let b=tc.of(),c=-1;const d=[];for(let f=a.length-1;0<=f;f--){var e=f?this.uidToItem:this.uidToLocation;const g=f?this.itemToUid:this.locationToUid,h=a[f];let k=e[h];null==k&&(k=g.length,g.push(h),e[h]=k,
e=this.worldGraph.nodes[h],!f&&e instanceof Ce&&e.isFixed()&&(this.win=k));f?(b=tc.with(b,k),d.push(this.unlocks[k]||(this.unlocks[k]=new Set))):c=k}(this.routes[c]||(this.routes[c]=[])).push(b);for(const a of d)a.add(c)}canReach(a,b){a=this.routes[this.uidToLocation[a.uid]];for(let c=0,d=a.length;c<d;c++)if(tc.containsAll(b,a[c]))return!0;return!1}traverse(a=tc.of(),b=[]){a=tc.clone(a);const c=new Set,d=new Set;for(var e=0;e<this.locationToUid.length;e++)d.add(e);for(const f of d)if(d.delete(f),
!c.has(f)){e=this.routes[f];for(let g=0,h=e.length;g<h;g++)if(tc.containsAll(a,e[g])){c.add(f);if(b[f]){a=tc.with(a,b[f]);for(const a of this.unlocks[b[f]])d.add(a)}break}}return c}traverseDepths(a){let b=tc.of(),c=0;const d=[],e={},f=new Set;for(var g=0;g<this.locationToUid.length;g++)f.add(g);f.add(e);for(const h of f)if(f.delete(h),"number"!==typeof h)f.size&&f.add(e),c++;else if(null==d[h]){g=this.routes[h];for(let e=0,l=g.length;e<l;e++)if(tc.containsAll(b,g[e])){d[h]=c;if(a[h]){b=tc.with(b,
a[h]);for(const b of this.unlocks[a[h]])f.add(b)}break}}return d}toString(){const a=[];for(let b=0;b<this.routes.length;b++){const c=this.location(b),d=this.routes[b],e=[];for(let a=0,b=d.length;a<b;a++){const b=[];for(const c of tc.bits(d[a]))b.push(this.item(c));e.push("("+b.join(" & ")+")")}a.push(`${c}: ${e.join(" | ")}`)}return a.join("\n")}assumedFill(a,b=()=>!0,c=hf){const d=c.shuffleItems(this.itemToUid.map(a=>this.worldGraph.nodes[a]),a);let e=tc.from(d);const f=Array(this.locationToUid.length).fill(null);
for(;d.length;){const g=d.pop();if(!tc.has(e,g))continue;const h=this.item(g);e=tc.without(e,g);const k=[...this.traverse(e,f)].filter(a=>null==f[a]);c.shuffleSlots(h,k,a);let l=!1;for(const a of k)if(null==f[a]&&a!==this.win&&b(this.location(a),h)){if(100<a)throw Error("Something went horribly wrong");f[a]=g;l=!0;break}if(!l)return null}return f}}
const hf={shuffleSlots:(a,b,c)=>{c.shuffle(b)},shuffleItems:(a,b)=>{const c=[];for(let b=0;b<a.length;b++){const {shufflePriority:d=1}=a[b];for(let a=0;a<d;a++)c.push(b)}b.shuffle(c);return c}};function Ge(a){for(const b of a)return b;throw Error("Empty iterable");}function He(a,b){return 0>a?~(512|b.itemIndex):512|b.itemIndex};const jf=(a=new id,b)=>{const c=new Oe(b),d=(a,b=!0)=>new Be(c,a,b),e=(a,b,...d)=>new Le(c,a,b,...d),f=new Ae(c,Ae.GLITCH,"Glitch"),g=new Ae(c,Ae.HARD,"Hard"),h=a=>a.value?a:f,k=d("Leather Boots grant speed",a.leatherBootsGiveSpeed()),l=h(d("Assume ghetto flight",a.assumeGhettoFlight())),n=h(d("Assume statue glitch",a.assumeStatueGlitch())),q=d("Allow statue glitch",!a.disableStatueGlitch()),v=h(d("Assume teleport skip",a.assumeTeleportSkip())),y=d("Allow teleport skip",!a.disableTeleportSkip()),
A=h(d("Assume rabbit skip",a.assumeRabbitSkip())),z=h(d("Allow rabbit skip",!a.disableRabbitSkip())),R=h(d("Assume sword charge glitch",a.assumeSwordChargeGlitch())),G=d("Allow sword charge glitch",!a.disableSwordChargeGlitch()),E=h(d("Assume wild warp",a.assumeWildWarp())),L=d("Allow wild warp",a.allowWildWarp()),fa=d("Sword magic optional",!a.guaranteeSwordMagic()),ba=d("Matching sword optional",!a.guaranteeMatchingSword()),lb=d("Gas mask optional",!a.guaranteeGasMask()),ea=d("Healed dolphin optional",
!a.requireHealedDolphinToRide()),Eb=d("Calm sea optional",!a.barrierRequiresCalmSea()),sb=d("Prison key optional",!1),xc=d("Windmill optional",!1),bc=d("Sword of Thunder teleports to Shyron",a.teleportOnThunderSword()),yb=d("Barrier magic optional",!a.guaranteeBarrier()),zb=d("Refresh magic optional",!a.guaranteeRefresh()),Nc=d("Telepathy optional for Deo",!a.saharaRabbitsRequireTelepathy()),kd=d("Lime Tree connects to Leaf",a.connectLimeTreeToLeaf()),ld=d("Buffed medical herb",a.buffMedicalHerb()),
nb=d("Orbs optional",a.orbsOptional()),ob=(new C(c,0,"Sword of Wind")).weight(a.guaranteeSword()?10:5).fromPerson("Leaf elder",13).npcSpawn(94,16,1).dialog(13,192,2).key(),Na=(new C(c,1,"Sword of Fire")).weight(a.guaranteeSword()?10:5).fromPerson("Oak elder",29).dialog(29,void 0,3).key(),ab=(new C(c,2,"Sword of Water")).weight(10).chest().key(),Qa=(new C(c,3,"Sword of Thunder")).weight(15).chest().key(),Oc=(new C(c,4,"Crystalis")).fixed(),Qb=(new C(c,5,"Ball of Wind")).chest().key(),cc=(new C(c,6,
"Tornado Bracelet")).chest().key(),dc=(new C(c,7,"Ball of Fire")).bossDrop("Insect",1).dialog(30,void 0,2).dialog(32,void 0,0).dialog(33,void 0,0).dialog(34,void 0,0).dialog(96,30,0).dialog(29,void 0,2).dialog(31,void 0,1).npcSpawn(193).key(),ec=(new C(c,8,"Flame Bracelet")).bossDrop("Kelbesque 1",2).npcSpawn(194).key(),Pc=(new C(c,9,"Ball of Water")).weight(5).direct("Rage",250679).npcSpawn(195).key(),bb=(new C(c,10,"Blizzard Bracelet")).weight(5).chest().key(),fc=(new C(c,11,"Ball of Thunder")).bossDrop("Mado 1",
5).trigger(154,1).key(),gc=(new C(c,12,"Storm Bracelet")).chest().key(),Qc=(new C(c,13,"Carapace Shield")).armor(),Rc=(new C(c,14,"Bronze Shield")).armor(),Fd=(new C(c,15,"Platinum Shield")).armor(),md=(new C(c,16,"Mirrored Shield")).armor(),yc=(new C(c,17,"Ceramic Shield")).armor(),U=(new C(c,18,"Sacred Shield")).armor().bossDrop("Mado 2",8).npcSpawn(199).bonus(),pb=(new C(c,19,"Battle Shield")).armor(),hc=(new C(c,20,"Psycho Shield")).armor(),Ha=(new C(c,21,"Tanned Hide")).armor(),Fb=(new C(c,22,
"Leather Armor")).armor(),cb=(new C(c,23,"Bronze Armor")).armor(),Rb=(new C(c,24,"Platinmum Armor")).armor(),nd=(new C(c,25,"Soldier Suit")).armor(),zc=(new C(c,26,"Ceramic Suit")).armor(),im=(new C(c,27,"Battle Suit")).armor(),jm=(new C(c,28,"Psycho Armor")).armor().bossDrop("Draygon 1",10).npcSpawn(203).trigger(159).npcSpawn(131).key(),fb=(new C(c,29,"Medical Herb")).consumable(),Ab=(new C(c,30,"Antidote")).consumable(),Gd=(new C(c,31,"Lysis Plant")).consumable(),Of=(new C(c,32,"Fruit of Lime")).consumable(),
Gb=(new C(c,33,"Fruit of Power")).consumable(),ic=(new C(c,34,"Magic Ring")).consumable(),Pf=(new C(c,35,"Fruit of Repun")).consumable().bossDrop("Sabera 2",7).npcSpawn(198).key(),Sb=(new C(c,36,"Warp Boots")).consumable(),Dh=(new C(c,37,"Statue of Onyx")).chest("Cordel grass").invisible(254882).key(),Qf=(new C(c,38,"Opel Statue")).consumable().bossDrop("Kelbesque 2",6).npcSpawn(197).key(),Eh=(new C(c,39,"Insect Flute")).fromPerson("Oak mother",30).dialog(30,void 0,1).key(),Rf=(new C(c,40,"Flute of Lime")).fromPerson("Portoa queen",
56).fromPerson("Asina secondary",98,1).dialog(56,void 0,4).key(),Pe=(new C(c,41,"Gas Mask")).direct("Akahana in Brynmaer",251902).npcSpawn(22,24).key(),km=(new C(c,42,"Power Ring")).chest().bonus(),lm=(new C(c,43,"Warrior Ring")).fromPerson("Akahana's friend",84).dialog(84,void 0,2).bonus(),mm=(new C(c,44,"Iron Necklace")).chest().bonus(),nm=(new C(c,45,"Deo's Pendant")).fromPerson("Deo",90).dialog(90,void 0,0).bonus(),Sf=(new C(c,46,"Rabbit Boots")).bossDrop("Vampire 1",0).npcSpawn(192).key(),Fh=
((a,b)=>new C(c,a,b))(47,a.leatherBootsGiveSpeed()?"Speed Boots":"Leather Boots").chest().bonus(),Gh=(new C(c,48,"Shield Ring")).direct("Akahana in waterfall cave",250543).bonus(),Tf=(new C(c,49,"Alarm Flute")).fromPerson("Zebu's student",20,1).key(),Hh=(new C(c,50,"Windmill Key")).fromPerson("Windmill guard",20).dialog(20,14,0).npcSpawn(20,14,1).key(),Uf=(new C(c,51,"Key to Prison")).chest().key(),Ih=(new C(c,52,"Key to Styx")).fromPerson("Zebu in Shyron",94,1).trigger(128,2).dialog(94,242,0).dialog(98,
242,0).key(),Jh=(new C(c,53,"Fog Lamp")).chest().key(),Vf=(new C(c,54,"Shell Flute")).fromPerson("Dolphin",99,1).npcSpawn(99).key(),Kh=(new C(c,55,"Eye Glasses")).fromPerson("Clark",68).dialog(68,233,1).key(),Lh=(new C(c,56,"Broken Statue")).bossDrop("Sabera 1",4).npcSpawn(127,101).npcSpawn(9).npcSpawn(10).npcSpawn(69).npcSpawn(70).npcSpawn(71).npcSpawn(132).npcSpawn(142).dialog(61).dialog(62).dialog(63).dialog(64).dialog(65).dialog(66).dialog(67).dialog(68,233).trigger(182).key(),Mh=(new C(c,57,
"Glowing Lamp")).direct("Kensu in lighthouse",250638).npcSpawn(126,98,1).key(),Nh=(new C(c,59,"Love Pendant")).chest("Underground channel").invisible(254890).key(),Oh=(new C(c,60,"Kirisa Plant")).chest("Kirisa meadow").invisible(254886).key(),Wf=(new C(c,61,"Ivory Statue")).bossDrop("Karmine",9).npcSpawn(200).key(),Ph=(new C(c,62,"Bow of Moon")).fromPerson("Aryllis",35).direct(251624).dialog(35,void 0,1).key(),Qh=(new C(c,63,"Bow of Sun")).chest().key(),Rh=(new C(c,64,"Bow of Truth")).fromPerson("Azteca",
131).npcSpawn(131,156,1).dialog(131,void 0,0).key(),Qe=(new De(c,65,"Refresh")).fromPerson("Zebu at windmill",94).requireUnique().direct(251665).dialog(94,16,3).trigger(180,1),pe=(new De(c,66,"Paralysis")).direct("Zebu at Mt. Sabre summit",251477).requireUnique().trigger(141).trigger(178),Sc=(new De(c,67,"Telepathy")).direct("Tornel at Stom's house",223220).npcSpawn(95,30,1).trigger(133,1),Sh=(new De(c,68,"Teleport")).fromPerson("Tornel on Mt. Sabre",95).dialog(95,33,0),om=(new De(c,69,"Recover")).direct("Asina in Portoa",
250361),Th=(new De(c,70,"Barrier")).direct("Asina on Angry sea",251609).requireUnique().trigger(132,0),od=(new De(c,71,"Change")).direct("Kensu in Swan",251614).npcSpawn(116,241,1).npcSpawn(126,241,1),Ua=(new De(c,72,"Flight")).weight(15).direct("Kensu in Draygonia Fortress",250255),pm=Gb.bossDrop("Vampire 2",12,97).npcSpawn(204).key(),Hb=new C(c,112,"Mimic"),Uh=(new D(c,"Talked to Leaf Elder")).get(ob),Vh=(new D(c,"Talked to Leaf Student")).get(Tf),Xf=new D(c,"Talked to Zebu in cave"),qm=(new D(c,
"Woke up Windmill Guard")).get(Hh),qe=new D(c,"Started Windmill"),Wh=(new D(c,"Learned Refresh")).get(Qe),rm=(new D(c,"Gave Statue to Akahana")).get(Pe),sm=(new D(c,"Fought Stom")).get(Sc),Xh=new D(c,"Visited Oak"),Yh=new D(c,"Talked to Oak Mother"),Yf=new D(c,"Rescued Oak Child"),tm=(new D(c,"Talked to Oak Mother Again")).get(Eh),um=(new D(c,"Talked to Oak Elder")).get(Na),vm=(new D(c,"Talked to Tornel on Mt Sabre")).get(Sh),Zh=new D(c,"Villagers Abducted"),$h=new D(c,"Talked to Rabbit in Leaf"),
wm=(new D(c,"Learned Paralysis")).get(pe),ai=new D(c,"Talked to Portoa Queen"),bi=new D(c,"Talked to Fortune Teller"),ci=new D(c,"Visited Underground Channel"),xm=(new D(c,"Sent to Waterfall Cave")).get(Rf),ym=(new D(c,"Cured Akahana")).get(Gh),di=(new D(c,"Talked to Rage")).get(Pc),ei=new D(c,"Mesia recording played"),fi=(new D(c,"Talked to Asina")).get(om),gi=(new D(c,"Healed Dolphin")).get(Vf),Zf=new D(c,"Returned Fog Lamp"),hi=new D(c,"Talked to Kensu in Cabin"),ii=new D(c,"Talked to Joel Elder"),
zm=(new D(c,"Talked to Clark")).get(Kh),Am=(new D(c,"Talked to Kensu in Lighthouse")).get(Mh),$f=new D(c,"Calmed the Angry Sea"),Bm=(new D(c,"Learned Barrier")).get(Th),ji=new D(c,"Talked to Stom in Swan Hut"),ki=new D(c,"Talked to Kensu in Swan tavern"),li=new D(c,"Talked to Kensu at Swan dance"),Cm=(new D(c,"Returned Kensu's love pendant")).get(od),Dm=(new D(c,"Talked to Amazones Queen")).get(Ph),ag=new D(c,"Entered Shyron"),Em=(new D(c,"Talked to Zebu in Shyron")).get(Ih),mi=new D(c,"Shyron Massacre"),
Fm=(new D(c,"Saved Kensu")).get(Ua),Gm=(new D(c,"Talked to Deo")).get(nm),Hm=(new D(c,"Talked to Akahana's Friend")).get(lm),Im=(new D(c,"Get Bow of Truth")).get(Rh),Jm=(new D(c,"Forged Crystalis")).get(Oc),Re=(new Ke(c,"Sword charge glitch")).option(R,G),Km=(new Ke(c,"Rabbit skip")).option(A,z),Lm=(new Ke(c,"Teleport skip")).option(v,y),Se=(new Ke(c,"Statue glitch")).option(n,q),Mm=(new Ke(c,"Wild warp")).option(E,L),Te=(new Ke(c,"Any level 2 sword")).option(ob,Qb).option(ob,cc).option(Na,dc).option(Na,
ec).option(ab,Pc).option(ab,bb).option(Qa,fc).option(Qa,gc),Ia=(new Ke(c,"Destroy stone")).option(ob,nb).option(ob,Qb).option(ob,cc).option(Re,ob,Te),Ja=(new Ke(c,"Destroy ice")).option(Na,nb).option(Na,dc).option(Na,ec).option(Re,Na,Te),sa=(new Ke(c,"Cross rivers")).option(ab,nb).option(ab,Pc).option(ab,bb).option(Ua).option(Re,ab,Te),Hd=(new Ke(c,"Destroy iron")).option(Qa,nb).option(Qa,fc).option(Qa,gc).option(Re,Qa,Te),Tb=(new Ke(c,"Any sword")).option(ob).option(Na).option(ab).option(Qa),Nm=
(new Ke(c,"Match insect sword (fire/water/thunder)")).option(Na).option(ab).option(Qa).option(Pe,ba.value?ba:g,ob),Om=(new Ke(c,"Match vampire 2 sword (wind/water/thunder)")).option(ob).option(ab).option(Qa).option(ba.value?ba:g,Na),ni=(new Ke(c,"Speed boots")).option(Fh,k),oi=(new Ke(c,"Climb slopes")).option(Sf).option(Ua).option(ni),Pm=(new Ke(c,"Enter Mt Sabre North (rabbit)")).option($h).option(Km),Qm=(new Ke(c,"Enter Mt Sabre North (Teleport)")).option(Sh).option(Lm,Ua),pi=(new Ke(c,"Asina in her room")).option(ei),
Rm=(new Ke(c,"Paralysis or Asina revealed")).option(pe).option(pi).option(Se),qi=(new Ke(c,"Ride dolphin")).option(Vf,hi),Sm=(new Ke(c,"Ghetto flight")).option(l,qi,Sf),Ac=(new Ke(c,"Cross sea")).option(qi).option(Ua),Tm=(new Ke(c,"Cross whirlpool")).option($f).option(Ua).option(Sm),Ub=(new Ke(c,"Refresh if needed")).option(zb.value?zb:g).option(Qe),ri=(new Ke(c,"Wind magic")).option(fa.value?fa:g,Ub).option(Qb,cc,Ub),si=(new Ke(c,"Fire magic")).option(fa.value?fa:g,Ub).option(dc,ec,Ub),ti=(new Ke(c,
"Water magic")).option(fa.value?fa:g,Ub).option(fa,Ub).option(Pc,bb,Ub),Um=(new Ke(c,"Thunder magic")).option(fa.value?fa:g,Ub).option(fa,Ub).option(fc,Ub).option(gc,Ub),Vm=(new Ke(c,"Flute of lime or glitch")).option(Rf).option(Se),Wm=(new Ke(c,"Change or glitch")).option(od).option(Se),Xm=(new Ke(c,"Change or glitch or paralysis")).option(od).option(Se).option(pe),bg=(new Ke(c,"Pass shooting statues")).option(Th).option(Tb,yb.value?yb:g).option(Qe,Gh),Ym=(new Ke(c,"Healed dolphin if required")).option(gi).option(ea),
ui=(new Ke(c,"Match sword of wind")).option(ob).option(ba.value?ba:g,Tb),vi=(new Ke(c,"Match sword of fire")).option(Na).option(ba.value?ba:g,Tb),wi=(new Ke(c,"Match sword of water")).option(ab).option(ba.value?ba:g,Tb),Zm=(new Ke(c,"Match sword of thunder")).option(Qa).option(ba.value?ba:g,Tb),$m=(new Ke(c,"Swamp run possible")).option(Tb,ni).option(Tb,ld).option(Tb,Qe),an=(new Ke(c,"Insect possible to kill")).option(Pe),Ue=(new Ke(c,"Travel swamp")).option(Pe).option(lb.value?lb:g,$m),bn=(new Ke(c,
"Calmed sea if required")).option($f).option(Eb),cn=(new Ke(c,"Started windmill if required")).option(qe).option(xc),dn=(new Ke(c,"Telepathy if required for Deo")).option(Sc).option(Nc),en=e(0,"Vampire 1",Tb).get(Sf),fn=e(1,"Insect",Eh,Nm,an).get(dc),gn=e(2,"Kelbesque 1",ui,ri).get(ec),hn=e(12,"Vampire 2",Om).get(pm),xi=e(4,"Sabera 1",vi,si).get(Lh),jn=e(5,"Mado 1",wi,ti).get(fc),kn=e(6,"Kelbesque 2",ui,ri).get(Qf),ln=e(7,"Sabera 2",vi,si).get(Pf),mn=e(8,"Mado 2",wi,ti).get(U),nn=e(9,"Karmine",Zm,
Um).get(Wf),on=e(10,"Draygon 1",Tb).get(jm),pn=e(-1,"Statues",Qh,Ph),qn=e(11,"Draygon 2",Tb,Rh),rn=e(13,"Dyna",Oc),sn=(new Ke(c,"Opened prison if required")).option(Uf).option(sb),jc=new Me(c,"Leaf"),Id=new Me(c,"Valley of Wind"),Vb=new Me(c,"Sealed Cave"),pd=new Me(c,"Cordel Plain"),Jd=new Me(c,"Brynmaer"),Kd=new Me(c,"Amazones"),Va=new Me(c,"Mt Sabre West"),Ca=new Me(c,"Mt Sabre North"),Ve=new Me(c,"Nadare's"),re=new Me(c,"Oak"),Tc=new Me(c,"Waterfall Valley"),Sa=new Me(c,"Portoa"),Uc=new Me(c,
"Waterfall Cave"),Wa=new Me(c,"Fog Lamp Cave"),Vc=new Me(c,"Kirisa Plant Cave"),qd=new Me(c,"Angry Sea"),Wc=new Me(c,"Joel"),tb=new Me(c,"Evil Spirit Island"),Xc=new Me(c,"Sabera's Castle"),kc=new Me(c,"Swan"),Oa=new Me(c,"Mt Hydra"),Yc=new Me(c,"Shyron"),rd=new Me(c,"Styx"),sd=new Me(c,"Goa"),We=new Me(c,"Draygonia Fortress 1"),lc=new Me(c,"Draygonia Fortress 2"),Ld=new Me(c,"Draygonia Fortress 3"),Ib=new Me(c,"Draygonia Fortress 4"),jb=new Me(c,"Oasis Cave"),mc=new Me(c,"Sahara"),Md=new Me(c,"Pyramid Front"),
Bc=new Me(c,"Pyramid Back"),Cc=new Me(c,"Tower"),cg=(new F(c,0,jc,"Start")).overworld().start(),tn=(new F(c,0,jc,"Mezame Shrine")).overworld().from(cg),un=(new F(c,1,jc,"Outside Start")).overworld().connect(tn),Zc=(new F(c,2,jc,"Town")).town().connect(un),se=(new F(c,3,Id,"Main")).overworld().connect(Zc).trigger(Wh,qe),yi=(new F(c,3,Id,"Outside Windmill")).overworld(),zi=(new F(c,4,Vb,"Tunnel 1 (entrance)")).cave().from(se,qe),vn=(new F(c,5,Vb,"Tunnel 2 (over bridge)")).cave().connect(zi),wn=(new F(c,
6,Vb,"Tunnel 6 (herb dead end)")).cave().chest(fb,15),Ai=(new F(c,7,Vb,"Tunnel 4a (ball corridor)")).cave().chest(fb,20,80).chest(Qb,21);(new F(c,7,Vb,"Tunnel 4b (antidote dead end)")).cave().connect(Ai,Ia).chest(Ab,19);const xn=(new F(c,8,Vb,"Tunnel 5 (warp boots dead end)")).cave().chest(Sb,14),yn=(new F(c,9,Vb,"Tunnel 3a (branch, front)")).cave().connect(vn).connectTo(Ai).connectTo(xn),zn=(new F(c,9,Vb,"Tunnel 3b (branch, back)")).cave().connect(yn,Ia).connectTo(wn),An=(new F(c,10,Vb,"Tunnel 7 (boss)")).cave().connect(zn).boss(en),
Bn=(new F(c,12,Vb,"Tunnel 8a (exit, above wall)")).cave().connect(An),Cn=(new F(c,12,Vb,"Tunnel 8b (exit, below wall")).cave().connect(Bn,Ia);(new F(c,14,Id,"Windmill Cave")).cave().connect(se).connectTo(yi).trigger(qm,Tf,Xf);(new F(c,15,Id,"Windmill")).misc().connect(yi).trigger(qe,Hh);const Dn=(new F(c,16,Id,"Zebu's Cave Front")).cave().connect(se).trigger(Xf,Uh,Vh).trigger(Wh,qe,Xf),En=(new F(c,16,Id,"Zebu's Cave Back")).cave().trigger(Zh).connect(Dn,Ja),Fn=(new F(c,17,Va,"Tunnel 1 (to Zebu)")).cave().connect(En),
Nd=(new F(c,20,pd,"West")).overworld().connect(Cn,cn),Gn=(new F(c,20,pd,"South")).overworld().connect(Nd,sa),Bi=(new F(c,21,pd,"East")).overworld().connect(Nd).chest(Dh,24),te=(new F(c,24,Jd,"Town")).town().connect(Nd).trigger(rm,Dh),Hn=(new F(c,25,pd,"Outside Stom's House")).town().connect(Nd),dg=(new F(c,26,pd,"Swamp")).overworld().connect(Bi,Ue).trigger(Yf,Yh,Ue);(new F(c,26,pd,"Swamp Insect Area")).overworld().connect(dg,Ue).boss(fn);const Xe=(new F(c,27,Kd,"Town")).town().connect(Gn),Ye=(new F(c,
28,re,"Town")).town().connect(dg,Ue).trigger(Xh);(new F(c,30,pd,"Stom's House")).house().connect(Hn).trigger(sm,Xh);const Od=(new F(c,32,Va,"Entrance")).overworld().connect(Nd).connect(Fn),In=(new F(c,32,Va,"Up Slope")).overworld().from(Od,oi).to(Od),Jn=(new F(c,32,Va,"Dead End (warp boots)")).overworld().chest(Sb,24,106),Ci=(new F(c,33,Va,"Upper")).overworld().from(Od,Ua).to(Od),Kn=(new F(c,33,Va,"Tornel Dead End")).overworld().trigger(vm,Qb,cc).chest(ic,23,105),Di=(new F(c,34,Va,"Tunnel 2a (fork at start)")).cave().connect(Od);
(new F(c,34,Va,"Tunnel 2b (left branch to dead end)")).cave().connect(Di,Ja).connectTo(Jn);const Ln=(new F(c,34,Va,"Tunnel 2c (right branch to upper)")).cave().connect(Di,Ja),Mn=(new F(c,35,Va,"Tunnel 3a (tunnel to upper, with herb chest)")).cave().connect(Ln).chest(fb,23,82),Nn=(new F(c,35,Va,"Tunnel 3b (tunnel to upper, branch below ice)")).cave().connect(Mn,Ja).connectTo(Ci),Ei=(new F(c,36,Va,"Tunnel 4a (branch to upper or Tornel)")).cave().connect(Nn);(new F(c,36,Va,"Tunnel 4b (out to upper)")).cave().connect(Ei,
Ja).connectTo(Ci);const On=(new F(c,37,Va,"Tunnel 5 (tiny connector)")).cave().connect(Ei),Pn=(new F(c,38,Va,"Tunnel 6a (exit to Tornel, above ice)")).cave().connect(On);(new F(c,38,Va,"Tunnel 6b (exit to Tornel, below ice)")).cave().connect(Pn,Ja).connectTo(Kn);const Qn=(new F(c,39,Va,"Tunnel 7a (tornado bracelet, lower)")).cave().connect(In),Rn=(new F(c,39,Va,"Tunnel 7b (tornado bracelet, middle)")).cave().connect(Qn,Ja);(new F(c,39,Va,"Tunnel 7c (tornado bracelet, upper)")).cave().connect(Rn,Ja).chest(cc,
25);const Ze=(new F(c,40,Ca,"Entrance")).overworld().connect(Bi,Qm,Pm),$e=(new F(c,40,Ca,"Upper")).overworld().from(Ze,Ua).to(Ze),eg=(new F(c,40,Ca,"Summit (boss)")).overworld().from($e,Ua).to($e).boss(gn),Fi=(new F(c,41,Ca,"Connector")).overworld(),fg=(new F(c,41,Ca,"Middle Left")).overworld(),Sn=(new F(c,41,Ca,"Middle Right")).overworld().from(fg,oi).to(fg),Gi=(new F(c,42,Ca,"Tunnel 2a (from entrance to connector)")).cave().connectTo(Fi);(new F(c,42,Ca,"Tunnel 2b (under bridge, to antidote)")).cave().connect(Gi,
Ja).chest(Ab,23,94);const Hi=(new F(c,43,Ca,"Tunnel 3a (branch after connector)")).cave().connect(Fi),Tn=(new F(c,43,Ca,"Tunnel 3b (right branch)")).cave().connect(Hi,Ja),Un=(new F(c,43,Ca,"Tunnel 3c (upper branch)")).cave().connect(Hi,Ja);(new F(c,44,Ca,"Tunnel 4 (over bridge, to middle)")).cave().connect(Un).connectTo(fg);const Ii=(new F(c,45,Ca,"Tunnel 5a (E-shaped, from right branch)")).cave().connect(Tn).connectTo(Sn);(new F(c,45,Ca,"Tunnel 5b (dead-end with herb)")).cave().connect(Ii,Ja).chest(fb,
22,83);const Vn=(new F(c,46,Ca,"Tunne; 6a (S-shaped hall, right)")).cave().connect(Ii),Wn=(new F(c,46,Ca,"Tunne; 6b (S-shaped hall, middle)")).cave().connect(Vn,Ja),Xn=(new F(c,46,Ca,"Tunnel 6c (S-shaped hall, left)")).cave().connect(Wn,Ja),Ji=(new F(c,47,Ca,"Prison (hallway)")).cave().connect($e),Yn=(new F(c,48,Ca,"Left Cell (shopkeepers)")).cave().from(Ji,Ja);(new F(c,49,Ca,"Left Cell 2 (back, with prison key)")).cave().from(Yn,Ja).chest(Uf,13);const Zn=(new F(c,50,Ca,"Right Cell (villagers)")).cave().from(Ji,
Ja),$n=(new F(c,51,Ca,"Tunnel 8 (behind right cell, toward summit)")).cave().from(Zn,Ja);(new F(c,52,Ca,"Tunnel 9 (connector to summit)")).cave().connect($n).connectTo(eg);const ao=(new F(c,53,Ca,"Summit Cave (front)")).cave().from(eg,Uf).to(eg),bo=(new F(c,53,Ca,"Summit Cave (behind ice)")).cave().connect(ao,Ja).trigger(wm);(new F(c,56,Ca,"Tunnel 1 (leads from main entrance)")).cave().connect(Ze).connectTo(Gi);(new F(c,57,Ca,"Tunnel 7 (to upper)")).cave().connect(Xn).connectTo($e);const co=(new F(c,
60,Ve,"Inn")).shop(),eo=(new F(c,61,Ve,"Tool Shop")).shop(fb,Ab,Gb,Sb),fo=(new F(c,62,Ve,"Back Room")).house(),gg=(new F(c,64,Tc,"Summit")).overworld().connect(bo,sn),af=(new F(c,64,Tc,"Northwest")).overworld().from(gg).to(gg,Ua),go=(new F(c,64,Tc,"Northeast")).overworld().connect(af,sa),Ki=(new F(c,65,Tc,"Southwest")).overworld().connect(af),ho=(new F(c,65,Tc,"Southeast")).overworld().connect(Ki,sa),Li=(new F(c,66,Tc,"Lime Tree Valley")).overworld().connect(Ki).connect(se,kd),io=(new F(c,67,Tc,"Lime Tree Lake (Rage)")).cave().connect(Li).trigger(di,
ab),jo=(new F(c,68,Vc,"Tunnel 1a (entrance)")).cave().connect(ho),ko=(new F(c,68,Vc,"Tunnel 1b (behind wall)")).cave().connect(jo,Ia),Mi=(new F(c,69,Vc,"Tunnel 2a (main path, before wall)")).cave().connect(ko);(new F(c,69,Vc,"Tunnel 2b (dead end, antidote)")).cave().connect(Mi,Ia).chest(Ab,25,95);const lo=(new F(c,69,Vc,"Tunnel 2c (main path, after wall)")).cave().connect(Mi,Ia),mo=(new F(c,70,Vc,"Tunnel 3a (last room, before wall)")).cave().connect(lo),no=(new F(c,70,Vc,"Tunnel 3b (last room, after wall)")).cave().connect(mo,
Ia);(new F(c,71,Vc,"Meadow")).overworld().connect(no).chest(Oh,14);const oo=(new F(c,72,Wa,"Tunnel 1a (entrance)")).cave().connect(go),Ni=(new F(c,72,Wa,"Tunnel 1b (past wall)")).cave().connect(oo,Ia);(new F(c,72,Wa,"Tunnel 1c (dead end, lysisPlant)")).cave().connect(Ni,Ia).chest(Gd,24);const po=(new F(c,73,Wa,"Tunnel 2 (tiny connector)")).cave().connect(Ni),Oi=(new F(c,74,Wa,"Tunnel 3a (upper branch)")).cave().connect(po);(new F(c,74,Wa,"Tunnel 3b (dead end, mimic)")).cave().connect(Oi,Ia).chest(Hb,
21,112);const Pi=(new F(c,74,Wa,"Tunnel 3c (short passage with mimic)")).cave().connect(Oi,Ia).chest(Hb,22,113),qo=(new F(c,74,Wa,"Tunnel 3d (lower branch)")).cave().connect(Pi,Ia);(new F(c,75,Wa,"Dead end loop")).cave().connect(qo);const Qi=(new F(c,76,Wa,"Tunnel 4a (right branch over bridge)")).cave().connect(Pi),ro=(new F(c,76,Wa,"Tunnel 4b (past wall over bridge)")).cave().connect(Qi,Ia),so=(new F(c,77,Wa,"Tunnel 5a (from left branch)")).cave().connect(Qi),to=(new F(c,77,Wa,"Tunnel 5b (reconvergence)")).cave().connect(so,
Ia).connect(ro),uo=(new F(c,77,Wa,"Tunnel 5c (between walls)")).cave().connect(to,Ia),vo=(new F(c,77,Wa,"Tunnel 5d (under bridge)")).cave().connect(uo,Ia),wo=(new F(c,78,Wa,"Tunnel 6a (over second bridge)")).cave().connect(vo),xo=(new F(c,78,Wa,"Tunnel 6b (past wall)")).cave().connect(wo,Ia),yo=(new F(c,79,Wa,"Tunnel 7a (under second bridge)")).cave().connect(xo);(new F(c,79,Wa,"Tunnel 7b (fog lamp)")).cave().connect(yo,Ia).chest(Jh,19);const td=(new F(c,80,Sa,"Town")).town().connect(af),Ri=(new F(c,
81,Sa,"Fishherman Island")).town().connect(td);(new F(c,82,Tc,"Mesia Shrine")).cave().trigger(ei).connect(io,sa,di);const Si=(new F(c,84,Uc,"Tunnel 1a (entrance)")).cave().connect(af);(new F(c,84,Uc,"Tunnel 1b (dead end, mimic)")).cave().connect(Si,Ja).chest(Hb,19,114);const zo=(new F(c,84,Uc,"Tunnel 1c (past ice)")).cave().connect(Si,Ja),Ao=(new F(c,85,Uc,"Tunnel 2 (stoned pair)")).cave().connect(zo),hg=(new F(c,86,Uc,"Tunnel 3 (wide medusa hallways)")).cave().connect(Ao,Vm),Bo=(new F(c,87,Uc,"Tunnel 4a (left entrance)")).cave().from(hg,
Ja).chest(md.chest().bonus(),25).trigger(ym,Rf);(new F(c,87,Uc,"Tunnel 4b (right entrance)")).cave().from(hg,Ja).connect(Bo,Ua);(new F(c,87,Uc,"Tunnel 4c (sword of water)")).cave().connect(hg,Ja).chest(ab,24);const Ti=(new F(c,88,Cc,"Entrance")).misc(),Co=(new F(c,89,Cc,"Level 1")).misc().from(Ti),Do=(new F(c,90,Cc,"Level 2")).misc().from(Co),Eo=(new F(c,91,Cc,"Level 3")).misc().from(Do),Ui=(new F(c,92,Cc,"Outside Mesia Room")).misc().from(Eo),Fo=(new F(c,93,Cc,"Outside Dyna Room")).misc().from(Ui,
Oc);(new F(c,94,Cc,"Mesia")).misc().connect(Ui).trigger(Jm);const Go=(new F(c,95,Cc,"Dyna")).misc().from(Fo).boss(rn);(new F(c,95,Cc,"Win")).misc().from(Go).end();const ig=(new F(c,96,qd,"Cabin Beach")).sea().from(Ri,Zf),Pd=(new F(c,96,qd,"South")).sea().connect(ig,Ac),Ho=(new F(c,96,qd,"Joel Beach")).sea().connect(Pd,Ac),Vi=(new F(c,96,Wc,"Outside Lighthouse")).sea();(new F(c,96,qd,"Altar")).sea().connect(Pd,Ac).trigger($f,Mh,Lh);const Io=(new F(c,96,qd,"North")).sea().to(Pd,Ac).from(Pd,Ac,Tm).trigger(Bm,
bn),Jo=(new F(c,96,qd,"Swan Beach")).sea().connect(Io,Ac);(new F(c,97,qd,"Cabin")).misc().connect(ig).trigger(hi,Zf);(new F(c,98,Wc,"Lighthouse")).misc().connect(Vi).trigger(Am,Tf);const bf=(new F(c,100,Sa,"Underground Channel 1 (from throne room)")).sea().trigger(ci),Ko=(new F(c,100,Sa,"Underground Channel 2 (to fortune teller)")).sea().connect(bf,sa),Wi=(new F(c,100,Sa,"Underground Channel 3 (from fortune teller)")).sea().connect(bf,Ua),Xi=(new F(c,100,Sa,"Underground Channel 4 (asina)")).sea().connect(Wi,
sa),Lo=(new F(c,100,Sa,"Underground Channel 5 (dolphin)")).sea().connect(Xi,sa).trigger(gi,fb,fi);(new F(c,100,Sa,"Underground Channel 6 (water)")).sea().connect(Lo,Ac).connectTo(Pd,Ac).chest(Nh,17);const jg=(new F(c,101,tb,"Zombie Town")).town(),Mo=(new F(c,104,tb,"Tunnel 1 (entrance)")).sea().connect(Pd,ii,Ac),Yi=(new F(c,105,tb,"Tunnel 2a (start)")).cave().connect(Mo);(new F(c,105,tb,"Tunnel 2b (dead end to left)")).cave().connect(Yi,sa);const No=(new F(c,105,tb,"Tunnel 2c (across first river)")).cave().connect(Yi,
sa),Zi=(new F(c,105,tb,"Tunnel 2d (across second river)")).cave().connect(No,sa);(new F(c,105,tb,"Tunnel 2e (dead end, magic ring)")).cave().connect(Zi,Ia).chest(ic,29);const Oo=(new F(c,105,tb,"Tunnel 2f (stair down)")).cave().connect(Zi,Ia),Po=(new F(c,106,tb,"Tunnel 3a (main area)")).cave().connect(Oo).connectTo(jg).chest(Gd,25,92),Qo=(new F(c,106,tb,"Tunnel 3b (left area toward items)")).cave().connect(Po,Ia),Ro=(new F(c,107,tb,"Tunnel 4a (right side, mimic)")).cave().connect(Qo).chest(Hb,14,
115);(new F(c,107,tb,"Tunnel 4b (left side, iron necklace)")).cave().connect(Ro,sa).chest(mm,15);const kg=(new F(c,108,Xc,"Floor 1")).fortress().connect(jg),So=(new F(c,108,Xc,"Miniboss")).fortress().boss(hn).connect(kg);(new F(c,109,Xc,"Floor 2a (left stair)")).fortress().connect(kg).chest(Gb,19);const To=(new F(c,109,Xc,"Floor 2b (right stair)")).fortress().connect(So).chest(fb,30,85),Uo=(new F(c,110,Xc,"Floor 3a (toward boss)")).fortress().connect(To),$i=(new F(c,110,Xc,"Floor 3b (boss room)")).fortress().connect(Uo);
(new F(c,110,Xc,"Boss")).fortress().boss(xi).connect($i);(new F(c,110,Xc,"Floor 3c (back room trap)")).fortress().from($i).to(kg);const Vo=(new F(c,112,Wc,"Secret Passage")).cave().connectTo(Vi),cf=(new F(c,113,Wc,"Town")).town().connect(Ho),Dc=(new F(c,114,kc,"Town")).town().connect(Jo),Wo=(new F(c,115,kc,"Inside Gate")).overworld().connect(Dc),Xo=(new F(c,115,kc,"Outside Gate")).overworld().from(Wo,od),df=(new F(c,120,sd,"Valley")).overworld().connect(Xo),lg=(new F(c,124,Oa,"Entrance")).overworld().connect(df),
Yo=(new F(c,124,Oa,"Over first river toward Shyron")).overworld().connect(lg,sa),aj=(new F(c,124,Oa,"After first tunnel")).overworld(),bj=(new F(c,124,Oa,"Door to Styx")).overworld().connect(aj,sa),Zo=(new F(c,124,Oa,"Dead end (no item)")).overworld(),$o=(new F(c,124,Oa,"Dead end (fruit of lime)")).overworld().chest(Of,26),ap=(new F(c,124,Oa,"Dead end (magic ring)")).overworld().chest(ic,25,101),cj=(new F(c,124,Oa,"Outside tunnel to bow")).overworld();(new F(c,124,Oa,"Floating island (bow of sun)")).overworld().connect(cj,
Ua).chest(Qh,24);const bp=(new F(c,125,Oa,"Tunnel 1 (to Shyron)")).cave().connect(Yo),cp=(new F(c,126,Oa,"Outside Shyron")).overworld().connect(bp);(new F(c,127,Oa,"Tunnel 2 (fork)")).cave().connect(lg).connectTo($o).connectTo(aj);const dj=(new F(c,128,Oa,"Tunnel 3 (caves)")).cave().connect(bj).connect(Zo),ej=(new F(c,129,Oa,"Tunnel 4 (left branch of cave)")).cave().connect(dj);(new F(c,130,Oa,"Tunnel 5 (dead end, medical herb)")).cave().connect(ej).chest(fb,15,86);const dp=(new F(c,131,Oa,"Tunnel 6a (left-then-right)")).cave().connect(ej),
ep=(new F(c,131,Oa,"Tunnel 6b (past wall)")).cave().connect(dp,Ia),fp=(new F(c,132,Oa,"Tunnel 7 (wide hall)")).cave().connect(ep);(new F(c,133,Oa,"Tunnel 8 (red slimes)")).cave().from(fp,Ia).connectTo(cj).chest(Hb,23,116);const gp=(new F(c,134,Oa,"Tunnel 9 (right branch, infinite loop)")).cave().connect(dj),hp=(new F(c,135,Oa,"Tunnel 10a (toward magic ring)")).cave().connect(gp);(new F(c,135,Oa,"Tunnel 10b (past wall)")).cave().connect(hp,Ia).connectTo(ap);const fj=(new F(c,136,rd,"Entrance")).fortress().from(bj,
Ih,bg),ip=(new F(c,137,rd,"Left branch")).fortress().connect(fj).chest(Hb,19,117),jp=(new F(c,137,rd,"Left branch, past one bridge")).fortress().connect(ip,sa),kp=(new F(c,137,rd,"Left branch, past two bridges")).fortress().connect(jp,sa).chest(fb,29,87),lp=(new F(c,137,rd,"Right branch")).fortress().connect(fj);(new F(c,137,rd,"Right branch, across water")).fortress().connect(lp,Ua).chest(Hb,20,118).chest(Hb,21,119).chest(hc,28);(new F(c,138,rd,"Upper floor")).fortress().connect(kp).chest(Qa,27);
const Qd=(new F(c,140,Yc,"Town")).town().connect(cp,Wm).trigger(ag),ue=(new F(c,142,sd,"Town")).town().connect(df),gj=(new F(c,143,jb,"Draygonia Fortress Basement 1 (front)")).fortress();(new F(c,143,jb,"Draygonia Fortress Basement 2 (power ring)")).fortress().connect(gj,Hd).chest(km,15);const mg=(new F(c,144,sd,"Desert 1")).overworld().connect(df),ef=(new F(c,145,jb,"Area 1 (from entrance)")).cave().chest(Fh,26),hj=(new F(c,145,jb,"Area 2 (across top bridge)")).cave().connect(ef,sa);(new F(c,145,
jb,"Area 3 (dead-end across top-right bridge)")).cave().connect(hj,sa);const mp=(new F(c,145,jb,"Area 4 (left across middle-right bridge)")).cave().connect(hj,sa),np=(new F(c,145,jb,"Area 5 (bottom edge)")).cave().connect(mp,sa),op=(new F(c,145,jb,"Area 6 (bottom island)")).cave().connect(np,sa),pp=(new F(c,145,jb,"Area 7 (bottom inner ring)")).cave().connect(op,sa),qp=(new F(c,145,jb,"Area 8 (left outer ring)")).cave().connect(pp,sa).connect(ef,sa).chest(Gb,27,100),rp=(new F(c,145,jb,"Area 9 (top left inner ring)")).cave().connect(qp,
sa),sp=(new F(c,145,jb,"Area 10 (top right inner ring)")).cave().connect(rp,sa);(new F(c,145,jb,"Area 11 (center)")).cave().connect(sp,sa).connectTo(gj);(new F(c,145,jb,"Area 12 (top center islands)")).cave().connect(ef,Ua).chest(im,28);const tp=(new F(c,146,mc,"Desert Cave 1")).cave().connect(mg,Ua),Rd=(new F(c,147,mc,"Town")).town(),up=(new F(c,148,mc,"Outside Cave")).overworld().connect(Rd),vp=(new F(c,149,mc,"Desert Cave 2")).cave().connect(up);(new F(c,150,mc,"Meadow")).overworld().connect(tp).connectTo(Rd).trigger(Gm,
od,dn);const ng=(new F(c,152,mc,"Desert 2")).overworld().connect(vp),wp=(new F(c,156,Md,"Entrance")).fortress().connect(ng,Ua),xp=(new F(c,156,Md,"Azteca")).fortress().trigger(Im),yp=(new F(c,157,Md,"Fork")).fortress().connect(wp),ij=(new F(c,158,Md,"Main")).fortress().connect(yp);(new F(c,158,Md,"Treasure Chest (magic ring)")).fortress().connect(ij).chest(ic,27,108);(new F(c,159,Md,"Draygon")).fortress().connect(ij).to(xp).boss(on);const zp=(new F(c,160,Bc,"Entrance")).fortress().connect(ng,Ua),
Ap=(new F(c,160,Bc,"Statues")).fortress().connect(zp).boss(pn),Bp=(new F(c,161,Bc,"Hall 1")).fortress().connect(Ap),og=(new F(c,162,Bc,"Branch")).fortress().connect(Bp);(new F(c,163,Bc,"Left Dead End")).fortress().connect(og).chest(Hb,13,120);(new F(c,164,Bc,"Right Dead End")).fortress().connect(og);const Cp=(new F(c,165,Bc,"Hall 2")).fortress().connect(og).chest(Qf,26,109),Dp=(new F(c,166,Bc,"Draygon 2")).fortress().connect(Cp).boss(qn);(new F(c,167,Bc,"Teleporter")).fortress().from(Dp).to(Ti);const jj=
(new F(c,168,We,"Entrance")).fortress().connect(ue,bg).trigger(mi,Qa),Ep=(new F(c,169,We,"Main")).fortress().from(jj,Hd),Fp=(new F(c,169,We,"Boss")).fortress().connect(Ep).boss(kn),Gp=(new F(c,170,We,"Zebu")).fortress().connect(Fp),ff=(new F(c,171,lc,"Entrance")).fortress().connect(Gp);(new F(c,171,lc,"Dead End Behind Iron (fruit of power)")).fortress().connect(ff,Hd).chest(Gb,28,98);(new F(c,171,lc,"Dead End Loop Across Closer Bridges")).fortress().connect(ff,sa).connect(ff,sa);const Hp=(new F(c,
171,lc,"Across First Bridge (fruit of repun)")).fortress().connect(ff,sa).chest(Pf,30,102),pg=(new F(c,171,lc,"Across Second Bridge")).fortress().connect(Hp,sa);(new F(c,171,lc,"Dead End Across Two Bridges ()")).fortress().connect(pg,sa).connect(pg,sa).chest(Gd,29,93);const Ip=(new F(c,171,lc,"Across Third Bridge")).fortress().connect(pg,sa),Jp=(new F(c,171,lc,"Exit Behind Iron Door")).fortress().connect(Ip,Hd),Kp=(new F(c,172,lc,"Boss")).fortress().connect(Jp).boss(ln),Lp=(new F(c,172,lc,"Tornel")).fortress().connect(Kp),
kj=(new F(c,173,Ld,"Lower")).fortress().connect(Lp).chest(Qf,26,99).chest(ic,27,111),Mp=(new F(c,174,Ld,"Upper Loop")).fortress().connect(kj).chest(Ab,22,96);(new F(c,174,Ld,"Upper Loop Behind Wall (magic ring)")).fortress().connect(Mp,Hd).chest(ic,23,107);const Np=(new F(c,175,Ld,"Upper Passage (toward Mado)")).fortress().connect(kj).chest(ic,27,84),qg=(new F(c,176,Ib,"Initial Fork")).fortress(),Op=(new F(c,177,Ib,"Left Branch")).fortress().connect(qg),lj=(new F(c,178,Ib,"Main Area (right branch, over bridges)")).fortress().connect(qg),
Pp=(new F(c,179,Ib,"U-shaped Passage (between floors)")).fortress().connect(lj),Qp=(new F(c,180,Ib,"Main Area Lower (under bridge)")).fortress().connect(Op).connect(lj).connect(Pp),mj=(new F(c,180,Ib,"Behind Iron Wall")).fortress().connect(Qp,Hd),Rp=(new F(c,181,Ib,"Lower")).fortress().connect(mj).chest(Hb,13,121).chest(Hb,14,122).chest(Hb,15,123).chest(ic,23,88).chest(Sb,24,110),Sp=(new F(c,182,Ib,"Boss Corridor")).fortress().connect(Rp),Tp=(new F(c,182,Ib,"Boss")).fortress().connect(Sp,bg).boss(nn);
(new F(c,182,Ib,"Behind Boss (stormBracelet)")).fortress().connect(Tp).chest(gc,18);const nj=(new F(c,183,Ib,"Exit Stairs")).fortress(),Up=(new F(c,184,jb,"Entrance Back (behind river)")).cave().connect(nj).chest(Gb,13,90);(new F(c,184,jb,"Entrance Front")).cave().connect(Up,Ua).connectTo(mg).connectTo(ef);const Vp=(new F(c,185,Ld,"Boss")).fortress().connect(Np).boss(mn);(new F(c,185,Ld,"Asina")).fortress().connect(Vp).connectTo(qg);(new F(c,186,Ib,"Kensu")).fortress().connect(mj).connectTo(nj).trigger(Fm,
Wf);(new F(c,187,sd,"House")).house().connect(ue).trigger(Hm,od,Wf);(new F(c,188,sd,"Inn")).shop().connect(ue,ag);(new F(c,190,sd,"Tool Shop")).shop(fb,Ab,Sb,Gb).connect(ue,ag);(new F(c,191,sd,"Tavern")).shop().connect(ue);(new F(c,192,jc,"Elder House")).house().connect(Zc).trigger(Uh);(new F(c,193,jc,"Rabbit Hut")).house().connect(Zc).trigger($h,Zh,Sc);(new F(c,194,jc,"Inn")).shop().connect(Zc);(new F(c,195,jc,"Tool Shop")).shop(fb,Ab,Sb,Gb).connect(Zc);(new F(c,196,jc,"Armor Shop")).shop(Ha,Qc).connect(Zc);
(new F(c,197,jc,"Student House")).house().connect(Zc).trigger(Vh);(new F(c,198,Jd,"Tavern")).house().connect(te);(new F(c,199,Jd,"Pawn Shop")).shop().connect(te);(new F(c,200,Jd,"Inn")).shop().connect(te);(new F(c,201,Jd,"Armor Shop")).shop(Fb,Qc,Rc).connect(te);(new F(c,203,Jd,"Tool Shop")).shop(fb,Ab,Sb).connect(te);(new F(c,205,re,"Elder House")).house().from(Ye,Sc).trigger(um,Yf);(new F(c,206,re,"Mother's House")).house().from(Ye,Sc).trigger(Yh,Sc).trigger(tm,Yf);(new F(c,207,re,"Tool Shop")).shop(fb,
Ab,Gb).from(Ye,Sc);(new F(c,208,re,"Inn")).shop().from(Ye,Sc);(new F(c,209,Kd,"Inn")).shop().connect(Xe);(new F(c,210,Kd,"Tool Shop")).shop(Sb,Gb,Gd).connect(Xe);(new F(c,211,Kd,"Armor Shop")).shop(Rb,Fd,md,U).connect(Xe);const Wp=(new F(c,212,Kd,"Queen's House")).house().from(Xe,Xm).trigger(Dm,od,Oh);(new F(c,213,Ve,"Nadare's")).house().connect(Ze).connectTo(co).connectTo(eo).connectTo(fo);(new F(c,214,Sa,"Fisherman's House")).house().connect(Ri).trigger(Zf,Jh,Vf,Ym);const rg=(new F(c,215,Sa,"Palace Entrance")).house().connect(td);
(new F(c,216,Sa,"Fortune Teller Front")).house().connect(td).trigger(bi,ai);(new F(c,216,Sa,"Fortune Teller Back")).house().connect(Ko).connect(Wi);(new F(c,217,Sa,"Pawn Shop")).shop().connect(td);(new F(c,218,Sa,"Armor Shop")).shop(cb,Rb,Fd).connect(td);(new F(c,220,Sa,"Inn")).shop().connect(td);(new F(c,221,Sa,"Tool Shop")).shop(fb,Gd,Of,Sb).connect(td);(new F(c,222,Sa,"Palace Left")).house().connect(rg);(new F(c,223,Sa,"Palace Throne Room")).house().connect(rg).to(bf,Rm).from(bf).trigger(ai).trigger(xm,
bi,ci);(new F(c,224,Sa,"Palace Right")).house().connect(rg);(new F(c,225,Sa,"Asina's Room")).house().connect(Xi).trigger(fi,pi);(new F(c,226,Kd,"Queen Downstairs")).house().connect(Wp).chest(bb,13);(new F(c,227,Wc,"Elder's House")).house().connect(cf).trigger(ii);(new F(c,228,Wc,"Shed")).house().connect(cf).to(Vo,Kh);(new F(c,229,Wc,"Tool Shop")).shop(fb,Ab,Gb,Gd).connect(cf);(new F(c,231,Wc,"Inn")).shop().connect(cf);const Xp=(new F(c,232,tb,"Zombie Town House")).house().connect(jg);(new F(c,233,
tb,"Zombie Town Basement")).house().connect(Xp).trigger(zm,xi);(new F(c,235,kc,"Tool Shop")).shop(fb,Ab,Gb,Sb).connect(Dc);(new F(c,236,kc,"Stom's Hut")).house().connect(Dc).trigger(ji);(new F(c,237,kc,"Inn")).shop().connect(Dc);(new F(c,238,kc,"Armor Shop")).shop(nd,zc,yc,pb).connect(Dc);(new F(c,239,kc,"Tavern")).house().connect(Dc).trigger(ki,ji,pe);(new F(c,240,kc,"Pawn Shop")).shop().connect(Dc);(new F(c,241,kc,"Dance Hall")).house().connect(Dc).trigger(li,ki,pe).trigger(Cm,li,Nh);const Yp=(new F(c,
242,Yc,"Temple (pre-massacre)")).fortress().connect(Qd).from(cg,Qa,bc).trigger(Em);(new F(c,242,Yc,"Temple (post-massacre)")).fortress().from(Yp,mi).boss(jn);(new F(c,243,Yc,"Training Hall")).house().connect(Qd);(new F(c,244,Yc,"Hospital")).house().connect(Qd);(new F(c,245,Yc,"Armor Shop")).shop(zc,U,pb).connect(Qd);(new F(c,246,Yc,"Tool Shop")).shop(fb,Ab,Of,ic).connect(Qd);(new F(c,247,Yc,"Inn")).shop().connect(Qd);(new F(c,248,mc,"Inn")).shop().connect(Rd);(new F(c,249,mc,"Tool Shop")).shop(Ab,
Sb,Pf,ic).connect(Rd);(new F(c,250,mc,"Elder's House")).house().connect(Rd);(new F(c,251,mc,"Pawn Shop")).house().connect(Rd);const Zp=[Zc,se,zi,Nd,dg,Od,gg,Li,ig,Dc,df,lg,mg,jj,ng];for(const a of Zp)a.from(cg,Mm);return c};class kf{constructor(a){this.path=void 0===a?"js/":a}read(a){const b=this;return m.asyncExecutePromiseGeneratorFunction(function*(){return a in lf?lf[a]:yield(yield fetch(b.path+a)).text()})}}const lf={};var mf;(function(a){a.name=function(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw Error(`Bad direction: ${a}`);};a.all=function(){return[0,1,2,3]};a.North=0;a.West=1;a.South=2;a.East=3})(mf||(mf={}));class nf{constructor(a){var b;this.worlds=a;var c=new Set,d=new Set,e=new Map,f=new Map;for(var g=0;g<a.length;g++){const b=a[g],h=g<<24;for(const a of b.requirements){const [b,e]=a;c.add(h|b);for(const a of e)for(const b of a)d.add(h|b)}for(const a of b.items){const [b,c]=a;f.set(h|b,c)}for(const a of b.slots){const [b,c]=a;e.set(h|b,c)}}this.itemInfos=new Map(f);this.slotInfos=new Map(e);this.progression=new Set(d);for(const a of f.keys())d.add(a);e=new Set;f=new Set;g=new Set;for(var h of d)(c.has(h)?
e:g).add(h);for(var k of c)d.has(k)||f.add(k);this.common=e.size;this.slots=new qa([...e,...f]);this.items=new qa([...e,...g]);c=[];d=[];for(h=0;h<a.length;h++){const b=h<<24;for(var l of a[h].requirements){const [a,f]=l;k=this.slots.index(b|a);if(null==k)throw Error(`Provided a non-slot? ${x(a)}`);for(var n of f){e=[...n].map(a=>{var c;return null!==(c=this.items.index(b|a))&&void 0!==c?c:$b()});(c[k]||(c[k]=[])).push(tc.from(e));for(const a of e)(d[a]||(d[a]=new Set)).add(k)}}}for(a=0;a<this.slots.length;a++)c[a]&&
c[a].length||(l=null!==(b=this.slots.get(a))&&void 0!==b?b:NaN,n=this.checkName(l),console.error(`Nothing provided $${x(l)}: ${n} (index ${a})`));this.graph=new pa(c);this.unlocks=new pa(d.map(ia))}shuffle(a,b,c,d,e){c=void 0===c?200:c;const f=this;return m.asyncExecutePromiseGeneratorFunction(function*(){d&&d.addTasks(Math.floor(c/10));for(var g=0;g<c;g++){d&&9===g%10&&(d.addCompleted(1),yield new Promise(requestAnimationFrame));var h=new ra;f.prefill(h,b);const n=f.compressFill(h);var k=f.itemPool(n.values(),
b),l=tc.from(new Set(k));if(f.fillInternal(n,k,l,b,a,Math.floor(g/5)))if(k=e?[]:void 0,l=f.traverse(a=>n.get(a),tc.of(),k),l.size!==f.slots.length){h=a=>`${String(a).padStart(3)} ${f.slots.get(a).toString(16).padStart(3,"0")} ${f.checkName(f.slots.get(a))}`;const a=a=>`${String(a).padStart(3)} ${f.items.get(a).toString(16).padStart(3,"0")} ${f.checkName(f.items.get(a))}`;k=new Set([...f.slots].map(a=>a[0]));for(const a of l)k.delete(a);const b=new Map;for(const c of k)b.set(h(c),f.graph.get(c).map(b=>
"\n    "+tc.bits(b).map(a).join(" & ")).join(""));console.error(`Initial fill never reached slots:\n  ${[...b.keys()].sort().map(a=>a+b.get(a)).join("\n  ")}`)}else if(f.expandFill(n,h),l=f.fillNonProgression(h,a,b),null!=l){d&&d.addCompleted(Math.floor((c-g)/100));if(e){for(const a of h){const [b,c]=a;g=f.checkName(b).replace(/^[0-9a-f]{3} /,"");e.addSlot(b,g,c)}if(k)for(const a of k){const [b,...c]=a;(b<f.common||n.has(b))&&e.addCheck(f.slots.get(b),c.map(a=>f.items.get(a)))}}return l}}return null})}fillInternal(a,
b,c,d,e,f){var g;const h=new Set(a.keys());for(var k=b.pop();null!=k;k=b.pop()){if(!tc.has(c,k))continue;const n=this.itemInfoFromIndex(k);c=tc.without(c,k);var l=this.expandReachable(this.traverse(b=>a.get(b),c),e);d.shuffle(l);let q=!1;const v=new Set(a.keys());for(const b of l){if(v.has(b))continue;v.add(b);const c=this.slotInfoFromIndex(b);if(c&&this.fits(c,n,e)){a.set(b,k);q=!0;break}}if(!q){v.clear();if(0<f--){for(const f of l)if(!v.has(f)&&a.has(f)&&!h.has(f)&&(v.add(f),(l=this.slotInfoFromIndex(f))&&
this.fits(l,n,e))){k=null!==(g=a.replace(f,k))&&void 0!==g?g:$b();c=tc.with(c,k);b.push(k);d.shuffle(b);q=!0;break}if(q)continue}return!1}}return!0}expandReachable(a,b){const c=[];for(const f of a){var d=this.slotInfoFromIndex(f);if(d&&(!b.preserveUniqueChecks()||d.unique)){a=c;var e=f;d=d.weight||1;for(let b=0;b<d;b++)a.push(e)}}return c}itemPool(a,b){a=new Set(a);const c=[];for(const b of this.itemInfos){const [g,k]=b;var d=this.items.index(g);if(null!=d&&this.progression.has(g)&&!a.has(d)){var e=
c,f=k.weight||1;for(let a=0;a<f;a++)e.push(d)}}return b.shuffle(c)}fits(a,b,c){if(c.preserveUniqueChecks()&&b.unique&&!a.unique)return!1;c=b.preventLoss||a.preventLoss;return a.lossy&&b.losable&&c?!1:!0}fillNonProgression(a,b,c){var d=[[],[],[]];const e=[[],[]];for(var f of this.itemInfos){const [c,e]=f;if(!a.hasValue(c)){var g=2;e.losable&&e.preventLoss&&(g=1);b.preserveUniqueChecks()&&e.unique&&(g=0);d[g].push(c)}}for(const b of this.slotInfos){const [c,d]=b;a.has(c)||e[d.lossy&&d.preventLoss?0:
1].push(c)}for(const a of[...d,...e])c.shuffle(a);c=a=>this.checkName(a);f=ha.count(ha.concat(...e));g=ha.count(ha.concat(...d));if(g>f)throw console.log(`Slots ${f}:\n  ${[...ha.concat(...e)].map(c).join("\n  ")}`),console.log(`Items ${g}:\n  ${[...ha.concat(...d)].map(c).join("\n  ")}`),Error("Too many items");for(const g of ha.concat(...d)){d=!1;for(const c of[...e]){if(d)break;for(f=0;f<c.length;f++)if(this.fits(this.slotInfos.get(c[f]),this.itemInfos.get(g),b)){a.set(c[f],g);d=!0;c.splice(f,
1);break}}if(!d)return console.log(`Slots:\n  ${[...ha.concat(...e)].map(c).join("\n  ")}`),console.error(`REROLL: Could not place item ${c(g)}`),null}return new Map(a)}traverse(a,b,c){b=tc.clone(b);const d=new Set,e=new Set;for(var f=0;f<this.slots.length;f++){if(null==this.graph.get(f))throw console.dir(this),a=this.slots.get(f),Error(`Unreachable slot ${null===a||void 0===a?void 0:a.toString(16)}`);e.add(f)}for(const g of e)if(e.delete(g),!d.has(g)){f=this.graph.get(g);if(null==f)throw Error(`Not in graph: ${g}`);
for(let h=0,k=f.length;h<k;h++){if(!tc.containsAll(b,f[h]))continue;c&&c.push([g,...tc.bits(f[h])]);d.add(g);f=[];g<this.common&&f.push(g);const k=a(g);null!=k&&f.push(k);for(const a of f){b=tc.with(b,a);for(const b of this.unlocks.get(a)||[]){if(null==this.graph.get(b))throw console.dir(this),Error(`Adding bad node ${b} from unlock ${a}`);e.add(b)}}break}}return d}expandFill(a,b){for(const c of a){const [d,e]=c;{a=this.slots.get(d);const c=this.items.get(e);if(null==a||null==c)throw Error("missing");
b.replace(a,c)}}}compressFill(a){const b=new ra;for(const c of a){const [d,e]=c;{a=this.slots.index(d);const c=this.items.index(e);if(null==a||null==c)throw Error(`Bad slot/item: ${d} ${a} ${e} ${c}`);b.set(a,c)}}return b}checkName(a){return this.worlds[a>>>24].checkName(a&16777215)}prefill(a,b){for(let c=0;c<this.worlds.length;c++){const d=c<<24,e=this.worlds[c].prefill(b);for(const b of e){const [c,e]=b;a.set(d|c,d|e)}}}itemInfoFromIndex(a){const b=this.items.get(a);if(null==b)throw Error(`Bad item: ${a}`);
return this.itemInfoFromId(b)}itemInfoFromId(a){const b=this.itemInfos.get(a);if(null==b)throw Error(`Missing info: ${x(a)}`);return b}slotInfoFromIndex(a){const b=this.slots.get(a);if(null==b)throw Error(`Bad slot: ${a}`);return this.slotInfoFromId(b)}slotInfoFromId(a){a=this.slotInfos.get(a);if(null!=a)return a}};function of(a){return a}(function(a){a.from=function({id:a},{x:c,y:d}){return a<<16|d>>>8<<12|c>>>8<<8|(d>>>4&15)<<4|c>>>4&15};a.add=function(a,c,d){if(c){for(c=(a&240)+(c<<4);240<=c;){if(61440<=(a&61440))return-1;c-=240;a+=4096}for(;0>c;){if(!(a&61440))return-1;c+=240;a-=4096}a=a&-241|c}if(d){for(d=(a&15)+d;16<=d;){if(1792<=(a&3840))return-1;d-=16;a+=256}for(;0>d;){if(!(a&3840))return-1;d+=16;a-=256}a=a&-16|d}return a}})(of||(of={}));var pf;
(function(a){a.trigger=function(a,c){return{*[Symbol.iterator](){let {x:b,y:e}=c;b+=8;for(const c of[-16,0]){const d=b+c;for(const b of[-16,0])yield of.from(a,{x:d,y:e+b})}}}};a.adjust=function(a,...c){const b=new Set;a=[...a];for(const [d,f]of c)for(const c of a)b.add(of.add(c,d,f));return b};a.screen=function(a){const b=[];for(let c=0;240>c;c++)b.push(a&-256|c);return b};a.atLocation=function(a,...c){const b=new Set;a=[...a];for(const d of c)for(const c of a)b.add(c&65535|d.id<<16);return b}})(pf||(pf=
{}));var H;
(function(a){function b(a){return a instanceof c?[...ha.map(a,a=>[...a])]:a}a.and=function(...a){return[[].concat(...a.map(([a])=>a))]};a.or=function(...c){const d=[];for(const e of c){if(e===a.OPEN)return a.OPEN;e!==a.CLOSED&&d.push(...b(e))}return d.length?d:a.CLOSED};a.meet=function(d,e){if(d===a.OPEN)return b(e);if(e===a.OPEN)return b(d);if(d===a.CLOSED||e===a.CLOSED)return a.CLOSED;const f=new c;for(const a of d)for(const b of e)f.addList([...a,...b]);return b(f)};a.freeze=b;a.label=function(a){return a instanceof c?
a.label():a.map(a=>a.join("&")).join("|")};a.isOpen=function(a){a=a[Symbol.iterator]();const {value:b,done:c}=a.next();return c||!a.next().done?!1:b[Symbol.iterator]().next().done};a.isClosed=function(a){return!!a[Symbol.iterator]().next().done};a.OPEN=[[]];a.CLOSED=[];class c{constructor(a){this.self=a;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(a,b){for(const a of b)if(Array.isArray(a))throw Error();if(b.has(this.self)||this.map.has(a))return!1;for(const [a,c]of this.map){if(qf(b,
c))return!1;qf(c,b)&&this.map.delete(a)}this.map.set(a,b);return!0}addRoute(a){return this.addInternal(a[rf],a.deps)}addAll(a){for(const b of a)this.addList(b)}addList(a){a=[...new Set(a)].sort();const b=new Set(a);this.addInternal(a.join("&"),b)}restrict(a){const b=[...this.map.values()];this.map.clear();for(const c of b)for(const b of a)this.addList([...c,...b])}label(){return[this.map.keys()].join("|")}}a.Builder=c})(H||(H={}));
function qf(a,b){if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0}const rf=Symbol("depsLabel");class sf{constructor(a,b){this.target=a;a=[...new Set(b)].sort();this.deps=new Set(a);this[rf]=a.join("&");this.label=`${this.target}:${this[rf]}`}};function tf(a){return a}(function(a){a.from=(a,c)=>"number"!==typeof a&&c?a.id<<8|c.y>>>8<<4|c.x>>>8:Number(a)>>>8;a.fromTile=function(a){return a>>>8}})(tf||(tf={}));class uf{constructor(a){this.rom=a;this.tiles=new da(a=>vf(this.rom,a));this.bosses=new da(a=>new wf(a));this.statues=new Map;this.flags=new da(a=>new da(b=>new da(c=>new xf(a,b,c))));this.meets=new da(a=>new da(b=>new yf(a,b)));this._seamless=new da(a=>new zf(a))}tile(a){return a&4?void 0:this.tiles.get(a)}boss(a,b){return b?this.rage||(this.rage=new Af(a,this.rom.flags.RageSkip.id)):this.bosses.get(a)}statue(a){const b=H.label(a);let c=this.statues.get(b);c||this.statues.set(b,c=new Bf(a));return c}flag(a,
b,c){a||(a=Cf);return this.flags.get(a).get(b).get(c)}meet(a,b){return this.meets.get(a).get(b)}seamless(a){return this._seamless.get(a)}label(a,b){return a.label?a.label(b):"Terrain"}}var Df;(function(a){a.FLY=2;a.BLOCKED=4;a.SLOPE=32;a.PAIN=128;a.BITS=166;a.SWAMP=256;a.BARRIER=512;a.SLOPE8=1024;a.SLOPE9=2048;a.DOLPHIN=4096;a.label=function(a,c){var b,e;return null!==(e=null===(b=a.label)||void 0===b?void 0:b.call(a,c))&&void 0!==e?e:"Terrain"}})(Df||(Df={}));
class zf{constructor(a){this._delegate=a;this.enter=a.enter;this.exit=a.exit}label(a){return`Seamless(${Df.label(this._delegate,a)})`}}class Ef{constructor(a,b=H.OPEN){this.enter=a;this.exit=[[15,b]]}get kind(){return"Simple"}label(a){const b=[];H.isOpen(this.enter)||b.push(`enter = ${Ff(this.enter,a)}`);H.isOpen(this.exit[0][1])||b.push(`exit = ${Ff(this.exit[0][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
class Gf{constructor(a,b,c=4){this.enter=a;this.exit=b?[[15&~c,b],[c,H.OPEN]]:[[15,H.OPEN]]}get kind(){return"South"}label(a){if(1===this.exit.length)return Ef.prototype.label.call(this,a);const b=[];H.isOpen(this.enter)||b.push(`enter = ${Ff(this.enter,a)}`);H.isOpen(this.exit[0][1])||b.push(`other = ${Ff(this.exit[0][1],a)}`);H.isOpen(this.exit[1][1])||b.push(`south = ${Ff(this.exit[1][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
function vf(a,b){let c=H.OPEN,d=void 0,e=4;b&Df.DOLPHIN&&b&Df.FLY?(b&Df.SLOPE&&(d=a.flags.ClimbWaterfall.r),c=[[a.flags.CurrentlyRidingDolphin.c],[a.flags.Flight.c]]):(b&Df.SLOPE9?d=a.flags.ClimbSlope9.r:b&Df.SLOPE8?d=a.flags.ClimbSlope8.r:b&Df.SLOPE&&(d=a.flags.ClimbSlope10.r),b&Df.FLY&&(c=a.flags.Flight.r));b&Df.SWAMP&&(c=c.map(b=>[a.flags.TravelSwamp.c,...b]));b&Df.PAIN&&(c=c.map(b=>[a.flags.CrossPain.c,...b]));b&Df.BARRIER&&(c=c.map(b=>[a.flags.ShootingStatue.c,...b]),d=a.flags.ShootingStatueSouth.r,
e=1);return new Gf(c,d,e)}class wf extends Ef{constructor(a){super(H.OPEN,[[a]]);this._flag=a}get kind(){return"Boss"}}class Bf extends Gf{constructor(a){super(H.OPEN,a);this._req=a}get kind(){return"Statue"}}class Af{constructor(a,b){this._rageFlag=a;this._rageSkipFlag=b;this.enter=H.OPEN;this.exit=[[11,[[a],[b]]],[4,H.OPEN]]}label(){return"Rage"}}
class xf extends Ef{constructor(a,b,c){if(1!==a.exit.length||1!==c.exit.length)throw console.error(a,c),Error("bad flag");const d=[[b]],e=0<=b?H.meet(c.enter,d):c.enter;b=0<=b?H.meet(c.exit[0][1],d):c.exit[0][1];super(H.or(a.enter,e),H.or(a.exit[0][1],b))}get kind(){return"Flag"}}const Cf=new Ef(H.CLOSED,H.CLOSED);
function Hf(a){const b=[];for(var c=0;c<a.exit.length;c++)for(let d=0;4>d;d++)a.exit[c][0]&1<<d&&(b[d]=c);for(c=0;4>c;c++)if(null==b[c])throw Error(`Bad terrain: ${a.exit.map(a=>a[0]).join(",")}`);return b}
class yf{constructor(a,b){this.left=a;this.right=b;const c=Hf(a),d=Hf(b),e=new Set,f=[];for(let a=0;4>a;a++)e.add(c[a]<<2|d[a]);for(const c of e){const [d,e]=a.exit[c>>2],[g,n]=b.exit[c&3];f.push([d&g,H.meet(e,n)])}this.enter=H.meet(a.enter,b.enter);this.exit=f}get kind(){return"Terrain"}label(a){if(1===this.exit.length)return Ef.prototype.label.call(this,a);const b=[];H.isOpen(this.enter)||b.push(`enter = ${Ff(this.enter,a)}`);for(const [c,d]of this.exit){const e=[c&1?"N":"",c&2?"W":"",c&4?"S":"",
c&8?"E":""].join("");b.push(`exit${e} = ${Ff(d,a)}`)}return`${this.kind}(${b.join(", ")})`}}function Ff(a,b){a=[...a];const c=a.map(a=>ha.isEmpty(a)?"open":[...a].map(a=>{var c;return null===(c=b.flags[a])||void 0===c?void 0:c.debug}).join(" & ")).join(") | (");return 1<a.length?`(${c})`:a.length?c:"never"}Df.debugLabel=Ff;"object"===typeof window&&(window.debugLabel=Ff);function If(a){return a}(function(a){a.of=function(a,c){return 16777216*a+c};a.split=function(a){return[Math.floor(a/16777216),a%16777216]}})(If||(If={}));var Jf,Kf=Jf||(Jf={});Kf[Kf.WIND=0]="WIND";Kf[Kf.FIRE=1]="FIRE";Kf[Kf.WATER=2]="WATER";Kf[Kf.THUNDER=3]="THUNDER";class Lf{constructor(a,b,c,d=1){this.rom=a;this._width=c;this._height=b;this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.element.appendChild(this.canvas);this.canvas.width=c;this.canvas.height=b;this.ctx=this.canvas.getContext("2d")||$b();this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.palettes=new Uint32Array(1024);this.layers=w(d,()=>new Uint32Array(c*b));this.data=this.layers[0];for(d=0;256>d;d++)for(let b=0;4>b;b++){const c=Mf[a.palettes[d].color(b)];
this.palettes[d<<2|b]=c|4278190080}}useLayer(a){this.data=this.layers[a]||$b(`Bad layer: ${a}`)}resizeWidth(a,b){const c=new Uint32Array(b*this._height),d=Math.min(b,this._width);for(let e=0;e<this._height;e++)c.subarray(e*b,e+b+d).set(a.subarray(e*this._width,e*this._width+d));return c}resizeHeight(a,b){const c=new Uint32Array(this._width*b);b=this._width*Math.min(b,this._height);c.subarray(0,b).set(a.subarray(0,b));return c}get width(){return this._width}set width(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=
this.resizeWidth(this.layers[b],a);this._width=a;this.canvas.width=a}get height(){return this._height}set height(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=this.resizeHeight(this.layers[b],a);this._height=a;this.canvas.height=a}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(a){this.data.fill(a)}clear(a){a=null!=a?this.palettes[a<<2]:0;this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.layers[0].fill(a);
for(a=1;a<this.layers.length;a++)this.layers[a].fill(0)}toDataUrl(){return this.canvas.toDataURL("image/png")}render(){let a=this.canvas,b=this.ctx;for(let c=0;c<this.layers.length;c++){c&&(a=document.createElement("canvas"),a.width=this.canvas.width,a.height=this.canvas.height,b=a.getContext("2d")||$b());const d=new Uint8Array(this.layers[c].buffer),e=b.getImageData(0,0,this._width,this._height);e.data.set(d);b.putImageData(e,0,0);c&&this.ctx.drawImage(a,0,0)}}rect(a,b,c,d,e){const f=Math.max(0,
b);c=Math.min(this._height,a+c);d=Math.min(this._width,b+d);for(a=Math.max(0,a);a<c;a++)for(b=f;b<d;b++)this.data[a*this._width+b]=e}tile(a,b,c,d){if(!(0>b||0>a||b+8>=this._width||a+8>=this._height)){c=this.rom.patterns.get(c).flip(d<<6);for(let e=0;8>e;e++){let f=c.pixels[8|e]<<1,g=c.pixels[e];for(let c=7;0<=c;c--){const h=f&2|g&1;f>>>=1;g>>>=1;h&&(this.data[(a+e)*this._width+b+c]=this.palettes[d&1020|h])}}this._minX=Math.min(this._minX,b);this._maxX=Math.max(this._maxX,b+8);this._minY=Math.min(this._minY,
a);this._maxY=Math.max(this._maxY,a+8)}}metatile(a,b,c,d,e=0){var f=this.rom.locations[d];d=[...f.tilePatterns];f.animation&&(d[1]=this.rom.tileAnimations[f.animation].pages[e&7]);var g=[...f.tilePalettes,127];e=this.rom.tilesets[f.tileset];f=g[e.attrs[c]];for(g=0;2>g;g++)for(let h=0;2>h;h++){const k=e.tiles[g<<1|h][c];this.tile(a+(g<<3),b+(h<<3),d[k&128?1:0]<<6|k&127,f<<2)}}metasprite(a,b,c,d,e=0,f=0){d=this.rom.locations[d];var g=this.rom.metasprites[c];c=[64,66,...d.spritePatterns];d=[0,1,...d.spritePalettes];
let h=!1;null!=g.mirrored&&(g=this.rom.metasprites[g.mirrored],h=!0);if(g&&g.used){f&=g.frameMask;for(let [k,l,n,q]of g.sprites[f]){if(128==k)break;k=128>k?k:k-256;l=128>l?l:l-256;q=q+e&255;f=d[n&3]+176&255;g=c[q>>6]<<6|q&63;h&&(k=-8-k,n^=64);this.tile(a+l,b+k,g,f<<2|n>>6)}}}text(a,b,c,d=18){for(let e=0;e<c.length;e++)this.tile(a,b+8*e,c.charCodeAt(e)|3840,d<<2)}}
const Mf=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];const Nf=Symbol("[LocationMap data]");
class sg extends Lf{constructor(a,b=0){super(a,1,1,4);this.rom=a;this.flags=new Set;this._maxWidth=Infinity;a=a.locations[b];this.width=256*(a.used?a.width:1);this.height=240*(a.used?a.height:1);this.location=a;a=a=>{let b=a.offsetX,c=a.offsetY;for(var f=a.target;f&&f!==this.element;)f=f.parentElement;if(f){f=b>>8;var g=Math.floor(c/240);sg.setData(a,{tile:this.location.id<<16|g<<12|f<<8|c-240*g>>4<<4|b-256*f>>4,target:this})}};this.element.addEventListener("mousemove",a);this.element.addEventListener("mousedown",
a);this.element.addEventListener("mouseup",a);this.element.addEventListener("click",a);this.redraw()}static getData(a){return a[Nf]}static setData(a,b){a[Nf]=b}get id(){return this.location.id}set id(a){this.location=this.rom.locations[a];this.height=240*(this.location.used?this.location.height:1);this.width=256*(this.location.used?this.location.width:1);this.ensureWidth();this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(a){this._maxWidth=a;this.ensureWidth()}ensureWidth(){if(this.width<=
this._maxWidth)this.element.style.transform="",this.element.style.width="",this.element.style.height="";else{var a=this._maxWidth/this.width,b=50*(1-a);this.element.style.transform=`translate(-${b}%,-${b}%) scale(${a})`;this.element.style.width=`${this.width*a}px`;this.element.style.height=`${this.height*a}px`}}clearOverlay(){this.useLayer(1);this.fill(0);this.useLayer(3);this.fill(0);this.render()}overlayShade(a){this.useLayer(3);this.fill(a)}overlayArea(a,b,c){for(const d of a){if(d>>>16!==this.location.id)continue;
const e=240*(d>>>12&15)+16*(d>>>4&15),f=256*(d>>>8&15)+16*(d&15);null!=c&&(this.useLayer(3),this.rect(e-1,f-1,18,18,0));this.useLayer(1);a.has(of.add(d,-1,0))||this.rect(e-1,f-1,2,18,b);a.has(of.add(d,0,-1))||this.rect(e-1,f-1,18,2,b);a.has(of.add(d,1,0))||this.rect(e+15,f-1,2,18,b);a.has(of.add(d,0,1))||this.rect(e-1,f+15,18,2,b)}}redraw(){this.useLayer(0);this.clear(this.location.tilePalettes[0]);for(var a=0;a<this.location.height;a++)for(var b=0;b<this.location.width;b++)this.drawScreen(this.rom.screens[this.location.screens[a][b]],
a,b);this.useLayer(2);for(const c of this.location.spawns){a=0;let {x:d,y:e}=c;e-=c.yt&240;let f;if(c.isNpc()){b=this.rom.npcs[c.id];if(!b||!b.data)continue;d+=8;e+=12;f=2|b.data[3]}else if(c.isChest())f=170;else if(c.isMonster()){b=this.rom.objects[c.monsterId];if(!b)continue;f=b.metasprite;41==b.action?f=104:[42,94].includes(b.action)&&(f=2|b.data[31])}c.patternBank&&(a+=64);null!=f&&this.metasprite(e,d,f,this.location.id,a)}this.render()}drawScreen(a,b,c){var d;const e=240*b,f=256*c,g=this.rom.tilesets[this.location.tileset];
let h,k=!1;for(const a of this.location.flags)if(a.xs===c&&a.ys===b){h=a.flag;if(null===(d=this.rom.flags[h])||void 0===d?0:d.logic.assumeTrue)k=!0;break}for(b=0;240>b;b+=16)for(c=0;16>c;c++)d=a.tiles[b|c],32>d&&(this.flags.has(h)||k)&&(d=g.alternates[d]),this.metatile(e+b,f+16*c,d,this.location.id,0)}};class tg{constructor(a,b){this.rom=a;this.world=b;this.element=document.createElement("div");this.element.addEventListener("click",a=>this.click(a));this.element.addEventListener("mousemove",a=>this.move(a));this.renderArea(0)}click(a){if(a=sg.getData(a))if(a=this.world.tiles.get(a.tile),null!=a){if(a.area===this.area){const b=null!=a.exit?this.world.tiles.get(a.exit):null;b&&b.area!==this.area&&(a=b)}a.area&&a.area!==this.area&&this.renderArea(a.area.id)}}move(a){if(a=sg.getData(a)){var b=this.world.tiles.get(a.tile);
null!=b&&(b=null!=b.exit&&!this.area.tiles.has(b.exit),a.target.element.style.cursor=b?"pointer":"default")}}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(a){var b;this.clear();const c=document.createElement("select");c.appendChild(document.createElement("option"));c.children[0].textContent="Select location";for(const a of this.rom.locations){if(!a.used)continue;const d=null===(b=this.world.locations[a.id])||void 0===b?void 0:b.areas[Symbol.iterator]().next().value;
if(null==d)continue;const f=document.createElement("option");f.textContent=`${x(a.id)} ${a.name}`;f.value=String(d.id);c.appendChild(f)}c.addEventListener("change",()=>{this.renderArea(Number(c.value))});this.element.appendChild(c);this.area=this.world.areas[a];b=document.createElement("pre");b.textContent=`Area ${a}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${Df.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([a,b])=>`${a.debug}: ${Ff(b,this.rom)}`))].join("\n  ")}
Routes:
  ${Ff(this.area.routes,this.rom).split(" | ").join("\n  ").replace(/[()]/g,"")}`;this.element.appendChild(b);for(const c of this.area.locations)a=this.rom.locations[c],b=document.createElement("h2"),b.textContent=a.name,this.element.appendChild(b),this.element.appendChild(this.makeLocation(this.area,a))}makeLocation(a,b){const c=new sg(this.rom,b.id);c.maxWidth=574;c.overlayShade(1426063360);for(const d of this.world.locations[b.id].areas)d!==a&&c.overlayArea(d.tiles,4294901760);c.overlayArea(a.tiles,
4278255615,0);c.render();return c.element}};class ug{constructor(a,b){this.rom=a;this.id=b}write(){return[]}toString(){return`${this.constructor.name} $${x(this.id)}`}}class vg extends Array{static get [Symbol.species](){return Array}};class wg extends vg{constructor(a){super(44);this.rom=a;this.innBasePrice=20;this.toolShopScaling=Array(48).fill(0);this.armorShopScaling=Array(48).fill(0);for(let b=0;44>b;b++)this[b]=new xg(a,b);if(null!=a.shopDataTablesAddress){const b=a.shopDataTablesAddress+21*a.shopCount+2*a.scalingLevels;this.basePrices=w(73,c=>13<=c&&39>c?ee(a.prg,b+2*(c-13)):0)}else this.basePrices=w(73,b=>2*ee(a.prg,138946+2*b))}armorShops(){return w(11,a=>this[4*a])}toolShops(){return w(11,a=>this[4*a+1])}inns(){return w(11,
a=>this[4*a+2])}pawnShops(){return w(11,a=>this[4*a+3])}write(){var a,b,c,d,e,f,g,h;const k=this.rom.assembler();if(this.rescale){var l=function(a){k.export(a);k.label(a)};k.segment("10","fe","ff");k.reloc("ShopData");l("ShopData");l("ArmorShopIdTable");for(const b of this.armorShops())for(var n=0;4>n;n++)k.byte(null!==(a=b.contents[n])&&void 0!==a?a:255);l("ToolShopIdTable");for(const a of this.toolShops())for(n=0;4>n;n++)k.byte(null!==(b=a.contents[n])&&void 0!==b?b:255);l("ArmorShopPriceTable");
for(const a of this.armorShops())for(n=0;4>n;n++)k.byte(Math.round(32*(null!==(c=a.prices[n])&&void 0!==c?c:0)));l("ToolShopPriceTable");for(const a of this.toolShops())for(c=0;4>c;c++)k.byte(Math.round(32*(null!==(d=a.prices[c])&&void 0!==d?d:0)));l("InnPrices");for(const a of this.inns())k.byte(Math.round(32*(null!==(e=a.prices[0])&&void 0!==e?e:0)));l("ShopLocations");for(const a of this)k.byte(a.location);l("ToolShopScaling");k.byte(...this.toolShopScaling);l("ArmorShopScaling");k.byte(...this.armorShopScaling);
l("BasePrices");k.word(...this.basePrices.slice(13,39).map(a=>null!==a&&void 0!==a?a:0));l("InnBasePrice");k.word(this.innBasePrice)}else{k.segment("10","fe","ff");k.org(40356,"ShopData");for(const a of this.armorShops())for(d=0;4>d;d++)k.byte(null!==(f=a.contents[d])&&void 0!==f?f:255);for(const a of this.armorShops())for(d=0;4>d;d++)k.word(null!==(g=a.prices[d])&&void 0!==g?g:0);for(const a of this.toolShops())for(d=0;4>d;d++)k.byte(null!==(h=a.contents[d])&&void 0!==h?h:255);for(n of this.toolShops())for(d=
0;4>d;d++)k.word(null!==(l=n.prices[d])&&void 0!==l?l:0)}return[k.module()]}}var yg,zg=yg||(yg={});zg[zg.ARMOR=0]="ARMOR";zg[zg.TOOL=1]="TOOL";zg[zg.INN=2]="INN";zg[zg.PAWN=3]="PAWN";const Ag=[yg.ARMOR,yg.TOOL,yg.INN,yg.PAWN],Bg=[a=>a?a:138660,(a,b)=>a?a+4*b:138792,()=>0,()=>0],Cg=[4,4,0,0],Dg=[(a,b)=>a?a+8*b:138704,(a,b)=>a?a+12*b:138836,(a,b)=>a?a+16*b:138924,()=>0],Eg=[4,4,1,0];
class xg extends ug{constructor(a,b){super(a,b);this.type=Ag[b&3];this.index=b>>>2;if(a.shopDataTablesAddress)this.location=a.prg[a.shopDataTablesAddress+17*a.shopCount+b];else{b=255;for(let d=0;33>d&&255===b;d++){if(a.prg[139125+d]!==this.index)continue;const e=a.prg[139092+d];for(var c of a.locations[e].spawns)if(4===c.type&&a.objects[c.id].data[25]===32+this.type){b=e;break}}this.location=b}c=a.shopDataTablesAddress?b=>a.prg[this.pricesAddress+b]/32:b=>ee(a.prg,this.pricesAddress+2*b);this.contents=
Xd(a.prg,this.contentsAddress,Cg[this.type]);this.prices=w(Eg[this.type],c);this.used=255!==this.location}get contentsAddress(){return Bg[this.type](this.rom.shopDataTablesAddress,this.rom.shopCount)+4*this.index}get pricesAddress(){const a=this.rom.shopDataTablesAddress;return Dg[this.type](a,this.rom.shopCount)+(a?1:2)*Eg[this.type]*this.index}updateShopkeeper(){throw Error("not implemented");}};class Fg{constructor(){this.data=new Map;this.sizes=new Map}find(a){if(a!==a)throw"nan";this.data.has(a)||(this.data.set(a,a),this.sizes.set(a,1));let b;for(;!Object.is(b=this.data.get(a),a);)this.data.set(a,a=this.data.get(b));return a}union(a){this.find(a[0]);for(let b=1;b<a.length;b++){if(a[b]!==a[b])throw"nan";this.unionInternal(a[0],a[b])}}unionInternal(a,b){a=this.find(a);b=this.find(b);if(a!==b){var c=this.sizes.get(a),d=this.sizes.get(b);c<d?(this.sizes.set(b,c+d),this.data.set(a,b)):(this.sizes.set(a,
c+d),this.data.set(b,a))}}sets(){const a=new Map;for(const b of this.data.keys()){const c=this.find(b);let d=a.get(c);d||a.set(c,d=new Set);d.add(b)}return[...a.values()]}map(){const a=new da(()=>new Set);for(const b of this.data.keys()){let c=a.get(this.find(b));a.set(b,c);c.add(b)}return a}roots(){const a=new Set;for(const b of this.data.keys())a.add(this.find(b));return[...a]}};const Gg={next(){return{done:!0}}},Hg={get size(){return 0},has(){return!1},[Symbol.iterator](){return Gg}},I={get size(){return Infinity},has(){return!0},[Symbol.iterator](){throw Error("cannot iterate");}};class Ig{constructor(a){this.bit=a}get size(){return 1}has(a){return a===this.bit}[Symbol.iterator](){return[this.bit][Symbol.iterator]()}}function Jg(a){return new Ig(a)}var Kg;
(function(a){a.intersect=function(a,c){if(a===I||!c.size)return c;if(c===I||!a.size)return a;const b=new Set;for(const d of a)c.has(d)&&b.add(d);return b.size?b:Hg};a.union=function(a,c){if(a===I||!c.size)return a;if(c===I||!a.size)return c;a=new Set(a);for(const b of c)a.add(b);return a};a.isSubset=function(a,c){if(c===I||!a.size)return!0;if(a.size>c.size)return!1;for(const b of a)if(!c.has(b))return!1;return!0};a.label=function(a){return a===I?"all":[...a].sort().join(" ")}})(Kg||(Kg={}));
class Lg{constructor(a,b,c){this.fixed=a;this.float=b;this.shift=c}get pat0(){return this.fixed[0]}get pat1(){return this.fixed[1]}get pal2(){return this.fixed[2]}get pal3(){return this.fixed[3]}static get ALL(){return new Lg([I,I,I,I],[],0)}static get NONE(){return new Lg([Hg,Hg,Hg,Hg],[],0)}static get MIMIC(){return new Lg([I,Jg(108),I,I],[],2)}static get TREASURE_CHEST(){return new Lg([I,I,I,I],[Mg],0)}static get BOSS(){return new Lg([Mg,I,I,I],[],0)}static get COIN(){return new Lg([Ng,I,I,I],
[],0)}static get STOM_FIGHT(){return new Lg([I,new Set([77]),I,I],[],0)}static get GUARDIAN_STATUE(){return new Lg([new Set([116]),new Set([98]),I,I],[],0)}static get SHOOTING_WALL(){return new Lg([new Set([97]),I,I,I],[],0)}static get KENSU_CHEST(){return new Lg([new Set([81]),I,I,I],[],0)}static forLocation(a){switch(a){case 3:return new Lg([I,Jg(96),I,Jg(32)],[],0);case 96:case 100:case 104:return new Lg([I,Jg(82),I,Jg(8)],[],0)}return Lg.ALL}static fromSpawn(a,b,c,d,e){const [f,...g]=b;(e=e&&
2===f&&!g.length)&&d.patternBank&&(b=new Set([3]));const h=e||!b.has(2)?I:Jg(c.spritePatterns[0]);b=e||!b.has(3)?I:Jg(c.spritePatterns[1]);d=e?[Jg(c.spritePatterns[d.patternBank])]:[];e=a.has(2)?Jg(c.spritePalettes[0]):I;a=a.has(3)?Jg(c.spritePalettes[1]):I;return new Lg([h,b,e,a],d,0)}ignorePalette(){return new Lg([this.fixed[0],this.fixed[1],I,I],this.float,this.shift)}shufflePalette(a,b){const c=[...this.fixed];for(let d=2;4>d;d++){if(c[d]===I)continue;const e=Math.floor(5-Math.log2(a.nextInt(15)+
2)),f=c[d]=new Set;for(let c=0;c<e;c++)f.add(a.pick(b))}return new Lg(c,this.float,this.shift)}shifted(){return new Lg(this.fixed,this.float,this.shift|2)}join(a){const b=w(4,b=>Kg.union(this.fixed[b],a.fixed[b]));if(this.float.length!==a.float.length)throw console.dir(this),console.dir(a),Error(`incompatible float: ${this.float} ${a.float}`);const c=w(this.float.length,b=>Kg.union(this.float[b],a.float[b]));return new Lg(b,c,this.shift|a.shift)}fix(a,b){var c=b?a=>b.nextInt(a):()=>0;const d=b?a=>
b.pick([...a]):a=>a[Symbol.iterator]().next().value,e=[...this.fixed];if(this.float.length){c=c(2);const a=1-c;c<this.float.length&&(e[0]=Kg.intersect(e[0],this.float[c]));a<this.float.length&&(e[1]=Kg.intersect(e[1],this.float[a]))}e[0]!==I&&(a.spritePatterns[0]=d([...e[0]]));e[1]!==I&&(a.spritePatterns[1]=d([...e[1]]));e[2]!==I&&(a.spritePalettes[0]=d([...e[2]]));e[3]!==I&&(a.spritePalettes[1]=d([...e[3]]))}meet(a,b=!1){a=this.tryMeet(a,b);if(!a)throw Error("Could not reconcile patterns");return a}tryMeet(a,
b=!1){const c=[];let d=this.shift|a.shift;for(var e=0;4>e;e++){var f=Kg.intersect(this.fixed[e],a.fixed[e]);if(!f.size){if(!b||2>e)return;f=Kg.union(this.fixed[e],a.fixed[e])}c.push(f)}e=new Map;b=[];for(var g of ha.concat(this.float,a.float)){if(g===I)throw Error("Unexpected unconstrained float");a=!1;for(var h of g)if(f=e.get(h),null!=f){for(var k of b[f])e.delete(k);b[f]=Kg.intersect(b[f],g);for(const a of b[f])e.set(a,f);a=!0;break}if(a)break;for(const a of g)e.set(a,b.length);b.push(g);if(2<
b.length)return}for(g=0;g<b.length;g++)for(h=0;2>h;h++)if(!Kg.intersect(b[g],c[h]).size){k=c[1-h]=Kg.intersect(b[g],c[1-h]);d|=1<<1-h;if(!k.size)return;b.splice(g,1);g=-1;break}return new Lg(c,b,d)}}const Mg=new Set([94,95,96,97,100,101,102,103,104,105,106,108,109,110,111,112,116,117,118,119]),Ng=new Set([94,95,96,97,99,100,101,102,103,104,105,106,107,108,109,110,111,112,116,117,118,119]);class Og extends ug{constructor(a,b,c=""){super(a.rom,b);this.constraint=Lg.ALL;a[b]=this;this.used=!0;this.name="";a.rom.writeMonsterNames?(a=this.rom.prg,b=this.rom.prg[499712|b]|this.rom.prg[499968|b]<<8|458752,b=String.fromCharCode(...a.slice(b+1,b+1+a[b]))):b=c;this.displayName=b;this.base=ee(this.rom.prg,this.pointer)+65536;this.sfx=this.rom.prg[this.base];this.data=[];b=this.base+1;a=0;for(c=0;32>c;c++)c&7||(a=this.rom.prg[b++]),this.data.push(a&128?this.rom.prg[b++]:0),a<<=1}get pointer(){return 109568+
(this.id<<1)}serialize(){const a=[this.sfx];for(let b=0;4>b;b++){const c=a.length;a.push(0);for(let d=0;8>d;d++)this.data[8*b+d]&&(a[c]|=128>>>d,a.push(this.data[8*b+d]))}return a}write(){var a=`Object_${this.id.toString(16).padStart(2,"0")}`;const b=this.rom.assembler();b.segment("0d");b.reloc(a);var c=b.pc();b.byte(...this.serialize());b.org(44032+(this.id<<1),`${a}_Ptr`);b.word(c);if(this===this.rom.objects.blueSlime){a=this.elements;for(c=0;a;)a>>=1,c++;b.segment("1a");b.org(37421);b.byte(c)}if(this.rom.writeMonsterNames){b.segment("3d");
let a;this.displayName&&(b.reloc(`${this.name}_Str`),a=b.pc(),b.byte(this.displayName.length),b.byte(...this.displayName));b.org(40960|this.id);b.byte(null!=a?za.loByte(a):0);b.org(41216|this.id);b.byte(null!=a?za.hiByte(a):0)}return[b.module()]}get(a){return this.data[a-768>>>5]}parents(){return[]}spawnedChild(){var a;if(null!==(a=this.rom.objectActions[this.action])&&void 0!==a&&a.data.hasChild&&(a=(a=this.rom.adHocSpawns[this.child])&&a.objectId,null!=a))return this.rom.objects[a]}spawnedReplacement(){if(this.replacement)return this.rom.objects[this.replacement]}locations(){return this.rom.locations.filter(a=>
a.used&&a.spawns.some(a=>a.isMonster()&&a.monsterId===this.id))}palettes(a=!1){var b,c;if(34===this.action)return[3];var d=this.data[0];42===this.action&&(d=this.data[31]|1);41===this.action&&(d=107);38===this.action&&(d=156);d=this.rom.metasprites[d];a=a&&this.child?this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]]:null;return[...new Set([...null!==(b=null===d||void 0===d?void 0:d.palettes())&&void 0!==b?b:[],...null!==(c=null===a||void 0===a?void 0:a.palettes())&&
void 0!==c?c:[]])]}isVulnerable(a){return!(this.elements&1<<a)}isShadow(){return 123===this.id||140===this.id}get metasprite(){return Pg.get(this.data)}set metasprite(a){Pg.set(this.data,a)}get speed(){return Qg.get(this.data)}set speed(a){Qg.set(this.data,a)}get collisionPlane(){return Rg.get(this.data)}set collisionPlane(a){Rg.set(this.data,a)}get hitbox(){return Sg.get(this.data)}set hitbox(a){Sg.set(this.data,a)}get hp(){return Tg.get(this.data)}set hp(a){Tg.set(this.data,a)}get atk(){return Ug.get(this.data)}set atk(a){Ug.set(this.data,
a)}get def(){return Vg.get(this.data)}set def(a){Vg.set(this.data,a)}get level(){return Wg.get(this.data)}set level(a){Wg.set(this.data,a)}get poison(){return!!Xg.get(this.data)}set poison(a){Xg.set(this.data,a?1:0)}get child(){return Yg.get(this.data)}set child(a){Yg.set(this.data,a)}get terrainSusceptibility(){return Zg.get(this.data)}set terrainSusceptibility(a){Zg.set(this.data,a)}get immobile(){return!!$g.get(this.data)}set immobile(a){$g.set(this.data,a?1:0)}get action(){return ah.get(this.data)}set action(a){ah.set(this.data,
a)}get replacement(){return bh.get(this.data)}set replacement(a){bh.set(this.data,a)}get goldDrop(){return ch.get(this.data)}set goldDrop(a){ch.set(this.data,a)}get elements(){return dh.get(this.data)}set elements(a){dh.set(this.data,a)}get expReward(){return eh.get(this.data)}set expReward(a){eh.set(this.data,a)}get attackType(){return fh.get(this.data)}set attackType(a){fh.set(this.data,a)}get statusEffect(){return gh.get(this.data)}set statusEffect(a){gh.set(this.data,a)}toString(){return super.toString()+
(this.name?" "+this.name:"")}}function hh(...a){return new ih(...a)}class ih{constructor(...a){this.spec=a}get(a){let b=0;for(const [c,d=255,e=0]of this.spec)b|=(a[c-768>>>5]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b}set(a,b){for(const [c,d=255,e=0]of this.spec){const f=c-768>>>5;a[f]=a[f]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d}}}
const Pg=hh([768]),Qg=hh([832,15]),Rg=hh([928,240,4]),Sg=hh([1056,64,2],[928,15]),Tg=hh([960]),Ug=hh([992]),Vg=hh([1024]),Wg=hh([1056,31]),Xg=hh([1056,128,7]),Yg=hh([1088]),Zg=hh([1120]),$g=hh([1184,128,7]),ah=hh([1184,127]),bh=hh([1216]),ch=hh([1280,240,4]),dh=hh([1280,15]),eh=hh([1312]),fh=hh([1344]),gh=hh([1376,15]);class J extends Og{constructor(a,b){super(a,b.id,b.displayName);a=b.scaling;var c=((24>a?1+a/3:(a+12)/4)+this.level)/2;a:{var d=this.elements;d=void 0===d?0:d;var e=10>a?1:18>a?2:38>a?4:8;for(var f=e;f;f>>>=1)if(!(f&d)){d=f<<1;break a}d=e<<1}d=c+d;this.hits=(this.hp+1)/(d-this.def);this.sdef=this.def/d;c=Math.min(255,Math.max(16,32+16*c));d=this.atk;e=24>a?1+a/3:(a+12)/4;f=this.attackType?jh(a,2,[6,6],[18,8],[25,12],[30,18],[37,24],[42,32]):jh(a,2,[6,6],[18,10],[25,14],[30,18],[40,24],[46,32]);this.satk=
(d-(e+f))/c;this.extraDifficulty=b.difficulty||0;this.monsterClass=b.class;c=this.expReward;c=(128>c?c:(c&127)<<4)/Math.pow(2,a/5-1);a=kh[this.goldDrop]/Math.pow(2,a/7-1);this.type=b.type||"monster";this.wealth=a&&a/(c+a)}isBoss(){return"boss"===this.type}isProjectile(){return"projectile"===this.type}isBird(){const a=this.rom.objectActions[this.action];return(null===a||void 0===a?void 0:a.data.bird)||!1}isFlyer(){const a=this.rom.objectActions[this.action];return(null===a||void 0===a?void 0:a.data.bird)||
(null===a||void 0===a?void 0:a.data.moth)||!1}placement(){var a,b;return null!==(b=null===(a=this.rom.objectActions[this.action])||void 0===a?void 0:a.data.placement)&&void 0!==b?b:"normal"}clearance(){var a;return(null===(a=this.rom.objectActions[this.action])||void 0===a?0:a.data.large)?6:3}totalDifficulty(){return this.toughness()+this.attack()+this.statusDifficulty()+this.immunities()+this.movement()}collectDifficulty(a,b){let c=a(this);var d=this.spawnedChild();d instanceof J&&(c=b(c,d.collectDifficulty(a,
b)));d=this.spawnedReplacement();d instanceof J&&(c=b(c,d.collectDifficulty(a,b)));return c}toughness(){return this.collectDifficulty(a=>jh(a.hits,0,[2,1],[3,2],[5,3],[7,4],[10,5],[13,6]),Math.max)}attack(){return this.collectDifficulty(a=>a.attackType&&a.statusEffect?0:jh(a.satk,0,[.04,1],[.08,2],[.13,3],[.18,4],[.25,5],[.33,6]),Math.max)}addStatusEffects(a){this.attackType&&this.statusEffect?a.add(this.statusEffect):!this.attackType&&this.poison&&a.add(0);var b=this.spawnedReplacement();b instanceof
J&&b.addStatusEffects(a);b=this.spawnedChild();b instanceof J&&b.addStatusEffects(a)}statusDifficulty(){const a=new Set;this.addStatusEffects(a);let b=0;for(const c of a)b+=lh[c];return b}immunities(){let a=0,b=this.elements;for(;b;)b&1&&a++,b>>>=1;return a&&1<<a-1}movement(){return this.collectDifficulty(a=>{const b=this.rom.objectActions[a.action],c=a.spawnedChild();a=a.extraDifficulty;b&&(a+=b.data.movement||0,b.data.large&&a++,c&&!c.statusEffect&&(a+=b.data.projectile||0));167===this.metasprite&&
(a+=2);return a},(a,b)=>a+b)}totalReward(){return this.totalDifficulty()/4}normalizedGold(){if(!this.wealth)return 0;const a=this.totalDifficulty()*this.wealth*.6;return Math.max(1,Math.min(15,Math.round(a)))}normalizedExp(){if(1===this.wealth)return 0;const a=.488+this.totalDifficulty()*(1-this.wealth)*.256;return Math.max(1,Math.min(255,Math.round(32*a)))}toString(){return`Monster $${x(this.id)} ${this.name}`}}const lh=[2,1,3,2,4],kh=[0,1,2,4,8,16,30,50,100,200,400,50,100,200,400,500];
function jh(a,b,...c){for(let b=c.length-1;0<=b;b--){const [d,f]=c[b];if(a>=d)return f}return b};class mh{constructor(a,b,c=!1){this.rom=a;this.flagset=b;this.tracker=c;this.terrainFactory=new uf(this.rom);this.terrains=new Map;this.checks=new da(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new da(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new Fg;this.neighbors=new da(()=>0);this.routes=new da(()=>new H.Builder);this.routeEdges=new da(()=>new ja);this.requirementMap=new da(a=>new H.Builder(a));this.limeTreeEntranceLocation=-1;for(const b of a.items)for(const a of b.itemUseData)"expect"===
a.kind?this.itemUses.get(a.want).push([b,a]):"location"===a.kind&&this.itemUses.get(~a.want).push([b,a]);this.aliases=new Map([[a.flags.ChangeAkahana,a.flags.Change],[a.flags.ChangeSoldier,a.flags.Change],[a.flags.ChangeStom,a.flags.Change],[a.flags.ChangeWoman,a.flags.Change],[a.flags.ParalyzedKensuInDanceHall,a.flags.Paralysis],[a.flags.ParalyzedKensuInTavern,a.flags.Paralysis]]);b.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(const b of a.locations)this.processLocation(b);
this.addExtraChecks();this.unionNeighbors();this.recordExits();this.buildNeighbors();this.addAllRoutes();this.consolidateChecks();this.buildRequirementMap()}addExtraChecks(){const {locations:{Leaf_ToolShop:a,MezameShrine:b,Oak:c,Shyron_ToolShop:d},flags:{AbleToRideDolphin:e,BallOfFire:f,BallOfThunder:g,BallOfWater:h,BallOfWind:k,Barrier:l,BlizzardBracelet:n,BowOfMoon:q,BowOfSun:v,BreakStone:y,BreakIce:A,BreakIron:z,BrokenStatue:R,BuyHealing:G,BuyWarp:E,ClimbWaterfall:L,ClimbSlope8:fa,ClimbSlope9:ba,
ClimbSlope10:lb,CrossPain:ea,CurrentlyRidingDolphin:Eb,Flight:sb,FlameBracelet:xc,FormBridge:bc,GasMask:yb,GlowingLamp:zb,InjuredDolphin:Nc,LeadingChild:kd,LeatherBoots:ld,Money:nb,OpenedCrypt:ob,RabbitBoots:Na,Refresh:ab,RepairedStatue:Qa,RescuedChild:Oc,ShellFlute:Qb,ShieldRing:cc,ShootingStatue:dc,ShootingStatueSouth:ec,StormBracelet:Pc,Sword:bb,SwordOfFire:fc,SwordOfThunder:gc,SwordOfWater:Qc,SwordOfWind:Rc,TornadoBracelet:Fd,TravelSwamp:md,TriggerSkip:yc,WildWarp:U},items:{MedicalHerb:pb,WarpBoots:hc}}=
this.rom,Ha=this.entrance(b);var Fb=this.entrance(c);this.addCheck([Ha],nh(q,v),[ob.id]);this.addCheck([Ha],nh(e,Qb),[Eb.id]);this.addCheck([Fb],nh(kd),[Oc.id]);this.addItemCheck([Ha],nh(zb,R),Qa.id,{lossy:!0,unique:!0});for(var cb of this.rom.shops)if(cb.location!==a.id&&cb.location!==d.id&&cb.used&&cb.type===yg.TOOL){Fb=[of(cb.location<<16|136)];for(var Rb of cb.contents)Rb===pb.id?this.addCheck(Fb,nb.r,[G.id]):Rb===hc.id&&this.addCheck(Fb,nb.r,[E.id])}cb=Rc.r;Rb=fc.r;Fb=Qc.r;let nd=gc.r;if(!this.flagset.orbsOptional()){var zc=
oh(k,Fd);const a=oh(f,xc),b=oh(h,n),c=oh(g,Pc);cb=H.meet(cb,zc);Rb=H.meet(Rb,a);Fb=H.meet(Fb,b);nd=H.meet(nd,c);if(this.flagset.assumeSwordChargeGlitch()){zc=function(b){return a.map(a=>a[0]===b.c?a:[b.c,...a])};const a=H.or(cb,Rb,Fb,nd);cb=zc(Rc);Rb=zc(fc);Fb=zc(Qc);nd=zc(gc)}}this.addCheck([Ha],cb,[y.id]);this.addCheck([Ha],Rb,[A.id]);this.addCheck([Ha],Fb,[bc.id]);this.addCheck([Ha],nd,[z.id]);this.addCheck([Ha],oh(Rc,fc,Qc,gc),[bb.id]);this.addCheck([Ha],sb.r,[L.id,lb.id]);this.addCheck([Ha],
oh(sb,Na),[fa.id]);this.addCheck([Ha],oh(sb,Na),[ba.id]);this.addCheck([Ha],l.r,[dc.id,ec.id]);this.addCheck([Ha],yb.r,[md.id]);cb=this.flagset.changeGasMaskToHazmatSuit()?yb:ld;this.addCheck([Ha],oh(sb,Na,cb),[ea.id]);this.flagset.leatherBootsGiveSpeed()&&this.addCheck([Ha],ld.r,[fa.id]);this.flagset.assumeGhettoFlight()&&this.addCheck([Ha],nh(Eb,Na),[L.id]);this.flagset.fogLampNotRequired()&&(cb=this.flagset.requireHealedDolphinToRide(),this.addCheck([Ha],cb?Nc.r:[[]],[e.id]));this.flagset.guaranteeBarrier()||
this.addCheck([Ha],[[nb.c,G.c],[nb.c,cc.c],[nb.c,ab.c]],[dc.id,ec.id]);this.flagset.assumeFlightStatueSkip()&&this.addCheck([Ha],[[nb.c,sb.c]],[dc.id]);this.flagset.guaranteeGasMask()||this.addCheck([Ha],[[nb.c,G.c],[nb.c,ab.c]],[md.id,ea.id]);this.flagset.assumeWildWarp()&&this.addCheck([Ha],H.OPEN,[U.id]);this.flagset.assumeTriggerGlitch()&&(this.addCheck([Ha],H.OPEN,[yc.id]),this.addCheck([Ha],yc.r,[ea.id,fa.id,ba.id]))}addExtraRoutes(){var a;const {flags:{BuyWarp:b,SwordOfThunder:c,Teleport:d,
WildWarp:e},locations:{MezameShrine:f}}=this.rom;this.addRoute(new sf(this.entrance(f),[]));if(this.flagset.teleportOnThunderSword()){var g=this.rom.townWarp.thunderSwordWarp;this.addRoute(new sf(this.entrance(g[0],g[1]&31),[c.c,b.c]));this.addRoute(new sf(this.entrance(g[0],g[1]&31),[c.c,d.c]))}if(this.flagset.assumeWildWarp())for(const b of this.rom.wildWarp.locations){if(b===this.rom.locations.UndergroundChannel.id)continue;g=this.entrance(b);const c=null!==(a=this.terrains.get(g))&&void 0!==a?
a:$b("bad entrance");for(const a of c.enter)this.addRoute(new sf(g,[e.c,...a]))}}consolidateChecks(){for(const [a,b]of this.checks){const c=this.tiles.find(a);if(a!==c){for(const a of b)this.checks.get(c).add(a);this.checks.delete(a)}}}buildRequirementMap(){for(const [a,b]of this.checks)for(const {checks:c,requirement:d}of b)for(const b of c){const c=this.requirementMap.get(b);for(const b of d)for(const d of this.routes.get(a)||[])c.addList([...b,...d])}}getLocationList(a="Crystalis"){return{worldName:a,
requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:a=>this.rom.flags[a].name,prefill:a=>{const {Crystalis:b,MesiaInTower:d,LeafElder:e}=this.rom.flags,f=new Map([[d.id,b.id]]);this.flagset.guaranteeSword()&&f.set(e.id,512|a.nextInt(4));return f}}}processLocation(a){a.used&&(this.processLocationTiles(a),this.processLocationSpawns(a),this.processLocationItemUses(a))}unionNeighbors(){for(const [b,c]of this.terrains){var a=of.add(b,0,1);this.terrains.get(a)===c&&this.tiles.union([b,
a]);a=of.add(b,1,0);this.terrains.get(a)===c&&this.tiles.union([b,a])}}addAllRoutes(){this.addExtraRoutes();for(const [b,c]of this.neighbors){const [d,e]=If.split(b);var a=this.terrains.get(d);const f=this.terrains.get(e);if(!a||!f)throw Error(`missing terrain ${x(a?d:e)}`);for(const [b,h]of a.exit)if(b&c)for(const a of h)for(const b of f.enter)this.addRoute(new sf(e,[...a,...b]),d)}"object"===typeof document&&(a=document.getElementById("debug"))&&a.appendChild((new tg(this.rom,this.getWorldData())).element)}getWorldData(){var a=
0;const b=new da(()=>({})),c=w(256,()=>({areas:new Set,tiles:new Set})),d=[];for(var e of this.tiles.sets()){var f=this.tiles.find(ha.first(e)),g=this.terrains.get(f);if(g&&(f=this.routes.has(f)?H.freeze(this.routes.get(f)):[],f.length)){g={checks:[],id:a++,locations:new Set,routes:f,terrain:g,tiles:new Set};d.push(g);for(const a of e)f=a>>>16,g.locations.add(f),g.tiles.add(a),c[f].areas.add(g),c[f].tiles.add(a),b.get(a).area=g}}for(const [a,c]of this.exits)b.has(a)&&(b.get(a).exit=c);for(const [c,
d]of this.checks)if(a=b.get(c).area)for(const {checks:b,requirement:c}of d)for(const d of b)e=this.rom.flags[d]||$b(),a.checks.push([e,c]);return{tiles:b,areas:d,locations:c}}addRoute(a,b){if(null!=b){this.routeEdges.get(b).add(a);for(var c of this.routes.get(b))this.addRoute(new sf(a.target,[...c,...a.deps]))}else for(b=new ja,c=new ja,b.add(a),a=b[Symbol.iterator]();;){const {value:d,done:e}=a.next();if(e)break;c.add(d);b.delete(d);const f=new ja,g=d.target;if(this.routes.get(g).addRoute(d))for(const a of this.routeEdges.get(g))f.add(new sf(a.target,
[...d.deps,...a.deps]));for(const a of f)c.has(a)||(b.delete(a),b.add(a))}}recordExits(){for(const [a,b]of this.exits)this.exitSet.add(If.of(this.tiles.find(a),this.tiles.find(b)));for(const a of this.exitSet){const [b,c]=If.split(a);if(this.terrains.get(b)!==this.terrains.get(c))continue;const d=If.of(c,b);this.exitSet.has(d)&&(this.tiles.union([b,c]),this.exitSet.delete(a),this.exitSet.delete(d))}}buildNeighbors(){for(const [c,d]of this.terrains)if(d){var a=of.add(c,1,0),b=this.terrains.get(a);
b&&b!==d&&this.handleAdjacentNeighbors(c,a,mf.North);a=of.add(c,0,1);(b=this.terrains.get(a))&&b!==d&&this.handleAdjacentNeighbors(c,a,mf.West)}for(const b of this.exitSet){const [c,e]=If.split(b);this.terrains.has(c)&&this.terrains.has(e)&&(a=If.of(this.tiles.find(c),this.tiles.find(e)),this.neighbors.set(a,this.neighbors.get(a)|1))}}handleAdjacentNeighbors(a,b,c){var d=this.tiles.find(a);const e=this.tiles.find(b);this.seamlessExits.has(b)||(b=If.of(e,d),this.neighbors.set(b,this.neighbors.get(b)|
1<<c));this.seamlessExits.has(a)||(a=c^2,d=If.of(d,e),this.neighbors.set(d,this.neighbors.get(d)|1<<a))}processLocationTiles(a){var b,c,d,e=new Map;const f=new Set,g=88===(a.id&248);for(var h of a.spawns)if(h.isWall())e.set(tf.from(a,h),h.id&3);else if(h.isMonster()&&63===h.id){var k=of(tf.from(a,h)<<8|h.yt<<4);for(var l=4;11>=l;l++)for(var n=-3;3>=n;n++)f.add(of.add(k,n,l))}h=this.rom.tilesets[a.tileset];const q=this.rom.tileEffects[a.tileEffects-179],v=b=>q.effects[this.rom.screens[a.screens[(b&
61440)>>>12][(b&3840)>>>8]].tiles[b&255]];k=(b,c,d)=>{b&=Df.BITS;26===a.id&&(b|=Df.SWAMP);if(96===a.id||104===a.id)b|=Df.DOLPHIN;100===a.id&&4144>(c&61680)&&(b|=Df.DOLPHIN);d&&(b|=Df.BARRIER);if(!(b&Df.DOLPHIN)&&b&Df.SLOPE){d=c;let a=0;for(;v(d)&Df.SLOPE;)d=of.add(d,1,0),a++;6>a?b&=~Df.SLOPE:9>a?b|=Df.SLOPE8:10>a&&(b|=Df.SLOPE9)}if(b&Df.PAIN)for(const a of[[0,1],[1,0],[0,-1],[-1,0]])if(!(v(of.add(c,...a))&(Df.PAIN|Df.FLY))){b&=~Df.PAIN;break}return this.terrainFactory.tile(b)};for(let v=0,E=a.height;v<
E;v++){l=a.screens[v];n=a.id<<8|v<<4;for(let v=0,fa=a.width;v<fa;v++){const fa=this.rom.screens[l[v]],G=tf(n|v),E=G&255;var y=e.get(G);y=g?this.rom.flags.AlwaysTrue.id:null!=y?this.wallCapability(y):null===(b=a.flags.find(a=>a.screen===E))||void 0===b?void 0:b.flag;var A=a.pits.find(a=>a.fromScreen===G);A&&this.exits.set(of(G<<8|136),of(A.toScreen<<8|136));A=null!==(d=null===(c=this.rom.flags[y])||void 0===c?void 0:c.logic)&&void 0!==d?d:{};for(let b=0;240>b;b++){const c=of(G<<8|b);var z=fa.tiles[b];
A.assumeTrue&&32>z&&(z=h.alternates[z]);var R=a.isShop()?0:q.effects[z];const d=f.has(c);R=k(R,c,d);32>z&&h.alternates[z]!==z&&null!=y&&!A.assumeTrue&&!A.assumeFalse&&(z=k(q.effects[h.alternates[z]],c,d))&&(R=this.terrainFactory.flag(R,A.track?y:-1,z));R&&this.terrains.set(c,R)}}}for(const f of a.exits){const {dest:g,entrance:h}=f;b=of.from(a,f);f.isSeamless()?(c=of(b&65535|g<<16),d=of.from(a,f),this.seamlessExits.add(d),(e=this.terrains.get(d))&&this.terrains.set(d,this.terrainFactory.seamless(e))):
c=this.entrance(this.rom.locations[g],h&31);this.exits.set(b,c);g===this.rom.locations.LimeTreeLake.id&&160<this.rom.locations.LimeTreeLake.entrances[h].y&&(this.limeTreeEntranceLocation=a.id)}}processLocationSpawns(a){for(const b of a.spawns)b.isTrigger()?this.processTrigger(a,b):b.isNpc()?this.processNpc(a,b):b.isBoss()?this.processBoss(a,b):b.isChest()?this.processChest(a,b):b.isMonster()?this.processMonster(a,b):3===b.type&&224===b.id&&this.processKeyUse(pf.screen(of.from(a,b)),this.rom.flags.UsedWindmillKey.r)}processTrigger(a,
b){var c=this.rom.trigger(b.id);if(!c)throw Error(`Missing trigger ${b.id.toString(16)}`);const d=this.filterRequirements(c.conditions);let e=this.filterAntiRequirements(c.conditions);const f=of.from(a,b);let g=pf.trigger(a,b);const h=[];for(const a of c.flags){const b=this.flag(a);(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}h.length&&this.addCheck(g,d,h);switch(c.message.action){case 25:134!==c.id||this.flagset.assumeRabbitSkip()?186!==c.id||this.flagset.assumeTeleportSkip()||this.flagset.disableTeleportSkip()||
(g=pf.atLocation(g,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)):g=pf.adjust(g,[0,-1],[0,1]);this.flagset.assumeTriggerGlitch()&&(e=H.or(e,this.rom.flags.TriggerSkip.r));this.addTerrain(g,this.terrainFactory.statue(e));break;case 29:this.addBossCheck(g,this.rom.bosses.Mado1,d);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(g,d,c.id);break;case 24:c=this.flagset.chargeShotsOnly()?H.meet(d,nh(this.rom.flags.WarpBoots)):d;this.addItemCheck(g,c,this.rom.flags.StomFightReward.id,
{lossy:!0,unique:!0});break;case 30:this.addItemCheck(g,d,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(f,a,d);break;case 27:a===this.rom.locations.Portoa_PalaceEntrance&&(g=pf.adjust(g,[-2,0]),e=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(g,a,e)}for(const [c,d]of this.itemUses.get(b.type<<8|b.id))this.processItemUse([of.from(a,b)],H.OPEN,c,d)}processNpc(a,b){var c,d,e;const f=this.rom.npcs[b.id];if(!f||!f.used)throw Error(`Unknown npc: ${x(b.id)}`);
const g=f.spawnConditions.get(a.id)||[];var h=this.filterRequirements(g),k=of.from(a,b);k=[this.terrains.has(k)?k:null!==(c=this.walkableNeighbor(k))&&void 0!==c?c:k];for(const [a,c]of this.itemUses.get(b.type<<8|b.id))this.processItemUse(k,h,a,c);f===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(k,this.rom.bosses.Sabera1,h);f.data[2]&4&&!this.flagset.assumeStatueGlitch()&&(b=this.filterAntiRequirements(g),f===this.rom.npcs.Rage?(k=pf.adjust(k,[2,-1],[2,0],[2,1],[2,2]),k=pf.adjust(k,[0,
-6],[0,-2],[0,2],[0,6])):f===this.rom.npcs.PortoaThroneRoomBackDoorGuard?b=H.or(this.rom.flags.MesiaRecording.r,nh(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):f===this.rom.npcs.SoldierGuard&&(b=void 0),b&&this.addTerrain(k,this.terrainFactory.statue(b)));f===this.rom.npcs.FortuneTeller&&(k=pf.adjust(k,[0,0],[2,0]));if(!H.isClosed(h)){[[...h]]=h;for(const a of f.globalDialogs){b=this.flag(~a.condition);c=this.flag(a.condition);if((null===b||void 0===b?0:b.logic.assumeFalse)||(null===
c||void 0===c?0:c.logic.assumeTrue))return;(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}a=null!==(e=null!==(d=f.localDialogs.get(a.id))&&void 0!==d?d:f.localDialogs.get(-1))&&void 0!==e?e:[];for(const b of a){d=[...h];e=this.flag(b.condition);a=this.flag(~b.condition);(null===e||void 0===e?0:e.logic.track)&&d.push(e.id);(null===e||void 0===e?0:e.logic.assumeFalse)||(null===a||void 0===a?0:a.logic.assumeTrue)||this.processDialog(k,f,d,b);if((null===e||void 0===e?0:e.logic.assumeTrue)||(null===
a||void 0===a?0:a.logic.assumeFalse))break;(null===a||void 0===a?0:a.logic.track)&&h.push(a.id)}}}processDialog(a,b,c,d){this.addCheckFromFlags(a,[c],d.flags);const e={lossy:!0,unique:!0};switch(d.message.action){case 8:this.processKeyUse(a,[c]);break;case 20:this.addItemCheck(a,[c],this.rom.flags.SlimedKensu.id,e);break;case 16:this.addItemCheck(a,[c],this.rom.flags.AsinaInBackRoom.id,e);break;case 17:this.addItemCheck(a,[c],256|b.data[1],e);break;case 3:case 10:this.addItemCheck(a,[c],256|b.data[0],
e);break;case 9:b=b.data[1];255!==b&&this.addItemCheck(a,[c],256|b,e);break;case 25:this.addItemCheck(a,[c],this.rom.flags.AkahanaFluteOfLimeTradein.id,e);break;case 26:this.addItemCheck(a,[c],this.rom.flags.Rage.id,e)}}processLocationItemUses(a){for(const [b,c]of this.itemUses.get(~a.id))this.processItemUse([this.entrance(a)],H.OPEN,b,c)}handleMovingGuard(a,b,c){if(!this.flagset.assumeStatueGlitch()){var d=[];for(const a of b.spawns.slice(0,2))if(a.isNpc()&&this.rom.npcs[a.id].isParalyzable()){d.push([this.rom.flags.Paralysis.c]);
break}this.flagset.assumeTriggerGlitch()&&d.push([this.rom.flags.TriggerSkip.c]);this.addTerrain(a,this.terrainFactory.statue([...c,...d].map(ia)))}}handleBoat(a,b,c){const d=this.walkableNeighbor(a);if(null==d)throw Error("Could not find walkable neighbor.");var e=a>>8&240|a>>4&15;a=a>>4&240|a&15;var f;for(const c of b.exits)c.yt===e&&c.xt<a&&(f=c);if(!f)throw Error("Could not find boat exit");b=this.rom.locations[f.dest];if(!b)throw Error("Bad destination");for(e=f=of.from(b,b.entrances[f.entrance]);;)if(e=
of.add(e,0,-1),b=this.walkableNeighbor(e),null!=b){c={enter:H.freeze(c),exit:[[15,H.OPEN]]};this.addTerrain([d],c);this.exits.set(d,b);this.exitSet.add(If.of(d,b));this.exits.set(f,b);this.exitSet.add(If.of(f,b));this.terrains.set(f,this.terrainFactory.tile(0));break}}addItemGrantChecks(a,b,c){const d=this.itemGrant(c),e=256|d;if(null==d)throw Error(`missing item grant for ${c.toString(16)}`);this.addItemCheck(a,b,e,{lossy:!0,unique:!0,preventLoss:128<=c})}addTerrain(a,b){for(const c of a)a=this.terrains.get(c),
null!=a&&this.terrains.set(c,this.terrainFactory.meet(a,b))}addCheck(a,b,c){if(!H.isClosed(b)){b={requirement:H.freeze(b),checks:c};for(const c of a)this.terrains.has(c)&&this.checks.get(c).add(b)}}addItemCheck(a,b,c,d){this.addCheck(a,b,[c]);this.slots.set(c,d);a=this.rom.itemGets[this.rom.slots[c&255]];b=this.rom.items[a.itemId];c=null===b||void 0===b?void 0:b.unique;d=a.isLosable();const e=c||b===this.rom.items.OpelStatue;let f=1;b===this.rom.items.SwordOfWind&&(f=5);b===this.rom.items.SwordOfFire&&
(f=5);b===this.rom.items.SwordOfWater&&(f=10);b===this.rom.items.SwordOfThunder&&(f=15);b===this.rom.items.Flight&&(f=15);this.items.set(512|a.id,{unique:c,losable:d,preventLoss:e,weight:f})}addCheckFromFlags(a,b,c){const d=[];for(const a of c)c=this.flag(a),(null===c||void 0===c?0:c.logic.track)&&d.push(c.id);d.length&&this.addCheck(a,b,d)}walkableNeighbor(a){if(this.isWalkable(a))return a;for(let b of[-1,1]){const c=of.add(a,b,0),d=of.add(a,0,b);if(this.isWalkable(c))return c;if(this.isWalkable(d))return d}}isWalkable(a){return!(this.getEffects(a)&
Df.BITS)}ensurePassable(a){var b;return this.isWalkable(a)?a:null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}getEffects(a){const b=this.rom.locations[a>>>16];return this.rom.tileEffects[b.tileEffects-179].effects[this.rom.screens[b.screens[(a&61440)>>>12][(a&3840)>>>8]].tiles[a&255]]}processBoss(a,b){if(201!==b.id&&202!==b.id){var c=195===b.id,d=c?this.rom.bosses.Rage:this.rom.bosses.fromLocation(a.id);b=of.from(a,b);if(!d||!d.flag)throw Error(`Bad boss at ${a.name}`);var e=b&-256;a=this.terrainFactory.boss(d.flag.id,
c);c=w(240,a=>e|a);this.addTerrain(c,a);this.addBossCheck(c,d)}}addBossCheck(a,b,c=H.OPEN){if(null==b.flag)throw Error(`Expected a flag: ${b}`);c=H.meet(c,this.bossRequirements(b));b===this.rom.bosses.Draygon2?this.addCheck(a,c,[b.flag.id]):this.addItemCheck(a,c,b.flag.id,{lossy:!1,unique:!0})}processChest(a,b){if(!(112<=this.rom.slots[b.id])){var c=256|b.id,d=this.rom.slots[b.id];112<=d||(d=this.rom.items[d],d=this.flagset.preserveUniqueChecks()?!(null===d||void 0===d||!d.unique):!0,this.addItemCheck([of.from(a,
b)],H.OPEN,c,{lossy:!1,unique:d}))}}processMonster(a,b){const c=this.rom.objects[b.monsterId];if(c instanceof J){var {Money:d,RageSkip:e,Sword:f,SwordOfWind:g,SwordOfFire:h,SwordOfWater:k,SwordOfThunder:l}=this.rom.flags;a.id===this.limeTreeEntranceLocation&&c.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(a)],H.OPEN,[e.id]);c.goldDrop&&(a=[of.from(a,b)],this.flagset.guaranteeMatchingSword()?(b=[g,h,k,l].filter((a,b)=>c.elements&1<<b),this.addCheck(a,oh(...b),[d.id])):this.addCheck(a,
f.r,[d.id]))}}processItemUse(a,b,c,d){a=new Set([...a].map(a=>{var b;return null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}));const e=[[512|c.id]];c.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&e[0].push(this.rom.flags.Change.c);c===this.rom.items.MedicalHerb&&(e[0][0]=this.rom.flags.BuyHealing.c);b=H.meet(b,e);this.addCheckFromFlags(a,b,d.flags);switch(d.message.action){case 16:this.processKeyUse(a,b);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(a,
b,c.id);break;case 2:this.addItemCheck(a,b,256|this.rom.npcs[d.want&255].data[1],{lossy:!0,unique:!0})}}processKeyUse(a,b){const [c,...d]=new Set([...a].map(a=>tf.from(a)));if(null==c||d.length)throw Error("Expected one screen");const e=this.rom.locations[c>>>8].flags.find(a=>a.screen===(c&255));if(null==e)throw Error("Expected flag on screen");this.addCheck(a,b,[e.flag])}bossRequirements(a){if(a===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];
var b=a.object;const c=new H.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())c.addAll(this.rom.flags.Sword.r);else{var d=this.flagset.guaranteeSwordMagic()?a.swordLevel:1;b=this.rom.objects[b];for(let a=0;4>a;a++)b.isVulnerable(a)&&c.addAll(this.swordRequirement(a,d))}d=[];null!=a.npc&&null!=a.location&&(b=a.npc.spawns(this.rom.locations[a.location]),d.push(...this.filterRequirements(b)[0]));a===this.rom.bosses.Insect?d.push(this.rom.flags.InsectFlute.c,
this.rom.flags.GasMask.c):a===this.rom.bosses.Draygon2&&d.push(this.rom.flags.BowOfTruth.c);this.flagset.guaranteeRefresh()&&d.push(this.rom.flags.Refresh.c);c.restrict([d]);return H.freeze(c)}swordRequirement(a,b){const c=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][a];if(1===b)return c.r;a=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,
this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][a];return 3===b?nh(c,...a):a.map(a=>[c.c,a.c])}itemGrant(a){for(const [b,c]of this.rom.itemGets.actionGrants)if(b===a)return c;throw Error(`Could not find item grant ${a.toString(16)}`);}filterRequirements(a){var b;const c=[];for(const d of a)if(0>d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeTrue)return H.CLOSED}else{a=this.flag(d);if(null===a||void 0===a?0:a.logic.assumeFalse)return H.CLOSED;
(null===a||void 0===a?0:a.logic.track)&&c.push(a.id)}return[c]}filterAntiRequirements(a){var b;const c=[];for(const d of a)if(0<=d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeFalse)return H.OPEN}else{a=this.flag(~d);if(null===a||void 0===a?0:a.logic.assumeTrue)return H.OPEN;(null===a||void 0===a?0:a.logic.track)&&c.push([a.id])}return c}flag(a){var b;a=this.rom.flags[a];return null!==(b=this.aliases.get(a))&&void 0!==b?b:a}entrance(a,b=0){"number"===typeof a&&
(a=this.rom.locations[a]);return this.tiles.find(of.from(a,a.entrances[b]))}wallCapability(a){switch(a){case Jf.WIND:return this.rom.flags.BreakStone.id;case Jf.FIRE:return this.rom.flags.BreakIce.id;case Jf.WATER:return this.rom.flags.FormBridge.id;case Jf.THUNDER:return this.rom.flags.BreakIron.id;default:throw Error(`bad wall type: ${a}`);}}}function nh(...a){return[a.map(a=>a.id)]}function oh(...a){return a.map(a=>[a.id])};class ph{constructor(a,b){this.height=a;this.width=b;this._coords=void 0;this.data=Array((a<<1|1)*(b<<1|1));this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;const a=[];for(let b=0;b<this.height;b++)for(let c=0;c<this.width;c++)a.push(b<<12|c<<4);return this._coords=a}index(a){return((a&248)>>3)+this.row*(a>>>11)}index2(a,b){return(this.row<<1)*a+2*b}yx(a){const b=a%this.row;return[(a-b)/this.row/2,b/2]}coord(a){const b=a%this.row;return(a-b)/this.row<<11|b<<3}get(a){return this.data[this.index(a)]}set(a,
b){this.data[this.index(a)]=b}get2(a,b){return this.data[this.index2(a,b)]}set2(a,b,c){this.data[this.index2(a,b)]=c}plus(a,b,c){return a+(this.row<<1)*b+2*c}x(a){return a%this.row/2}y(a){return Math.floor(a/this.row)/2}border(a,b){let c;a&1?(c=b<<12|2048,a=a&2?this.width<<4:0):(c=a&2?this.height<<12:0,a=b<<4|8);return c|a}randomBorder(a,b){if(null!=b)if(b&1){var c=a.nextInt(this.height)<<12|2048;b=b&2?this.width<<4:0}else c=b&2?this.height<<12:0,b=a.nextInt(this.width)<<4|8;else c=this.width+this.height,
c=a.nextInt(c<<1)-c,a=!1,0>c&&(c=~c,a=!0),c<this.width?(b=c<<4|8,c=a?this.height<<12:0):(c=c-this.width<<12|2048,b=a?this.width<<4:0);return c|b}oppositeBorder(a){return a&8?a^this.height<<12:a^this.width<<4}furthestBorder(a){return(this.height<<12|this.width<<4)-a}edgeCoordination(a,b){let c=0;if(2056!==(a&2056))throw Error(`Bad tile: ${x(a)}`);for(const d of[8,-8,2048,-2048]){const e=this.get(a+d);(b?e===b:e)&&c++}return c}isBorder(a){if(a&8){if(a&2048)return!1;a>>>=12;return!a||a===this.height}return a&
2048?(a=a>>>4&15,!a||a===this.width):!1}partition(a){var b,c,d;const e=new Fg;for(let g=0;g<this.data.length;g+=this.row)for(let h=0;h<this.row;h++){const k=g+h,l=this.coord(k);if(null!==(b=null===a||void 0===a?void 0:a.get(l))&&void 0!==b?b:this.data[k]){e.find(l);var f=l-2048;g&&(null!==(c=null===a||void 0===a?void 0:a.get(f))&&void 0!==c?c:this.data[k-this.row])&&e.union([l,f]);f=l-8;h&&(null!==(d=null===a||void 0===a?void 0:a.get(f))&&void 0!==d?d:this.data[k-1])&&e.union([l,f])}}return e.map()}show(){const a=
[];for(let b=0;b<this.data.length;b+=this.row){let c="";for(let a=0;a<this.row;a++)c+=this.data[b+a]||" ";a.push(c)}return a.join("\n")}static writeGrid2d(a,b,c){b=a.index(b);for(let d=0;d<c.length;d++){const e=c[d];for(let c=0;c<e.length;c++){const f=e[c];a.data[b+d*a.row+c]=" "!==f?f:""}}}}function qh(a,b=1){return a-8*b}function rh(a,b=1){return a+8*b}function sh(a,b=1){return a-2048*b}function th(a,b=1){return a+2048*b};class uh extends we{constructor(){super(...arguments);this.x=this.prop([0],[1,255,-8]);this.y=this.prop([2],[3,255,-8]);this.screen=this.prop([3,15,-4],[1,15]);this.tile=this.prop([2,240],[0,240,4]);this.coord=this.prop([2,255,-8],[0,255])}get used(){return 8>this.data[1]}toString(){return`Entrance ${this.hex()}: (${x(this.y)}, ${x(this.x)})`}}uh.size=4;
class vh extends we{constructor(){super(...arguments);this.x=this.prop([0,255,-4]);this.xt=this.prop([0]);this.y=this.prop([1,255,-4]);this.yt=this.prop([1]);this.screen=this.prop([1,240],[0,240,4]);this.tile=this.prop([1,15,-4],[0,15]);this.coord=this.prop([1,15,-12],[0,15,-4]);this.dest=this.prop([2]);this.entrance=this.prop([3])}isSeamless(){return!!(this.entrance&32)}toString(){return`Exit ${this.hex()}: (${x(this.y)}, ${x(this.x)}) => ${this.dest}:${this.entrance}`}}vh.size=4;
class wh extends we{constructor(){super(...arguments);this.x=this.prop([1,7,-8]);this.xs=this.prop([1,7]);this.y=this.prop([1,240,-4]);this.ys=this.prop([1,240,4]);this.screen=this.prop([1])}get flag(){return this.data[0]|512}set flag(a){if(512!==(a&-256))throw Error(`bad flag: ${x(a)}`);this.data[0]=a&255}toString(){return`Flag ${this.hex()}: ${x(this.screen)} @ ${x(this.flag)}`}}wh.size=2;
class xh extends we{constructor(){super(...arguments);this.fromXs=this.prop([1,112,4]);this.toXs=this.prop([1,7]);this.fromYs=this.prop([3,240,4]);this.toYs=this.prop([3,15]);this.fromScreen=this.prop([3,240],[1,112,4]);this.toScreen=this.prop([3,15,-4],[1,7]);this.dest=this.prop([0])}toString(){return`Pit ${this.hex()}: (${x(this.fromXs)}, ${x(this.fromYs)}) => ${x(this.dest)}:(${x(this.toXs)}, ${x(this.toYs)})`}}xh.size=4;
class yh extends we{constructor(){super(...arguments);this.y=this.prop([0,255,-4]);this.yt=this.prop([0]);this.x=this.prop([1,127,-4],[2,64,3]);this.xt=this.prop([1,127]);this.timed=this.booleanProp(1,7);this.screen=this.prop([0,240],[1,112,4]);this.tile=this.prop([0,15,-4],[1,15]);this.coord=this.prop([0,15,-12],[1,15,-4],[2,64,3]);this.type=this.prop([2,7]);this.id=this.prop([3]);this.patternBank=this.prop([2,128,7])}get used(){return 254!==this.data[0]}set used(a){this.data[0]=a?0:254}[Symbol.iterator](){return this.used?
super[Symbol.iterator]():[254,0,0,0][Symbol.iterator]()}get monsterId(){return this.id+80&255}set monsterId(a){this.id=a-80&255}isChest(){return 2===this.type&&128>this.id}isInvisible(){return this.isChest()&&!!(this.data[2]&32)}isTrigger(){return 2===this.type&&128<=this.id}isNpc(){return 1===this.type&&192>this.id}isBoss(){return 1===this.type&&192<=this.id}isMonster(){return 0===this.type}isGeneric(){return 4===this.type}isWall(){return!(3!==this.type||!(4>this.id||this.data[2]&32))}isShootingWall(a){return this.isWall()&&
!!(this.data[2]&32?this.data[2]&16:143===a.id||168===a.id)}wallType(){if(3!==this.type)return"";const a=this.data[2]&32?this.id>>>4:this.id;return 4<=a?"":2===a?"bridge":"wall"}wallElement(){return this.isWall()?this.id&3:-1}toString(){return`Spawn ${this.hex()}: (${x(this.x)}, ${x(this.y)}) ${this.timed?"timed":"fixed"} ${this.type}:${x(this.id)}`}}yh.size=4;function zh(a,b){return a-b-((a>>>4)-(b>>>4))}
function Ah(a,...b){for(const c of b){const d=c%15;b=(a>>4)+(c-d)/15;a=(a&15)+d;0>a?(b--,a=15+a):15<=a&&(b++,a-=15);a|=b<<4}return a};class Bh{constructor(a,b,c,d){this.id=a;this.tileset=b;this.customFlags=new Map;this.freeFlags=new Set;this._pos=void 0;this._exits=new ta;this._pits=new Map;this.rom=b.rom;this._height=c;this._width=d;this._screens=Array(c<<4).fill(b.empty)}static of(a,b){function c(a,b,c){for(const d of g.metascreens.getById(b,a.tileset))if(b=d.findEntranceType(c,1===a.height),null!=b)return b}var d,e,f;const {rom:g,width:h,height:k}=a;if(!b){const {fortress:c,labyrinth:d}=g.metatilesets;b=new Set;for(var l of g.metatilesets)a.tileset===
l.tileset.id&&b.add(l);b.delete(169===a.id?c:d);for(var n of new Set(ha.concat(...a.screens)))for(var q of b)if(q.getMetascreens(n).length||b.delete(q),!b.size)throw Error(`No tileset for ${x(n)} in ${a}`);if(1!==b.size)throw Error(`Non-unique tileset for ${a}: [${Array.from(b,a=>a.name).join(", ")}]`);b=[...b][0]}const v=a.reachableTiles(!0);l=new Set;for(var y of v.keys())l.add(y>>>8);for(var A of a.entrances)A.used&&l.add(A.screen);for(var z of a.exits)l.add(z.screen),z.isSeamless()&&(y=z.tile>>>
4,0===y?v.set(z.screen-16<<8|136,1):14===y&&v.set(z.screen<<8|136,1));z=Array(k<<4).fill(b.empty);for(let c=0;c<k;c++)for(let d=0;d<h;d++){y=c<<4|d;var R=b.getMetascreens(a.screens[c][d]);A=void 0;if(1===R.length)A=R[0];else if(R.length){n=a.flags.find(a=>a.screen===(c<<4|d));q=[];var G=[];for(var E of R)E.data.match?q.push(E):"always"===E.flag&&766===(null===n||void 0===n?void 0:n.flag)||!E.flag&&!E.data.wall&&!n?G.unshift(E):G.push(E);if(q.length){R=function(a,b){b=(d<<8)+b;a=(c<<8)+a;return v.has(a<<
4&61440|b&3840|a&240|b>>4&15)};for(var L of q)if(L.data.match(R,null!=n)){A=L;break}}A||(A=G[0])}else throw Error("impossible");if(!A)throw Error("impossible");z[y]=A}E=new ta;let fa;for(const b of a.exits){if(255===b.dest)continue;L=b.screen;A=b.tile;!b.isSeamless()||b.yt&15||88===(a.id&88)||(L-=16,A|=240);if(!l.has(L))throw Error("impossible?");y=z[L];q=y.findExitType(A,1===k,!!(b.entrance&32));A=null===q||void 0===q?void 0:q.type;if(!A){if(Ch.has(a.id<<16|L<<8|b.tile))continue;A=null===(d=y.data.exits)||
void 0===d?void 0:d.map(a=>a.type+": "+a.exits.map(x).join(", ")).join("\n  ");console.warn(`Unknown exit ${x(b.tile)}: ${y.name} in ${a} @ ${x(L)}:\n  ${A}`);continue}if(E.has(L,A))continue;n=g.locations[b.dest];if(A.startsWith("seamless")){y="seamless:down"===A;E.set(L,A,[n.id<<8|L+(0>q.exits[0]+(y?-16:16)?-16:0),y?"seamless:up":"seamless:down"]);continue}R=n.entrances[b.entrance&31];q=R.screen;G=R.coord;"door"===A&&0===(R.y&240)&&(q-=16,G+=65536);R=n.screens[q>>4][q&15];const f=c(n,R,G);if(f)E.set(L,
A,[n.id<<8|q,f]),a.entrances[0].screen===L&&(L=a.entrances[0].coord,y=y.findExitByType(A),1024>=Math.pow((y.entrance&255)-(L&255),2)+Math.pow((y.entrance>>>8)-(L>>>8),2)&&(fa=A));else{L=[];for(const a of g.metascreens.getById(R,n.tileset))for(const b of null!==(e=a.data.exits)&&void 0!==e?e:[])b.type.startsWith("seamless")||L.push(`  ${a.name} ${b.type}: ${x(b.entrance)}`);console.warn(`Bad entrance ${x(G)}: raw ${x(R)} in ${n} @ ${x(q)}\n${L.join("\n")}`)}}d=new Map;for(var ba of a.pits)d.set(ba.fromScreen,
ba.dest<<8|ba.toScreen);ba=new Bh(a.id,b,k,h);ba._screens=z;ba._exits=E;ba._entrance0=fa;ba._pits=d;for(const b of a.flags)a=ba._screens[b.screen],(null===(f=a.flag)||void 0===f?0:f.startsWith("custom"))?ba.customFlags.set(b.screen,g.flags[b.flag]):a.flag||ba.freeFlags.add(g.flags[b.flag]);return ba}getUid(a){return this._screens[a].uid}get(a){return this._screens[a]}get width(){return this._width}set width(a){this._width=a;this._pos=void 0}get height(){return this._height}set height(a){this._height>
a?this._screens.splice(a+2<<4,this._height-a<<4):this._height<a&&(this._screens.length=a+2<<4,this._screens.fill(this.tileset.empty,this.height+2<<4,this._screens.length));this._height=a;this._pos=void 0}allPos(){if(this._pos)return this._pos;const a=this._pos=[];for(let b=0;b<this._height;b++)for(let c=0;c<this._width;c++)a.push(b<<4|c);return a}set(a,b){this._screens[a]=null!==b&&void 0!==b?b:this.tileset.empty}inBounds(a){return(a&15)<this.width&&0<=a&&a>>>4<this.height}set2d(a,b){for(const c of b){b=
0;for(const d of c)d&&this.set(a+b,d),b++;a+=16}}validate(){for(var a of[0,1])for(var b=a?0:1;b<this.height;b++)for(var c=a;c<this.width;c++){var d=b<<4|c,e=this._screens[d],f=d-(a?1:16),g=this._screens[f];if(!e.isEmpty()&&!g.isEmpty()&&!e.checkNeighbor(g,a)){b=Error;a=[g.name,f,oj[a],e.name,d];d="bad neighbor %s (%02x) %s %s (%02x)".split(/%/g);e=0;f=d[0];for(g=1;g<d.length;g++){if(!d[g]){f+="%"+d[++g];continue}c=/([-+]*)([0\D]?)(\d*)([dxs])/.exec(d[g]);if(!c){f+=a[e++]+d[g];continue}var h=parseInt(c[3])||
0;const b=c[2]||" ",l=a[e++];let n="x"===c[4]?Number(l).toString(16):String(l);"s"!==c[4]&&/\+/.test(c[1])&&0<=Number(l)&&(n="+"+n);n.length<h&&(h=b.repeat(h-n.length),n=/-/.test(c[1])?n+h:h+n);f+=n+d[g].substring(c[0].length)}a=f;throw b(a);}}return!0}spliceColumns(a,b,c,d){for(var e=0;e<this._screens.length;e+=16)this._screens.copyWithin(e+a+c,e+a+b,e+10),this._screens.splice(e+a,c,...d[e>>4]);c-=b;this.width+=c;this._pos=void 0;d=[];for(var f of this._exits){const [g,h]=f;e=g&15;e<a+b?e>=a&&this._exits.delete(g,
h):d.push([g,h,g+c,h])}this.moveExits(...d);f=this.rom.locations[this.id];d=a+b<<4;for(const a of f.spawns)a.xt<d||(a.xt-=c<<4);for(const d of f.flags)d.xs<a+b?d.xs>=a&&(d.screen=255):d.xs-=c;f.flags=f.flags.filter(a=>255!==a.screen)}setExit(a,b,c){const d=this.rom.locations[c[0]>>>8].meta;if(!d)throw Error("Cannot set two-way exit without meta");this.setExitOneWay(a,b,c);d.setExitOneWay(c[0]&255,c[1],[this.id<<8|a,b])}setExitOneWay(a,b,c){this._exits.set(a,b,c)}deleteExit(a,b){this._exits.delete(a,
b)}getExit(a,b){return this._exits.get(a,b)}exits(){return this._exits}exitCandidates(a){var b;const c=[];for(const d of this.tileset)(null===(b=d.data.exits)||void 0===b?0:b.some(b=>b.type===a))&&c.push(d);return c}show(){var a,b;const c=[];let d=[];for(var e=0;e<this.width;e++)d.push(e.toString(16));c.push("   "+d.join("  "));for(e=0;e<this.height;e++)for(let f=0;3>f;f++){d=[1===f?e.toString(16):" "," "];for(let c=0;c<this.width;c++){const g=this._screens[e<<4|c];d.push(null!==(b=null===(a=null===
g||void 0===g?void 0:g.data.icon)||void 0===a?void 0:a.full[f])&&void 0!==b?b:1===f?" ? ":"   ")}c.push(d.join(""))}return c.join("\n")}screenNames(){const a=[];for(let b=0;b<this.height;b++){let c=[];for(let a=0;a<this.width;a++){const d=this._screens[b<<4|a];c.push(null===d||void 0===d?void 0:d.name)}a.push(c.join(" "))}return a.join("\n")}traverse(a){a=void 0===a?{}:a;var b,c,d=new Fg;const e=(a.flight?2:0)|(a.noFlagged?1:0);for(const f of this.allPos()){const g=null!==(c=null===(b=a.with)||void 0===
b?void 0:b.get(f))&&void 0!==c?c:this._screens[f];for(const a of g.connections[e])a.length&&d.union(a.map(a=>(f<<8)+a))}a=new Map;d=d.sets();for(b=0;b<d.length;b++){c=d[b];for(const b of c)a.set(b,c)}return a}exitType(a){var b;if(224===(a&240)){var c=a>>>8;a=null===(b=this.get(c).data.exits)||void 0===b?void 0:b[a&15].type;if(null===a||void 0===a||!a.startsWith("edge:")||!("edge:top"===a&&c>>>4||"edge:bottom"===a&&c>>>4===this.height-1||"edge:left"===a&&c&15||"edge:bottom"===a&&(c&15)===this.width-
1))return a}}poiTile(){throw Error("not implemented");}static connect(a,b,c){a.locations[b[0]>>>8].meta.attach(b[0]&255,a.locations[c[0]>>>8].meta,c[0]&255,b[1],c[1])}static findExitTiles(a,b){return a.locations[b[0]>>>8].meta._screens[b[0]&255].findExitByType(b[1]).exits.map(a=>a|(b[0]&255)<<8)}attach(a,b,c,d,e){d||(d=this.pickTypeFromExits(a));e||(e=b.pickTypeFromExits(c));const f=b.id<<8|c,g=this.id<<8|a,h=this._exits.get(a,d),k=b._exits.get(c,e);if(h&&k){const [a,b]=h,[c,v]=k;if(a===f&&b===e&&
c===g&&v===d)return}this._exits.set(a,d,[f,e]);b._exits.set(c,e,[g,d]);if(k&&h){const [b,c]=h,[d,e]=k;a=this.rom.locations[b>>8].meta;this.rom.locations[d>>8].meta._exits.set(d&255,e,h);a._exits.set(b&255,c,k)}else if(k||h){const [a,b]=k||h;a===g&&b===d||a===f&&b===e||this.rom.locations[a>>8].meta._exits.delete(a&255,b)}}pickTypeFromExits(a){const b=[...this._exits.row(a).keys()];if(!b.length)return this.pickTypeFromScreens(a);if(1<b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);
return b[0]}moveExits(...a){const b=[];for(const c of a){const [d,e,f,g]=c;{a=this._exits.get(d,e);const [c,k]=a;this.rom.locations[c>>8].meta._exits.set(c&255,k,[this.id<<8|f,g]);b.push([f,g,a]);this._exits.delete(d,e)}}for(const a of b){const [b,c,f]=a;this._exits.set(b,c,f)}}moveExit(a,b,c,d){c||(c=this.pickTypeFromExits(a));d||(d=this.pickTypeFromScreens(b));const e=this._exits.get(a,c),[f,g]=e;this.rom.locations[f>>8].meta._exits.set(f&255,g,[this.id<<8|b,d]);this._exits.set(b,d,e);this._exits.delete(a,
c)}moveExitsAndPitsTo(a){const b=new Set;for(const c of a.allPos())a.get(c).data.delete||b.add(c);for(const c of this._exits){const [d,e,[f,g]]=c;b.has(d)&&(this.rom.locations[f>>>8].meta._exits.set(f&255,g,[a.id<<8|d,e]),a._exits.set(d,e,[f,g]),this._exits.delete(d,e))}for(const c of this._pits){const [d,e]=c;b.has(d)&&(a._pits.set(d,e),this._pits.delete(d))}}pickTypeFromScreens(a){var b=this._screens[a].data.exits;b=(null!==b&&void 0!==b?b:[]).map(a=>a.type);if(1!==b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);
return b[0]}transferFlags(a,b){var c;this.freeFlags=new Set(a.freeFlags);const d=new da(()=>[]);for(const b of a.customFlags){const [c,e]=b;d.get(a._screens[c]).push(e)}for(const a of d.values())b.shuffle(a);for(const e of this.allPos())if(a=this._screens[e],null===(c=a.flag)||void 0===c?0:c.startsWith("custom")){b=d.get(a).pop();if(!b)throw Error(`No flag for ${a.name} at ${this.rom.locations[this.id]} @${x(e)}`);this.customFlags.set(e,b)}}transferPits(a){this._pits=a._pits}shufflePits(){var a;if(this._pits.size){var b=
new Set;for(var c of this._pits){var [,d]=c;b.add(this.rom.locations[d>>>8].id)}this._pits.clear();c=new da(()=>[]);for(var e of this.allPos())if(this.get(e).hasFeature("pit")){var f=[-1,this,Infinity];for(var g of this._exits){const [a,,[c]]=g;d=pj(e,a);b.has(c>>>8)&&d<f[2]&&(f=this.rom.locations[c>>>8].meta,f=[qj(e,c&255,a,f),f,d])}0<=f[0]&&c.get(f[1]).push([e,f[0]])}for(var h of b)b=c.get(this.rom.locations[h].meta),b.length||b.push([0,240]);for(const f of c){const [k,n]=f;h=[[],[]];b=new Map;
for(const a of k.allPos())e=k.get(a),e.hasFeature("river")||e.hasFeature("empty")||(g=(e.data.edges||"").split("").map(a=>" "===a?"":a),g[0]&&g[2]&&h[0].push(a),(g[1]&&g[3]||e.hasFeature("spikes"))&&h[1].push(a),e.hasFeature("spikes")&&b.set(a,[...g].filter(a=>"s"===a).length));g=[0,0];for(const f of n){const [l,n]=f;e=this.get(l).data.edges||"";c="c"===e[1]&&"c"===e[3]?1:0;e=[-1,Infinity,0];g=qj(n,g[0],g[1],k);for(const f of h[c])c=null!==(a=b.get(f))&&void 0!==a?a:0,c<e[2]||(d=pj(g,f),d<e[1]&&(e=
[f,d,c]));e=e[0];if(0>e)throw Error("no eligible dest");g=[e,g];this._pits.set(l,k.id<<8|e)}}}}transferExits(a,b){var c;const d=new da(()=>[]),e=new da(()=>new Set);for(var f of this.allPos()){var g=this._screens[f];for(var h of null!==(c=g.data.exits)&&void 0!==c?c:[])({type:g}=h),"edge:top"===g&&f>>>4||"edge:left"===g&&f&15||"edge:bottom"===g&&f>>>4<this.height-1||"edge:right"===g&&(f&15)<this.width-1||d.get(g).push(f)}for(var k of d.values())b.shuffle(k);for(const g of a._exits){const [l,q,v]=
g;if(!e.get(q).has(l)){f=d.get(q).pop();if(null==f)throw Error(`Could not transfer exit ${q} in ${this.rom.locations[this.id]}: no eligible screen\n${this.show()}`);h=this.rom.locations[v[0]>>>8].meta;b=v[0]&255;c=v[1];if(h===a){h=d.get(c).pop();if(null==h)throw Error("Impossible");this._exits.set(f,q,[this.id<<8|h,c]);this._exits.set(h,c,[this.id<<8|f,q]);e.get(c).add(b)}else{k=h._exits.get(b,c);if(!k)throw a=this.rom.locations[v[0]>>>8],console.log(h),Error(`No exit for ${a} at ${x(b)} ${c}\n${h.show()}\n${this.rom.locations[this.id]} at ${x(l)} ${q}\n${this.show()}`);
k[0]>>>8===this.id&&(k[0]&255)===l&&k[1]===q&&h._exits.set(b,c,[this.id<<8|f,q]);this._exits.set(f,q,v)}}}}transferSpawns(a,b){var c,d,e,f=new Map;const g=new Map,h=[],k=[],l=[],n=[];var q=[];for(var v of[this,a]){for(const a of v.allPos()){const b=v._screens[a],d=a&240,e=(a&15)<<4;if(b.hasFeature("pit")&&v===this)g.set(a,5===b.edgeIndex("c")?0:1);else if((null===(c=b.data.statues)||void 0===c?0:c.length)&&v===this)for(var y=0;y<b.data.statues.length;y++)h.push([a,b.data.statues[y]<<12|((a&15^a>>>
4^y)&1?80:160)]);if(v===this&&b.hasFeature("wall")){if(null==b.data.wall)throw Error("Missing wall prop");y=[d|b.data.wall>>4,e|b.data.wall&15];l.push(y);b.data.tilesets.lime&&l.push([y[0]-1,y[1]])}else if(v===this&&b.hasFeature("bridge")){if(null==b.data.wall)throw Error("Missing wall prop");n.push([d|b.data.wall>>4,e|b.data.wall&15])}if(b.hasFeature("arena"))if(v===this)q.push([d|8,e|8]);else{const [a,b]=q.pop();k.push([d|8,e|8,a,b,144,"arena"])}}v===this&&(b.shuffle(q),b.shuffle(h))}for(const b of[this,
a])for(const e of b._exits){const [g,h,l]=e;c=b._screens[g];a=null===(d=c.data.exits)||void 0===d?void 0:d.find(a=>a.type===h);if(!a)throw Error(`Invalid exit: ${c.name} ${h}`);c=g&15;q=g>>>4;v=a.exits[0]&15;a=a.exits[0]>>>4;if(b===this)f.set(l,[q<<4|a,c<<4|v]);else if(l[0]>>>8!==this.id){const [b,d]=f.get(l);k.push([q<<4|a,c<<4|v,b,d,25,"exit"])}}d=[[],[],[],[],[],[]];for(var A of this.allPos()){f=this._screens[A];for(var z of null!==(e=f.data.poi)&&void 0!==e?e:[]){const [a,b=112,c=120]=z;d[a].push([((A&
240)<<4)+b,((A&15)<<8)+c])}}for(const a of d)b.shuffle(a);e=[...ha.concat(...d)];A=this.rom.locations[this.id];for(const a of b.ishuffle(A.spawns)){if(a.isMonster()){b=rj.indexOf(a.monsterId);if(0<=b&&g.size){const [[c,d]]=g;g.delete(c);a.monsterId=rj[b&2|d];a.screen=c;a.tile=d?115:71}else if(143===a.monsterId&&h.length){const [b,c]=h.pop();a.screen=b;a.coord=c}continue}else if(a.isWall()){b=("bridge"===a.wallType()?n:l).pop();if(!b)throw Error(`Not enough ${a.wallType()} screens in new metalocation: ${A}\n${this.show()}`);
const [c,d]=b;a.yt=c;a.xt=d;continue}else if(a.isNpc()||a.isBoss()||a.isTrigger()||a.isGeneric()){b=[-1,-1,Infinity];for(const c of k){const [d,e,f,g,h,k]=c;"arena"!==k&&a.isBoss()||(z=Math.pow(zh(a.yt,d),2)+Math.pow(a.xt-e,2),z<=h&&z<b[2]&&(b=[Ah(a.yt,zh(f,d)),a.xt+g-e,z]))}if(Number.isFinite(b[2])){[a.yt,a.xt]=b;continue}}if(a.isTrigger()||a.isBoss())throw Error(`Could not place ${A} ${a.isBoss()?"Boss":"Trigger"} ${a.hex()}\n${this.show()}`);b=e.shift();if(!b)throw Error(`Ran out of POI for ${A}`);
const [c,d]=b;k.push([a.y>>>4,a.x>>>4,c>>>4,d>>>4,4,"???"]);a.y=c;a.x=d}}reconcileExits(a){const b=[],c=[];for(const d of[this,a])for(const e of d._exits){const [f,g,[h,k]]=e;{if(k.startsWith("seamless"))continue;const e=this.rom.locations[h>>>8].meta._exits.get(h&255,k);if(e){const [c,l]=e;if(c>>>8===d.id&&(c&255)===f&&l===g){b.push([d===this?a:this,f,g,[h,k]]);continue}}c.push([d,f,g])}}for(const a of c){const [b,c,d]=a;b._exits.delete(c,d)}for(const a of b){const [b,c,d,h]=a;b._exits.set(c,d,h)}}writeEntrance0(){if(this._entrance0)for(var a of this._exits){const [b,
c]=a;if(c===this._entrance0){a=this._screens[b].findExitByType(c);this.rom.locations[this.id].entrances[0]=uh.of({screen:b,coord:a.entrance});break}}}write(){var a,b,c,d,e,f,g,h,k,l,n,q;const v=this.rom.locations[this.id],y=new Set;for(var A of this._exits){const [c,d,[e,f]]=A;{var z=this._screens[c],R=e>>8,G=e&255;const g=this.rom.locations[R],h=g.meta._screens[e&255],k=null===(a=z.data.exits)||void 0===a?void 0:a.find(a=>a.type===d);var E=null===(b=h.data.exits)||void 0===b?void 0:b.find(a=>a.type===
f);if(!k||!E)throw Error(`Missing ${k?"dest":"source"} exit:
  From: ${v} @ ${x(c)}:${d} ${z.name}
  To:   ${g} @ ${x(G)}:${f} ${h.name}`);z=32;E.type.startsWith("seamless")?y.add(c):(E=E.entrance,61439<E&&(G+=16,E-=65536),z=g.findOrAddEntrance(G,E));for(let a of k.exits)G=c,240===(a&240)&&(G+=16,a&=15),v.exits.push(vh.of({screen:G,tile:a,dest:R,entrance:z}))}}v.width=this._width;v.height=this._height;v.screens=[];for(a=0;a<this._height;a++)for(b=[],v.screens.push(b),A=0;A<this._width;A++)b.push(this._screens[a<<4|A].sid);v.tileset=this.tileset.tilesetId;v.tileEffects=this.tileset.effects().id;
a=new Fg;for(const g of this.allPos())y.has(g)||(b=this._screens[g],A=g+16,R=g+1,y.has(A)||" "===(null!==(d=null===(c=b.data.edges)||void 0===c?void 0:c[2])&&void 0!==d?d:" ")||a.union([g,A]),y.has(R)||" "===(null!==(f=null===(e=b.data.edges)||void 0===e?void 0:e[3])&&void 0!==f?f:" ")||a.union([g,R]),a.union([g]));d=a.map();c=new Set;for(var L of this._exits){[e]=L;for(const a of null!==(g=d.get(e))&&void 0!==g?g:[])c.add(a)}v.flags=[];g=[...this.freeFlags];for(const a of this.allPos()){L=this._screens[a];
let b;null!=L.data.wall&&c.has(a)?b=null!==(k=null===(h=g.pop())||void 0===h?void 0:h.id)&&void 0!==k?k:this.rom.flags.alloc(512):"always"===L.flag?b=this.rom.flags.AlwaysTrue.id:"calm"===L.flag?b=this.rom.flags.CalmedAngrySea.id:"custom:false"===L.flag?b=null===(l=this.customFlags.get(a))||void 0===l?void 0:l.id:"custom:true"===L.flag&&(b=null!==(q=null===(n=this.customFlags.get(a))||void 0===n?void 0:n.id)&&void 0!==q?q:this.rom.flags.AlwaysTrue.id);null!=b&&v.flags.push(wh.of({screen:a,flag:b}))}v.pits=
[];for(const a of this._pits){const [b,c]=a;v.pits.push(xh.of({fromScreen:b,toScreen:c&255,dest:c>>>8}))}}replaceMonsters(a){if(104!==this.id){var b=this.rom.locations[this.id];a=b.monsterPlacer(a);for(const c of b.spawns){if(!c.used)continue;if(!c.isMonster())continue;const d=b.rom.objects[c.monsterId];if(!(d instanceof J))continue;const e=a(d);null==e?(console.error(`no valid location for ${x(d.id)} ${d.name} in ${b}`),c.used=!1):d.isBird()?(c.y=4048,c.x=2032,c.timed=!0):(c.screen=e>>>8,c.tile=
e&255)}}}}const Ch=new Set([65594,65595,1392800,1716320,4202496,4202544,4292816,6326207,10552102,10552105,11077158,11077161]),oj=["above","left of","below","right of"];function pj(a,b){return Math.pow((a>>>4)-(b>>>4),2)+Math.pow((a&15)-(b&15),2)}function qj(a,b,c,d){return Math.max(0,Math.min(d.height-1,(a>>>4)+(b>>>4)-(c>>>4)))<<4|Math.max(0,Math.min(d.width-1,(a&15)+(b&15)-(c&15)))}const rj=[126,127,159,141];const K={ok:!0,value:void 0};class sj{constructor(a,b){this.rom=a;this.random=b;this.shuffles=[]}add(...a){this.shuffles.push(...a)}shuffleAll(){for(const a of this.shuffles)a.shuffle(this.random);for(const a of this.shuffles)a.meta&&a.finish();for(const a of this.rom.locations)a.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((a,b)=>(a.badness||0)-(b.badness||0)).join("\n")}}
class tj{constructor(a,b){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new ph(1,1);this.fixed=new Set;this.count=this.size=this.h=this.w=0;this.exitMap=[];this.loc=a;this.orig=a.meta;this.params=null!==b&&void 0!==b?b:this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;const a=this.pickHeight(),b=this.pickWidth(),c=this.pickSize(),d=new ph(a,
b);d.data.fill("");Object.assign(this,{h:a,w:b,size:c,grid:d,fixed:new Set,count:0,exitMap:[]})}shuffle(a){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:a});++this.attempt<=this.maxAttempts;){this.reset();a=this.build();if(a.ok)return;console.log(`Shuffle failed ${this.loc}: ${a.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){this.meta&&this.meta!==this.loc.meta&&this.finishInternal()}finishInternal(){if(!this.meta)throw Error("impossible");
this.meta.transferFlags(this.loc.meta,this.random);const a=[];for(const [b,c,d]of this.exitMap)for(const [e,f,g]of a)if(b(e,f)){a.push([c,d,g]);break}this.meta.transferExits(this.loc.meta,this.random);for(const [b,c,d]of a)this.meta.attach(b,this.meta.rom.locations[d[0]>>>8].meta,d[0]&255,c,d[1]);this.meta.transferSpawns(this.loc.meta,this.random);this.meta.transferPits(this.loc.meta);this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-
1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(2>this.random.nextInt(5)?1:0)}insertTile(a,b){a=this.posToGrid(a);for(var c=0;3>c;c++)for(var d=0;3>d;d++){var e=a+2048*c+8*d;if(this.fixed.has(e)||(e=this.grid.get(e))&&e!==b[3*c+d])return!1}for(c=0;3>c;c++)for(d=0;3>d;d++)this.grid.set(a+2048*c+8*d,b[3*c+d]);return!0}posToGrid(a,b=0){return(a>>>4<<12|(a&15)<<4)+b}insertPattern(a,{top:b=0,bottom:c=0,left:d=
0,right:e=0}={}){const f=a.length-1>>>1;var g=a[0].length-1>>>1;c=b+c;if(this.h<f+c)return{ok:!1,fail:"too short"};if(this.w<g+(d+e))return{ok:!1,fail:"too narrow"};b=this.random.nextInt(this.h-f-1-c)+b;d=this.random.nextInt(this.w-g-1-c)+d;d=b+1<<12|d+1<<4;ph.writeGrid2d(this.grid,d,a);for(a=12288;20480>=a;a+=2048)for(g=48;64>=g;g+=8)this.fixed.add(d+(a|g));return{ok:!0,value:void 0}}extract(a,b,{h:c=3,w:d=3,replace:e}={}){var f=a.index(b);b="";c=f+c*a.row;const {row:g}=a;for(;f<c;f+=g)for(let c=
f;c<f+d;c++){if(e){const d=e.get(a.coord(c));if(null!=d){b+=d||" ";continue}}b+=a.data[c]||" "}return b}canSet(a,b){return this.canSetAll(new Map([[a,b]]))}canSetAll(a){var b=new Set;for(const c of a.keys()){if(this.fixed.has(c))return!1;const a=c&-2057,e=a>>>12,f=a>>>4&15;f<this.w&&e<this.h&&b.add(a);!(c&8)&&e<this.h&&f&&b.add(a-16);!(c&2048)&&f<this.w&&e&&b.add(a-4096);c&2056||!f||!e||b.add(a-4112)}for(const c of b)if(b=this.extract(this.grid,c,{replace:a}),!this.orig.tileset.getMetascreensFromTileString(b).length)return!1;
return!0}addAllFixed(){for(let a=0;a<this.grid.data.length;a++)this.grid.data[a]&&this.fixed.add(this.grid.coord(a))}};class M extends tj{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.upEdgeType=this.initialFillType="c";this._requirePitDestination=!1;this.bridges=this.walls=this.wides=this.rivers=0}reset(){super.reset();this.bridges=this.walls=this.wides=this.rivers=0}requirePitDestination(){this._requirePitDestination=!0;return this}survey(a){var b,c;const d={meta:a,id:a.id,tileset:a.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],
features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(0<=a.id)for(var e of a.rom.locations[a.id].spawns)e.isMonster()&&143===e.monsterId&&d.features.statue++;for(const f of a.allPos()){e=a.get(f);(!e.isEmpty()||(null===(b=e.data.exits)||void 0===b?0:b.length))&&d.size++;for(const b of null!==(c=e.data.exits)&&void 0!==c?c:[]){const {type:c}=b;if("edge:top"===c)0===f>>>4&&d.edges[0]++;else if("edge:left"===c)0===(f&15)&&d.edges[1]++;else if("edge:bottom"===
c)f>>>4===a.height-1&&d.edges[2]++;else if("edge:right"===c)(f&15)===a.width-1&&d.edges[3]++;else if("crypt"!==c&&!c.startsWith("seamless")){if(b.dir&1)throw Error(`Bad exit direction: ${b.dir}`);d.stairs[b.dir>>>1]++}}e.hasFeature("arena")&&d.features.arena++;e.hasFeature("bridge")&&d.features.bridge++;e.hasFeature("overpass")&&d.features.over++;e.hasFeature("pit")&&d.features.pit++;e.hasFeature("ramp")&&d.features.ramp++;e.hasFeature("spikes")&&d.features.spike++;e.hasFeature("underpass")&&d.features.under++;
e.hasFeature("wall")&&d.features.wall++;e.hasFeature("river")&&d.features.river++;e.hasFeature("wide")&&d.features.wide++}2>d.size&&(1<a.width||1<a.height)&&(d.size=2);return d}build(){this.init();let a;if((a=this.fillGrid(),!a.ok)||(a=this.preinfer(),!a.ok))return a;const b=this.inferScreens();if(!b.ok)return b;if((a=this.refineMetascreens(b.value),!a.ok)||(a=this.checkMetascreens(b.value),!a.ok))return a;if(this._requirePitDestination&&!this.requireEligiblePitDestination(b.value))return{ok:!1,fail:"no eligible pit destination"};
this.meta=b.value;return K}fillGrid(){var a;let b;if(!((b=this.initialFill(),b.ok)&&(b=this.addEdges(),b.ok)&&(b=this.addEarlyFeatures(),b.ok)&&(b=this.refine(),b.ok)))return b;if(!this.refineEdges())return{ok:!1,fail:"refineEdges"};this.removeSpurs();this.removeTightLoops();return(b=this.addLateFeatures(),b.ok)&&(b=this.addStairs(...null!==(a=this.params.stairs)&&void 0!==a?a:[]),b.ok)?K:b}init(){}initialFill(){this.fillCave(this.initialFillType);return K}fillCave(a){for(let b=.5;b<this.h;b++)for(let c=
.5;c<this.w;c++)1<b&&this.grid.set2(b-.5,c,a),1<c&&this.grid.set2(b,c-.5,a),this.grid.set2(b,c,a);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return K;for(let a=0;4>a;a++){let b=this.params.edges[a]||0;if(!b)continue;const c=w(a&1?this.h:this.w,b=>this.grid.border(a,b));for(const d of this.random.ishuffle(c))if(!this.grid.get(d)&&(a&1?1===a?this.addLeftEdge(d)&&b--:this.addRightEdge(d)&&b--:0===a?this.addUpEdge(d)&&b--:this.addDownEdge(d)&&b--,!b))break;if(b)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}\nmissing ${b} ${a}`}}return K}addUpEdge(a){var b=
a+2048;const c=b-8,d=c-8-8;b+=8;const e=b+8+8;if(this.grid.isBorder(c)){if(this.grid.get(c))return!1}else if(this.grid.get(a-16)||this.grid.isBorder(d)&&this.grid.get(d))return!1;if(this.grid.isBorder(b)){if(this.grid.get(b))return!1}else if(this.grid.get(a+16)||this.grid.isBorder(e)&&this.grid.get(e))return!1;this.fixed.add(a);this.grid.set(a,this.upEdgeType);this.grid.set(c,"");this.grid.set(b,"");return!0}addDownEdge(a){const b=a-2048,c=b-8,d=b+8;if(!this.grid.get(b)||this.grid.isBorder(c)&&this.grid.get(c)||
this.grid.isBorder(d)&&this.grid.get(d))return!1;this.fixed.add(a);this.grid.set(a,"n");this.grid.set(c,"");this.grid.set(d,"");return!0}addLeftEdge(a){const b=a+8,c=b-2048,d=b+2048;if(!this.grid.get(b)||this.grid.isBorder(c)&&this.grid.get(c)||this.grid.isBorder(d)&&this.grid.get(d))return!1;this.fixed.add(a);this.grid.set(a,"c");return!0}addRightEdge(a){const b=a-8,c=b-2048,d=b+2048;if(!this.grid.get(b)||this.grid.isBorder(c)&&this.grid.get(c)||this.grid.isBorder(d)&&this.grid.get(d))return!1;this.fixed.add(a);
this.grid.set(a,"c");return!0}addEarlyFeatures(){var a,b,c,d;return this.addSpikes(null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.spike)&&void 0!==b?b:0)?this.addOverpasses(null!==(d=null===(c=this.params.features)||void 0===c?void 0:c.over)&&void 0!==d?d:0)?K:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes\n${this.grid.show()}`}}addLateFeatures(){var a,b,c,d,e,f,g,h;return this.addArenas(null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.arena)&&void 0!==b?b:0)?
this.addUnderpasses(null!==(d=null===(c=this.params.features)||void 0===c?void 0:c.under)&&void 0!==d?d:0)?this.addPits(null!==(f=null===(e=this.params.features)||void 0===e?void 0:e.pit)&&void 0!==f?f:0)?this.addRamps(null!==(h=null===(g=this.params.features)||void 0===g?void 0:g.ramp)&&void 0!==h?h:0)?K:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas\n${this.grid.show()}`}}addArenas(a){if(!a)return!0;const b=this.grid;for(const d of this.random.ishuffle(this.grid.screens())){const e=
d|2056;if(this.isEligibleArena(e)){var c=this.extract(this.grid,d);c=c.substring(0,4)+"a"+c.substring(5);if(this.orig.tileset.getMetascreensFromTileString(c).length){if(this.fixed.add(e),b.set(e,"a"),a--,!a)return!0}else console.log(`no tile ${c}`)}}return!1}isEligibleArena(a){const b=this.grid,c=a-8,d=c-8,e=a+8,f=e+8;return"c"!==b.get(a)&&"w"!==b.get(a)||b.get(c)||b.get(e)||!b.isBorder(c)&&b.get(d)||!b.isBorder(e)&&b.get(f)?!1:!0}addUnderpasses(a){return this.addStraightScreenLate(a,"b",2048)}addOverpasses(a){let b=
0;for(;a;){var c=this.random.nextInt(this.h-2)+1;const d=this.random.nextInt(this.w-2)+1;c=c<<12|d<<4|2056;if("c"!==this.grid.get(c)){if(10<++b)throw Error("Bad attempts");}else this.grid.set(c,"b"),this.fixed.add(c),this.grid.set(c-8,""),this.grid.set(c+8,""),a--}return!0}addPits(a){return this.addStraightScreenLate(a,"p")}addRamps(a){return this.addStraightScreenLate(a,"/",8)}addStraightScreenLate(a,b,c){if(!a)return!0;for(const e of this.random.ishuffle(this.grid.screens())){const f=e|2056;if("c"===
this.grid.get(f)){if(c){var d=f+c;if(this.grid.get(f-c)||this.grid.get(d))continue}d=this.extract(this.grid,e);d=d.substring(0,4)+b+d.substring(5);if(this.orig.tileset.getMetascreensFromTileString(d).length&&(this.fixed.add(f),this.grid.set(f,b),a--,!a))return!0}}return!1}addSpikes(a){if(!a)return!0;for(var b=0;0<a;){if(20<++b)return!1;let e=Math.min(a,Math.floor(.6*this.h),this.maxSpikes);for(;e<a-1&&e>this.minSpikes;).2>this.random.next()&&e--;var c=2<e&&3<this.w?this.random.nextInt(this.w-2)+1:
this.random.nextInt(this.w);e>a-this.minSpikes&&(e=e>=this.h-2?this.h-2:a);const f=this.random.nextInt(this.h-e-2)+1<<12|c<<4|2056;c=f+(e-1<<12);for(var d=f-4096;e&&d<=c+4096;d+=2048)"c"!==this.grid.get(d)&&(e=0);if(e&&(d=this.tryClear([f-8,f+8,c-8,c+8]),d.length)){for(const a of d)this.grid.set(a,"");this.fixed.add(f-2048);this.fixed.add(f-4096);this.fixed.add(c+2048);this.fixed.add(c+4096);for(b=f;b<=c;b+=2048)this.fixed.add(b),this.grid.set(b,"s");a-=e;b=0}}return 0===a}canRemove(a){return a===
this.initialFillType}tryClear(a){var b=new Map;for(var c of a){if(this.fixed.has(c))return[];b.set(c,"")}b=this.grid.partition(b);[c]=b.values();if(c.size===b.size)return[...a];c=new Set;const d=new Set(b.values());for(const a of this.fixed)c.add(b.get(a));if(c.size>this.maxPartitions)return[];a=[...a];for(const b of d)c.has(b)||a.push(...b);return a}refine(){let a=new Set;for(var b=0;b<this.grid.data.length;b++)this.grid.data[b]&&a.add(this.grid.coord(b));for(b=0;this.count>this.size;){if(50<b++)throw Error("refine failed: attempts");
let d=0;for(const b of this.random.ishuffle([...a])){if(this.grid.isBorder(b)||!this.canRemove(this.grid.get(b))||this.fixed.has(b))continue;if(3<d)break;const e=this.grid.partition(this.removalMap(b));var [c]=e.values();if(c.size===e.size&&1<e.size)d++,a.delete(b),2056===(b&2056)&&this.count--,this.grid.set(b,"");else{let f;for(const a of e.values())if(!f||a.size>f.size)f=a;if([...this.fixed].every(a=>f.has(a))&&(c=[...f].filter(a=>2056==(a&2056)).length,!(c<this.size))){d++;a=f;this.count=c;this.grid.set(b,
"");for(const [a,b]of e)b!==f&&this.grid.set(a,"")}}}if(!d){if(this.looseRefine)break;return{ok:!1,fail:`refine ${this.count} > ${this.size}\n${this.grid.show()}`}}}return K}removalMap(a){return new Map([[a,""]])}refineEdges(){var a=[];for(var b=0;b<this.grid.data.length;b++)if(this.grid.data[b]){var c=this.grid.coord(b);this.grid.isBorder(c)||this.fixed.has(c)||(c^c>>8)&8&&a.push(c)}this.random.shuffle(a);c=this.grid.partition(new Map);b=c.size;c=(new Set(c.values())).size;for(const d of a){a=this.grid.partition(new Map([[d,
""]]));const [e]=a.values();if(e.size===a.size?a.size===b-1:(new Set(a.values())).size===c&&a.size===b-1)b--,this.grid.set(d,"")}return!0}removeSpurs(){for(let b=0;b<this.h;b++)for(let c=0;c<this.w;c++){var a=b<<12|2056|c<<4;if(this.grid.get(a))continue;const d=a-2048,e=a+2048,f=a-8;a+=8;(this.grid.get(d)||this.grid.get(e))&&(this.grid.get(f)||this.grid.get(a))&&(this.random.nextInt(2)?(this.grid.set(d,""),this.grid.set(e,"")):(this.grid.set(f,""),this.grid.set(a,"")))}}removeTightLoops(){for(let a=
0;a<this.h-1;a++){const b=a<<12|2048;for(let a=0;a<this.w-1;a++){const c=b|a<<4|8;this.isTightLoop(c)&&this.breakTightLoop(c)}}}isTightLoop(a){for(let b=0;6144>b;b+=2048)for(let c=0;24>c;c+=8){const d=b|c;if(2056!==d&&"c"!==this.grid.get(a+d))return!1}return!0}breakTightLoop(a){const b=this.random.nextInt(65536);this.grid.set(a+(b&1?b&4096|8:b&16|2048),"")}addStairs(a=0,b=0){a=[a,b];if(!a[0]&&!a[1])return K;for(const b of this.random.ishuffle(this.grid.screens()))if(this.tryAddStair(b,a)&&!a[0]&&
!a[1])return K;return{ok:!1,fail:"stairs"}}addEarlyStair(a,b){const c=[];var d=a-8,e=a+8;const f=a-2048,g=a+2048;let h=[a-8,a+8];if("<"===b){if(h.push(g),c.push([f,""]),"c"===this.grid.get(d)&&"c"===this.grid.get(e)&&this.random.nextInt(3))return c.push([g,""],[a,"<"]),c}else">"===b&&(h.push(f),c.push([g,""]));h=h.filter(a=>"c"===this.grid.get(a));if(!h.length)return[];d=this.random.nextInt(h.length);for(e=0;e<h.length;e++)e!==d&&c.push([h[e],""]);c.push([a,b]);return c}tryAddStair(a,b){if(this.fixed.has(a|
2056))return!1;const c=this.extract(this.grid,a);var d=b[0]&&b[1],e=this.random.nextInt(b[0]+b[1])<b[0];const f=[e?0:1];d&&f.push(e?1:0);for(const g of f)if(d="<>"[g],e=c.substring(0,4)+d+c.substring(5),this.orig.tileset.getMetascreensFromTileString(e).length)return this.grid.set(a|2056,d),b[g]--,!0;return!1}tryConnect(a,b,c,d=1){for(var e;0<d--;){const d=new Map;let l=a;if(2056!==(a&b&2056))throw Error(`bad start ${x(a)} or end ${x(b)}`);for(d.set(l,c);l!==b;){var f=[];for(const a of[8,-8,2048,-2048]){var g=
l+a,h=l+2*a;this.fixed.has(h)||(null!==(e=d.get(h))&&void 0!==e?e:this.grid.get(h))||this.grid.isBorder(g)||f.push(a)}if(!f.length)break;g=(b>>12)-(l>>12);h=(b&240)-(l&240);const a=new Set(f);0>g&&a.delete(2048);0<g&&a.delete(-2048);0>h&&a.delete(8);0<h&&a.delete(-8);f.push(...a,...a);f=this.random.pick(f);d.set(l+f,c);d.set(l+=2*f,c)}if(l===b){for(const [a,b]of d)this.grid.set(a,b),2056===(a&2056)&&this.count++;return!0}}return!1}tryAddLoop(a,b=1){var c=new Fg;for(var d=0;d<this.grid.data.length;d++){var e=
this.grid.coord(d);this.grid.get(e)||this.grid.isBorder(e)||(this.grid.get(rh(e))||c.union([e,rh(e)]),this.grid.get(th(e))||c.union([e,th(e)]))}d=new da(()=>[]);for(const b of this.grid.screens())if(e=b+2056,this.grid.get(e))for(const g of[8,-8,2048,-2048]){const h=e+g;if(this.grid.isBorder(h)||this.grid.get(h))continue;const k=e+2*g;if(!this.grid.get(k)){var f=new Map([[h,a]]);f=this.extract(this.grid,b,{replace:f});this.orig.tileset.getMetascreensFromTileString(f).length&&d.get(c.find(k)).push([h,
k])}}c=new Map;for(var g of d.values())if(!(2>g.length))for(var [h]of g)c.set(h,g);g=[...c.values()];if(!g.length)return!1;for(;0<b--;){h=this.random.pick(g);const [[b,c],[d,e]]=this.random.ishuffle(h);this.grid.set(b,a);this.grid.set(d,a);if(this.tryConnect(c,e,a,5))return!0;this.grid.set(b,"");this.grid.set(d,"")}return!1}tryExtrude(a,b,c=1){for(;c--;)for(const c of this.random.ishuffle(this.grid.screens())){const e=c+2056;if(!this.grid.get(e))continue;const g=this.extract(this.grid,c);for(let c of this.random.ishuffle([0,
1,2,3])){const f=e+uj[c],h=e+2*uj[c];if(!(this.grid.get(f)||this.grid.isBorder(f)||this.grid.get(h))){var d=vj[c];d=g.substring(0,d)+a+g.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(d).length){this.grid.set(f,a);this.grid.set(h,a);if(d=this.tryContinueExtrude(a,b,h))return d;this.grid.set(h,"");this.grid.set(f,"")}}}}return 0}tryContinueExtrude(a,b,c){const d=this.extract(this.grid,c-2056),e=0<this.orig.tileset.getMetascreensFromTileString(d).length;if(1===b)return e?1:0;if(e&&
!this.random.nextInt(b))return 1;for(const g of this.random.ishuffle([0,1,2,3])){const h=c+uj[g],k=c+2*uj[g];if(!(this.grid.get(h)||this.grid.isBorder(h)||this.grid.get(k))){var f=vj[g];f=d.substring(0,f)+a+d.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(h,a);this.grid.set(k,a);if(f=this.tryContinueExtrude(a,b-1,k))return f+1;this.grid.set(k,"");this.grid.set(h,"")}if(e)break}}return e?1:0}tryAdd(a={}){const b=this.orig.tileset,{attempts:c=1,char:d="c",
start:e,loop:f=!1}=a;for(a=0;a<c;a++){var g=null!=e?[e&61680]:this.random.ishuffle(this.grid.screens());for(const a of g){g=a+2056;if(!this.grid.get(g))continue;const c=this.extract(this.grid,a);for(let a of this.random.ishuffle([0,1,2,3])){const e=g+uj[a],k=g+2*uj[a];if(this.fixed.has(e)||this.fixed.has(k))continue;const l=this.grid.get(e),n=this.grid.get(k);if(!(l&&(n||l!==d)||this.grid.isBorder(e))){if(!f){var h=this.extract(this.grid,k-2056,{replace:new Map([[e,""]])});if(/\S/.test(h))continue}h=
vj[a];h=c.substring(0,h)+d+c.substring(h+1);if(b.getMetascreensFromTileString(h).length){this.count++;this.grid.set(e,d);this.grid.set(k,d);h=this.extract(this.grid,k-2056);if(b.getMetascreensFromTileString(h).length)return 1;this.grid.set(k,n);this.grid.set(e,l);this.count--}}}}}return 0}preinfer(){var a;let b;if(null===(a=this.params.features)||void 0===a?0:a.spike)if(b=this.preinferSpikes(),!b.ok)return b;return K}preinferSpikes(){return K}inferScreens(){const a=[];for(var b of this.grid.screens()){var c=
this.extract(this.grid,b),d=this.orig.tileset.getMetascreensFromTileString(c).filter(a=>!a.data.mod);if(!d.length){if(1E5<this.grid.show().length)debugger;return{ok:!1,fail:`infer screen ${x(b)}: [${c}]\n${this.grid.show()}`}}c=this.random.pick(d);a.push(c);c.hasFeature("wall")&&this.walls++;c.hasFeature("bridge")&&this.bridges++}b=!0;c=new Bh(this.params.id,this.orig.tileset,this.h,this.w);for(d=0;d<this.h;d++)for(let f=0;f<this.w;f++){const g=a[d*this.w+f];c.set(d<<4|f,g);g.isEmpty()||(b=!1);if(d){var e=
c.get(d-1<<4|f);if(this.orig.tileset.isBannedVertical(e,g))return{ok:!1,fail:`bad vertical neighbor at ${d}${f}: ${e.name} ${g.name}`}}if(f&&(e=c.get(d<<4|f-1),this.orig.tileset.isBannedHorizontal(e,g)))return{ok:!1,fail:`bad horizontal neighbor at ${d}${f}: ${e.name} ${g.name}`}}return b?{ok:!1,fail:"all screens empty"}:{ok:!0,value:c}}refineMetascreens(a){var b,c;const d=(null===(b=this.params.features)||void 0===b?void 0:b.bridge)||0;b=(null===(c=this.params.features)||void 0===c?void 0:c.wall)||
0;for(const e of this.random.ishuffle(a.allPos())){c=this.extract(this.grid,(e<<8|e<<4)&61680);const f=a.get(e);this.bridges<=d&&f.hasFeature("bridge")||(this.addBlocks&&this.tryMeta(a,e,this.orig.tileset.withMod(c,"block"))?f.hasFeature("bridge")&&this.bridges--:f.hasFeature("bridge")&&this.tryMeta(a,e,this.orig.tileset.withMod(c,"bridge"))?this.bridges--:this.walls<b&&!f.hasFeature("wall")&&this.tryMeta(a,e,this.orig.tileset.withMod(c,"wall"))&&this.walls++)}return this.bridges!==d?{ok:!1,fail:`refineMeta bridges want ${d} got ${this.bridges}\n${a.show()}`}:
this.walls!==b?{ok:!1,fail:`refineMeta walls want ${b} got ${this.walls}\n${a.show()}`}:K}tryMeta(a,b,c){for(const d of c)if(this.checkMeta(a,new Map([[b,d]])))return a.set(b,d),!0;return!1}checkMeta(a,b){a=a.traverse(b?{with:b}:{});return(new Set(a.values())).size===this.maxPartitions}requireEligiblePitDestination(a){let b=!1,c=!1;for(const d of a.allPos()){const e=a.get(d);if(e.hasFeature("river")||e.hasFeature("empty"))continue;const f=(e.data.edges||"").split("").map(a=>" "===a?"":a);f[0]&&f[2]&&
(b=!0);if(f[1]&&f[3]||e.hasFeature("spikes"))c=!0;if(b&&c)return!0}return!1}checkMetascreens(a){var b,c;if(null===(b=this.params.features)||void 0===b||!b.statue)return K;b=0;for(const d of a.allPos()){const e=a.get(d);b+=(null===(c=e.data.statues)||void 0===c?void 0:c.length)||0}return b<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:K}}
class wj extends M{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(a){this.upEdgeType=a;return this}isEligibleArena(a){return!(a&61440)&&super.isEligibleArena(a)}addEdges(){var a;const b=this.grid;var c=super.addEdges();if(!c.ok)return c;c=null===(a=this.params.features)||void 0===a?void 0:a.arena;if(!c)return K;a=[];for(var d=0;d<this.w;d++){var e=d<<4|2056;b.get(e-2048)&&a.push(e)}if(a.length<c)return{ok:!1,fail:`not enough edges\n${b.show()}`};for(const f of this.random.ishuffle(a)){if(!c)break;
a=f-8;d=a-8;e=d-8;const g=d-2048,h=d+2048,k=f+8,l=k+8,n=l+8,q=l-2048,v=l+2048;if(!b.isBorder(a)){if(b.isBorder(e)&&b.get(e))continue;if(b.isBorder(g)&&b.get(g))continue;if(b.isBorder(h)&&b.get(h))continue}if(!b.isBorder(k)){if(b.isBorder(n)&&b.get(n))continue;if(b.isBorder(q)&&b.get(q))continue;if(b.isBorder(v)&&b.get(v))continue}this.fixed.add(f);b.set(f,"a");b.set(a,"");b.set(d,"");b.set(k,"");b.set(l,"");this.grid.set(f,"a");c--}return K}addArenas(){return!0}}
class xj extends M{refineMetascreens(a){for(let b=0;b<this.h;b++)for(let c=0;c<this.w;c++)"a"===this.grid.get(b<<12|c<<4|2056)&&a.set(b<<4|c,a.rom.metascreens.cryptArena_statues);return super.refineMetascreens(a)}isEligibleArena(a){return!this.grid.get(a-2048)&&super.isEligibleArena(a)}}const vj=[1,3,7,5],uj=[-2048,-8,2048,8];class yj extends M{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){var a=[];for(var b=0;b<this.h;b++)for(var c=0;c<this.w;c++){const d=b<<12|c<<4|2056;this.grid.get(d)&&a.push(d)}a=a.filter(a=>1===this.tryClear([a]).length);if(!a.length)return{ok:!1,fail:"all critical?"};for(b=0;b<a.length;b++)for(c=0;c<b;c++)if(2<this.tryClear([a[b],a[c]]).length)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}}
class zj extends yj{removeTightLoops(){}};function Aj(a,b,c=!1){a=new Bj(a,b,c);b=new Cj(b,a,c);return[a,b]}
class Cj extends M{constructor(a,b,c){super(a);this.location=a;this.under=b;this.reverse=c;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw Error("impossible");this.under.finish();super.finishInternal();for(const [a,b]of ha.zip(this.under.upStairs,this.downStairs))this.meta.attach(b,
this.under.meta,a)}addEarlyFeatures(){var a=super.addEarlyFeatures();if(!a.ok)return a;a=16;let b=0,c=16,d=0;var e=1;for(var f of[...this.under.underBridges,-1,...this.under.upStairs])if(-1===f)e=0;else{var g=f>>>4,h=f&15;a=Math.min(h,a);b=Math.max(h,b);c=Math.min(g-e,c);d=Math.max(g+e,d)}a:for(f=0;10>f;f++){e=[];g=this.random.nextInt(this.w-(b-a))+a;g=this.random.nextInt(this.h-(d-c))+c-c<<4+(g-a);for(const a of this.under.underBridges){h=a+g;h=h>>>4<<12|(h&15)<<4|2056;if("c"!==this.grid.get(h))continue a;
e.push([h,"b"]);e.push([h-8,""]);e.push([h+8,""])}for(const a of this.under.upStairsEffective){h=a+g;h=h>>>4<<12|(h&15)<<4|2056;if("c"!==this.grid.get(h))continue a;e.push([h,this.reverse?"<":">"]);e.push([h+(this.reverse?-2048:2048),""]);h=this.addEarlyStair(h,this.reverse?"<":">");if(!h.length)continue a;e.push(...h)}for(const [a,b]of e)b&&this.fixed.add(a),"<"!==b&&">"!==b||this.downStairs.push(a>>4&15|a>>8&240),this.grid.set(a,b);return K}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(a=
0,b=0){return this.reverse?super.addStairs(a-this.under.upStairs.length,b):super.addStairs(a,b-this.under.upStairs.length)}addOverpasses(){return!0}}
class Bj extends M{constructor(a,b,c){super(a);this.loc=a;this.overpass=b;this.reverse=c;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}build(){var a=super.build();if(!a.ok)return a;if(!this.meta)throw Error("impossible");a=this.reverse?"stair:down":"stair:up";for(var b of this.meta.allPos()){const c=this.meta.get(b);c.hasFeature("underpass")&&this.underBridges.push(b);if(c.hasFeature(a)){let a=0;for(const b of c.data.exits)"stair:up"===
b.type&&32768>b.entrance&&(a=-16),"stair:down"===b.type&&32768<b.entrance&&(a=16);this.upStairsEffective.push(b+a);this.upStairs.push(b)}}if(!this.underBridges.length)throw Error(`Expected bridge in ${this.loc}\n${this.meta.show()}`);if(!this.upStairs.length)throw Error(`Expected stair in ${this.loc}\n${this.meta.show()}`);b=0;for(const [,c,[d]]of this.orig.exits())c===a&&d>>>8===this.overpass.id&&b++;this.upStairs=this.random.shuffle(this.upStairs).slice(0,b);return K}};var N,Dj=N||(N={});Dj[Dj.Unknown=0]="Unknown";Dj[Dj.GrassLongGrass=1]="GrassLongGrass";Dj[Dj.GrassLongGrassRemapping=2]="GrassLongGrassRemapping";Dj[Dj.RiverShortGrass=3]="RiverShortGrass";Dj[Dj.SeaCaveEntrance=4]="SeaCaveEntrance";Dj[Dj.SeaRocks=5]="SeaRocks";Dj[Dj.SeaMarsh=6]="SeaMarsh";Dj[Dj.SeaTrees=7]="SeaTrees";Dj[Dj.DesertShortGrass=8]="DesertShortGrass";Dj[Dj.DesertLongGrass=9]="DesertLongGrass";Dj[Dj.DesertMarsh=10]="DesertMarsh";Dj[Dj.DesertRocks=11]="DesertRocks";
Dj[Dj.DesertTrees=12]="DesertTrees";Dj[Dj.DesertTownEntrance=13]="DesertTownEntrance";Dj[Dj.LabyrinthParapets=14]="LabyrinthParapets";Dj[Dj.SwampDoors=15]="SwampDoors";Dj[Dj.ExtraSpikes=16]="ExtraSpikes";Dj[Dj.CloseCaves=17]="CloseCaves";Dj[Dj.WideArenaExits=18]="WideArenaExits";
function Ej(a){const {desert:b,grass:c,lime:d,mountain:e,mountainRiver:f,river:g,sea:h,town:k}=a.metatilesets;a=a.metascreens;a.registerFix(N.DesertRocks);b.getTile(95).copyFrom(91).replaceIn(a.oasisCave,a.oasisLake);b.getTile(90).copyFrom(152).setTiles([,,26,24]);b.getTile(91).copyFrom(128).setTiles([52,50,,]);b.getTile(92).copyFrom(128).setTiles([,,55,53]);b.getTile(93).copyFrom(128).setTiles([,55,,52]);b.getTile(94).copyFrom(128).setTiles([53,,50]);a.registerFix(N.DesertTrees);b.getTile(99).copyFrom(113);
b.getTile(104).copyFrom(112);b.getTile(105).copyFrom(96);b.getTile(106).copyFrom(101);b.getTile(108).copyFrom(112);b.getTile(110).copyFrom(118);b.getTile(111).copyFrom(120);a.registerFix(N.GrassLongGrass);c.getTile(64).copyFrom(81);c.getTile(65).copyFrom(82);c.getTile(66).copyFrom(83);c.getTile(67).copyFrom(84);c.getTile(68).copyFrom(85);c.getTile(69).copyFrom(86);c.getTile(70).copyFrom(88);c.getTile(71).copyFrom(89);a.registerFix(N.SeaCaveEntrance);h.getTile(173).copyFrom(10).replaceIn(a.beachExitN,
a.lighthouseEntrance,a.oceanShrine);h.getTile(10).copyFrom(162);a.boundaryN_cave.screen.set2d(56,[[,0,0],[,10,10],[,247,247],[248,248,248,248]]);a.cornerSE_cave.screen.set2d(73,[[,0,0],[,10,10],[,247,247],[248,247,247],[,253,247]]);a.cornerSE_cave.screen.set2d(74,[[0,0],[10,10],[247,247],[248,247],[128,253],[128,255],[250]]);a.registerFix(N.CloseCaves);g.getTile(7).copyFrom(1).replaceIn(...g);g.getTile(14).copyFrom(2).replaceIn(...g);g.getTile(32).copyFrom(3).replaceIn(...g);g.getTile(33).copyFrom(4).replaceIn(...g);
for(var l of[b,h,e,f,d])l.getTile(104).copyFrom(1).replaceIn(...l),l.getTile(131).copyFrom(2).replaceIn(...l),l.getTile(136).copyFrom(3).replaceIn(...l),l.getTile(137).copyFrom(4).replaceIn(...l);for(var n of[k])n.getTile(80).copyFrom(26).replaceIn(...n),n.getTile(81).copyFrom(27).replaceIn(...n),n.getTile(26).copyFrom(1).replaceIn(...n),n.getTile(27).copyFrom(2).replaceIn(...n),n.getTile(82).copyFrom(3).replaceIn(...n),n.getTile(87).copyFrom(4).replaceIn(...n);for(const a of[c,g,b])a.getTile(1).copyFrom(193).setAlternative(0),
a.getTile(2).copyFrom(215).setAlternative(10),a.getTile(3).copyFrom(193).setAlternative(0),a.getTile(4).copyFrom(215).setAlternative(10);for(var q of[h])for(q.getTile(1).copyFrom(193).setAlternative(0),q.getTile(2).copyFrom(203).setAlternative(0),q.getTile(3).copyFrom(193).setAlternative(192),q.getTile(4).copyFrom(203).setAlternative(192),l=1;5>l;l++)q.getTile(l).setTiles(c.getTile(l).tiles);for(var v of[k])v.getTile(1).copyFrom(99).setAlternative(0),v.getTile(2).copyFrom(100).setAlternative(210),
v.getTile(3).copyFrom(99).setAlternative(0),v.getTile(4).copyFrom(100).setAlternative(210);l=new Set([a.boundaryE_cave,a.boundaryW_cave,a.exitW_cave,a.caveAbovePortoa,a.beachCave,a.outsideWindmill,a.exitS_cave,a.townExitW_cave,a.zombieTownBottom_caveExit]);q=new Set([]);a.isFixed(N.SeaCaveEntrance)&&(q.add(a.boundaryN_cave),q.add(a.cornerSE_cave));v=new Set([a.mountainDeadEndW_caveEmpty,a.mountainPathW_cave,a.mountainCave_empty,a.mountainPathE_cave,a.mountainPathN_slopeS_cave,a.mountainPathWE_slopeN_cave,
a.mountainPathE_gate]);for(var y of[...l,...q])l=y.data.exits.find(a=>"cave"===a.type),l=Math.min(...l.exits)-16,n=q.has(y)?[[3,3],[4,4]]:[[1,1],[2,2]],y.screen.set2d(l,n),y.addCustomFlag(!0);for(const a of[...v])y=a.data.exits.find(a=>"cave"===a.type||"gate"===a.type),y=Math.min(...y.exits)-16,a.screen.set2d(y,[[26,26],[8,9]]),a.addCustomFlag(!0);a.outsideWindmill.screen.set2d(67,[[202,130]]);a.townExitW_cave.screen.set2d(42,[[202,130]])}
function Fj(a){function b(a){a.splice(0,a.length,...new Set(ha.concat(...a.map(a=>[a,a+1,a-1]))))}var c;const {fortressArena_through:d,fortressTrap:e,hallNS:f,hallNS_arena:g,hallNS_arenaWall:h,hallNS_entrance:k}=a.metascreens;g.screen.set2d(4,[[151,118,34,35,35,35,75,149],[66,72,34,33,35,35,69,66],[67,73,46,35,35,33,70,67],[68,74,46,35,33,33,71,68]]);g.setGridTile(" c | a | c ");b(g.findExitByType("edge:top").exits);h.screen.set2d(4,[[148,76,34,33,33,33,75,147],[151,79,0,1,1,2,80,149]]);h.setGridTile(" c | a | c ");
b(h.findExitByType("edge:top").exits);var l=a.locations.ZebuCave.spawns.find(a=>a.isTrigger()&&140===a.id);l&&(l.yt+=4);d.screen.set2d(5,[[95,34,33,33,33,95],[183,34,33,33,33,181],[191,34,33,33,33,168]]);d.setGridTile(" c | a | w ");b(d.findExitByType("edge:top").exits);e.screen.set2d(196,[[60,61,33,33,33,33,59,60],[146,76,34,33,33,33,75,144],[148,76,34,33,33,33,75,147]]);e.setGridTile("   | x | c ");b(e.findExitByType("edge:bottom").exits);for(const b of a.locations){a=b.meta;for(const d of a.allPos())a.get(d)===
k&&(null===(c=a.get(d+16))||void 0===c?0:c.hasFeature("arena"))&&(a.set(d,f),l=b.screens[d>>>4])&&(l[d&15]=f.sid)}};class Gj extends M{initialFill(){const a=this.size+3,b=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(qh(b))||this.fixed.add(qh(b,2));this.grid.isBorder(rh(b))||this.fixed.add(rh(b,2));this.grid.set(b,">");this.fixed.add(b);this.grid.set(sh(b),"w");this.fixed.add(sh(b));this.fixed.add(qh(b));this.fixed.add(rh(b));const c=this.random.nextInt(this.w)<<4|2056,d=th(c,2);this.grid.set(c,"<");this.fixed.add(c);this.grid.set(th(c),"w");this.fixed.add(th(c));this.grid.set(d,"w");this.fixed.add(d);
this.grid.set(th(d),"w");this.fixed.add(th(d));this.fixed.add(qh(d));this.fixed.add(rh(d));if(!this.tryConnect(sh(b,2),th(d,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<a;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return K}refine(){return K}refineEdges(){return!0}addArenas(){return!0}addStairs(){return K}refineMetascreens(a){console.log(a.show());for(var b=0;b<a.height;b++)for(var c=0;c<a.width;c++){var d=b<<4|c,e=a.get(d),f=e.edgeIndex("w");if(e.hasFeature("arena"))this.arena=
d+16<<8|1;else if(5===f){if(16>d||!a.get(d-16).hasFeature("arena"))a.set(d,a.rom.metascreens.goaWideHallNS_stairs),this.grid.set((d<<8|d<<4)&61680|2056,"H")}else 1===f&&(this.stair=d<<8|2)}this.reachable=void 0;if(!this.checkMeta(a))return{ok:!1,fail:"initial meta check"};console.log(a.show());b=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(c=0;c<a.width;c++)for(d=0;d<a.height;d++){e=d<<12|c<<4|2056;for(f=0;d+f<a.height&&"H"===this.grid.get(e+4096*f);)f++;if(!f)continue;const h=[new Map,new Map];
for(var g=0;g<f;g++)h[g&1].set(d+g<<4|c,b);g=!1;for(const b of this.random.ishuffle(h))if(!b.size)g=!0;else if(this.checkMeta(a,b)){for(const [c,f]of b)a.set(c,f),this.grid.set(e+4096*((c>>4)-d),"=");g=!0;break}if(!g)return{ok:!1,fail:"could not rectify hallway"};d+=f}return super.refineMetascreens(a)}checkMeta(a,b){b=a.traverse(b?{with:b}:{});const c=b.get(this.stair);if(c!==b.get(this.arena))return console.log(`stair not connected to arena\n${a.show()}`),!1;if(null==this.reachable){if(c&&c.size<
.95*b.size)return console.log("too small"),!1;this.reachable=null===c||void 0===c?void 0:c.size;return!0}return(null===c||void 0===c?void 0:c.size)>.95*this.reachable?!0:!1}}
function Hj(a,b){var c;const {metatilesets:{cave:d,fortress:e,iceCave:f,labyrinth:g,pyramid:h}}=a;a.metascreens.registerFix(N.LabyrinthParapets,1);for(var k of[g,h])k.getTile(43).copyFrom(25).replaceIn(...k),k.getTile(186).copyFrom(27).replaceIn(...k);for(var l of[e,g,h,d])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(const a of[f,d,h])a.getTile(23).copyFrom(197),a.getTile(24).copyFrom(197);g.getTile(23).copyFrom(198).setAlternative(197);g.getTile(24).copyFrom(196).setAlternative(197);
k=new da(()=>[]);for(var n of a.metatilesets.labyrinth)k.get(n.sid).push(n);for(const [d,e]of k){n=a.screens[d];k=e.map(a=>{var b;return null===(b=a.data.tilesets.labyrinth)||void 0===b?void 0:b.removeWall});const [f,...g]=new Set(k.filter(a=>null!=a));if(null!=f){n.set2d(f,[[197,197],[208,197]]);if(g.length)throw Error("bad remove");for(l=0;l<k.length;l++)null==k[l]&&(e[l].data.tilesets.labyrinth.addWall=[f])}if(!(2>e.length)){2<e.length&&(k=b.pick(e.filter(a=>{var b;return null===(b=a.data.tilesets.labyrinth)||
void 0===b?void 0:b.addWall})),e.splice(e.indexOf(k),1),k.remove());for(const a of e)if(k=null===(c=a.data.tilesets.labyrinth)||void 0===c?void 0:c.addWall,null!=k){a.data.mod="block";for(const a of k)n.set2d(a,[[23,23],[24,24]])}else a.flag="always"}}};function Ij(a,b,c){a=new Jj(a);b=new Kj(b,a);c=new Lj(c,b);return[a,b,c]}
class Jj extends M{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){var a=this.random.pick(this.patterns);this.count=3;a=this.insertPattern(a,{top:1,bottom:1});if(!a.ok)return a;this.addAllFixed();for(a=0;a<this.grid.data.length;a++){if(">"!==this.grid.data[a])continue;const b=this.grid.coord(a);this.stair=b>>>8&240|
b>>>4&15}return K}addEdges(){let a=10;for(;this.count<this.size&&a;)this.tryAdd()||a--;return a?K:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let a=!1;for(const b of this.random.ishuffle(this.grid.screens()))if(" c  c  c "===this.extract(this.grid,b)){this.grid.set(b+2056,"b");a=!0;break}return a?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return K}addLateFeatures(){return K}addStairs(){return K}}
class Kj extends M{constructor(a,b){super(a);this.location=a;this.upper=b;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){const a=[];var b=!0,c=this.upper.meta;let d=this.upper.stair;c.get(d).isEmpty()||(d+=16,b=!1);if(null==d)throw Error("no stair found");for(var e of c.allPos())c.get(e).hasFeature("overpass")&&a.push(e);this.random.shuffle(a);
e=d>>>4;var f=c=d&15,g=e;for(var h of a){const a=h>>>4,b=h&15;e=Math.min(e,a);c=Math.min(c,b);f=Math.max(f,b);g=Math.max(g,a)}h=g-e+1;f=f-c+1;e=e<<4|c;g=1+this.random.nextInt(this.w-f-2);e=(this.random.nextInt(this.h-h-(b?1:0))<<4|g)-e;c=(d&15)-c<f/2;d+=e;for(h=0;h<a.length;h++)a[h]+=e;e=b?"    <  c ":c?"    <c   ":"   c<    ";if(!this.insertTile(a[0],"   cbc   ")||!this.insertTile(a[1],"   cbc   "))throw Error("Could not insert bridge tile");if(!this.insertTile(d,e)){h=[-1,1,16,-16,15,17,-15,-17];
f=!1;for(var k of this.random.ishuffle(h))if(this.insertTile(d+k,e)){d+=k;f=!0;break}if(!f)throw Error("Could not insert stair");}this.stair=d;this.addAllFixed();this.count=3;k=c?1:-1;b=b?16:k;return a.includes(d+k)||this.tryConnect(this.posToGrid(d+b,2056),this.posToGrid(a[0]-k,2056),"c",10)?this.tryConnect(this.posToGrid(a[0]+k,2056),this.posToGrid(a[1]+k,2056),"c",10)?K:{ok:!1,fail:"could not connect bridges"}:{ok:!1,fail:"could not connect stair to bridge"}}addEdges(){let a=100;for(;this.count<
this.size-4&&a;)this.tryAdd()||a--;return a?K:{ok:!1,fail:"could not populate"}}refine(){return K}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(const a of this.random.ishuffle(this.grid.screens())){if(!(a&61440))continue;const b=a+2056;if(!(this.fixed.has(b)||this.grid.get(b)||this.grid.get(qh(b,2))||this.grid.get(rh(b,2))||"c"!==this.grid.get(th(b,2)))&&this.canSetAll(new Map([[th(b),"c"],[b,"a"],[sh(b),"c"],[sh(b,2),"c"]])))return this.grid.set(th(b),"c"),this.grid.set(b,"a"),
this.grid.set(sh(b),"c"),this.fixed.add(b),this.fixed.add(sh(b,2)),!0}return!1}addStairs(a=0,b=0){return super.addStairs(a-1,b)}finishInternal(){if(!this.meta)throw Error("impossible");this.upper.finish();super.finishInternal();const a=this.upper.meta,b=this.upper.stair,c=this.stair;null!=b&&null!=c&&this.meta.attach(c,a,b,"stair:up","stair:down")}}
class Lj extends M{constructor(a,b){super(a);this.main=b}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(a){for(const b of a.allPos())if(a.get(b).hasFeature("arena"))return b;throw Error("never found arena");}initialFill(){var a=this.findArena(this.main.meta);a=this.posToGrid(a,2056);this.grid.set(a,"a");this.grid.set(sh(a),"c");this.grid.set(th(a),"c");this.fixed.add(a);this.fixed.add(th(a));
this.fixed.add(th(a,2));return K}addEdges(){let a=10;const b=2+this.random.nextInt(2);for(;this.count<b&&a;)this.tryAdd()||a--;return a?K:{ok:!1,fail:"addEdges"}}refine(){return K}addLateFeatures(){return K}inferScreens(){const a=super.inferScreens();if(!a.ok)return a;const b=a.value,c=this.findArena(b),d=this.main.meta;b.set(c+15,this.orig.tileset.unreachableVariant(d.get(c+15)));b.set(c+16,this.orig.tileset.unreachableVariant(d.get(c+16)));b.set(c+17,this.orig.tileset.unreachableVariant(d.get(c+
17)));return a}finishInternal(){if(!this.meta)throw Error("impossible");this.main.finish();const a=this.main.meta,b=this.findArena(this.meta);super.finishInternal();a.setExit(b,"seamless:up",[this.meta.id<<8|b,"seamless:down"]);this.meta.freeFlags=new Set(a.freeFlags)}reportFailure(){throw Error("Completely failed to shuffle Karmine Kensu map");}}
class Mj extends M{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(5!==this.grid.height||8!==this.grid.width)throw Error("bad size");ph.writeGrid2d(this.grid,0,Mj.PATTERN);this.count=36;return K}addSpikes(){var a=this.random.nextInt(4);for(var b=1;10>b;b++)for(var c=0;4>c;c++){var d=2*c+5+17*b;c===a?this.grid.data[d]="c":(d=this.grid.coord(d),this.fixed.add(d),5===b&&(this.fixed.add(d+8),this.fixed.add(d+16),this.fixed.add(d-8),this.fixed.add(d-
16)))}a=0;for(const h of this.random.ishuffle(this.grid.screens())){if(3===a)break;b=h|2056;c=sh(b);var e=sh(b,2);d=th(b);var f=th(b,2),g=qh(b);const k=rh(b);if("c"===this.grid.get(b)&&"s"!==this.grid.get(c)&&"s"!==this.grid.get(e)&&"s"!==this.grid.get(d)&&"s"!==this.grid.get(f)){e=[];f=[];for(const a of[d,g,k])"c"===this.grid.get(a)&&("s"===this.grid.get(2*a-b)?f.push(a):e.push(a));if(!(1<f.length)&&(e.length||f.length)){for(;1<e.length+f.length&&(2!==e.length+f.length||e.includes(d)||f.includes(d));)[g]=
e.splice(this.random.nextInt(e.length),1),this.grid.set(g,"");this.grid.set(c,"");this.fixed.add(b);this.grid.set(b,"<");a++}}}return 1===(new Set(this.grid.partition().values())).size}addStairs(){return K}}Mj.PATTERN="                 ;   ccccccccccc   ;   c c c c c c   ; ccc s s s s ccc ; c c s s s s c c ; ccccscscscscccc ; c c s s s s c c ; ccc s s s s ccc ;   c c c c c c   ;   ccccccccccc   ;                 ".split(";");class Nj{constructor(a,b,c){this.h=a;this.w=b;this.valid=c;this.fixed=new Set;this.size=0;this.data=new Uint8Array(a*b)}fill(){for(let a=0;a<this.h;a++)for(let b=0;b<this.w;b++){const c=a*this.w+b;0<a&&(this.data[c]|=1);0<b&&(this.data[c]|=2);a<this.h-1&&(this.data[c]|=4);b<this.w-1&&(this.data[c]|=8)}}isBorder(a,b){const c=a%this.w;return this.isBorder2((a-c)/this.w,c,b)}isBorder2(a,b,c){if(0===c)return!a;if(1===c)return!b;if(2===c)return a>=this.h-1;if(3===c)return b>=this.w-1;throw Error("bad direction");
}delete2(a,b,c=a*this.w+b){if(this.fixed.has(c))return!1;const d=new Map;d.set(c,0);for(let e=0;4>e;e++){if(this.isBorder2(a,b,e))continue;const f=c+this.delta(e),g=this.data[f],h=g&~(1<<(e^2));if(g!==h){if(this.fixed.has(f))return!1;d.set(f,h)}}return this.try(d)}delete(a){const b=a%this.w;return this.delete2((a-b)/this.w,b,a)}deleteEdge2(a,b,c,d=a*this.w+b){if(this.fixed.has(d))return!1;if(this.isBorder2(a,b,c))return this.data[d]&=~(1<<c),!0;a=new Map;b=d+this.delta(c);if(this.fixed.has(b))return!1;
a.set(d,this.data[d]&~(1<<c));a.set(b,this.data[b]&~(1<<(c^2)));return this.try(a)}deleteEdge(a,b){const c=a%this.w;return this.deleteEdge2((a-c)/this.w,c,b,a)}refine(a,b){let c=0;const d=new Set;for(var e=0;e<this.data.length;e++)this.data[e]&&c++,this.fixed.has(e)||d.add(e);for(;c>b;){e=!1;for(const f of a.ishuffle(d)){if(c<=b)break;this.data[f]?this.delete(f)&&(e=!0,c--):c--}if(!e)return!1}return!0}validate(){for(let a=0;a<this.h;a++)for(let b=0;b<this.w;b++){const c=a*this.w+b,d=this.data[c];
if(a&&!(this.data[c-this.w]&4)!==!(d&1))throw Error(`invalid above ${a}${b}`);if(b&&!(this.data[c-1]&8)!==!(d&2))throw Error(`invalid left of ${a}${b}`);}}addEdge(a,b,c){const d=a*this.w+b;this.data[d]|=1<<c;this.isBorder2(a,b,c)||(this.data[d+this.delta(c)]|=1<<(c^2))}consolidate(a,b){const c=new na;for(var d=0;d<this.data.length;d++)!this.fixed.has(d)&&this.data[d]&&c.add(this.data[d]);for(d=1E3;c.unique()>b&&--d;){var e=[...c].sort((a,b)=>b[1]-a[1]);const d=e[b][1];e=new Set(e.filter(a=>a[1]<=
d).map(a=>a[0]));e=this.findEligibleConsolidates(e);if(!e.length)return[];for(const [b,d]of a.pick(e))this.data[b]&&c.delete(this.data[b]),d&&c.add(d),this.data[b]=d}return d?[...c].map(a=>a[0]):[]}consolidateFixed(a,b){const c=new na;for(var d=0;d<this.data.length;d++){var e=this.data[d];!this.fixed.has(d)&&b.has(e)&&c.add(e)}for(d=1E3;c.unique()&&--d;){e=this.findEligibleConsolidates(b);if(!e.length)return!1;for(const [d,g]of a.pick(e))e=this.data[d],b.has(e)&&c.delete(e),b.has(g)&&c.add(g),this.data[d]=
g}return d?!0:!1}findEligibleConsolidates(a){const b=[],c=[];for(let e=0;e<this.data.length;e++){if(this.fixed.has(e))continue;const f=this.data[e];if(a.has(f))for(let g=0;4>g;g++){if(this.isBorder(e,g))continue;var d=this.delta(g);if(this.fixed.has(e+d))continue;const h=1<<g;if(a.has(f^h))continue;const k=1<<(g^2),l=this.data[e+d];d=new Map([[e,f^h],[e+d,l^k]]);if(this.check(d)&&(b.push(d),!a.has(l^k)&&a.has(l))){c.push(d);break}}}return c.length?c:b}try(a){if(!this.check(a))return!1;for(const [b,
c]of a)this.data[b]=c;return!0}check(a){var b;const c=new Fg;for(let d=0;d<this.h;d++)for(let e=0;e<this.w;e++){const f=d*this.w+e,g=null!==(b=null===a||void 0===a?void 0:a.get(f))&&void 0!==b?b:this.data[f];g&&c.union([f]);0<d&&g&1&&c.union([f,f-this.w]);0<e&&g&2&&c.union([f,f-1]);d<this.h-1&&g&4&&c.union([f,f+this.w]);e<this.w-1&&g&8&&c.union([f,f+1])}return 1===c.roots().length}addPath(a,b){var c,d,e;if(this.size){var f=[];for(e=0;e<this.data.length;e++)this.data[e]&&15!==this.data[e]&&f.push(e);
if(!f.length)return!1;e=a.pick(f);f=e%this.w;e=(e-f)/this.w}else e=a.nextInt(this.h),f=a.nextInt(this.w);const g=new Map;let h=e*this.w+f,k=0,l=!0;for(;;){let q=!1;const v=null!==(c=g.get(h))&&void 0!==c?c:this.data[h];let y=!1;for(let b of a.ishuffle([0,1,2,3])){var n=1<<b;if(v&n)continue;n|=v;if(this.valid&&!this.valid.has(n))continue;const a=e+Oj[b],c=f+Pj[b];if(0>a||0>c||a>=this.h||c>=this.w)continue;const k=a*this.w+c,A=null!==(d=g.get(k))&&void 0!==d?d:this.data[k],L=A|1<<(b^2);if(A){if(A===
L||this.valid&&!this.valid.has(L))continue;q=!0}l=!this.valid||this.valid.has(L);g.set(h,n);g.set(k,L);f=c;e=a;h=k;y=!0;break}if(!y)break;if(q||this.data[h])break;this.size++||this.size++;if(l&&b&&this.size>=b)break;if(l&&a.nextInt(15)<k++)break}if(!g.size||!l)return!1;for(const [a,b]of g)this.data[a]=b;return!0}toGrid(a){const b=new ph(this.h,this.w);for(let c=0;c<this.h;c++)for(let d=0;d<this.w;d++){const e=this.data[c*this.w+d];if(!e)continue;const f=c<<12|d<<4|2056;b.set(f,a);for(let c=0;4>c;c++){if(!(e&
1<<c))continue;const d=c&1?8:2048;b.set(c&2?f+d:f-d,a)}}return b}delta(a){return(a&2?1:-1)*(a&1?1:this.w)}show(){const a=[];for(let b=0;b<this.h;b++){let c="";for(let a=0;a<this.w;a++)c+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250c\u251c\u252c\u253c"[this.data[b*this.w+a]];a.push(c)}return a.join("\n")}}
class Qj{constructor(a,b,c){this.grid=a;this._i=b*a.w+c}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(a){var b=this.grid.delta(a);b=this._i+b;this.grid.data[this._i]|=1<<a;this.grid.data[this._i=b]|=1<<(a^2)}directedPath(a,b,c){for(;;){const d=this.y,e=this.x,f=[];b<d&&f.push(0);c<e&&f.push(1);b>d&&f.push(2);c>e&&f.push(3);if(!f.length)break;this.go(a.pick(f))}}}const Oj=[-1,0,1,0],Pj=[0,-1,0,1];class Rj{constructor(a){this.location=a}shuffle(a){if(this.meta)throw Error("impossible");const b=this.location.meta;Sj(b,a);a.nextInt(2)&&Tj(this.location.rom);const c=[...b.exits()].filter(a=>"stair:up"===a[1]),d=[...b.exits()].filter(a=>"stair:down"===a[1]);a.shuffle(c);a.shuffle(d);for(var e of[...b.exits()])if(e[2][0]>>>8!==this.location.id){var f=("stair:up"===e[1]?c:d).pop();b.setExit(f[0],f[1],e[2])}if(c.length!==d.length)throw Error("length mismatch");e=a.shuffle([...d]);for(f=0;f<d.length;f++)d[f]===
e[f]&&(a.shuffle(e),f=-1);a=this.location.id<<8;for(f=0;f<c.length;f++)b.setExitOneWay(c[f][0],c[f][1],[a|d[f][0],d[f][1]]),b.setExitOneWay(e[f][0],e[f][1],[a|c[f][0],c[f][1]]);this.meta=b}finish(){}}
function Sj(a,b){const c=b.nextInt(2)+6;b=b.nextInt(3)+2;if(7!==c||3!==b){var {branchNWSE:d,branchNWE:e,branchWSE:f,branchNWE_upStair:g,deadEndW:h,deadEndE:k}=a.rom.metascreens,l=c<<4|b,n=f;7===c&&1===b&&(n=k);7===c&&5===b&&(n=h);a.set2d(99,[[d],[d],[d]]);a.set2d(l-16,[[e],[g],[n]]);a.moveExit(115,l)}}
function Tj(a){const b=a.locations.Pyramid_Draygon.meta,c=a.locations.Pyramid_Main.meta,{metascreens:{hallSE:d,deadEndW_downStair:e,wideHallNE:f,wideHallNW:g,fortressArena_through:h,deadEndS_stairs:k}}=a;b.width=2;b.set2d(0,[[null,k],[null,h],[f,g]]);b.moveExit(32,1);c.set2d(3,[[d,e]]);c.moveExit(3,4);c.attach(4,b,1)};class Uj extends M{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let a;if(a=this.initialFillEarly(),!a.ok)return a;this.initialFillLate();if(a=this.connectEarlyToLate(),!a.ok)return a;this.count=[...this.grid.screens()].filter(a=>this.grid.get(a+2056)).length;return K}initialFillEarly(){const a=new Nj(this.h,this.w,this.getValidEarlyScreens());let b=0;const c=this.targetEarly();for(;20>b++&&a.size<c;)a.addPath(this.random,c)&&(b=0);this.grid.data=a.toGrid(this.early).data;this.addAllFixed();
return K}initialFillLate(){for(var a=0;a<this.h;a++)for(var b=0;b<this.w;b++){var c=a<<12|b<<4|2056;this.grid.get(c)||this.grid.set(c,"c")}for(a=0;a<this.h;a++)for(b=0;b<this.w;b++)for(const d of[8,2048]){c=a<<12|b<<4|2056;const e=c+d,f=c+2*d;this.grid.isBorder(e)||this.grid.get(e)||"c"!==this.grid.get(c)||"c"!==this.grid.get(f)||this.grid.set(e,"c")}}connectEarlyToLate(){for(const c of this.random.ishuffle(this.grid.screens()))for(const d of[8,2048]){var a=c|2056;const e=a+d;var b=a+2*d;this.grid.isBorder(e)||
this.grid.get(e)||(this.grid.set(e,"c"),a=this.extract(this.grid,a-2056),b=this.extract(this.grid,b-2056),this.orig.tileset.getMetascreensFromTileString(a).length&&this.orig.tileset.getMetascreensFromTileString(b).length||this.grid.set(e,""))}return K}pruneDisconnected(){const a=new Set(this.grid.partition().values());let b=0;for(const c of a)if([...c].some(a=>this.grid.get(a)===this.early))b+=[...c].filter(a=>2056===(a&2056)).length;else for(const a of c){if(this.fixed.has(a))return{ok:!1,fail:`fixed tile ${x(a)} disconnected`};
this.grid.set(a,"")}return b<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):K}getValidEarlyScreens(){if(!this.validEarlyScreens){const a=new Set;for(const b of this.orig.tileset){const c=b.edgeIndex(this.early);null!=c&&a.add(c)}this.validEarlyScreens=a}return this.validEarlyScreens}addEarlyFeatures(){var a,b;if(!this.addArenas(null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.arena)&&void 0!==b?b:0))return{ok:!1,fail:"addArenas"};let c;return(c=
this.pruneDisconnected(),c.ok)?super.addEarlyFeatures():c}}
class Vj extends Uj{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){var a;const b=null===(a=this.params.features)||void 0===a?void 0:a.wide;return null!=b?b+2+this.random.nextInt(3):0}initialFillEarly(){var a,b;const c=new Nj(this.h,this.w);c.fill();var d=w(c.data.length).slice(c.w),e=this.random.pick(d);if(!c.deleteEdge(e,1))return{ok:!1,fail:"initial stair"};if(!c.deleteEdge(e,2))return{ok:!1,fail:"initial stair"};if(!c.deleteEdge(e,3))return{ok:!1,fail:"initial stair"};
c.fixed.add(e);var f=new Set(d);f.delete(e);d=[];for(const e of this.random.ishuffle(f)){f=function(a){if(!c.delete(a))return!1;c.fixed.add(a);return!0};var g=null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.arena)&&void 0!==b?b:0;if(d.length>=g)break;if(e>c.data.length-2*c.w)continue;if(c.fixed.has(e))continue;g=!c.isBorder(e,1);const h=!c.isBorder(e,3);if(!(g&&c.fixed.has(e-1)||h&&c.fixed.has(e+1)||c.fixed.has(e-c.w)||c.fixed.has(e+c.w))&&c.data[e]&4){if(!f(e-c.w))return{ok:!1,fail:"initial arena"};
if(g&&!f(e-1))return{ok:!1,fail:"initial arena"};if(h&&!f(e+1))return{ok:!1,fail:"initial arena"};f=e+c.w;if(5!==(c.data[f]&5))return{ok:!1,fail:"initial arena"};if(!c.deleteEdge(f,1))return{ok:!1,fail:"initial arena"};if(!c.deleteEdge(f,3))return{ok:!1,fail:"initial arena"};c.deleteEdge(f+c.w,2);c.fixed.add(f);d.push(e);c.fixed.add(e)}}if(!c.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};a=new Set;for(b=1;16>b;b++)this.getValidEarlyScreens().has(b)||a.add(b);if(!c.consolidateFixed(this.random,
a))return{ok:!1,fail:"consolidate"};this.grid.data=c.toGrid("w").data;a=(a,b)=>{const d=a%c.w;a=(a-d)/c.w<<12|d<<4|2056;this.grid.set(a,b);for(const b of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(a+b)};a(e,">");for(const b of d)a(b,"a");e=3;for(const a of this.grid.screens())this.grid.get(a+2056)&&e++;this.size=e;return K}addStairs(a,b){return super.addStairs(a,b?b-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let a=0;a<this.h;a++){const b=a<<12|2056;for(let a=0;a<this.w;a++){const c=
b|a<<4;"a"===this.grid.get(c)&&this.grid.set(c-2048,"c")}}return K}preinfer(){var a=new Map;for(var b=0;b<this.grid.data.length;b++)"w"===this.grid.data[b]&&a.set(this.grid.coord(b),"");a=this.grid.partition(a);b=new Set;for(const [c,d]of a)"<"===this.grid.get(c)&&b.add(d);return 2>b.size?{ok:!1,fail:"stairs bunched"}:K}refineMetascreens(a){for(const b of a.allPos())a.get(b).hasFeature("arena")&&a.set(b,a.rom.metascreens.fortressArena_through);return K}refineEdges(){return!0}};class Wj extends Uj{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){var a,b;return null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.river)&&void 0!==b?b:0}preinfer(){if(2>[...this.orig.exits()].length)return K;var a=new Map;for(var b=0;b<this.grid.data.length;b++)"r"===this.grid.data[b]&&a.set(this.grid.coord(b),"");a=this.grid.partition(a);b=[];for(let c=0;c<this.grid.data.length;c++)("<"===this.grid.data[c]||">"===this.grid.data[c]||this.grid.data[c]&&
this.grid.isBorder(this.grid.coord(c)))&&b.push(a.get(this.grid.coord(c)));return(new Set(b)).size<b.length?{ok:!1,fail:`river didn't matter\n${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return K}addArenas(a){if(!a)return!0;const b=this.grid;for(const c of this.random.ishuffle(this.grid.screens())){const d=c|2056,e=d-8,f=e-8,g=d+8,h=g+8,k=d-2048,l=d+2048;if("c"!==b.get(d))continue;if("c"!==b.get(k))continue;if("c"!==b.get(l))continue;const n=b.isBorder(e)?"":this.extract(b,f-2056),q=b.isBorder(g)?
"":this.extract(b,h-2056);if(!/[^ c]/.test(n+q)&&(b.isBorder(e)||(b.set(e,""),b.set(f,""),b.set(f-8,""),b.set(f-2048,""),b.set(f+2048,"")),b.isBorder(g)||(b.set(g,""),b.set(h,""),b.set(h+8,""),b.set(h-2048,""),b.set(h+2048,"")),this.fixed.add(d),this.fixed.add(k),this.fixed.add(l),b.set(d,"a"),a--,!a))return this.pruneDisconnected(),!0}return!1}}
class Xj extends Wj{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){const a=new Nj(this.h,this.w,this.getValidEarlyScreens()),b=2+this.random.nextInt(this.w-4);var c=2+this.random.nextInt(this.w-4);c=new Qj(a,this.h-1,c);c.go(0);c.directedPath(this.random,1,b);c.go(0);this.grid.data=a.toGrid("r").data;this.addAllFixed();return K}addEdges(){var a=-1;const b=this.h-1<<12|2056;for(var c=0;c<this.w;c++)"r"===this.grid.get(b|c<<4)&&(a=c);if(0>a)throw Error("no river on bottom edge");
c=b|this.random.nextInt(a)<<4;a=b|a+1+this.random.nextInt(this.w-1-a)<<4;this.grid.set(c,">");this.grid.set(c-8,"");this.grid.set(c+8,"");this.grid.set(a,">");this.grid.set(a-8,"");this.grid.set(a+8,"");this.fixed.add(c);this.fixed.add(a);return K}addStairs(){return K}checkMeta(a,b){a=a.traverse(b?{flight:!0,with:b}:{flight:!0});return(new Set(a.values())).size===this.maxPartitions}}
class Yj extends M{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){var a=new da(()=>[]);for(var b of this.orig.tileset)if(b.hasFeature("spikes")&&b.data.edges){var c=0;for(var d=0;4>d;d++)"s"===b.data.edges[d]&&(c|=1<<d);a.get(c).push(...b.gridTiles())}b=1+this.random.nextInt(this.w-2);d=1+this.random.nextInt(this.h-2);b|=d<<4;c=this.posToGrid(b,2056);var e=d<this.h/2?2:0;this.insertTile(b,this.random.pick(a.get(1<<e)));
for(d=4;0<=d;d--){b+=Zj[e];c+=ak[e];e^=2;const h=[];for(var f of a){const [a,b]=f;{if(!(a&1<<e))continue;const c=a&~(1<<e);if(d?c:!c)for(const c of b)h.push(a)}}var g=void 0;for(const d of this.random.ishuffle(h))if(!this.grid.isBorder(c+ak[d])&&this.insertTile(b,this.random.pick(a.get(d)))){g=31-Math.clz32(d&~(1<<e));break}if(null==g)return{ok:!1,fail:"spikes"};e=g}a=[];for(g=3;g<this.h-3;g++)for(f=1;f<this.w-1;f++)a.push(g<<12|f<<4|2056);g=!1;for(var h of this.random.ishuffle(a))if(!this.grid.get(h)){for(const b of ak)if("c"===
this.grid.get(h+b)){this.grid.set(h,"r");a=2056&~Math.abs(b);this.grid.set(h+a,"r");this.grid.set(h-a,"r");a=this.random.pick([-a,a]);this.grid.set(h+2*a,"r");this.grid.set(h+3*a,"r");this.grid.set(h+2*a-b,"c");g=!0;break}if(g)break}if(!g)return{ok:!1,fail:"nucleate river"};for(h=5+this.random.nextInt(3);0<h;h--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(h=0;h<this.grid.data.length;h++)if(this.grid.data[h]&&this.grid.isBorder(this.grid.coord(h)))return{ok:!1,fail:"border"};return K}checkMeta(a,
b){a=a.traverse(b?{flight:!0,with:b}:{flight:!0});return(new Set(a.values())).size===this.maxPartitions}refine(){return K}refineEdges(){return!0}addSpikes(){return!0}refineMetascreens(a){function b(b){return[...new Set(b.values())].filter(b=>{var c;for(const d of b)if(null===(c=a.exitType(d))||void 0===c?0:c.startsWith("stair"))return!0;return!1}).length}var c=super.refineMetascreens(a);if(!c.ok)return c;c=b(a.traverse());const d=b(a.traverse({flight:!0}));return c===d?{ok:!1,fail:"flight not required"}:
K}}const ak=[-2048,-8,2048,8],Zj=[-16,-1,16,1];
class bk extends Wj{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){var a,b=[];let c=0;for(var d of this.random.ishuffle(w(this.w-2,a=>a+1)))if(!(1===b.length&&1>=Math.pow(d-b[0],2))){var e=this.h-1<<12|d<<4|2056;this.grid.set(e,"c");this.grid.set(sh(e),"c");this.grid.set(th(e),"n");this.fixed.add(e);this.fixed.add(sh(e));this.fixed.add(th(e));b.push(d);c++;if(2===b.length)break}if(2>b.length)return{ok:!1,fail:"initial edges"};d=this.w;b=this.random.nextInt(Math.abs(b[0]-b[1])-1)+Math.min(b[0],
b[1])+1;for(e=1;e<2*this.w;e++)e!==2*b+1&&(this.grid.set(this.h-2<<12|e<<3|2048,"r"),this.fixed.add(this.h-1<<12|e<<3|2048));for(b=this.params.features.river;d<b;){e=this.tryAdd({char:"r"});if(!e)return{ok:!1,fail:`failed to extrude river\n${this.grid.show()}`};d+=e;c+=e}for(d=this.params.size;c<d;){b=this.tryAdd();if(!b)return{ok:!1,fail:"failed to extrude cave"};c+=b}return this.addStairs(...null!==(a=this.params.stairs)&&void 0!==a?a:[])}checkMeta(){return!0}refineMetascreens(a){function b(b){let c=
0;for(const d of new Set(b.values()))for(const b of d)if("edge:bottom"===a.exitType(b)){c+=d.size;break}return c}var c=super.refineMetascreens(a);if(!c.ok)return c;var d=b(a.traverse({noFlagged:!0}));c=b(a.traverse());if(d===c)return{ok:!1,fail:"bridge didn't matter"};d=b(a.traverse({flight:!0}));return c===d?{ok:!1,fail:"flight not required"}:K}}
class ck extends Wj{constructor(){super(...arguments);this.pattern="               ; rrrrrrrrrrrrr ; r           r ; r rrrrrrrrr r ; r r       r r ; r r rrrrr r r ; r r r   r r r ; r r r   r r r ; r r r   r r r ; r r r < r r r ; r r r c r r r ; r r rrrrr r r ; r r       r r ; r rrrrrrrrr r ; r           r ; rrrrrrrrrrrrr ;               ".split(";")}initialFill(){return this.insertPattern(this.pattern)}addEdges(){for(var a=0;a<this.grid.data.length;a++)if("r"===this.grid.data[a]){var b=this.grid.coord(a)-
2056;break}if(null==b)throw Error("no corner");a=[];for(let c=0;c<this.pattern.length;c++)for(let d=1;d<this.pattern[c].length-1;d++)(d^c)&1&&" "===this.pattern[c][d]&&a.push(b+(c<<11|d<<3));b=this.random.shuffle([..."ccrrrrrrrr"]);for(var c of this.random.ishuffle(a))if(a=b[b.length-1],!("c"===a&&4>[...this.extract(this.grid,c-2056)].filter(a=>"r"===a).length||(this.canSet(c,a)&&this.grid.set(c,b.pop()),b.length)))break;for(c=0;6>c;c++)this.tryAdd({char:"c"});return K}refine(){var a,b=[...null!==
(a=this.params.stairs)&&void 0!==a?a:[]];b[0]--;if(b[0]||b[1])if(a=this.addStairs(...b),!a.ok)return a;a=0;for(const c of this.random.ishuffle(this.grid.screens()))if("c"===this.extract(this.grid,c).replace(/ /g,"")&&(b[0]&&!this.grid.get(c+8)&&(this.grid.set(c+2056,"<"),b[0]--),this.fixed.add(c+2056),2<=++a))break;b=this.grid.partition();return 1<(new Set(b.values())).size?{ok:!1,fail:"orphans"}:K}fillGrid(){let a;return(a=this.initialFill(),a.ok)&&(a=this.addEdges(),a.ok)&&(a=this.refine(),a.ok)?
K:a}checkMeta(a,b){var c=a.traverse(b?{with:b}:{});b=[];for(const d of new Set(c.values())){c=0;for(const b of new Set([...d]))a.exitType(b)&&c++;b.push(c)}return 1===b.filter(a=>0<a).length}refineMetascreens(a){function b(b){let c=0;for(const d of new Set(b.values()))for(const b of d)if(a.exitType(b)){c+=d.size;break}return c}if(!this.checkMeta(a))return{ok:!1,fail:"initial checkMeta"};var c=super.refineMetascreens(a);if(!c.ok)return c;c=b(a.traverse());const d=b(a.traverse({flight:!0}));return c===
d?{ok:!1,fail:"flight not required"}:K}};class dk extends M{build(){function a(a,b){h.delete2(a,b);n.add(a*h.w+b)}var b,c,d;const {h:e,w:f}=this;var g=this.orig.rom;const h=new Nj(e,f);h.fill();var k=28>e*f?0:this.random.nextInt(e-1),l=this.random.nextInt(f);const n=new Set;n.add(k*h.w+l);l&&a(k,l-1);l<h.w-1&&a(k,l+1);k&&(a(k-1,l),l&&a(k-1,l-1),l<h.w-1&&a(k-1,l+1));for(var q of n)h.fixed.add(q);q=new Set;for(var v=0;4>v;v++){var y=v&1?e:f,A=this.random.shuffle(w(y));y=v&2?y:0;let a=null!==(c=null===(b=this.params.edges)||void 0===b?void 0:
b[v])&&void 0!==c?c:0;for(;a&&A.length;){const b=v&1?A.pop():y,c=v&1?y:A.pop(),d=b*h.w+c;h.data[d]&&!h.fixed.has(d)&&(h.addEdge(b,c,v),q.add(b<<4|c),a--)}if(a)return{ok:!1,fail:`could not add all edges: ${v} ${a}\n${h.toGrid("c").show()}\n${h.data}`}}b=0;c=h.h*h.w*(.15*this.random.next()+.4);for(var z of this.random.ishuffle(w(h.data.length<<2)))if(v=z>>>2,A=z&3,!h.isBorder(v,A)&&h.deleteEdge(v,A)&&++b>=c)break;b=new Set;c=new Set;const R=[];z=[];let G;for(var E of this.orig.tileset)if(E.hasFeature("arena"))G=
E;else if(E.hasFeature("empty"))R[0]=E;else{v=E.edgeIndex("s");if(null==v)throw Error("bad edges");((null===(d=E.data.exits)||void 0===d?0:d.some(a=>!a.type.startsWith("edge")))?z:R)[v]=E;(0>E.sid?c:b).add(E.sid)}if(!G)throw Error("never found arena");d=h.consolidate(this.random,b.size);const L=new Set(d.map(a=>R[a].sid));if(!L.size)return{ok:!1,fail:"consolidate failed"};d=[...c].filter(a=>L.has(a));E=[...b].filter(a=>!L.has(a));if(d.length>E.length)throw Error("out of space");if(d.length){for(b=
-1;g.metascreens.getById(b).length;)b--;c=b;for(v=0;v<d.length;v++)g.metascreens.renumber(E[v],b),g.metascreens.renumber(d[v],E[v]),b=d[v];g.metascreens.renumber(c,d[d.length-1])}g=new Bh(this.orig.id,this.orig.tileset,e,f);for(d=0;d<h.h;d++)for(E=0;E<h.w;E++)g.set(d<<4|E,d===k&&E===l?G:R[h.data[d*h.w+E]]);k=[...this.orig.exits()].filter(a=>!a[1].startsWith("edge")).length;for(const a of this.random.ishuffle(g.allPos())){if(!k)break;!q.has(a)&&(l=z[h.data[(a>>>4)*h.w+(a&15)]])&&(g.set(a,l),k--)}return k?
{ok:!1,fail:"could not place all doors"}:K}};function ek(a){for(const b of a.locations){a=new Set;for(const c of b.spawns)if(c.isTrigger()&&a.has(c.coord))throw Error(`Overlapping triggers on ${b} at ${c.coord.toString(16)}`);}};let fk=0;class gk{constructor(){this.name=`Area ${++fk}`}}class hk extends gk{constructor(){super(...arguments);this.type="overworld"}}class ik extends gk{constructor(){super(...arguments);this.type="town"}}class jk extends gk{constructor(){super(...arguments);this.type="connector";this.exits=[2,2]}}class kk extends gk{constructor(){super(...arguments);this.type="terminal";this.exits=[1,1]}}var O;
(function(a){a.Unused=new kk;a.ValleyOfWind=new class extends hk{constructor(){super(...arguments);this.exits=[3,6]}};a.CordelPlain=new class extends hk{constructor(){super(...arguments);this.exits=[5,8]}};a.WaterfallValley=new class extends hk{constructor(){super(...arguments);this.exits=[6,6]}};a.AngrySea=new class extends hk{constructor(){super(...arguments);this.exits=[0,0]}};a.GoaValley=new class extends hk{constructor(){super(...arguments);this.exits=[0,0]}};a.Desert1=new class extends hk{constructor(){super(...arguments);
this.exits=[0,0]}};a.Desert2=new class extends hk{constructor(){super(...arguments);this.exits=[0,0]}};a.Leaf=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Brynmaer=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Oak=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Amazones=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Nadare=new class extends ik{constructor(){super(...arguments);this.exits=
[0,0]}};a.Portoa=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Joel=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.ZombieTown=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Swan=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Shyron=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.Goa=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};
a.Sahara=new class extends ik{constructor(){super(...arguments);this.exits=[0,0]}};a.WindmillCave=new class extends jk{};a.SealedCave=new class extends jk{};a.ZebuCave=new class extends jk{};a.MtSabreWest=new class extends jk{};a.MtSabreNorth=new class extends jk{};a.LimeTreeValley=new class extends jk{};a.PortoaPalace=new class extends jk{};a.FishermanHouse=new class extends jk{};a.UndergroundChannel=new class extends jk{};a.JoelPassage=new class extends jk{};a.EvilSpiritIslandEntrance=new class extends jk{};
a.EvilSpiritIsland=new class extends jk{};a.KirisaPlantCave=new class extends jk{};a.SwanGate=new class extends jk{};a.MtHydra=new class extends jk{};a.GoaFortress=new class extends jk{};a.OasisEntrance=new class extends jk{};a.OasisCave=new class extends jk{};a.DesertCave1=new class extends jk{};a.SaharaMeadow=new class extends jk{};a.DesertCave2=new class extends jk{};a.EastCave=new class extends jk{};a.Swamp=new class extends jk{};a.Mezame=new class extends kk{};a.Windmill=new class extends kk{};
a.StomHouse=new class extends kk{};a.WaterfallCave=new class extends kk{};a.KirisaMeadow=new class extends kk{};a.FogLampCave=new class extends kk{};a.LimeTreeLake=new class extends kk{};a.Lighthouse=new class extends kk{};a.SaberaFortress=new class extends kk{};a.ShyronTemple=new class extends kk{};a.Styx=new class extends kk{};a.FortressBasement=new class extends kk{};a.Pyramid=new class extends kk{};a.Crypt=new kk;a.Tower=new kk})(O||(O={}));
for(const [a,b]of Object.entries(O))b.name=a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace("Of","of");const {$0a:lk,$0b:mk,$0c:nk,$0d:ok}=B,pk={subArea:"cave",music:a=>`${a.name}-Cave`,palette:a=>`${a.name}-Cave`},P={subArea:"house",palette:()=>Symbol()},qk={subArea:"house",palette:()=>Symbol(),music:a=>`${a.name}-FortuneTeller`},rk={name:"mesia",music:a=>`${a.name}-Mesia`,palette:a=>"Tower"===a.name?a.name:`${a.name}-Mesia`},sk={name:"dyna",music:a=>`${a.name}-Dyna`,palette:a=>`${a.name}-Dyna`},tk={name:"goa 1",music:"goa 1",palette:"goa 1"},uk={name:"goa 2",music:"goa 2",palette:"goa 2"},vk={name:"goa 3",
music:"goa 3",palette:"goa 3"},wk=Object.assign({},vk,{palette:"goa 3 upper"}),xk={name:"goa 4",music:"goa 4",palette:"goa 4"},yk=Object.assign({},xk,{palette:"goa 4 lower"}),Q=(()=>{function a(a,e){e=void 0===e?{}:e;e=Object.assign({},e);c=e.area=e.area||c;return b(a,e)}const b=me();let c;a.commit=a=>{b.commit(a,(b,c,d)=>{b=Vd(b);const e=d.area,f="function"===typeof d.music?d.music(e):null!=d.music?d.music:e.name,g="function"===typeof d.palette?d.palette(e):d.palette||e.name;b={area:e,name:b,music:f,
palette:g};null!=d.houseType&&(b.houseType=d.houseType);null!=d.subArea&&(b.subArea=d.subArea);null!=d.bossScreen&&(b.bossScreen=d.bossScreen);d=new zk(a.rom,c,b);0<=c&&(a[c]=d);return d})};return a})();
class Ak extends Array{constructor(a){super(256);this.rom=a;this.MezameShrine=Q(0,{area:O.Mezame});this.Leaf_OutsideStart=Q(1,{music:1});this.Leaf=Q(2,{area:O.Leaf});this.ValleyOfWind=Q(3,{area:O.ValleyOfWind});this.SealedCave1=Q(4,{area:O.SealedCave});this.SealedCave2=Q(5);this.SealedCave6=Q(6);this.SealedCave4=Q(7);this.SealedCave5=Q(8);this.SealedCave3=Q(9);this.SealedCave7=Q(10,{bossScreen:145});this.SealedCave8=Q(12);this.WindmillCave=Q(14,{area:O.WindmillCave});this.Windmill=Q(15,{area:O.Windmill,
music:0,houseType:"outside"});this.ZebuCave=Q(16,{area:O.ZebuCave});this.MtSabreWest_Cave1=Q(17,Object.assign({},{area:O.MtSabreWest},pk));this.CordelPlainWest=Q(20,{area:O.CordelPlain});this.CordelPlainEast=Q(21);this.Brynmaer=Q(24,{area:O.Brynmaer});this.OutsideStomHouse=Q(25,{area:O.StomHouse,music:0});this.Swamp=Q(26,{area:O.Swamp,bossScreen:124});this.Amazones=Q(27,{area:O.Amazones,fixed:[13,14]});this.Oak=Q(28,{area:O.Oak});this.StomHouse=Q(30,{area:O.StomHouse,houseType:"outside"});this.MtSabreWest_Lower=
Q(32,{area:O.MtSabreWest});this.MtSabreWest_Upper=Q(33);this.MtSabreWest_Cave2=Q(34,pk);this.MtSabreWest_Cave3=Q(35,pk);this.MtSabreWest_Cave4=Q(36,pk);this.MtSabreWest_Cave5=Q(37,pk);this.MtSabreWest_Cave6=Q(38,pk);this.MtSabreWest_Cave7=Q(39,pk);this.MtSabreNorth_Main=Q(40,{area:O.MtSabreNorth,bossScreen:181});this.MtSabreNorth_Middle=Q(41);this.MtSabreNorth_Cave2=Q(42,pk);this.MtSabreNorth_Cave3=Q(43,pk);this.MtSabreNorth_Cave4=Q(44,pk);this.MtSabreNorth_Cave5=Q(45,pk);this.MtSabreNorth_Cave6=
Q(46,pk);this.MtSabreNorth_PrisonHall=Q(47,pk);this.MtSabreNorth_LeftCell=Q(48,pk);this.MtSabreNorth_LeftCell2=Q(49,pk);this.MtSabreNorth_RightCell=Q(50,pk);this.MtSabreNorth_Cave8=Q(51,pk);this.MtSabreNorth_Cave9=Q(52,pk);this.MtSabreNorth_SummitCave=Q(53,pk);this.MtSabreNorth_Cave1=Q(56,pk);this.MtSabreNorth_Cave7=Q(57,pk);this.Nadare_Inn=Q(60,Object.assign({},{area:O.Nadare},P));this.Nadare_ToolShop=Q(61,Object.assign({},P,{houseType:"tool"}));this.Nadare_BackRoom=Q(62,Object.assign({},P,{houseType:"house"}));
this.WaterfallValleyNorth=Q(64,{area:O.WaterfallValley});this.WaterfallValleySouth=Q(65);this.LimeTreeValley=Q(66,{area:O.LimeTreeValley,music:0});this.LimeTreeLake=Q(67,{area:O.LimeTreeLake,music:0});this.KirisaPlantCave1=Q(68,{area:O.KirisaPlantCave});this.KirisaPlantCave2=Q(69);this.KirisaPlantCave3=Q(70);this.KirisaMeadow=Q(71,{area:O.KirisaMeadow});this.FogLampCave1=Q(72,{area:O.FogLampCave});this.FogLampCave2=Q(73);this.FogLampCave3=Q(74);this.FogLampCaveDeadEnd=Q(75);this.FogLampCave4=Q(76);
this.FogLampCave5=Q(77);this.FogLampCave6=Q(78);this.FogLampCave7=Q(79);this.Portoa=Q(80,{area:O.Portoa});this.Portoa_FishermanIsland=Q(81,{area:O.FishermanHouse,music:0});this.MesiaShrine=Q(82,Object.assign({},{area:O.LimeTreeLake},rk));this.WaterfallCave1=Q(84,{area:O.WaterfallCave});this.WaterfallCave2=Q(85);this.WaterfallCave3=Q(86);this.WaterfallCave4=Q(87);this.TowerEntrance=Q(88,{area:O.Tower});this.Tower1=Q(89);this.Tower2=Q(90);this.Tower3=Q(91);this.TowerOutsideMesia=Q(92);this.TowerOutsideDyna=
Q(93);this.TowerMesia=Q(94,rk);this.TowerDyna=Q(95,sk);this.AngrySea=Q(96,{area:O.AngrySea});this.BoatHouse=Q(97,{houseType:"outside"});this.JoelLighthouse=Q(98,{area:O.Lighthouse,music:0,houseType:"outside"});this.UndergroundChannel=Q(100,{area:O.UndergroundChannel});this.ZombieTown=Q(101,{area:O.ZombieTown});this.EvilSpiritIsland1=Q(104,{area:O.EvilSpiritIslandEntrance,music:1});this.EvilSpiritIsland2=Q(105,{area:O.EvilSpiritIsland});this.EvilSpiritIsland3=Q(106);this.EvilSpiritIsland4=Q(107);this.SaberaPalace1=
Q(108,{area:O.SaberaFortress,bossScreen:253,houseType:"palace"});this.SaberaPalace2=Q(109);this.SaberaPalace2_West=Q(-1);this.SaberaPalace3=Q(110,{bossScreen:253});this.JoelSecretPassage=Q(112,{area:O.JoelPassage});this.Joel=Q(113,{area:O.Joel});this.Swan=Q(114,{area:O.Swan,music:1});this.SwanGate=Q(115,{area:O.SwanGate,music:1});this.GoaValley=Q(120,{area:O.GoaValley});this.MtHydra=Q(124,{area:O.MtHydra});this.MtHydra_Cave1=Q(125,pk);this.MtHydra_OutsideShyron=Q(126,{fixed:[13,14]});this.MtHydra_Cave2=
Q(127,pk);this.MtHydra_Cave3=Q(128,pk);this.MtHydra_Cave4=Q(129,pk);this.MtHydra_Cave5=Q(130,pk);this.MtHydra_Cave6=Q(131,pk);this.MtHydra_Cave7=Q(132,pk);this.MtHydra_Cave8=Q(133,pk);this.MtHydra_Cave9=Q(134,pk);this.MtHydra_Cave10=Q(135,pk);this.Styx1=Q(136,{area:O.Styx,houseType:"palace"});this.Styx2=Q(137);this.Styx2_East=Q(-1);this.Styx3=Q(138);this.Shyron=Q(140,{area:O.Shyron});this.Goa=Q(142,{area:O.Goa});this.GoaFortressBasement=Q(143,{area:O.FortressBasement,music:0});this.Desert1=Q(144,
{area:O.Desert1});this.OasisCaveMain=Q(145,{area:O.OasisCave});this.DesertCave1=Q(146,{area:O.DesertCave1,music:0});this.Sahara=Q(147,{area:O.Sahara});this.SaharaOutsideCave=Q(148,{music:0});this.DesertCave2=Q(149,{area:O.DesertCave2,music:1});this.SaharaMeadow=Q(150,{area:O.SaharaMeadow,music:0});this.Desert2=Q(152,{area:O.Desert2});this.Pyramid_Entrance=Q(156,{area:O.Pyramid,houseType:"palace"});this.Pyramid_Branch=Q(157);this.Pyramid_Main=Q(158);this.Pyramid_Draygon=Q(159);this.Crypt_Entrance=
Q(160,{area:O.Crypt});this.Crypt_Hall1=Q(161);this.Crypt_Branch=Q(162);this.Crypt_DeadEndLeft=Q(163);this.Crypt_DeadEndRight=Q(164);this.Crypt_Hall2=Q(165);this.Crypt_Draygon2=Q(166);this.Crypt_Teleporter=Q(167,{music:"Crypt-Teleporter"});this.GoaFortress_Entrance=Q(168,{area:O.GoaFortress,music:1,houseType:"palace"});this.GoaFortress_Kelbesque=Q(169,Object.assign({},{bossScreen:115},tk));this.GoaFortress_Zebu=Q(170,Object.assign({},tk,{palette:1}));this.GoaFortress_Sabera=Q(171,uk);this.GoaFortress_Tornel=
Q(172,Object.assign({},{bossScreen:145},uk,{palette:1}));this.GoaFortress_Mado1=Q(173,vk);this.GoaFortress_Mado2=Q(174,wk);this.GoaFortress_Mado3=Q(175,wk);this.GoaFortress_Karmine1=Q(176,xk);this.GoaFortress_Karmine2=Q(177,xk);this.GoaFortress_Karmine3=Q(178,xk);this.GoaFortress_Karmine4=Q(179,xk);this.GoaFortress_Karmine5=Q(180,xk);this.GoaFortress_Karmine6=Q(181,yk);this.GoaFortress_Karmine7=Q(182,Object.assign({},{bossScreen:253},yk));this.GoaFortress_Exit=Q(183,{music:0});this.OasisCave_Entrance=
Q(184,{area:O.OasisEntrance,music:2});this.GoaFortress_Asina=Q(185,Object.assign({},{area:O.GoaFortress},wk,{bossScreen:145}));this.GoaFortress_Kensu=Q(186,xk);this.Goa_House=Q(187,Object.assign({},{area:O.Goa},P,{houseType:"house"}));this.Goa_Inn=Q(188,Object.assign({},P,{houseType:"inn"}));this.Goa_ToolShop=Q(190,Object.assign({},P,{houseType:"tool"}));this.Goa_Tavern=Q(191,Object.assign({},P,{houseType:"tavern"}));this.Leaf_ElderHouse=Q(192,Object.assign({},{area:O.Leaf},P,{houseType:"house"}));
this.Leaf_RabbitHut=Q(193,Object.assign({},P,{houseType:"shed"}));this.Leaf_Inn=Q(194,Object.assign({},P,{houseType:"inn"}));this.Leaf_ToolShop=Q(195,Object.assign({},P,{houseType:"tool"}));this.Leaf_ArmorShop=Q(196,Object.assign({},P,{houseType:"armor"}));this.Leaf_StudentHouse=Q(197,Object.assign({},P,{houseType:"house"}));this.Brynmaer_Tavern=Q(198,Object.assign({},{area:O.Brynmaer},P,{houseType:"tavern"}));this.Brynmaer_PawnShop=Q(199,Object.assign({},P,{houseType:"pawn"}));this.Brynmaer_Inn=
Q(200,Object.assign({},P,{houseType:"inn"}));this.Brynmaer_ArmorShop=Q(201,Object.assign({},P,{houseType:"armor"}));this.Brynmaer_ItemShop=Q(203,Object.assign({},P,{houseType:"tool"}));this.Oak_ElderHouse=Q(205,Object.assign({},{area:O.Oak},P,{houseType:"house"}));this.Oak_MotherHouse=Q(206,Object.assign({},P,{houseType:"house"}));this.Oak_ToolShop=Q(207,Object.assign({},P,{houseType:"tool"}));this.Oak_Inn=Q(208,Object.assign({},P,{houseType:"inn"}));this.Amazones_Inn=Q(209,Object.assign({},{area:O.Amazones},
P,{houseType:"inn"}));this.Amazones_ItemShop=Q(210,Object.assign({},P,{houseType:"tool"}));this.Amazones_ArmorShop=Q(211,Object.assign({},P,{houseType:"armor"}));this.Amazones_Elder=Q(212,Object.assign({},P,{houseType:"house",fixed:[13,14]}));this.Nadare=Q(213,{area:O.Nadare});this.Portoa_FishermanHouse=Q(214,Object.assign({},{area:O.FishermanHouse},P,{music:0,houseType:"outside"}));this.Portoa_PalaceEntrance=Q(215,{area:O.PortoaPalace,houseType:"palace"});this.Portoa_FortuneTeller=Q(216,Object.assign({},
{area:O.Portoa,fixed:[13,14]},qk,{houseType:"house"}));this.Portoa_PawnShop=Q(217,Object.assign({},P,{houseType:"pawn"}));this.Portoa_ArmorShop=Q(218,Object.assign({},P,{houseType:"armor"}));this.Portoa_Inn=Q(220,Object.assign({},P,{houseType:"inn"}));this.Portoa_ToolShop=Q(221,Object.assign({},P,{houseType:"tool"}));this.PortoaPalace_Left=Q(222,Object.assign({},{area:O.PortoaPalace},P,{houseType:"house"}));this.PortoaPalace_ThroneRoom=Q(223,P);this.PortoaPalace_Right=Q(224,Object.assign({},P,{houseType:"house"}));
this.Portoa_AsinaRoom=Q(225,Object.assign({},{area:O.UndergroundChannel},P,{music:"asina"}));this.Amazones_ElderDownstairs=Q(226,Object.assign({},{area:O.Amazones},P));this.Joel_ElderHouse=Q(227,Object.assign({},{area:O.Joel},P,{houseType:"house"}));this.Joel_Shed=Q(228,Object.assign({},P,{houseType:"shed"}));this.Joel_ToolShop=Q(229,Object.assign({},P,{houseType:"tool"}));this.Joel_Inn=Q(231,Object.assign({},P,{houseType:"inn"}));this.ZombieTown_House=Q(232,Object.assign({},{area:O.ZombieTown},P,
{houseType:"house"}));this.ZombieTown_HouseBasement=Q(233,P);this.Swan_ToolShop=Q(235,Object.assign({},{area:O.Swan},P,{houseType:"tool"}));this.Swan_StomHut=Q(236,Object.assign({},P,{houseType:"shed"}));this.Swan_Inn=Q(237,Object.assign({},P,{houseType:"inn"}));this.Swan_ArmorShop=Q(238,Object.assign({},P,{houseType:"armor"}));this.Swan_Tavern=Q(239,Object.assign({},P,{houseType:"tavern"}));this.Swan_PawnShop=Q(240,Object.assign({},P,{houseType:"pawn"}));this.Swan_DanceHall=Q(241,Object.assign({},
P,{houseType:"house"}));this.Shyron_Temple=Q(242,{area:O.ShyronTemple,bossScreen:112,houseType:"palace"});this.Shyron_TrainingHall=Q(243,Object.assign({},{area:O.Shyron},P,{houseType:"house"}));this.Shyron_Hospital=Q(244,Object.assign({},P,{houseType:"house"}));this.Shyron_ArmorShop=Q(245,Object.assign({},P,{houseType:"armor"}));this.Shyron_ToolShop=Q(246,Object.assign({},P,{houseType:"tool"}));this.Shyron_Inn=Q(247,Object.assign({},P,{houseType:"inn"}));this.Sahara_Inn=Q(248,Object.assign({},{area:O.Sahara},
P,{houseType:"inn"}));this.Sahara_ToolShop=Q(249,Object.assign({},P,{houseType:"tool"}));this.Sahara_ElderHouse=Q(250,Object.assign({},P,{houseType:"house"}));this.Sahara_PawnShop=Q(251,Object.assign({},P,{houseType:"pawn"}));this.EastCave1=Q(-1,{area:O.EastCave});this.EastCave2=Q(-1);this.EastCave3=Q(-1);this.FishermanBeach=Q(-1,Object.assign({},{area:O.FishermanHouse},P));this.locsByScreen=new da(()=>[]);Q.commit(this);for(let b=0;256>b;b++)this[b]?this.indexScreens(this[b]):this[b]=new zk(a,b,
{area:O.Unused,name:"",music:"",palette:""})}indexScreens(a){for(const b of a.screens)for(const c of b)this.locsByScreen.get(c).push(a)}renumberScreen(a,b){var c=this.locsByScreen.get(a);this.locsByScreen.set(b,c);this.locsByScreen.delete(a);for(const d of c)for(const e of d.screens)for(c=0;c<e.length;c++)e[c]===a&&(e[c]=b)}allocate(a,b){for(const c of this)if(!(c.used||b&&c.id<b.id))return a.id=c.id,a.used=!0,this.indexScreens(a),this[c.id]=a;throw Error("No unused location");}write(){const a=this.rom.assembler();
ye(a,lk,34040,40960);ye(a,mk,40960,48640);ye(a,nk,37881,40960);ye(a,ok,40960,44032);ye(a,ok,44544,49152);for(const b of this)b.assemble(a);return[a.module()]}location(){}}
class zk extends ug{constructor(a,b,c){super(a,b);this.data=c;this.monstersMoved=!1;this._meta=this._isShop=void 0;var d=0<=b?ee(a.prg,this.mapDataPointer)+49152:0;if(this.used=49152<d&&!!this.name){var e=ee(a.prg,d)+49152;c=ee(a.prg,d+2)+49152;var f=ee(a.prg,d+4)+49152,g=ee(a.prg,d+6)+49152,h=ee(a.prg,d+8)+49152,k=this.used&&e!==d+10,l=g-f;this.exits=(()=>{const b=[];let c=g;for(;!(a.prg[c]&128);)255!=a.prg[c+2]&&b.push(vh.from(a.prg,c)),c+=4;255!==a.prg[c]&&(k=!!(a.prg[c]&64),l=(a.prg[c]&31)<<2);
return b})();d=k?ee(a.prg,d+10)+49152:0;this.bgm=this.originalBgm=a.prg[e];this.layoutWidth=a.prg[e+1];this.layoutHeight=a.prg[e+2];this.animation=a.prg[e+3];var n=a.prg[e+4]?256:0;this.screens=w(this.height,b=>Xd(a.prg,e+5+b*this.width,this.width).map(a=>n|a));this.tilePalettes=Xd(a.prg,c,3);this.originalTilePalettes=Xd(this.tilePalettes,0,3);this.tileset=a.prg[c+3];this.tileEffects=a.prg[c+4];this.tilePatterns=Xd(a.prg,c+5,2);this.entrances=ae(4,a.prg.slice(f,f+l),a=>uh.from(a));this.flags=Zd(a.prg,
h,2,255,Infinity,a=>wh.from(a));this.pits=d?Zd(a.prg,d,4,255,Infinity,a=>xh.from(a)):[];c=ee(a.prg,this.npcDataPointer)+65536;this.spritePalettes=(f=65536!==c)?Xd(a.prg,c+1,2):[0,0];this.spritePatterns=f?Xd(a.prg,c+3,2):[0,0];this.spawns=f?Zd(a.prg,c+5,4,255,Infinity,a=>yh.from(a)):[];this.checkpoint=!!(a.prg[196352|b]&128);this.saveable=!!(a.prg[196352|b]&1)}else this.animation=this.layoutHeight=this.layoutWidth=this.bgm=this.originalBgm=0,this.screens=[[0]],this.tilePalettes=[36,1,38],this.originalTilePalettes=
[36,1,38],this.tileset=128,this.tileEffects=179,this.tilePatterns=[2,4],this.exits=[],this.entrances=[],this.flags=[],this.pits=[],this.spawns=[],this.spritePalettes=[0,0],this.spritePatterns=[0,0],this.checkpoint=this.saveable=!1}set meta(a){this._meta=a}get meta(){this.ensureMeta();return this._meta}ensureMeta(){this._meta||(this._meta=Bh.of(this))}set musicGroup(a){this._musicGroup=a}get musicGroup(){this.ensureMusicGroup();return this._musicGroup}ensureMusicGroup(){if(null==this._musicGroup){const a=
this.data.music;this._musicGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].musicGroup}}set colorGroup(a){this._colorGroup=a}get colorGroup(){this.ensureColorGroup();return this._colorGroup}ensureColorGroup(){if(null==this._colorGroup){const a=this.data.music;this._colorGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].colorGroup}}lazyInitialization(){this.ensureMeta();this.ensureMusicGroup();this.ensureColorGroup()}get name(){return this.data.name}get mapDataPointer(){if(0>
this.id)throw Error(`no mapdata pointer for ${this.name}`);return 82688+(this.id<<1)}get npcDataPointer(){if(0>this.id)throw Error(`no npcdata pointer for ${this.name}`);return 102913+(this.id<<1)}get hasSpawns(){return 0<this.spawns.length}mapPlane(){var a=new da(()=>new Set);for(const b of this.screens)for(const c of b)a.get(c>>>8).add(c);if(1!==a.size)throw Error(`Non-unique screen page for ${this}: ${[...a.values()].map(a=>[...a].map(a=>{var b;const [c]=this.rom.metascreens.getById(a);return`${x(a)} ${null!==
(b=null===c||void 0===c?void 0:c.name)&&void 0!==b?b:"??"}`}).join(", ")).join(", ")}`);[a]=a.keys();return a}isShop(){null==this._isShop&&(this._isShop=0<=this.rom.shops.findIndex(a=>a.location===this.id),251===this.id&&(this._isShop=!0));return this._isShop}spawn(a){const b=this.spawns[a-13];if(!b)throw Error(`Expected spawn $${x(a)}`);return b}get width(){return this.layoutWidth+1}set width(a){this.layoutWidth=a-1}get height(){return this.layoutHeight+1}set height(a){this.layoutHeight=a-1}findOrAddEntrance(a,
b){for(let c=0;c<this.entrances.length;c++){const d=this.entrances[c];if(d.screen===a&&d.coord===b)return c}this.entrances.push(uh.of({screen:a,coord:b}));return this.entrances.length-1}assemble(a){if(this.used){var b=this.id.toString(16).padStart(2,"0"),c=this.spawns.length?this.spritePalettes:[255,255],d=this.spawns.length?this.spritePatterns:[255,255],e=[];d=[0,...c,...d,...ce(this.spawns),255];a.segment("0c","0d");a.reloc(`NpcData_${b}`);var f=a.pc();a.byte(...d);a.org(37377+(this.id<<1),`NpcData_${b}_Ptr`);
a.word(f);a.segment("17");a.org(48896|this.id);a.byte(+this.checkpoint<<7|+this.saveable);a.segment("0a","0b");d=[];for(var g of ce(this.screens))d.push(g&255);g=this.rom.compressedMapData?[this.bgm,this.layoutHeight<<4|this.layoutWidth,this.mapPlane()<<2|this.animation,...d]:[this.bgm,this.layoutWidth,this.layoutHeight,this.animation,this.mapPlane()?128:0,...d];a.reloc(`MapData_${b}_Layout`);d=a.pc();a.byte(...g);e.push(d);a.reloc(`MapData_${b}_Graphics`);g=a.pc();a.byte(...this.tilePalettes,this.tileset,
this.tileEffects,...this.tilePatterns);e.push(g);if(1===this.height){for(var h of this.entrances)h.used&&191<h.y&&(h.y=191);for(var k of this.exits)12<k.yt&&(k.yt=12)}a.reloc(`MapData_${b}_Entrances`);h=a.pc();a.byte(...ce(this.entrances));e.push(h);a.reloc(`MapData_${b}_Exits`);h=a.pc();a.byte(...ce(this.exits),128|(this.pits.length?64:0)|this.entrances.length);e.push(h);a.reloc(`MapData_${b}_Flags`);h=a.pc();a.byte(...ce(this.flags),255);e.push(h);h=ce(this.pits);h.length&&(a.reloc(`MapData_${b}_Pits`),
k=a.pc(),a.byte(...h),e.push(k));a.reloc(`MapData_${b}`);h=a.pc();a.word(...e);a.org(33536+(this.id<<1),`MapData_${b}_Ptr`);a.word(h);b=this.bossId();if(null!=b&&95!==this.id){e=this.rom.bossKills[b].base;h=[,,,166===this.id?0:this.bgm,,...this.tilePalettes,,,,this.spritePalettes[0],,,,,,,,this.animation];a.segment("0f");for(k=0;k<h.length;k++)g=h[k],null!=g&&(a.org(e+k,`Boss_${b}_${k}`),a.byte(g));a.org(47041+5*b,`Boss_${b}_Post`);a.byte(c[1])}}}allScreens(){const a=new Set;for(const b of this.screens)for(const c of b)a.add(this.rom.screens[c]);
return a}bossId(){for(let a=0;14>a;a++)if(this.rom.prg[129373+a]===this.id)return a}hasDolphin(){return 96===this.id||100===this.id||104===this.id}isTower(){return 88===(this.id&248)}reachableTiles(a){a=void 0===a?!1:a;this.hasDolphin()&&(a=!0);const b=new Set(this.exits.map(a=>a.screen<<8|a.tile));var c=new Fg;const d=this.rom.tilesets[this.tileset],e=this.rom.tileEffects[this.tileEffects-179];var f=new Set;for(let c=0;c<this.height;c++){const h=this.screens[c];for(let k=0;k<this.width;k++){const l=
this.rom.screens[h[k]],n=c<<4|k,y=this.flags.find(a=>a.screen===n);for(let c=0;240>c;c++){const h=n<<8|c;if(b.has(h))continue;let k=l.tiles[c];var g=e.effects[k];g=a?g&4:g&6;y&&g&&32>k&&d.alternates[k]!=k&&(k=d.alternates[k],g=e.effects[k],g=a?g&4:g&6);g||f.add(h)}}}for(let b of f)a=15===(b&15)?b+241:b+1,f.has(a)&&c.union([b,a]),a=224===(b&240)?b+3872:b+16,f.has(a)&&c.union([b,a]);f=c.map();c=new Set;for(var h of this.entrances)h.used&&c.add(f.get(h.screen<<8|h.tile)||new Set);h=new Map;for(const a of c)for(const b of a)h.set(b,
e.effects[this.rom.screens[this.screens[b>>>12][b>>>8&15]].tiles[b&255]]);return h}screenMover(){const a=new da(()=>[]),b=ha.concat(this.spawns,this.exits,this.entrances);for(const c of b)a.get(c.screen).push(c);return(b,d)=>{for(const c of a.get(b))c.screen=d}}moveScreen(a,b){const c=ha.concat(this.spawns,this.exits,this.entrances);for(const d of c)d.screen===a&&(d.screen=b)}monsterPlacer(a){this.monstersMoved=!0;const b=this.data.bossScreen,c=this.reachableTiles(!1),d=new Map([...c.keys()].map(a=>
[a,0])),e=[],f=[],g=[],h=[],k=[],l=this.hasDolphin()?37:39;for(const a of d){const [k,n]=a;{const a=this.screens[k>>>12][k>>>8&15];if(a!==b){for(const a of Bk(k,this.width,this.height))d.has(a)||d.set(a,n+1);n||c.get(k)&l||e.push(k);26===this.id?240===this.rom.screens[a].tiles[k&255]&&h.push(k):2<=n&&4>=n&&h.push(k);3<=n&&7>=n&&f.push(k);12<=n&&g.push(k)}}}return b=>{const c=b.clearance();var d=b.placement();d=[..."normal"===d?e:"moth"===d?f:"bird"===d?g:"plant"===d?h:oa(d)];let l;a:for(;d.length;){var n=
a.nextInt(d.length),[z]=d.splice(n,1);n=(z&3840)>>>4|z&15;z=(z&61440)>>>8|(z&240)>>>4;for(const a of this.entrances){const {x:b,y:d,used:e}=a;if(e&&Math.pow(z-(d>>4),2)+Math.pow(n-(b>>4),2)<Math.pow(c+1,2))continue a}for(const a of this.exits){if(!a.isSeamless())continue;const {x:b,y:d}=a;if(Math.pow(z-(d>>4),2)+Math.pow(n-(b>>4),2)<Math.pow(c+8,2))continue a}for(const a of k){const [,b,d,e]=a;{const a=Math.pow(z-d,2)+Math.pow(n-b,2);if(!a)continue a;if(a<Math.pow(c+e,2)){if(!l||l[2]<a)l=[n,z,a];
continue a}}}l=[n,z,Infinity];break}if(l){const [a,d]=l;k.push([b,a,d,c]);return(d&240|(a&240)>>>4)<<8|(d&15)<<4|a&15}}}resizeScreens(a,b,c,d,e){e=void 0===e?0:e;const f=this.width+b+d;c=this.height+a+c;d=Array.from({length:c},(c,d)=>{d-=a;return Array.from({length:f},(a,c)=>{c-=b;return 0>d||0>c||d>=this.height||c>=this.width?e:this.screens[d][c]})});this.width=f;this.height=c;this.screens=d;for(const c of this.flags)c.xs+=b,c.ys+=a;for(const c of this.pits)c.fromXs+=b,c.fromYs+=a;for(const c of[...this.spawns,
...this.exits])c.xt+=16*b,c.yt+=16*a;for(const c of this.entrances)c.used&&(c.x+=256*b,c.y+=256*a)}writeScreens2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){let f=e[b];null!=f&&(0>f&&(f=~f,this.flags.push(wh.of({screen:a+d<<4|c+b,flag:this.rom.flags.AlwaysTrue.id}))),this.screens[a+d][c+b]=f)}}}connect(a,b,c){var d=0>a?256:0,e=0>c?256:0;a=0>a?~a:a;c=0>c?~c:c;const f=a>>>4,g=a&15,h=c>>>4,k=c&15,l=b.screens[h][k],[n,q]=Ck[d|this.screens[f][g]],[v,y]=
Ck[e|l];d=this.entrances.length;e=b.entrances.length;this.entrances.push(uh.of({y:f<<8|n>>>8,x:g<<8|n&255}));b.entrances.push(uh.of({y:h<<8|v>>>8,x:k<<8|v&255}));for(const c of q)this.exits.push(vh.of({screen:a,tile:c,dest:b.id,entrance:e}));for(const a of y)b.exits.push(vh.of({screen:c,tile:a,dest:this.id,entrance:d}))}neighborForEntrance(a){const b=this.entrances[a];if(!b)throw Error(`no entrance ${x(this.id)}:${a}`);for(const a of this.exits){if(a.screen!==b.screen)continue;const c=Math.abs(a.y-
b.y);if(24>Math.abs(a.x-b.x)&&24>c)return this.rom.locations[a.dest]}throw Error(`no exit found near ${x(this.id)}:${a}`);}toString(){return`${super.toString()} ${this.name}`}}function Bk(a,b,c){const d=[],e=a&61680,f=a&3855;e<(c-1<<12|224)&&d.push(224===(a&240)?a+3872:a+16);e&&d.push(0===(a&240)?a-3872:a-16);f<(b-1<<8|15)&&d.push(15===(a&15)?a+241:a+1);f&&d.push(0===(a&15)?a-241:a-1);return d}
const Ck={21:[37024,[137,138]],25:[24720,[88,89]],150:[16432,[50,51]],151:[44848,[178,179]],152:[16592,[60,61]],153:[45008,[188,189]],154:[8064,[39,40]],158:[57216,[231,232]],193:[20640,[73,74]],194:[24752,[90,91]],410:[53376,[199,200]]};function Dk(a){if(!a.compressedMapData){a.compressedMapData=!0;for(let b=0;3>b;b++)a.metascreens.renumber(256|b,320|b),delete a.screens[256|b]}}
function Ek(a){if(!a.compressedMapData)throw Error("Must compress first");const {town:b,cave:c,pyramid:d,lime:e,mountain:f,shrine:g,mountainRiver:h,swamp:k,house:l,fortress:n,labyrinth:q,iceCave:v,tower:y}=a.metatilesets;a.moveScreens([k],4);a.moveScreens([l],4);a.moveScreens([b],4);a.moveScreens([e],4);a.moveScreens([g],4);a.moveScreens([y],4);a.moveScreens([f,h],4);a.moveScreens([c,d,n,q,v],5)};function Fk(a,b){var c=a.objects[159],d=a.objects[127];const e=a.objects[141];e.used=!0;e.name="Crumbling Horizontal Platform";e.sfx=c.sfx;c.data.forEach((a,b)=>e.data[b]=a);e.data[3]=d.data[3];c=new Set([47,61]);d=new Set([46,79]);for(const e of a.locations)if(e.pits.length){a=1>b.nextInt(3);for(const b of e.spawns)b.isMonster()&&(d.has(b.id)&&(b.id=(a?159:126)-80),c.has(b.id)&&(b.id=(a?141:127)-80))}};class Gk extends we{constructor(){super(...arguments);this.action=this.prop([0,248,3]);this.part=this.prop([0,7,-3],[1,224,5]);this.index=this.prop([1,31])}toString(){const a=this.action?` (action ${x(this.action)})`:"";return`MessageId ${this.hex()}: (${x(this.part)}:${x(this.index)}${a}`}get mid(){return`${x(this.part)}:${x(this.index)}`}set mid(a){const b=a.split(":");if(2!==b.length)throw Error(`oops: ${a}`);this.part=Number.parseInt(b[0],16);this.index=Number.parseInt(b[1],16);if(isNaN(this.part)||
isNaN(this.index))throw Error(`oops: ${a}`);}nonzero(){return!(!this.part&&!this.index)}}Gk.size=2;const {$04:Hk,$05:Ik,$0e:Jk,$1b:Kk,$fe:Lk}=B;
class Mk extends vg{constructor(a){super(205);this.rom=a;this.GoaSoldier=new S(this,11);this.LeafElder=new S(this,13);this.LeafElderDaughter=new S(this,17);this.LeafRabbit=new S(this,19);this.WindmillGuard=new S(this,20);this.SleepingWindmillGuard=new S(this,21);this.Akahana=new S(this,22);this.OakElder=new S(this,29);this.OakMother=new S(this,30);this.OakChild=new S(this,31);this.Aryllis=new S(this,35);this.AmazonesGuard=new S(this,37);this.AryllisRightAttendant=new S(this,38);this.AryllisLeftAttendant=
new S(this,39);this.Nadare=new S(this,40);this.SoldierGuard=new S(this,45);this.PortoaThroneRoomBackDoorGuard=new S(this,51);this.PortoaPalaceFrontGuard=new S(this,52);this.PortoaQueen=new Nk(this,56);this.FortuneTeller=new S(this,57);this.WaterfallCaveAdventurers=new S(this,58);this.JoelElder=new S(this,61);this.Clark=new S(this,68);this.ShyronGuard=new S(this,78);this.Brokahana=new S(this,84);this.SaharaBunny=new S(this,89);this.Deo=new S(this,90);this.SaharaElder=new S(this,91);this.SaharaElderDaughter=
new S(this,92);this.Zebu=new S(this,94);this.Tornel=new S(this,95);this.Stom=new S(this,96);this.MesiaRecording=new S(this,97);this.Asina=new S(this,98);this.HurtDolphin=new S(this,99);this.Fisherman=new S(this,100);this.StartledVillagerOutsideCave=new S(this,101);this.KensuInCabin=new S(this,104);this.Dolphin=new Ok(this,105);this.SleepingKensu=new S(this,107);this.KensuDisguisedAsDancer=new S(this,108);this.KensuDisguisedAsSoldier=new S(this,109);this.AztecaInShyron=new S(this,110);this.DeadAkahana=
new S(this,112);this.DeadStomsGirlfriend=new S(this,113);this.DeadStom=new S(this,114);this.KensuInSwan=new S(this,116);this.SlimedKensu=new S(this,117);this.FishermanDaughter=new S(this,123);this.Kensu=new S(this,126);this.AkahanaInBrynmaer=new S(this,130);this.AztecaInPyramid=new S(this,131);this.SaberaDisguisedAsMesia=new S(this,132);this.StonedWaterfallCaveAdventurers=new S(this,133);this.StonedAkahana=new S(this,136);this.Mesia=new S(this,142);this.Vampire1=new S(this,192);this.Insect=new S(this,
193);this.Kelbesque1=new S(this,194);this.Rage=new S(this,195);this.Kelbesque2=new S(this,197);this.Sabera2=new S(this,198);this.Mado2=new S(this,199);this.Karmine=new S(this,200);this.StatueOfMoon=new S(this,201);this.StatueOfSun=new S(this,202);this.Draygon=new S(this,203);this.Vampire2=new S(this,204);for(var b in this){const a=this[b];this.hasOwnProperty(b)&&a instanceof S&&(this[a.id]=a,a.name=Vd(b))}for(b=0;205>b;b++)this[b]||(this[b]=new S(this,b));const c=Pk.readAddress(a.prg);this.movementScripts=
w(16,b=>{b=c.plus(2*b).readAddress(a.prg).offset;const d=[];for(;128>a.prg[b];)d.push(a.prg[b++]);return{steps:d,terminate:a.prg[b]}})}write(){const a=this.rom.assembler();for(var b of this)b&&b.used&&b.assemble(a);ye(a,Kk,44804,44969);b=[];a.segment("1b","fe","ff");let c=0;for(var d of this.movementScripts){const e=(a.reloc(`MovementScript_${x(c++)}`),a.pc());a.byte(...d.steps,d.terminate);b.push(e)}d=(a.reloc("MovementScriptTable"),a.pc());a.word(...b);Pk.loc(a,"MovementScriptTablePtr");a.word(d);
Pk.plus(5).loc(a,"MovementScriptTablePlus1Ptr");a.word({op:"+",args:[d,{op:"num",num:1}]});return[a.module()]}}
class S extends ug{constructor(a,b){super(a.rom,b);this.npcs=a;this.spawnConditions=new Map;this.localDialogs=new Map;a=a.rom;if(204<b)throw Error(`Unavailable: ${b}`);this._used=!Qk.has(b)&&(143>b||192<=b);(b=196>b?this.dialogPointer.readAddress(a.prg):null)&&35641===b.org&&(b=null);this.data=Xd(a.prg,this.dataBase.offset,4);for(var c=this.spawnPointer.readAddress(a.prg).offset,d;this.used&&255!==(d=a.prg[c++]);){const b=le.read(a.prg,c);c+=2*b.length;this.spawnConditions.set(d,b)}this.globalDialogs=
[];if(b){for(d=b.offset;;){const [b,c]=Rk.parse(a.prg,d);d+=4;b.condition&&this.globalDialogs.push(b);if(c)break}for(b=[];;){c=a.prg[d++];if(255===c)break;b.push([c,a.prg[d++]])}b.length||b.push([-1,0]);c=d;for(const [e,f]of b)for(b=[],this.localDialogs.set(e,b),d=c+f;;){const [c,e]=Sk.parse(a.prg,d);d+=c.byteLength();b.push(c);if(e)break}}}get dataBase(){return xe.of(this.id&128?Ik:Hk,33008|(this.id&252)<<6|(this.id&3)<<2)}get spawnPointer(){return xe.of(Jk,34272+(this.id<<1))}get dialogPointer(){return xe.of(Jk,
35165+(this.id<<1))}get used(){return this._used}set used(a){if(a&&136<this.id&&192>this.id&&142!==this.id)throw Error(`invalid: ${this.id}`);this._used=a}spawnConditionsBytes(){const a=[];for(const [b,c]of this.spawnConditions)a.push(b,...le.bytes(c));a.push(255);return a}dialog(a){a=a?a.id:-1;const b=this.localDialogs.get(a);if(b)return b;throw Error(`No local dialog for NPC ${x(this.id)} at ${x(a)}`);}spawns(a){const b=a.id;if(a=this.spawnConditions.get(a.id))return a;throw Error(`No spawn condition for NPC ${x(this.id)} at ${x(b)}`);
}hasDialog(){const a=!(!this.globalDialogs.length&&!this.localDialogs.size);if(142<this.id&&195!==this.id&&a)throw Error(`invalid: ${this.id}`);return a}*allDialogs(){yield*this.globalDialogs;for(const a of this.localDialogs.values())yield*a}dialogBytes(){function a(a){const b=[];for(let c=0;c<a.length;c++)b.push(...a[c].bytes(c===a.length-1));return b}if(!this.hasDialog())return[];const b=[];this.globalDialogs.length?b.push(...a(this.globalDialogs)):b.push(128,0,0,0);const c=[],d=new Map;for(const [e,
f]of this.localDialogs){const g=a(f),h=g.join(","),k=d.get(h);null!=k?b.push(e,k):(d.set(h,c.length),-1!==e&&b.push(e,c.length),c.push(...g))}c.length&&b.push(255,...c);return b}link(a){this.spawnConditions=this.rom.npcs[a].spawnConditions;this.linkDialog(a)}linkDialog(a){a=this.rom.npcs[a];this.globalDialogs=a.globalDialogs;this.localDialogs=a.localDialogs}localDialog(a,b){null==b&&(b=a,a=-1);const c=this.localDialogs.get(a);if(null==c||b>=c.length)throw Error(`No local dialog ${b} for location ${x(a)}`);
return c[b]}isParalyzable(){for(let a=217176;217196>a;a++)if(this.rom.prg[a]===this.id)return!1;return!0}assemble(a){if(this.used){var b=x(this.id);this.dataBase.loc(a,"PersonData_${id}");a.byte(...this.data);a.segment("0e","fe","ff");a.reloc(`SpawnCondition_${b}`);var c=a.pc();a.byte(...this.spawnConditionsBytes());this.spawnPointer.loc(a,`SpawnCondition_${b}_Pointer`);a.word(c);this.hasDialog()&&(a.segment("0e","fe","ff"),a.reloc(`Dialog_${b}`),c=a.pc(),a.byte(...this.dialogBytes()),this.dialogPointer.loc(a,
`Dialog_${b}_Pointer`),a.word(c))}}}class Rk{constructor(a,b){this.condition=a;this.message=b}static of(a,b){const [c,d,e=0]=b;return new Rk(a,Gk.of({part:c,index:d,action:e}))}static parse(a,b=0){const c=de(a,b);a=Gk.from(a,b+2);b=c&1023;const d=!!(c&32768);c&8192&&(b=~b);return[new Rk(b,a),d]}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);return[b>>>8,b&255,...this.message.data]}}
class Sk{constructor(a,b,c,d){this.condition=a;this.message=b;this.update=c;this.flags=d}clone(){return Sk.parse(this.bytes(!1))[0]}static parse(a,b=0){const c=de(a,b),d=Gk.from(a,b+2),e=a[b+4];let f=c&1023;const g=!!(c&32768);c&8192&&(f=~f);a=c&16384?he.read(a,b+5):[];return[new Sk(f,d,e,a),g]}static of(a,b,c=[]){const [d,e,f=0]=b;return new Sk(a,Gk.of({part:d,index:e,action:f}),0,c)}byteLength(){return 5+2*this.flags.length}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);this.flags.length&&
(b|=16384);return[b>>>8,b&255,...this.message.data,this.update,...he.bytes(this.flags)]}}const Qk=new Set([49,59,60,102,103,106,115,116,130,134,135,137,138,139,140,141,196]);class Nk extends S{get expectedSword(){return this.localDialog(3).condition&255}set expectedSword(a){this.localDialog(3).condition=512|a}}
class Ok extends S{constructor(a,b){super(a,b);const c=a.rom.prg,d=Tk.readAddress(c).offset;this.spawnScripts=w(9,a=>({entrance:uh.from(c,d+5*a),movement:c[d+5*a+4]}));this.channelSpawn=Uk(Vk.read(c)/5);this.evilSpiritIslandSpawn=Uk(Wk.read(c)/5)}assemble(a){super.assemble(a);a.segment("fe");a.org(54952);a.free(45);a.segment("fe","ff");a.reloc("DolphinSpawnTable");const b=a.pc();for(;!this.spawnScripts[this.spawnScripts.length-1].entrance.used;)this.spawnScripts.pop();for(var c=0;c<this.rom.locations.AngrySea.entrances.length;c++){const b=
this.spawnScripts[c];b?a.byte(...b.entrance.data,b.movement):a.byte(255,15,255,15,15)}Vk.loc(a,"DolphinChannelSpawn");a.byte(5*this.channelSpawn);Wk.loc(a,"DolphinEvilSpiritIslandSpawn");a.byte(5*this.evilSpiritIslandSpawn);Tk.loc(a,"DolphinSpawnTablePtr");a.word(b);for(c=0;4>c;c++)Xk.plus(5*c).loc(a,`DolphinSpawnTablePlus${c+1}Ptr`),a.word({op:"+",args:[b,{op:"num",num:c+1}]})}}var Yk,Zk=Yk||(Yk={});Zk.UP=0;Zk.RIGHT=2;Zk.DOWN=4;Zk.LEFT=6;Zk.DOLPHIN=255;Zk.DESPAWN=254;
const Vk=xe.of(Lk,54884),Wk=xe.of(Lk,54892),Tk=xe.of(Lk,54906),Xk=xe.of(Lk,54926),Pk=xe.of(Kk,44627);function Uk(a){if(a!==Math.floor(a))throw Error(`Expected integer: ${a}`);return a};class $k extends ug{constructor(a,b,c){super(a,b);this.pixels=c||Xd(a.chr,b<<4,16)}pixelAt(a,b){return(this.pixels[a|8]>>b&1)<<1|this.pixels[a]>>b&1}flipH(){return new $k(this.rom,-1,this.pixels.map(be))}flipV(){return new $k(this.rom,-1,w(16,a=>this.pixels[a&8|~a&7]))}flip(a){let b=this;a&al.HORIZONTAL&&(b=b.flipH());a&al.VERTICAL&&(b=b.flipV());return b}write(){const a=this.id<<4;this.rom.chr.subarray(a,a+16).set(this.pixels);return[]}}
class bl{constructor(a){this._all=[];this._all=w(a.chr.length>>4,b=>new $k(a,b))}get(a,b){return b?this._all[a|b]:this._all[a]}set(a,b,c){this._all[a|b].pixels=c}[Symbol.iterator](){return this._all[Symbol.iterator]()}}bl.HUD_LF=cl("\n    |L     ..|\n    |L.    .#|\n    |L.  FF.#|\n    |L.  F..#|\n    |LLL FF.#|\n    | ...F..#|\n    |    F ..|\n    |    .   |\n  ",{" ":2,L:1,F:1,"#":1,".":3});
bl.HUD_PW=cl("\n    |PPP     |\n    |P..P.   |\n    |PPP.    |\n    |P..     |\n    |P.w.w.w |\n    | .w.w.w |\n    |  .w.w. |\n    |   . .  |\n  ",{" ":2,P:1,w:1,".":3});bl.HUD_EY=cl("\n    |EEE     |\n    |E...    |\n    |EEE Y.Y.|\n    |E...Y.Y.|\n    |EEE  Y. |\n    | ... Y. |\n    |     Y. |\n    |        |\n  ",{" ":2,E:1,Y:1,"#":1,".":3});
bl.HUD_LV=cl("\n    |        |\n    |L       |\n    |L.      |\n    |L.  v.v.|\n    |L.  v.v.|\n    |LLL  v. |\n    | ... v. |\n    |     .  |\n  ",{" ":2,L:1,v:1,".":3});bl.HUD_DL=cl("\n    |        |\n    |DD      |\n    |D.D.L   |\n    |D.D.L.  |\n    |D.D.L.  |\n    |DD. L.  |\n    | .  LLL |\n    |     ...|\n  ",{" ":2,D:1,L:1,".":3});
bl.HUD_MP=cl("\n    |M.  M   |\n    |MM.MM.  |\n    |M.M.M.  |\n    |M. .PPP |\n    |M. .P..P|\n    |    PPP.|\n    |    P.. |\n    |    P.  |\n  ",{" ":2,M:1,P:1,".":3});bl.HUD_EX=cl("\n    |EEE     |\n    |E...    |\n    |EEE     |\n    |E...    |\n    |EEE x.x.|\n    | ... x. |\n    |    x.x.|\n    |     . .|\n  ",{" ":2,E:1,x:1,".":3});
bl.HUD_CLOSE_RIGHT=cl("\n    |________|\n    |____oooo|\n    |____o...|\n    |__ooo...|\n    |__o....o|\n    |__o....o|\n    |__o..oo |\n    |__o..o  |\n  ",{" ":0,".":1,_:2,o:3});bl.HUD_CLOSE_LEFT=cl("\n    |________|\n    |oooo____|\n    |...o____|\n    |...ooo__|\n    |o....o__|\n    |o....o__|\n    | oo..o__|\n    |  o..o__|\n  ",{" ":0,".":1,_:2,o:3});bl.BLANK_TILE_TEMPLATE="\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n  ";
bl.BLANK_TILES=[cl(bl.BLANK_TILE_TEMPLATE,{" ":0}),cl(bl.BLANK_TILE_TEMPLATE,{" ":1}),cl(bl.BLANK_TILE_TEMPLATE,{" ":2}),cl(bl.BLANK_TILE_TEMPLATE,{" ":3})];function cl(a,b){a=a.trim().replace(/^[^|]*\||\|[^|]*$/mg,"").replace(/\n/g,"");if(64!==a.length)throw Error(`Bad CHR tile: ${a}`);const c=Array(16).fill(0);for(let e=0,f="";f=a.charAt(e);++e){var d=e>>>3;const a=d;d|=8;const h=~e&7,k=b[f]||0;k&1&&(c[a]|=1<<h);k&2&&(c[d]|=1<<h)}return c}var al,dl=al||(al={});dl[dl.HORIZONTAL=64]="HORIZONTAL";
dl[dl.VERTICAL=128]="VERTICAL";function el(a,b,...c){let d=0,e;for(;null!=(e=c[d++]);)if("number"===typeof e)a[b++]=e;else if("string"===typeof e)for(const c of e)a[b++]=c.charCodeAt(0);else throw Error("bad data");}
function fl(a){a[107924]=255;a[118213]=168;a[106870]=255;a[108620]=255;a[120899]=160;a[122987]&=7;a[122991]&=7;a[122995]&=7;a[122999]&=7;a[123003]&=7;a[123012]&=7;a[123035]&=7;a[123065]&=7;a[123141]=47;a[123511]=0;a[123750]=64;a[123761]=0;a[123783]=0;a[123793]=0;el(a,106856,51,51);el(a,107662,51,51);a[105393]=112;a[105397]=113;a[105079]=114;a[105963]=115;a[106565]=116;a[106721]=117;a[106725]=118;a[106729]=119;a[108037]=120;a[107457]=121;a[107461]=122;a[107465]=123;el(a,123063,192,0);el(a,123690,192,
0);el(a,123696,192,0);el(a,123702,192,0);el(a,123104,192,0);el(a,123110,192,0);a[116739]=0;el(a,116749,162,179);a[109190]=254;el(a,251605,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(const b of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])a[b]|=1;el(a,157038,"Simea",16,0,"     ",16,0)}
function gl(a,b){{const {flags:{WarpZombie:b},locations:{ZombieTown:c}}=a;a.flags.insertZombieWarpFlag();a.messages.parts[33][0].text=" {1a:Leaf}      {16:Brynmaer} {1d:Oak} \n{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} \n{19:Joel}      Zombie   {20:Swan} \n{23:Shyron}    {18:Goa}      {21:Sahara}";const f=a.nextFreeTrigger("zombie warp");f.used=!0;f.conditions=[];f.message=Gk.of({});f.flags=[b.id];for(const a of c.spawns)a.isTrigger()&&138===a.id&&(a.id=f.id);a.townWarp.locations.splice(7,0,c.id);
if(255!==a.townWarp.locations.pop())throw Error("unexpected");}hl(a);a.items.GlowingLamp.itemUseData[0].message.action=11;{const b=a.nextFreeTrigger("mezame");b.used=!0;b.conditions=[~a.flags.AlwaysTrue.id];b.message=Gk.of({action:4});b.flags=[a.flags.AlwaysTrue.id];a.locations.MezameShrine.spawns.push(yh.of({tile:136,type:2,id:b.id}))}a.objects[16].atk=3;a.objects[17].atk=6;a.objects[18].atk=8;a.objects[24].atk=3;a.objects[19].atk=5;a.objects[25].atk=5;a.objects[23].atk=7;a.objects[26].atk=7;a.objects[20].atk=
3;a.objects[21].atk=6;a.objects[22].atk=8;a.objects[28].atk=3;a.objects[29].atk=3;a.objects[30].atk=5;a.objects[27].atk=7;a.objects[31].atk=7;if(b.slowDownTornado()){const b=a.objects[18];b.speed=7;b.data[12]=96}a.tileEffects[2].effects[116]=6;a.tileEffects[3].effects[70]=6;for(const b of a.objects)b instanceof J&&!(b.isProjectile()||b.isBoss()||b.isFlyer())&&b!==a.objects.mimic&&(b.terrainSusceptibility|=3);a.objects[51].elements=15;a.items.OpelStatue.selectedItemValue=0;for(const b of[96,100,101,
102,103,104,105,106,107,108,109,111])for(const c of[0,1,2])a.patterns.set(b<<6,c,a.patterns.get(6016,c).pixels);a.objects[12].metasprite=169;for(const b of a.locations)for(const a of b.spawns)a.isChest()&&(a.timed=!1);{const b=a.trigger(160);b.used=!0;b.conditions=[];b.flags=[];b.message=Gk.of({part:0,index:0,action:21});a.objects[94].data[13]=254;a.items.InsectFlute.itemUseData[0].flags=[a.flags.UsedInsectFlute.id]}{const {flags:{BallOfWind:b,TornadoBracelet:c},npcs:{Tornel:f}}=a,g=f.localDialogs.get(33),
h=[g[0],g[2],g[2].clone(),g[1]];h[1].condition=~c.id;h[2].condition=~b.id;h[3].condition=-1;f.localDialogs.set(33,h)}{const b=a.locations;b.GoaFortress_Kelbesque.spawns[0].x-=16;b.GoaFortress_Zebu.spawns.splice(1,1);b.GoaFortress_Tornel.spawns.splice(2,1);b.GoaFortress_Asina.spawns.splice(2,1);b.GoaFortress_Kensu.spawns.splice(3,1);b.GoaFortress_Kensu.spawns.splice(1,1)}il(a,b);a.npcs[13].localDialogs.get(53)[0].message.action=23;if(b.requireHealedDolphinToRide()){{const {flags:{InjuredDolphin:b,
ShellFlute:c},npcs:{Fisherman:f,FishermanDaughter:g}}=a;f.spawnConditions.set(214,[c.id,b.id]);const h=g.localDialogs.get(-1);h.unshift(h[0].clone());h[0].condition=~b.id;h[1].condition=~c.id}}if(b.saharaRabbitsRequireTelepathy()){{const {flags:{Telepathy:b},npcs:{Deo:c,SaharaBunny:f}}=a;f.globalDialogs.push(Rk.of(~b.id,[26,18]));c.globalDialogs.push(Rk.of(~b.id,[26,19]))}}if(b.leatherBootsGiveSpeed()){const c=a.items[47];c.menuName="Speed Boots";c.messageName="Speed Boots";if(b.changeGasMaskToHazmatSuit()){const b=
a.items[41];b.menuName="Hazmat Suit";b.messageName="Hazmat Suit"}}for(let b=5;12>b;b+=2)a.items[b].menuName=a.items[b].menuName.replace("Ball","Orb"),a.items[b].messageName=a.items[b].messageName.replace("Ball","Orb");{const {items:{AlarmFlute:c},flags:{TalkedToZebuStudent:e,ZebuStudent:f},locations:{MezameShrine:g,Leaf_StudentHouse:h,WaterfallCave4:k,ZebuCave:l},npcs:{WindmillGuard:n,Zebu:q}}=a;a.itemGets[49].inventoryRowStart=32;c.unique=!0;c.basePrice=0;if(b.zebuStudentGivesItem())n.data[1]=49;
else{n.data[1]=255;const b=n.dialog(h)[0];b.condition=~e.id;b.flags.push(e.id);jl(q.spawns(l),f.id,e.id);g.spawns.push(yh.of({screen:0,tile:155,type:2,id:49}));g.spawns.push(yh.of({screen:0,tile:149,type:2,id:73}));a.itemGets[73].itemId=a.items.MedicalHerb.id}const v=[[33,.72],[31,.9]];let y=0;for(const b of a.shops)if(b.type===yg.TOOL)for(let c=0,d=b.contents.length;c<d;c++){if(49!==b.contents[c])continue;const [d,e]=v[y++%v.length];b.contents[c]=d;a.shopDataTablesAddress&&(b.prices[c]=Math.round(b.prices[c]*
e))}a.itemGets[91].itemId=29;k.spawn(25).id=16}{const {flags:{Karmine:b,Mado1:e},npcs:{Brokahana:f}}=a;var c=f.localDialogs.get(-1);if(!c)throw Error(`asserted but falsy: ${c}`);const g=c[0];if(g.condition!==~b.id)throw Error(`Bad brokahana condition: ${g.condition}`);g.condition=~e.id}if(b.teleportOnThunderSword()){{const {flags:{WarpShyron:b}}=a;a.itemGets[3].flags.push(b.id)}a.townWarp.thunderSwordWarp=[a.locations.Shyron.id,65]}else a.itemGets[3].acquisitionAction.action=22;{const {tiles:b}=a.screens[161];
b[40]=159;b[55]=35;b[56]=35;b[57]=33;b[71]=141;b[72]=143;b[86]=153;b[87]=154;b[88]=140}if(b.fogLampNotRequired()){{const {flags:{AlwaysTrue:c,InjuredDolphin:e,FogLamp:f,KensuInCabin:g,ReturnedFogLamp:h},items:{ShellFlute:k},locations:{BoatHouse:l,Portoa_FishermanHouse:n},npcs:q}=a,v=b.requireHealedDolphinToRide();k.itemUseData[0].want=v?e.id:c.id;q.KensuInCabin.data[0]=103;q.KensuInCabin.localDialogs.get(-1)[0].message.action=10;q.KensuInCabin.localDialogs.get(-1)[0].flags=[];q.KensuInCabin.spawnConditions.set(l.id,
[h.id,~g.id]);q.Fisherman.spawnConditions.set(n.id,[f.id]);a.itemGets[100].flags=[];a.itemGets[103].copyFrom(a.itemGets[100])}}a.trigger(138).conditions=[~a.flags.CurrentlyRidingDolphin.id];a.messages.parts[29][16].text="The cave entrance appears\nto be underwater. You'll\nneed to swim.";{const {CordelPlainEast:b,KirisaMeadow:c,UndergroundChannel:f}=a.locations;for(const a of[b,c,f])for(const b of a.spawns)b.isChest()&&(b.data[2]|=32)}{const {CordelPlainEast:c,CordelPlainWest:e}=a.locations;for(const a of c.spawns)(a.isChest()||
b.disableTeleportSkip()&&a.isTrigger())&&e.spawns.push(a.clone())}if(b.disableRabbitSkip())for(const b of a.locations.MtSabreNorth_Main.spawns)b.isTrigger()&&134===b.id&&1856===b.x&&(b.x+=16,b.y+=16);if(b.disableFlightStatueSkip()){{const b=a.hitboxes[a.objects.guardianStatueMissile.hitbox],c=a.hitboxes[6];a.objects.guardianStatueMissile.hitbox=c.id;c.x0=b.x0-6;c.w=b.w+12;c.y0=b.y0-2;c.h=b.h+4}}kl(a,b);for(const b in[4,5,8,9])a.tileEffects[9].effects[b]=24,a.tileEffects[2].effects[b]=24;if(b.chargeShotsOnly()){for(const b of[8,
9,39])a.objects[b].collisionPlane=0;a.npcs.Brokahana.data[0]=a.items.FruitOfLime.id}if(b.orbsOptional())for(const b of[16,20,24,29])a.objects[b].terrainSusceptibility&=-5,a.objects[b].level=2;if(b.noBowMode()){{const {flags:{UsedBowOfTruth:b},locations:{Crypt_Draygon2:c,MezameShrine:f}}=a;let g;for(const b of f.spawns)b.isTrigger()&&136===b.tile&&(g=a.trigger(b.id));if(!g)throw Error("Could not find start trigger");g.flags.push(b.id);a.tileEffects[6].effects[88]=0;f.meta.setExit(0,"door",[c.meta.id<<
8|16,"edge:bottom"])}}a.messages.parts[32][15].text+="\nItem: [:ITEM:]";if(b.hardcoreMode())for(const b of a.locations)b.checkpoint=b.saveable=!1;b.shouldUpdateHud()&&(a.patterns.set(3584,0,bl.HUD_LF),a.patterns.set(3584,1,bl.HUD_PW),a.patterns.set(3584,2,bl.HUD_EY),a.patterns.set(3584,3,bl.HUD_LV),a.patterns.set(3584,4,bl.HUD_DL),a.patterns.set(3584,5,bl.HUD_MP),a.patterns.set(3584,6,bl.HUD_EX),a.patterns.set(3584,26,bl.HUD_CLOSE_LEFT),a.patterns.set(3584,27,bl.HUD_CLOSE_RIGHT),a.writeMonsterNames=
!0);b.shouldColorSwordElements()&&ll(a);if(b.hasStatTracking()){{a.prg[143082]=40;for(let b=0;4>b;b++)a.patterns.set(5376,41+b,bl.BLANK_TILES[b]);for(let b=143364;144132>b;b++)41<=a.prg[b]&&45>=a.prg[b]&&(a.prg[b]+=127);for(let b=143364;144132>b;b+=192)a.prg[b+160]=42;const b=new Map([[66,160]]);for(let c=142469;142546>c;c++)b.has(a.prg[c])&&(a.prg[c]=b.get(a.prg[c]));for(let b=143364;144132>b;b+=192)for(let c=123;127>=c;c++)169==a.prg[b+c]&&(a.prg[b+c]=42);for(let b=144376;144440>b;b++){let c=a.prg[b];
for(let a=0;8>a;a+=2){const b=3<<a,d=2<<a;(c&b)==b&&(c=c&(255^3<<a)|d)}a.prg[b]=c}const c=[15,48,15,17];for(let b=0;b<c.length;b++)a.prg[144452+b]=c[b];a.prg[144451]=8;for(let b=145114;145222>b;b+=4)a.prg[b]+=128}}}function ll(a){function b(b,d){for(let c=0;10>=c;c++){if(8===c)continue;const e=a.patterns.get(c|b),g=[...e.pixels];for(let a=0;a<e.pixels.length;a++)e.pixels[a]=g[a^8],a>>>3===d&&(e.pixels[a]|=g[a])}}b(4240);b(4304);b(4368);b(4432);b(4496)}
function hl(a){const b=new Set([129,139,144,153,166,167,168,169,170,171,172,a.allocatedTriggers.get("zombie warp")]);for(const c of a.locations)c.used&&(c.spawns=c.spawns.filter(a=>!a.isTrigger()||!b.has(a.id)))}
function kl(a,b){const c=a.locations.LimeTreeLake,d=a.screens[a.metascreens.limeTreeLake.sid];if(b.disableRageSkip()){d.set2d(32,d.get2d(0,143));d.set2d(42,d.get2d(58,1));d.set2d(16,d.get2d(32,4));d.set2d(26,d.get2d(42,5));d.set2d(27,d.get2d(0,16));for(const a of c.spawns)a.tile+=32;a=a.metascreens.limeTreeLake.findExitByType("cave");a.entrance+=8192;a.exits=a.exits.map(a=>a+32)}else d.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,
null,null,null,null,null,121,122,118,118]])}
function il(a,b){function c(a,b){const c=a.indexOf(b);if(0>c)throw Error(`Could not find element ${b} in ${a}`);a.splice(c,1)}function d(a){a.reverse();for(let b=0;b<a.length;b++){const c=a[b+1];a[b].condition=c?~c.condition:-1}}const {locations:{BoatHouse:e,Brynmaer:f,Crypt_Draygon2:g,Joel_Shed:h,Leaf_ElderHouse:k,MtSabreNorth_SummitCave:l,MtSabreWest_Upper:n,PortoaPalace_ThroneRoom:q,Portoa_PalaceEntrance:v,Portoa_AsinaRoom:y,Portoa_FortuneTeller:A,Shyron_Temple:z,StomHouse:R,Swan_DanceHall:G,Swan_Tavern:E,
WindmillCave:L,WaterfallCave4:fa,WaterfallValleyNorth:ba,ZebuCave:lb,ZombieTown_HouseBasement:ea},items:{GlowingLamp:Eb,KeyToPrison:sb,LovePendant:xc,StatueOfOnyx:bc},npcs:{Akahana:yb,AkahanaInBrynmaer:zb,Asina:Nc,AztecaInShyron:kd,Clark:ld,Draygon:nb,FortuneTeller:ob,Kensu:Na,KensuInCabin:ab,KensuInSwan:Qa,LeafElder:Oc,LeafRabbit:Qb,OakChild:cc,OakElder:dc,OakMother:ec,PortoaPalaceFrontGuard:Pc,PortoaQueen:bb,PortoaThroneRoomBackDoorGuard:fc,Rage:gc,Stom:Qc,StonedAkahana:Rc,Tornel:Fd,WindmillGuard:md,
Zebu:yc},flags:U}=a;Na.localDialogs.delete(E.id);Qa.link(Na.id);Qa.used=!0;Qa.data=[...Na.data];Na.data[0]=Eb.id;G.spawns.find(a=>a.isNpc()&&a.id===Na.id).id=Qa.id;xc.itemUseData[0].want=256|Qa.id;Rc.linkDialog(yb.id);zb.used=!0;zb.link(yb.id);zb.data=[...yb.data];f.spawns.find(a=>a.isNpc()&&a.id===yb.id).id=zb.id;bc.itemUseData[0].want=256|zb.id;Oc.dialog(k).splice(0,0,...Oc.dialog(k).splice(2,1));Qb.dialog()[2].condition=U.RescuedLeafElder.id;Qb.dialog()[2].flags.push(U.TalkedToLeafRabbit.id);Qb.dialog()[3].flags.push(U.TalkedToLeafRabbit.id);
md.spawns(L)[1]=~U.WindmillGuardAlarmFluteTradein.id;c(yb.spawns(fa),~U.BehindWhirlpool.id);c(Rc.spawns(fa),~U.BehindWhirlpool.id);for(var pb=0;4>pb;pb++){var hc=dc.dialog()[pb];hc.condition!==a.flags.OakElder.id&&(hc.message.action=3)}(()=>{const [a,b,c,d]=ec.dialog();d.condition=~U.RescuedChild.id;b.condition=-1;ec.dialog().splice(0,4,d,c,a,b)})();for(const b of[32,33,34,124,125])d(a.npcs[b].dialog());cc.dialog().unshift(...cc.dialog().splice(1,1));fc.spawnConditions.set(q.id,[~U.QueenNotInThroneRoom.id,
~U.MesiaRecording.id]);Pc.dialog()[1].condition=U.MesiaRecording.id;bb.dialog()[3].condition=U.SwordOfWater.id;bb.dialog()[3].message.action=3;bb.dialog()[4].flags.push(U.PortoaQueenGoingAway.id);bb.spawns(q)[1]=~U.MesiaRecording.id;bb.spawns(y)[0]=U.MesiaRecording.id;bb.dialog()[1].condition=U.MesiaRecording.id;ob.spawns(A)[1]=~U.MesiaRecording.id;ld.spawnConditions.set(ea.id,[~U.Clark.id]);ld.spawnConditions.set(h.id,[U.Clark.id]);yc.localDialogs.set(lb.id,[Sk.of(~U.TalkedToZebuInCave.id,[0,26],
[U.TalkedToZebuInCave.id]),Sk.of(U.LeafVillagersRescued.id,[0,29]),Sk.of(U.LeafAbduction.id,[0,28]),Sk.of(U.ZebuAtWindmill.id,[0,29]),Sk.of(U.UsedWindmillKey.id,[0,27,3]),Sk.of(-1,[0,29])]);c(yc.spawns(lb),~U.BehindWhirlpool.id);Fd.spawnConditions.delete(n.id);Qc.spawnConditions.delete(R.id);c(Nc.spawns(y),~U.CalmedAngrySea.id);pb=a.npcs[52];pb.spawnConditions.set(q.id,[U.MesiaRecording.id,~U.PortoaQueen.id]);pb.localDialogs.set(v.id,pb.localDialogs.get(-1));pb.data[0]=a.items.FluteOfLime.id;hc=a.messages.alloc();
hc.text="The queen left this for you.";pb.localDialogs.set(q.id,[Sk.of(~U.PortoaQueen.id,[hc.part,hc.id,3]),Sk.of(-1,[10,14])]);q.spawns.push(yh.of({yt:3,xt:12,type:1,patternBank:1,id:pb.id}));bb.localDialogs.set(y.id,bb.dialog().splice(0,2));bb.localDialogs.set(q.id,bb.dialog());bb.localDialogs.delete(-1);ab.spawnConditions.set(e.id,[~U.AbleToRideDolphin.id,U.ReturnedFogLamp.id]);ab.dialog()[0].message.action=2;kd.spawns(z).push(~U.ShyronMassacre.id);a.trigger(130).conditions.push(~U.ShyronMassacre.id);
gc.dialog()[0].condition=U.SwordOfWater.id;nb.spawnConditions.set(g.id,[~U.Draygon2.id]);yc.dialog(z).unshift(...yc.dialog(z).splice(1,1));a.trigger(128).conditions=[~U.ShyronMassacre.id,U.TalkedToZebuInShyron.id,U.SwordOfThunder.id];a.trigger(129).conditions=[];b.barrierRequiresCalmSea()&&a.trigger(132).conditions.push(U.CalmedAngrySea.id);a.trigger(140).conditions.push(U.TalkedToZebuInCave.id);a.trigger(141).used=!1;for(const a of l.spawns)a.isTrigger()&&141===a.id&&(a.id=178);(function(a,b){b=
a.findIndex(b);if(0>b)throw Error(`Could not find element in ${a}`);a.splice(b,1)})(ba.spawns,a=>a.isTrigger()&&141===a.id);a.trigger(178).conditions.push(U.Kelbesque1.id);a.trigger(178).flags.push(~U.LeafVillagersCurrentlyAbducted.id,~U.LeafElderCurrentlyAbducted.id,U.LeafVillagersRescued.id);a.trigger(140).conditions.push(~U.Kelbesque1.id);a.trigger(134).conditions.push(~U.Kelbesque1.id);c(sb.itemUseData[0].flags,~U.LeafVillagersCurrentlyAbducted.id);jl(a.trigger(187).conditions,~U.Rage.id,~U.MesiaRecording.id)}
function jl(a,b,c){for(let d=0;d<a.length;d++)if(a[d]===b){a[d]=c;return}throw Error(`Could not find ${b} in ${a.join(",")}`);};const {$0e:ml,$0f:nl,$10:ol,$1a:pl,$fe:ql,$ff:rl}=B,sl=xe.of(ml,33689),tl=xe.of(ml,39906),ul=xe.of(ol,36848),vl=xe.of(ol,36923),wl=xe.of(ol,36998),xl=xe.of(pl,35776),yl=xe.of(pl,35785),zl=[["Sword","\n\x0B\f"],[" of ","\\]"],["Bracelet","<=>["],["Shield","\r\u000e\u000f"],["Armor","{\u0011\u0012"],["Magic","#%("],["Power","\u0013\u0014\u0015"],["Item","\u0016\u0017^"]];
class T extends ug{constructor(a,b,c={}){super(a.rom,b);this.items=a;const d=this.rom;a[b]=this;this.itemUseData=[];this.trades=c.trades||[];this.use=c.use||!1;this.weight=c.weight||1;this.valueAddr=null!=c.valueAddr?xe.of(ml,c.valueAddr):void 0;null!=this.valueAddr&&(this.value=this.valueAddr.read(d.prg));if(this.use){this.itemUseJump=this.itemUseJumpPointer.readAddress(d.prg,ml,nl);b=a.itemUseJumps[this.itemUseJump.org];if(!b)throw Error(`Bad ItemUseJump: ${this.itemUseJump}`);a=this.itemUseDataPointer.readAddress(d.prg,
ml,nl);for(var e of b)b=Al.from(e,d.prg,a),this.itemUseData.push(b),a=a.plus(b.length)}this.itemDataValue=this.itemDataPointer.read(d.prg);this.selectedItemValue=this.selectedItemPointer.read(d.prg);e=this.menuNamePointer.readAddress(d.prg);this.menuName=zl.reduce((a,[b,c])=>a.replace(c,b),fe(d.prg,e.offset,255))}get messageName(){return this.rom.messages.itemNames[this.id]}set messageName(a){this.rom.messages.itemNames[this.id]=a}get basePrice(){return this.rom.shops.basePrices[this.id]}set basePrice(a){this.rom.shops.basePrices[this.id]=
a}get itemUseJumpPointer(){return sl.plus(this.id<<1)}get itemUseDataPointer(){return tl.plus(this.id<<1)}get itemDataPointer(){return ul.plus(this.id)}get selectedItemPointer(){return vl.plus(this.id)}get menuNamePointer(){return wl.plus(this.id<<1)}itemUseMessages(){const a=new Map;for(const {message:b}of this.itemUseData)a.set(b.mid,b);return[...a.values()]}setName(a){this.messageName=this.menuName=a}get palette(){return this.itemDataValue&3}set palette(a){this.itemDataValue=this.itemDataValue&
-4|a&3}get unique(){return!!(this.itemDataValue&64)}set unique(a){this.itemDataValue=this.itemDataValue&-65|(a?64:0)}get worn(){return!!(this.itemDataValue&32)}set worn(a){this.itemDataValue=this.itemDataValue&-33|(a?32:0)}get solid(){return!!(this.itemDataValue&128)}set solid(a){this.itemDataValue=this.itemDataValue&-129|(a?128:0)}assemble(a){const b=x(this.id);this.itemDataPointer.loc(a,`ItemData_${b}`);a.byte(this.itemDataValue);this.selectedItemPointer.loc(a,`ItemSelectedValue_${b}`);a.byte(this.selectedItemValue);
var c=zl.reduce((a,[b,c])=>a.replace(b,c),this.menuName);a.segment(ol,ql,rl);a.reloc(`ItemMenuName_${x(this.id)}`);const d=a.pc();a.byte(c,255);this.menuNamePointer.loc(a,`ItemMenuName_${b}`);a.word(d);if(this.itemUseJump){this.itemUseJumpPointer.loc(a,`ItemUseJump_${b}_Ptr`);a.word(this.itemUseJump.org);c=[];for(var e of this.itemUseData)c.push(...e.bytes());a.segment(ml.name,nl.name);a.reloc(`ItemUseData_${b}`);e=a.pc();a.byte(...c);this.itemUseDataPointer.loc(a,`ItemUseData_${b}_Ptr`);a.word(e)}this.valueAddr&&
(this.valueAddr.loc(a,`ItemValue_${b}`),a.byte(this.value));this.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&(a.segment("fe"),a.org(54453),a.byte(this.id-28))}isMagic(){return 65<=this.id&&72>=this.id}}
class Al{constructor(a,b,c,d){this.kind=a;this.want=b;this.message=c;this.flags=d}static from(a,b,c){({offset:c}=c);var d=0;if("expect"===a||"screen"===a)d=b[c+1]<<8|b[c],c+=2;else if("flag"===a){d=ke.read(b,c);d.length||d.push(-1);if(1<d.length)throw Error(`Flag list too long: ${d}`);d=d[0];c+=2}else"location"===a?d=b[c++]:"empty"!==a&&oa(a);const e=Gk.from(b,c);b=je.read(b,c+2);return new Al(a,d,e,b)}bytes(){const a=[];if("expect"===this.kind||"screen"===this.kind)a.push(this.want&255,this.want>>>
8&255);else if("flag"===this.kind){const b=ke.bytes([this.want]);if(2!==b.length)throw Error(`bad data: ${b}`);a.push(...b)}else"location"===this.kind?a.push(this.want):"empty"!==this.kind&&oa(this.kind);a.push(...this.message.data);a.push(...je.bytes(this.flags));return a}tradeNpc(){return"expect"!==this.kind||1!==this.want>>>8?null:this.want&255}get length(){return 2*(1+Math.max(1,this.flags.length))+("empty"===this.kind?0:"location"===this.kind?1:2)}}
class Bl extends T{get defense(){return this.items.shieldDefense[this.id-12]}set defense(a){this.items.shieldDefense[this.id-12]=a}}class Cl extends T{get defense(){return this.items.armorDefense[this.id-20]}set defense(a){this.items.armorDefense[this.id-20]=a}}
class Dl extends vg{constructor(a){super(73);this.rom=a;this.itemUseJumps=El;this.SwordOfWind=new T(this,0);this.SwordOfFire=new T(this,1);this.SwordOfWater=new T(this,2);this.SwordOfThunder=new T(this,3);this.Crystalis=new T(this,4);this.BallOfWind=new T(this,5);this.TornadoBracelet=new T(this,6);this.BallOfFire=new T(this,7);this.FlameBracelet=new T(this,8);this.BallOfWater=new T(this,9);this.BlizzardBracelet=new T(this,10);this.BallOfThunder=new T(this,11);this.StormBracelet=new T(this,12);this.CarapaceShield=
new Bl(this,13);this.BronzeShield=new Bl(this,14);this.PlatinumShield=new Bl(this,15);this.MirroredShield=new Bl(this,16);this.CeramicShield=new Bl(this,17);this.SacredShield=new Bl(this,18);this.BattleShield=new Bl(this,19);this.PsychoShield=new Bl(this,20);this.TannedHide=new Cl(this,21);this.LeatherArmor=new Cl(this,22);this.BronzeArmor=new Cl(this,23);this.PlatinumArmor=new Cl(this,24);this.SoldierSuit=new Cl(this,25);this.CeramicSuit=new Cl(this,26);this.BattleArmor=new Cl(this,27);this.PsychoArmor=
new Cl(this,28);this.MedicalHerb=new T(this,29,{use:!0,trades:[0],valueAddr:34026});this.Antidote=new T(this,30,{use:!0});this.LysisPlant=new T(this,31,{use:!0});this.FruitOfLime=new T(this,32,{use:!0});this.FruitOfPower=new T(this,33,{use:!0,valueAddr:34060});this.MagicRing=new T(this,34,{use:!0});this.FruitOfRepun=new T(this,35,{use:!0});this.WarpBoots=new T(this,36,{use:!0});this.StatueOfOnyx=new T(this,37,{use:!0,trades:[0]});this.OpelStatue=new T(this,38,{use:!0});this.InsectFlute=new T(this,
39,{use:!0});this.FluteOfLime=new T(this,40,{use:!0,trades:[0,1,2,3]});this.GasMask=new T(this,41);this.PowerRing=new T(this,42);this.WarriorRing=new T(this,43);this.IronNecklace=new T(this,44);this.DeosPendant=new T(this,45);this.RabbitBoots=new T(this,46);this.LeatherBoots=new T(this,47);this.ShieldRing=new T(this,48);this.AlarmFlute=new T(this,49,{use:!0,trades:[0,1]});this.WindmillKey=new T(this,50,{use:!0});this.KeyToPrison=new T(this,51,{use:!0});this.KeyToStyx=new T(this,52,{use:!0});this.FogLamp=
new T(this,53,{use:!0,trades:[0]});this.ShellFlute=new T(this,54,{use:!0});this.EyeGlasses=new T(this,55,{use:!0});this.BrokenStatue=new T(this,56,{use:!0});this.GlowingLamp=new T(this,57,{use:!0});this.StatueOfGold=new T(this,58,{use:!0});this.LovePendant=new T(this,59,{use:!0,trades:[0]});this.KirisaPlant=new T(this,60,{use:!0,trades:[0]});this.IvoryStatue=new T(this,61,{use:!0,trades:[0]});this.BowOfMoon=new T(this,62,{use:!0});this.BowOfSun=new T(this,63,{use:!0});this.BowOfTruth=new T(this,64,
{use:!0});this.Refresh=new T(this,65);this.Paralysis=new T(this,66);this.Telepathy=new T(this,67);this.Teleport=new T(this,68);this.Recover=new T(this,69);this.Barrier=new T(this,70);this.Change=new T(this,71);this.Flight=new T(this,72);this.armorDefense=Xd(a.prg,xl.offset,9);this.shieldDefense=Xd(a.prg,yl.offset,9)}write(){const a=this.rom.assembler();xl.loc(a);a.byte(...this.armorDefense);yl.loc(a);a.byte(...this.shieldDefense);const b=Array(10).fill(0);for(const c of this)c.assemble(a),c.unique&&
(b[c.id>>>3]|=1<<(c.id&7));ze(a,[ml,nl],"KeyItemData");a.byte(...b);return[a.module()]}}const El={33849:["expect"],33858:["screen"],33872:["empty"],33873:["screen"],33887:["location"],33937:["expect"],33961:["expect","expect"],33971:["location"],34E3:["expect"],34011:[],34016:["expect","empty"],34055:["empty"],34077:["empty"],34084:["empty"],34095:["empty"],34106:["empty"],34122:["empty"],34148:["empty"],34149:["expect"],34155:["flag"],34181:["empty"],34206:["expect","expect","expect","expect"]};function Fl(a,b,c){if(b.randomizeTrades()){var {items:{StatueOfOnyx:d,FogLamp:e,LovePendant:f,KirisaPlant:g,IvoryStatue:h},locations:{Swan_DanceHall:k},npcs:{KensuInSwan:l}}=a,n=new Map,q=[[d,0,"Akahana"],[e,0,"Fisherman"],[f,0,"Kensu"],[g,0,"Aryllis"],[h,0,"Slimed Kensu"]],v=q.map(([a,b,c])=>{if(0>a.trades.indexOf(b)||b>=a.itemUseData.length)throw Error(`not a trade: ${a} ${b}`);return[a.itemUseData[b],a.id,c]});c.shuffle(v);for(const [c,d]of q){const [e,f,g]=v.pop();c.itemUseData[d]=e;a.spoiler&&
a.spoiler.addTrade(c.id,c.messageName,g);356===e.want&&b.fogLampNotRequired()&&([...a.npcs[100].spawnConditions.values()][0][0]=512|c.id);n.set(f,c.id)}a.itemGets.actionGrants=new Map([...a.itemGets.actionGrants].map(([a,b])=>{var c;return[null!==(c=n.get(a))&&void 0!==c?c:a,b]}));b=a.items[c.nextInt(4)];a.npcs[195].localDialogs.get(-1)[0].condition=512|b.id;a.spoiler&&a.spoiler.addTrade(b.id,b.messageName,"Rage");a.npcs.PortoaQueen.localDialogs.get(-1)[3].condition=512|b.id;c=a.items[2*c.nextInt(4)+
6];for(const d of a.npcs[95].localDialogs.values())for(b=2;b<d.length;b++)if(3===d[b].message.action){d[b-2].condition=~(512|c.id-1);d[b-1].condition=~(512|c.id);a.spoiler&&a.spoiler.addTrade(c.id,c.messageName,"Tornel");break}l.dialog(k)[0].message.mid="13:00"}}function Gl(a){const b=new Map;for(const c of a.items)for(const a of c.trades)b.set(c.itemUseData[a].want&255,c.id);return b};function Hl(a){function b(b){const c=lb.get(b.id);if(!c)throw Error(`No trade-in for ${b.name}`);return a.items[c]}function c(a){e(a,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function d(b){"number"===typeof b?b=a.items[a.itemGets[b&255].itemId]:b instanceof T||(b=b.item);return`[${x(b.id)}:${b.messageName}]`}function e(b,c,d){const [e,f]=b.split(":").map(a=>parseInt(a,16));b=a.messages.parts[e][f];b.text=b.text.replace(c,d)}const {flags:{AkahanaStatueOfOnyxTradein:f,AsinaInBackRoom:g,
BehindWhirlpool:h,KensuInSwan:k,MtSabreNorthSummit:l,MtSabreWestTornel:n,PortoaQueen:q,Rage:v,RepairedStatue:y,SlimedKensu:A,StomFightReward:z,ZebuAtWindmill:R},npcs:{AkahanaInBrynmaer:G,Aryllis:E,Fisherman:L,PortoaQueen:fa},locations:{PortoaPalace_ThroneRoom:ba}}=a;e("03:06",",","");const lb=Gl(a);R.item.isMagic()||c("00:1b");e("00:1b","[41:Refresh]",d(R.item));var ea=b(G);e("02:01","an unusual statue",Il(ea));e("02:02","a statue",`the ${Jl(ea)}`);e("02:02","[29:Gas Mask]",d(f));z.item.isMagic()||
c("03:01");e("03:01","[43:Telepathy]",d(z));ea=Kl(a);e("03:01","[06:Tornado Bracelet]",d(ea));e("05:0a","[06:Tornado Bracelet]",d(ea));e("05:0a","[44:Teleport]",d(n));ea=b(L);e("09:01","[35:Fog Lamp]",d(ea));e("09:04","[35:Fog Lamp]",d(ea));e("09:05","[35:Fog Lamp]",d(ea));e("09:06","lamp",Jl(ea));ea=fa.dialog(ba)[1].condition;e("0a:0c","[28:Flute of Lime]",d(q));e("0a:0d","[02:Sword of Water]",d(ea));g.item.isMagic()||c("0b:01");e("0b:01","[45:Recover]",d(g));h.item.isMagic()||(c("0b:01"),c("1d:12"));
e("0b:01","[46:Barrier]",d(h));e("1d:12","[46:Barrier]",d(h));(ea=function(...b){var c=[a=>Ll.has(a),a=>Ml.has(a),b=>a.items[a.itemGets[b].itemId].unique];for(const d of c)for(const e of b){c=[...a.locations[e].spawns].reverse();for(const b of c)if(b.isChest()&&(c=a.slots[b.id],72>=c&&d(c)))return a.items[c]}}(79,78,77,76,71,70,69,68,75,74,73,72))?e("0d:00","[35:Fog Lamp]",d(ea)):e("0d:00","that a [35:Fog Lamp] was","there was treasure");ea=a.npcs.Rage.dialog()[0].condition;e("0e:03","[02:Sword of Water]",
d(ea));e("0e:03","[09:Ball of Water]",d(v));e("10:0c","that's","is");e("10:0c",/, is in the\+lighthouse/,"");ea=b(E);e("12:05","[3c:Kirisa Plant]",d(ea));e("12:10","the plant",`the ${Jl(ea)}`);e("12:10","[3c:Kirisa Plant]",d(ea));ea=`Our illustrious chief seeks ${Il(ea)}.`;e("12:09",/[^]*/,ea);e("12:0a",/[^]*/,ea);ea=b(a.npcs.KensuInSwan);e("13:02","[3b:Love Pendant]",d(ea));e("13:00","pendant",Jl(ea));k.item.isMagic()||c("13:02");e("13:02","[47:Change]",d(k));ea=b(a.npcs.SlimedKensu);e("18:06","[3d:Ivory Statue]",
d(ea));e("18:07","[3d:Ivory Statue]",d(ea));e("18:06","It's in a room","{0b:Karmine} is");A.item.isMagic()||e("18:07","teach","give");e("18:07","[48:Flight]",d(A));l.item.isMagic()||c("1c:10");e("1c:10","[42:Paralysis]",d(l));e("20:06","Statue of Gold",d(y));ea=a.messages.alloc();a.trigger(134).message.mid=ea.mid;ea.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!";a.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}
const Ll=new Set([62,63,64]),Ml=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function Kl(a){var {Tornel:b}=a.npcs;for(const c of b.localDialogs.values())for(b=2;b<c.length;b++){const d=~c[b].condition;if(516<d&&524>=d&&!(d&1))return a.items[d&255]}return a.items.TornadoBracelet}
function Il(a){const b=a.rom.items;switch(a){case b.StatueOfOnyx:return"an unusual statue";case b.FluteOfLime:return"a rare instrument";case b.FogLamp:return"a brilliant lamp";case b.LovePendant:return"a beautiful charm";case b.KirisaPlant:return"a fragrant plant";case b.IvoryStatue:return"an exotic statue"}throw Error("impossible");}
function Jl(a){const b=a.rom.items;switch(a){case b.StatueOfOnyx:return"statue";case b.FluteOfLime:return"instrument";case b.FogLamp:return"lamp";case b.LovePendant:return"pendant";case b.KirisaPlant:return"plant";case b.IvoryStatue:return"statue"}throw Error("impossible");};function Nl(a){const {locations:{Portoa:b,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:d,UndergroundChannel:e,WaterfallCave2:f,WaterfallCave3:g}}=a;Ol(d,"edge:bottom",183,b);Ol(c,"door",146,e);Ol(f,"stair:up",191,g);{const {locations:{MtSabreNorth_Main:b,ValleyOfWind:c}}=a;for(var h of Pl(c,17))Ql(a.locations[h>>>8],h&255,a.flags.OpenedSealedCave);for(const c of Pl(b,4)){h=a.locations[c>>>8];if(h.data.fixed)continue;if(15<h.spawns.length)continue;var k=c&255;Ql(h,k,a.flags.OpenedPrison);const b=
h.meta.get(k).findExitByType("cave").entrance,d=yh.of({screen:k,coord:b,type:2,id:173});h.spawns.push(d);15<h.spawns.length||(k=yh.of({screen:k,coord:b-4112,type:4,id:44}),h.spawns.splice(1,0,k))}}}
function Ol(a,b,c,d){const [e,...f]=[...a.meta.exits()].filter(([,a])=>a===b);if(!e)throw Error(`Could not find ${b} in ${a}`);if(f.length)throw Error(`Ambiguous ${b} in ${a}`);const [g,h]=e[2];var k=g>>>8;if(k!==d.id){var l=g&255;a=a.rom.locations[k];k=a.meta.get(l).data.exits.find(a=>a.type===h);if(!k)throw Error(`Bad entrance in ${a}`);k=((k.entrance&61440)>>>8|(k.entrance&240)>>>4)+Rl[k.dir];17<a.spawns.length&&a.spawns.pop();var n=d.spawns.findIndex(a=>a.isTrigger()&&a.id===c);d=0<=n?d.spawns.splice(n,
1)[0]:yh.of({type:2,id:c});d.xt=(l&15)<<4|k&15;d.yt=l&240|k>>>4;a.spawns.push(d)}}const Rl=[16,0,0,0];
function Pl(a,b){const c=new Set([a,a.id<<8|b]),d=new Set;for(var e of a.meta.exits())e[0]!==b||"cave"!==e[1]&&"gate"!==e[1]||d.add(e[2]);b=[];for(const f of d){if(c.has(f[0]))continue;e=a.rom.locations[f[0]>>>8];const g=f[0]&255;if(!e.meta.customFlags.has(g))if("cave"===f[1]||"gate"===f[1])e=e.meta.get(g),"custom:true"===e.flag?b.push(f[0]):console.error(`No flag for ${e.name}`);else if(!c.has(e)){c.add(e);for(const a of e.meta.exits())"cave"!==a[1]&&"gate"!==a[1]&&d.add(a[2])}}console.log(`From ${a}: ${b.map(a=>
a.toString(16))}`);return b}function Ql(a,b,c,d){c?a.meta.customFlags.set(b,c):a.meta.customFlags.delete(b);d||(a===a.rom.locations.CordelPlainEast?Ql(a.rom.locations.CordelPlainWest,b,c,!0):a===a.rom.locations.CordelPlainWest&&Ql(a.rom.locations.CordelPlainEast,b,c,!0))};function Sl(a){const {locations:{AngrySea:b},npcs:{Dolphin:c},metascreens:{beachCabinEntrance:d,beachCave:e,beachExitN:f,boatChannel:g}}=a;c.spawnScripts=[];a=new Set(w(16,a=>a));for(let h=0;h<b.entrances.length;h++){let k=b.entrances[h],l=b.meta.get(k.screen),n;if(l===g){if(b.meta.get(k.screen-1)!==d)throw Error(`Bad boatChannel entrance ${k}`);k=uh.of({screen:k.screen-1,tile:0});l=d}l===d?n={entrance:uh.of({screen:k.screen-17,coord:47336}),movement:5}:l===e?n={entrance:uh.of({screen:k.screen,coord:59400}),
movement:8}:l===f&&(n={entrance:uh.of({screen:k.screen,coord:55544}),movement:9});n&&(a.delete(h),c.spawnScripts[h]=n)}[c.channelSpawn,c.evilSpiritIslandSpawn]=a;c.spawnScripts[c.channelSpawn]={entrance:uh.of({x:424,y:120}),movement:6};c.spawnScripts[c.evilSpiritIslandSpawn]={entrance:uh.of({x:424,y:120}),movement:7}};function Tl(a){var b,c=new Set;for(var d of a.locations)for(var e of null!==(b=d.pits)&&void 0!==b?b:[])c.add(e.dest<<8|e.toScreen);for(const f of c){b=a.locations[f>>8];const g=f&255;c=b.exits.filter(a=>a.screen===g);e=b.entrances.filter(a=>a.screen===g);c=new Map(c.map(a=>[a.tile,a]));d=new Fg;for(const a of c.keys())for(const b of Ul)c.has(a+b)&&d.union([a,a+b]);d=d.map();for(const a of e)for(const g of Ul){e=d.get(a.tile+g);for(const a of null!==e&&void 0!==e?e:[])e=c.get(a),e=vh.of({screen:f&
255,tile:a+g,dest:e.dest,entrance:e.entrance}),b.exits.push(e)}}}const Ul=[1,-1,16,-16];const Vl=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",
["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",
["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",
["Anti-Slime Pill","Maiden's Kiss"]]]),Wl=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),Xl=new Map([["Poison Slime",
["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Vision"]],["DYNA",["GLaDOS","HAL-9000",
"Multivac"]]]);
function Yl(a,b,c){if(b.communityJokes()){if(!(b.unidentifiedItems()||"sphereAnalysis"in globalThis)){b=.05>c.next()?a.items:[a.items[c.nextInt(72)]];for(var d of b){if(!d)continue;b=Vl.get(d.messageName)||[];const a=Math.floor(c.nextInt(3*b.length+1)/3);a<b.length?d.messageName=d.menuName=b[a]:d.messageName===d.menuName&&(d.messageName=d.menuName=Zl(d.messageName,c))}}$l(a,c);for(d=0;10>d;d++){const [d,f]=c.pick([...Xl]);b=c.pick(["",...f,...f,...f])||Zl(d,c);b!==d&&am(a,bm(d,b))}}}
function Zl(a,b){const c=a.split("");b=b.nextInt(c.length-1);if(" "===c[b]||" "===c[b+1])return a;c[b].toUpperCase()===c[b]?c.splice(b+1,1):[c[b],c[b+1]]=[c[b+1],c[b]];return c.join("")}function am(a,b){for(const c of a.messages.parts)for(const a of c)a.text=b(a.text);a.messages.personNames=a.messages.personNames.map(b);for(const c of a.objects)c.displayName&&(c.displayName=b(c.displayName))}function bm(a,b){return c=>c.includes(a)?c.split(a).join(b):c}
function $l(a,b){const c=[...Wl].flatMap(([a,b])=>["",...b,...b].map(b=>[a,b])),[d,e]=b.pick(c);b=e||Zl(d,b);b!==d&&am(a,bm(d,b))};function cm(a,b){var c=[...a.townWarp.locations].filter(a=>255!==a);b=b.nextInt(c.length);const d=c[b];let e=64;if(d===a.locations.Shyron.id||d===a.locations.Shyron_Temple.id)e=65;a.townWarp.thunderSwordWarp=[d,e];c=768-c.length+b;a=a.itemGets[3].flags;for(b=0;b<a.length;b++)if(765===a[b]){a[b]=c;return}a.push(c)};function dm(a,b,c){var d=new Set(w(256,a=>a).filter(b=>b in a.objects));for(var [e]of em)d.delete(e);for(const [b,c]of em)for(var f of d)a.objects[b].base===a.objects[f].base&&(em.set(f,c),d.delete(b));for(var g of[200,249,250])a.objects[g].attackType=240<g?254:255,a.objects[g].statusEffect=0;a.objects[125].elements|=8;e=new Set([87,94,104,125,136,151,155,158]);d=new Set([80,83,95,105]);for(const [h,{sdef:k,swrd:l,hits:n,satk:q,dgld:v,sexp:y}]of em)f=a.objects[h].data,g=e.has(h)?1:0,f[2]|=128,f[6]=
n,f[7]=q,f[8]=k|l<<4,f[16]=f[16]&15|v<<4,f[17]=y,(g?b.shuffleBossElements():b.shuffleMonsterElements())&&!d.has(h)&&(f=[...a.objects[h].elements.toString(2).padStart(4,"0")],c.shuffle(f),a.objects[h].elements=Number.parseInt(f.join(""),2));if(b.shuffleMonsterElements()){b=c.nextInt(4);for(const c of d)a.objects[c].elements=1<<b}}
const em=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],
[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b",
"Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,
"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",
4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],
[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,
,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",
,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",
,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,
"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([a,b,c,d=0,e=0,f=0,g=0,h=0,k=0])=>[a,{id:a,type:b,name:c,sdef:d,swrd:e,hits:f,satk:g,dgld:h,sexp:k}]));const fm=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),gm=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);
function hm(a,[b,c,[d,e]]){let f=fm.get(c)||gm.get(fm.get(e)),g=!1;const h=a.id.toString(16),k=(a.id<<8|b).toString(16)+" "+c,l=a.rom.locations[d>>>8],n=d&255;d=d.toString(16)+" "+e;const q=l.id.toString(16);e={loc:l,pos:n,type:e,area:q,key:d,reverse:null,origRev:null,get conn(){return gm.get(f)},set conn(a){f=gm.get(a)},get shuffle(){return g},set shuffle(a){if(a&&!f)throw Error("shuffle without conn");g=a}};a={loc:a,pos:b,type:c,key:k,reverse:e,area:h,origRev:e,get conn(){return f},set conn(a){f=
a},get shuffle(){return g},set shuffle(a){if(a&&!f)throw Error("shuffle without conn");g=a}};return e.reverse=e.origRev=a}function $p(a,b){return"string"===typeof b?a.type===b:"number"===typeof b?a.pos===b:b instanceof zk?a.reverse.loc===b:b.every(b=>$p(a,b))}
function aq(a,b,c){function d(a,...b){const c=[];for(const d of l.get(a))for(const a of b)if($p(d,a)){c.push(d);break}return c}function e(a,...b){for(const c of d(a,...b))c.shuffle=!0}function f(...a){const b=new Set(a);for(const c of a)for(const a of l.get(c))b.has(a.reverse.loc)||(a.shuffle=!0)}function g(){var a=new Set;const b=new Map,c=[];for(var d of[A,...v.keys()]){if(a.has(d))continue;const e=new Set([d]),f=[];for(const d of e){a.add(d);for(const g of v.get(d))b.set(g,c.length),f.push(g),
g.oneWay||a.has(g.reverse.area)||e.add(g.reverse.area)}c.push(f)}a=0;for(d=1;d<c.length;d++)c[d].length<c[a].length&&(a=d);return[c.length,b,c[a]]}if(b.shuffleAreas()){var {locations:h}=a,k=new Map,l=new da(()=>[]);for(var n of a.locations)for(const b of n.meta.exits())if(!(n===h.CordelPlainEast&&5>(b[0]&15)||n===h.CordelPlainWest&&4<(b[0]&15)||n.isTower()||(a=hm(n,b),a.loc===h.Portoa_FortuneTeller||a.reverse.loc===h.Portoa_FortuneTeller||k.has(a.key)))){if(k.has(a.reverse.key))throw Error(`Inconsistent exits: ${a.key} | ${a.reverse.key}`);
k.set(a.key,a);k.set(a.reverse.key,a.reverse);l.get(a.loc).push(a);l.get(a.reverse.loc).push(a.reverse)}for(const a of d(h.ValleyOfWind,"door","windmill"))a.area="windmill";for(const a of d(h.AngrySea,100))a.area="lighthouse";d(h.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;f(h.Leaf_OutsideStart);e(h.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right");f(h.WindmillCave);f(h.EastCave1,h.EastCave2,h.EastCave3);f(h.ZebuCave,h.MtSabreWest_Cave1);f(h.CordelPlainWest,h.CordelPlainEast);
f(h.WaterfallValleyNorth,h.WaterfallValleySouth);f(h.KirisaMeadow);f(h.LimeTreeLake);e(h.Portoa_FishermanIsland,"edge:right");e(h.PortoaPalace_ThroneRoom,"door");e(h.Joel,"edge:bottom");f(h.JoelSecretPassage);e(h.EvilSpiritIsland1,"stair:up");e(h.ZombieTown,"cave");e(h.AngrySea,"edge:top");f(h.SwanGate);e(h.GoaValley,"edge:left");f(h.Desert1);f(h.GoaFortressBasement);f(h.DesertCave1);f(h.SaharaOutsideCave);f(h.DesertCave2);e(h.Desert2,"stair:down");if(!b.shuffleHouses()){b=[[h.ZombieTown,"fortress"],
[h.MtHydra,"gate"],[h.Desert2,"fortress"],[h.Goa,"edge:top"],[h.Portoa,"fortress"],[h.Shyron,"fortress"],[h.GoaValley,"fortress"],[h.OasisCave_Entrance,"stair:up"],[h.MtHydra_OutsideShyron,"gate"],[h.Crypt_Entrance,"crypt"]];for(const [a,c]of b)[b]=d(a,c),b.conn="F",b.shuffle=!0}[b]=d(h.Oak,"edge:bottom");b.conn="X";b.shuffle=!0;b=new Fg;for(var q of k.values())q.shuffle||b.union([q.area,q.reverse.area]);var v=new da(()=>[]);for(var y of k.values())y.shuffle&&v.get(y.area=b.find(y.area)).push(y);
var A=l.get(h.MezameShrine)[0].area;h=new da(()=>[]);for(var z of k.values())z.shuffle&&z.conn&&h.get(z.conn).push(z);for(var R of"NWCF")for(z=h.get(R),q=c.shuffle([...z]).map(a=>a.reverse),y=0;y<q.length;y++)b=z[y],n=q[y],[b.reverse,n.reverse]=[n,b];R=0;for(var [G,E,L]=g();0<R--||1<G;){z=c.pick(L);q=h.get(z.conn);if(1<G){const a=E.get(z);q=q.filter(b=>E.get(b)!==a)}q=c.pick(q);y=z.reverse;b=q.reverse;z.reverse=b;b.reverse=z;q.reverse=y;y.reverse=q;[G,E,L]=g();if(-10>R)debugger}for(const a of k.values())a.reverse!==
a.origRev&&(c=function(a){return`${a.loc.name} ${a.type}(${a.pos.toString(16)})`},console.log(`${c(a)}  =>  ${c(a.reverse)}  (was ${c(a.origRev)})`)),a.loc.meta.attach(a.pos,a.reverse.loc.meta,a.reverse.pos,a.type,a.reverse.type)}};function bq(a){console.log("flip sabera entrance");const b=a[0];b.set2d(113,[[b.rom.metascreens.deadEndE_upStair],[b.rom.metascreens.caveEmpty]]);b.moveExits([129,"stair:down",113,"stair:up"]);a[1]=113;a[2]="stair:up"}function cq(a,b){console.log("flip karmine entrance");const c=a[0],d=c.rom.metascreens;c.set2d(32,[[d.caveEmpty,d.hallNS],[d.deadEndE_upStair,d.hallNW]]);c.replaceMonsters(b);c.moveExits([48,"stair:down",48,"stair:up"]);a[2]="stair:up"}
function dq(a){console.log("flip karmine exit");const b=a[0],c=b.rom.metascreens;b.set2d(1,[[c.deadEndS_stairs,c.caveEmpty]]);b.moveExits([2,"stair:down",1,"stair:up"]);a[1]=1;a[2]="stair:up"}function eq(a){console.log("flip generic exit");const b=a[0],c=b.rom.metascreens;2>b.width&&(b.width=2);b.set2d(0,[[c.hallSE,c.deadEndW_downStair]]);b.moveExits([0,"stair:up",1,"stair:down"]);a[1]=1;a[2]="stair:down"}
function fq(a,b){const c=a.locations;var d=[0,1,2,3];b.shuffle(d);const e=[[c.GoaFortress_Kelbesque.meta,131,"stair:down"],[c.GoaFortress_Sabera.meta,129,"stair:down",bq],[c.GoaFortress_Mado1.meta,114,"stair:down"],[c.GoaFortress_Karmine1.meta,48,"stair:down",cq]],f=[[c.GoaFortress_Zebu.meta,0,"stair:up",eq],[c.GoaFortress_Tornel.meta,0,"stair:up",eq],[c.GoaFortress_Asina.meta,0,"stair:up",eq],[c.GoaFortress_Kensu.meta,2,"stair:down",dq]],g=[[c.GoaFortress_Entrance.meta,0,"edge:top"]],h=[];var k=
!0;let l=g[0];for(const c of d){var n=k||e[c][3]||g[g.length-1][3];d=n?b.pick([!1,!0]):!0;console.log(`FLOOR ${c}: up ${k} flexible ${!!n} reverse ${d}`);n=d?f[c]:e[c];console.log(`push b ${a.locations[n[0].id].name}`);h.push(n);k!==("stair:down"===n[2])&&(n[3]?(k=n,k[3](k,b),k[3]=void 0):(k=l,k[3](k,b),k[3]=void 0));g.push(l=d?e[c]:f[c]);console.log(`push a ${a.locations[l[0].id].name}`);k="stair:up"===l[2]}k&&(a=l,a[3](a,b),a[3]=void 0);h.push([c.GoaFortress_Exit.meta,1,"stair:up"]);for(b=0;b<g.length;b++)g[b][0].attach(g[b][1],
h[b][0],h[b][1],g[b][2],h[b][2])};const gq=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),hq=new Set(["inn","armor","tool","pawn"]),iq=new Set([...hq,"house","tavern"]);
function jq(a,b,c){var d,e,f;const {locations:{Crypt_Hall1:g,Goa:h,GoaFortress_Exit:k,Shyron:l},metascreens:{squareTownNE_house:n,fortressTownEntrance:q,mountainPathE_gate:v}}=a,y=new Set([h.id,l.id]);var A=new Set([n.data.id,q.data.id,v.data.id]);if(b.shuffleAreas())for(var z of[h,k,l,g])z.data.houseType="palace";const R=new da(()=>[]);b=new da(()=>[]);z=new da(()=>new Set);for(var G of a.locations)if(G.used&&null!=G.data.houseType){var E=void 0;for(const [a,b,c]of G.meta.exits()){var L=(a&240)<<
4|G.meta.get(a).findExitByType(b).entrance>>>8;if(!E||L>E[3])E=[a,b,c,L]}for(const [c,d,e]of[E]){L={type:G.data.houseType,inside:[G.id<<8|c,d],outside:e};var fa=e[0];b.get(fa).push(L);R.get(G.data.houseType).push(L);z.get(a.locations[fa>>>8].screens[fa>>>4&15][fa&15]).add(fa)}}G=new Map;E=new Map;for(const [a,b]of c.ishuffle(z))2<=b.size||A.has(a)?E.set(a,b):G.set(a,b);const ba=new Set,lb=R.get("inn");for(const [,g]of[...E,...G]){A=new Map;z=!0;for(const h of g){for(const k of b.get(h)){G=z&&iq.has(k.type)?
[...iq].map(a=>R.get(a)):[R.get(null!==(d=A.get(k.outside[1]))&&void 0!==d?d:k.type)];G=G.filter(a=>a.length);"palace"===k.type&&y.has(k.outside[0]>>>8)&&(G=G.map(a=>a.filter(a=>!y.has(a.inside[0]>>>8))));E=[...g].every(a=>!ba.has(a>>>8));!E&&1<G.length?G=G.filter(a=>a!==lb):E&&G.some(a=>a===lb)&&(G=[lb]);E=c.pickAndRemove(...G);if("inn"===E.type)for(const a of g)ba.add(a>>>8);A.set(k.outside[1],E.type);a.spoiler&&a.spoiler.addHouse(E.inside[0]>>>8,k.outside[0]>>>8);Bh.connect(a,k.outside,E.inside);
z&&gq.get(k.type)!==gq.get(E.type)&&(G=a.locations[k.outside[0]>>>8],G.meta.tileset===a.metatilesets.town&&(L=Bh.findExitTiles(a,k.outside),1<L.length||(fa=L[0]-32,32>(L[0]&240)&&(fa-=3856),L=fa>>8,fa&=255,E=null!==(e=gq.get(E.type))&&void 0!==e?e:(null===(f=G.meta.get(L).data.tallHouses)||void 0===f?0:f.includes(fa))?33:6,a.screens[G.screens[L>>4][L&15]].tiles[fa]=E)))}z=!1}}};const kq=1/2147483563;
class lq{constructor(a=Math.floor(4294967296*Math.random())){this.iy=this.idum2=this.idum=0;this.iv=[];this.z1=null;this.seed(a)}static newSeed(){return Math.floor(4294967296*Math.random())}seed(a){this.idum2=this.idum=Math.max(1,Math.floor(a));this.iy=0;this.iv=Array(32).fill(0);for(a=39;0<=a;a--){const b=Math.floor(this.idum/53668);this.idum=40014*(this.idum-53668*b)-12211*b;0>this.idum&&(this.idum+=2147483563);32>a&&(this.iv[a]=this.idum)}this.iy=this.iv[0]}next(){var a=Math.floor(this.idum/53668);
this.idum=40014*(this.idum-53668*a)-12211*a;0>this.idum&&(this.idum+=2147483563);a=Math.floor(this.idum2/52774);this.idum2=40692*(this.idum2-52774*a)-3791*a;0>this.idum2&&(this.idum2+=2147483399);a=Math.floor(this.iy/67108862);this.iy=this.iv[a]-this.idum2;this.iv[a]=this.idum;1>this.iy&&(this.iy+=2147483562);return Math.min(kq*this.iy,.99999988)}nextInt(a){return Math.floor(this.next()*a)}nextNormal(a=0,b=1,c=-Infinity,d=Infinity){for(;;){let e=this.z1;if(null==e){const a=Math.sqrt(-2*Math.log(this.next())),
b=mq*this.next();e=a*Math.cos(b);this.z1=a*Math.sin(b)}else this.z1=null;e=a+e*b;if(e>=c&&e<=d)return e}}shuffle(a){for(let b=a.length;b;){const c=this.nextInt(b--);[a[b],a[c]]=[a[c],a[b]]}return a}*ishuffle(a){const b=[];if(!Array.isArray(a)){if("size"in a){var c=a[Symbol.iterator]();for(var d=0;d<a.size;d++){const e=d+this.nextInt(a.size-d);for(;b.length<=e;)b.push(c.next().value);yield b[e];b[e]=b[d]}return}a=[...a]}if(!Array.isArray(a))throw Error("impossible");for(c=0;c<a.length;c++)d=c+this.nextInt(a.length-
c),yield d in b?b[d]:a[d],b[d]=c in b?b[c]:a[c]}pick(a){if(!a.length)throw Error("empty array");return a[this.nextInt(a.length)]}pickWeighted(a){if(!a.length)throw Error("empty array");var b=0;for(const [c]of a)b+=c;b*=this.next();for(const [c,d]of a){if(b<c)return d;b-=c}throw Error("bad weights");}pickAndRemove(...a){var b=0;for(const c of a)b+=c.length;if(!b)throw Error("empty arrays");b=this.nextInt(b);for(const c of a){if(b<c.length)return c.splice(b,1)[0];b-=c.length}throw Error("impossible");
}bitGenerator(){let a=0,b=0;return()=>{a||(a=32,b=this.nextInt(4294967296));a--;const c=!(b&1);b>>>=1;return c}}}const mq=2*Math.PI;function nq(a,b,c){b=a.locations;oq(a,c);a=new sj(a,c);a.add();a.shuffles.length||a.add(new M(b.EastCave1),new M(b.EastCave2),new M(b.EastCave3),...Aj(b.SealedCave1,b.SealedCave2),new M(b.SealedCave3),new M(b.SealedCave4),new M(b.SealedCave5),new M(b.SealedCave6),new M(b.SealedCave7),new M(b.SealedCave8),new M(b.WindmillCave),new M(b.ZebuCave),new dk(b.Swamp),new M(b.MtSabreWest_Cave1),new M(b.MtSabreWest_Cave2),new M(b.MtSabreWest_Cave3),new M(b.MtSabreWest_Cave4),new M(b.MtSabreWest_Cave5),new M(b.MtSabreWest_Cave6),
new yj(b.MtSabreWest_Cave7),new M(b.MtSabreNorth_Cave1),new M(b.MtSabreNorth_Cave2),new M(b.MtSabreNorth_Cave3),new M(b.MtSabreNorth_Cave4),new M(b.MtSabreNorth_Cave5),new M(b.MtSabreNorth_Cave6),new M(b.MtSabreNorth_Cave7),new M(b.MtSabreNorth_Cave8),new M(b.MtSabreNorth_Cave9),new M(b.MtSabreNorth_LeftCell2),new M(b.MtSabreNorth_SummitCave),new M(b.KirisaPlantCave1),new M(b.KirisaPlantCave2),new M(b.KirisaPlantCave3),new M(b.FogLampCave1),new M(b.FogLampCave2),new M(b.FogLampCave3),new zj(b.FogLampCaveDeadEnd),
...Aj(b.FogLampCave5,b.FogLampCave4,!0),...Aj(b.FogLampCave7,b.FogLampCave6),new yj(b.WaterfallCave1),new M(b.WaterfallCave2),new wj(b.WaterfallCave3),new Xj(b.WaterfallCave4),(new Wj(b.EvilSpiritIsland2)).requirePitDestination(),new yj(b.EvilSpiritIsland3),new Wj(b.EvilSpiritIsland4),(new Vj(b.SaberaPalace1)).requirePitDestination(),new M(b.SaberaPalace2),new M(b.SaberaPalace2_West),new M(b.JoelSecretPassage),new M(b.MtHydra_Cave1),new M(b.MtHydra_Cave2),new M(b.MtHydra_Cave3),new M(b.MtHydra_Cave4),
new M(b.MtHydra_Cave5),new M(b.MtHydra_Cave6),new wj(b.MtHydra_Cave7),new M(b.MtHydra_Cave8),new M(b.MtHydra_Cave9),new M(b.MtHydra_Cave10),(new wj(b.Styx1)).setUpEdgeType("c"),(new bk(b.Styx2)).requirePitDestination(),new M(b.Styx3),new ck(b.OasisCaveMain),new M(b.DesertCave1),new M(b.DesertCave2),new M(b.Pyramid_Branch),new Rj(b.Pyramid_Main),new xj(b.Crypt_Entrance),(new wj(b.Crypt_Hall1)).setUpEdgeType("c"),new M(b.Crypt_DeadEndLeft),new M(b.Crypt_DeadEndRight),new M(b.Crypt_Branch),new M(b.Crypt_Hall2),
new Gj(b.GoaFortress_Kelbesque),new Wj(b.GoaFortress_Sabera),(new M(b.GoaFortress_Mado1)).requirePitDestination(),new M(b.GoaFortress_Mado2),new M(b.GoaFortress_Mado3),new M(b.GoaFortress_Karmine1),new M(b.GoaFortress_Karmine2),new M(b.GoaFortress_Karmine4),new Mj(b.GoaFortress_Karmine6),...Ij(b.GoaFortress_Karmine3,b.GoaFortress_Karmine5,b.GoaFortress_Kensu),new Yj(b.OasisCave_Entrance));a.shuffleAll();console.log(String(a))}
function oq(a,b=new lq(1)){Fj(a);{const {swamp:b}=a.metatilesets,d=a.metascreens,e=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(const [a,c,d]of e)b.getTile(a).copyFrom(c).setAlternative(d);d.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]);d.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]);
d.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]);d.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]);d.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]);d.registerFix(N.SwampDoors,0)}Hj(a,b)};function pq(a,b,c){const d=[],e=[];for(const c of a.locations)if(!qq.has(c.id))for(const g of c.spawns)if(g.isChest()){var f=a.slots[g.id];112<=f&&e.push(g.id);if(b.preserveUniqueChecks()&&(f=a.itemGets[f],f=a.items[null===f||void 0===f?void 0:f.itemId],null===f||void 0===f?0:f.unique))continue;g.isInvisible()||d.push(g.id)}c.shuffle(d);a.slots.setMimicCount(e.length);[...ha.zip(e,d,(b,c)=>a.slots.swap(b,c))]}const qq=new Set([182]);function rq(a,b){for(const c of a.locations)88!==(c.id&248)&&c.meta.replaceMonsters(b)};class sq{constructor(a){this.rom=a;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;var b=new da(()=>[]);for(var c of a.locations)if(c.used)for(var d=0;d<c.spawns.length;d++){const a=c.spawns[d];a.used&&(a.isMonster()?b.get(a.monsterId).push([c,d,a]):(a.isNpc()||a.isBoss())&&b.get(~a.id).push([c,d,a]))}for(const [e,f]of b)if(0>e){b=a.npcs[~e];c=[b.data[3]];if(!a.metasprites[c[0]])throw Error(`bad NPC: ${~e}`);208===b.data[2]&&c.push(192);b=this.computeConstraint(c,
f,!0,128>b.data[2]?b.data[2]&112:0);95===~e&&(b=b.ignorePalette());this.npcConstraints.set(~e,b)}else{c=Lg.ALL;b=this.rom.objects[e];for(const g of tq(a,b)){d=a.objectActions[g.action];d=this.computeConstraint(((null===d||void 0===d?void 0:d.data.metasprites)||(()=>[g.metasprite]))(g),f,g.id===e,g.data[1]);d=c.meet(d);if(!d)throw Error(`Bad meet for ${e} with ${g.id}`);d&&(c=d);if(g.data[4]&2&&(d=this.computeConstraint([g.data[20]],f,!1,g.data[1]),c=c.meet(d),!c))throw Error(`Bad meet for ${e} bonus ${g.id}`);
}this.monsterConstraints.set(b.id,c);b.constraint=c}}getMonsterConstraint(a,b){const c=this.monsterConstraints.get(b)||Lg.NONE;return 88!==(a&88)&&this.rom.objects[b].goldDrop?c.meet(Lg.COIN)||Lg.NONE:c}getNpcConstraint(a,b){const c=this.npcConstraints.get(b)||Lg.NONE;return 30===a&&96===b?c.meet(Lg.STOM_FIGHT):160===a&&201===b?c.meet(Lg.GUARDIAN_STATUE):c}shufflePalettes(a){const b=[...this.allSpritePalettes];for(const [c,d]of this.monsterConstraints)this.monsterConstraints.set(c,d.shufflePalette(a,
b));for(const [c,d]of this.npcConstraints)this.npcConstraints.set(c,d.shufflePalette(a,b))}configure(a,b){if(b.used){var c=this.rom.slots[b.id];if(c=b.isMonster()?this.monsterConstraints.get(b.monsterId):b.isNpc()?this.npcConstraints.get(b.id):b.isChest()?112>c?Lg.TREASURE_CHEST:Lg.MIMIC:void 0){if(3===c.shift||2<=c.float.length)throw Error("don't know what to do with two floats");if(!c.float.length)b.patternBank=Number(2===c.shift);else if(c.float[0].has(a.spritePatterns[0]))b.patternBank=0;else if(c.float[0].has(a.spritePatterns[1]))b.patternBank=
1;else if(b.isMonster())throw Error("no matching pattern bank");}}}computeConstraint(a,b,c,d=0){const e=new Set,f=new Set;for(const b of a.map(a=>this.rom.metasprites[a])){for(const a of b.palettes())f.add(a);for(const a of b.patternBanks(d))e.add(a)}c=c&&1==e.size&&2===[...e][0];a=new Map;for(const [d,,e]of b)a.set(e.patternBank&&c?~d.id:d.id,e);b=void 0;for(let [d,h]of a){a=this.rom.locations[0>d?~d:d];for(const b of f)1<b&&this.allSpritePalettes.add(a.spritePalettes[b-2]);a=Lg.fromSpawn(f,e,a,
h,c);b=b?b.join(a):a;!c&&h.patternBank&&(b=b.shifted())}if(!b)throw Error("Expected child to appear");return b}}function*tq(a,b){yield b;var c=b.spawnedReplacement();c&&(yield*tq(a,c));(c=b.spawnedChild())&&(yield*tq(a,c));80===b.id&&(yield a.objects.largeBlueSlime);83===b.id&&(yield a.objects.largeRedSlime)};function uq(a,b,c){const d=new sq(a);b.shuffleSpritePalettes()&&d.shufflePalettes(c);b=new vq(b,{});for(const c of a.locations)c.used&&b.populate(c);b.shuffle(c,d)}
class vq{constructor(a,b){this.flags=a;this.report=b;this.monsters=[];this.used=[];this.locations=[]}populate(a){var b=wq[a.id]||{},c=Object.assign({},b);const d=void 0===b.skip?!1:b.skip;b=void 0===b.tower?!1:b.tower;c=(delete c.maxFlyers,delete c.nonFlyers,delete c.skip,delete c.tower,delete c.fixedSlots,c);for(var e of Object.keys(c))throw Error(`Unexpected property '${e}' in MONSTER_ADJUSTMENTS[${a.id}]`);var f=!0===d||!this.flags.shuffleTowerMonsters()&&b||!a.spritePatterns||!a.spritePalettes;
e=[];c=[];b=12;for(const d of f?[]:a.spawns){++b;if(!d.used||!d.isMonster())continue;f=d.monsterId;if(!em.has(f)||"m"!==em.get(f).type)continue;var g=a.rom.objects[f];if(!(g instanceof J))continue;const k=d.patternBank,n=a.spritePatterns[k];var h=g.palettes(!0);g=h.includes(2)?a.spritePalettes[0]:void 0;h=h.includes(3)?a.spritePalettes[1]:void 0;e.push({id:f,pat:n,pal2:g,pal3:h,patBank:k});(this.report[`start-${f.toString(16)}`]=this.report[`start-${f.toString(16)}`]||[]).push("$"+a.id.toString(16));
c.push(b)}if(!e.length||d)c=[];this.locations.push({location:a,slots:c});this.monsters.push(...e)}shuffle(a,b){const c=b.rom;this.report["pre-shuffle locations"]=this.locations.map(a=>a.location.id);this.report["pre-shuffle monsters"]=this.monsters.map(a=>a.id);a.shuffle(this.locations);a.shuffle(this.monsters);this.report["post-shuffle locations"]=this.locations.map(a=>a.location.id);for(this.report["post-shuffle monsters"]=this.monsters.map(a=>a.id);this.locations.length;){const {location:f,slots:g}=
this.locations.pop(),h=this.report["$"+f.id.toString(16).padStart(2,"0")]=[],{maxFlyers:k=0,nonFlyers:l={},tower:n=!1}=wq[f.id]||{};if(n)continue;let q=k,v=Lg.forLocation(f.id);f.bossId();for(const a of f.spawns)if(a.isChest()&&!a.isInvisible())v=112>c.slots[a.id]?v.meet(Lg.TREASURE_CHEST,!0):v.meet(Lg.MIMIC,!0);else if(a.isNpc()||a.isBoss()){var d=b.getNpcConstraint(f.id,a.id);v=v.meet(d,!0);!a.isNpc()||107!==a.id&&104!==a.id||(v=v.meet(Lg.KENSU_CHEST,!0))}else!a.isMonster()||c.objects[a.monsterId]instanceof
J?a.isShootingWall(f)&&(v=v.meet(Lg.SHOOTING_WALL,!0)):(d=b.getMonsterConstraint(f.id,a.monsterId),v=v.meet(d,!0));h.push(`Initial pass: ${v.fixed.map(a=>Infinity>a.size?"["+[...a].join(", ")+"]":"all")}`);const y=new Map;d=a=>{var d=c.objects[a.id];if(d.monsterClass){var e=y.get(d.monsterClass);if(null!=e&&e!==a.id)return!1}e=xq.has(a.id);var k=yq.has(a.id);if(e){if(!q)return!1;--q}const n=b.getMonsterConstraint(f.id,a.id);var z=v.tryMeet(n);!z&&Infinity>v.pal2.size&&Infinity>v.pal3.size&&this.flags.shuffleSpritePalettes()&&
(z=v.tryMeet(n,!0));if(!z)return!1;if(A){var ba=c.objects[a.id];if(!(ba instanceof J))throw Error(`non-monster: ${ba}`);ba=A(ba);if(null==ba)return!1}h.push(`  Adding ${a.id.toString(16)}: ${z}`);v=z;d.monsterClass&&y.set(d.monsterClass,a.id);d=0;if(e||k)for(k=0;k<g.length;k++){if(g[k]in l){d=k;break}}else for(k=0;k<g.length;k++)if(!(g[k]in l)){d=k;break}(this.report[`mon-${a.id.toString(16)}`]=this.report[`mon-${a.id.toString(16)}`]||[]).push("$"+f.id.toString(16));k=g[d];z=f.spawns[k-13];e?(z.data[0]=
253,z.data[1]=255):A?(z.screen=ba>>>8,z.tile=ba&255):k in l&&(z.y+=16*l[k][0],z.x+=16*l[k][1]);z.monsterId=a.id;h.push(`    slot ${k.toString(16)}: ${z}`);g.splice(d,1);return!0};const A=f.monstersMoved||g.length&&this.flags.randomizeMaps()?f.monsterPlacer(a):null;if(q&&g.length)for(var e=0;e<Math.min(40,this.monsters.length);e++)xq.has(this.monsters[e].id)&&d(this.monsters[e])&&this.monsters.splice(e,1);for(e=0;e<this.monsters.length&&g.length;e++)if(d(this.monsters[e])){const [a]=this.monsters.splice(e,
1);xq.has(a.id)||this.used.push(a);e--}for(e=0;e<this.used.length&&g.length;e++)d(this.used[e])&&(this.used.push(...this.used.splice(e,1)),e--);v.fix(f,a);if(g.length){console.error(`Failed to fill location ${f.id.toString(16)} ${f.name}: ${g.length} remaining`);for(const a of g)d=f.spawns[a-13],d.x=d.y=0,d.id=176,d.data[0]=254}for(const a of f.spawns)b.configure(f,a)}}}
const xq=new Set([89,92,110,111,129,138,163,196]),yq=new Set([85,93,124,188,193]),wq={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,
-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,
pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},
[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,
8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};class zq{constructor(a,b,c){this.rom=a;this.flags=b;this.random=c}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){var a=new da(()=>[]);for(var b of this.rom.locations)b.tilePalettes.some(a=>154!==a)&&a.get(b.colorGroup).push(b);b=[new Map,new Map];for(var c of a.values())for(var d of c)for(let a=0;2>a;a++)for(let c=0;2>c;c++){let e=b[a].get(d.tilePatterns[c]);e||b[a].set(d.tilePatterns[c],e=new Set);e.add(d.tilePalettes[a])}for(const e of a.values()){c=e[0];a=[new Set,new Set];for(d=0;2>
d;d++)a[d]=new Set([...b[d].get(c.tilePatterns[0]),...b[d].get(c.tilePatterns[1])]);c=this.random.pick([...a[0]]);a=this.random.pick([...a[1]]);for(const b of e)b.tilePalettes[0]=c,b.tilePalettes[1]=a}}};function Aq(a,b){if(b.eastCave){{b=b.eastCave;const {locations:{EastCave1:d,EastCave2:e,EastCave3:f,SealedCave1:g,ValleyOfWind:h},metascreens:{boundaryE_cave:k,branchNSE:l,branchNWE:n,branchNWSE:q,branchNWS:v,branchWSE:y,caveEmpty:A,deadEndE:z,deadEndE_downStair:R,deadEndE_upStair:G,deadEndN_stairs:E,deadEndS:L,deadEndS_stairs:fa,deadEndW:ba,deadEndW_downStair:lb,hallNE:ea,hallNS:Eb,hallNW:sb,hallSE:xc,hallWS:bc,hallWE:yb,hallNS_entrance:zb,hallNS_ramp:Nc,hallNS_wall:kd}}=a;a.locations.allocate(d);
a.locations.allocate(e);b.exit2&&a.locations.allocate(f);for(var c of[d,e,f])c.bgm=c.originalBgm=23,c.entrances=[],c.exits=[],c.pits=[],c.spawns=[],c.flags=[],c.width=c.height=1,c.screens=[[128]],c.tilePalettes=[26,27,5],c.originalTilePalettes=[26,27,5],c.tileset=136,c.tileEffects=181,c.tilePatterns=[20,2],c.spritePatterns=[...g.spritePatterns],c.spritePalettes=[...g.spritePalettes];d.meta=new Bh(d.id,a.metatilesets.cave,5,5);d.meta.set2d(0,[[z,bc,A,xc,ba],[A,Eb,xc,sb,A],[xc,q,v,A,A],[Eb,Nc,ea,yb,
bc],[zb,ea,ba,G,sb]]);e.meta=new Bh(e.id,a.metatilesets.cave,5,5);e.meta.set2d(0,[[z,bc,L,A,L],[A,Eb,Eb,A,Eb],[A,l,n,y,sb],[A,Nc,A,ea,bc],[z,sb,A,A,E]]);h.meta.set2d(51,[[k]]);a.tileEffects[0].effects[192]=0;d.meta.attach(67,e.meta,68);d.meta.attach(64,h.meta,51);b.exit1&&(d.meta.set2d(4,[[lb]]),Bq(d,4,b.exit1));b.exit2&&(f.meta=new Bh(f.id,a.metatilesets.cave,3,1),f.meta.set2d(0,[[fa],[kd],[zb]]),f.spawns.push(yh.from([24,7,35,0])),f.flags.push(wh.of({screen:16,flag:a.flags.alloc(512)})),e.meta.set2d(64,
[[R]]),e.meta.attach(64,f.meta,0),Bq(f,32,b.exit2));d.spawns.push(yh.of({screen:33,tile:135,timed:!0,id:2}),yh.of({screen:18,tile:136,timed:!1,id:2}),yh.of({screen:19,tile:137,timed:!0,id:2}),yh.of({screen:50,tile:104,timed:!1,id:2}),yh.of({screen:65,tile:136,timed:!0,id:2}),yh.of({screen:51,tile:152,timed:!0,id:2}),yh.of({screen:3,tile:136,timed:!0,id:2}));e.spawns.push(yh.of({screen:1,tile:136,timed:!0,id:2}),yh.of({screen:17,tile:72,timed:!1,id:2}),yh.of({screen:18,tile:119,timed:!0,id:2}),yh.of({screen:20,
tile:40,timed:!1,id:2}),yh.of({screen:35,tile:133,timed:!0,id:2}),yh.of({screen:49,tile:136,timed:!0,id:2}),yh.of({screen:51,tile:138,timed:!1,id:2}),yh.of({screen:52,tile:152,timed:!0,id:2}),yh.of({screen:65,tile:130,timed:!0,id:2}),yh.of({y:272,x:1144,type:2,id:89}),yh.of({y:112,x:264,type:2,id:124}));a.slots.swap(49,89)}}else if(b.classicLimeTreeToLeaf){{const {locations:{ValleyOfWind:b,LimeTreeValley:c},metascreens:{exitE:f,exitW_southwest:g,overworldEmpty_alt:h}}=a;b.meta.set2d(84,[[f]]);c.meta.set2d(16,
[[g],[h]]);b.meta.attach(84,c.meta,16)}}{const {TowerEntrance:b,Crypt_Teleporter:c}=a.locations;c.meta.attach(0,b.meta,0,"teleporter","teleporter")}{const {flags:{OpenedSwanGate:b},locations:{SwanGate:c},npcs:{SoldierGuard:f}}=a;c.spawns.push(yh.of({xt:10,yt:2,type:1,id:45}),yh.of({xt:11,yt:2,type:1,id:45}));f.localDialogs.get(c.id)[0].flags.push(b.id)}c=a.locations.GoaFortress_Kensu.meta;for(const [a,b]of c.exits())16>a||b.startsWith("seamless")||c.deleteExit(a,b);Cq(a);Dq(a.locations.SaberaPalace2_West,
a.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}(function(a){a.generateOptions=function(a,c){const b={};if(a.addEastCave()){b.eastCave={};a=["cordel","lime","goa","desert"];let d=c.nextInt(4);[b.eastCave.exit1]=a.splice(d,1);b.eastCave.exit2=c.pick(a)}else a.connectLimeTreeToLeaf()&&(b.classicLimeTreeToLeaf=!0);return b}})(Aq||(Aq={}));
function Bq(a,b,c){const {locations:{CordelPlainEast:d,CordelPlainWest:e,Desert2:f,GoaValley:g,LimeTreeValley:h},metascreens:{bendNE:k,bendSE:l,boundaryN_trees:n,boundaryW_cave:q,cornerNE:v,cornerNW:y,cornerSE:A,cornerSE_cave:z,cornerSW:R}}=a.rom;let G,E;switch(c){case "lime":G=h;E=16;G.resizeScreens(0,1,0,0);G.meta.spliceColumns(0,1,2,[[y,n],[q,l],[R,A]]);break;case "cordel":c=[[q,l],[R,A]];G=d;E=85;G.meta.set2d(85,c);e.meta.set2d(85,c);break;case "goa":G=g;E=17;G.meta.set2d(1,[[y,v],[q,k]]);break;
case "desert":G=f,E=83,G.meta.set2d(83,[[z]])}a.meta.attach(b,G.meta,E)}
function Dq(a,b,...c){a.rom.locations.allocate(a,b);a.bgm=b.bgm;a.entrances=[];a.exits=[];a.pits=[];a.spawns=[];a.flags=[];a.width=a.height=1;a.screens=[[128]];a.tilePalettes=[...b.tilePalettes];a.originalTilePalettes=[...b.originalTilePalettes];a.tileset=b.tileset;a.tileEffects=b.tileEffects;a.tilePatterns=[...b.tilePatterns];a.spritePatterns=[...b.spritePatterns];a.spritePalettes=[...b.spritePalettes];let d=0,e=0;for(const a of c)d=Math.max(d,(a>>>4)+1),e=Math.max(e,(a&15)+1);a.meta=new Bh(a.id,
b.meta.tileset,d,e);for(const d of c)a.meta.set(d,b.meta.get(d)),b.meta.set(d,b.meta.tileset.empty);const f=new Set(c);a.flags=b.flags.filter(a=>f.has(a.screen));b.flags=b.flags.filter(a=>!f.has(a.screen));a.spawns=b.spawns.filter(a=>f.has(a.screen));b.spawns=b.spawns.filter(a=>!f.has(a.screen));b.meta.moveExitsAndPitsTo(a.meta)}function Cq(a){a.locations.ZebuCave.spawns.find(a=>a.isTrigger()).yt+=3};const Eq="!Random Key;!Curious Key;!Bronze Key;!Silver Key;!Golden Key;!Ancient Key;!Small Key;!Shiny Key;!Mysterious Key;!Magic Key;!Backdoor Key;!Skeleton Key;Piano Key;Encryption Key;Private Key;Public Key;Key Card;Any Key;Space Bar;Return Key;Imaginary Key;Giant Key;Out of Key;Key of C;Key of G;Key of B Flat;Key of F Sharp;Lockpick;Transponder Key;Sharp Key;Flat Key;Locke and Key;Major Key;Minor Key;Cookie;Turkey;Monkey;Ctrl Key;Escape Key;Car Key;Clock Key;Florida Key;Key Lime Pie;Keystone;Answer Key".split(";"),
Fq="!Random Flute;!Wooden Flute;!Metal Flute;!Piccolo;Horn of Plenty;!Ocarina;Fairy Ocarina;Ocarina of Time;!Pan Pipes;!Bugle;!Bagpipes;Kazoo;Lute;Harp;Guitar;Electric Guitar;!Tin Whistle;Magic Whistle;Dog Whistle;!Recorder;!Accordion;!Harmonica;Sousaphone;Trumpet;French Horn;Trombone;Euphonium;Tuba;Clarinet;Saxophone;Oboe;Bassoon;Violin;Viola;Cello;Theramin;Synthesizer;Moog Synth;Piano;Harpsichord;Pipe Organ;Note Block;Snare Drum;Xylophone;Marimba;Tambourine;Tornelsbane;Flute of Power".split(";"),
Gq="!Random Lamp;!Bronze Lamp;!Silver Lamp;!Gold Lamp;!Oil Lamp;!Magic Lamp;Genie Lamp;Dull Lamp;Desk Lamp;Shimmering Lamp;Broken Lamp;Brass Lantern;Overhead Lamp;Pedestal Lamp;Incubation Lamp;Fluorescent Lamp;Ultraviolet Lamp;Heat Lamp;Recessed Lighting;Laser Pointer;Spotlight;Flashlight;Search Light;Batsignal;Candelabra;Chandelier;Birthday Candle;Tallow Candle;Wax Candle;Tanning Bed;CRT".split(";"),Hq="!Random Statue;!Rusty Statue;!Forbidden Statue;Golden Idol;!Strange Statue;!Glass Statue;!Copper Statue;!White Statue;Invisible Statue;Burt Figurine;Draygon Figurine;Karmine Figurine;Mado Figurine;Sabera Figurine;Kelbesque Figurine;Flail Guy Trophy;Metroid Amiibo;Model of Dyna;Jeff Peters Statue;M. Toki Statue;Statue of Liberty;Colossus of Rhodes;Mattrick Figurine;Dragondarch Statue;Overswarm Statue;Trueblue83 Statue;TheAxeMan Idol;Acmlm Figurine;CodeGorilla Trophy".split(";"),
Iq="!Random Bow;Crossbow;Autocrossbow;Long Bow;Compound Bow;Silver Arrows;Wooden Bow;Violin Bow;Tae Bo;Botox;Bo Derek;Bo Diddley;Bo Dallas;Rainbow;Hair Bow;Bow Tie;!Bow of Earth;!Bow of Stars;!Bow of Wind;!Bow of Fire;!Bow of Water;!Bow of Thunder;!Bow of Light;!Bow of Darkness;Bow of Lies;Bow of Life;Bow of Death;Bow of Freedom;JBowe;KLINGSBO;LILLABO;SVALBO;Buriza-Do Kyanon;Windforce;Eaglehorn".split(";");
function Jq(a,b,c){if(b.unidentifiedItems()){var d=(...b)=>b.map(b=>a.items[b]),e=d(50,51,52),f=d(39,40,49,54),g=d(53,57),h=d(37,56,58,61);d=d(62,63,64);for(const [k,[...l]]of[[e,Eq],[f,Fq],[g,Gq],[h,Hq],[d,Iq]]){e=(b.communityJokes()?l:l.filter(a=>a.startsWith("!"))).map(a=>a.replace(/^!/,""));c.shuffle(e);f=c.shuffle([0,1,2,3]);for(const b of k)g=e.pop(),a.spoiler&&a.spoiler.addUnidentifiedItem(b.id,b.messageName,g),b.menuName=b.messageName=g,b.palette=f.pop()}}};function Kq(a){({locations:a}=a);const {CordelPlainEast:b,CordelPlainWest:c,WaterfallValleyNorth:d,WaterfallValleySouth:e,MezameShrine:f,MtSabreWest_Cave1:g}=a;b.meta.reconcileExits(c.meta);for(const a of d.meta.allPos()){const b=d.meta.get(a),c=e.meta.get(a);b.isEmpty()&&!c.isEmpty()?d.meta.set(a,c):c.isEmpty()&&!b.isEmpty()&&e.meta.set(a,b)}for(const b of a)b.used&&(b.exits=[],b.entrances=[],b.meta.writeEntrance0());f.meta.getExit(0,"door")||f.meta.attach(0,f.meta,0,"door","door");for(const b of a)b.used&&
b!==g&&(b.meta.write(),b===c&&g.used&&g.meta.write())};class Lq extends ug{constructor(a,b){super(a,b);this.data=Xd(a.prg,this.base,4)}get base(){return(this.id<<2)+171008}get slotRangeLower(){return this.data[0]}set slotRangeLower(a){this.data[0]=a}get slotRangeUpper(){return this.data[1]}set slotRangeUpper(a){this.data[1]=a}get objectId(){return this.data[2]}set objectId(a){this.data[2]=a}get count(){return this.data[3]}set count(a){this.data[3]=a}write(){const a=this.rom.assembler();a.segment("14");a.org(39936+(this.id<<2));a.byte(...this.data);return[a.module()]}}
;class Mq extends ug{constructor(a,b){super(a,b);this.base=ee(a.prg,this.pointer);this.data=a.prg.slice(this.base+81920,this.base+81941);this.palettes=this.data.subarray(5,13);this.patterns=this.data.subarray(13,19)}get pointer(){return 129387+2*this.id}get routine(){const a=ee(this.data,0);return a&&a+81920}set routine(a){var b=this.data;a=a?a-81920:0;b[0]=a&255;b[1]=a>>>8}get restoreMusic(){return this.data[3]}set restoreMusic(a){this.data[3]=a}get itemDrop(){return this.data[4]}set itemDrop(a){this.data[4]=
a}get restoreAnimation(){return this.data[19]}set restoreAnimation(a){this.data[19]=a}get explode(){return!!this.data[20]}set explode(a){this.data[20]=a?1:0}write(){if(!this.base)return[];const a=this.rom.assembler();a.segment("0f");a.org(this.base);a.byte(this.data[0],this.data[1]);a.org(this.base+4);a.byte(this.data[4]);return[a.module()]}};const {$0f:Nq,$1b:Oq}=B;
class Pq{constructor(a){this.rom=a;this.Vampire1=new Qq(this,{flag:this.rom.flags.Vampire1,kill:0,npc:this.rom.npcs.Vampire1,shuffled:!0,sword:1});this.Insect=new Qq(this,{flag:this.rom.flags.GiantInsect,kill:1,npc:this.rom.npcs.Insect,sword:1});this.Kelbesque1=new Qq(this,{flag:this.rom.flags.Kelbesque1,kill:2,npc:this.rom.npcs.Kelbesque1,shuffled:!0});this.Rage=new Qq(this,{flag:this.rom.flags.Rage,kill:3,npc:this.rom.npcs.Rage});this.Sabera1=new Qq(this,{address:222574,flag:this.rom.flags.Sabera1,
kill:4,npc:this.rom.npcs.SaberaDisguisedAsMesia,shuffled:!0});this.Vampire2=new Qq(this,{flag:this.rom.flags.Vampire2,kill:12,npc:this.rom.npcs.Vampire2,shuffled:!0,sword:1});this.Mado1=new Qq(this,{address:251936,flag:this.rom.flags.Mado1,kill:5,shuffled:!0});this.Kelbesque2=new Qq(this,{flag:this.rom.flags.Kelbesque2,kill:6,npc:this.rom.npcs.Kelbesque2,shuffled:!0});this.Sabera2=new Qq(this,{flag:this.rom.flags.Sabera2,kill:7,npc:this.rom.npcs.Sabera2,shuffled:!0});this.Mado2=new Qq(this,{flag:this.rom.flags.Mado2,
kill:8,npc:this.rom.npcs.Mado2,shuffled:!0});this.Karmine=new Qq(this,{flag:this.rom.flags.Karmine,kill:9,npc:this.rom.npcs.Karmine,shuffled:!0,sword:2});this.Draygon1=new Qq(this,{flag:this.rom.flags.Draygon1,kill:10,npc:this.rom.npcs.Draygon,shuffled:!0,sword:2});this.StatueOfMoon=new Qq(this,{flag:this.rom.flags.UsedBowOfMoon,npc:this.rom.npcs.StatueOfMoon});this.StatueOfSun=new Qq(this,{flag:this.rom.flags.UsedBowOfSun,npc:this.rom.npcs.StatueOfSun});this.Draygon2=new Qq(this,{flag:this.rom.flags.Draygon2,
kill:11,npc:this.rom.npcs.Draygon});this.Dyna=new Qq(this,{kill:13,object:164});this.musics=[new Rq(Nq,42168,[this.Vampire1,this.Vampire2]),new Rq(Nq,42640,[this.Insect]),new Rq(Nq,43419,[this.Kelbesque1,this.Kelbesque2]),new Rq(Nq,44209,[this.Sabera1,this.Sabera2]),new Rq(Nq,44559,[this.Mado1,this.Mado2]),new Rq(Nq,44931,[this.Karmine]),new Rq(Nq,45447,[this.Draygon1]),new Rq(Nq,45841,[this.Draygon2]),new Rq(Oq,48176,[this.Dyna])];this.all=[];for(const b in this)this.hasOwnProperty(b)&&(a=this[b],
a instanceof Qq&&(a.name=Vd(b),this.all.push(a)))}isBossFlag(a){return(this.flags||(this.flags=(()=>{const a=new Set;for(const b of this.all)null!=b.flag&&a.add(b.flag.id);return a})())).has(a)}fromLocation(a){return this.all.find(b=>b.location===a)}fromBossKill(a){return this.all.find(b=>b.kill===a)}fromObject(a){return this.all.find(b=>b.object===a)}[Symbol.iterator](){return this.all[Symbol.iterator]()}write(){const a=this.rom.assembler();for(const b of this.musics)b.addr.loc(a),a.byte(b.bgm);
return[a.module()]}}class Rq{constructor(a,b,c){this.bosses=c;this.addr=xe.of(a,b);this.bgm=this.addr.read(c[0].bosses.rom.prg)}}
class Qq{constructor(a,{flag:b,npc:c,kill:d,shuffled:e,address:f,sword:g=3,object:h}){this.bosses=a;({prg:a}=a.rom);this.flag=b;this.npc=c;this.object=f?a[f]:c?c.data[1]:null!==h&&void 0!==h?h:$b("address, npc, or object is required");this.swordLevel=g;this.shuffled=!!e;this.kill=d;null!=d&&(b=81920+ee(a,129387+2*d),b=a[b+4],255!==b&&(this.drop=b),this.location=a[129373+d])}};class Sq{constructor(a){this.rom=a;this.values=Xd(a.prg,Tq.offset,16)}write(){const a=this.rom.assembler();Tq.loc(a);a.word(...this.values);return[a.module()]}}const Tq=xe.of(B.$1a,35806);const Uq=Symbol(),Vq={assumeFalse:!0},Wq={assumeTrue:!0},Xq={track:!0},Yq={};
class Zq{constructor(a,b,c,d){var e;this.flags=a;this.name=b;this.id=c;this.fixed=d.fixed||!1;this.obsolete=d.obsolete;this.logic=null!==(e=d.logic)&&void 0!==e?e:Xq}get c(){return this.id}get r(){return[[this.id]]}get debug(){return this.id.toString(16).padStart(3,"0")+" "+this.name}get item(){if(256>this.id||383<this.id)throw Error(`not a slot: ${this.id}`);const a=this.flags.rom.items[this.flags.rom.itemGets[this.flags.rom.slots[this.id&255]].itemId];if(!a)throw Error("no item");return a}}
function V(a){"number"===typeof a&&(a=(a=>()=>a)(a));return{obsolete:a,[Uq]:!0}}function $q(a,b){b=void 0===b?Yq:b;return{id:a,fixed:!0,[Uq]:!0,logic:b}}function W(a){return $q(a,Xq)}function ar(a,b){b=void 0===b?Yq:b;return{id:a,[Uq]:!0,logic:b}}function br(a,b){b=void 0===b?Yq:b;return{name:a,[Uq]:!0,logic:b}}function cr(a,b){b=void 0===b?Yq:b;return{name:a,[Uq]:!0,logic:b}}function dr(a){const b=er.get(a)||1024;er.set(a,b+1);return{id:b,[Uq]:!0,logic:Xq}}const er=new WeakMap;
class fr{constructor(a){this.rom=a;this[0]=$q(0,Vq);this[1]=$q(1);this[2]=$q(2);this[3]=$q(3);this[4]=$q(4);this[5]=$q(5);this[6]=$q(6);this[7]=$q(7);this[8]=$q(8);this[9]=$q(9);this.UsedWindmillKey=$q(10,Xq);this[11]=V(256);this[12]=cr("Leaf villager");this.LeafVillagersRescued=ar(13);this[14]=V(a=>{var b;return 133===(null===(b=a.trigger)||void 0===b?void 0:b.id)?323:579});this.WokeWindmillGuard=ar(15,Xq);this.TurnedInKirisaPlant=ar(16);this[17]=br("Welcomed to Amazones");this[18]=br("Treasure hunter dead");
this[19]=V(312);this[22]=br("Portoa queen Rage hint");this[23]=V(258);this.EnteredUndergroundChannel=ar(24,Xq);this[25]=cr("Portoa queen tired of talking");this[26]=br("Initial talk with Portoa queen");this.MesiaRecording=ar(27,Xq);this[28]=V(272);this.TalkedToFortuneTeller=ar(29,Xq);this.QueenRevealed=ar(30,Xq);this[31]=V(265);this.QueenNotInThroneRoom=ar(32,Xq);this.ReturnedFogLamp=ar(33,Xq);this[34]=br("Sahara elder");this[35]=br("Sahara elder daughter");this[36]=V(317);this[37]=V(310);this[38]=
V(765);this.ShyronMassacre=$q(39,Xq);this.ChangeWoman=$q(40);this.ChangeAkahana=$q(41);this.ChangeSoldier=$q(42);this.ChangeStom=$q(43);this[45]=br("Shyron sages");this[46]=V(301);this.UsedBowOfTruth=$q(47);this[49]=br("Zombie town");this[50]=V(311);this[52]=br("Akahana in waterfall cave");this.CuredAkahana=ar(53,Xq);this[54]=br("Akahana Shyron");this[55]=V(322);this.LeafAbduction=ar(56,Xq);this[57]=V(321);this.TalkedToZebuInCave=ar(58,Xq);this.TalkedToZebuInShyron=ar(59,Xq);this[60]=V(315);this[61]=
br("Asina in Shyron temple");this.FoundKensuInDanceHall=ar(62,Xq);this[63]=V(a=>{var b;return 186===(null===(b=a.trigger)||void 0===b?void 0:b.id)?580:324});this[64]=br("Tornel in Shyron temple");this[65]=V(263);this[68]=V(263);this.RescuedChild=$q(69,Xq);this.UsedInsectFlute=$q(70);this.RescuedLeafElder=ar(71);this[72]=br("Treasure hunter embarked");this[73]=V(257);this[74]=br("Boat owner");this[75]=cr("Shyron sick men");this[76]=cr("Shyron training men 1");this[77]=cr("Shyron training men 2");this[78]=
V(262);this[79]=V(299);this.GivenStatueToAkahana=ar(80);this[81]=V(326);this.TalkedToDwarfMother=ar(82,Xq);this.LeadingChild=$q(83,Xq);this[85]=br("Zebu rescued");this[86]=br("Tornel rescued");this[87]=br("Asina rescued");this.MtSabreGuardsDespawned=ar(91,Wq);this[94]=V(653);this[95]=V(515);this.TalkedToStomInSwan=ar(97,Xq);this[98]=V(337);this[99]=V(327);this.CuredKensu=ar(101,Xq);this[103]=V(267);this[104]=V(260);this.StonedPeopleCured=ar(106,Xq);this[108]=V(284);this.CurrentlyRidingDolphin=$q(-111,
Xq);this.ParalyzedKensuInTavern=$q(112);this.ParalyzedKensuInDanceHall=$q(113);this.FoundKensuInTavern=ar(114,Xq);this[115]=br("Startled man in Leaf");this[117]=V(313);this[118]=br("Kensu in Goa");this[119]=V(264);this[120]=V(268);this[121]=V(320);this[122]=V(266);this[123]=V(265);this[125]=V(319);this[126]=br("Mt Sabre guards 1");this[127]=br("Mt Sabre guards 2");this.AlarmFluteUsedOnce=$q(118);this.FluteOfLimeUsedOnce=$q(119);this[130]=V(320);this[131]=br("Rescued Leaf elder");this.LeafVillagersCurrentlyAbducted=
ar(132);this.LeafElderCurrentlyAbducted=ar(133);this[135]=V(261);this[136]=V(306);this[137]=br("Dead Stom's girlfriend");this[138]=br("Dead Stom");this[139]=V(566);this[141]=V(311);this[143]=V(643);this[144]=br("Stoned people gone");this[146]=V(296);this[150]=cr("Leaf elder daughter");this[151]=cr("Leaf villager");this[152]=br("Nadare villager");this.AbleToRideDolphin=ar(155,Xq);this.PortoaQueenGoingAway=ar(156);this[160]=V(295);this[163]=cr("Portoa queen/fortune teller");this.WokeKensuInLighthouse=
ar(164,Xq);this[165]=V(305);this[166]=br("Oak elder 1",Vq);this[167]=cr("Swan dancer");this[168]=br("Oak elder 2",Vq);this.TalkedToLeafRabbit=ar(169,Xq);this[170]=V(285);this[171]=V(336);this[173]=V(338);this[174]=V(339);this[175]=V(340);this[176]=V(341);this[177]=V(342);this[178]=V(343);this[179]=V(344);this[180]=V(345);this[181]=V(346);this[182]=V(287);this[183]=V(348);this[184]=V(349);this[185]=V(286);this[186]=V(350);this[187]=V(351);this[188]=V(352);this[189]=V(288);this[190]=V(289);this[191]=
V(354);this[192]=V(355);this[193]=V(356);this[194]=V(290);this[195]=V(357);this[196]=V(358);this[197]=V(363);this[198]=V(364);this[199]=V(291);this[200]=V(292);this[201]=V(362);this[202]=V(317);this[203]=V(298);this[204]=V(284);this[205]=V(276);this[206]=V(293);this[207]=V(307);this[208]=V(296);this[209]=V(309);this[210]=V(361);this[211]=V(294);this[212]=V(347);this[213]=cr("Portoa queen 1");this[214]=cr("Portoa queen 2");this[215]=cr("Portoa queen 3");this[216]=br("Kensu rescued");this[217]=cr("Stoned pair");
this[218]=br("Kensu gone from tavern");this[219]=cr("In Sabera's trap");this[220]=V(367);this[221]=V(368);this[222]=V(300);this[223]=V(283);this[224]=br("Dead Akahana");this[228]=V(316);this[229]=V(366);this[230]=V(365);this[231]=V(303);this[232]=br("Dead Shyron villager");this[233]=br("Dead Shyron guard");this[234]=br("Tower message 1");this[235]=br("Tower message 2");this[236]=br("Tower message 3");this[237]=br("Mesia");this.TalkedToZebuStudent=ar(238,Xq);this[256]=V(302);this[257]=V(263);this[258]=
V(264);this[259]=V(265);this[261]=V(294);this[262]=V(291);this[263]=V(274);this[264]=V(317);this.UsedBowOfMoon=ar(265);this.UsedBowOfSun=ar(266);this[267]=V(284);this[268]=V(353);this.LeafElder=W(-257);this.OakElder=W(-258);this.WaterfallCaveSwordOfWaterChest=W(-259);this.StxyLeftUpperSwordOfThunderChest=W(-260);this.MesiaInTower=W(260);this.SealedCaveBallOfWindChest=W(-262);this.MtSabreWestTornadoBraceletChest=W(-263);this.GiantInsect=W(-264);this.Kelbesque1=W(-265);this.Rage=W(-266);this.AryllisBasementChest=
W(-267);this.Mado1=W(-268);this.StormBraceletChest=W(-269);this.WaterfallCaveRiverLeftChest=W(272);this.Mado2=W(274);this.StxyRightMiddleChest=W(276);this.BattleArmorChest=W(283);this.Draygon1=W(284);this.SealedCaveSmallRoomBackChest=W(285);this.SealedCaveBigRoomNortheastChest=W(286);this.FogLampCaveFrontChest=W(287);this.MtHydraRightChest=W(288);this.SaberaUpstairsLeftChest=W(289);this.EvilSpiritIslandLowerChest=W(290);this.Sabera2=W(291);this.SealedCaveSmallRoomFrontChest=W(292);this.CordelGrass=
W(293);this.Kelbesque2=W(294);this.OakMother=W(295);this.PortoaQueen=W(296);this.AkahanaStatueOfOnyxTradein=W(297);this.OasisCaveFortressBasementChest=W(298);this.Brokahana=W(299);this.EvilSpiritIslandRiverLeftChest=W(300);this.Deo=W(301);this.Vampire1=W(302);this.OasisCaveNorthwestChest=W(303);this.AkahanaFluteOfLimeTradein=W(304);this.ZebuStudent=W(305);this.WindmillGuardAlarmFluteTradein=W(306);this.MtSabreNorthBackOfPrisonChest=W(307);this.ZebuInShyron=W(308);this.FogLampCaveBackChest=W(309);
this.InjuredDolphin=W(310);this.Clark=W(311);this.Sabera1=W(312);this.KensuInLighthouse=W(313);this.RepairedStatue=W(314);this.UndergroundChannelUnderwaterChest=W(315);this.KirisaMeadow=W(316);this.Karmine=W(317);this.Aryllis=W(318);this.MtHydraSummitChest=W(319);this.AztecaInPyramid=W(320);this.ZebuAtWindmill=W(321);this.MtSabreNorthSummit=W(322);this.StomFightReward=W(323);this.MtSabreWestTornel=W(324);this.AsinaInBackRoom=W(325);this.BehindWhirlpool=W(326);this.KensuInSwan=W(327);this.SlimedKensu=
W(328);this.MezameShrineLeftChest=W(329);this.SealedCaveBigRoomSouthwestChest=W(336);this.MtSabreWestRightChest=W(338);this.MtSabreNorthMiddleChest=W(339);this.FortressMadoHellwayChest=W(340);this.SaberaUpstairsRightChest=W(341);this.MtHydraFarLeftChest=W(342);this.StxyLeftLowerChest=W(343);this.KarmineBasementLowerMiddleChest=W(344);this.EastCaveNortheastChest=W(345);this.OasisCaveEntranceAcrossRiverChest=W(346);this.EvilSpiritIslandExitChest=W(348);this.FortressSaberaMiddleChest=W(349);this.MtSabreNorthUnderBridgeChest=
W(350);this.KirisaPlantCaveChest=W(351);this.FortressMadoUpperNorthChest=W(352);this.Vampire2=W(353);this.FortressSaberaNorthwestChest=W(354);this.FortressMadoLowerCenterNorthChest=W(355);this.OasisCaveNearEntranceChest=W(356);this.MtHydraLeftRightChest=W(357);this.FortressSaberaSoutheastChest=W(358);this.KensuInCabin=W(359);this.MtSabreWestNearKensuChest=W(361);this.MtSabreWestLeftChest=W(362);this.FortressMadoUpperBehindWallChest=W(363);this.PyramidChest=W(364);this.CryptRightChest=W(365);this.KarmineBasementLowerLeftChest=
W(366);this.FortressMadoLowerSoutheastChest=W(367);this.FogLampCaveMiddleNorthMimic=W(368);this.FogLampCaveMiddleSouthwestMimic=W(369);this.WaterfallCaveFrontMimic=W(370);this.EvilSpiritIslandRiverRightMimic=W(371);this.MtHydraFinalCaveMimic=W(372);this.StxyLeftNorthMimic=W(373);this.StxyRightNorthMimic=W(374);this.StxyRightSouthMimic=W(375);this.CryptLeftPitMimic=W(376);this.KarmineBasementUpperMiddleMimic=W(377);this.KarmineBasementUpperRightMimic=W(378);this.KarmineBasementLowerRightMimic=W(379);
this.EastCaveNorthwestMimic=W(380);this.SwordOfWind=W(512);this.SwordOfFire=W(513);this.SwordOfWater=W(514);this.SwordOfThunder=W(515);this.Crystalis=W(516);this.BallOfWind=W(517);this.TornadoBracelet=W(518);this.BallOfFire=W(519);this.FlameBracelet=W(520);this.BallOfWater=W(521);this.BlizzardBracelet=W(522);this.BallOfThunder=W(523);this.StormBracelet=W(524);this.CarapaceShield=W(525);this.BronzeShield=W(526);this.PlatinumShield=W(527);this.MirroredShield=W(528);this.CeramicShield=W(529);this.SacredShield=
W(530);this.BattleShield=W(531);this.PsychoShield=W(532);this.TannedHide=W(533);this.LeatherArmor=W(534);this.BronzeArmor=W(535);this.PlatinumArmor=W(536);this.SoldierSuit=W(537);this.CeramicSuit=W(538);this.BattleArmor=W(539);this.PsychoArmor=W(540);this.MedicalHerb=W(541);this.Antidote=W(542);this.LysisPlant=W(543);this.FruitOfLime=W(544);this.FruitOfPower=W(545);this.MagicRing=W(546);this.FruitOfRepun=W(547);this.WarpBoots=W(548);this.StatueOfOnyx=W(549);this.OpelStatue=W(550);this.InsectFlute=
W(551);this.FluteOfLime=W(552);this.GasMask=W(553);this.PowerRing=W(554);this.WarriorRing=W(555);this.IronNecklace=W(556);this.DeosPendant=W(557);this.RabbitBoots=W(558);this.LeatherBoots=W(559);this.ShieldRing=W(560);this.AlarmFlute=W(561);this.WindmillKey=W(562);this.KeyToPrison=W(563);this.KeyToStxy=W(564);this.FogLamp=W(565);this.ShellFlute=W(566);this.EyeGlasses=W(567);this.BrokenStatue=W(568);this.GlowingLamp=W(569);this.StatueOfGold=W(570);this.LovePendant=W(571);this.KirisaPlant=W(572);this.IvoryStatue=
W(573);this.BowOfMoon=W(574);this.BowOfSun=W(575);this.BowOfTruth=W(576);this.Refresh=W(577);this.Paralysis=W(578);this.Telepathy=W(579);this.Teleport=W(580);this.Recover=W(581);this.Barrier=W(582);this.Change=W(583);this.Flight=W(584);this.CalmedAngrySea=W(643);this.OpenedJoelShed=W(647);this.Draygon2=W(653);this.OpenedCrypt=W(654);this.OpenedStxy=W(688);this.OpenedSwanGate=W(691);this.OpenedPrison=W(728);this.OpenedSealedCave=W(750);this.AlwaysTrue=$q(752,Wq);this.WarpLeaf=W(757);this.WarpBrynmaer=
W(758);this.WarpOak=W(759);this.WarpNadare=W(760);this.WarpPortoa=W(761);this.WarpAmazones=W(762);this.WarpJoel=W(763);this.WarpZombie=W(-764);this.WarpSwan=W(764);this.WarpShyron=W(765);this.WarpGoa=W(766);this.WarpSahara=W(767);this.Sword=dr(this);this.Money=dr(this);this.BreakStone=dr(this);this.BreakIce=dr(this);this.FormBridge=dr(this);this.BreakIron=dr(this);this.TravelSwamp=dr(this);this.CrossPain=dr(this);this.ClimbWaterfall=dr(this);this.BuyHealing=dr(this);this.BuyWarp=dr(this);this.ShootingStatue=
dr(this);this.ClimbSlope8=dr(this);this.ClimbSlope9=dr(this);this.ClimbSlope10=dr(this);this.WildWarp=dr(this);this.TriggerSkip=dr(this);this.RageSkip=dr(this);this.ShootingStatueSouth=dr(this);this.unallocated=new Map;for(var b in this){if(!this.hasOwnProperty(b))continue;var c=this[b];if(!c[Uq])continue;var d=Number(b);const a="number"===typeof c.id?c.id:d;if(isNaN(a))throw Error(`Bad flag: ${b}`);d=c.name||(isNaN(d)?Vd(b):"Flag "+a.toString(16).padStart(3,"0"));c=new Zq(this,d,a,c);this[b]=c;0>
c.id?this.unallocated.set(~c.id,c):this[c.id]||(this[c.id]=c)}for(b=256;384>b;b++)c=`Check ${x(b&255)}`,this[b]?this[b].fixed||this.unallocated.has(b)||this.unallocated.set(b,new Zq(this,c,~b,{fixed:!0})):this[b]=new Zq(this,c,b,{fixed:!0});for(b=384;640>b;b++)this[b]||(this[b]=new Zq(this,(512>b?"Buffer ":"Item ")+x(b),b,{fixed:!0}));for(const b of a.locations)for(const a of b.flags)this[a.flag]||(this[a.flag]=gr(this,a.flag))}defrag(){function a(a){return()=>a}var b=new Map,c=new Set;for(var d=
0;768>d;d++){const a=this[d],e=null===a||void 0===a?void 0:a.obsolete;e?(b.set(d,b=>b.set?-1:e.call(a,b)),delete this[d]):a||c.add(d)}d=0;let e=767;for(;d<e;){if(this[d]||this.unallocated.has(d)){d++;continue}const c=this[e];c&&!c.fixed&&(b.set(e,a(d)),c.id=d,this[d]=c,delete this[e],d++);e--}this.remapFlags(b,c);for(const a of this.unallocated){const [b,c]=a;this[b]||(this.unallocated.delete(b),(this[b]=c).id=b)}b=[];for(c=0;768>c;c++)this[c]||b.push(c.toString(16).padStart(3,"0"))}insertZombieWarpFlag(){const a=
new Map;if(this[756])throw Error("No space to insert warp flag");const b=~this.WarpZombie.id;if(0>b)throw Error("Bad WarpZombie id");for(let c=756;c<b;c++)this[c]=this[c+1],this[c].id=c,a.set(c+1,()=>c);this.WarpZombie.id=b;this[b]=this.WarpZombie;this.remapFlags(a)}remap(a,b){this.remapFlags(new Map([[a,()=>b]]))}remapFlags(a,b){function c(c,d){for(let f=c.length-1;0<=f;f--){var e=c[f];0>e&&(e=~e);if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);null!=e&&(e=e(Object.assign({},d,
{index:f})),0<=e?c[f]=0>c[f]?~e:e:c.splice(f,1))}}function d(c,d){var e=0>c?~c:c;if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);if(null==e)return c;d=e(d);if(0>d)throw Error("Bad flag delete");return 0>c?~d:d}for(var e of this.rom.locations)if(e.used)for(const a of e.flags)a.flag=d(a.flag,{location:e});for(const a of this.rom.npcs)if(a.used){for(const b of a.spawnConditions){const [d,e]=b;c(e,{npc:a,spawn:d})}for(const b of a.globalDialogs)b.condition=d(b.condition,{npc:a,dialog:!0});
for(const b of a.localDialogs){[,e]=b;for(const b of e)b.condition=d(b.condition,{npc:a,dialog:!0}),c(b.flags,{npc:a,dialog:!0,set:!0})}}for(const a of this.rom.triggers)a.used&&(c(a.conditions,{trigger:a}),c(a.flags,{trigger:a,set:!0}));for(const a of this.rom.itemGets)c(a.flags,{set:!0});for(const a of this.rom.items)for(const b of a.itemUseData)"flag"===b.kind&&(b.want=d(b.want,{})),c(b.flags,{set:!0})}alloc(a){if(512!==(void 0===a?0:a))throw Error("Cannot allocate outside 2xx");for(a=640;768>
a;a++)if(!this[a])return this[a]=gr(this,a),a;throw Error("No free flags.");}free(a){delete this[a]}}function gr(a,b){return new Zq(a,"Wall "+x(b&255),b,{fixed:!0})};class hr extends ug{constructor(a,b){super(a,b);this.coordinates=Xd(a.prg,this.base,4)}get base(){return 218769+(this.id<<2)}get w(){return this.coordinates[1]}set w(a){this.coordinates[1]=a}get x0(){return Yd(this.coordinates[0])}set x0(a){this.coordinates[0]=0>a?a+256:a}get x1(){return this.x0+this.w}get h(){return this.coordinates[3]}set h(a){this.coordinates[3]=a}get y0(){return Yd(this.coordinates[2])}set y0(a){this.coordinates[2]=0>a?a+256:a}get y1(){return this.y0+this.h}write(){const a=this.rom.assembler();
a.segment("1a");a.org(38545+(this.id<<2));a.byte(...this.coordinates);return[a.module()]}};const {$0e:ir,$0f:jr,$14:kr,$fe:lr,$ff:mr}=B,nr=xe.of(ir,39680),or=xe.of(ir,40294);
class pr extends vg{constructor(a){super(113);this.rom=a;this.actionGrants=new Map;for(let b=0;113>b;b++)this[b]=new qr(a,b);this.actionGrants.set(37,41);this.actionGrants.set(57,58);this.actionGrants.set(59,71);this.actionGrants.set(60,62);this.actionGrants.set(132,70);this.actionGrants.set(178,66);this.actionGrants.set(180,65)}write(){const a=this.rom.assembler();for(const b of this)b.assemble(a);ze(a,[kr,lr,mr],"GrantItemTable");for(const [b,c]of this.actionGrants)a.byte(b,c);return[a.module()]}}
class qr extends ug{constructor(a,b){super(a,b);this._itemId=this.itemPointer.read(a.prg);const c=this.tablePointer.readAddress(a.prg,ir,jr);let d=c.offset;this.inventoryRowStart=a.prg[d++];this.inventoryRowLength=a.prg[d++];this.acquisitionAction=Gk.from(a.prg,d);this.flags=ie.read(a.prg,d+2);this.key=254===a.prg[d+2+2*this.flags.length+1];0!==b&&c.org===ee(a.prg,122214)&&(this.key=!1,this.flags=[])}get itemPointer(){return or.plus(this.id)}get tablePointer(){return nr.plus(this.id<<1)}get itemId(){return this._itemId}set itemId(a){if(73>
this.id)throw Error(`${this.id}`);this._itemId=a}isLosable(){return rr.has(this.inventoryRowStart)}copyFrom(a){this.inventoryRowStart=a.inventoryRowStart;this.inventoryRowLength=a.inventoryRowLength;this.acquisitionAction=a.acquisitionAction;this.flags=[...a.flags];this.key=a.key}assemble(a){this.itemPointer.loc(a);a.byte(this.itemId);const b=[this.inventoryRowStart,this.inventoryRowLength,...this.acquisitionAction.data,...ie.bytes(this.flags),this.key?254:255];a.segment(ir.name,jr.name);a.reloc(`ItemGetData ${x(this.id)}`);
const c=a.pc();a.byte(...b);this.tablePointer.loc(a);a.word(c)}}const rr=new Set([4,8,16]);const {$14:sr,$15:tr,$16_a:ur,$17:vr}=B,wr=new Map([[6,"{}"],[7,"[]"]]);
class xr{constructor(a,b,c,d,e){this.messages=a;this.part=b;this.id=c;this.bytes=[];this.hex="";a=a.rom.prg;b=[];for(c=d;d&&a[c];c++){const f=a[c];this.bytes.push(f);if(1===f){if(c!==d&&3!==a[c-1])throw Error(`Unexpected start message signal at ${c.toString(16)}`);}else if(2===f)b.push("\n ");else if(3===f)b.push(`${yr.CONTINUED}\n`);else if(4===f)b.push("{:HERO:}");else if(8===f)b.push("[:ITEM:]");else if(5<=f&&9>=f){const d=a[++c];this.bytes.push(d);if(9===f){b.push(" ".repeat(d));continue}const h=
wr.get(f);h&&(b.push(h[0]),b.push(d.toString(16).padStart(2,"0")),b.push(":"));b.push(e(d,f));h&&b.push(h[1]);zr[String.fromCharCode(a[c+1])]||b.push(" ")}else if(128<=f)b.push(e(f,0)),zr[String.fromCharCode(a[c+1])]||b.push(" ");else if(32<=f)b.push(String.fromCharCode(f));else throw Error(`Non-exhaustive switch: ${f} at ${c.toString(16)}`);}this.text=b.join("")}get mid(){return`${x(this.part)}:${x(this.id)}`}fixText(){function a(a,b=a.length){28<f+b&&c();" "===a?(d.push(...h," "),h=[]):/^[[{]:/.test(a)?
h.push({toString:()=>a,length:b}):h.push(a);f+=b;g=a.endsWith(" ")}function b(b){b=b.split(/\s+/);for(let c=0;c<b.length;c++)c&&(g||a(" "),g=!0),a(b[c])}function c(){f=1+h.reduce((a,b)=>a+b.length,0);2<++e?(d.push("#\n "),e=0):d.push("\n ");g=!0}if(!this.checkText()){var d=[],e=0,f=0,g=!1,h=[],k=new Map;for(var l=0;l<this.text.length;l++){var n=this.text[l],q=this.text[l+1];/[\s\n#]/.test(n)?(g||a(" "),g=!0):"{"===n?(":"===q?a("{:HERO:}",6):(n=this.text.indexOf(":",l),n=Number.parseInt(this.text.substring(l+
1,n),16),q=this.messages.extraWords[6][n],k.set(q,`{${n.toString(16)}:${q}}`),b(q)),l=this.text.indexOf("}",l)):"["===n?(":"===q?a("[:ITEM:]",Math.max(...this.messages.rom.items.map(a=>a.messageName.length))):(n=this.text.indexOf(":",l),n=Number.parseInt(this.text.substring(l+1,n),16),q=this.messages.rom.items[n].messageName,k.set(q,`[${n.toString(16)}:${q}]`),b(q)),l=this.text.indexOf("]",l)):a(n)}d.push(...h);l=d.join("");for(const [a,b]of k)l.includes(a)&&(l=l.split(a).join(b));this.text=l}}checkText(){let a=
0,b=0;const c=this.text.replace(/\s+$/mg,"");for(let e=0;e<c.length;e++){const f=c[e];var d=c[e+1];if("\n"===f){if(a++,b=0,3<a)return!1}else if("#"===f)"\n"===d&&e++,a=b=0;else if("{"===f||"["===f){if(":"===d){if(b="{"===f?b+6:b+Math.max(...this.messages.rom.items.map(a=>a.messageName.length)),28<b)return!1}else d=c.indexOf(":",e),d=Number.parseInt(c.substring(e+1,d),16),b+=("{"===f?this.messages.personNames[d]:this.messages.itemNames[d]).length;e=c.indexOf(Ar[f],e)}else b++;if(28<b||14<b&&2<a&&c.includes("#",
e))return!1}return!0}}const zr={"\x00":!0," ":!0,"!":!0,"'":!0,",":!0,".":!0,":":!0,";":!0,"?":!0,_:!0,"\n":!0,"#":!0},Br=xe.of(sr,34564),Cr=xe.of(sr,34442),Dr=xe.of(sr,34517),Er=xe.of(sr,34537),Fr=xe.of(sr,34697),Gr=xe.of(sr,34113),Hr=xe.of(sr,34380),Ir=xe.of(sr,34124),Jr={21:tr,22:ur,23:vr};
class yr{constructor(a){this.rom=a;this.partCount=34;this.commonWords=[];this.uncommonWords=[];this.personNames=[];this.itemNames=[];this.parts=[];const b=Br.readAddress(a.prg);var c=Cr.readAddress(a.prg),d=Dr.readAddress(a.prg),e=Er.readAddress(a.prg),f=Gr.readAddress(a.prg);const g=Ir.readAddress(a.prg),h={5:c,6:d,7:e};this.extraWords={5:this.uncommonWords,6:this.personNames,7:this.itemNames};const k=(b,c,d)=>{let e=b[d];if(null!=e)return e;e=fe(a.prg,c.plus(2*d).readAddress(a.prg).offset);return b[d]=
e};c=(a,c)=>c?k(this.extraWords[c],h[c],a):k(this.commonWords,b,a-128);for(d=0;73>d;d++)c(d,7);f=f.offset;this.banks=Xd(a.prg,f,this.partCount);for(d=this.partCount-1;0<=d;d--){e=g.plus(2*d).readAddress(a.prg);const b=f-e.offset>>>1;f=e.offset;const h=Jr[this.banks[d]],k=this.parts[d]=[];for(let f=0;f<b;f++){const b=e.plus(2*f).readAddress(a.prg,h);k[f]=new xr(this,d,f,b.offset,c)}}}*messages(a){for(const b of this.parts)if(a)for(const c of b)a.has(c.mid)&&(yield c);else yield*b}alloc(){const a=this.uses();
for(const b of this.parts)for(const c of b)if(!a.has(c.mid))return c;throw Error("could not find an unused message id");}uses(){function a(a,c){a="string"===typeof a?a:a.mid;const d=b.get(a)||new Set;d.add(c);b.set(a,d)}const b=new Map;for(var c of this.rom.triggers)c.message.nonzero()&&a(c.message,`Trigger $${x(c.id)}`);for(const b of this.rom.items)for(const c of b.itemUseMessages())c.nonzero()&&a(c,`Item $${x(b.id)}`);for(const b of this.rom.npcs){for(const c of b.globalDialogs)a(c.message,`NPC $${x(b.id)}`);
for(const [d,f]of b.localDialogs){c=0<=d?` @ $${x(d)}`:"";for(const d of f)a(d.message,`NPC $${x(b.id)}${c}`)}}for(const b of this.rom.telepathy.sages){for(const c of b.defaultMessages)a(c,`Telepathy ${b.sage}`);for(const c of b.messageGroups)for(const [,...d]of c.messages)for(const c of d)a(c,`Telepathy ${b.sage}`)}for(const b of Kr)a(b,"Hardcoded");return b}buildAbbreviationTable(a=this.uses()){const b=[];var c=new Map;const d=new Map;for(var e of this.messages(a)){e.fixText();a=e.mid;var f=c.get(e.text);
if(f=null!=f&&d.get(f))f.push(a);else{c.set(e.text,a);d.set(a,[]);f=e.text;var g=[];for(let c=0,d=f.length;c<=d;c++){var h=f[c],k=Ar[h];if(zr[h]||k||c===d){var l=f[c+1];k&&(c=Math.max(c,f.indexOf(k,c)));if(g.length){k=" "!==h&&"'"!==h||!l||zr[l]?"":h;l=g.join("");var n=b.length;h=l.length+(" "===h?1:0);g=[];b.push({str:l,id:n,chain:k,bytes:h,used:0,suffixes:new Set,mid:a})}}else g.push(h)}}}c=new Map;for(e=b.length-1;0<=e;e--)for(a=b[e],f=a.bytes-2;0<=f;f--)for(g=a.str.substring(f),h=0,k=a,l=a.bytes-
f-1;;){(n=c.get(g))||c.set(g,n={chains:h,missing:f,saving:-g.length,str:g,words:new Set});n.words.add(e);n.saving+=l;for(let a=h;0<=a;a--)b[e+a].suffixes.add(n);if(!k.chain)break;g+=k.chain;k=b[e+ ++h];g+=k.str;l+=k.bytes}e=new Set;a=[];f=({saving:a},{saving:b})=>b-a;g=[...c.values()].sort(f);for(h=0;g.length&&1250>h;){e.has(g[0].str)&&(g.sort(f),e.clear());const {str:q,saving:v,missing:y,words:A,chains:z}=g.shift();if(0>=v)break;h+=q.length+3;k=a.length;l=new Set;for(const a of A){n=b[a];for(const a of[n.mid,
...d.get(n.mid)||[]])l.add(a)}a.push({bytes:128>k?[k+128]:[5,k-128],mids:l,str:q});for(const a of A)for(k=0;k<=z;k++){l=b[a+k];n=l.bytes-(k?0:y);for(const a of l.suffixes)a.saving-=n-l.used,e.add(a.str);l.used=n}if(128===a.length){for(const a of c.values())a.saving-=a.words.size;g.sort(f);e.clear()}}return a}compress(){var a=this.uses(),b=this.buildAbbreviationTable(a);const c=new Map;this.commonWords.splice(0,this.commonWords.length);this.uncommonWords.splice(0,this.uncommonWords.length);for(var d of b){1===
d.bytes.length?this.commonWords[d.bytes[0]&127]=d.str:this.extraWords[d.bytes[0]][d.bytes[1]]=d.str;for(var e of d.mids)(b=c.get(e))||c.set(e,b=[]),b.push(d)}for(var f of c.values())f.sort(({str:{length:a}},{str:{length:b}})=>b-a);for(const g of this.messages(a)){a=g.text;a=a.replace(/([\[{])([^\]}]*)[\]}](.|$)/g,(a,b,c,d)=>{if(d&&!zr[d])return a;" "===d&&(d="");if("["===b&&":ITEM:"===c)return`[8]${d}`;if("{"===b&&":HERO:"===c)return`[4]${d}`;c=/^([0-9a-f]+):/.exec(c);if(!c)throw Error(`Bad message text: ${a}`);
a=Number.parseInt(c[1],16);return`[${"{"===b?6:7}][${a}]${d}`});for(const {str:b,bytes:d}of c.get(g.mid)||[])a=a.replace(new RegExp(b+"( [ &0-9]|.|$)","g"),(a,b)=>{if(b&&!zr[b])return a;" "===b&&(b="");return d.map(a=>`[${a}]`).join("")+b});d=["[01]"];e=[];e.push(1);for(let c=0,g=a.length;c<g;c++)if(f=a[c],f===yr.CONTINUED)e.push(3,1),d.push("[03][01]"),"\n"===a[c+1]&&c++;else if("\n"===f)e.push(2)," "===a[c+1]&&c++,d.push("[02]");else if("["===f){f=a.indexOf("]",c);if(0>=f)throw Error(`bad text: ${a}`);
b=Number(a.substring(c+1,f));if(isNaN(b))throw Error(`bad text: ${a}`);e.push(b);d.push(`[${x(b)}]`);c=f}else if(" "===f&&" "===a[c+1]){for(f=c+2;" "===a[f];)f++;e.push(9,f-c);d.push(`[09][${x(f-c)}]`);c=f-1}else e.push(f.charCodeAt(0)),d.push(f);e.push(0);d.push("[0]");g.bytes=e;g.hex=d.join("")}}write(){function a(a,c,...d){a.loc(b);b.word(c);let e=0;for(const f of d)a.plus(f).loc(b),b.word({op:"+",args:[c,{op:"num",num:++e}]})}const b=this.rom.assembler();ye(b,sr,32768,34048);ye(b,sr,34080,34088);
ye(b,sr,34182,34195);ye(b,sr,35072,37888);ye(b,sr,38533,38662);ye(b,sr,40576,40960);ye(b,tr,40960,49152);ye(b,ur,40960,49152);ye(b,vr,40960,48128);var c=w(this.partCount,()=>[]);for(var d=0;d<this.partCount;d++){var e=c[d];const a=this.parts[d];b.segment(Jr[this.banks[d]].name);for(const c of a)b.reloc(`Message_${c.mid}`),e.push(b.pc()),b.byte(...c.bytes,0)}d=[];b.segment(sr.name);b.reloc("MessagesTable");for(e=0;e<this.partCount;e++)d.push(b.pc()),b.word(...c[e]);c=b.pc();b.byte(...this.banks);b.reloc("MessageParts");
e=b.pc();b.word(...d);a(Gr,c);a(Hr,c);a(Ir,e,5);c=[["CommonWords",this.commonWords,[Br]],["UncommonWords",this.uncommonWords,[Cr]],["PersonNames",this.personNames,[Dr]],["ItemNames",this.itemNames,[Er,Fr]]];for(const [e,g,h]of c){c=[];d=0;for(const a of g)a?(b.reloc(`${e}_${x(d++)}`),c.push(b.pc()),b.byte(a,0)):c.push(0);b.reloc(e);d=b.pc();b.word(...c);for(const b of h)a(b,d,5)}return[b.module()]}}yr.CONTINUED="#";const Ar={"{":"}","[":"]"},Kr=new Set("20:1d 1b:0f 1b:10 1b:11 1b:12 1b:05 1b:06 1b:07 1f:00 13:00 0b:01 20:0c 20:0f 1c:11 0e:05 16:00 16:02 16:04 16:06 20:11 21:00 21:02 21:01 06:00 18:00 18:02 18:04 18:08 1b:03 1b:00 1b:00 1b:04 06:01 10:13 19:05 20:14 20:15 20:17 20:02 20:0d 20:19 20:1a 20:1b 03:01 03:02 10:10 10:11 10:12 0c:04 0c:05 03:03 20:0e 20:13".split(" "));const Lr={empty:1,pit:2,arena:4,spikes:8,wide:16,river:32,bridge:64,wall:128,ramp:256,overpass:512,underpass:1024,whirlpool:2048,deadend:4096,"stair:up":65536,"stair:down":131072,portoa1:117440512,portoa2:184549376,portoa3:218103808,lake:234881024,lighthouse:318767104,cabin:352321536,windmill:369098752,altar:419430400,pyramid:436207616,crypt:469762048,manual:1073741824,consolidate:2147483648};
function X(a){if(1!=a.length)throw Error("Bad icon input");a=a[0].split("\n");const b=a.slice(1).map(a=>a.replace(/^\s*\||\|\s*$/g,""));return{short:/\S/.test(a[0])?a[0][0]:b[1][1],full:[b[0],b[1],b[2]]}}function Mr(a,...b){a=a.split(/\s+/g);a[0]||a.shift();a[a.length-1]||a.pop();if(240!==a.length)throw Error(`Bad screen definition: ${a.length}`);const c=new Map(b);return Uint8Array.from(a,(a,b)=>{const d=c.get(a);return"number"===typeof d?d:d?d.screen.tiles[b]:parseInt(a,16)})}
function Nr(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:up",dir:2,entrance:(c<<12)+(14===c?10240:6144)|(d<<4)+8,exits:[a]}:{type:"stair:up",dir:0,entrance:c<<12|(d<<4)+(b<<3),exits:w(b,b=>a-16+b)}}
function Or(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:down",dir:2,entrance:(c<<12)-2048|(d<<4)+8,exits:[a],allowedExits:[a+16,a-16]}:{type:"stair:down",dir:2,entrance:c<<12|3840|(d<<4)+(b<<3),exits:w(b,b=>a+16+b),allowedExits:[...w(b,b=>a+32+b),...w(b,b=>a+b)]}}function Pr(a,b){b=void 0===b?"cave":b;return Object.assign({},Nr(a+16),{type:b})}function Y(a,b){b=void 0===b?"door":b;return Object.assign({},Nr(a,1),{type:b})}
function Qr(a){var {left:b=7,width:c=2,top:d=2,manual:e=!1}=void 0===a?{}:a;return{type:"edge:top",manual:e,dir:0,entrance:d+1<<12|(b<<4)+(c<<3),exits:w(c,a=>d<<4|a+b)}}function Rr(a){var {left:b=7,width:c=2,shift:d=0,type:e="edge:bottom",manual:f=!1}=void 0===a?{}:a;return{type:e,manual:f,dir:2,entrance:57088|(b<<4)+(c<<3)+16*d,exits:w(c,a=>224|a+b)}}
function Sr(a){var {left:b=7,width:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:bottom",dir:2,entrance:44800|(b<<4)+(c<<3)+16*d,exits:w(c,a=>176|a+b)}}function Tr(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:left",dir:1,entrance:(b<<12)+(16*d<<8)+(c<<11)|16,exits:w(c,a=>a+b<<4)}}function Ur(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:right",dir:3,entrance:(b<<12)+(16*d<<8)+(c<<11)|239,exits:w(c,a=>a+b<<4|15)}}
function Vr(a,b){return{type:"seamless:up",dir:0,get entrance(){throw Error("does not make sense");},exits:w(void 0===b?2:b,b=>a+b)}}function Wr(a,b){return{type:"seamless:down",dir:2,get entrance(){throw Error("does not make sense");},exits:w(void 0===b?2:b,b=>a+b)}};class Xr{constructor(a,b,c){var d,e,f,g,h;this.rom=a;this.uid=b;this.data=c;this._tilesets=new Set;this.used=!1;this.neighbors=[new da(a=>this._checkNeighbor(a,0)),new da(a=>this._checkNeighbor(a,1))];for(const a of Object.values(c.tilesets))a.requires||(this.used=!0);a=0;for(var k of null!==(d=c.feature)&&void 0!==d?d:[])d=Lr[k],null!=d&&(a|=d);for(var l of null!==(e=c.exits)&&void 0!==e?e:[])if("stair:down"===l.type||"stair:up"===l.type)a|=Lr[l.type];this._features=a;this._isEmpty=!!(a&Lr.empty);
this.flag=c.flag;this.connections=c=[[[]],[[]],[[]],[[]]];for(e=0;4>e;e++){l=k=0;d=c[e][0];for(const b of null!==(f=this.data.connect)&&void 0!==f?f:"")if(Yr[e].includes(b))c[e].push(d=[]);else if(!Zr.has(b)){if("p"===b)a=240|k++;else if("x"===b)a=224|l++;else{a=parseInt(b,16);if(!a)throw Error(`bad term: '${b}'`);a=(a&3)<<(a&4)|(a&8?a&4?256:4096:0)}d.push(a)}for(;k<(null===(g=this.data.poi)||void 0===g?void 0:g.length);)d.push(240|k++);for(;l<(null===(h=this.data.exits)||void 0===h?void 0:h.length);)d.push(224|
l++)}}get features(){return this._features}get manual(){return!!(this._features&$r)}get counted(){return!!(this._features&as)}hasFeature(a){return!!(this._features&Lr[a])}hasFeatures(a){return(this._features&a)===a}withFeature(){throw Error();}isEmpty(){return this._isEmpty}hasStair(){return!!(this._features&(Lr["stair:up"]|Lr["stair:down"]))}withObstruction(){throw Error();}isCompatibleWithTileset(a){for(const b of this._tilesets)if(b.tilesetId===a)return!0;return!1}replace(a,b){const {tiles:c}=
this.screen;for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b);return this}remove(){for(const a of this.tilesets())a.deleteScreen(this)}tilesets(){const a=[];for(const b in this.data.tilesets)a.push(this.rom.metatilesets[b]);return a}setGridTile(...a){this.data.tile=a;for(const a of this.tilesets())a.invalidate()}gridTiles(){var a;let b=null!==(a=this.data.tile)&&void 0!==a?a:[];Array.isArray(b)||(b=[b]);return b.map(a=>a.replace(/\|/g,""))}get sid(){return this.data.id}set sid(a){this.sid!==a&&this.rom.metascreens.renumber(this.sid,
a,new Set(this.tilesets()))}get screen(){const {sid:a,rom:{screens:b}}=this;return 0>a?b.unallocated[~a]:b[a]}unsafeSetId(a){this.data.id=a;for(const a of this._tilesets)a.invalidate()}unsafeAddTileset(a){this._tilesets.add(a)}unsafeRemoveTileset(a){this._tilesets.delete(a)}edgeExits(){var a;let b=0;for(const c of null!==(a=this.data.exits)&&void 0!==a?a:[])a=bs[c.type],null!=a&&(b|=1<<a);return b}edgeIndex(a){var b;let c=0;const d=null!==(b=this.data.edges)&&void 0!==b?b:"";for(b=0;4>b;b++)if(" "!==
d[b]){if(d[b]!==a)return;c|=1<<b}return c}findExitType(a,b,c){var d,e;for(const f of null!==(d=this.data.exits)&&void 0!==d?d:[])if(f.type.startsWith("seamless")===c&&(d=b&&"edge:bottom"===f.type&&192<=a?a+32:a,f.exits.includes(d)||(null!==(e=f.allowedExits)&&void 0!==e?e:[]).includes(d)))return f}findExitByType(a){const b=this.data.exits.find(b=>b.type===a);if(!b)throw Error(`no exit ${a}`);return b}findEntranceType(a,b){var c,d;for(const e of null!==(c=this.data.exits)&&void 0!==c?c:[]){if(e.type.startsWith("seamless"))continue;
c=b&&"edge:bottom"===e.type&&48896<=a?a+8192:a;const f=(c&240)>>4|(c&61440)>>8;if(e.entrance===c||e.exits.includes(f)||(null!==(d=e.allowedExits)&&void 0!==d?d:[]).includes(f))return e.type}}addCustomFlag(a){this.flag=a?"custom:true":"custom:false"}checkNeighbor(a,b){return(b&2?this:a).neighbors[b&1].get(b&2?a:this)}_checkNeighbor(a,b){const c=this.data.edges;a=a.data.edges;if(c&&a){const d=b^2;if("*"!==c[d]&&c[d]===a[b])return!0}return!1}toString(){return`${va(this.sid)} ${this.name}`}}
const bs={"edge:top":0,"edge:left":1,"edge:bottom":2,"edge:right":3},Yr=["|:","|:=-","|","|="],Zr=new Set(["|",":","-","="]),cs=new Set("arena portoa1 portoa2 portoa3 lake overpass underpass lighthouse cabin windmill altar pyramid crypt".split(" ")),ds=new Set("pit spikes bridge wall ramp whirlpool".split(" ")),$r=[...cs].map(a=>Lr[a]).reduce((a,b)=>a|b),as=[...ds].map(a=>Lr[a]).reduce((a,b)=>a|b);class es{constructor(a){this.rom=a;this.length=0;this.screensByFix=new da(()=>[]);this.screensById=new da(()=>[]);this.registeredFixes=new Set;this.overworldEmpty=this.metascreen({id:0,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryW_trees=this.metascreen({id:1,icon:X`
      |\u2588\u258c |
      |\u2588\u258c^|
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks]},sea:{requires:[N.SeaTrees]}},edges:"> >o"});this.boundaryW=this.metascreen({id:2,icon:X`
      |\u2588\u258c |
      |\u2588\u258c |
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"> >o"});this.boundaryE_rocks=this.metascreen({id:3,icon:X`
      |.\u2590\u2588|
      | \u2590\u2588|
      |.\u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks]},sea:{requires:[N.SeaRocks]}},edges:"<o< "});this.boundaryE=this.metascreen({id:4,icon:X`
      | \u2590\u2588|
      | \u2590\u2588|
      | \u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<o< "});this.longGrassS=this.metascreen({id:5,icon:X`
      |vv |
      | vv|
      |   |`,tile:"olo|ooo|   ",tilesets:{river:{},grass:{requires:[N.GrassLongGrass]}},edges:"looo"});this.longGrassN=this.metascreen({id:6,icon:X`
      |   |
      | vv|
      |vv |`,tile:"   |ooo|olo",tilesets:{river:{},grass:{requires:[N.GrassLongGrass]}},edges:"oolo"});this.boundaryS_rocks=this.metascreen({id:7,icon:X`
      | . |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks]},sea:{requires:[N.SeaRocks]}},edges:"o^ ^"});this.fortressTownEntrance=this.metascreen({id:8,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |   |`,placement:"manual",tile:["   |oFo|ooo","oo |oFo|ooo"],tilesets:{grass:{}},edges:" vov",exits:[Object.assign({},Nr(166,3),{type:"fortress"})]});this.bendSE_longGrass=this.metascreen({id:9,icon:X`\u2597
      | v |
      |vv\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.exitW_cave=this.metascreen({id:10,icon:X`\u2229
      |\u2588\u2229\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:["   |o< |   ","   |x< |   "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[N.SeaCaveEntrance]}},edges:" n  ",exits:[Pr(72),Tr({top:6})]});this.bendNE_grassRocks=this.metascreen({id:11,icon:X`\u259d
      |.\u2590\u2588|
      |  \u2580|
      |;;;|`,tile:"oo |ooo|ogo",tilesets:{grass:{},river:{requires:[N.RiverShortGrass]},desert:{requires:[N.DesertShortGrass,N.DesertRocks]}},edges:"<osv"});this.cornerNW=this.metascreen({id:12,icon:X`\u259b
      |\u2588\u2588\u2588|
      |\u2588 \u2580|
      |\u2588\u258c |`,tile:"   | oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"  >v"});this.overworldEmpty_alt=this.metascreen({id:12,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,placement:"manual",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty","manual"],edges:"    ",match:()=>!1,delete:!0});this.cornerNE=this.metascreen({id:13,icon:X`\u259c
      |\u2588\u2588\u2588|
      |\u2580\u2588\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:" v< "});this.cornerSW=this.metascreen({id:14,icon:X`\u2599
      |\u2588\u258c |
      |\u2588\u2588\u2584|
      |\u2588\u2588\u2588|`,tile:" oo| oo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">  ^"});this.cornerSE=this.metascreen({id:15,icon:X`\u259f
      | \u2590\u2588|
      |\u2584\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |oo |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  "});this.exitE=this.metascreen({id:16,icon:X`\u2576
      | \u2590\u2588|
      |   |
      | \u2590\u2588|`,tile:["oo |ooo|oo ","oo |oox|oo "],tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks]}},edges:"<o<n",exits:[Ur({top:6})]});this.boundaryN_trees=this.metascreen({id:17,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      | ^ |`,tile:"   |ooo|ooo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[N.SeaTrees]}},edges:" vov"});this.bridgeToPortoa=this.metascreen({id:18,icon:X`\u2574
      |\u2550  |
      |\u255e\u2550\u2550|
      |\u2502  |`,placement:"manual",tile:"roo|1rr| oo",tilesets:{river:{}},feature:["portoa3"],edges:"2*>r",exits:[Tr({top:1})]});this.slopeAbovePortoa=this.metascreen({id:19,icon:X`
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2580|
      |\u2502  |`,placement:"manual",tile:" \u2193 | oo|roo",tilesets:{river:{}},feature:["portoa2"],edges:"1*2v"});this.riverBendSE=this.metascreen({id:20,icon:X`
      |w  |
      | \u2554\u2550|
      | \u2551 |`,tile:"ooo|orr|oro",tilesets:{river:{}},edges:"oorr"});this.boundaryW_cave=this.metascreen({id:21,icon:X`
      |\u2588\u258c |
      |\u2588\u2229 |
      |\u2588\u258c |`,tile:" oo| <o| oo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[N.SeaCaveEntrance]}},edges:"> >o",exits:[Pr(137)]});this.exitN=this.metascreen({id:22,icon:X`\u2575
      |\u2588 \u2588|
      |\u2580 \u2580|
      | ^ |`,tile:[" o |ooo|ooo"," x |ooo|ooo"],tilesets:{grass:{},river:{},desert:{}},edges:"nvov",exits:[Qr()]});this.riverWE_woodenBridge=this.metascreen({id:23,icon:X`\u2550
      |   |
      |\u2550\u2551\u2550|
      |   |`,tile:"ooo|ror|ooo",tilesets:{river:{}},edges:"oror",exits:[Vr(119),Wr(135)]});this.riverBoundaryE_waterfall=this.metascreen({id:24,icon:X`\u2561
      | \u2590\u2588|
      |\u2550\u2550/|
      | \u2590\u2588|`,tile:"oo |rr |oo ",tilesets:{river:{}},edges:"<r< "});this.boundaryE_cave=this.metascreen({id:25,icon:X`
      | \u2590\u2588|
      |v\u2229\u2588|
      |v\u2590\u2588|`,tile:"oo |o< |oo ",tilesets:{river:{},grass:{requires:[N.GrassLongGrass]},desert:{requires:[N.DesertLongGrass]}},edges:"<o< ",exits:[Pr(88)]});this.exitW_southwest=this.metascreen({id:26,icon:X`\u2574
      |\u2588\u258c |
      |\u2580 \u2584|
      |\u2584\u2588\u2588|`,tile:" oo|Boo|   ",tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks]},sea:{requires:[N.SeaRocks]}},edges:">* ^",exits:[Tr({top:11})]});this.nadare=this.metascreen({id:27,tilesets:{house:{}},exits:[Sr(),Y(35),Y(37,"door2"),Y(42,"door3")]});this.townExitW=this.metascreen({id:28,icon:X`\u2574
      |\u2588\u258c |
      |\u2580 ^|
      |\u2588\u258c |`,tile:" oo|8oo| oo",tilesets:{grass:{},river:{}},edges:">n>o",exits:[Tr({top:8,height:3,shift:-.5})]});this.shortGrassS=this.metascreen({id:29,icon:X` |
      |;;;|
      | v |
      |   |`,tile:"ogo|ooo|ooo",tilesets:{grass:{},river:{requires:[N.RiverShortGrass,N.GrassLongGrassRemapping]}},edges:"sooo"});this.townExitS=this.metascreen({id:30,icon:X`\u2577
      | ^ |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x "],tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks,N.DesertTownEntrance]}},edges:"o^n^",exits:[Rr()]});this.swanGate=this.metascreen({id:31,tilesets:{town:{}},exits:[Tr({top:3}),Ur({top:9})],flag:"custom:false"});this.riverBranchNSE=this.metascreen({id:32,icon:X`
      | \u2551 |
      | \u2560\u2550|
      | \u2551 |`,tile:"oro|orr|oro",tilesets:{river:{}},edges:"rorr"});this.riverWE=this.metascreen({id:33,icon:X`
      |   |
      |\u2550\u2550\u2550|
      |   |`,tile:"ooo|rrr|ooo",tilesets:{river:{}},edges:"oror"});this.riverBoundaryS_waterfall=this.metascreen({id:34,icon:X`\u2568
      | \u2551 |
      |\u2584\u2551\u2584|
      |\u2588/\u2588|`,tile:"oro|oro|   ",tilesets:{river:{}},edges:"r^ ^"});this.shortGrassSE=this.metascreen({id:35,icon:X`
      |;;;|
      |;  |
      |; ^|`,tile:"ogo|goo|ooo",tilesets:{grass:{}},edges:"ssoo"});this.shortGrassNE=this.metascreen({id:36,icon:X` |
      |;  |
      |;v |
      |;;;|`,tile:"ooo|goo|ogo",tilesets:{grass:{}},edges:"osso"});this.stomHouseOutside=this.metascreen({id:37,icon:X`\u2229
      |\u2588\u2588\u2588|
      |\u258c\u2229\u2590|
      |\u2588 \u2588|`,placement:"manual",tile:["   | H | o ","   | H | x "],tilesets:{grass:{}},exits:[Y(104),Rr({shift:.5})]});this.bendNW_trees=this.metascreen({id:38,icon:X`\u2598
      |\u2588\u258c |
      |\u2580 ^|
      | ^^|`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[N.DesertRocks,N.DesertTrees]},sea:{requires:[N.SeaRocks,N.SeaTrees]}},edges:">voo"});this.shortGrassSW=this.metascreen({id:39,icon:X`
      |;;;|
      |  ;|
      |^ ;|`,tile:"ogo|oog|ooo",tilesets:{grass:{},river:{requires:[N.RiverShortGrass]}},edges:"soos"});this.riverBranchNWS=this.metascreen({id:40,icon:X`
      | \u2551 |
      |\u2550\u2563 |
      | \u2551 |`,tile:"oro|rro|oro",tilesets:{river:{}},edges:"rrro"});this.shortGrassNW=this.metascreen({id:41,icon:X`
      |  ;|
      | v;|
      |;;;|`,tile:"ooo|oog|ogo",tilesets:{grass:{},river:{requires:[N.RiverShortGrass,N.GrassLongGrassRemapping]}},edges:"ooss"});this.valleyBridge=this.metascreen({id:42,icon:X` |
      |\u259b\u2551\u259c|
      | \u2551 |
      |\u2599\u2551\u259f|`,tile:[" o | o | o "," x | o | o "," o | o | x "],tilesets:{grass:{},river:{}},edges:"n n ",exits:[Vr(119),Wr(135),Qr(),Rr()]});this.exitS_cave=this.metascreen({id:43,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588 \u2588|`,tile:["   | < | o ","   | < | x "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[N.SeaCaveEntrance]}},edges:"  n ",exits:[Pr(103),Rr()]});this.outsideWindmill=this.metascreen({id:44,icon:X`\u2573
      |\u2588\u2588\u2573|
      |\u2588\u2229\u2588|
      |\u2588 \u2588|`,placement:"manual",tile:["   | W | o ","   | W | x "],tilesets:{grass:{}},flag:"custom:false",feature:["windmill"],edges:"  n ",exits:[Pr(99),Rr(),Y(137,"windmill"),Y(140)]});this.townExitW_cave=this.metascreen({id:45,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2584\u2584\u2588|
      |\u2588\u2588\u2588|`,tile:"   |x< |   ",tilesets:{grass:{}},edges:" n  ",exits:[Pr(74),Tr({top:5,height:3,shift:-.5})],flag:"custom:true"});this.riverNS=this.metascreen({id:46,icon:X`
      | \u2551 |
      | \u2551 |
      | \u2551 |`,tile:"oro|ooo|oro",tilesets:{river:{}},edges:"roro",mod:"bridge"});this.riverNS_bridge=this.metascreen({id:47,icon:X`
      | \u2551 |
      |w\u254fw|
      | \u2551 |`,placement:"mod",tile:"oro|oro|oro",tilesets:{river:{}},feature:["bridge"],edges:"roro",wall:119});this.riverBendWS=this.metascreen({id:48,icon:X`
      | w\u259c|
      |\u2550\u2557w|
      | \u2551 |`,tile:"oo |rro|oro",tilesets:{river:{}},edges:"<rrv"});this.boundaryN_waterfallCave=this.metascreen({id:49,icon:X`
      |\u259b/\u2588|
      |\u2598\u2551\u2580|
      | \u2551 |`,tile:"   |oro|oro",tilesets:{river:{}},edges:" vrv",exits:[{type:"cave",dir:0,entrance:28767,exits:[102,118]}]});this.open_trees=this.metascreen({id:50,icon:X`
      | ^ |
      |^ ^|
      | ^ |`,tile:"ooo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[N.DesertTrees,N.DesertRocks]}},edges:"oooo"});this.exitS=this.metascreen({id:51,icon:X`\u2577
      | w |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x |"],tilesets:{grass:{},river:{},desert:{requires:[N.DesertMarsh]},sea:{requires:[N.SeaMarsh]}},edges:"o^n^",exits:[Rr()]});this.bendNW=this.metascreen({id:52,icon:X`\u2598
      |\u2588\u258c |
      |\u2580\u2580 |
      |   |`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">voo"});this.bendNE=this.metascreen({id:53,icon:X`\u259d
      | \u2590\u2588|
      |  \u2580|
      |   |`,tile:"oo |ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<oov"});this.bendSE=this.metascreen({id:54,icon:X`\u2597
      |   |
      | \u2584\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.bendWS=this.metascreen({id:55,icon:X`\u2596
      |   |
      |\u2584\u2584 |
      |\u2588\u258c |`,tile:"ooo|ooo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^>o"});this.towerPlain_upStair=this.metascreen({id:56,icon:X`\u2534
      | \u250a |
      |\u2500\u2534\u2500|
      |   |`,tile:" t |ttt|   ",tilesets:{tower:{}},edges:"st t",exits:[Qr({left:8}),Wr(8,2)]});this.towerRobotDoor_downStair=this.metascreen({id:57,icon:X`\u252c
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u250a |`,tile:"   |ttt| t ",tilesets:{tower:{}},edges:" tst",exits:[Vr(232,2),Wr(248,2)]});this.towerDynaDoor=this.metascreen({id:58,icon:X`\u2229
      | \u2229 |
      |\u2514\u252c\u2518|
      | \u250a |`,tile:"   | < | t ",tilesets:{tower:{}},edges:"  s ",exits:[Pr(103,"door")]});this.towerLongStairs=this.metascreen({id:59,icon:X`
      | \u250a |
      | \u250a |
      | \u250a |`,tile:" t | t | t ",tilesets:{tower:{}},edges:"s s ",exits:[Rr()]});this.towerMesiaRoom=this.metascreen({id:60,tilesets:{tower:{}},exits:[Sr()]});this.towerTeleporter=this.metascreen({id:61,tilesets:{tower:{}},exits:[Sr(),Pr(87,"teleporter")]});this.caveAbovePortoa=this.metascreen({id:62,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |\u2588\u2193\u2588|`,placement:"manual",tile:"   | < | \u2193 ",tilesets:{river:{}},edges:"  1 ",feature:["portoa1"],exits:[Pr(102)]});this.cornerNE_flowers=this.metascreen({id:63,icon:X`\u259c
      |\u2588\u2588\u2588|
      |\u2580*\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{}},edges:" v< "});this.towerEdge=this.metascreen({id:64,icon:X` |
      |   |
      |\u2524 \u251c|
      |   |`,tile:"   |t t|   ",tilesets:{tower:{}},edges:" t t"});this.towerEdgeW=this.metascreen({id:64,icon:X` |
      |   |
      |\u2524  |
      |   |`,tile:"   |t  |   ",tilesets:{tower:{}},edges:" t  "});this.towerEdgeE=this.metascreen({id:64,icon:X` |
      |   |
      |  \u251c|
      |   |`,tile:"   |  t|   ",tilesets:{tower:{}},edges:"   t"});this.towerRobotDoor=this.metascreen({id:65,icon:X`\u2500
      | O |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ttt|   ",tilesets:{tower:{}},edges:" t t"});this.towerDoor=this.metascreen({id:66,icon:X`\u2229
      | \u2229 |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |t<t|   ",tilesets:{tower:{}},edges:" t t",exits:[Pr(88)]});this.house_bedroom=this.metascreen({id:67,tilesets:{house:{}},exits:[Sr()]});this.shed=this.metascreen({id:68,tilesets:{house:{}},exits:[Sr(),Pr(73)],flag:"custom:false"});this.tavern=this.metascreen({id:69,tilesets:{house:{}},exits:[Sr()]});this.house_twoBeds=this.metascreen({id:70,tilesets:{house:{}},exits:[Sr()]});this.throneRoom_amazones=this.metascreen({id:71,tilesets:{house:{}},exits:[Sr({width:3}),Or(76,1)]});
this.house_ruinedUpstairs=this.metascreen({id:72,tilesets:{house:{}},exits:[Sr(),Or(156,1)]});this.house_ruinedDownstairs=this.metascreen({id:73,tilesets:{house:{}},exits:[Nr(86,1)]});this.foyer=this.metascreen({id:74,tilesets:{house:{}},exits:[Sr({shift:.5}),Y(40),Y(83,"door2"),Y(92,"door3")]});this.throneRoom_portoa=this.metascreen({id:75,tilesets:{house:{}},exits:[Sr(),Y(43)]});this.fortuneTeller=this.metascreen({id:76,tilesets:{house:{}},exits:[Sr(),Y(86),Y(89,"door2")]});this.backRoom=this.metascreen({id:77,
tilesets:{house:{}},exits:[Sr()]});this.dojo=this.metascreen({id:78,tilesets:{house:{}},exits:[Sr({shift:-.5})]});this.windmillInside=this.metascreen({id:79,tilesets:{house:{}},exits:[Sr({left:9,width:1})]});this.horizontalTownMiddle=this.metascreen({id:80,tilesets:{town:{}},exits:[Y(76),Y(85,"door2")],tallHouses:[53]});this.brynmaerRight_exitE=this.metascreen({id:81,tilesets:{town:{type:"horizontal"}},exits:[Ur({top:8}),Y(65)]});this.brynmaerLeft_deadEnd=this.metascreen({id:82,tilesets:{town:{type:"horizontal"}},
exits:[Y(73),Y(76,"door2")]});this.swanLeft_exitW=this.metascreen({id:83,tilesets:{town:{type:"horizontal"}},exits:[Tr({top:9}),Y(73),Y(94,"door2")]});this.swanRight_exitS=this.metascreen({id:84,tilesets:{town:{type:"horizontal"}},exits:[Rr({left:3}),Y(65),Y(67,"door2"),Y(87,"door3")]});this.horizontalTownLeft_exitN=this.metascreen({id:85,tilesets:{town:{type:"horizontal"}},exits:[Qr({left:13}),Y(70),Y(75,"door2")]});this.amazonesRight_deadEnd=this.metascreen({id:86,tilesets:{town:{type:"horizontal"}},
exits:[Y(64),Y(88,"door2")]});this.saharaRight_exitE=this.metascreen({id:87,tilesets:{town:{type:"horizontal"}},exits:[Ur({top:7}),Y(64),Y(102,"door2")]});this.portoaNW=this.metascreen({id:88,tilesets:{town:{type:"square"}},exits:[Pr(71,"fortress"),Rr()]});this.portoaNE=this.metascreen({id:89,tilesets:{town:{type:"square"}},exits:[Y(99),Y(138,"door2"),Rr({left:3,width:4})]});this.portoaSW_exitW=this.metascreen({id:90,tilesets:{town:{type:"square"}},exits:[Tr({top:9}),Y(134),Qr()]});this.portoaSE_exitE=
this.metascreen({id:91,tilesets:{town:{type:"square"}},exits:[Ur({top:9}),Y(122),Y(135,"door2")],tallHouses:[90]});this.dyna=this.metascreen({id:92,tilesets:{tower:{}},exits:[{type:"stair:down",manual:!0,dir:2,entrance:49024,exits:[]}]});this.portoaFisherman=this.metascreen({id:93,tilesets:{town:{type:"square"}},exits:[Ur({top:6}),Tr({top:4,height:6,shift:.5}),Y(104)]});this.verticalTownTop_fortress=this.metascreen({id:94,tilesets:{town:{type:"vertical"}},exits:[Pr(71,"fortress"),Rr()]});this.shyronMiddle=
this.metascreen({id:95,tilesets:{town:{type:"vertical"}},exits:[Y(84),Y(91,"door2"),Qr()]});this.shyronBottom_exitS=this.metascreen({id:96,tilesets:{town:{type:"vertical"}},exits:[Rr({left:3}),Y(4),Y(6,"door2"),Y(153,"door3")]});this.zombieTownMiddle=this.metascreen({id:97,tilesets:{town:{type:"vertical"}},exits:[Y(153),Qr()]});this.zombieTownBottom_caveExit=this.metascreen({id:98,tilesets:{town:{type:"vertical"}},exits:[Pr(146),Y(35),Y(77,"door2")]});this.leafNW_houseShed=this.metascreen({id:99,
tilesets:{town:{type:"square"}},exits:[Y(140),Y(149,"door2")]});this.squareTownNE_house=this.metascreen({id:100,tilesets:{town:{type:"square"}},exits:[Qr({left:1}),Y(183)]});this.leafSW_shops=this.metascreen({id:101,tilesets:{town:{type:"square"}},exits:[Y(119),Y(138,"door2")],tallHouses:[106]});this.leafSE_exitE=this.metascreen({id:102,tilesets:{town:{type:"square"}},exits:[Ur({top:3,height:3,shift:-.5}),Y(132)]});this.goaNW_tavern=this.metascreen({id:103,tilesets:{town:{type:"square"}},exits:[Y(186)]});
this.squareTownSW_exitS=this.metascreen({id:104,tilesets:{town:{type:"square"}},exits:[Rr({left:8}),Y(132)]});this.goaSE_shop=this.metascreen({id:105,tilesets:{town:{type:"square"}},exits:[Y(130)]});this.joelNE_shop=this.metascreen({id:106,tilesets:{town:{type:"square"}},exits:[Y(167)]});this.joelSE_lake=this.metascreen({id:107,tilesets:{town:{type:"square"}}});this.oakNW=this.metascreen({id:108,tilesets:{town:{type:"square"}},exits:[Y(231)]});this.oakNE=this.metascreen({id:109,tilesets:{town:{type:"square"}},
exits:[Y(96)]});this.oakSW=this.metascreen({id:110,tilesets:{town:{type:"square"}},exits:[Y(124)]});this.oakSE=this.metascreen({id:111,tilesets:{town:{type:"square"}},exits:[Rr({left:0,shift:.5}),Y(151)]});this.temple=this.metascreen({id:112,tilesets:{house:{}},exits:[Sr()]});this.wideDeadEndN=this.metascreen({id:113,icon:X`
      | \u2503 |
      | > |
      |   |`,tile:" w | > |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",exits:[Or(199)],statues:[4]});this.goaWideDeadEndN=this.metascreen({id:113,icon:X`
      |\u2575\u2503\u2575|
      | > |
      |   |`,tile:" w | > |   ",tilesets:{labyrinth:{}},edges:"w   ",connect:"1|2x|3",exits:[Or(199)],statues:[4]});this.wideHallNS=this.metascreen({id:114,icon:X`
      | \u2503 |
      | \u2503 |
      | \u2503 |`,tile:" w | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2a",statues:[1,7,13]});this.goaWideHallNS=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|`,tile:" w | w | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"19|2a|3b",statues:[1,7,13]});this.goaWideHallNS_blockedRight=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      |\u2502\u2503 |
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[157]}},edges:"w w ",connect:"19|2a|3|b"});this.goaWideHallNS_blockedLeft=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      | \u2503\u2502|
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[81]}},edges:"w w ",connect:"1|9|2a|3b"});this.goaWideArena=this.metascreen({id:115,icon:X`<
      |\u257b<\u257b|
      |\u2521\u2501\u2529|
      |\u2502\u257b\u2502|`,placement:"manual",tile:"   | < | w ",tilesets:{labyrinth:{}},feature:["arena"],edges:"w w ",connect:"9b|a",exits:[Nr(55)]});this.limeTreeLake=this.metascreen({id:116,tilesets:{lime:{}},exits:[Sr(),Pr(71)],feature:["bridge"],wall:103});this.swampNW=this.metascreen({id:117,icon:X`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss  ",connect:"26",exits:[Qr({left:6,width:4}),Tr({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampE=this.metascreen({id:118,icon:X`
      |   |
      | \u2576\u2500|
      |   |`,tile:"   | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"   s",connect:"e",exits:[],poi:[[0]]});this.swampE_door=this.metascreen({id:118,icon:X`\u2229
      | \u2229 |
      | \u2576\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"   s",connect:"e",exits:[Pr(92,"swamp")]});this.swampNWSE=this.metascreen({id:119,icon:X`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ssss",connect:"26ae",exits:[Qr({left:6,width:4}),Tr({top:7,height:4,shift:-.5}),Rr({left:6,width:4}),Ur({top:7,height:4,shift:-.5})]});this.swampNWS=this.metascreen({id:120,icon:X`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"sss ",connect:"26a",exits:[Qr({left:6,width:4}),Tr({top:7,height:4,shift:-.5}),Rr({left:6,width:4})]});this.swampNE=this.metascreen({id:121,icon:X`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s  s",connect:"2e",exits:[Qr({left:6,width:4}),Ur({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampWSE=this.metascreen({id:122,icon:X`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" sss",connect:"6ae",exits:[Tr({top:7,height:4,shift:-.5}),Rr({left:6,width:4}),Ur({top:7,height:4,shift:-.5})]});this.swampWSE_door=this.metascreen({id:122,icon:X`\u2229
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |c<c| c ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" sss",connect:"6ae",exits:[Pr(86,"swamp")]});this.swampW=this.metascreen({id:123,icon:X`
      |   |
      |\u2500\u2574 |
      |   |`,tile:"   |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s  ",connect:"6",poi:[[0]]});this.swampW_door=this.metascreen({id:123,icon:X`\u2229
      | \u2229 |
      |\u2500\u2574 |
      |   |`,tile:"   |c< |   ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s  ",connect:"6",exits:[Pr(84,"swamp")]});this.swampArena=this.metascreen({id:124,icon:X`
      |   |
      |\u2517\u252f\u251b|
      | \u2502 |`,tile:"   | a | c ",tilesets:{swamp:{}},feature:["arena"],edges:"  s ",connect:"a"});this.swampNWE=this.metascreen({id:125,icon:X`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss s",connect:"26e",exits:[Qr({left:6,width:4}),Tr({top:7,height:4}),Ur({top:7,height:4})]});this.swampWS=this.metascreen({id:126,icon:X`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],update:[[N.SwampDoors,(a,c,d)=>{d.metascreens.swampWS_door.flag="always";return!0}]],edges:" ss ",connect:"6a",exits:[Tr({top:7,height:4}),Rr({left:6,width:4})],poi:[[2]]});this.swampWS_door=this.metascreen({id:126,icon:X`\u2229
      | \u2229 |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |c< | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" ss ",connect:"6a",exits:[Pr(87,"swamp")]});this.swampEmpty=this.metascreen({id:127,icon:X`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{swamp:{}},feature:["empty"],edges:"    ",connect:"",delete:!0});this.swampN=this.metascreen({id:-113,icon:X`
      | \u2502 |
      | \u2575 |
      |   |`,tile:" c | c |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s   ",connect:"2",poi:[[0]],definition:fs(Mr(".  .  .  .  cf f6 c7 ad c4 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b9 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b8 ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad b9 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad ad d2 e2 .  .  .  .\n         .  .  .  .  e3 f6 c3 c3 b8 b6 d2 .  .  .  .  .\n         .  .  .  .  .  e3 fd ad ad fc e2 .  .  .  .  .\n         .  .  .  .  .  .  ff fb fb fa .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200]))});this.swampS=this.metascreen({id:-114,icon:X`
      |   |
      | \u2577 |
      | \u2502 |`,tile:"   | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  s ",connect:"a",poi:[[0]],definition:fs(Mr(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 ca .  .  .  .  .  .\n         .  .  .  .  .  cd eb a0 a0 cb ca .  .  .  .  .\n         .  .  .  .  cf a0 f9 f5 f7 f8 cb cc .  .  .  .\n         .  .  .  .  cf a0 ed 08 09 a0 a0 cc .  .  .  .\n         .  .  .  .  cf db ee 0c 0b ef a0 cc .  .  .  .\n         .  .  .  .  cf d0 d1 03 03 d8 db cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad ad ae d2 cc .  .  .  .\n         .  .  .  .  cf d3 ad b9 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c5 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .",
[".",200]))});this.swampNS=this.metascreen({id:-115,icon:X`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s s ",connect:"2a",exits:[Qr({left:6,width:4}),Rr({left:6,width:4})],definition:fs(Mr(".  .  .  .  cf d3 b6 b6 c6 b6 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c3 c7 b6 f6 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c7 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b6 c6 c5 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c6 c3 c7 d2 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 ad c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 c4 c5 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f5 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 c2 b8 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 c7 b6 d2 cc .  .  .  .",
[".",200]))});this.swampWE=this.metascreen({id:-116,icon:X`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s s",connect:"6e",exits:[Tr({top:7,height:4,shift:-.5}),Ur({top:7,height:4,shift:-.5})],definition:fs(Mr(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9\n         a0 e4 e8 eb e4 a0 a0 a0 eb eb e8 f0 f1 a0 e4 a0\n         a0 e5 e9 f9 f5 f6 f6 f7 ec f9 f7 f8 f2 a0 e5 a0\n         a0 e6 f0 f1 e6 e0 08 09 ed de ea de f2 a0 e6 a0\n         db e7 db f3 e7 e1 0c 0b dd df e0 df f3 db e7 e0\n         d0 d1 da da d0 d1 03 03 d0 d1 d0 d1 da da da da\n         ad c4 ad ad ad ad ad ad ad ad ad ad ad ad ad ad\n         c2 c5 b8 c6 c4 c4 b9 c7 c4 c5 c5 c7 ad ad ad ad\n         ad ad ad ad c2 c3 c3 c3 c3 c3 c7 ad ad ad ad ad\n         fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200]))});this.swampWE_door=this.metascreen({id:-116,icon:X`\u2229
      | \u2229 |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s s",connect:"6e",exits:[Pr(86,"swamp")]});this.swampSE=this.metascreen({id:-117,icon:X`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  ss",connect:"ae",exits:[Ur({top:7,height:4,shift:-.5}),Rr({left:6,width:4})],poi:[[2]],definition:fs(Mr(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 c9 c9 c9 c9 c9 c9 c9\n         .  .  .  .  .  cd a0 a0 a0 e8 04 a0 e8 a0 a0 e4\n         .  .  .  .  cf f8 a0 f0 f1 f5 f5 f7 e9 f4 f7 e5\n         .  .  .  .  cf f6 f7 f8 f2 ea 06 aa e9 f0 f1 e6\n         .  .  .  .  cf a0 dd e0 f3 e0 07 0c ea db f3 e7\n         .  .  .  .  cf db d5 d0 d1 d1 03 03 d0 d1 da da\n         .  .  .  .  cf d5 af c4 c4 ad ad ad ad ad c4 ad\n         .  .  .  .  cf d3 b9 c3 c3 b8 ad ad ad c2 b7 b8\n         .  .  .  .  cf f6 c3 c3 c3 c3 b8 ad ad ad ad ad\n         .  .  .  .  cf f6 c7 ad c2 c3 c7 fc fb fb fb fb\n         .  .  .  .  cf d3 ad ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad b9 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad b9 c7 d2 cc .  .  .  . \n         .  .  .  .  cf d3 b6 b9 c3 b8 d2 cc .  .  .  .",
[".",200]))});this.swampSE_door=this.metascreen({id:-117,icon:X`\u2229
      | \u2229 |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | <c| c ",tilesets:{swamp:{requires:[N.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"  ss",connect:"ae",exits:[Pr(90,"swamp")]});this.swampNSE=this.metascreen({id:-118,icon:X`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s ss",connect:"2ae",exits:[Qr({left:6,width:4}),Rr({left:6,width:4}),Ur({top:7,height:4,shift:-.5})],definition:fs(Mr(".  .  .  .  cf d3 c4 c3 c3 c3 f7 f8 ca .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f7 f7 a0 ca c9 c9\n         .  .  .  .  cf f6 c3 c3 b8 b6 d2 f7 f8 e8 e4 a0\n         .  .  .  .  cf f5 b7 c3 b7 b8 d2 f0 f1 e9 e5 de\n         .  .  .  .  cf d3 c2 b8 c2 b8 d8 db f2 ea e6 df\n         .  .  .  .  cf d3 ad ad ad ad ae d4 f3 dd e7 df\n         .  .  .  .  cf d3 ad ad ad ad ad ae d0 d1 d0 d1\n         .  .  .  .  cf d3 c2 c3 c3 b7 b8 ad ad ad ad ad\n         .  .  .  .  cf d3 ad ad c2 b7 b7 b7 b8 c4 ad ad\n         .  .  .  .  cf d3 ad ad b6 b9 b7 b7 b7 b7 b8 ad\n         .  .  .  .  cf d3 ad c4 c3 b7 b8 fc fb fb fb fb\n         .  .  .  .  cf d3 b6 ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c4 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b9 b7 b7 f6 cc .  .  .  .",
[".",200]))});this.caveEmpty=this.metascreen({id:128,icon:X`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{cave:{},fortress:{},labyrinth:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"    ",delete:!0});this.dolphinCave_empty=this.metascreen({id:128,icon:X`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{dolphinCave:{}},feature:["empty"],edges:"    ",delete:!0});this.open=this.metascreen({id:128,icon:X`
      |   |
      |   |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{},sea:{}},edges:"oooo"});this.hallNS=this.metascreen({id:129,icon:X`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",connect:"2a",poi:[[4]],exits:[Rr({left:6,width:4,manual:!0}),Qr({left:6,width:4,manual:!0})]});this.hallNS_unreachable=this.metascreen({id:129,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE=this.metascreen({id:130,icon:X`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",poi:[[4]]});this.hallWE_unreachable=this.metascreen({id:130,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallSE=this.metascreen({id:131,icon:X`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"  cc",connect:"ae",poi:[[2]]});this.hallSE_unreachable=this.metascreen({id:131,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWS=this.metascreen({id:132,icon:X`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" cc ",connect:"6a",poi:[[2]]});this.hallWS_unreachable=this.metascreen({id:132,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNE=this.metascreen({id:133,icon:X`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c  c",connect:"2e",poi:[[2]],exits:[Qr({left:6,width:4,manual:!0})]});this.hallNE_unreachable=this.metascreen({id:133,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNW=this.metascreen({id:134,icon:X`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc  ",connect:"26",poi:[[2]],exits:[Qr({left:6,width:4,manual:!0})]});this.hallNW_unreachable=this.metascreen({id:134,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNSE=this.metascreen({id:135,icon:X`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c cc",connect:"2ae",poi:[[3]],exits:[Qr({left:6,width:4,manual:!0})]});this.branchNSE_unreachable=this.metascreen({id:135,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWSE=this.metascreen({id:136,icon:X`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cccc",connect:"26ae",poi:[[3]],exits:[Qr({left:6,width:4,manual:!0})]});this.branchNWSE_unreachable=this.metascreen({id:136,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWS=this.metascreen({id:137,icon:X`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"ccc ",connect:"26a",poi:[[3]],exits:[Qr({left:6,width:4,manual:!0})]});this.branchNWS_unreachable=this.metascreen({id:137,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchWSE=this.metascreen({id:138,icon:X`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" ccc",connect:"6ae",poi:[[3]]});this.branchWSE_unreachable=this.metascreen({id:138,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE=this.metascreen({id:139,icon:X`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc c",connect:"26e",poi:[[3]],exits:[Qr({left:6,width:4,manual:!0})]});this.branchNWE_unreachable=this.metascreen({id:139,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_ramp=this.metascreen({id:140,icon:X`
      | \u250b |
      | \u250b |
      | \u250b |`,tile:" c | / | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["ramp"],edges:"c c ",connect:"2a",exits:[Qr({left:6,width:4,manual:!0})]});this.hallNS_ramp_unreachable=this.metascreen({id:140,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_overBridge=this.metascreen({id:141,icon:X`
      | \u257d |
      |\u2500\u2503\u2500|
      | \u257f |`,tile:" c | b | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["overpass"],edges:"cbcb",connect:"2a",exits:[Qr({left:6,width:4,manual:!0})]});this.hallWE_underBridge=this.metascreen({id:142,icon:X`
      | \u257d |
      |\u2500\u2500\u2500|
      | \u257f |`,tile:"   |cbc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["underpass"],edges:"bcbc",connect:"6e"});this.hallNS_wall=this.metascreen({id:143,icon:X`
      | \u2502 |
      | \u2506 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",feature:["wall"],connect:"2=a",wall:135,mod:"wall",exits:[Qr({left:6,width:4,manual:!0})]});this.hallNS_wall_unreachable=this.metascreen({id:143,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE_wall=this.metascreen({id:144,icon:X`
      |   |
      |\u2500\u2504\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},iceCave:{}},feature:["wall"],edges:" c c",connect:"6=e",wall:103,mod:"wall"});this.hallWE_wall_unreachable=this.metascreen({id:144,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arena=this.metascreen({id:145,icon:X`
      |\u250c\u2538\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,tile:[" n | a | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena"],edges:"c c ",connect:"2a",poi:[[1,96,120]],exits:[Qr(),Rr({left:6,width:4,manual:!0}),Vr(230,4),Wr(246,4)],arena:1});this.hallNS_arena_unreachable=this.metascreen({id:145,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arenaWall=this.metascreen({id:146,icon:X`
      |\u250c\u2504\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,placement:"manual",tile:[" n | a | c "],tilesets:{cave:{},iceCave:{}},feature:["arena","wall"],edges:"n c ",connect:"2x=apx",wall:39,mod:"wall",poi:[[1,96,120]],exits:[Qr({top:1}),Rr({left:6,width:4,manual:!0})],arena:1});this.branchNWE_wall=this.metascreen({id:148,icon:X`
      | \u2506 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wall"],edges:"cc c",connect:"2x=6e",exits:[Qr({left:6,width:4})],mod:"wall",wall:55});this.branchNWE_wall_unreachable=this.metascreen({id:148,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE_upStair=this.metascreen({id:149,icon:X`<
      | < |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",exits:[Nr(71)]});this.branchNWE_upStair_unreachable=this.metascreen({id:149,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.deadEndW_upStair=this.metascreen({id:150,icon:X`<
      | < |
      |\u2500\u2518 |
      |   |`,tile:"   |c< |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Nr(66)]});this.deadEndW_upStair_unreachable=this.metascreen({id:150,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndW_downStair=this.metascreen({id:151,icon:X`>
      |   |
      |\u2500\u2510 |
      | > |`,tile:"   |c> |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Or(162)]});this.deadEndW_downStair_unreachable=this.metascreen({id:151,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndE_upStair=this.metascreen({id:152,icon:X`<
      | < |
      | \u2514\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Nr(76)]});this.deadEndE_upStair_unreachable=this.metascreen({id:152,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndE_downStair=this.metascreen({id:153,icon:X`>
      |   |
      | \u250c\u2500|
      | > |`,tile:"   | >c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Or(172)]});this.deadEndE_downStair_unreachable=this.metascreen({id:153,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndNS_stairs=this.metascreen({id:154,icon:X`
      | > |
      |   |
      | < |`,placement:"manual",tile:" > |   | < ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2x|ax",exits:[Or(23),Nr(215)],match:a=>a(264,120)&&a(-48,120)});this.deadEndNS_stairs_unreachable=this.metascreen({id:154,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(264,120)&&!a(-48,120),delete:!0});this.deadEndN_stairs=this.metascreen({id:154,icon:X`
      | > |
      |   |
      |   |`,tile:[" c | > |   "," > |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",exits:[Or(23)],match:a=>!a(264,120)&&a(-48,120)});this.deadEndS_stairs=this.metascreen({id:154,icon:X`
      |   |
      |   |
      | < |`,tile:["   | < | c ","   |   | < "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",exits:[Nr(215)],match:a=>!a(-48,120)&&a(264,120)});this.deadEndNS=this.metascreen({id:155,icon:X`
      | \u2575 |
      |   |
      | \u2577 |`,placement:"manual",tile:" c |   | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c c ",connect:"2p|ap",poi:[[0,-48,120],[0,272,120]],match:a=>a(-48,120)&&a(272,120)});this.deadEndNS_unreachable=this.metascreen({id:155,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(-48,120)&&!a(272,120),delete:!0});this.deadEndN=this.metascreen({id:155,icon:X`
      | \u2575 |
      |   |
      |   |`,tile:[" c | c |   "," c |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c   ",connect:"2",poi:[[0,-48,120]],match:a=>!a(272,120)&&a(-48,120)});this.deadEndS=this.metascreen({id:155,icon:X`
      |   |
      |   |
      | \u2577 |`,tile:["   | c | c ","   |   | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"  c ",connect:"a",poi:[[0,272,120]],match:a=>!a(-48,120)&&a(272,120)});this.deadEndWE=this.metascreen({id:156,icon:X`
      |   |
      |\u2574 \u2576|
      |   |`,placement:"manual",tile:"   |c c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c c",connect:"6p|ep",poi:[[0,112,-40],[0,112,264]],match:a=>a(112,-40)&&a(112,264)});this.deadEndWE_unreachable=this.metascreen({id:156,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(112,-40)&&!a(112,264),delete:!0});this.deadEndW=this.metascreen({id:156,icon:X`
      |   |
      |\u2574  |
      |   |`,tile:["   |cc |   ","   |c  |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c  ",connect:"6",poi:[[0,112,-40]],match:a=>!a(112,264)&&a(112,-40)});this.deadEndE=this.metascreen({id:156,icon:X`
      |   |
      |  \u2576|
      |   |`,tile:["   | cc|   ","   |  c|   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"   c",connect:"e",poi:[[0,112,264]],match:a=>!a(112,-40)&&a(112,264)});this.hallNS_entrance=this.metascreen({id:158,icon:X`\u257d
      | \u2502 |
      | \u2502 |
      | \u257d |`,tile:" c | c | n ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c n ",connect:"2a",exits:[Rr()]});this.hallNS_entrance_unreachable=this.metascreen({id:158,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.channelExitSE=this.metascreen({id:159,icon:X`
      |   |
      | \u2554\u2550|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:"  rr",exits:[Rr({left:5})]});this.channelBendWS=this.metascreen({id:160,icon:X`
      |\u2588  |
      |\u2550\u2557 |
      |\u2588\u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:" rr "});this.channelHallNS=this.metascreen({id:161,icon:X`
      | \u2551 |
      | \u2560\u2508|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],wall:139,edges:"r r "});this.channelEntranceSE=this.metascreen({id:162,icon:X`
      |   |
      | \u2554\u2508|
      |\u2577\u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Rr({left:2})],wall:124,edges:"  rr"});this.channelCross=this.metascreen({id:163,icon:X`
      | \u2551 |
      |\u2550\u256c\u2550|
      |\u2577\u2551\u2577|`,tilesets:{dolphinCave:{}},feature:["river"],exits:[Rr({left:3}),Rr({left:11,type:"door"})],edges:"  rr"});this.channelDoor=this.metascreen({id:164,icon:X`\u2229
      | \u2229\u2588|
      |\u2508\u2550\u2550|
      |  \u2588|`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Y(56)],wall:115,edges:" r  "});this.mountainFloatingIsland=this.metascreen({id:165,icon:X`*
      |\u2550\u2557\u2588|
      |*\u2551 |
      |\u2550\u2563\u2588|`,placement:"manual",tile:"   | ap|   ",tilesets:{mountainRiver:{}},edges:"  wp",connect:"e"});this.mountainPathNE_stair=this.metascreen({id:166,icon:X`\u2514
      |\u2588\u250b\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" / | pp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"l  p",connect:"2e",exits:[Qr()]});this.mountainBranchNWE=this.metascreen({id:167,icon:X`\u2534
      |\u2588 \u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" p |ppp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp p",connect:"26e"});this.mountainPathWE_iceBridge=this.metascreen({id:168,icon:X`\u256b
      |\u2588\u2551\u2588|
      | \u2506 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},feature:["bridge"],edges:"wpwp",connect:"6-e:2a",wall:135});this.mountainPathSE=this.metascreen({id:169,icon:X`\u250c
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588 \u2588|`,tile:"   | pp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:"  pp",connect:"ae",exits:[Ur({top:6,height:4}),Rr({left:6,width:4})]});this.mountainDeadEndW_caveEmpty=this.metascreen({id:170,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2590 \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Pr(56)]});this.mountainPathNE=this.metascreen({id:171,icon:X`\u2514
      |\u2588 \u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" p | pp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"p  p",connect:"2e",exits:[Ur({top:6,height:4}),Qr({left:6,width:4})]});this.mountainBranchWSE=this.metascreen({id:172,icon:X`\u252c
      |\u2588\u2588\u2588|
      |   |
      |\u2588 \u2588|`,tile:"   |ppp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:" ppp",connect:"6ae"});this.mountainPathW_cave=this.metascreen({id:173,icon:X`\u2229
      |\u2588\u2229\u2588|
      |  \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Pr(85)]});this.mountainPathE_slopeS=this.metascreen({id:174,icon:X`\u2553
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588\u2193\u2588|`,tile:"   | pp| \u2193 ",tilesets:{mountain:{}},edges:"  sp",connect:"ae"});this.mountainPathNW=this.metascreen({id:175,icon:X`\u2518
      |\u2588 \u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:" p |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp  ",connect:"26",exits:[Tr({top:6,height:4}),Qr({left:6,width:4})]});this.mountainCave_empty=this.metascreen({id:176,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588\u2588\u2588|`,tile:"   | < |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"    ",connect:"",exits:[Pr(88)]});this.mountainPathE_cave=this.metascreen({id:177,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"   p",connect:"e",exits:[Pr(87)]});this.mountainPathWE_slopeN=this.metascreen({id:178,icon:X`\u2568
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |ppp|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e"});this.mountainDeadEndW=this.metascreen({id:179,icon:X`\u2574
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:"   |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6"});this.mountainPathWE=this.metascreen({id:180,icon:X`\u2500
      |\u2588\u2588\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |ppp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p p",connect:"6e",exits:[Tr({top:6,height:4}),Ur({top:6,height:4})]});this.mountainArena_gate=this.metascreen({id:181,icon:X`#
      |\u2588#\u2588|
      |\u258c \u2590|
      |\u2588\u250b\u2588|`,tile:"   | < | / ",tilesets:{mountain:{},mountainRiver:{}},feature:["arena"],edges:"  l ",connect:"a",exits:[Object.assign({},Nr(71,3),{type:"gate"})],flag:"custom:false"});this.mountainPathN_slopeS_cave=this.metascreen({id:182,icon:X`\u2229
      |\u2588\u250b\u2229|
      |\u258c \u2590|
      |\u2588\u2193\u2588|`,tile:" / | < | \u2193 ",tilesets:{mountain:{}},edges:"l s ",connect:"2a",exits:[Pr(90),Qr()]});this.mountainPathWE_slopeNS=this.metascreen({id:183,icon:X`\u256b
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"26ae"});this.mountainPathWE_slopeN_cave=this.metascreen({id:184,icon:X`\u2229
      |\u2588\u2193\u2229|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |p<p|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e",exits:[Pr(92)]});this.mountainPathWS=this.metascreen({id:185,icon:X`\u2510
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588 \u2588|`,tile:"   |pp | p ",tilesets:{mountain:{},mountainRiver:{}},edges:" pp ",connect:"6a",exits:[Tr({top:6,height:4}),Rr({left:6,width:4})]});this.mountainSlope=this.metascreen({id:186,icon:X`\u2193
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|`,tile:" \u2193 | \u2193 | \u2193 ",tilesets:{mountain:{}},edges:"s s ",connect:"2a"});this.mountainRiver=this.metascreen({id:186,icon:X`\u2551
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|`,tile:[" r | r | r "," r | r |   "],tilesets:{mountainRiver:{}},edges:"w w ",connect:"2:e"});this.mountainPathE_gate=this.metascreen({id:187,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{}},edges:"   p",connect:"e",exits:[Pr(87,"gate")]});this.mountainPathWE_inn=this.metascreen({id:188,icon:X`\u2229
      |\u2588\u2229\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |p<p|   ",placement:"manual",tilesets:{mountain:{}},edges:" p p",connect:"6e",exits:[Y(118)]});this.mountainPathWE_bridgeOverSlope=this.metascreen({id:189,icon:X`\u2550
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"6e",exits:[Vr(182,4)]});this.mountainPathWE_bridgeOverRiver=this.metascreen({id:189,icon:X`\u2550
      |\u2588\u2551\u2588|
      | \u2550 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},edges:"wpwp",connect:"6e|2|a"});this.mountainSlope_underBridge=this.metascreen({id:190,icon:X`\u2193
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |p\u2193p| \u2193 ",placement:"manual",tilesets:{mountain:{}},edges:"spsp",connect:"2a",exits:[Wr(198,4)]});this.mountainEmpty=this.metascreen({id:191,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{mountain:{},mountainRiver:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryS=this.metascreen({id:192,icon:X`
      |   |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^ ^"});this.boundaryN_cave=this.metascreen({id:193,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2229\u2580|
      |   |`,tile:"   |o<o|ooo",tilesets:{grass:{},sea:{},desert:{},river:{requires:[N.SeaCaveEntrance]}},edges:" vov",exits:[Pr(73)]});this.cornerSE_cave=this.metascreen({id:194,icon:X`
      | \u2590\u2588|
      |\u2584\u2229\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |o< |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  ",exits:[Pr(90)]});this.waterfall=this.metascreen({id:195,icon:X`
      |   |
      |\u2193\u2193\u2193|
      |   |`,tile:"ooo|\u2193\u2193\u2193|ooo",tilesets:{sea:{}},edges:"oooo"});this.whirlpoolBlocker=this.metascreen({id:196,icon:X`
      |   |
      |\u2588\u2573\u2588|
      |   |`,tile:"ooo|\u2193#\u2193|ooo",tilesets:{sea:{}},feature:["whirlpool"],flag:"calm",edges:"oooo"});this.beachExitN=this.metascreen({id:197,icon:X`
      |\u2588 \u2588|
      |\u2588\u2571\u2580|
      |\u2588\u258c |`,placement:"manual",tile:" x | bo| oo",tilesets:{sea:{}},edges:"n >v",exits:[Qr({left:9})]});this.whirlpoolOpen=this.metascreen({id:198,icon:X`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{sea:{}},feature:["whirlpool"],edges:"oooo",flag:"calm"});this.quicksandOpen=this.metascreen({id:198,icon:X`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{}},feature:["whirlpool"],edges:"oooo"});this.lighthouseEntrance=this.metascreen({id:199,icon:X`
      |\u2597\u259f\u2588|
      |\u2590\u2229\u259b|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"oo |oLo|ooo",tilesets:{sea:{}},feature:["lighthouse"],edges:"<oov",exits:[Pr(42),Y(117)]});this.beachCave=this.metascreen({id:200,icon:X`
      |\u2588\u2229\u2588|
      |\u2580\u2572\u2588|
      |   |`,placement:"manual",tile:"   |o<o|ooo",tilesets:{sea:{}},edges:" vov",exits:[Pr(40)]});this.beachCabinEntrance=this.metascreen({id:201,icon:X`
      | \u2229\u2588|
      | \u2572\u2580|
      |\u2588\u2584\u2584|`,placement:"manual",tile:"oo |oC8|   ",tilesets:{sea:{}},feature:["cabin"],edges:"<^ b",exits:[Y(85),Ur({top:8,height:3})]});this.oceanShrine=this.metascreen({id:202,icon:X`
      |\u2597\u2584\u2596|
      |\u2590*\u258c|
      |\u259d \u2598|`,placement:"manual",tile:"ooo|oAo|ooo",tilesets:{sea:{}},feature:["altar"],edges:"oooo"});this.pyramidEntrance=this.metascreen({id:203,icon:X`
      | \u2584 |
      |\u259f\u2229\u2599|
      | \u2573 |`,placement:"manual",tile:"ooo|oPo|ooo",tilesets:{desert:{}},feature:["pyramid"],edges:"oooo",exits:[Pr(167,"fortress")]});this.cryptEntrance=this.metascreen({id:204,icon:X`
      | \u2573 |
      |\u2590>\u258c|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"ooo|oYo|ooo",tilesets:{desert:{}},feature:["crypt"],edges:"oooo",exits:[Or(103)]});this.oasisLake=this.metascreen({id:205,icon:X`
      | ^ |
      |vOv|
      | vv|`,tile:"ooo|ooo|oro",placement:"manual",tilesets:{desert:{}},feature:["lake"],edges:"oo3o"});this.desertCaveEntrance=this.metascreen({id:206,icon:X`
      |\u2597\u2584\u2596|
      |\u259c\u2229\u259b|
      | \u2573 |`,tile:"ooo|o<o|ooo",tilesets:{desert:{},sea:{requires:[N.SeaCaveEntrance]}},edges:"oooo",exits:[Pr(167)]});this.oasisCave=this.metascreen({id:207,icon:X`
      | vv|
      |\u2584\u2229v|
      |\u2588\u258c |`,placement:"manual",tile:"oro|o<o| oo",tilesets:{desert:{}},edges:"3^>o",exits:[Nr(55)]});this.channelEndW_cave=this.metascreen({id:208,icon:X`
      |\u2588\u2588\u2229|
      |\u2550\u2550 |
      |\u2588\u2588\u2588|`,tile:"   |r< |   ",tilesets:{dolphinCave:{}},feature:["river"],exits:[Nr(87)]});this.boatChannel=this.metascreen({id:209,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      |\u2584\u2584\u2584|`,tile:["   |888|   ","   |88x|   "],tilesets:{sea:{}},edges:" b b",exits:[Object.assign({},Ur({top:8,height:3}),{entrance:40168}),Tr({top:8,height:3})]});this.channelWE=this.metascreen({id:210,icon:X`
      |\u2588\u2588\u2588|
      |\u2550\u2550\u2550|
      |\u2588\u2588\u2588|`,tile:"   |rrr|   ",tilesets:{dolphinCave:{}},feature:["river"]});this.riverCaveNWSE=this.metascreen({id:211,icon:X`
      |\u2518\u2551\u2514|
      |\u2550\u256c\u2550|
      |\u252c\u2507\u252c|`,tile:" r |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"rrrr",connect:"15p:3dp:79-bf",wall:182,poi:[[4,0,72],[4,0,152]]});this.riverCaveNS=this.metascreen({id:212,icon:X`
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3b",mod:"bridge"});this.riverCaveWE=this.metascreen({id:213,icon:X`
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" r r",connect:"5d:7f",mod:"bridge"});this.riverCaveNS_bridge=this.metascreen({id:214,icon:X`
      |\u2502\u2551\u2502|
      |\u251c\u2507\u2524|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r r ",connect:"19-3b",wall:135});this.riverCaveWE_bridge=this.metascreen({id:215,icon:X`
      |\u2500\u252c\u2500|
      |\u2550\u2505\u2550|
      |\u2500\u2534\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:" r r",connect:"5d-7f",wall:134});this.riverCaveSE=this.metascreen({id:216,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u2554\u2550|
      |\u2502\u2551\u250c|`,tile:"   | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"  rr",connect:"9d:bf"});this.riverCaveWS=this.metascreen({id:217,icon:X`
      |\u2500\u2500\u2510|
      |\u2550\u2557\u2502|
      |\u2510\u2551\u2502|`,tile:"   |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rr ",connect:"5b:79"});this.riverCaveNE=this.metascreen({id:218,icon:X`
      |\u2502\u2551\u2514|
      |\u2502\u255a\u2550|
      |\u2514\u2500\u2500|`,tile:" r | rr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r  r",connect:"1f:3d"});this.riverCaveNW=this.metascreen({id:219,icon:X`
      |\u2518\u2551\u2502|
      |\u2550\u255d\u2502|
      |\u2500\u2500\u2518|`,tile:" r |rr |   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr  ",connect:"15:37"});this.riverCaveWE_passageN=this.metascreen({id:220,icon:X`\u2567
      |\u2500\u2534\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:" c |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"cr r",connect:"25d:7f"});this.riverCaveWE_passageS=this.metascreen({id:221,icon:X`\u2564
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u252c\u2500|`,tile:"   |rrr| c ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rcr",connect:"5d:7af"});this.riverCaveNS_passageW=this.metascreen({id:222,icon:X`\u2562
      |\u2502\u2551\u2502|
      |\u2524\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r |cr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rcr ",connect:"169:3b"});this.riverCaveNS_passageE=this.metascreen({id:223,icon:X`\u255f
      |\u2502\u2551\u2502|
      |\u2502\u2551\u251c|
      |\u2502\u2551\u2502|`,tile:" r | rc| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rc",connect:"19:3be"});this.wideHallNE=this.metascreen({id:224,icon:X`
      | \u2503 |
      | \u2517\u2501|
      |   |`,tile:" w | ww|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w  w",connect:"2e"});this.goaWideHallNE=this.metascreen({id:224,icon:X`
      |\u2502\u2503\u2514|
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{}},edges:"w  w",connect:"1f|2e|3d"});this.goaWideHallNE_blockedLeft=this.metascreen({id:224,icon:X`
      |\u2502\u2503\u2514|
      | \u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[97]}},edges:"w  w",connect:"1|f|2e|3d"});this.goaWideHallNE_blockedRight=this.metascreen({id:224,icon:X`
      |\u2502\u2503 |
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[13]}},edges:"w  w",connect:"1f|2e|3|d"});this.wideHallNW=this.metascreen({id:225,icon:X`
      | \u2503 |
      |\u2501\u251b |
      |   |`,tile:" w |ww |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww  ",connect:"26"});this.goaWideHallNW=this.metascreen({id:225,icon:X`
      |\u2518\u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],removeWall:109}},edges:"ww  ",connect:"15|26|37"});this.goaWideHallNW_blockedRight=this.metascreen({id:225,icon:X`
      |\u2518\u2503\u2502|
      |\u2501\u251b |
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{}},edges:"ww  ",connect:"15|26|3|7"});this.goaWideHallNW_blockedLeft=this.metascreen({id:225,icon:X`
      | \u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[1],removeWall:109}},edges:"ww  ",connect:"1|5|26|37"});this.wideHallSE=this.metascreen({id:226,icon:X`
      |   |
      | \u250f\u2501|
      | \u2503 |`,tile:"   | ww| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  ww",connect:"ae"});this.goaWideHallSE=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{}},edges:"  ww",connect:"9d|ae|bf"});this.goaWideHallSE_blockedLeft=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      | \u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[97]}},edges:"  ww",connect:"9|d|ae|bf"});this.goaWideHallSE_blockedRight=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503 |`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[221]}},edges:"  ww",connect:"9d|ae|b|f"});this.wideHallWS=this.metascreen({id:227,icon:X`
      |   |
      |\u2501\u2513 |
      | \u2503 |`,tile:"   |ww | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" ww ",connect:"6a"});this.goaWideHallWS=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],removeWall:157}},edges:" ww ",connect:"5b|6a|79"});this.goaWideHallWS_blockedRight=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513 |
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{}},edges:" ww ",connect:"5|b|6a|79"});this.goaWideHallWS_blockedLeft=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      | \u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[209],removeWall:157}},edges:" ww ",connect:"5b|6a|7|9"});this.goaWideHallNS_stairs=this.metascreen({id:228,icon:X`
      |\u251c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2524|`,tile:" w | H | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"1239ab"});this.goaWideHallNS_stairsBlocked13=this.metascreen({id:228,icon:X`
      |\u2514\u2528\u2502|
      |\u2577\u2503\u2575|
      |\u2502\u2520\u2510|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[65,141]}},edges:"w w ",connect:"12ab|3|9"});this.goaWideHallNS_stairsBlocked24=this.metascreen({id:228,icon:X`
      |\u250c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2518|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[1,205]}},edges:"w w ",connect:"1|239a|b"});this.wideHallNS_deadEnds=this.metascreen({id:229,icon:X`
      | \u2579 |
      |   |
      | \u257b |`,tile:" w |   | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2|a",match:a=>a(272,120)&&a(-48,120)});this.wideHall_deadEndN=this.metascreen({id:229,icon:X`
      | \u2579 |
      |   |
      |   |`,tile:[" w |   |   "," w | w |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",match:a=>!a(272,120)&&a(-48,120)});this.wideHall_deadEndS=this.metascreen({id:229,icon:X`
      |   |
      |   |
      | \u257b |`,tile:["   |   | w ","   | w | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  w ",connect:"a",match:a=>a(272,120)&&!a(-48,120)});this.goaWideHallNS_deadEnd=this.metascreen({id:229,icon:X`
      |\u2502\u2579\u2502|
      |\u251c\u2500\u2524|
      |\u2502\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"139b|2|a"});this.goaWideHallNS_deadEndBlocked24=this.metascreen({id:229,icon:X`
      |\u2575\u2579\u2502|
      |\u250c\u2500\u2518|
      |\u2502\u257b\u2577|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[97,173]}},edges:"w w ",connect:"1|2|39|a|b"});this.goaWideHallNS_deadEndBlocked13=this.metascreen({id:229,icon:X`
      |\u2502\u2579\u2575|
      |\u2514\u2500\u2510|
      |\u2577\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[109,161]}},edges:"w w ",connect:"1b|2|3|9|a"});this.wideHallNWSE=this.metascreen({id:230,icon:X`
      | \u2503 |
      |\u2501\u254b\u2501|
      | \u2503 |`,tile:" w |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"wwww",connect:"26ae"});this.goaWideHallNWSE=this.metascreen({id:230,icon:X`
      |\u2518\u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{}},edges:"wwww",connect:"26ae|15|3d|79|bf"});this.goaWideHallNWSE_blocked13=this.metascreen({id:230,icon:X`
      |\u2518\u2503 |
      |\u2501\u254b\u2501|
      | \u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[13,209]}},edges:"wwww",connect:"26ae|15|3|d|7|9|bf"});this.goaWideHallNWSE_blocked24=this.metascreen({id:230,icon:X`
      | \u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503 |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[1,221]}},edges:"wwww",connect:"26ae|1|5|3d|79|b|f"});this.wideHallNWE=this.metascreen({id:231,icon:X`
      | \u2503 |
      |\u2501\u253b\u2501|
      |   |`,tile:" w |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww w",connect:"26e"});this.goaWideHallNWE=this.metascreen({id:231,icon:X`
      |\u2518\u2503\u2514|
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{}},edges:"ww w",connect:"26e|15|3d|7f"});this.goaWideHallNWE_blockedTop=this.metascreen({id:231,icon:X`
      | \u2503 |
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[1,13]}},edges:"ww w",connect:"26e|1|5|3|d|7f"});this.wideHallWSE=this.metascreen({id:232,icon:X`
      |   |
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" www",connect:"6ae"});this.goaWideHallWSE=this.metascreen({id:232,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      |\u2510\u2503\u250c|`,tile:"   |www| w ",tilesets:{labyrinth:{}},edges:" www",connect:"6ae|5d|79|bf"});this.goaWideHallWSE_blockedBottom=this.metascreen({id:232,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{labyrinth:{requires:[N.LabyrinthParapets],addWall:[209,221]}},edges:" www",connect:"6ae|5d|7|9|b|f"});this.wideHallNS_wallTop=this.metascreen({id:233,icon:X`
      | \u2506 |
      | \u2503 |
      | \u2503 |`,tile:" n | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide","wall"],edges:"c w",connect:"2a",exits:[Qr({left:6,width:4})],wall:55,statues:[10]});this.goaWideHallNS_wallTop=this.metascreen({id:233,icon:X`
      | \u2506 |
      |\u2577\u2503\u2577|
      |\u2502\u2503\u2502|`,tile:" n | w | w ",tilesets:{labyrinth:{}},feature:["wall"],edges:"c w ",connect:"2ax|9|b",exits:[Qr({left:6,width:4})],wall:55,statues:[10]});this.wideHallWE=this.metascreen({id:234,icon:X`
      |   |
      |\u2501\u2501\u2501|
      |   |`,tile:"   |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" w w",connect:"6e"});this.goaWideHallWE=this.metascreen({id:234,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2501\u2501|
      |\u2500\u2500\u2500|`,tile:"   |www|   ",tilesets:{labyrinth:{}},edges:" w w",connect:"5d|6e|7f"});this.pitWE=this.metascreen({id:235,tile:"   |cpc|   ",icon:X`
      |   |
      |\u2500\u2573\u2500|
      |   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:" c c",connect:"6e",platform:{type:"horizontal",coord:28728}});this.pitNS=this.metascreen({id:236,icon:X`
      | \u2502 |
      | \u2573 |
      | \u2502 |`,tile:" c | p | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:"c c ",connect:"2a",platform:{type:"vertical",coord:16504}});this.pitNS_unreachable=this.metascreen({id:236,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.spikesNS_hallS=this.metascreen({id:237,icon:X`
      | \u2591 |
      | \u2591 |
      | \u2502 |`,tile:" s | s | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s c ",connect:"2a"});this.spikesNS_hallN=this.metascreen({id:238,icon:X`
      | \u2502 |
      | \u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" c | s | s ",feature:["spikes"],edges:"c s ",connect:"2a"});this.spikesNS_hallWE=this.metascreen({id:239,icon:X`
      | \u2591 |
      |\u2500\u2591\u2500|
      | \u2591 |`,tile:" s |csc| s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"scsc",connect:"26ae"});this.spikesNS_hallW=this.metascreen({id:-225,icon:X`
      | \u2591 |
      |\u2500\u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s |cs | s ",feature:["spikes"],edges:"scs ",connect:"26a",definition:a=>Mr("L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R",
["L",a.metascreens.spikesNS_hallWE],["R",a.metascreens.spikesNS])});this.spikesNS_hallE=this.metascreen({id:-226,icon:X`
      | \u2591 |
      | \u2591\u2500|
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s | sc| s ",feature:["spikes"],edges:"s sc",connect:"2ae",definition:a=>Mr("L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R",
["L",a.metascreens.spikesNS],["R",a.metascreens.spikesNS_hallWE])});this.riverCave_deadEndsNS=this.metascreen({id:240,icon:X`
      | \u2568 |
      |   |
      | \u2565 |`,tile:" r |   | r ",placement:"manual",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r r ",connect:"1p:3p|9p:bp",poi:[[1,-48,72],[1,-48,152],[1,272,72],[1,272,152]]});this.riverCave_deadEndsN=this.metascreen({id:240,icon:X`
      | \u2568 |
      |   |
      |   |`,tile:[" r |   |   "," r | r |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r   ",connect:"1p:3p",poi:[[1,-48,72],[1,-48,152]],match:a=>!a(264,72)&&!a(264,152),mod:"bridge"});this.riverCave_deadEndsS=this.metascreen({id:240,icon:X`
      |   |
      |   |
      | \u2565 |`,tile:["   |   | r ","   | r | r "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"  r ",connect:"9p:bp",poi:[[1,272,72],[1,272,152]],match:a=>!a(-48,72)&&!a(-48,152),mod:"bridge"});this.riverCave_deadEndsWE=this.metascreen({id:241,icon:X`
      |   |
      |\u2561 \u255e|
      |   |`,tile:"   |r r|   ",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r r",connect:"5p:7p|dp:fp",poi:[[1,96,-40],[1,160,-40],[1,96,264],[1,160,264]]});this.riverCave_deadEndsW=this.metascreen({id:241,icon:X`
      |   |
      |\u2561  |
      |   |`,tile:["   |r  |   ","   |rr |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r  ",connect:"5p:7p",poi:[[1,96,-40],[1,160,-40]],match:a=>!a(96,264)&&!a(160,264)});this.riverCave_deadEndsE=this.metascreen({id:241,icon:X`
      |   |
      |  \u255e|
      |   |`,tile:["   |  r|   ","   | rr|   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"   r",connect:"dp:fp",poi:[[1,96,264],[1,160,264]],match:a=>!a(96,-40)&&!a(160,-40)});this.riverCaveN_bridge=this.metascreen({id:242,icon:X`
      | \u2507 |
      | \u2568 |
      |   |`,tile:[" r | r |   "," r |   |   "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r   ",connect:"1-3",wall:23,match:a=>!a(208,72)&&!a(208,152)});this.riverCaveS_bridge=this.metascreen({id:242,icon:X`
      |   |
      | \u2565 |
      | \u2507 |`,tile:["   | r | r ","   |   | r "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"  r ",connect:"9-b",wall:198,match:a=>!a(16,72)&&!a(16,152)});this.riverCaveWSE=this.metascreen({id:243,icon:X`
      |\u2500\u2500\u2500|
      |\u2550\u2566\u2550|
      |\u2510\u2551\u250c|`,tile:"   |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rrr",connect:"5d:79:bf"});this.riverCaveNWE=this.metascreen({id:244,icon:X`
      |\u2518\u2551\u2514|
      |\u2550\u2569\u2550|
      |\u2500\u2500\u2500|`,tile:" r |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr r",connect:"15p:3dp:7f",poi:[[4,0,72],[4,0,152]]});this.riverCaveNWS=this.metascreen({id:-241,icon:X`
      |\u2518\u2551\u2502|
      |\u2550\u2563\u2502|
      |\u2510\u2551\u2502|`,tile:" r |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rrr ",connect:"15p:3b:79",poi:[[4,0,72]],definition:a=>Mr("A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R",
["A",a.metascreens.riverCaveNWE],["B",a.metascreens.riverCaveWSE],["R",a.metascreens.riverCaveNS])});this.riverCaveNSE=this.metascreen({id:-242,icon:X`
      |\u2502\u2551\u2514|
      |\u2502\u2560\u2550|
      |\u2502\u2551\u250c|`,tile:" r | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rr",connect:"19:3dp:bf",poi:[[4,0,152]],definition:a=>Mr("L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B",
["A",a.metascreens.riverCaveNWE],["B",a.metascreens.riverCaveWSE],["L",a.metascreens.riverCaveNS])});this.riverCaveNS_blockedRight=this.metascreen({id:245,icon:X`
      |\u2502\u2551\u2502|
      |\u2502\u2551 |
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3p:bp",poi:[[0,64,152],[0,192,152]],mod:"block"});this.riverCaveNS_blockedLeft=this.metascreen({id:246,icon:X`
      |\u2502\u2551\u2502|
      | \u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"1p:3b:9p",poi:[[0,48,72],[0,176,72]],mod:"block"});this.spikesNS=this.metascreen({id:247,icon:X`
      | \u2591 |
      | \u2591 |
      | \u2591 |`,tile:" s | s | s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s s ",connect:"2a"});this.cryptArena_statues=this.metascreen({id:248,icon:X`<
      |&<&|
      |\u2502 \u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | c ",tilesets:{pyramid:{}},feature:["arena"],edges:"  c ",connect:"a",exits:[Object.assign({},Nr(87),{type:"crypt"})],flag:"custom:false",arena:2});this.pyramidArena_draygon=this.metascreen({id:249,icon:X`
      |\u250c\u2500\u2510|
      |\u2502\u2573\u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | w ",tilesets:{pyramid:{}},feature:["arena","pit"],edges:"  w ",connect:"a",arena:3});this.cryptArena_draygon2=this.metascreen({id:250,icon:X`
      |\u250f\u2537\u2513|
      |\u2503&\u2503|
      |\u2517\u2533\u251b|`,tile:" x | a | w ",tilesets:{pyramid:{}},feature:["arena"],edges:"c w ",connect:"2a",exits:[Qr({left:6,width:4})],flag:"custom:false",arena:4});this.cryptArena_entrance=this.metascreen({id:251,icon:X`
      | \u2503 |
      | \u2503 |
      | \u257f |`,tile:" w | w | x ",tilesets:{pyramid:{}},edges:"w n ",connect:"2a",exits:[Rr()]});this.cryptTeleporter=this.metascreen({id:252,tilesets:{pyramid:{},tower:{}},exits:[Rr({left:6,width:4}),Pr(87,"teleporter")]});this.fortressArena_through=this.metascreen({id:253,icon:X`\u257d
      |\u250c\u2534\u2510|
      |\u2502 \u2502|
      |\u2515\u2533\u2519|`,tile:[" c | a | w "," n | a | w "],tilesets:{fortress:{},pyramid:{}},feature:["arena"],edges:"n w ",connect:"2a",exits:[Qr()],arena:5});this.fortressTrap=this.metascreen({id:254,icon:X`
      |\u2514\u2500\u2518|
      | \u2573 |
      |\u2576\u252c\u2574|`,tile:"   | x | n ",tilesets:{fortress:{},pyramid:{}},feature:["pit"],edges:"  n ",connect:"a",exits:[Rr()]});this.shrine=this.metascreen({id:255,tilesets:{shrine:{}},exits:[Rr({left:6,width:5}),Y(104)]});this.inn=this.metascreen({id:256,tilesets:{house:{}},exits:[Object.assign({},Y(134),{entrance:37992})]});this.toolShop=this.metascreen({id:257,tilesets:{house:{}},exits:[Object.assign({},Y(134),{entrance:37992})]});this.armorShop=this.metascreen({id:258,tilesets:{house:{}},
exits:[Object.assign({},Y(134),{entrance:37992})]});for(const b in this)a=this[b],a instanceof Xr&&(a.name=b)}metascreen(a){const b=new Xr(this.rom,this.length,a);this[this.length++]=b;this.screensById.get(b.sid).push(b);for(const c in a.tilesets){const d=c,e=a.tilesets[d];if(e.requires)for(const a of e.requires)this.screensByFix.get(a).push(b);else this.rom.metatilesets[d].addScreen(b)}return b}getById(a,b){a=this.screensById.has(a)?[...this.screensById.get(a)]:[];null!=b&&(a=a.filter(a=>a.isCompatibleWithTileset(b)));
return a}registerFix(a,b){for(const d of this.screensByFix.get(a)){var c=(d.data.update||[]).find(b=>b[0]===a);if(c){if(null==b)throw Error("Seed required for update");if(!c[1](d,b,this.rom))continue}for(const b in d.data.tilesets){c=b;const e=d.data.tilesets[c];if(!e.requires)continue;const g=e.requires.indexOf(a);0>g||(e.requires.splice(g,1),e.requires.length||this.rom.metatilesets[c].addScreen(d))}}this.registeredFixes.add(a)}isFixed(a){return this.registeredFixes.has(a)}renumber(a,b,c){if(a!==
b){var d=this.screensById.get(b);if(d.length)throw Error(`ID already used: ${va(b)}: ${d.join(", ")}`);for(var e of this.getById(a))if(!c||e.tilesets().some(a=>c.has(a))){if(e.data.definition){var f=e.data.definition(this.rom);e.data.definition=void 0}e.unsafeSetId(b);d.push(e)}this.screensById.delete(a);e=this.rom.screens.getScreen(a);0<=a&&0>b&&(d[0].data.definition=fs(Uint8Array.from(e.tiles)));d=e.clone(b);this.rom.screens.setScreen(b,d);e.used=!1;0>a&&(this.rom.screens.deleteScreen(a),f&&0<=
b&&(d.tiles=Array.from(f)));this.rom.locations.renumberScreen(a,b)}}checkExitTypes(){var a;for(const b in this){const c=this[b],d=new Set;for(const e of(null===(a=null===c||void 0===c?void 0:c.data)||void 0===a?void 0:a.exits)||[])d.has(e.type)&&console.log(`duplicate: ${b} ${e.type}`),d.add(e.type)}}}function fs(a){return()=>a};class gs extends ug{constructor(a,b){super(a,b);this.mirrored=null;this.pointer=230492+(this.id<<1);this.base=ee(a.prg,this.pointer)+196608;this.used=229376<=this.base;if(255===a.prg[this.base]){const c=ee(a.prg,this.base+1);for(let b=0;256>b;b++)if(ee(a.prg,230492+(b<<1))===c){this.mirrored=b;break}if(null==this.mirrored)throw Error(`could not find mirrored sprite for ${x(b)}: ${x(c)}`);this.frames=this.frameMask=this.size=0;this.sprites=[]}else this.mirrored=null,this.size=a.prg[this.base],this.frameMask=
a.prg[this.base+1],this.frames=this.frameMask+1,this.sprites=w(this.frames,b=>{b=this.base+2+4*b*this.size;const c=[];for(let d=0;d<this.size&&128!==a.prg[b+4*d];d++)c.push(Xd(a.prg,b+4*d,4));return c})}patternBanks(a=0){if(!this.used)return[];let b=this;b.mirrored&&(b=this.rom.metasprites[b.mirrored]);const c=new Set;for(const d of b.sprites)for(const [b,,,f]of d){if(128===b)break;c.add(f+a>>>6&255)}return[...c]}palettes(){if(!this.used)return[];let a=this;a.mirrored&&(a=this.rom.metasprites[a.mirrored]);
const b=new Set;for(const c of a.sprites)for(const [a,,e]of c){if(128===a)break;b.add(e&3)}return[...b]}};class hs{constructor(a){this.rom=a;this._all=[];this.grass=this.tileset(128,{patterns:[0,12]});this.town=this.tileset(132,{});this.cave=this.tileset(136,{});this.dolphinCave=this.tileset(136,{});this.pyramid=this.tileset(140,{});this.river=this.tileset(144,{animated:[0,1],patterns:[20,0]});this.sea=this.tileset(148,{});this.lime=this.tileset(148,{});this.mountain=this.tileset(148,{});this.shrine=this.tileset(152,{});this.desert=this.tileset(156,{});this.mountainRiver=this.tileset(156,{});this.swamp=
this.tileset(160,{consolidated:!0});this.house=this.tileset(160,{});this.fortress=this.tileset(164,{});this.labyrinth=this.tileset(164,{});this.iceCave=this.tileset(168,{});this.tower=this.tileset(172,{});for(const b in this)a=this[b],a instanceof is&&(a.name=b)}tileset(a,b){a=new is(this.rom,a,b);this._all.push(a);return a}[Symbol.iterator](){return this._all[Symbol.iterator]()}}
class is{constructor(a,b,c){this.rom=a;this.tilesetId=b;this.data=c;this._screens=new Set;this._cache=void 0}[Symbol.iterator](){return this._screens[Symbol.iterator]()}get cache(){this._cache||(this._cache=new js(this));return this._cache}get tileset(){return this.rom.tilesets[this.tilesetId]}get empty(){const a=this.cache.empty;if(!a)throw Error(`No empty screen for ${this.name}`);return a}effects(){return this.tileset.effects()}getTile(a){return this.tileset.getTile(a)}addScreen(a){this._screens.add(a);
a.unsafeAddTileset(this);this.invalidate()}deleteScreen(a){this._screens.delete(a);a.unsafeRemoveTileset(this);this.invalidate()}getMetascreens(a){var b;return null!==(b=this.cache.fromId.get(a))&&void 0!==b?b:[]}getExits(a){return this.cache.exits.get(a)}getMetascreensFromTileString(a){return this.cache.tiles.has(a)?this.cache.tiles.get(a):[]}getScreensWithOnlyFeatures(...a){let b=0;for(const c of a)b|=Lr[c];a=[];for(const c of this)c.features&~b||a.push(c);return a}withMod(a,b){const c=[];for(const d of this.cache.tiles.get(a))d.data.mod===
b&&c.push(d);return c}unreachableVariant(a){for(const b of this)if(b.sid===a.sid&&b.isEmpty())return b;return a}isBannedVertical(a,b){return this.cache.bannedNeighbors[0].has(a.uid<<16|b.uid)}isBannedHorizontal(a,b){return this.cache.bannedNeighbors[1].has(a.uid<<16|b.uid)}invalidate(){this._cache=void 0}}var ks,ls=ks||(ks={});ls.N=0;ls.W=1;ls.S=2;ls.E=3;
class js{constructor(a){var b,c;this.tileset=a;this.fromId=new da(()=>[]);this.exits=new da(()=>[]);this.tiles=new da(()=>[]);this.bannedNeighbors=[new Set,new Set];let d=void 0;for(const f of a){0<=f.sid&&this.fromId.get(f.sid).push(f);d||"    "!==f.data.edges||"manual"===f.data.placement||!f.hasFeature("empty")||(null===(b=f.data.exits)||void 0===b?0:b.length)||(d=f);for(const a of null!==(c=f.data.exits)&&void 0!==c?c:[])this.exits.get(a.type).push(f);var e="string"===typeof f.data.tile?[f.data.tile]:
f.data.tile;for(const a of null!==e&&void 0!==e?e:[])this.tiles.get(a.replace(/\|/g,"")).push(f);(f.hasFeature("ramp")||f.hasFeature("overpass")||f.hasFeature("pit")||f.isEmpty())&&this.banDeadEndNeighbor(f);e=a.rom.metascreens;this.banDeadEndNeighbor(e.branchNWE_wall,1);this.banNeighbor(e.deadEndS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndS_stairs,e.deadEndNS_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndNS_stairs,2)}this.empty=
null!==d&&void 0!==d?d:a.rom.metascreens.caveEmpty}banDeadEndNeighbor(a,b=15){var c,d;for(const e of this.tileset)if(e.hasFeature("deadend"))for(let f=0;4>f;f++)b&1<<f&&" "!==(null===(c=a.data.edges)||void 0===c?void 0:c[f])&&" "!==(null===(d=e.data.edges)||void 0===d?void 0:d[f^2])&&this.banNeighbor(a,e,f)}banNeighbor(a,b,c){this.bannedNeighbors[c&1].add((c&2?a:b).uid<<16|(c&2?b:a).uid)}};class Z extends ug{constructor(a,b,c,d={}){super(a.rom,b);this.type=c;this.data=d;a[b]=this}}
class ms extends vg{constructor(a){super();this.rom=a;this.straightShotOptionalBounce=new Z(this,16,"projectile");this.straightShotNoBounce=new Z(this,17,"projectile");this.madoShuriken=new Z(this,22,"projectile");this.demonWallFire=new Z(this,23,"projectile");this.popcorn=new Z(this,27,"projectile");this.harpoonSource=new Z(this,29,"source");this.lasers=new Z(this,30,"projectile");this.paralysisPowder=new Z(this,31,"projectile");this.randomMovement=new Z(this,32,"monster",{movement:1});this.randomLargeStoner=
new Z(this,33,"monster",{hasChild:!0,large:!0,movement:2});this.slowHoming=new Z(this,34,"monster",{hasChild:!0,movement:3});this.smallHoming1=new Z(this,36,"monster",{movement:3});this.smallHoming2=new Z(this,37,"monster",{movement:3});this.homingShooter1=new Z(this,38,"monster",{hasChild:!0,projectile:1,movement:3});this.homingShooter2=new Z(this,39,"monster",{hasChild:!0,projectile:1,movement:3});this.headShooter=new Z(this,40,"monster",{hasChild:!0,projectile:2,movement:3,metasprites:()=>[101,
145]});this.puddle=new Z(this,41,"monster",{hasChild:!0,movement:5,metasprites:()=>[107,104]});this.soldier=new Z(this,42,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});this.mimic=new Z(this,43,"monster",{movement:4});this.mothResidueSource=new Z(this,44,"source",{hasChild:!0});this.flailGuy=new Z(this,46,"monster",{hasChild:!0,large:!0,projectile:2,movement:3});this.dynaLaser=new Z(this,47,"projectile");this.guardianStatue=new Z(this,52,"source",{hasChild:!0});
this.movingPlatform=new Z(this,56,"other");this.crumblingMovingPlatform=new Z(this,60,"other");this.erraticFlyer=new Z(this,64,"monster",{hasChild:!0,moth:!0,movement:4,placement:"moth"});this.skeleton=new Z(this,65,"monster",{hasChild:!0,movement:3});this.swampTomato=new Z(this,68,"monster",{movement:3});this.shootingFlyer=new Z(this,69,"monster",{hasChild:!0,bird:!0,projectile:2,movement:5,placement:"bird"});this.swampPlant=new Z(this,76,"monster",{hasChild:!0,stationary:!0,projectile:3,placement:"plant"});
this.kraken=new Z(this,77,"monster",{hasChild:!0,stationary:!0,projectile:3});this.burt=new Z(this,78,"monster",{hasChild:!0,stationary:!0});this.dynaShot=new Z(this,87,"projectile",{});this.popcorn2=new Z(this,88,"projectile");this.towerSentinel=new Z(this,92,"monster",{hasChild:!0,projectile:3,movement:1});this.helicopter=new Z(this,93,"monster",{bird:!0,movement:6,placement:"bird"});this.whiteRobot=new Z(this,94,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});
this.vampire=new Z(this,96,"boss");this.vampireBat=new Z(this,97,"monster");this.kelbesque=new Z(this,99,"boss");this.kelbesqueRock=new Z(this,100,"projectile");this.sabera=new Z(this,102,"boss");this.mado=new Z(this,103,"boss");this.karmine=new Z(this,104,"boss");this.draygon1=new Z(this,106,"boss");this.draygon2=new Z(this,107,"boss");this.dyna=new Z(this,112,"boss");this.giantBug=new Z(this,127,"boss")}};class ns extends vg{constructor(a){super(256);this.rom=a;this.mesiaSabera=new Og(this,42,"Mesia");this.sorcerorShot=new J(this,{id:63,scaling:37,type:"projectile"});this.wraith1=new J(this,{id:75,scaling:24,class:"wraith",displayName:"Wraith"});this.paralysisPowderSource=new J(this,{id:77,scaling:23,type:"projectile"});this.wraith2=new J(this,{id:79,scaling:28,class:"wraith",displayName:"Wraith"});this.blueSlime=new J(this,{id:80,scaling:1,class:"slime",displayName:"Slime"});this.weretiger=new J(this,
{id:81,scaling:1,displayName:"Weretiger"});this.greenJelly=new J(this,{id:82,scaling:4,class:"jelly",displayName:"Slug"});this.redSlime=new J(this,{id:83,scaling:4,class:"slime",displayName:"Poison Slime"});this.rockGolem=new J(this,{id:84,scaling:4,class:"golem",displayName:"Mud Golem"});this.blueBat=new J(this,{id:85,scaling:4,displayName:"Bat"});this.greenWyvern=new J(this,{id:86,scaling:4,class:"wyvern",displayName:"Wyvern"});this.vampire1=new J(this,{id:87,scaling:5,type:"boss",displayName:"Vampire"});
this.orc=new J(this,{id:88,scaling:6,displayName:"Axe Wereboar"});this.redMosquito=new J(this,{id:89,scaling:10,class:"mosquito",displayName:"Mosquito"});this.blueMushroom=new J(this,{id:90,scaling:10,class:"mushroom",displayName:"Mushroom"});this.swampTomato=new J(this,{id:91,scaling:10,displayName:"Pillbug"});this.blueMosquito=new J(this,{id:92,scaling:23,class:"mosquito",displayName:"Mosquito"});this.swampPlant=new J(this,{id:93,scaling:10,displayName:"Swamp Dandelion"});this.giantInsect=new J(this,
{id:94,scaling:11,type:"boss",displayName:"Giant Insect"});this.largeBlueSlime=new J(this,{id:95,scaling:11,class:"slime",displayName:"Large Slime"});this.iceZombie=new J(this,{id:96,scaling:12,class:"zombie",displayName:"Ice Zombie"});this.greenBrain=new J(this,{id:97,scaling:12,class:"brain",displayName:"Brain"});this.greenSpider=new J(this,{id:98,scaling:12,class:"spider",displayName:"Spider"});this.redWyvern=new J(this,{id:99,scaling:12,class:"wyvern",displayName:"Wyvern"});this.soldier=new J(this,
{id:100,scaling:14,class:"soldier",displayName:"Draygonia Soldier"});this.iceEntity=new J(this,{id:101,scaling:14,class:"entity",displayName:"Ice Plant"});this.redBrain=new J(this,{id:102,scaling:14,class:"brain",displayName:"Poison Brain"});this.iceGolem=new J(this,{id:103,scaling:14,class:"golem",displayName:"Ice Golem"});this.kelbesque1=new J(this,{id:104,scaling:15,type:"boss",displayName:"General Kelbesque"});this.largeRedSlime=new J(this,{id:105,scaling:18,class:"slime",displayName:"Large Poison Slime"});
this.troll=new J(this,{id:106,scaling:18,displayName:"Troll"});this.redJelly=new J(this,{id:107,scaling:18,class:"jelly",displayName:"Poison Jelly"});this.medusa=new J(this,{id:108,scaling:19,displayName:"Medusa"});this.crab=new J(this,{id:109,scaling:19,displayName:"Crab"});this.medusaHead=new J(this,{id:110,scaling:20,displayName:"Flying Plant"});this.bird=new J(this,{id:111,scaling:20,class:"bird",displayName:"Bird"});this.redMushroom=new J(this,{id:113,scaling:21,class:"mushroom",displayName:"Poison Mushroom"});
this.earthEntity=new J(this,{id:114,scaling:22,class:"entity",displayName:"Poison Plant"});this.mimic=new J(this,{id:115,scaling:22,displayName:"Mimic"});this.redSpider=new J(this,{id:116,scaling:22,class:"spider",displayName:"Paralyzing Spider"});this.fishman=new J(this,{id:117,scaling:25,displayName:"Mutant Fish"});this.jellyfish=new J(this,{id:118,scaling:25,displayName:"Jellyfish"});this.kraken=new J(this,{id:119,scaling:25,displayName:"Kraken"});this.darkGreenWyvern=new J(this,{id:120,scaling:27,
class:"wyvern",displayName:"Wyvern Mage"});this.sandZombie=new J(this,{id:121,scaling:38,class:"zombie",displayName:"Sand Zombie"});this.wraithShadow1=new J(this,{id:123,scaling:28,class:"wraith",displayName:"Shadow"});this.moth=new J(this,{id:124,scaling:28,difficulty:3,displayName:"Butterfly"});this.sabera1=new J(this,{id:125,scaling:29,type:"boss",displayName:"General Sabera"});this.verticalPlatform=new Og(this,126);this.horizotalPlatform=new Og(this,127);this.archer=new J(this,{id:128,scaling:33,
class:"soldier",displayName:"Draygonia Archer"});this.bomberBird=new J(this,{id:129,scaling:33,class:"bird",displayName:"Bomber Bird"});this.lavaBlob=new J(this,{id:130,scaling:37,class:"puddle",displayName:"Lava Blob"});this.flailGuy=new J(this,{id:132,scaling:37,displayName:"Flail Guy"});this.blueEye=new J(this,{id:133,scaling:37,class:"eye",displayName:"Beholder"});this.salamander=new J(this,{id:134,scaling:37,displayName:"Salamander"});this.sorceror=new J(this,{id:135,scaling:37,displayName:"Burt"});
this.mado1=new J(this,{id:136,scaling:37,displayName:"General Mado"});this.knight=new J(this,{id:137,scaling:41,difficulty:1,displayName:"Ninja"});this.devil=new J(this,{id:138,scaling:41,displayName:"Devil Bat"});this.kelbesque2=new J(this,{id:139,scaling:41,type:"boss",displayName:"General Kelbesque"});this.wraithShadow2=new J(this,{id:140,scaling:41,class:"wraith",displayName:"Shadow"});this.glitch1=new Og(this,141);this.glitch2=new Og(this,142);this.guardianStatue=new Og(this,143);this.sabera2=
new J(this,{id:144,scaling:41,type:"boss",displayName:"General Sabera"});this.tarantula=new J(this,{id:145,scaling:41,displayName:"Tarantula"});this.skeleton=new J(this,{id:146,scaling:41,displayName:"Skeleton"});this.mado2=new J(this,{id:147,scaling:41,type:"boss",displayName:"General Mado"});this.purpleEye=new J(this,{id:148,scaling:41,class:"eye",displayName:"Beholder"});this.flailKnight=new J(this,{id:149,scaling:41,displayName:"Flail Knight"});this.scorpion=new J(this,{id:150,scaling:41,displayName:"Scorpion"});
this.karmine=new J(this,{id:151,scaling:41,type:"boss",displayName:"General Karmine"});this.sandBlob=new J(this,{id:152,scaling:44,class:"puddle",displayName:"Sand Blob"});this.mummy=new J(this,{id:153,scaling:44,displayName:"Mummy"});this.warlock=new J(this,{id:154,scaling:46,displayName:"Warlock"});this.draygon1=new J(this,{id:155,scaling:45,type:"boss",displayName:"Emperor Draygon"});this.statueOfSun=new Og(this,156);this.statueOfMoon=new Og(this,157);this.draygon2=new J(this,{id:158,scaling:47,
type:"boss",displayName:"Emperor Draygon"});this.crumblingVerticalPlatform=new Og(this,159);this.brownRobot=new J(this,{id:160,scaling:47,difficulty:1,displayName:"Robot Sentry"});this.whiteRobot=new J(this,{id:161,scaling:47,displayName:"Robot Enforcer"});this.towerSentinel=new J(this,{id:162,scaling:47,displayName:"Tower Sentinel"});this.helicopter=new J(this,{id:163,scaling:47,displayName:"Robocopter"});this.dyna=new J(this,{id:164,scaling:47,type:"boss",displayName:"DYNA"});this.vampire2=new J(this,
{id:165,scaling:28,type:"boss",displayName:"Vampire"});this.glitch3=new Og(this,166);this.dynaPod=new J(this,{id:180,scaling:47,type:"boss",displayName:"DYNA Defense Pod"});this.dynaCounter=new J(this,{id:184,scaling:47,type:"projectile"});this.dynaLaser=new J(this,{id:185,scaling:47,type:"projectile"});this.dynaBubble=new J(this,{id:186,scaling:47,type:"projectile"});this.vampire2Bat=new J(this,{id:188,scaling:28});this.brownRobotLaserSource=new J(this,{id:190,scaling:47,type:"projectile"});this.draygon2Fireball=
new J(this,{id:191,scaling:47,type:"projectile"});this.vampire1Bat=new J(this,{id:193,scaling:5});this.giantInsectFireball=new J(this,{id:195,scaling:11,type:"projectile"});this.greenMosquito=new J(this,{id:196,scaling:11,displayName:"Mosquito"});this.kelbesque1Rock=new J(this,{id:197,scaling:15,type:"projectile"});this.sabera1Balls=new J(this,{id:198,scaling:29,type:"projectile"});this.kelbesque2Fire=new J(this,{id:199,scaling:41,type:"projectile"});this.sabera2Fire=new J(this,{id:200,scaling:41,
type:"projectile"});this.sabera2Balls=new J(this,{id:201,scaling:41,type:"projectile"});this.karmineBalls=new J(this,{id:202,scaling:41,type:"projectile"});this.statueBalls=new J(this,{id:203,scaling:47,type:"projectile"});this.draygon1Lightning=new J(this,{id:204,scaling:45,type:"projectile"});this.draygon2Laser=new J(this,{id:205,scaling:47,type:"projectile"});this.draygon2Breath=new J(this,{id:206,scaling:47,type:"projectile"});this.birdBomb=new J(this,{id:224,scaling:33,type:"projectile"});this.greenMosquitoShot=
new J(this,{id:226,scaling:11,type:"projectile"});this.paralysisBeam=new J(this,{id:227,scaling:25,type:"projectile"});this.stoneGaze=new J(this,{id:228,scaling:19,type:"projectile"});this.rockGolemRock=new J(this,{id:229,scaling:4,type:"projectile"});this.curseBeam=new J(this,{id:230,scaling:41,type:"projectile"});this.mpDrainWeb=new J(this,{id:231,scaling:41,type:"projectile"});this.fishmanTrident=new J(this,{id:232,scaling:25,type:"projectile"});this.orcAxe=new J(this,{id:233,scaling:6,type:"projectile"});
this.swampPollen=new J(this,{id:234,scaling:10,type:"projectile"});this.paralysisPowder=new J(this,{id:235,scaling:23,type:"projectile"});this.soldierSword=new J(this,{id:236,scaling:14,type:"projectile"});this.iceGolemRock=new J(this,{id:237,scaling:14,type:"projectile"});this.trollAxe=new J(this,{id:238,scaling:18,type:"projectile"});this.krakenInk=new J(this,{id:239,scaling:25,type:"projectile"});this.archerArrow=new J(this,{id:240,scaling:33,type:"projectile"});this.knightSword=new J(this,{id:242,
scaling:41,type:"projectile"});this.mothResidue=new J(this,{id:243,scaling:28,type:"projectile"});this.brownRobotLaser=new J(this,{id:244,scaling:47,type:"projectile"});this.whiteRobotLaser=new J(this,{id:245,scaling:47,type:"projectile"});this.towerSentinelLaser=new J(this,{id:246,scaling:47,type:"projectile"});this.skeletonShot=new J(this,{id:247,scaling:41,type:"projectile"});this.blobShot=new J(this,{id:248,scaling:37,type:"projectile"});this.flailKnightFlail=new J(this,{id:249,scaling:41,type:"projectile"});
this.flailGuyFlail=new J(this,{id:250,scaling:37,type:"projectile"});this.madoShuriken=new J(this,{id:252,scaling:37,type:"projectile"});this.guardianStatueMissile=new J(this,{id:253,scaling:36,type:"projectile"});this.demonWallFire=new J(this,{id:254,scaling:37,type:"projectile"});for(var b in this)a=this[b],a instanceof Og&&(a.name=Wd(b));for(b=0;b<this.length;b++)this[b]||(this[b]=new Og(this,b))}write(){const a=[];for(var b of this)a.push(...b.write());if(this.rom.writeMonsterNames){b=this.rom.assembler();
var c=Math.max(...this.map(a=>a.displayName.length));if(27<c)throw Error(`Longest displayName length is greater than ${27}. (${c} > ${27})\nCrystalis HUD can't comfortably fit that many characters.`);b.assign("ENEMY_NAME_LENGTH",c);b.export("ENEMY_NAME_LENGTH");b.segment("1a");b.reloc("EnemyNameBlocklist");b.label("EnemyNameBlocklist");b.export("EnemyNameBlocklist");c=[this.dynaCounter,this.dynaLaser,this.dynaBubble];c=this.filter(a=>0<a.hp&&""==a.displayName).concat(c);b.byte(...c.map(a=>a.id));
b.assign("ENEMY_NAME_BLOCKLIST_LEN",c.length);b.export("ENEMY_NAME_BLOCKLIST_LEN");a.push(b.module())}return a}};var os;(function(a){a.bit=(a,c)=>new ps(a,c);a.byte=a=>new qs(a);a.address=a=>new rs(a)})(os||(os={}));class ps{constructor(a,b){this.address=a;this.bit=b}get(a){return!!(a[this.address]&1<<this.bit)}set(a,b){const c=1<<this.bit;a[this.address]=b?a[this.address]|c:a[this.address]&~c}}class qs{constructor(a){this.address=a}get(a){return a[this.address]}set(a,b){a[this.address]=b&255}}
class rs{constructor(a){this.address=a}get(a){return a[this.address]<<16|a[this.address+1]<<8|a[this.address+2]}set(a,b){a[this.address]=b>>>16&255;a[this.address+1]=b>>>8&255;a[this.address+2]=b&255}};class ss extends ug{constructor(a,b){super(a,b);this.base=(b&3)<<2|(b&252)<<6|16624;this.colors=Xd(a.prg,this.base,4)}color(a){return this.colors[a]&63}};class ts{constructor(a){this.rom=a;this.values=Xd(a.prg,us.offset,64)}write(){const a=this.rom.assembler();us.loc(a);a.byte(...this.values);return[a.module()]}}const us=xe.of(B.$1a,38884);const {$0d:vs,$fe:ws,$ff:xs}=B;
class ys{constructor(a){this.rom=a;this.patk=Array(48).fill(0);this.pdef=Array(48).fill(0);this.php=Array(48).fill(0);this.exp=Array(48).fill(0);this.setPAtkFormula(a=>5+15*a/32);this.setPDefFormula(a=>a);this.setPhpFormula(a=>48+5.5*a);this.setExpScalingFactor(1)}setExpScalingFactor(a){this.setExpFormula(b=>Math.floor(4*Math.pow(2,(16+9*b)/32)*a))}setPAtkFormula(a){this.patk=this.patk.map((b,c)=>Math.round(8*a(c)))}setPDefFormula(a){this.pdef=this.pdef.map((b,c)=>Math.round(4*a(c)))}setPhpFormula(a){this.php=
this.php.map((b,c)=>Math.min(255,Math.max(5,Math.round(a(c)))))}setExpFormula(a){this.exp=this.exp.map((b,c)=>{b=a(c);return 128>b?b:Math.min(255,128+(b>>4))})}write(){const a=this.rom.assembler();ze(a,[vs,ws,xs],"DiffAtk");a.byte(...this.patk);ze(a,[vs,ws,xs],"DiffDef");a.byte(...this.pdef);ze(a,[vs,ws,xs],"DiffHP");a.byte(...this.php);ze(a,[vs,ws,xs],"DiffExp");a.byte(...this.exp);return[a.module()]}};class zs extends ug{constructor(a,b){super(a,b);this.used=!0;this.tiles=Xd(a.prg,(255<b?64+b:b)<<8,240)}clone(a){a=new zs(this.rom,a);a.used=this.used;a.tiles=[...this.tiles];return a}allTilesSet(){return new Set(this.tiles)}set2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){const f=e[b];null!=f&&(this.tiles[a+d<<4|c+b]=f)}}}get2d(a,b){const c=a&15;var d=a>>>4;a=(b&15)+1;b=d+(b>>>4);const e=[];for(;d<=b;d++){const b=d<<4|c;e.push(this.tiles.slice(b,
b+a))}return e}assemble(a){const b=this.id.toString(16).padStart(2,"0");let c=this.tiles;if(this.rom.compressedMapData||256>this.id){const b=(this.id>>5).toString(16).padStart(2,"0");a.segment(b);"0a"===b&&(c=c.slice(192))}else a.segment("0a"),c=c.slice(0,192);a.org(32768|(this.id&63)<<8,`Screen_${b}`);a.byte(...c)}}
class As extends Array{constructor(a){super(259);this.rom=a;this.unallocated=[];for(let b=0;259>b;b++)this[b]=new zs(a,b)}getScreen(a){const b=0>a?this.unallocated:this,c=0>a?~a:a;return b[c]||(b[c]=new zs(this.rom,a))}setScreen(a,b){(0>a?this.unallocated:this)[0>a?~a:a]=b}deleteScreen(a){delete (0>a?this.unallocated:this)[0>a?~a:a]}write(){const a=this.rom.assembler();for(const b of this)(null===b||void 0===b?0:b.used)&&b.assemble(a);return[a.module()]}};const {$0e:Bs}=B;
class Cs extends Array{constructor(a){super(128);this.rom=a;this.checkCount=112;this.mimicCount=16;for(a=0;128>a;a++)this[a]=a}setCheckCount(a){this.checkCount=a}setMimicCount(a){this.mimicCount=a}swap(a,b){if(a!==b){var c=this[a];this[a]=this[b];this[b]=c}}exportDigits(a,b,c){c=c.toString().padStart(3,"0");a.assign(`${b}_HUN`,Number(c[0]));a.export(`${b}_HUN`);a.assign(`${b}_TEN`,Number(c[1]));a.export(`${b}_TEN`);a.assign(`${b}_ONE`,Number(c[2]));a.export(`${b}_ONE`)}write(){const a=this.rom.assembler();
ze(a,[Bs],"CheckToItemGetMap");this.exportDigits(a,"CHECK_COUNT",this.checkCount);this.exportDigits(a,"MIMIC_COUNT",this.mimicCount);a.byte(...this);return[a.module()]}};const {$0e:Ds,$fe:Es,$ff:Fs}=B;var Gs,Hs=Gs||(Gs={});Hs[Hs.TORNEL=0]="TORNEL";Hs[Hs.ZEBU=1]="ZEBU";Hs[Hs.ASINA=2]="ASINA";Hs[Hs.KENSU=3]="KENSU";var Is,Js=Is||(Is={});Js[Js.INSUFFICIENT_MAGIC=0]="INSUFFICIENT_MAGIC";Js[Js.FREE_MAGIC=1]="FREE_MAGIC";Js[Js.IGNORED=2]="IGNORED";Js[Js.DEFAULT=3]="DEFAULT";
class Ks{constructor(a){this.rom=a;this.sages=w(4,a=>new Ls(this,a));this.resultTable=Xd(a.prg,115247,64);a.telepathyTablesAddress?(this.groupsByLocation=[],this.minimumLevels=[]):(this.groupsByLocation=Xd(a.prg,121076,256),this.minimumLevels=Xd(a.prg,115219,7))}write(){var a=this.rom.telepathyTablesAddress;const b=this.rom.assembler();b.segment(Ds.name,Es.name,Fs.name);if(a)for(ye(b,Ds,39156,39680),a=this.sages.map((a,c)=>{b.reloc(`Telepathy_Sage_${c}`);c=b.pc();b.byte(...a.messageGroups[0].bytes());
return c}),b.org(33327,"Telepathy_ResultTable"),b.byte(...this.resultTable.map(a=>4>a?a:a>>>1)),b.reloc("TelepathyTable"),b.export("TelepathyTable"),b.label("TelepathyTable"),b.word(...a),a=1;4>a;a++)for(var c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);else{ye(b,Ds,39500,39680);b.org(33327,"Telepathy_ResultTable");b.byte(...this.resultTable);b.org(33299,"Telepathy_LevelsTable");b.byte(...this.minimumLevels);b.org(39156,"Telepathy_LocationTable");b.byte(...this.groupsByLocation);b.org(39468,
"Telepathy_VanillaDefaultsTable");for(a=0;4>a;a++)for(c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);a=[];for(c=0;4>c;c++){const d=this.sages[c];for(let e=0,f=d.messageGroups.length;e<f;e++)b.reloc(`Telepathy_Sage_${c}_Group_${e}`),a[4*e+c]=b.pc(),b.byte(...d.messageGroups[e].bytes())}b.org(39412,"Telepathy_VanillaMainTable");b.word(...a)}return[b.module()]}}
class Ls{constructor(a,b){this.telepathy=a;this.sage=b;const c=a.rom;let d,e;c.telepathyTablesAddress?(e=d=c.telepathyTablesAddress+2*b,a=1):(d=121388+2*b,e=121332+2*b,a=7);this.defaultMessages=w(4,a=>Gk.from(c.prg,d+8*a));this.messageGroups=w(a,a=>Ms.from(c.prg,e+8*a))}}
class Ms{constructor(a){this.messages=a}bytes(){const a=[];for(let b=0,c=this.messages.length;b<c;b++){const [d,e,f]=this.messages[b];let g=0<=d?d:8192|~d;b===c-1&&(g|=32768);f&&(g|=16384);a.push(g>>=8,g&255,...e.data,...f?f.data:[])}return a}static from(a,b){const c=new Ms([]);b=ee(a,b)+81920;let d=0;for(;!(d&32768);){d=de(a,b);b+=2;var e=d&8191;d&8192&&(e=~e);e=[e,Gk.from(a,b)];b+=2;d&16384&&(e.push(Gk.from(a,b)),b+=2);c.messages.push(e)}return c}};class Ns extends ug{constructor(a,b){super(a,b);this.base=255865+(b<<3);this.pages=Xd(a.prg,this.base,8)}};class Os extends ug{constructor(a,b){super(a,b);this.effects=Xd(a.prg,this.base,256)}get base(){return this.id<<8&8191|73728}get org(){return this.id<<8&8191|40960}write(){const a=this.rom.assembler();a.segment("09","fe","ff");a.org(this.org,`TileEffects_${this.id.toString(16)}_Tiles`);a.byte(...this.effects);return[a.module()]}}Os.PIT=1;Os.NO_WALK=2;Os.IMPASSIBLE=4;Os.ALTERNATIVE=8;Os.BEHIND=16;Os.SLOPE=32;Os.SLOW=64;Os.PAIN=128;class Ps{constructor(a,b){this.tileset=a;this.id=b;this.copiedFrom=-1}get tiles(){return[0,1,2,3].map(a=>this.tileset.tiles[a][this.id])}setTiles(a){for(let b=0;4>b;b++){const c=a[b];null!=c&&(this.tileset.tiles[b][this.id]=c)}return this}get alternative(){const a=32>this.id?this.tileset.alternates[this.id]:this.id;return a!==this.id?a:null}setAlternative(a){if(32<=this.id)return this;this.tileset.alternates[this.id]=null!=a?a:this.id;this.tileset.effects().effects[this.id]|=8;return this}get attrs(){return this.tileset.attrs[this.id]}setAttrs(a){this.tileset.attrs[this.id]=
a;return this}get effects(){return this.tileset.effects().effects[this.id]}setEffects(a){this.tileset.effects().effects[this.id]=a;return this}copyFrom(a){const b=new Ps(this.tileset,a);this.copiedFrom=a;this.setTiles(b.tiles);32>(this.id|b.id)&&this.setAlternative(b.alternative);this.setAttrs(b.attrs);this.setEffects(b.effects);return this}replaceIn(...a){if(0>this.copiedFrom)throw Error("Must copyFrom first.");for(const b of a)b.replace(this.copiedFrom,this.id);return this}};class Qs{constructor(a){this.rom=a;this.tilesets=[];for(let b=128;176>b;b+=4)this.tilesets.push(this[b]=new Rs(a,b))}[Symbol.iterator](){return this.tilesets[Symbol.iterator]()}}
class Rs extends ug{constructor(a,b){super(a,b);this.tiles=w(4,b=>Xd(a.prg,this.tileBase|b<<8,256));this.attrs=w(256,b=>a.prg[this.attrBase|b>>2]>>((b&3)<<1)&3);this.alternates=Xd(a.prg,this.alternatesBase,32)}get map(){return this.id&63}get tileBase(){return 65536|this.map<<8}get attrBase(){return 77824|this.map<<4}get alternatesBase(){return 81408|this.map<<3}getTile(a){return new Ps(this,a)}write(){const a=w(64,a=>{a<<=2;return this.attrs[a]&3|(this.attrs[a+1]&3)<<2|(this.attrs[a+2]&3)<<4|(this.attrs[a+
3]&3)<<6}),b=this.rom.assembler(),c=`Tileset_${this.id.toString(16).padStart(2,"0")}`;b.segment("08","09");b.org(32768|this.map<<8,`${c}_Tiles`);b.byte(...[].concat(...this.tiles));b.org(45056|this.map<<4,`${c}_Attrs`);b.byte(...a);b.org(48640|this.map<<3,`${c}_Alternates`);b.byte(...this.alternates);return[b.module()]}effects(){let a=this.id>>>2&15;168===this.id&&(a=2);172===this.id&&a--;return this.rom.tileEffects[a]}};class Ss{constructor(a){this.rom=a;this.locations=Xd(a.prg,Ts.offset,12);this.thunderSwordWarp=[a.prg[251338],a.prg[251342]]}write(){const a=this.rom.assembler();Ts.loc(a);a.label("TownWarpTable");a.byte(...this.locations);a.org(56460);a.instruction("lda","TownWarpTable,y");a.org(54729);a.instruction("lda","#"+this.thunderSwordWarp[0]);a.org(54733);a.instruction("lda","#"+this.thunderSwordWarp[1]);return[a.module()]}}const Ts=xe.of(B.$fe,56408);const Us=new Set([131,135,136,137,143,147,150,152,155,156,157,158,159,170,179,181,185,190,192]);
class Vs extends ug{constructor(a,b){super(a,b);this.used=!Us.has(b);this.pointer=123258+((b&127)<<1);this.base=$d(a.prg,this.pointer,81920);this.conditions=[];this.message=Gk.of({});this.flags=[];let c=this.base;do{b=de(a.prg,c);var d=b&4095;this.conditions.push(b&8192?~d:d);c+=2}while(!(b&32768));this.message=Gk.from(a.prg,c);do c+=2,b=de(a.prg,c),d=b&4095,this.flags.push(b&32768?~d:d);while(!(b&16384))}bytes(){const a=[];this.conditions.length||this.conditions.push(-1);for(var b=0;b<this.conditions.length;b++){var c=
this.conditions[b];0>c&&(c=~c|8192);b===this.conditions.length-1&&(c|=32768);a.push(c>>>8,c&255)}a.push(...this.message.data);this.flags.length||this.flags.push(-1);for(b=0;b<this.flags.length;b++)c=this.flags[b],0>c&&(c=~c|32768),b===this.flags.length-1&&(c|=16384),a.push(c>>>8,c&255);return a}write(){if(!this.used)return[];const a=this.rom.assembler(),b=`Trigger_${x(this.id)}`;a.segment("0f");a.reloc(b);const c=a.pc();a.byte(...this.bytes());a.org(41338+2*(this.id&127),b+"_Ptr");a.word(c);return[a.module()]}}
;class Ws{constructor(a){this.rom=a;this.locations=Xd(a.prg,Xs.offset,16)}write(){const a=this.rom.assembler();Xs.loc(a);a.label("WildWarpLocations");a.byte(...this.locations);a.org(52185);a.instruction("lda","WildWarpLocations,y");return[a.module()]}}const Xs=xe.of(B.$fe,52204);const {$0e:Ys,$0f:Zs,$10:$s}=B;
class at{constructor(a){this.modules=new Map;this.allocatedTriggers=new Map;const b=16+(a[6]&4?512:0),c=b+16384*a[4];this.prg=a.subarray(b,c);this.chr=a.subarray(c);this.shopCount=at.SHOP_COUNT.get(a);this.scalingLevels=at.SCALING_LEVELS.get(a);this.uniqueItemTableAddress=at.UNIQUE_ITEM_TABLE.get(a);this.shopDataTablesAddress=at.SHOP_DATA_TABLES.get(a);this.telepathyTablesAddress=at.TELEPATHY_TABLES.get(a);this.omitItemGetDataSuffix=at.OMIT_ITEM_GET_DATA_SUFFIX.get(a);this.omitLocalDialogSuffix=at.OMIT_LOCAL_DIALOG_SUFFIX.get(a);
this.compressedMapData=at.COMPRESSED_MAPDATA.get(a);this.writeMonsterNames=at.WRITE_MONSTER_NAMES.get(a);for(const a of bt){const [b,c,d]=a;this.prg[b]===c&&(this.prg[b]=d)}this.tilesets=new Qs(this);this.tileEffects=w(11,a=>new Os(this,a+179));this.screens=new As(this);this.metatilesets=new hs(this);this.metascreens=new es(this);this.triggers=w(67,a=>new Vs(this,128|a));this.patterns=new bl(this);this.palettes=w(256,a=>new ss(this,a));this.locations=new Ak(this);this.tileAnimations=w(4,a=>new Ns(this,
a));this.hitboxes=w(24,a=>new hr(this,a));this.objectActions=new ms(this);this.objects=new ns(this);this.adHocSpawns=w(96,a=>new Lq(this,a));this.metasprites=w(256,a=>new gs(this,a));this.messages=new yr(this);this.telepathy=new Ks(this);this.itemGets=new pr(this);this.items=new Dl(this);this.shops=new wg(this);this.slots=new Cs(this);this.npcs=new Mk(this);this.bossKills=w(14,a=>new Mq(this,a));this.wildWarp=new Ws(this);this.townWarp=new Ss(this);this.coinDrops=new Sq(this);this.flags=new fr(this);
this.bosses=new Pq(this);this.scaling=new ys(this);this.randomNumbers=new ts(this);for(const a of this.locations)a.used&&a.lazyInitialization()}trigger(a){if(128>a||255<a)throw Error(`Bad trigger id $${x(a)}`);return this.triggers[a&127]}get projectiles(){const a=new Set;for(const b of this.objects.filter(a=>a instanceof J))b.child&&a.add(this.objects[this.adHocSpawns[b.child].objectId]);return[...a].sort((a,c)=>a.id-c.id)}get monsterGraphics(){const a={};for(const b of this.locations)if(b.used&&
b.hasSpawns)for(const c of b.spawns)if(!(c.data[2]&7)){const d=c.data[2]&128?1:0,e=x(c.data[3]+80);(a[e]=a[e]||{})[`${d}:${b.spritePatterns[d].toString(16)}:${b.spritePalettes[d].toString(16)}`]={pal:b.spritePalettes[d],pat:b.spritePatterns[d],slot:d}}return a}get locationMonsters(){const a={};for(const b of this.locations){if(!b.used||!b.hasSpawns)continue;const c=a["$"+x(b.id)]={};for(const a of b.spawns)if(!(a.data[2]&7)){const b=a.data[2]&128?1:0,d=a.data[3]+80;c[`${b}:${d.toString(16)}`]=(c[`${b}:${d.toString(16)}`]||
0)+1}}return a}assembler(){return new $a}writeData(a){a=void 0===a?this.prg:a;var b,c=this.assembler();ye(c,Ys,34682,35165);ye(c,Ys,35557,39156);ye(c,Ys,40422,40960);ye(c,Zs,40960,41222);ye(c,Zs,41472,41920);ye(c,$s,37146,37992);const d=[...this.modules.values(),c.module()];c=a=>{for(const b of a)d.push(...b.write())};d.push(...this.locations.write());d.push(...this.objects.write());c(this.hitboxes);c(this.triggers);d.push(...this.npcs.write());c(this.tilesets);c(this.tileEffects);c(this.adHocSpawns);
d.push(...this.itemGets.write());d.push(...this.slots.write());d.push(...this.items.write());d.push(...this.shops.write());c(this.bossKills);c(this.patterns);d.push(...this.wildWarp.write());d.push(...this.townWarp.write());d.push(...this.coinDrops.write());d.push(...this.scaling.write());d.push(...this.bosses.write());d.push(...this.randomNumbers.write());d.push(...this.telepathy.write());d.push(...this.messages.write());d.push(...this.screens.write());c=new wb;c.base(this.prg,0);for(const a of d)c.read(a);
c.link().apply(a);a===this.prg&&(a=c.exports(),this.uniqueItemTableAddress=a.get("KeyItemData").offset,this.shopCount=11,this.shopDataTablesAddress=(null===(b=a.get("ShopData"))||void 0===b?void 0:b.offset)||0,at.SHOP_COUNT.set(this.prg,this.shopCount),at.SCALING_LEVELS.set(this.prg,this.scalingLevels),at.UNIQUE_ITEM_TABLE.set(this.prg,this.uniqueItemTableAddress),at.SHOP_DATA_TABLES.set(this.prg,this.shopDataTablesAddress||0),at.OMIT_ITEM_GET_DATA_SUFFIX.set(this.prg,this.omitItemGetDataSuffix),
at.OMIT_LOCAL_DIALOG_SUFFIX.set(this.prg,this.omitLocalDialogSuffix),at.COMPRESSED_MAPDATA.set(this.prg,this.compressedMapData),at.WRITE_MONSTER_NAMES.set(this.prg,this.writeMonsterNames))}analyzeTiles(){}disjointTilesets(){var a=[];for(var b of this.locations)if(b.used){var c=b.tileset;for(const d of b.screens)for(const b of d)(a[b]||(a[b]=new Set)).add(c)}b=w(256,()=>new Fg);for(c=0;c<a.length;c++)if(a[c])for(var d of this.screens[c].allTilesSet())b[d].union([...a[c]]);for(a=0;a<b.length;a++)d=
b[a].sets().map(a=>[...a].map(x).join(" ")).join(" | "),console.log(`Tile ${x(a)}: ${d}`)}swapMetatiles(a,...b){var c=new Map,d=w(256);const e=new Map,f=a=>Array.isArray(a)?a[0]:0>a?~a:a;for(var g of b){for(var h=0;h<g.length-1;h++)if(Array.isArray(g[h])){var k=g[h];e.set(k[0],k[1]);g[h]=k[0]}for(h=0;h<g.length-1;h++){k=g[h];const a=g[h+1];0>k||0>a||(c.set(a,k),d[a]=k)}}g=new Set;c=new Set;a=new Set(a);for(var l of this.locations)if(l.used&&a.has(l.tileset)){c.add(l.tileEffects);for(var n of l.allScreens())g.add(n)}for(var q of g)for(let a=
0,b=q.tiles.length;a<b;a++)q.tiles[a]=d[q.tiles[a]];for(var v of a){d=this.tilesets[v];for(var y of b)for(l=0;l<y.length-1;l++){n=f(y[l]);q=f(y[l+1]);for(a=0;4>a;a++)d.tiles[a][n]=d.tiles[a][q];d.attrs[n]=d.attrs[q];if(32>q&&d.alternates[q]!==q){if(32<=n)throw Error(`Cannot unflag: ${v} ${n} ${q} ${d.alternates[q]}`);d.alternates[n]=d.alternates[q]}}for(var A of e){const [a,b]=A;d.alternates[a]=b}}for(const a of c){v=this.tileEffects[a-179];for(const a of b)for(y=0;y<a.length-1;y++)A=f(a[y]),d=f(a[y+
1]),v.effects[A]=v.effects[d];for(const a of e.keys())v.effects[a]|=8}}moveFlag(a,b){function c(c){for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b),c[d]===~a&&(c[d]=~b)}for(const a of this.triggers)c(a.conditions),c(a.flags);for(const d of this.npcs){for(const a of d.spawnConditions.values())c(a);for(const c of[d.globalDialogs,...d.localDialogs.values()])for(const d of c)d.condition===a&&(d.condition=b),d.condition===~a&&(d.condition=~b)}if(512===(a&-256)&&512===(b&-256))for(const c of this.locations)for(const d of c.flags)d.flag===
a&&(d.flag=b)}nextFreeTrigger(a){for(const b of this.triggers)if(!b.used)return a&&this.allocatedTriggers.set(a,b.id),b;throw Error("Could not find an unused trigger.");}moveScreens(a,b){if(!this.compressedMapData)throw Error("Must compress maps first.");const c=new Map;for(var d=b<<8;this.screens[d];)d++;a=new Set(a);for(var e of a)for(var f of e)if(256<=f.sid)c.set(f.sid,f.sid);else{var g=f.sid;if(!c.has(g)){const b=d++;c.set(g,b);c.set(b,b);this.metascreens.renumber(g,b,a)}}if(d>>>8!==b)throw Error(`Out of space on page ${b}`);
d=new Set;for(const h of this.locations)if(a.has(h.meta.tileset)){e=!1;for(const a of h.screens)for(f=0;f<a.length;f++)g=c.get(a[f]),null!=g?(a[f]=g,e=!0):d.add(h.name);if(e&&d.size)throw Error(`Inconsistent move [${[...a].map(a=>a.name).join(", ")}] to plane ${b}: missed ${[...d].join(", ")}`);}}static load(a,b){return m.asyncExecutePromiseGeneratorFunction(function*(){const c=yield ct(b);a&&(yield a(c));return new at(c)})}static loadBytes(){return m.asyncExecutePromiseGeneratorFunction(function*(){return yield ct()})}}
at.OMIT_ITEM_GET_DATA_SUFFIX=os.bit(82624,0);at.OMIT_LOCAL_DIALOG_SUFFIX=os.bit(82624,1);at.COMPRESSED_MAPDATA=os.bit(82624,2);at.WRITE_MONSTER_NAMES=os.bit(82624,3);at.SHOP_COUNT=os.byte(82625);at.SCALING_LEVELS=os.byte(82626);at.UNIQUE_ITEM_TABLE=os.address(82640);at.SHOP_DATA_TABLES=os.address(82643);at.TELEPATHY_TABLES=os.address(82646);
function ct(a){a||(a=a=>document.body.appendChild(a));return new Promise(a=>{if("#reset"!==window.location.hash){const b=localStorage.getItem("rom");if(b)return a(Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))))}const b=document.createElement("input");document.body.appendChild(b);b.type="file";b.addEventListener("change",()=>{const c=b.files[0],e=new FileReader;e.addEventListener("loadend",()=>{const c=new Uint8Array(e.result),d=Array.from(c,x).join("");
localStorage.setItem("rom",d);b.remove();a(c)});e.readAsArrayBuffer(c)})})}
const bt=[[83272,86,80],[83306,0,255],[83343,56,48],[83480,96,112],[83494,168,160],[83507,21,22],[83511,21,22],[84305,168,160],[84307,152,144],[84505,120,112],[84715,9,255],[84809,128,136],[84871,32,48],[84890,1,2],[84894,1,2],[85433,8,128],[85750,104,96],[87133,255,0],[87145,120,112],[88070,152,160],[88074,152,160],[88078,88,80],[88093,0,255],[88142,219,255],[88181,120,112],[88911,120,128],[89007,240,128],[89014,223,128],[89015,150,128],[89315,223,207],[89326,110,109],[89330,110,109],[89486,223,
207],[89489,46,45],[89493,46,45],[89658,216,223],[89913,120,112],[89920,2,255],[89953,141,255],[89957,141,255],[91133,72,64],[91139,85,80],[91227,216,223],[91340,4,32],[91391,11,10],[91661,32,48],[91684,1,2],[91688,1,2],[93616,154,128],[93620,158,128],[93624,145,128],[93628,158,128],[93632,145,128],[93672,0,255],[93677,223,208],[93688,12,92],[93689,176,185],[93690,0,2],[93692,12,92],[93693,176,185],[93694,0,2],[93695,7,255],[93789,2,255],[93802,173,255],[93806,173,255],[94209,2,255],[94254,183,255],
[94258,183,255],[94379,3,255],[94383,2,255],[94387,5,255],[94391,6,255],[94395,0,255],[94404,178,255],[94408,178,255],[94412,177,255],[94416,177,255],[94420,179,255],[94424,179,255],[94428,181,255],[94432,181,255],[94436,181,255],[94440,181,255],[95470,128,136],[96193,136,128],[96197,152,160],[96199,88,80],[96298,16,1],[96343,16,1],[96596,128,120],[96674,128,120],[97162,0,64],[97168,0,64],[97230,0,64],[97236,0,64],[97294,0,64],[97300,0,64],[97358,0,64],[97364,0,64],[106242,64,128],[106243,51,50],
[106976,64,192],[106977,61,52],[118533,71,72],[119569,32,160],[119570,48,0],[118777,96,224],[182928,2,0],[193907,2,0],[195300,95,0]];class dt{constructor(a){this.rom=a;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(a,b){this.route.push(new et(this,a,b))}addSlot(a,b,c){this.slots[a&255]=new ft(this.rom,a&255,b,c&255)}addMaze(a,b,c){this.mazes.push({id:a,name:b,maze:c})}addTrade(a,b,c){this.trades.push({itemId:a,item:b,npc:c})}addUnidentifiedItem(a,b,c){this.unidentifiedItems.push({itemId:a,oldName:b,newName:c})}addWall(a,b,
c){this.walls.push({location:a,oldElement:b,newElement:c})}addWildWarp(a,b){this.wildWarps.push({id:a,name:b})}addHouse(a,b){this.houses.push({houseId:a,townId:b,house:this.rom.locations[a].name,town:this.rom.locations[b].name})}formatCondition(a){var b;return null===(b=this.rom.flags[a])||void 0===b?void 0:b.name}formatConditionList(a){const b=[];for(const c of a)a=this.rom.flags[c],(null===a||void 0===a?0:a.logic.track)&&b.push(a.name);return b.join(", ")}}
class et{constructor(a,b,c){this.spoiler=a;this.condition=b;this.deps=c}toString(){let a=0;256===(this.condition&-128)&&(a=512|this.spoiler.rom.slots[this.condition&255]);return`${this.spoiler.formatCondition(this.condition)}${a?` (${this.spoiler.formatCondition(a)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}}
class ft{constructor(a,b,c,d){this.slot=b;this.slotName=c;this.item=d;this.itemName=112<=d?"Mimic":a.items[a.itemGets[d].itemId].messageName;this.originalItem=112<=b?"Mimic":a.items[a.itemGets[b].itemId].messageName}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};const gt="object"===typeof __VERSION__?__VERSION__:{},ht=gt.STATUS||"unstable",it=gt.VERSION||"HEAD",jt=gt.LABEL||"HEAD",kt=gt.HASH||"HEAD",lt=gt.DATE||new Date;const mt=Symbol("asm");function nt(a){return a?/^[0-9a-f]{1,8}$/i.test(a)?Number.parseInt(a,16):cd(a):lq.newSeed()}
function ot(a,b){const c={_ALLOW_TELEPORT_OUT_OF_BOSS:a.hardcoreMode()&&a.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:a.audibleWallCues(b),_AUTO_EQUIP_BRACELET:a.autoEquipBracelet(b),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:a.buffDeosPendant(),_BUFF_DYNA:a.buffDyna(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:a.controllerShortcuts(b),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:a.disableShopGlitch(),_DISABLE_STATUE_GLITCH:a.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:a.disableSwordChargeGlitch(),
_DISABLE_TRIGGER_SKIP:a.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:a.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:!0,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:a.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:a.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:a.maxScalingInTower(),_MONEY_AT_START:a.shuffleHouses()||a.shuffleAreas(),_NERF_FLIGHT:!0,
_NERF_MADO:!0,_NEVER_DIE:a.neverDie(),_NORMALIZE_SHOP_PRICES:a.shuffleShops(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:a.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_REQUIRE_HEALED_DOLPHIN_TO_RIDE:a.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:a.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:a.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:a.teleportOnThunderSword(),
_TINK_MODE:!a.guaranteeMatchingSword(),_TRAINER:a.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:a.unidentifiedItems(),_ENEMY_HP:a.shouldUpdateHud(),_UPDATE_HUD:a.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:a.zebuStudentGivesItem()};return Object.keys(c).filter(a=>c[a]).map(a=>`.define ${a} ${c[a]}\n`).join("")}function pt(a,b){for(let c of b)Fc.applyPatch(c,a,!0)}
function qt(a,b,c,d,e,f,g){return m.asyncExecutePromiseGeneratorFunction(function*(){var h=16+(a[6]&4?512:0)+(a[4]<<14)+(a[5]<<13);a.length>h&&(a=a.slice(0,h));524288>a.length&&(h=new Uint8Array(a.length+262144),h.subarray(0,262160).set(a.subarray(0,262160)),h.subarray(524304).set(a.subarray(262160)),h[4]<<=1,a=h);fl(a.subarray(16));if("number"!==typeof b)throw Error("Bad seed");h=cd(b.toString(16).padStart(8,"0")+String(c.filterOptional()))>>>0;h=new lq(h);const k=e?e:[],l=[];for(let e=0;5>e;e++)try{return yield rt(a,
c,b,h,d,f,g,k)}catch(q){l.push(q),console.error(`Attempt ${e+1} failed: ${q.stack}`)}throw Error(`Shuffle failed: ${l.map(a=>a.stack).join("\n\n")}`);})}
function rt(a,b,c,d,e,f,g,h){return m.asyncExecutePromiseGeneratorFunction(function*(){function k(a){return m.asyncExecutePromiseGeneratorFunction(function*(){function b(a){return m.asyncExecutePromiseGeneratorFunction(function*(){return new Ta(yield e.read(a),a,{lineContinuations:!0})})}var c=ot(n,a);const d=new $a(xa.P02),f=new Zb;f.enter(ya.concat(new Ta(c,"flags.s"),yield b("../asm/init.s"),yield b("../asm/alloc.s"),yield b("../asm/cleanup.s"),yield b("../asm/stattracker.s"),yield b("../asm/preshuffle.s"),
yield b("../asm/postparse.s"),yield b("../asm/postshuffle.s")));c=new Pb(f,d);d.tokens(c);return d.module()})}var l=String(b);const n=b.filterRandom(d);var q=new at(a),v=String(n);q.flags.defrag();Dk(q);Ek(q);"object"==typeof window&&(window.rom=q);q.spoiler=new dt(q);f&&(f.spoiler=q.spoiler);v!==l&&(q.spoiler.flags=v);gl(q,n);Ej(q);Aq(q,Aq.generateOptions(n,d));q.scalingLevels=48;n.shuffleShops()&&st(q,n,d);n.shuffleGoaFloors()&&fq(q,d);tt(q);ut(q,n,d);Fk(q,d);n.nerfWildWarp()&&q.wildWarp.locations.fill(0);
n.randomizeWildWarp()&&vt(q,n,d);n.randomizeThunderTeleport()&&cm(q,d);dm(q,n,d);Jq(q,n,d);Yl(q,n,d);Fl(q,n,d);n.shuffleHouses()&&jq(q,n,d);n.shuffleAreas()&&aq(q,n,d);Nl(q);n.randomizeMaps()&&nq(q,n,d);Kq(q);rq(q,d);n.shuffleMimics()&&pq(q,n,d);n.shuffleMonsters()&&uq(q,n,d);v=new mh(q,n);v=new nf([v.getLocationList()]);if(!n.noShuffle())if(v=yield v.shuffle(n,d,void 0,g,q.spoiler)){for(var y of v){const [a,b]=y;q.slots[a&255]=b&255}q.slots.setCheckCount(v.size)}else return[a,-1];n.shuffleShops()&&
wt(q,n.bargainHunting()?d:void 0);n.buffMedicalHerb()&&(q.items.MedicalHerb.value=80,q.items.FruitOfPower.value=56);n.storyMode()&&xt(q);n.blackoutMode()&&yt(q);zt(q,n,d);Hl(q);Sl(q);ek(q);n.buffDyna()&&At(q,n);n.trainer()&&(q.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]);n.randomizeMusic("early")&&Bt(q,n,d);n.shuffleTilePalettes("early")&&(new zq(q,n,d)).shuffle();Ct(q,n);d.shuffle(q.randomNumbers.values);q.messages.compress();y=a.slice(16);q.modules.set(mt,yield k("early"));
q.writeData(y);q.modules.set(mt,yield k("late"));v=(null===h||void 0===h?void 0:h.some(a=>Fc.isCustom(a)))||!1;l=Dt(a,c,l,y,v);n.randomizeMusic("late")&&Bt(q,n,d);n.noMusic("late")&&Et(q);n.shuffleTilePalettes("late")&&(new zq(q,n,d)).shuffle();Tl(q);q.writeData();q=a.subarray(16);q.subarray(507904,524288).set(q.subarray(245760,262144));pt(a,h);return[a,l]})}
function zt(a){a.messages.parts[2][2].text="\n{01:Akahana} is handed a statue.#\nThanks for finding that.\nI was totally gonna sell\nit for tons of cash.#\nHere, have this lame\n[29:Gas Mask] or something.";a.messages.parts[0][14].text="It's dangerous to go alone! Take this.";a.messages.parts[0][14].fixText()}
function st(a,b,c){b={[yg.ARMOR]:{contents:[],shops:[]},[yg.TOOL]:{contents:[],shops:[]}};for(var d of a.shops)d.used&&255!==d.location&&(a=b[d.type])&&(a.contents.push(...d.contents.filter(a=>255!==a)),a.shops.push(d),d.contents=[]);for(const e of Object.values(b))for(d=null,a=[...e.contents],c.shuffle(a);a.length;){d&&d.length||(d&&a.shift(),d=[...e.shops,...e.shops,...e.shops,...e.shops],c.shuffle(d));const b=a[0],g=d[0];4>g.contents.length&&!g.contents.includes(b)&&(g.contents.push(b),a.shift());
d.shift()}for(const a of Object.values(b))for(const b of a.shops){for(;4>b.contents.length;)b.contents.push(255);b.contents.sort((a,b)=>a-b)}}function tt(a){for(const b of a.locations)if(b.used)for(const c of b.spawns)c.isWall()&&(a=c.id&15,c.id=a|a<<4,a=c.isShootingWall(b),c.data[2]=a?51:35)}
function ut(a,b,c){if(b.randomizeWalls()){b=[[5,56],[17],[106],[20]];var d=new da(()=>[]);for(var e of a.locations)d.get(e.data.area).push(e);for(const g of d.values()){e=c.nextInt(4);d=c.pick(b[e]);let h=!1;for(const b of g)for(const g of b.spawns)if(g.isWall()){var f=g.data[2]&32?g.id>>>4&3:g.id&3;if(2!==f)if(3===f){const d=c.nextInt(4);a.spoiler&&a.spoiler.addWall(b.name,f,d);g.data[2]|=32;g.id=48|d}else!h&&a.spoiler&&(a.spoiler.addWall(b.name,f,e),h=!0),g.data[2]|=32,g.id=f<<4|e,b.tilePalettes[2]=
d}}}}function Et(a){for(const b of[...a.locations,...a.bosses.musics])b.bgm=0}function Bt(a,b,c){b=new da(()=>[]);const d=new Set;for(var e of a.locations){if(95===e.id||0===e.id||!e.used)continue;const a=e.musicGroup;d.add(e.bgm);b.get(a).push(e)}for(const c of a.bosses.musics)b.set(c,[c]),d.add(c.bgm);a=[...d];e=new Set;for(const d of b.values()){b=c.pick(a);for(const a of d)a.bgm=b,e.add(a)}}
function vt(a,b,c){b=[];for(const c of a.locations)c&&c.used&&c.id&&!c.isShop()&&88!==(c.id&248)&&c!==a.locations.Crypt_Draygon2&&c!==a.locations.Crypt_Teleporter&&c!==a.locations.MesiaShrine&&c!==a.locations.LimeTreeLake&&b.push(c);c.shuffle(b);a.wildWarp.locations=[];for(const c of[...b.slice(0,15).sort((a,b)=>a.id-b.id)])a.wildWarp.locations.push(c.id),a.spoiler&&a.spoiler.addWildWarp(c.id,c.name);a.wildWarp.locations.push(0)}
function At(a){a.objects[184].collisionPlane=1;a.objects[184].immobile=!0;a.objects[185].collisionPlane=1;a.objects[185].immobile=!0;a.objects[51].collisionPlane=2;a.adHocSpawns[40].slotRangeLower=28;a.adHocSpawns[41].slotRangeUpper=28;a.adHocSpawns[42].slotRangeUpper=28}function yt(a){var b=jf();for(const c of b.nodes)b=c.type,"Location"!==c.nodeType||"cave"!==b&&"fortress"!==b||a.locations[c.id].tilePalettes.fill(154)}
const xt=a=>{const b=[a.flags.Kelbesque1.id,a.flags.Sabera1.id,a.flags.Mado1.id,a.flags.Kelbesque2.id,a.flags.Sabera2.id,a.flags.Mado2.id,a.flags.Karmine.id,a.flags.Draygon1.id,a.flags.SwordOfWind.id,a.flags.SwordOfFire.id,a.flags.SwordOfWater.id,a.flags.SwordOfThunder.id];a.npcs[203].spawnConditions.get(166).push(...b)};
function Dt(a,b,c,d,e){d=cd(d);const f=d.toString(16).padStart(8,"0").toUpperCase(),g="unstable"===ht?kt.substring(0,7).padStart(7,"0").toUpperCase()+"     ":it.substring(0,12).padEnd(12," ");b=b.toString(16).padStart(8,"0").toUpperCase();const h=(b,...c)=>{b+=16;for(const d of c)if("string"===typeof d)for(const c of d)a[b++]=c.charCodeAt(0);else if("number"===typeof d)a[b++]=d;else throw Error(`Bad value: ${d}`);},k=(a,b)=>{const c=[];for(let d=0;d<a.length||d<b.length;d++)c.push(a[d]||" "),c.push(b[d]||
" ");return c.join("")};h(161743,k("  VERSION     SEED      ",`  ${g}${b}`));let l;if(46<c.length){if(92<c.length)throw Error("Flag string way too long!");l=c.substring(46,92).padEnd(46," ");c=c.substring(0,46)}c=c.padEnd(46," ");h(161791,k(c.substring(0,23),c.substring(23)));l&&h(161839,k(l.substring(0,23),l.substring(23)));e&&h(161923,126);h(161925,k(f.substring(0,4),f.substring(4)));h(153366,"RANDOMIZER");"unstable"===ht&&h(153404,"BETA");return d}
function Ct(a,b){b.decreaseEnemyDamage()&&a.scaling.setPhpFormula(a=>16+6*a);a.scaling.setExpScalingFactor(b.expScalingFactor());b.disableShopGlitch()?a.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1E3]:a.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800];a.items.CarapaceShield.defense=a.items.TannedHide.defense=3;a.items.PlatinumShield.defense=a.items.BronzeArmor.defense=9;a.items.MirroredShield.defense=a.items.PlatinumArmor.defense=13;a.items.PsychoArmor.defense=
a.items.PsychoShield.defense=20;a.items.CeramicSuit.defense=a.items.BattleShield.defense=32;a.items.CarapaceShield.defense=a.items.TannedHide.defense=2;a.items.PlatinumShield.defense=a.items.BronzeArmor.defense=10;a.items.MirroredShield.defense=a.items.PlatinumArmor.defense=14;a.items.BattleArmor.defense=24}
const wt=(a,b)=>{for(const c of a.shops)if(c.type!==yg.PAWN)for(let a=0,e=c.prices.length;a<e;a++)c.prices[a]=128>c.contents[a]?b?b.nextNormal(1,.3,.5,1.5):1:c.type!==yg.INN?0:b?b.nextNormal(1,.5,.375,1.625):1;b=w(48,a=>a);a.shops.rescale=!0;a.shops.toolShopScaling=b.map(a=>Math.round(8*Math.pow(2,a/10)));a.shops.armorShopScaling=b.map(a=>Math.round(8*Math.pow(2,(47-a)/12)));for(b=13;39>b;b++)a.items[b].basePrice=Ft[b]},Ft={13:4,14:16,15:50,16:325,17:1E3,18:2E3,19:4E3,21:6,22:20,23:75,24:250,25:1E3,
26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300};Array.prototype.flatMap||Object.defineProperties(Array.prototype,{flatMap:{value(a){const b=[];let c=0;for(const d of this){let e=a(d,c++);"function"!==typeof e[Symbol.iterator]&&(e=[e]);e=[...e];e.length&&b.push(...e)}return b}}});class Gt{constructor(){this.completed=this.tasks=0}addTasks(a){this.tasks+=a}addCompleted(a){this.completed+=a}value(){return this.tasks&&this.completed/this.tasks}};function Ht(a){let b=!0;for(const d of gd.all()){const {name:e,flagString:f,description:g}=d;var c=document.createElement("h2");c.textContent=e;a.appendChild(c);c=document.createElement("p");c.innerHTML=g;a.appendChild(c);c=document.createElement("a");c.textContent=f;c.classList.add("button");c.classList.add("preset-flags");c.dataset.flags=f;48<f.length&&c.classList.add("small");b&&(c.dataset.defaultPreset="true");b=!1;a.appendChild(c)}}
function It(a){for(const c of Bd.all()){const {name:d,description:e,flags:f}=c;var b=document.createElement("h2");b.textContent=d;a.appendChild(b);e&&(b=document.createElement("p"),b.innerHTML=e,a.appendChild(b));b=document.createElement("div");b.classList.add("flag-list");a.appendChild(b);for(const a of f.values()){const {flag:c,opts:{hard:d,name:e,text:f}}=a,g=document.createElement("div");g.textContent=`${c}: ${e}`;g.classList.add("checkbox");d&&g.classList.add("hard");if(f){const a=document.createElement("div");
a.classList.add("flag-body");a.innerHTML=f;g.appendChild(a)}b.appendChild(g)}}}function Jt(a){return m.asyncExecutePromiseGeneratorFunction(function*(){var b=Hc.get("simea");for(const c of b.values())b=document.createElement("div"),Kt(b,yield c),a.appendChild(b)})}
function Kt(a,b){a.className="flex-row";a.style.width="100%";var c=document.createElement("input");c.type="radio";c.name="simea-replacement";c.id=`simea-replacement-${b.name}`;c.value=b.name;c.style.display="none";"Simea"==b.name&&(c.checked=!0);a.appendChild(c);c=document.createElement("label");c.className="sprite-replacement";c.htmlFor=`simea-replacement-${b.name}`;const d=document.createElement("img");d.width=112;d.height=98;d.style.float="left";vc(b.nssdata).then(a=>d.src=a);c.appendChild(d);
var e=document.createElement("div");e.textContent=b.name;e.className="title";c.appendChild(e);b.description&&(e=document.createElement("div"),e.innerHTML=b.description,e.className="desc",c.appendChild(e));a.appendChild(c)}
function Lt(a,b){for(const c of Bd.all()){const {name:d,description:e,flags:f}=c;{let c=!1;const h=document.createElement("h2");h.textContent=d;const k=e?document.createElement("p"):null;k&&(k.innerHTML=e);const l=document.createElement("div");l.classList.add("flag-list");for(const a of f.values()){const {flag:d,opts:{hard:e,name:f,text:g}}=a;if(!b.check(a))continue;c=!0;const h=document.createElement("div");h.textContent=`${d}: ${f}`;h.classList.add("checkbox");e&&h.classList.add("hard");if(g){const a=
document.createElement("div");a.classList.add("flag-body");a.innerHTML=g;h.appendChild(a)}l.appendChild(h)}c&&(a.appendChild(h),k&&a.appendChild(k),a.appendChild(l))}}};let Mt,Nt,Ot,Pt,Qt=!1;window.global=window;const Rt="boolean"===typeof CR_PERMALINK&&CR_PERMALINK;function St(a,...b){(window.ga||(()=>{}))("gtag_UA_131783670_1."+a,...b)}
const Zt=()=>{Tt();Ut();Vt(!1);Wt();window.addEventListener("popstate",()=>{Vt(!1)});document.body.addEventListener("click",Xt);Yt()},Yt=()=>{if("latest"!==kt){const a=Rt?"":"Current version: ";for(const b of document.getElementsByClassName("version"))b.textContent=`${a}${jt} (${lt.toDateString()})`}document.body.classList.add("js-works");document.body.classList.remove("js-broken");"rc"==ht?(document.body.classList.add("release-candidate"),document.body.classList.add("versioned")):"stable"==ht&&document.body.classList.add("versioned")},
au=()=>{const a=document.getElementById("seed"),b=()=>{Nt=a.value;$t()};a.addEventListener("keyup",b);a.addEventListener("change",b)},Vt=()=>{for(const a of location.hash.substring(1).split("&")){let [b,c]=a.split("=");c=decodeURIComponent(c);"flags"===b&&(Mt=new id(c));"seed"===b&&(Nt=decodeURIComponent(c));"race"===b&&document.body.classList.add("race");"debug"===b&&(Qt=!0);for(const a of document.querySelectorAll("[data-flags]"))a.addEventListener("click",()=>{Mt=new id(a.dataset.flags);"unstable"==
it&&Mt.set("Ds",!0);$t()})}};
function Xt(a){return m.asyncExecutePromiseGeneratorFunction(function*(){for(var b=a.target,c=`${jt}: ${Mt}`,d=(new Date).getTime();b;){if("H1"===b.tagName&&b.parentElement.classList.contains("expandable")){b.parentElement.classList.toggle("expanded");break}else if("preset-apply"===b.id){St("send","event","custom-preset");Mt=new id(document.getElementById("flagstring").value);$t();break}else if("new-seed"===b.id){St("send","event","Main","new-seed");Nt=Math.floor(4294967296*Math.random()).toString(16);
$t();break}else if("generate"===b.id){St("send","event","Main","generate",c);b=nt(Nt);const [a,f]=yield bu(b);St("send","timing","Main","generate",(new Date).getTime()-d,c);if(!a)break;c=Pt.replace(/\.nes|$/,["_",b.toString(16).padStart(8,0),"_",f.toString(16).padStart(8,0),".nes"].join(""));b=a;d=document.createElement("a");document.body.appendChild(d);d.style="display: none";b=new Blob([b],{type:"octet/stream"});b=window.URL.createObjectURL(b);d.href=b;d.download=c;d.click();window.URL.revokeObjectURL(b);
d.remove();break}else if("spoiler"===b.id){St("send","event","Main","spoiler",c);yield bu(nt(Nt));St("send","timing","Main","spoiler",(new Date).getTime()-d,c);break}b=b.parentElement}})}
const cu=(a,b,c)=>{const d=[];for(let e=0;e<c;e++)d.push(String.fromCharCode(a[b+2*e]));return d.join("")},bu=a=>m.asyncExecutePromiseGeneratorFunction(function*(){for(var b of document.getElementsByClassName("seed-out"))b.textContent=a.toString(16).padStart(8,"0");const c=document.getElementById("progress"),d=new Gt;b=Ot.slice();let e=!1;const f=new id(String(Mt));document.body.classList.add("shuffling");const g=Mt.check("Ds")?{}:void 0,h=()=>{e||(c.value=d.value(),setTimeout(h,120))};h();let k;
var l=document.querySelector('input[name="simea-replacement"]:checked').value;l=yield Hc.get("simea").get(l);try{[n,k]=yield qt(b,a,f,new kf,[l],g,d)}catch(q){document.body.classList.add("failure");var n=document.getElementById("error-text");n.textContent=q.stack;n.parentElement.parentElement.scrollIntoViewIfNeeded();document.getElementById("checksum").textContent="SHUFFLE FAILED!";throw q;}if(0>k)return document.getElementById("checksum").textContent=`SHUFFLE FAILED! ${k}`,[null,null];e=!0;document.body.classList.remove("shuffling");
g&&g.spoiler&&(b=g.spoiler,b.flags&&du("spoiler-flags",[b.flags]),du("spoiler-items",eu(b.slots.filter(a=>a),a=>a.item)),du("spoiler-route",b.route),du("spoiler-mazes",eu(b.mazes,a=>a.location).map(a=>{var {name:b,maze:c}=a;return`${b}:\n${c}`})),du("spoiler-trades",b.trades.map(a=>{var {item:b,npc:c}=a;return`${c}: ${b}`}).sort()),du("spoiler-item-names",b.unidentifiedItems.map(a=>{var {oldName:b,newName:c}=a;return`${c}: ${b}`}).sort()),du("spoiler-walls",eu(b.walls,a=>a.location).map(a=>{var {location:b,
oldElement:c,newElement:d}=a;return`${b}${3===c?" (iron)":""}: ${["wind","fire","water","thunder"][d]}`})),du("spoiler-wild-warps",b.wildWarps.map(a=>{({name:a}=a);return a})),du("spoiler-houses",b.houses.map(a=>{var {house:b,town:c}=a;return`${b}: ${c}`.replace(/\s*-\s*/g," ")})));document.getElementById("checksum").textContent=cu(n,161941,4)+cu(n,161942,4);return[n,k]});function eu(a,b){return[...a].sort((a,d)=>{a=b(a);d=b(d);return a<d?-1:a>d?1:0})}
const du=(a,b)=>{for(a=document.getElementById(a);a.children.length;)a.lastChild.remove();for(const c of b){const b=document.createElement("li");b.textContent=c;a.appendChild(b)}a.previousElementSibling.classList.toggle("empty-spoiler",!b.length)},fu=a=>{const b=a.getElementsByClassName("flag-body")[0];b&&b.remove();const [c,d]=a.textContent.split(/:\s*/),e=document.createElement("input");e.type="checkbox";e.id=`flag-${c}`;e.dataset.flag=c;e.dataset.mode="false";a.parentElement.insertBefore(e,a);
const f=document.createElement("label");f.textContent=c;f.htmlFor=e.id;a.parentElement.insertBefore(f,a);const g=document.createElement("div");a.parentElement.insertBefore(g,a);const h=document.createElement("label");h.textContent=d;h.htmlFor=e.id;g.appendChild(h);b&&g.appendChild(b);a.classList.contains("hard")&&(f.classList.add("hard"),h.classList.add("hard"),h.textContent+=" *");a.remove();e.addEventListener("change",()=>{window.FLAGS=Mt;const a=Mt.toggle(c);a?!0===a?(e.checked=!0,f.textContent=
c):(e.checked=!0,f.textContent=`${c[0]}${a}${c.substring(1)}`):(e.checked=!1,f.textContent=c);$t()})},$t=()=>{document.body.classList.remove("failure");for(var a of document.querySelectorAll("input[data-flag]")){var b=a.dataset.flag;const c=Mt.get(b);a.checked=!1!==c;a.nextElementSibling.textContent=`${b[0]}${"boolean"===typeof c?"":c}${b.substring(1)}`}a=String(Mt).replace(/ /g,"");document.getElementById("seed").value=Nt||"";b=["#flags=",a];Nt&&b.push("&seed=",encodeURIComponent(Nt));Qt&&b.push("&debug");
history.replaceState({flags:String(Mt),seed:Nt},"",String(window.location).replace(/#.*/,"")+b.join(""));if("stable"==ht||"rc"==ht)b=Nt||Math.floor(4294967296*Math.random()).toString(16),document.getElementById("race").href=`/${it}/race#flags=${a}&seed=${b}`;Wt()},Wt=()=>{const a=String(Mt);document.body.classList.toggle("spoiled",Mt.check("Ds"));document.body.classList.toggle("debug-mode",/D/.test(a));for(const b of document.getElementsByClassName("flagstring-out"))b.textContent=a},Tt=()=>{const a=
window.localStorage.getItem("name"),b=window.localStorage.getItem("rom"),c=document.getElementById("pick-file"),d=()=>{document.body.classList.add("rom-uploaded");document.body.classList.toggle("rom-broken",466849842!=cd(Ot))};a&&b&&(Pt=a,Ot=Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))),d());c.addEventListener("change",()=>{const a=c.files[0],b=new FileReader;b.addEventListener("loadend",()=>{var c=new Uint8Array(b.result);c=c.slice(0,16+(c[6]&4?512:0)+
(c[4]<<14)+(c[5]<<13));const e=Array.from(c,a=>a.toString(16).padStart(2,0)).join("");Ot=c;window.localStorage.setItem("rom",e);window.localStorage.setItem("name",a.name);d();Pt=a.name});b.readAsArrayBuffer(a)})},gu=()=>{const a=window.localStorage.getItem("simea-replacement");var b=window.localStorage.getItem("simea-replacement-custom")||"{}",c=JSON.parse(b);b=document.getElementById("simea-sprite-custom");b.innerHTML="";for(let d of Object.entries(c))[,c]=d,Hc.get("simea").set(c.name,Promise.resolve(c)),
Kt(b,c),c=document.getElementById(`simea-replacement-${c.name}`),c.addEventListener("change",a=>{window.localStorage.setItem("simea-replacement",a.target.value)}),c.value==a&&(c.checked=!0)},Ut=()=>{const a=window.localStorage.getItem("simea-replacement"),b=document.getElementsByName("simea-replacement");for(const c of b)c.value==a&&(c.checked=!0);b.forEach(a=>{a.addEventListener("change",a=>{window.localStorage.setItem("simea-replacement",a.target.value)})});gu();const c=document.getElementById("upload-sprite");
c.addEventListener("change",()=>{const a=c.files[0],b=new FileReader;b.addEventListener("loadend",()=>{var d=window.localStorage.getItem("simea-replacement-custom")||"{}";const e=JSON.parse(d);d=b.result;const h=a.name.replace(/\.[^/.]+$/,"").replaceAll(/_/g," ");Fc.init(h,"simea",Jc(a.name,d),`Loaded on ${(new Date).toLocaleString()}`).then(a=>{e[h]=a;window.localStorage.setItem("simea-replacement-custom",JSON.stringify(e));gu()});c.value=""});b.readAsText(a)})};
(()=>{Rt&&document.body.classList.add("permalink");if(null==document.getElementById("race")){Zt();Lt(document.getElementById("flags"),Mt);for(var a of[...document.getElementsByClassName("checkbox")])fu(a);for(var b of document.querySelectorAll('.flag-list > input[type="checkbox"]'))b.checked=!0,b.disabled=!0}else{Ht(document.getElementById("presets"));It(document.getElementById("select-options"));Jt(document.getElementById("simea-sprite-options")).then(()=>{Ut()});Tt();Vt(!0);Mt||document.querySelector("[data-default-preset]").click();
for(const a of[...document.getElementsByClassName("checkbox")])fu(a);$t();au();document.body.addEventListener("click",Xt);window.addEventListener("popstate",a=>{a.state?(Mt=new id(a.state.flags),Nt=a.state.seed):Vt(!0)});Qt&&(a=document.createElement("section"),a.classList.add("expandable"),b=document.createElement("h1"),b.textContent="Debug",a.appendChild(b),b=document.createElement("div"),b.id="debug",a.appendChild(b),document.querySelector("main").appendChild(a));Yt()}})();}).call(this);
