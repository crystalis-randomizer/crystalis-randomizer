import { Item } from '../rom/item.js';
import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    const { flags: { AkahanaStatueOfOnyxTradein, AsinaInBackRoom, BehindWhirlpool, KensuInSwan, MtSabreNorthSummit, MtSabreWestTornel, PortoaQueen: PortoaQueenItem, Rage, RepairedStatue, SlimedKensu, StomFightReward, ZebuAtWindmill, }, npcs: { AkahanaInBrynmaer, Aryllis, Fisherman, PortoaQueen, }, locations: { PortoaPalace_ThroneRoom, }, } = rom;
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    function tradeIn(npc) {
        const trade = tradeIns.get(npc.id);
        if (!trade)
            throw new Error(`No trade-in for ${npc.name}`);
        return rom.items[trade];
    }
    if (!ZebuAtWindmill.item.isMagic())
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(ZebuAtWindmill.item));
    const akahanaWant = tradeIn(AkahanaInBrynmaer);
    replaceMessage('02:01', 'an unusual statue', vague(akahanaWant));
    replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaWant)}`);
    replaceMessage('02:02', '[29:Gas Mask]', item(AkahanaStatueOfOnyxTradein));
    if (!StomFightReward.item.isMagic())
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(StomFightReward));
    const tornelWant = findTornelTradeIn(rom);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelWant));
    replaceMessage('05:0a', '[44:Teleport]', item(MtSabreWestTornel));
    const fogLampWant = tradeIn(Fisherman);
    replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampWant));
    replaceMessage('09:06', 'lamp', commonNoun(fogLampWant));
    const queenWant = PortoaQueen.dialog(PortoaPalace_ThroneRoom)[1].condition;
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(PortoaQueenItem));
    replaceMessage('0a:0d', '[02:Sword of Water]', item(queenWant));
    if (!AsinaInBackRoom.item.isMagic())
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(AsinaInBackRoom));
    if (!BehindWhirlpool.item.isMagic()) {
        unmagic('0b:01');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(BehindWhirlpool));
    replaceMessage('1d:12', '[46:Barrier]', item(BehindWhirlpool));
    let fogLampCaveLoot = findLoot(0x4f, 0x4e, 0x4d, 0x4c, 0x47, 0x46, 0x45, 0x44, 0x4b, 0x4a, 0x49, 0x48);
    if (fogLampCaveLoot) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageWant = rom.npcs.Rage.dialog()[0].condition;
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageWant));
    replaceMessage('0e:03', '[09:Ball of Water]', item(Rage));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisWant = tradeIn(Aryllis);
    replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisWant));
    replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisWant)}`);
    replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisWant));
    const aryllisClue = `Our illustrious chief seeks ${vague(aryllisWant)}.`;
    replaceMessage('12:09', /[^]*/, aryllisClue);
    replaceMessage('12:0a', /[^]*/, aryllisClue);
    const lovePendantWant = tradeIn(rom.npcs.KensuInSwan);
    replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantWant));
    replaceMessage('13:00', 'pendant', commonNoun(lovePendantWant));
    if (!KensuInSwan.item.isMagic()) {
        unmagic('13:02');
    }
    replaceMessage('13:02', '[47:Change]', item(KensuInSwan));
    const ivoryStatueWant = tradeIn(rom.npcs.SlimedKensu);
    replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueWant));
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    if (!SlimedKensu.item.isMagic())
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(SlimedKensu));
    if (!MtSabreNorthSummit.item.isMagic())
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(MtSabreNorthSummit));
    replaceMessage('20:06', 'Statue of Gold', item(RepairedStatue));
    {
        const msg = rom.messages.alloc();
        rom.trigger(0x86).message.mid = msg.mid;
        msg.text =
            '{:HERO:}, there\'s nothing to see here! Return to Zebu at once!';
        rom.messages.parts[0x1c][0x0f].text =
            '{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!';
    }
    function unmagic(mid) {
        replaceMessage(mid, /teach\s+you\s+the\s+magic\s+of/, 'bestow upon you the');
    }
    function item(item) {
        if (typeof item === 'number') {
            item = rom.items[rom.itemGets[item & 0xff].itemId];
        }
        else if (!(item instanceof Item))
            item = item.item;
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        const conditions = [
            (item) => BOWS.has(item),
            (item) => SWORD_OR_MAGIC.has(item),
            (item) => itemget(item).unique,
        ];
        for (const cond of conditions) {
            for (const id of locs) {
                const loc = rom.locations[id];
                const spawns = [...loc.spawns].reverse();
                for (const spawn of spawns) {
                    if (!spawn.isChest())
                        continue;
                    const item = rom.slots[spawn.id];
                    if (item <= 0x48 && cond(item)) {
                        return rom.items[item];
                    }
                }
            }
        }
        return undefined;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
const BOWS = new Set([0x3e, 0x3f, 0x40]);
const SWORD_OR_MAGIC = new Set([0x00, 0x01, 0x02, 0x03, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48]);
function findTornelTradeIn(rom) {
    const { Tornel } = rom.npcs;
    for (const ds of Tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1)) {
                return rom.items[item & 0xff];
            }
        }
    }
    return rom.items.TornadoBracelet;
}
function vague(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'an unusual statue';
        case items.FluteOfLime: return 'a rare instrument';
        case items.FogLamp: return 'a brilliant lamp';
        case items.LovePendant: return 'a beautiful charm';
        case items.KirisaPlant: return 'a fragrant plant';
        case items.IvoryStatue: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(item) {
    const items = item.rom.items;
    switch (item) {
        case items.StatueOfOnyx: return 'statue';
        case items.FluteOfLime: return 'instrument';
        case items.FogLamp: return 'lamp';
        case items.LovePendant: return 'pendant';
        case items.KirisaPlant: return 'plant';
        case items.IvoryStatue: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFHbEMsTUFBTSxVQUFVLFNBQVMsQ0FBQyxHQUFRO0lBQ2hDLE1BQU0sRUFDSixLQUFLLEVBQUUsRUFDTCwwQkFBMEIsRUFDMUIsZUFBZSxFQUNmLGVBQWUsRUFDZixXQUFXLEVBQ1gsa0JBQWtCLEVBQ2xCLGlCQUFpQixFQUNqQixXQUFXLEVBQUUsZUFBZSxFQUM1QixJQUFJLEVBQ0osY0FBYyxFQUNkLFdBQVcsRUFDWCxlQUFlLEVBQ2YsY0FBYyxHQUNmLEVBQ0QsSUFBSSxFQUFFLEVBQ0osaUJBQWlCLEVBQ2pCLE9BQU8sRUFDUCxTQUFTLEVBQ1QsV0FBVyxHQUNaLEVBQ0QsU0FBUyxFQUFFLEVBQ1QsdUJBQXVCLEdBQ3hCLEdBQ0YsR0FBRyxHQUFHLENBQUM7SUFHUixjQUFjLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUVqQyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEMsU0FBUyxPQUFPLENBQUMsR0FBUTtRQUN2QixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsS0FBSztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzNELE9BQU8sR0FBRyxDQUFD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UUFDN0MsS0FBSyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQU0sT0FBTyxNQUFNLENBQUM7UUFDdkMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxTQUFTLENBQUM7UUFDMUMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxPQUFPLENBQUM7UUFDeEMsS0FBSyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUUsT0FBTyxRQUFRLENBQUM7S0FDMUM7SUFDRCxJQUFJLEVBQUUsQ0FBQztJQUNQLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RmxhZ30gZnJvbSAnLi4vcm9tL2ZsYWdzLmpzJztcbmltcG9ydCB7SXRlbX0gZnJvbSAnLi4vcm9tL2l0ZW0uanMnO1xuaW1wb3J0IHtOcGN9IGZyb20gJy4uL3JvbS9ucGMuanMnO1xuaW1wb3J0IHtoZXh9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7YnVpbGRUcmFkZUluTWFwfSBmcm9tICcuL3NodWZmbGV0cmFkZXMuanMnO1xuaW1wb3J0IHtmYWlsfSBmcm9tICcuLi9hc3NlcnQuanMnO1xuXG4vKiogRmluZHMgcmVmZXJlbmNlcyB0byBnaXZlbiBpdGVtcyBhbmQgcmVwbGFjZXMgaXQgd2l0aCB0aGUgYWN0dWFsIGl0ZW1zLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpeERpYWxvZyhyb206IFJvbSkge1xuICBjb25zdCB7XG4gICAgZmxhZ3M6IHtcbiAgICAgIEFrYWhhbmFTdGF0dWVPZk9ueXhUcmFkZWluLFxuICAgICAgQXNpbmFJbkJhY2tSb29tLFxuICAgICAgQmVoaW5kV2hpcmxwb29sLFxuICAgICAgS2Vuc3VJblN3YW4sXG4gICAgICBNdFNhYnJlTm9ydGhTdW1taXQsXG4gICAgICBNdFNhYnJlV2VzdFRvcm5lbCxcbiAgICAgIFBvcnRvYVF1ZWVuOiBQb3J0b2FRdWVlbkl0ZW0sXG4gICAgICBSYWdlLFxuICAgICAgUmVwYWlyZWRTdGF0dWUsXG4gICAgICBTbGltZWRLZW5zdSxcbiAgICAgIFN0b21GaWdodFJld2FyZCxcbiAgICAgIFplYnVBdFdpbmRtaWxsLFxuICAgIH0sXG4gICAgbnBjczoge1xuICAgICAgQWthaGFuYUluQnJ5bm1hZXIsXG4gICAgICBBcnlsbGlzLFxuICAgICAgRmlzaGVybWFuLFxuICAgICAgUG9ydG9hUXVlZW4sXG4gICAgfSxcbiAgICBsb2NhdGlvbnM6IHtcbiAgICAgIFBvcnRvYVBhbGFjZV9UaHJvbmVSb29tLFxuICAgIH0sXG4gIH0gPSByb207XG5cbiAgLy8gU3RvbSdzIFwiSSdsbCwgYmUgd2FpdGluZy4uLlwiIGRpYWxvZyAtIHRoZSBjb21tYSBpcyBqdXN0IHdyb25nLlxuICByZXBsYWNlTWVzc2FnZSgnMDM6MDYnLCAnLCcsICcnKTtcblxuICBjb25zdCB0cmFkZUlucyA9IGJ1aWxkVHJhZGVJbk1hcChyb20pO1xuICBmdW5jdGlvbiB0cmFkZUluKG5wYzogTnBjKTogSXRlbSB7XG4gICAgY29uc3QgdHJhZGUgPSB0cmFkZUlucy5nZXQobnBjLmlkKTtcbiAgICBpZiAoIXRyYWRlKSB0aHJvdyBuZXcgRXJyb3IoYE5vIHRyYWRlLWluIGZvciAke25wYy5uYW1lfWApO1xuICAgIHJldHVybiByb20uaXRlbXNbdHJhZGVdO1xuICB9XG4gIC8vIE5PVEU6IHdlIG5lZWQgdG8gaGFyZGNvZGUgb3JpZ2luYWwgbmFtZXMgaW4gY2FzZSB0aGV5IHdlcmUgc2h1ZmZsZWQuXG5cbiAgaWYgKCFaZWJ1QXRXaW5kbWlsbC5pdGVtLmlzTWFnaWMoKSkgdW5tYWdpYygnMDA6MWInKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAwOjFiJywgJ1s0MTpSZWZyZXNoXScsIGl0ZW0oWmVidUF0V2luZG1pbGwuaXRlbSkpO1xuXG4gIGNvbnN0IGFrYWhhbmFXYW50ID0gdHJhZGVJbihBa2FoYW5hSW5CcnlubWFlcik7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMScsICdhbiB1bnVzdWFsIHN0YXR1ZScsIHZhZ3VlKGFrYWhhbmFXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdhIHN0YXR1ZScsIGB0aGUgJHtjb21tb25Ob3VuKGFrYWhhbmFXYW50KX1gKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAyOjAyJywgJ1syOTpHYXMgTWFza10nLCBpdGVtKEFrYWhhbmFTdGF0dWVPZk9ueXhUcmFkZWluKSk7XG5cbiAgaWYgKCFTdG9tRmlnaHRSZXdhcmQuaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzAzOjAxJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMzowMScsICdbNDM6VGVsZXBhdGh5XScsIGl0ZW0oU3RvbUZpZ2h0UmV3YXJkKSk7XG5cbiAgY29uc3QgdG9ybmVsV2FudCA9IGZpbmRUb3JuZWxUcmFkZUluKHJvbSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMzowMScsICdbMDY6VG9ybmFkbyBCcmFjZWxldF0nLCBpdGVtKHRvcm5lbFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA1OjBhJywgJ1swNjpUb3JuYWRvIEJyYWNlbGV0XScsIGl0ZW0odG9ybmVsV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDU6MGEnLCAnWzQ0OlRlbGVwb3J0XScsIGl0ZW0oTXRTYWJyZVdlc3RUb3JuZWwpKTtcblxuICBjb25zdCBmb2dMYW1wV2FudCA9IHRyYWRlSW4oRmlzaGVybWFuKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA5OjAxJywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBXYW50KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwOTowNCcsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMDk6MDUnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcFdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA2JywgJ2xhbXAnLCBjb21tb25Ob3VuKGZvZ0xhbXBXYW50KSk7XG5cbiAgY29uc3QgcXVlZW5XYW50ID0gUG9ydG9hUXVlZW4uZGlhbG9nKFBvcnRvYVBhbGFjZV9UaHJvbmVSb29tKVsxXS5jb25kaXRpb247XG4gIHJlcGxhY2VNZXNzYWdlKCcwYTowYycsICdbMjg6Rmx1dGUgb2YgTGltZV0nLCBpdGVtKFBvcnRvYVF1ZWVuSXRlbSkpO1xuICByZXBsYWNlTWVzc2FnZSgnMGE6MGQnLCAnWzAyOlN3b3JkIG9mIFdhdGVyXScsIGl0ZW0ocXVlZW5XYW50KSk7XG4gIC8vIFRPRE8gLSBjb25zaWRlciByZXBsYWNpbmcgMGE6MGQgYnV0IHdlIG5lZWQgdG8gYWxzbyByZXBsYWNlIGNvbmRpdGlvbj9cbiAgaWYgKCFBc2luYUluQmFja1Jvb20uaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzBiOjAxJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDU6UmVjb3Zlcl0nLCBpdGVtKEFzaW5hSW5CYWNrUm9vbSkpO1xuXG4gIGlmICghQmVoaW5kV2hpcmxwb29sLml0ZW0uaXNNYWdpYygpKSB7XG4gICAgdW5tYWdpYygnMGI6MDEnKTtcbiAgICB1bm1hZ2ljKCcxZDoxMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDY6QmFycmllcl0nLCBpdGVtKEJlaGluZFdoaXJscG9vbCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMWQ6MTInLCAnWzQ2OkJhcnJpZXJdJywgaXRlbShCZWhpbmRXaGlybHBvb2wpKTtcblxuICAvLyBMb29rIGZvciBhIGtleSBpdGVtIGluIHRoZSBmb2cgbGFtcC9raXJpc2EgcGxhbnQgY2F2ZXMuXG4gIC8vIE9yZGVyIGlzIGJhY2sgb2YgZm9nIGxhbXAsIGtpcmlzYSBiYWNrLXRvLWZyb250LCB0aGVuIGZyb250IG9mIGZvZyBsYW1wXG4gIGxldCBmb2dMYW1wQ2F2ZUxvb3QgPSBmaW5kTG9vdCgweDRmLCAweDRlLCAweDRkLCAweDRjLCAweDQ3LCAweDQ2LCAweDQ1LCAweDQ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMHg0YiwgMHg0YSwgMHg0OSwgMHg0OCk7XG4gIGlmIChmb2dMYW1wQ2F2ZUxvb3QpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGQ6MDAnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcENhdmVMb290KSk7XG4gIH0gZWxzZSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzBkOjAwJywgJ3RoYXQgYSBbMzU6Rm9nIExhbXBdIHdhcycsICd0aGVyZSB3YXMgdHJlYXN1cmUnKTtcbiAgfVxuXG4gIGNvbnN0IHJhZ2VXYW50ID0gcm9tLm5wY3MuUmFnZS5kaWFsb2coKVswXS5jb25kaXRpb247XG4gIHJlcGxhY2VNZXNzYWdlKCcwZTowMycsICdbMDI6U3dvcmQgb2YgV2F0ZXJdJywgaXRlbShyYWdlV2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMGU6MDMnLCAnWzA5OkJhbGwgb2YgV2F0ZXJdJywgaXRlbShSYWdlKSk7XG5cbiAgLy8gVE9ETyAtIG1lc3NhZ2UgMTA6MGMgaXMgb25seSBoYWxmLWNvcnJlY3QuICBJZiBpdGVtIG5hbWVzIGFyZSByYW5kb21pemVkXG4gIC8vIHRoZW4gZXZlbiB3aXRob3V0IGEgbG9jYXRpb24gdGhlIG1lc3NhZ2UgaXMgc3RpbGwgdXNlZnVsLiAgU28ganVzdCBkbyB0aGF0XG4gIC8vIGZvciBub3csIGFuZCB3ZSBjYW4gZmluZCBhIHdheSB0byBoaW50IGxhdGVyLlxuICByZXBsYWNlTWVzc2FnZSgnMTA6MGMnLCAndGhhdFxcJ3MnLCAnaXMnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEwOjBjJywgLywgaXMgaW4gdGhlXFwrbGlnaHRob3VzZS8sICcnKTtcblxuICBjb25zdCBhcnlsbGlzV2FudCA9IHRyYWRlSW4oQXJ5bGxpcyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjowNScsICdbM2M6S2lyaXNhIFBsYW50XScsIGl0ZW0oYXJ5bGxpc1dhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ3RoZSBwbGFudCcsIGB0aGUgJHtjb21tb25Ob3VuKGFyeWxsaXNXYW50KX1gKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ1szYzpLaXJpc2EgUGxhbnRdJywgaXRlbShhcnlsbGlzV2FudCkpO1xuICAvLyBUT0RPIC0gcmVmcyBpbiAxMjowOSBhbmQgMTI6MGEgaGF2ZSBsb2NhdGlvbiwgdG9vLlxuICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgLy8gcmVwbGFjZU1lc3NhZ2UoJzEyOjBhJywgL1xccypcXG4uKi8sICcuJyk7XG4gIGNvbnN0IGFyeWxsaXNDbHVlID0gYE91ciBpbGx1c3RyaW91cyBjaGllZiBzZWVrcyAke3ZhZ3VlKGFyeWxsaXNXYW50KX0uYDtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEyOjA5JywgL1teXSovLCBhcnlsbGlzQ2x1ZSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9bXl0qLywgYXJ5bGxpc0NsdWUpO1xuXG4gIGNvbnN0IGxvdmVQZW5kYW50V2FudCA9IHRyYWRlSW4ocm9tLm5wY3MuS2Vuc3VJblN3YW4pO1xuICByZXBsYWNlTWVzc2FnZSgnMTM6MDInLCAnWzNiOkxvdmUgUGVuZGFudF0nLCBpdGVtKGxvdmVQZW5kYW50V2FudCkpO1xuICByZXBsYWNlTWVzc2FnZSgnMTM6MDAnLCAncGVuZGFudCcsIGNvbW1vbk5vdW4obG92ZVBlbmRhbnRXYW50KSk7XG4gIGlmICghS2Vuc3VJblN3YW4uaXRlbS5pc01hZ2ljKCkpIHtcbiAgICB1bm1hZ2ljKCcxMzowMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICdbNDc6Q2hhbmdlXScsIGl0ZW0oS2Vuc3VJblN3YW4pKTtcblxuICBjb25zdCBpdm9yeVN0YXR1ZVdhbnQgPSB0cmFkZUluKHJvbS5ucGNzLlNsaW1lZEtlbnN1KTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVdhbnQpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgYEl0J3MgaW4gYSByb29tYCwgJ3swYjpLYXJtaW5lfSBpcycpO1xuICBpZiAoIVNsaW1lZEtlbnN1Lml0ZW0uaXNNYWdpYygpKSByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAndGVhY2gnLCAnZ2l2ZScpO1xuICByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAnWzQ4OkZsaWdodF0nLCBpdGVtKFNsaW1lZEtlbnN1KSk7XG5cbiAgaWYgKCFNdFNhYnJlTm9ydGhTdW1taXQuaXRlbS5pc01hZ2ljKCkpIHVubWFnaWMoJzFjOjEwJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxYzoxMCcsICdbNDI6UGFyYWx5c2lzXScsIGl0ZW0oTXRTYWJyZU5vcnRoU3VtbWl0KSk7XG5cbiAgLy8gVE9ETyAtIHNodWZmbGUgd2hpY2ggaXRlbSByZWNvbnN0cnVjdHMgd2hpY2ggb3RoZXI/XG4gIHJlcGxhY2VNZXNzYWdlKCcyMDowNicsICdTdGF0dWUgb2YgR29sZCcsIGl0ZW0oUmVwYWlyZWRTdGF0dWUpKTtcblxuICAvLyBUT0RPIC0gY29uc2lkZXIgd2FycGluZyBvbiBhIHJhbmRvbSBzd29yZD8gLSBtZXNzYWdlIDFjOjExXG5cbiAgLy8gU3BsaXQgdGhlIG1lc3NhZ2Ugb24gZWl0aGVyIHNpZGUgb2YgU2FicmUgTiBlbnRyYW5jZS5cbiAge1xuICAgIGNvbnN0IG1zZyA9IHJvbS5tZXNzYWdlcy5hbGxvYygpO1xuICAgIHJvbS50cmlnZ2VyKDB4ODYpLm1lc3NhZ2UubWlkID0gbXNnLm1pZDsgLy8gcmFiYml0XG4gICAgbXNnLnRleHQgPVxuICAgICAgICAnezpIRVJPOn0sIHRoZXJlXFwncyBub3RoaW5nIHRvIHNlZSBoZXJlISBSZXR1cm4gdG8gWmVidSBhdCBvbmNlISc7XG4gICAgLy8gcm9tLnRyaWdnZXIoMHhiYSkgLy8gdGVsZXBvcnRcbiAgICAvLyBUT0RPIC0gc2VlIGlmIGl0J3MgY2hhbmdlZD9cbiAgICByb20ubWVzc2FnZXMucGFydHNbMHgxY11bMHgwZl0udGV4dCA9XG4gICAgICAgICd7OkhFUk86fSwgeW91IGNhbm5vdCBjbGltYiB0aGlzIHlldCEgU2VlayBvdXQgWzQ0OlRlbGVwb3J0XSBhdCBvbmNlISc7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gdW5tYWdpYyhtaWQ6IHN0cmluZykge1xuICAgIHJlcGxhY2VNZXNzYWdlKG1pZCwgL3RlYWNoXFxzK3lvdVxccyt0aGVcXHMrbWFnaWNcXHMrb2YvLCAnYmVzdG93IHVwb24geW91IHRoZScpO1xuICB9XG4gIGZ1bmN0aW9uIGl0ZW0oaXRlbTogbnVtYmVyfEZsYWd8SXRlbSk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiBpdGVtID09PSAnbnVtYmVyJykge1xuICAgICAgaXRlbSA9IHJvbS5pdGVtc1tyb20uaXRlbUdldHNbaXRlbSAmIDB4ZmZdLml0ZW1JZF07XG4gICAgfSBlbHNlIGlmICghKGl0ZW0gaW5zdGFuY2VvZiBJdGVtKSkgaXRlbSA9IGl0ZW0uaXRlbSBhcyBJdGVtO1xuICAgIHJldHVybiBgWyR7aGV4KGl0ZW0uaWQpfToke2l0ZW0ubWVzc2FnZU5hbWV9XWA7XG4gIH1cbiAgZnVuY3Rpb24gcmVwbGFjZU1lc3NhZ2UobWlkOiBzdHJpbmcsIHBhdDogc3RyaW5nIHwgUmVnRXhwLCByZXBsOiBzdHJpbmcpIHtcbiAgICBjb25zdCBbcGFydCwgaW5kZXhdID0gbWlkLnNwbGl0KCc6JykubWFwKHggPT4gcGFyc2VJbnQoeCwgMTYpKTtcbiAgICBjb25zdCBtc2cgPSByb20ubWVzc2FnZXMucGFydHNbcGFydF1baW5kZXhdO1xuICAgIG1zZy50ZXh0ID0gbXNnLnRleHQucmVwbGFjZShwYXQsIHJlcGwpO1xuICB9XG4gIGZ1bmN0aW9uIGZpbmRMb290KC4uLmxvY3M6IG51bWJlcltdKTogSXRlbXx1bmRlZmluZWQge1xuICAgIGNvbnN0IGNvbmRpdGlvbnMgPSBbXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBCT1dTLmhhcyhpdGVtKSxcbiAgICAgIChpdGVtOiBudW1iZXIpID0+IFNXT1JEX09SX01BR0lDLmhhcyhpdGVtKSxcbiAgICAgIChpdGVtOiBudW1iZXIpID0+IGl0ZW1nZXQoaXRlbSkudW5pcXVlLFxuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IGNvbmQgb2YgY29uZGl0aW9ucykge1xuICAgICAgZm9yIChjb25zdCBpZCBvZiBsb2NzKSB7XG4gICAgICAgIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnNbaWRdO1xuICAgICAgICAvLyBOT1RFOiBGb2cgTGFtcCBDYXZlIDMgaGFzIHRoZSBzcGF3bnMgaW4gb3JkZXIsIHNvIHdlIG5lZWQgdG9cbiAgICAgICAgLy8gY2hlY2sgZm9yIHRoZSBzcGF3bnMgaW4gcmV2ZXJzZSBvcmRlciB0byBnbyBkZWVwZXItZmlyc3QuXG4gICAgICAgIGNvbnN0IHNwYXducyA9IFsuLi5sb2Muc3Bhd25zXS5yZXZlcnNlKCk7XG4gICAgICAgIGZvciAoY29uc3Qgc3Bhd24gb2Ygc3Bhd25zKSB7XG4gICAgICAgICAgaWYgKCFzcGF3bi5pc0NoZXN0KCkpIGNvbnRpbnVlO1xuICAgICAgICAgIGNvbnN0IGl0ZW0gPSByb20uc2xvdHNbc3Bhd24uaWRdO1xuICAgICAgICAgIGlmIChpdGVtIDw9IDB4NDggJiYgY29uZChpdGVtKSkge1xuICAgICAgICAgICAgcmV0dXJuIHJvbS5pdGVtc1tpdGVtXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBmdW5jdGlvbiBpdGVtZ2V0KGlkOiBudW1iZXIpOiBJdGVtIHtcbiAgICBjb25zdCBpdGVtZ2V0ID0gcm9tLml0ZW1HZXRzW2lkXTtcbiAgICByZXR1cm4gcm9tLml0ZW1zW2l0ZW1nZXQuaXRlbUlkXTtcbiAgfVxufVxuXG5jb25zdCBCT1dTID0gbmV3IFNldChbMHgzZSwgMHgzZiwgMHg0MF0pO1xuY29uc3QgU1dPUkRfT1JfTUFHSUMgPSBuZXcgU2V0KFsweDAwLCAweDAxLCAweDAyLCAweDAzLCAweDQxLCAweDQyLCAweDQzLCAweDQ0LCAweDQ1LCAweDQ2LCAweDQ3LCAweDQ4XSk7XG5cbmZ1bmN0aW9uIGZpbmRUb3JuZWxUcmFkZUluKHJvbTogUm9tKTogSXRlbSB7XG4gIC8vIEV4cGVjdGVkIHN0cnVjdHVyZTpcbiAgLy8gICAuLi5cbiAgLy8gICBOT1QgYnJhY2VsZXQgLT4gLi4uXG4gIC8vICAgTk9UIGJhbGwgLT4gLi4uXG4gIC8vICAgLT4gZ2l2ZSBpdGVtXG4gIGNvbnN0IHtUb3JuZWx9ID0gcm9tLm5wY3M7XG4gIGZvciAoY29uc3QgZHMgb2YgVG9ybmVsLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSB+ZHNbaV0uY29uZGl0aW9uO1xuICAgICAgLy8gTG9vayBmb3IgYW55IG5lZ2F0aXZlIGNvbmRpdGlvbiBvbiBhIGJyYWNlbGV0IChkb2Vzbid0IG1hdHRlciB3aGVyZSlcbiAgICAgIGlmIChpdGVtID4gMHgyMDQgJiYgaXRlbSA8PSAweDIwYyAmJiAhKGl0ZW0gJiAxKSkge1xuICAgICAgICByZXR1cm4gcm9tLml0ZW1zW2l0ZW0gJiAweGZmXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJvbS5pdGVtcy5Ub3JuYWRvQnJhY2VsZXQ7IC8vIGRlZmF1bHQgdG8gdG9ybmFkbyBicmFjZWxldFxufVxuXG5mdW5jdGlvbiB2YWd1ZShpdGVtOiBJdGVtKTogc3RyaW5nIHtcbiAgY29uc3QgaXRlbXMgPSBpdGVtLnJvbS5pdGVtcztcbiAgc3dpdGNoIChpdGVtKSB7XG4gICAgY2FzZSBpdGVtcy5TdGF0dWVPZk9ueXg6IHJldHVybiAnYW4gdW51c3VhbCBzdGF0dWUnO1xuICAgIGNhc2UgaXRlbXMuRmx1dGVPZkxpbWU6ICByZXR1cm4gJ2EgcmFyZSBpbnN0cnVtZW50JztcbiAgICBjYXNlIGl0ZW1zLkZvZ0xhbXA6ICAgICAgcmV0dXJuICdhIGJyaWxsaWFudCBsYW1wJztcbiAgICBjYXNlIGl0ZW1zLkxvdmVQZW5kYW50OiAgcmV0dXJuICdhIGJlYXV0aWZ1bCBjaGFybSc7XG4gICAgY2FzZSBpdGVtcy5LaXJpc2FQbGFudDogIHJldHVybiAnYSBmcmFncmFudCBwbGFudCc7XG4gICAgY2FzZSBpdGVtcy5Jdm9yeVN0YXR1ZTogIHJldHVybiAnYW4gZXhvdGljIHN0YXR1ZSc7XG4gICAgLy8gVE9ETyAtIHN0YXR1ZSBvZiBnb2xkXG4gIH1cbiAgZmFpbCgpO1xuICByZXR1cm4gJ2EgdmFsdWFibGUgaXRlbSc7XG59XG5cbmZ1bmN0aW9uIGNvbW1vbk5vdW4oaXRlbTogSXRlbSk6IHN0cmluZyB7XG4gIGNvbnN0IGl0ZW1zID0gaXRlbS5yb20uaXRlbXM7XG4gIHN3aXRjaCAoaXRlbSkge1xuICAgIGNhc2UgaXRlbXMuU3RhdHVlT2ZPbnl4OiByZXR1cm4gJ3N0YXR1ZSc7XG4gICAgY2FzZSBpdGVtcy5GbHV0ZU9mTGltZTogIHJldHVybiAnaW5zdHJ1bWVudCc7XG4gICAgY2FzZSBpdGVtcy5Gb2dMYW1wOiAgICAgIHJldHVybiAnbGFtcCc7XG4gICAgY2FzZSBpdGVtcy5Mb3ZlUGVuZGFudDogIHJldHVybiAncGVuZGFudCc7XG4gICAgY2FzZSBpdGVtcy5LaXJpc2FQbGFudDogIHJldHVybiAncGxhbnQnO1xuICAgIGNhc2UgaXRlbXMuSXZvcnlTdGF0dWU6ICByZXR1cm4gJ3N0YXR1ZSc7XG4gIH1cbiAgZmFpbCgpO1xuICByZXR1cm4gJ2l0ZW0nO1xufVxuXG4vLyBmdW5jdGlvbiByZXBsYWNlRGlhbG9nKG5wYzogTnBjLCBvcmlnOiBudW1iZXIgfCBSZWdFeHAsIHJlcGxhY2VtZW50SWQ6IG51bWJlcikge1xuLy8gICBjb25zdCByb20gPSBucGMucm9tO1xuLy8gICBjb25zdCBwYXQgPSBvcmlnIGluc3RhbmNlb2YgUmVnRXhwID8gb3JpZyA6IHBhdHRlcm4ocm9tLml0ZW1zW29yaWddKTtcbi8vICAgY29uc3QgcmVwbCA9IHJlcGxhY2VtZW50KHJvbS5pdGVtc1tyZXBsYWNlbWVudElkXSk7XG4vLyAgIGZvciAoY29uc3QgZHMgb2YgbnBjLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuLy8gICAgIGZvciAoY29uc3QgZCBvZiBkcykge1xuLy8gICAgICAgY29uc3QgbWlkID0gZC5tZXNzYWdlO1xuLy8gICAgICAgcmVwbGFjZU1lc3NhZ2Uocm9tLCBtaWQucGFydCwgbWlkLmluZGV4LCBwYXQsIHJlcGwpO1xuLy8gICAgIH1cbi8vICAgfVxuLy8gfVxuXG4vLyBjb25zdCBwYXR0ZXJuOiB7KGlkOiBudW1iZXIsIG5hbWU6IHN0cmluZyk6IFJlZ0V4cDtcbi8vICAgICAgICAgICAgICAgICAoaXRlbTogSXRlbSk6IFJlZ0V4cH0gPVxuLy8gICAgIChpdGVtOiBudW1iZXIgfCBJdGVtLCBuYW1lPzogc3RyaW5nKSA9PiB7XG4vLyAgICAgICBuYW1lID0gbmFtZSB8fCAoaXRlbSBhcyBJdGVtKS5tZXNzYWdlTmFtZTtcbi8vICAgICAgIGNvbnN0IGlkID0gaGV4KGl0ZW0gaW5zdGFuY2VvZiBJdGVtID8gaXRlbS5pZCA6IGl0ZW0pO1xuLy8gICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoYFxcXFxbJHtpZH06W15cXFxcXV0qXFxcXF18JHtuYW1lLnJlcGxhY2UoL1xccysvZywgJ1xcXFxzKycpfWAsXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAnZycpO1xuLy8gICAgIH07XG5cbi8vIGZ1bmN0aW9uIHJlcGxhY2VtZW50KGl0ZW06IEl0ZW0pOiBzdHJpbmcge1xuLy8gICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuLy8gfVxuIl19