import { DefaultMap } from '../util.js';
import { Constraint } from './constraint.js';
export class Graphics {
    constructor(rom) {
        this.rom = rom;
        this.monsterConstraints = new Map();
        this.npcConstraints = new Map();
        this.allSpritePalettes = new Set();
        const allSpawns = new DefaultMap(() => []);
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (let i = 0; i < l.spawns.length; i++) {
                const s = l.spawns[i];
                if (!s.used)
                    continue;
                if (s.isMonster()) {
                    allSpawns.get(s.monsterId).push([l, i, s]);
                }
                else if (s.isNpc() || s.isBoss()) {
                    allSpawns.get(~s.id).push([l, i, s]);
                }
            }
        }
        for (const [m, spawns] of allSpawns) {
            if (m < 0) {
                const npc = rom.npcs[~m];
                const metaspriteIds = [npc.data[3]];
                const metasprite = rom.metasprites[metaspriteIds[0]];
                if (!metasprite)
                    throw new Error(`bad NPC: ${~m}`);
                if (npc.data[2] === 0xd0)
                    metaspriteIds.push(0xc0);
                const offset = npc.data[2] < 0x80 ? npc.data[2] & 0x70 : 0;
                let constraint = this.computeConstraint(metaspriteIds, spawns, true, offset);
                if (~m === 0x5f)
                    constraint = constraint.ignorePalette();
                this.npcConstraints.set(~m, constraint);
            }
            else {
                let constraint = Constraint.ALL;
                const parent = this.rom.objects[m];
                for (const obj of allObjects(rom, parent)) {
                    const action = rom.objectActions[obj.action];
                    const metaspriteFn = (action === null || action === void 0 ? void 0 : action.data.metasprites) || (() => [obj.metasprite]);
                    const child = this.computeConstraint(metaspriteFn(obj), spawns, obj.id === m, obj.data[1]);
                    const meet = constraint.meet(child);
                    if (!meet)
                        throw new Error(`Bad meet for ${m} with ${obj.id}`);
                    if (meet)
                        constraint = meet;
                    if (obj.data[4] & 0x02) {
                        const child2 = this.computeConstraint([obj.data[0x14]], spawns, false, obj.data[1]);
                        const meet2 = constraint.meet(child2);
                        if (!meet2)
                            throw new Error(`Bad meet for ${m} bonus ${obj.id}`);
                        constraint = meet2;
                    }
                }
                this.monsterConstraints.set(parent.id, constraint);
                parent.constraint = constraint;
            }
        }
    }
    getMonsterConstraint(locationId, monsterId) {
        const c = this.monsterConstraints.get(monsterId) || Constraint.NONE;
        if ((locationId & 0x58) === 0x58)
            return c;
        const m = this.rom.objects[monsterId].goldDrop;
        if (!m)
            return c;
        return c.meet(Constraint.COIN) || Constraint.NONE;
    }
    getNpcConstraint(locationId, npcId) {
        const c = this.npcConstraints.get(npcId) || Constraint.NONE;
        if (locationId === 0x1e && npcId === 0x60) {
            return c.meet(Constraint.STOM_FIGHT);
        }
        else if (locationId === 0xa0 && npcId === 0xc9) {
            return c.meet(Constraint.GUARDIAN_STATUE);
        }
        return c;
    }
    shufflePalettes(random) {
        const pal = [...this.allSpritePalettes];
        for (const [k, c] of this.monsterConstraints) {
            this.monsterConstraints.set(k, c.shufflePalette(random, pal));
        }
        for (const [k, c] of this.npcConstraints) {
            this.npcConstraints.set(k, c.shufflePalette(random, pal));
        }
    }
    configure(location, spawn) {
        if (!spawn.used)
            return;
        const itemId = this.rom.slots[spawn.id];
        const c = spawn.isMonster() ? this.monsterConstraints.get(spawn.monsterId) :
            spawn.isNpc() ? this.npcConstraints.get(spawn.id) :
                spawn.isChest() ? (itemId < 0x70 ? Constraint.TREASURE_CHEST :
                    Constraint.MIMIC) :
                    undefined;
        if (!c)
            return;
        if (c.shift === 3 || c.float.length >= 2) {
            throw new Error(`don't know what to do with two floats`);
        }
        else if (!c.float.length) {
            spawn.patternBank = Number(c.shift === 2);
        }
        else if (c.float[0].has(location.spritePatterns[0])) {
            spawn.patternBank = 0;
        }
        else if (c.float[0].has(location.spritePatterns[1])) {
            spawn.patternBank = 1;
        }
        else if (spawn.isMonster()) {
            throw new Error(`no matching pattern bank`);
        }
    }
    computeConstraint(metaspriteIds, spawns, shiftable, offset = 0) {
        const patterns = new Set();
        const palettes = new Set();
        for (const metasprite of metaspriteIds.map(s => this.rom.metasprites[s])) {
            for (const p of metasprite.palettes()) {
                palettes.add(p);
            }
            for (const p of metasprite.patternBanks(offset)) {
                patterns.add(p);
            }
        }
        shiftable = shiftable && patterns.size == 1 && [...patterns][0] === 2;
        const locs = new Map();
        for (const [l, , spawn] of spawns) {
            locs.set(spawn.patternBank && shiftable ? ~l.id : l.id, spawn);
        }
        let child = undefined;
        for (let [l, spawn] of locs) {
            const loc = this.rom.locations[l < 0 ? ~l : l];
            for (const pal of palettes) {
                if (pal > 1)
                    this.allSpritePalettes.add(loc.spritePalettes[pal - 2]);
            }
            const c = Constraint.fromSpawn(palettes, patterns, loc, spawn, shiftable);
            child = child ? child.join(c) : c;
            if (!shiftable && spawn.patternBank)
                child = child.shifted();
        }
        if (!child)
            throw new Error(`Expected child to appear`);
        return child;
    }
}
function* allObjects(rom, parent) {
    yield parent;
    const repl = parent.spawnedReplacement();
    if (repl)
        yield* allObjects(rom, repl);
    const child = parent.spawnedChild();
    if (child)
        yield* allObjects(rom, child);
    if (parent.id === 0x50)
        yield rom.objects.largeBlueSlime;
    if (parent.id === 0x53)
        yield rom.objects.largeRedSlime;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL2dyYXBoaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBUzdDLE1BQU0sT0FBTyxRQUFRO0lBT25CLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTHJCLHVCQUFrQixHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ25ELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFFdkQsc0JBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUtwQyxNQUFNLFNBQVMsR0FDWCxJQUFJLFVBQVUsQ0FDVixHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVsQixLQUFLLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDN0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJO2dCQUFFLFNBQVM7WUFDdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUk7b0JBQUUsU0FBUztnQkFDdEIsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7b0JBQ2pCLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDNUM7cUJBQU0sSUFBSSxDQUFDLENBQUMsS0FB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ekMsSUFBSSxJQUFJO1FBQUUsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEMsSUFBSSxLQUFLO1FBQUUsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQU16QyxJQUFJLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSTtRQUFFLE1BQU0sR0FBRyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7SUFDekQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLElBQUk7UUFBRSxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO0FBQzFELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb20gfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHsgRGVmYXVsdE1hcCB9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHsgTG9jYXRpb24sIFNwYXduIH0gZnJvbSAnLi9sb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBDb25zdHJhaW50IH0gZnJvbSAnLi9jb25zdHJhaW50LmpzJztcbmltcG9ydCB7IFJhbmRvbSB9IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQgeyBPYmplY3REYXRhIH0gZnJvbSAnLi9vYmplY3RkYXRhLmpzJztcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4vLyBUaGlzIGFjdHVhbGx5IGFwcGVhcnMgdG8gYmUgbW9yZSBvZiBhIEdyYXBoaWNzQ29uc3RyYWludHMgY2xhc3M/XG4vLyAgIC0gbWF5YmUgZG9uJ3Qgc3RvcmUgdGhlIGNvbnN0cmFpbnRzIG9uIE1vbnN0ZXI/XG5cbmV4cG9ydCBjbGFzcyBHcmFwaGljcyB7XG5cbiAgcHJpdmF0ZSBtb25zdGVyQ29uc3RyYWludHMgPSBuZXcgTWFwPG51bWJlciwgQ29uc3RyYWludD4oKTtcbiAgcHJpdmF0ZSBucGNDb25zdHJhaW50cyA9IG5ldyBNYXA8bnVtYmVyLCBDb25zdHJhaW50PigpO1xuXG4gIGFsbFNwcml0ZVBhbGV0dGVzID0gbmV3IFNldDxudW1iZXI+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICAvLyBJdGVyYXRlIG92ZXIgbG9jYXRpb25zL3NwYXducyB0byBidWlsZCBtdWx0aW1hcCBvZiB3aGVyZSBtb25zdGVycyBhcHBlYXIuXG4gICAgLy8gUG9zdGl2ZSBrZXlzIGFyZSBtb25zdGVycywgbmVnYXRpdmUga2V5cyBhcmUgTlBDcy5cbiAgICBjb25zdCBhbGxTcGF3bnMgPVxuICAgICAgICBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIEFycmF5PHJlYWRvbmx5IFtMb2NhdGlvbiwgbnVtYmVyLCBTcGF3bl0+PihcbiAgICAgICAgICAgICgpID0+IFtdKTtcblxuICAgIGZvciAoY29uc3QgbCBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgICBpZiAoIWwudXNlZCkgY29udGludWU7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwuc3Bhd25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHMgPSBsLnNwYXduc1tpXTtcbiAgICAgICAgaWYgKCFzLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgICBpZiAocy5pc01vbnN0ZXIoKSkge1xuICAgICAgICAgIGFsbFNwYXducy5nZXQocy5tb25zdGVySWQpLnB1c2goW2wsIGksIHNdKTtcbiAgICAgICAgfSBlbHNlIGlmIChzLmlzTnBjKCkgfHwgcy5pc0Jvc3MoKSkge1xuICAgICAgICAgIGFsbFNwYXducy5nZXQofnMuaWQpLnB1c2goW2wsIGksIHNdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyBGb3IgZWFjaCBtb25zdGVyLCBkZXRlcm1pbmUgd2hpY2ggcGF0dGVybnMgYW5kIHBhbGV0dGVzIGFyZSB1c2VkLlxuICAgIGZvciAoY29uc3QgW20sIHNwYXduc10gb2YgYWxsU3Bhd25zKSB7XG4gICAgICAvLyBUT0RPIC0gZm9sZCBpbnRvIHBhdGNoLnNodWZmbGVNb25zdGVyc1xuICAgICAgLy9pZiAobSA9PT0gMCkgY29udGludWU7IC8vIHVzZWQgdG8gc3VwcHJlc3MgYnVnZ3kgc3RyYXkgc3Bhd25zXG4gICAgICBpZiAobSA8IDApIHsgLy8gTlBDXG4gICAgICAgIGNvbnN0IG5wYyA9IHJvbS5ucGNzW35tXTtcbiAgICAgICAgY29uc3QgbWV0YXNwcml0ZUlkcyA9IFtucGMuZGF0YVszXV07XG4gICAgICAgIGNvbnN0IG1ldGFzcHJpdGUgPSByb20ubWV0YXNwcml0ZXNbbWV0YXNwcml0ZUlkc1swXV07XG4gICAgICAgIGlmICghbWV0YXNwcml0ZSkgdGhyb3cgbmV3IEVycm9yKGBiYWQgTlBDOiAke35tfWApO1xuICAgICAgICAvLyBIYXJkY29kZSBleGNlcHRpb24gZm9yIGp1bXBpbmcgbWFuIChhY3Rpb24gc2NyaXB0ICQ1MClcbiAgICAgICAgaWYgKG5wYy5kYXRhWzJdID09PSAweGQwKSBtZXRhc3ByaXRlSWRzLnB1c2goMHhjMCk7XG4gICAgICAgIC8vIENvbXB1dGUgY29uc3RyYWludFxuICAgICAgICBjb25zdCBvZmZzZXQgPSBucGMuZGF0YVsyXSA8IDB4ODAgPyBucGMuZGF0YVsyXSAmIDB4NzAgOiAwO1xuICAgICAgICBsZXQgY29uc3RyYWludCA9XG4gICAgICAgICAgICB0aGlzLmNvbXB1dGVDb25zdHJhaW50KG1ldGFzcHJpdGVJZHMsIHNwYXducywgdHJ1ZSwgb2Zmc2V0KTtcbiAgICAgICAgLy8gVE9ETyAtIGJldHRlciB3YXkgc3RyZWFtbGluZSB0aGlzLi4uPyAodG9ybmVsIG9uIHNhYnJlKVxuICAgICAgICBpZiAofm0gPT09IDB4NWYpIGNvbnN0cmFpbnQgPSBjb25zdHJhaW50Lmlnbm9yZVBhbGV0dGUoKTtcbiAgICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQofm0sIGNvbnN0cmFpbnQpO1xuICAgICAgfSBlbHNlIHsgLy8gbW9uc3RlclxuICAgICAgICBsZXQgY29uc3RyYWludCA9IENvbnN0cmFpbnQuQUxMO1xuICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLnJvbS5vYmplY3RzW21dO1xuICAgICAgICBmb3IgKGNvbnN0IG9iaiBvZiBhbGxPYmplY3RzKHJvbSwgcGFyZW50KSkge1xuICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IHJvbS5vYmplY3RBY3Rpb25zW29iai5hY3Rpb25dO1xuICAgICAgICAgIGNvbnN0IG1ldGFzcHJpdGVGbjogKG06IE9iamVjdERhdGEpID0+IHJlYWRvbmx5IG51bWJlcltdID1cbiAgICAgICAgICAgICAgYWN0aW9uPy5kYXRhLm1ldGFzcHJpdGVzIHx8ICgoKSA9PiBbb2JqLm1ldGFzcHJpdGVdKTtcbiAgICAgICAgICBjb25zdCBjaGlsZCA9IHRoaXMuY29tcHV0ZUNvbnN0cmFpbnQobWV0YXNwcml0ZUZuKG9iaiksIHNwYXducyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmlkID09PSBtLCBvYmouZGF0YVsxXSk7XG4gICAgICAgICAgY29uc3QgbWVldCA9IGNvbnN0cmFpbnQubWVldChjaGlsZCk7XG4gICAgICAgICAgaWYgKCFtZWV0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZWV0IGZvciAke219IHdpdGggJHtvYmouaWR9YCk7XG4gICAgICAgICAgaWYgKG1lZXQpIGNvbnN0cmFpbnQgPSBtZWV0O1xuICAgICAgICAgIC8vIE5PVEU6IGlmICQzODAseCAmICMkMDIgdGhlbiB3ZSBkcmF3IGEgYm9udXMgc3ByaXRlIChlLmcuXG4gICAgICAgICAgLy8gbW9zcXVpdG8gd2luZ3MpIGZyb20gJDU4MCx4IHdpdGggbm8gc2hpZnQuXG4gICAgICAgICAgaWYgKG9iai5kYXRhWzRdICYgMHgwMikge1xuICAgICAgICAgICAgY29uc3QgY2hpbGQyID0gdGhpcy5jb21wdXRlQ29uc3RyYWludChbb2JqLmRhdGFbMHgxNF1dLCBzcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLCBvYmouZGF0YVsxXSk7XG4gICAgICAgICAgICBjb25zdCBtZWV0MiA9IGNvbnN0cmFpbnQubWVldChjaGlsZDIpO1xuICAgICAgICAgICAgaWYgKCFtZWV0MikgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVldCBmb3IgJHttfSBib251cyAke29iai5pZH1gKTtcbiAgICAgICAgICAgIGNvbnN0cmFpbnQgPSBtZWV0MjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KHBhcmVudC5pZCwgY29uc3RyYWludCk7XG4gICAgICAgIHBhcmVudC5jb25zdHJhaW50ID0gY29uc3RyYWludDsgIC8vIGZvciBkZWJ1Z2dpbmdcbiAgICAgIH1cbiAgICB9ICAgIFxuICB9XG5cbiAgZ2V0TW9uc3RlckNvbnN0cmFpbnQobG9jYXRpb25JZDogbnVtYmVyLCBtb25zdGVySWQ6IG51bWJlcik6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IGMgPSB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5nZXQobW9uc3RlcklkKSB8fCBDb25zdHJhaW50Lk5PTkU7XG4gICAgaWYgKChsb2NhdGlvbklkICYgMHg1OCkgPT09IDB4NTgpIHJldHVybiBjO1xuICAgIGNvbnN0IG0gPSB0aGlzLnJvbS5vYmplY3RzW21vbnN0ZXJJZF0uZ29sZERyb3A7XG4gICAgaWYgKCFtKSByZXR1cm4gYztcbiAgICByZXR1cm4gYy5tZWV0KENvbnN0cmFpbnQuQ09JTikgfHwgQ29uc3RyYWludC5OT05FO1xuICB9XG5cbiAgZ2V0TnBjQ29uc3RyYWludChsb2NhdGlvbklkOiBudW1iZXIsIG5wY0lkOiBudW1iZXIpOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBjID0gdGhpcy5ucGNDb25zdHJhaW50cy5nZXQobnBjSWQpIHx8IENvbnN0cmFpbnQuTk9ORTtcbiAgICBpZiAobG9jYXRpb25JZCA9PT0gMHgxZSAmJiBucGNJZCA9PT0gMHg2MCkge1xuICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gYWN0dWFsbHkgbG9vayBhdCB0aGUgbG9jYXRpb24ncyB0cmlnZ2Vycz9cbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5TVE9NX0ZJR0hUKTtcbiAgICB9IGVsc2UgaWYgKGxvY2F0aW9uSWQgPT09IDB4YTAgJiYgbnBjSWQgPT09IDB4YzkpIHtcbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5HVUFSRElBTl9TVEFUVUUpO1xuICAgIH1cbiAgICByZXR1cm4gYztcbiAgfVxuXG4gIHNodWZmbGVQYWxldHRlcyhyYW5kb206IFJhbmRvbSk6IHZvaWQge1xuICAgIGNvbnN0IHBhbCA9IFsuLi50aGlzLmFsbFNwcml0ZVBhbGV0dGVzXTtcbiAgICBmb3IgKGNvbnN0IFtrLCBjXSBvZiB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KGssIGMuc2h1ZmZsZVBhbGV0dGUocmFuZG9tLCBwYWwpKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbaywgY10gb2YgdGhpcy5ucGNDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQoaywgYy5zaHVmZmxlUGFsZXR0ZShyYW5kb20sIHBhbCkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbmZpZ3VyZShsb2NhdGlvbjogTG9jYXRpb24sIHNwYXduOiBTcGF3bikge1xuICAgIGlmICghc3Bhd24udXNlZCkgcmV0dXJuO1xuICAgIGNvbnN0IGl0ZW1JZCA9IHRoaXMucm9tLnNsb3RzW3NwYXduLmlkXTtcbiAgICBjb25zdCBjID0gc3Bhd24uaXNNb25zdGVyKCkgPyB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5nZXQoc3Bhd24ubW9uc3RlcklkKSA6XG4gICAgICAgIHNwYXduLmlzTnBjKCkgPyB0aGlzLm5wY0NvbnN0cmFpbnRzLmdldChzcGF3bi5pZCkgOlxuICAgICAgICBzcGF3bi5pc0NoZXN0KCkgPyAoaXRlbUlkIDwgMHg3MCA/IENvbnN0cmFpbnQuVFJFQVNVUkVfQ0hFU1QgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uc3RyYWludC5NSU1JQykgOlxuICAgICAgICB1bmRlZmluZWQ7XG4gICAgaWYgKCFjKSByZXR1cm47XG4gICAgaWYgKGMuc2hpZnQgPT09IDMgfHwgYy5mbG9hdC5sZW5ndGggPj0gMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBkb24ndCBrbm93IHdoYXQgdG8gZG8gd2l0aCB0d28gZmxvYXRzYCk7XG4gICAgfSBlbHNlIGlmICghYy5mbG9hdC5sZW5ndGgpIHtcbiAgICAgIHNwYXduLnBhdHRlcm5CYW5rID0gTnVtYmVyKGMuc2hpZnQgPT09IDIpO1xuICAgIH0gZWxzZSBpZiAoYy5mbG9hdFswXS5oYXMobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMF0pKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IDA7XG4gICAgfSBlbHNlIGlmIChjLmZsb2F0WzBdLmhhcyhsb2NhdGlvbi5zcHJpdGVQYXR0ZXJuc1sxXSkpIHtcbiAgICAgIHNwYXduLnBhdHRlcm5CYW5rID0gMTtcbiAgICB9IGVsc2UgaWYgKHNwYXduLmlzTW9uc3RlcigpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vIG1hdGNoaW5nIHBhdHRlcm4gYmFua2ApO1xuICAgIH1cbiAgfVxuXG4gIGNvbXB1dGVDb25zdHJhaW50KG1ldGFzcHJpdGVJZHM6IHJlYWRvbmx5IG51bWJlcltdLFxuICAgICAgICAgICAgICAgICAgICBzcGF3bnM6IFNwYXducyxcbiAgICAgICAgICAgICAgICAgICAgc2hpZnRhYmxlOiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSAwKTogQ29uc3RyYWludCB7XG4gICAgY29uc3QgcGF0dGVybnMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCBwYWxldHRlcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAoY29uc3QgbWV0YXNwcml0ZSBvZiBtZXRhc3ByaXRlSWRzLm1hcChzID0+IHRoaXMucm9tLm1ldGFzcHJpdGVzW3NdKSkge1xuICAgICAgLy8gV2hpY2ggcGFsZXR0ZSBhbmQgcGF0dGVybiBiYW5rcyBhcmUgcmVmZXJlbmNlZD9cbiAgICAgIGZvciAoY29uc3QgcCBvZiBtZXRhc3ByaXRlLnBhbGV0dGVzKCkpIHtcbiAgICAgICAgcGFsZXR0ZXMuYWRkKHApO1xuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBwIG9mIG1ldGFzcHJpdGUucGF0dGVybkJhbmtzKG9mZnNldCkpIHtcbiAgICAgICAgcGF0dGVybnMuYWRkKHApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIG9iai51c2VkUGFsZXR0ZXMgPSBbLi4ucGFsZXR0ZXNdO1xuICAgIC8vIG9iai51c2VkUGF0dGVybnMgPSBbLi4ucGF0dGVybnNdO1xuXG4gICAgLy8gSWYgb25seSB0aGlyZC1iYW5rIHBhdHRlcm5zIGFyZSB1c2VkLCB0aGVuIHRoZSBtZXRhc3ByaXRlIGNhbiBiZVxuICAgIC8vIHNoaWZ0ZWQgdG8gZm91cnRoIGJhbmsgd2hlbiBuZWNlc3NhcnkuICBUaGlzIGlzIG9ubHkgdHJ1ZSBmb3IgTlBDXG4gICAgLy8gc3Bhd25zLiAgQWQgaG9jIHNwYXducyBjYW5ub3QgYmUgc2hpZnRlZCAoeWV0PykuXG4gICAgc2hpZnRhYmxlID0gc2hpZnRhYmxlICYmIHBhdHRlcm5zLnNpemUgPT0gMSAmJiBbLi4ucGF0dGVybnNdWzBdID09PSAyO1xuXG4gICAgLy8gSWYgdGhlIHNwYXduIHNldHMgcGF0dGVybkJhbmsgdGhlbiB3ZSBuZWVkIHRvIGluY3JlbWVudCBlYWNoIHBhdHRlcm4uXG4gICAgLy8gV2UgaGF2ZSB0aGUgZnJlZWRvbSB0byBzZXQgdGhpcyB0byBlaXRoZXIsIGRlcGVuZGluZy5cbiAgICBjb25zdCBsb2NzID0gbmV3IE1hcDxudW1iZXIsIFNwYXduPigpO1xuICAgIGZvciAoY29uc3QgW2wsICwgc3Bhd25dIG9mIHNwYXducykge1xuICAgICAgbG9jcy5zZXQoc3Bhd24ucGF0dGVybkJhbmsgJiYgc2hpZnRhYmxlID8gfmwuaWQgOiBsLmlkLCBzcGF3bik7XG4gICAgfVxuXG4gICAgLy8gVE9ETyAtIENvbnN0cmFpbnRCdWlsZGVyXG4gICAgLy8gICAtLSBrZWVwcyB0cmFjayBvbmx5IG9mIHJlbGV2YW50IGZhY3RvcnMsIGluIGEgam9pbi5cbiAgICAvLyAgICAgIC0tPiBubyBtZWV0aW5nIGludm9sdmVkIVxuICAgIGxldCBjaGlsZCA9IHVuZGVmaW5lZDtcblxuICAgIGZvciAobGV0IFtsLCBzcGF3bl0gb2YgbG9jcykge1xuICAgICAgY29uc3QgbG9jID0gdGhpcy5yb20ubG9jYXRpb25zW2wgPCAwID8gfmwgOiBsXTtcbiAgICAgIGZvciAoY29uc3QgcGFsIG9mIHBhbGV0dGVzKSB7XG4gICAgICAgIGlmIChwYWwgPiAxKSB0aGlzLmFsbFNwcml0ZVBhbGV0dGVzLmFkZChsb2Muc3ByaXRlUGFsZXR0ZXNbcGFsIC0gMl0pO1xuICAgICAgfVxuICAgICAgY29uc3QgYyA9IENvbnN0cmFpbnQuZnJvbVNwYXduKHBhbGV0dGVzLCBwYXR0ZXJucywgbG9jLCBzcGF3biwgc2hpZnRhYmxlKTtcbiAgICAgIGNoaWxkID0gY2hpbGQgPyBjaGlsZC5qb2luKGMpIDogYztcbiAgICAgIGlmICghc2hpZnRhYmxlICYmIHNwYXduLnBhdHRlcm5CYW5rKSBjaGlsZCA9IGNoaWxkLnNoaWZ0ZWQoKTtcblxuICAgICAgLy8gLS0tIGhhbmRsZSBzaGlmdHMgYmV0dGVyLi4uPyBzdXBwb3NlIGUuZy4gbXVsdGlwbGUgcGFsMidzXG4gICAgICAvLyAgICAtPiB3ZSB3YW50IHRvIGpvaW4gdGhlbSAtIHdpbGwgaGF2ZSBtdWx0aXBsZSBzaGlmdGFibGVzLi4uXG4gICAgICAvL2NvbnN0cmFpbnQgPSBjb25zdHJhaW50LlxuICAgIH1cblxuICAgIC8vIElmIHdlJ3JlIHNoaWZ0YWJsZSwgc2F2ZSB0aGUgc2V0IG9mIHBvc3NpYmxlIHNoaWZ0IGJhbmtzXG4gICAgaWYgKCFjaGlsZCkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBjaGlsZCB0byBhcHBlYXJgKTtcbiAgICAvLyBpZiAoY2hpbGQuZmxvYXQubGVuZ3RoID09PSAxKSB7XG4gICAgLy8gICBwYXJlbnQuc2hpZnRQYXR0ZXJucyA9IG5ldyBTZXQoY2hpbGQuZmxvYXRbMF0pO1xuICAgIC8vIH1cbiAgICByZXR1cm4gY2hpbGQ7XG4gIH1cbn1cblxuZnVuY3Rpb24qIGFsbE9iamVjdHMocm9tOiBSb20sIHBhcmVudDogT2JqZWN0RGF0YSk6IEl0ZXJhYmxlPE9iamVjdERhdGE+IHtcbiAgeWllbGQgcGFyZW50O1xuICBjb25zdCByZXBsID0gcGFyZW50LnNwYXduZWRSZXBsYWNlbWVudCgpO1xuICBpZiAocmVwbCkgeWllbGQqIGFsbE9iamVjdHMocm9tLCByZXBsKTtcbiAgY29uc3QgY2hpbGQgPSBwYXJlbnQuc3Bhd25lZENoaWxkKCk7XG4gIGlmIChjaGlsZCkgeWllbGQqIGFsbE9iamVjdHMocm9tLCBjaGlsZCk7XG4gIC8vIFRPRE8gLSB0aGVzZSBkb24ndCBtYWtlIHNlbnNlIHRvIHB1dCBpbiBzcGF3bmVkUmVwbGFjZW1lbnQgYmVjYXVzZVxuICAvLyB3ZSBkb24ndCB3YW50IHRvIG92ZXItaW5mbGF0ZSByZWQgc2xpbWVzIGR1ZSB0byBnaWFudCByZWQgc2xpbWVzJ1xuICAvLyBkaWZmaWN1bHR5LCBzaW5jZSBtb3N0IGZvbGtzIHdpbGwgbmV2ZXIgaGF2ZSB0byBkZWFsIHdpdGggdGhhdC5cbiAgLy8gQnV0IHdlIGRvIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgdGhleSBnZXQgXCJ1bi1mbG9hdGVkXCIgc2luY2UgdGhlXG4gIC8vIHJlcGxhY2VtZW50IHNwYXduIHdpbGwgbm90IHNoYXJlIHRoZSBzYW1lIDM4MDoyMCAoZm9yIG5vdykuXG4gIGlmIChwYXJlbnQuaWQgPT09IDB4NTApIHlpZWxkIHJvbS5vYmplY3RzLmxhcmdlQmx1ZVNsaW1lO1xuICBpZiAocGFyZW50LmlkID09PSAweDUzKSB5aWVsZCByb20ub2JqZWN0cy5sYXJnZVJlZFNsaW1lO1xufVxuXG50eXBlIFNwYXducyA9IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT47XG4iXX0=