var Oi=Object.create;var Zs=Object.defineProperty;var Fi=Object.getOwnPropertyDescriptor;var zi=Object.getOwnPropertyNames;var Gi=Object.getPrototypeOf,Ui=Object.prototype.hasOwnProperty;var Ha=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports),Ka=(o,t)=>{for(var e in t)Zs(o,e,{get:t[e],enumerable:!0})},ji=(o,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of zi(t))!Ui.call(o,r)&&r!==e&&Zs(o,r,{get:()=>t[r],enumerable:!(s=Fi(t,r))||s.enumerable});return o};var Va=(o,t,e)=>(e=o!=null?Oi(Gi(o)):{},ji(t||!o||!o.__esModule?Zs(e,"default",{value:o,enumerable:!0}):e,o));var Za=(()=>{for(var o=new Uint8Array(128),t=0;t<64;t++)o[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return e=>{for(var s=e.length,r=new Uint8Array((s-(e[s-1]=="=")-(e[s-2]=="="))*3/4|0),n=0,i=0;n<s;){var a=o[e.charCodeAt(n++)],l=o[e.charCodeAt(n++)],c=o[e.charCodeAt(n++)],h=o[e.charCodeAt(n++)];r[i++]=a<<2|l>>4,r[i++]=l<<4|c>>2,r[i++]=c<<6|h}return r}})();function Qe(o){return o.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace(/Of/g,"of").replace(/_/g," - ")}function Ur(o){return Qe(o).replace(/^./,t=>t.toUpperCase())}function W(o,t=e=>e){return new Array(o).fill(0).map((e,s)=>t(s))}function qi(o,t,e){return o.slice(t,t+e)}function U(o,t,e){return Array.from(o.slice(t,t+e))}function Xs(o){return o<128?o:o-256}function Qs(o){return o<0?o+256:o}function Xt(o,t,e,s,r=1/0,n){n||(n=a=>a);let i=[];for(;t+e<=r&&o[t]!==s;)i.push(n(o.slice(t,t+e))),t+=e;return i}function jr(o,t,e=0){return(o[t]|o[t+1]<<8)+e}function qr(o,t,e){return e||(e=s=>s),W(Math.max(0,Math.floor(t.length/o)),s=>e(qi(t,s*o,o)))}function Hr(o){return(o*2050&139536|o*32800&558144)*65793>>>16&255}function L(o){return o!=null?o.toString(16).padStart(2,"0"):String(o)}function er(o){return o.toString(16).padStart(3,"0")}function ft(o){let t=[];for(let e of o)for(let s of e)t.push(s);return t}function it(o,t){return o[t]<<8|o[t+1]}function ne(o,t){return o[t+1]<<8|o[t]}function Qt(o,t,e=0){let s=[];for(;o[t]!=e;)s.push(o[t++]);return String.fromCharCode(...s)}function Kr(o,t){let e=o[t];return String.fromCharCode(...o.slice(t+1,t+1+e))}function Vr(o,t,e){o[t]=e&255,o[t+1]=e>>>8}var ut=class{constructor(t,e,s=!1){this.last=t;this.clear=e;this.nonEmpty=s}read(t,e=0){let s=[];for(;;){let r=t[e++],n=t[e++],i=(r&3)<<8|n,a=r&this.clear?~i:i;if(a!==-1&&s.push(a),r&this.last)return s}}bytes(t){t=t.filter(s=>s!==-1),this.nonEmpty&&!t.length&&(t=[-1]);let e=[];for(let s=0;s<t.length;s++){let r=t[s];r<0&&(r=this.clear<<8|~r),s===t.length-1&&(r|=this.last<<8),e.push(r>>>8),e.push(r&255)}return e}write(t,e,s=0){let r=this.bytes(e);for(let n=0;n<r.length;n++)t[n+s]=r[n]}},tr=new ut(64,128),sr=new ut(64,128,!0),rr=new ut(64,128,!0),nr=new ut(128,32,!0),ir=new ut(128,32);function Zr(){let o=Symbol();function t(...e){return{tag:o,args:e}}return t.commit=(e,s)=>{for(let r of Object.getOwnPropertyNames(e)){let n=e[r];n.tag===o&&(e[r]=s(r,...n.args))}},t}var Js=Symbol("PROP_TAG"),Ys=new WeakMap;function Gr(o){let t=Ys.get(o);if(!t){t=class extends Fe{},Object.defineProperties(t,{name:{value:o.name}}),Object.assign(t,o),Reflect.setPrototypeOf(t.prototype,o.prototype);let e=new o,s={};for(let[r,n]of Object.entries(e))n&&n[Js]&&(s[r]=n);Object.defineProperties(t.prototype,s),Ys.set(o,t),Ys.set(t,t)}return t}var Fe=class{constructor(t){this.data=t}static of(t){return Object.assign(new(Gr(this))(new Array(this.size).fill(0)),t)}static from(t,e=0){let s=Gr(this),r=!e&&t.length===this.size?t:U(t,e,this.size);return new s(r)}[Symbol.iterator](){return this.data[Symbol.iterator]()}hex(){return Array.from(this.data,L).join(" ")}clone(){return new this.constructor(this.data)}prop(...t){return{get(){let e=0;for(let[s,r=255,n=0]of t){let i=n<0?-n:0,a=n<0?0:n;e|=(this.data[s]&r)>>>a<<i}return e},set(e){for(let[s,r=255,n=0]of t){let i=n<0?-n:0,a=n<0?0:n,l=e>>>i<<a&r;this.data[s]=this.data[s]&~r|l}},[Js]:!0}}booleanProp(t,e){return{get(){return Boolean(this.data[t]&1<<e)},set(s){let r=1<<e;s?this.data[t]|=r:this.data[t]&=~r},[Js]:!0}}},Hi=(o,t)=>{let e={get(s,r){let n=s[r];return r==="subarray"?(i,a)=>{let l=s.subarray(i,a);return i<=t&&t<a?Hi(l,t-i):l}:r==="set"?i=>{console.log(`Setting overlapping array ${t}`);debugger;s.set(i)}:(typeof n=="function"&&(n=n.bind(s)),n)},set(s,r,n,i){if(r==t){console.log(`Writing ${t.toString(16)}`);debugger}return s[r]=n,!0}};return new Proxy(o,e)},me=class{constructor(t,e,s){this.name=t;this.bank=e;this.org=s}get offset(){return(this.bank&31)<<13}},G=me;G.$04=new me("04",4,32768),G.$05=new me("05",5,40960),G.$0a=new me("0a",10,32768),G.$0b=new me("0b",11,40960),G.$0c=new me("0c",12,32768),G.$0d=new me("0d",13,40960),G.$0e=new me("0e",14,32768),G.$0f=new me("0f",15,40960),G.$10=new me("10",16,32768),G.$14=new me("14",20,32768),G.$15=new me("15",21,40960),G.$16_a=new me("16:a",22,40960),G.$17=new me("17",23,40960),G.$18=new me("18",24,32768),G.$19=new me("19",25,40960),G.$1a=new me("1a",26,32768),G.$1b=new me("1b",27,40960),G.$fe=new me("fe",30,49152),G.$ff=new me("ff",31,57344);var j=class{constructor(t,e){this.seg=t;this.delta=e}static of(t,e){return new j(t,e-t.org)}get offset(){return this.seg.offset+this.delta}get org(){return this.seg.org+this.delta}get segment(){return this.seg.name}plus(t,e){let s=this.delta+t;if(s>=8192){if(!e)throw new Error("Segment changed");if(this.seg.org&8192)throw new Error("Bad segment cross");return new j(e,s&8191)}return new j(this.seg,s)}minus(t){if(t.seg!==this.seg)throw new Error("Incompatible segments");return this.delta-t.delta}read(t){return t[this.offset]}readLittleEndian(t){let e=this.offset;return t[e]|t[e+1]<<8}readAddress(t,...e){let s=this.readLittleEndian(t);e.length||(e=[this.seg]);for(let r of e)if((s&57344)===(r.org&57344))return j.of(r,s);throw new Error(`Could not find valid segment for ${L(s)}`)}loc(t,e){t.segment(this.segment),t.org(this.org,e)}};function ie(o,t,e,s){o.segment(t.name),o.org(e),o.free(s-e)}function ze(o,t,e){o.segment(...t.map(s=>s.name)),o.reloc(e),o.label(e),o.export(e)}function Ja(o){return[...o]}var Yr=class{constructor(t){this.buffer=new Array(16);this.mask=15;this.start=0;this.end=0;this.size=0;t&&this.push(...t)}[Symbol.iterator](){let t=0;return{next:()=>t>=this.size?{value:void 0,done:!0}:{value:this.buffer[this.start+t++&this.mask],done:!1},[Symbol.iterator](){return this}}}get length(){return this.size}upsize(t){for(;this.mask<=t;)this.end<this.start&&(this.start+=this.mask+1),this.mask=this.mask<<1|1,this.buffer=this.buffer.concat(this.buffer);this.size=t}push(...t){this.upsize(this.size+t.length);for(let e of t)this.buffer[this.end]=e,this.end=this.end+1&this.mask}pop(){if(!!this.size)return this.end=this.end-1&this.mask,this.size--,this.buffer[this.end]}peek(){if(!!this.size)return this.buffer[this.end-1&this.mask]}unshift(...t){this.upsize(this.size+t.length);let e=this.start=this.start-t.length&this.mask;for(let s of t)this.buffer[e++&this.mask]=s}shift(){if(!this.size)return;let t=this.buffer[this.start];return this.start=this.start+1&this.mask,this.size--,t}front(){if(!!this.size)return this.buffer[this.start]}get(t){if(!(t>=this.size))return this.buffer[this.start+t&this.mask]}slice(t,e=this.size){return t<0&&(t+=this.size),e<0&&(e+=this.size),e<=t?[]:(t=this.start+Math.max(0,Math.min(this.size,t))&this.mask,e=this.start+Math.max(0,Math.min(this.size,e))&this.mask,t<=e?this.buffer.slice(t,e):this.buffer.slice(t).concat(this.buffer.slice(0,e)))}splice(t,e,...s){t<0&&(t+=this.size),t=Math.max(0,Math.min(this.size,t)),e=Math.max(0,Math.min(this.size-t,e));let r=t+e,n=s.length-e,i=this.slice(t,r);if(this.upsize(this.size+n),this.size-=n,t===0){this.start=this.start-n&this.mask;for(let a=0;a<s.length;a++)this.buffer[this.start+a&this.mask]=s[a]}else if(r===this.size){this.end=this.end+n&this.mask,t+=this.start;for(let a=0;a<s.length;a++)this.buffer[t+a&this.mask]=s[a]}else{let a=[...this.slice(0,t),...s,...this.slice(r)];a.length=this.buffer.length,this.buffer=a,this.start=0,this.end=this.size}return this.size+=n,i}toString(){let t=new Array(this.size);for(let e=0;e<this.size;e++)t[e]=this.buffer[this.start+e&this.mask];return`[${t.join(", ")}]`}};var Jr=class extends Error{};var he=class extends Map{constructor(e,s){super(s);this.supplier=e}get(e){let s=super.get(e);return s==null&&super.set(e,s=this.supplier(e)),s}sortedKeys(e){return[...this.keys()].sort(e)}sortedEntries(e){return this.sortedKeys(e).map(s=>[s,this.get(s)])}};var De;(c=>{function*o(...h){for(let u of h)yield*u}c.concat=o;function t(h){return Boolean(h[Symbol.iterator]().next().done)}c.isEmpty=t;function*e(h,u){for(let m of h)yield u(m)}c.map=e;function*s(h,u){for(let m of h)u(m)&&(yield m)}c.filter=s;function*r(h,u){for(let m of h)yield*u(m)}c.flatMap=r;function n(h){let u=0;for(let m of h)u++;return u}c.count=n;function*i(h,u){for(let m of h){if(--u<0)return;yield m}}c.take=i;function a(h,u){for(let m of h)return m;if(arguments.length<2)throw new Error(`Empty iterable: ${h}`);return u}c.first=a;function l(h,u,m=(f,S)=>[f,S]){return{*[Symbol.iterator](){let f=h[Symbol.iterator](),S=u[Symbol.iterator](),v,k;for(;v=f.next(),k=S.next(),!v.done&&!k.done;)yield m(v.value,k.value)}}}c.zip=l})(De||(De={}));function el(o){return[...o]}var Xr=class{constructor(){this.map=new Map}add(t){this.map.set(t.label,t)}has(t){return this.map.has(t.label)}delete(t){this.map.delete(t.label)}[Symbol.iterator](){return this.map.values()}},Qr=Symbol("Invalidated"),Ki=Symbol("Size"),or=class{constructor(t,e,s){this.ownerMap=t;this.ownerKey=e;this.currentSet=s}getCurrentSet(){return(!this.currentSet||this.currentSet[Qr])&&(this.currentSet=this.ownerMap.get(this.ownerKey)||new Set),this.currentSet}mutateSet(t){let e=this.getCurrentSet(),s=e.size;try{return t(e)}finally{this.ownerMap[Ki]+=e.size-s,e.size||(this.ownerMap.delete(this.ownerKey),e[Qr]=!0)}}add(t){return this.mutateSet(e=>e.add(t)),this}has(t){return this.getCurrentSet().has(t)}clear(){this.mutateSet(t=>t.clear())}delete(t){return this.mutateSet(e=>e.delete(t))}[Symbol.iterator](){return this.getCurrentSet()[Symbol.iterator]()}values(){return this.getCurrentSet().values()}keys(){return this.getCurrentSet().keys()}entries(){return this.getCurrentSet().entries()}forEach(t,e){this.getCurrentSet().forEach(t,e)}get size(){return this.getCurrentSet().size}get[Symbol.toStringTag](){return"Set"}};Reflect.setPrototypeOf(or.prototype,Set.prototype);var en=class{constructor(t=[]){this.entries=new he(()=>0,t)}add(t){this.entries.set(t,this.entries.get(t)+1)}delete(t){let e=this.entries.get(t)-1;e>0?this.entries.set(t,e):this.entries.delete(t)}unique(){return this.entries.size}count(t){return this.entries.has(t)?this.entries.get(t):0}[Symbol.iterator](){return this.entries.entries()}};function et(o){throw new Error(`non-exhaustive check: ${o}`)}function tl(o){if(!o)throw new Error(`asserted but falsy: ${o}`);return o}var tn=class{constructor(t){this.data=t}get(t){return this.data[t]}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}},sn=class{constructor(t){this.data=t;let e=new Map;for(let s=0;s<t.length;s++)e.set(t[s],s);this.rev=e,this.length=t.length}get(t){return this.data[t]}hasValue(t){return this.rev.has(t)}index(t){let e=this.rev.get(t);if(e==null)throw new Error(`Missing index for ${t}`);return e}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}},rn=class{constructor(){this._fwd=[];this._rev=[]}*[Symbol.iterator](){for(let t=0;t<this._fwd.length;t++){let e=this._fwd[t];e!=null&&(yield[t,e])}}*keys(){for(let t=0;t<this._fwd.length;t++)this._fwd[t]!=null&&(yield t)}*values(){for(let t=0;t<this._rev.length;t++)this._rev[t]!=null&&(yield t)}get(t){return this._fwd[t]}has(t){return this._fwd[t]!=null}hasValue(t){return this._rev[t]!=null}index(t){let e=this._rev[t];if(e==null)throw new Error(`Missing index for ${t}`);return e}set(t,e){if(this._fwd[t])throw new Error(`already has key ${t}`);if(this._rev[e])throw new Error(`already has value ${e}`);this._fwd[t]=e,this._rev[e]=t}replace(t,e){let s=this._rev[e];s!=null&&delete this._fwd[s];let r=this._fwd[t];return r!=null&&delete this._rev[r],this._fwd[t]=e,this._rev[e]=t,r}},Gt=class{constructor(t){this._map=new Map;if(t)for(let[e,s,r]of t)this.set(e,s,r)}*[Symbol.iterator](){for(let[t,e]of this._map)for(let[s,r]of e)yield[t,s,r]}set(t,e,s){let r=this._map.get(t);r||this._map.set(t,r=new Map),r.set(e,s)}get(t,e){return this._map.get(t)?.get(e)}has(t,e){return this._map.get(t)?.has(e)||!1}delete(t,e){let s=this._map.get(t);!s||(s.delete(e),s.size||this._map.delete(t))}row(t){return this._map.get(t)??new Map}};function on(o,...t){let e=o.split(/%/g),s=0,r=e[0];for(let n=1;n<e.length;n++){if(!e[n]){r+="%"+e[++n];continue}let i=/([-+]*)([0\D]?)(\d*)([dxs])/.exec(e[n]);if(!i){r+=t[s++]+e[n];continue}let a=parseInt(i[3])||0,l=i[2]||" ",c=t[s++],h=i[4]==="x"?Number(c).toString(16):String(c);if(i[4]!=="s"&&/\+/.test(i[1])&&Number(c)>=0&&(h="+"+h),h.length<a){let u=l.repeat(a-h.length);h=/-/.test(i[1])?h+u:u+h}r+=h+e[n].substring(i[0].length)}return r}var nn;(e=>(e.NONE={get requested(){return!1},throwIfRequested(){},register(){return{unregister(){}}}},e.CANCELLED={get requested(){return!0},throwIfRequested(){throw new Error("cancelled")},register(){return{unregister(){}}}}))(nn||(nn={}));function Et(o,t=1){return o<0?`~${(~o).toString(16).padStart(t,"0")}`:o.toString(16).padStart(t,"0")}function nl(o){let{desert:t,grass:e,lime:s,mountain:r,mountainRiver:n,river:i,sea:a,town:l}=o.metatilesets,c=o.metascreens;c.registerFix(11),t.getTile(95).copyFrom(91).replaceIn(c.oasisCave,c.oasisLake),t.getTile(90).copyFrom(152).setTiles([,,26,24]),t.getTile(91).copyFrom(128).setTiles([52,50,,]),t.getTile(92).copyFrom(128).setTiles([,,55,53]),t.getTile(93).copyFrom(128).setTiles([,55,,52]),t.getTile(94).copyFrom(128).setTiles([53,,50]),c.registerFix(12),t.getTile(99).copyFrom(113),t.getTile(104).copyFrom(112),t.getTile(105).copyFrom(96),t.getTile(106).copyFrom(101),t.getTile(108).copyFrom(112),t.getTile(110).copyFrom(118),t.getTile(111).copyFrom(120),c.registerFix(1),e.getTile(64).copyFrom(81),e.getTile(65).copyFrom(82),e.getTile(66).copyFrom(83),e.getTile(67).copyFrom(84),e.getTile(68).copyFrom(85),e.getTile(69).copyFrom(86),e.getTile(70).copyFrom(88),e.getTile(71).copyFrom(89),c.registerFix(4),a.getTile(173).copyFrom(10).replaceIn(c.beachExitN,c.lighthouseEntrance,c.oceanShrine),a.getTile(10).copyFrom(162),c.boundaryN_cave.screen.set2d(56,[[,0,0],[,10,10],[,247,247],[248,248,248,248]]),c.cornerSE_cave.screen.set2d(73,[[,0,0],[,10,10],[,247,247],[248,247,247],[,253,247]]),c.cornerSE_cave.screen.set2d(74,[[0,0],[10,10],[247,247],[248,247],[128,253],[128,255],[250]]),c.registerFix(17),i.getTile(7).copyFrom(1).replaceIn(...i),i.getTile(14).copyFrom(2).replaceIn(...i),i.getTile(32).copyFrom(3).replaceIn(...i),i.getTile(33).copyFrom(4).replaceIn(...i);for(let f of[t,a,r,n,s])f.getTile(104).copyFrom(1).replaceIn(...f),f.getTile(131).copyFrom(2).replaceIn(...f),f.getTile(136).copyFrom(3).replaceIn(...f),f.getTile(137).copyFrom(4).replaceIn(...f);for(let f of[l])f.getTile(80).copyFrom(26).replaceIn(...f),f.getTile(81).copyFrom(27).replaceIn(...f),f.getTile(26).copyFrom(1).replaceIn(...f),f.getTile(27).copyFrom(2).replaceIn(...f),f.getTile(82).copyFrom(3).replaceIn(...f),f.getTile(87).copyFrom(4).replaceIn(...f);for(let f of[e,i,t])f.getTile(1).copyFrom(193).setAlternative(0),f.getTile(2).copyFrom(215).setAlternative(10),f.getTile(3).copyFrom(193).setAlternative(0),f.getTile(4).copyFrom(215).setAlternative(10);for(let f of[a]){f.getTile(1).copyFrom(193).setAlternative(0),f.getTile(2).copyFrom(203).setAlternative(0),f.getTile(3).copyFrom(193).setAlternative(192),f.getTile(4).copyFrom(203).setAlternative(192);for(let S=1;S<5;S++)f.getTile(S).setTiles(e.getTile(S).tiles)}for(let f of[l])f.getTile(1).copyFrom(99).setAlternative(0),f.getTile(2).copyFrom(100).setAlternative(210),f.getTile(3).copyFrom(99).setAlternative(0),f.getTile(4).copyFrom(100).setAlternative(210);let h=new Set([c.boundaryE_cave,c.boundaryW_cave,c.exitW_cave,c.caveAbovePortoa,c.beachCave,c.outsideWindmill,c.exitS_cave,c.townExitW_cave,c.zombieTownBottom_caveExit]),u=new Set([]);c.isFixed(4)&&(u.add(c.boundaryN_cave),u.add(c.cornerSE_cave));let m=new Set([c.mountainDeadEndW_caveEmpty,c.mountainPathW_cave,c.mountainCave_empty,c.mountainPathE_cave,c.mountainPathN_slopeS_cave,c.mountainPathWE_slopeN_cave,c.mountainPathE_gate]);for(let f of[...h,...u]){let S=f.data.exits.find(p=>p.type==="cave"),v=Math.min(...S.exits)-16,k=u.has(f)?[[3,3],[4,4]]:[[1,1],[2,2]];f.screen.set2d(v,k),f.addCustomFlag(!0)}for(let f of[...m]){let S=f.data.exits.find(p=>p.type==="cave"||p.type==="gate"),v=Math.min(...S.exits)-16,k=[[26,26],[8,9]];f.screen.set2d(v,k),f.addCustomFlag(!0)}c.outsideWindmill.screen.set2d(67,[[202,130]]),c.townExitW_cave.screen.set2d(42,[[202,130]])}function il(o){function t(c){c.splice(0,c.length,...new Set(De.concat(...c.map(h=>[h,h+1,h-1]))))}let{fortressArena_through:e,fortressTrap:s,hallNS:r,hallNS_arena:n,hallNS_arenaWall:i,hallNS_entrance:a}=o.metascreens;n.screen.set2d(4,[[151,118,34,35,35,35,75,149],[66,72,34,33,35,35,69,66],[67,73,46,35,35,33,70,67],[68,74,46,35,33,33,71,68]]),n.setGridTile(" c | a | c "),t(n.findExitByType("edge:top").exits),i.screen.set2d(4,[[148,76,34,33,33,33,75,147],[151,79,0,1,1,2,80,149]]),i.setGridTile(" c | a | c "),t(i.findExitByType("edge:top").exits);let l=o.locations.ZebuCave.spawns.find(c=>c.isTrigger()&&c.id===140);l&&(l.yt+=4),e.screen.set2d(5,[[95,34,33,33,33,95],[183,34,33,33,33,181],[191,34,33,33,33,168]]),e.setGridTile(" c | a | w "),t(e.findExitByType("edge:top").exits),s.screen.set2d(196,[[60,61,33,33,33,33,59,60],[146,76,34,33,33,33,75,144],[148,76,34,33,33,33,75,147]]),s.setGridTile("   | x | c "),t(s.findExitByType("edge:bottom").exits);for(let c of o.locations){let h=c.meta;for(let u of h.allPos())if(h.get(u)===a&&h.get(u+16)?.hasFeature("arena")){h.set(u,r);let f=c.screens[u>>>4];f&&(f[u&15]=r.sid)}}}var{$14:Ae,$15:mn,$16_a:xn,$17:pn}=G,Vi=new Map([[6,"{}"],[7,"[]"]]),ar=class{constructor(t,e,s,r,n){this.messages=t;this.part=e;this.id=s;this.bytes=[];this.hex="";let i=t.rom.prg,a=[];for(let l=r;r&&i[l];l++){let c=i[l];if(this.bytes.push(c),c===1){if(l!==r&&i[l-1]!==3)throw new Error(`Unexpected start message signal at ${l.toString(16)}`)}else if(c===2)a.push(`
 `);else if(c===3)a.push(`${kt.CONTINUED}
`);else if(c===4)a.push("{:HERO:}");else if(c===8)a.push("[:ITEM:]");else if(c>=5&&c<=9){let h=i[++l];if(this.bytes.push(h),c===9){a.push(" ".repeat(h));continue}let u=Vi.get(c);u&&(a.push(u[0]),a.push(h.toString(16).padStart(2,"0")),a.push(":")),a.push(n(h,c)),u&&a.push(u[1]),_t[String.fromCharCode(i[l+1])]||a.push(" ")}else if(c>=128)a.push(n(c,0)),_t[String.fromCharCode(i[l+1])]||a.push(" ");else if(c>=32)a.push(String.fromCharCode(c));else throw new Error(`Non-exhaustive switch: ${c} at ${l.toString(16)}`)}this.text=a.join("")}get mid(){return`${L(this.part)}:${L(this.id)}`}fixText(){if(this.checkText())return;let t=[],e=0,s=0,r=!1,n=[],i=new Map;function a(m,f=m.length){s+f>28&&h(),m===" "?(t.push(...n," "),n=[]):/^[[{]:/.test(m)?n.push({toString:()=>m,length:f}):n.push(m),s+=f,r=m.endsWith(" ")}function l(){r||a(" "),r=!0}function c(m){let f=m.split(/\s+/);for(let S=0;S<f.length;S++)S&&l(),a(f[S])}function h(){s=1+n.reduce((m,f)=>m+f.length,0),++e>2?(t.push(`#
 `),e=0):t.push(`
 `),r=!0}for(let m=0;m<this.text.length;m++){let f=this.text[m],S=this.text[m+1];if(/[\s\n#]/.test(f))l();else if(f==="{"){if(S===":")a("{:HERO:}",6);else{let v=this.text.indexOf(":",m),k=Number.parseInt(this.text.substring(m+1,v),16),p=this.messages.extraWords[6][k];i.set(p,`{${k.toString(16)}:${p}}`),c(p)}m=this.text.indexOf("}",m)}else if(f==="["){if(S===":"){let v=this.messages.rom.items;a("[:ITEM:]",Math.max(...v.map(k=>k.messageName.length)))}else{let v=this.text.indexOf(":",m),k=Number.parseInt(this.text.substring(m+1,v),16),p=this.messages.rom.items[k].messageName;i.set(p,`[${k.toString(16)}:${p}]`),c(p)}m=this.text.indexOf("]",m)}else a(f)}t.push(...n);let u=t.join("");for(let[m,f]of i)u.includes(m)&&(u=u.split(m).join(f));this.text=u}checkText(){let t=0,e=0,s=this.text.replace(/\s+$/mg,"");for(let r=0;r<s.length;r++){let n=s[r],i=s[r+1];if(n===`
`){if(t++,e=0,t>3)return!1}else if(n==="#")i===`
`&&r++,t=e=0;else if(n==="{"||n==="["){if(i===":"){if(n==="{")e+=6;else{let a=this.messages.rom.items;e+=Math.max(...a.map(l=>l.messageName.length))}if(e>28)return!1}else{let a=s.indexOf(":",r),l=Number.parseInt(s.substring(r+1,a),16);e+=(n==="{"?this.messages.personNames[l]:this.messages.itemNames[l]).length}r=s.indexOf(bn[n],r)}else e++;if(e>28||e>14&&t>2&&s.includes("#",r))return!1}return!0}},_t={"\0":!0," ":!0,"!":!0,"'":!0,",":!0,".":!0,":":!0,";":!0,"?":!0,_:!0,"\n":!0,"#":!0},an=j.of(Ae,34564),ln=j.of(Ae,34442),cn=j.of(Ae,34517),dn=j.of(Ae,34537),Zi=j.of(Ae,34697),hn=j.of(Ae,34113),Yi=j.of(Ae,34380),un=j.of(Ae,34124),fn={21:mn,22:xn,23:pn},lr=class{constructor(t){this.rom=t;this.partCount=34;this.commonWords=[];this.uncommonWords=[];this.personNames=[];this.itemNames=[];this.parts=[];let e=an.readAddress(t.prg),s=ln.readAddress(t.prg),r=cn.readAddress(t.prg),n=dn.readAddress(t.prg),i=hn.readAddress(t.prg),a=un.readAddress(t.prg),l={5:s,6:r,7:n};this.extraWords={5:this.uncommonWords,6:this.personNames,7:this.itemNames};let c=(m,f,S)=>{let v=m[S];return v??(v=Qt(t.prg,f.plus(2*S).readAddress(t.prg).offset),m[S]=v)},h=(m,f)=>f?c(this.extraWords[f],l[f],m):c(this.commonWords,e,m-128);for(let m=0;m<73;m++)h(m,7);let u=i.offset;this.banks=U(t.prg,u,this.partCount);for(let m=this.partCount-1;m>=0;m--){let f=a.plus(2*m).readAddress(t.prg),S=u-f.offset>>>1;u=f.offset;let v=fn[this.banks[m]],k=this.parts[m]=[];for(let p=0;p<S;p++){let y=f.plus(2*p).readAddress(t.prg,v);k[p]=new ar(this,m,p,y.offset,h)}}}*messages(t){for(let e of this.parts)if(t)for(let s of e)t.has(s.mid)&&(yield s);else yield*e}alloc(){let t=this.uses();for(let e of this.parts)for(let s of e)if(!t.has(s.mid))return s;throw new Error("could not find an unused message id")}uses(){let t=new Map;function e(s,r){let n=typeof s=="string"?s:s.mid,i=t.get(n)||new Set;i.add(r),t.set(n,i)}for(let s of this.rom.triggers)s.message.nonzero()&&e(s.message,`Trigger $${L(s.id)}`);for(let s of this.rom.items)for(let r of s.itemUseMessages())r.nonzero()&&e(r,`Item $${L(s.id)}`);for(let s of this.rom.npcs){for(let r of s.globalDialogs)e(r.message,`NPC $${L(s.id)}`);for(let[r,n]of s.localDialogs){let i=r>=0?` @ $${L(r)}`:"";for(let a of n)e(a.message,`NPC $${L(s.id)}${i}`)}}for(let s of this.rom.telepathy.sages){for(let r of s.defaultMessages)e(r,`Telepathy ${s.sage}`);for(let r of s.messageGroups)for(let[,...n]of r.messages)for(let i of n)e(i,`Telepathy ${s.sage}`)}for(let s of Xi)e(s,"Hardcoded");return t}buildAbbreviationTable(t=this.uses()){let e=[],s=new Map,r=new Map;for(let u of this.messages(t)){u.fixText();let m=u.mid,f=s.get(u.text),S=f!=null&&r.get(f);if(S){S.push(m);continue}s.set(u.text,m),r.set(m,[]);let v=u.text,k=[];for(let p=0,y=v.length;p<=y;p++){let w=v[p],E=bn[w];if(_t[w]||E||p===y){let B=v[p+1];if(E&&(p=Math.max(p,v.indexOf(E,p))),!k.length)continue;let O=(w===" "||w==="'")&&B&&!_t[B]?w:"",q=k.join(""),P=e.length,oe=q.length+(w===" "?1:0);k=[],e.push({str:q,id:P,chain:O,bytes:oe,used:0,suffixes:new Set,mid:m})}else k.push(w)}}let n=new Map;for(let u=e.length-1;u>=0;u--){let m=e[u];for(let f=m.bytes-2;f>=0;f--){let v=m.str.substring(f),k=0,p=m,y=m.bytes-f-1;for(;;){let w=n.get(v);w||n.set(v,w={chains:k,missing:f,saving:-v.length,str:v,words:new Set}),w.words.add(u),w.saving+=y;for(let E=k;E>=0;E--)e[u+E].suffixes.add(w);if(!p.chain)break;v+=p.chain,p=e[u+ ++k],v+=p.str,y+=p.bytes}}}let i=new Set,a=[],l=({saving:u},{saving:m})=>m-u,c=[...n.values()].sort(l),h=0;for(;c.length&&h<Ji;){i.has(c[0].str)&&(c.sort(l),i.clear());let{str:u,saving:m,missing:f,words:S,chains:v}=c.shift();if(m<=0)break;h+=u.length+3;let k=a.length,p=new Set;for(let y of S){let w=e[y];for(let E of[w.mid,...r.get(w.mid)||[]])p.add(E)}a.push({bytes:k<128?[k+128]:[5,k-128],mids:p,str:u});for(let y of S)for(let w=0;w<=v;w++){let E=e[y+w],B=E.bytes-(w?0:f);for(let O of E.suffixes)O.saving-=B-E.used,i.add(O.str);E.used=B}if(a.length===128){for(let y of n.values())y.saving-=y.words.size;c.sort(l),i.clear()}}return a}compress(){let t=this.uses(),e=this.buildAbbreviationTable(t),s=new Map;this.commonWords.splice(0,this.commonWords.length),this.uncommonWords.splice(0,this.uncommonWords.length);for(let r of e){r.bytes.length===1?this.commonWords[r.bytes[0]&127]=r.str:this.extraWords[r.bytes[0]][r.bytes[1]]=r.str;for(let n of r.mids){let i=s.get(n);i||s.set(n,i=[]),i.push(r)}}for(let r of s.values())r.sort(({str:{length:n}},{str:{length:i}})=>i-n);for(let r of this.messages(t)){let n=r.text;n=n.replace(/([\[{])([^\]}]*)[\]}](.|$)/g,(l,c,h,u)=>{if(u&&!_t[u])return l;if(u===" "&&(u=""),c==="["&&h===":ITEM:")return`[8]${u}`;if(c==="{"&&h===":HERO:")return`[4]${u}`;let m=/^([0-9a-f]+):/.exec(h);if(!m)throw new Error(`Bad message text: ${l}`);let f=Number.parseInt(m[1],16);return`[${c==="{"?6:7}][${f}]${u}`});for(let{str:l,bytes:c}of s.get(r.mid)||[])n=n.replace(new RegExp(l+"( [ &0-9]|.|$)","g"),(h,u)=>u&&!_t[u]?h:(u===" "&&(u=""),c.map(m=>`[${m}]`).join("")+u));let i=["[01]"],a=[];a.push(1);for(let l=0,c=n.length;l<c;l++){let h=n[l];if(h===lr.CONTINUED)a.push(3,1),i.push("[03][01]"),n[l+1]===`
`&&l++;else if(h===`
`)a.push(2),n[l+1]===" "&&l++,i.push("[02]");else if(h==="["){let u=n.indexOf("]",l);if(u<=0)throw new Error(`bad text: ${n}`);let m=Number(n.substring(l+1,u));if(isNaN(m))throw new Error(`bad text: ${n}`);a.push(m),i.push(`[${L(m)}]`),l=u}else if(h===" "&&n[l+1]===" "){let u=l+2;for(;n[u]===" ";)u++;a.push(9,u-l),i.push(`[09][${L(u-l)}]`),l=u-1}else a.push(h.charCodeAt(0)),i.push(h)}a.push(0),i.push("[0]"),r.bytes=a,r.hex=i.join("")}}write(){let t=this.rom.assembler();ie(t,Ae,32768,34048),ie(t,Ae,34080,34088),ie(t,Ae,34182,34195),ie(t,Ae,35072,37888),ie(t,Ae,38533,38662),ie(t,Ae,40576,40960),ie(t,mn,40960,49152),ie(t,xn,40960,49152),ie(t,pn,40960,48128);function e(l,c,...h){l.loc(t),t.word(c);let u=0;for(let m of h)l.plus(m).loc(t),t.word({op:"+",args:[c,{op:"num",num:++u}]})}let s=W(this.partCount,()=>[]);for(let l=0;l<this.partCount;l++){let c=s[l],h=this.parts[l],u=this.banks[l],m=fn[u];t.segment(m.name);for(let f of h)t.reloc(`Message_${f.mid}`),c.push(t.pc()),t.byte(...f.bytes,0)}let r=[];t.segment(Ae.name),t.reloc("MessagesTable");for(let l=0;l<this.partCount;l++)r.push(t.pc()),t.word(...s[l]);let n=t.pc();t.byte(...this.banks),t.reloc("MessageParts");let i=t.pc();t.word(...r),e(hn,n),e(Yi,n),e(un,i,5);let a=[["CommonWords",this.commonWords,[an]],["UncommonWords",this.uncommonWords,[ln]],["PersonNames",this.personNames,[cn]],["ItemNames",this.itemNames,[dn,Zi]]];for(let[l,c,h]of a){let u=[],m=0;for(let S of c){if(!S){u.push(0);continue}t.reloc(`${l}_${L(m++)}`),u.push(t.pc()),t.byte(S,0)}t.reloc(l);let f=t.pc();t.word(...u);for(let S of h)e(S,f,5)}return[t.module()]}},kt=lr;kt.CONTINUED="#";var Ji=1250,bn={"{":"}","[":"]"},Xi=new Set(["20:1d","1b:0f","1b:10","1b:11","1b:12","1b:05","1b:06","1b:07","1f:00","13:00","0b:01","20:0c","20:0f","1c:11","0e:05","16:00","16:02","16:04","16:06","20:11","21:00","21:02","21:01","06:00","18:00","18:02","18:04","18:08","1b:03","1b:00","1b:00","1b:04","06:01","10:13","19:05","20:14","20:15","20:17","20:02","20:0d","20:19","20:1a","20:1b","03:01","03:02","10:10","10:11","10:12","0c:04","0c:05","03:03","20:0e","20:13"]);var cr=class{constructor(t){this.table=t;let e=[];for(let[s,r]of Object.entries(t))for(let[n,i]of Object.entries(r))e[i]=[s,n];this.reverse=e}op(t){let e=this.table[t];if(!e)throw new Error(`Bad mnemonic: ${t}`);return e}disasm(t){let e=this.reverse[t];return e&&[...e]}argLen(t){switch(t){case"acc":case"imp":return 0;case"imm":case"rel":case"zpg":case"zpx":case"zpy":case"iny":return 1;case"abs":case"abx":case"aby":case"ind":case"inx":return 2}}format(t,e){if(t==="acc"||t==="imp")return"";if(typeof e=="number")if(t==="rel"){let s=(e>127?e-256:e)+2;s<0?e=`*-${-s}`:s>0?e=`*+${s}`:e="*"}else t.startsWith("zp")||t==="iny"||t==="imm"?e=`$${(e&255).toString(16).padStart(2,"0")}`:e=`$${(e&65535).toString(16).padStart(4,"0")}`;switch(t){case"imm":return`#${e}`;case"rel":return e;case"zpg":return e;case"abs":return e;case"zpx":return`${e},x`;case"abx":return`${e},x`;case"zpy":return`${e},y`;case"aby":return`${e},y`;case"iny":return`(${e}),y`;case"ind":return`(${e})`;case"inx":return`(${e},x)`}}},Lt;(t=>t.P02=new cr({adc:{abs:109,abx:125,aby:121,imm:105,iny:113,inx:97,zpg:101,zpx:117},and:{abs:45,abx:61,aby:57,imm:41,iny:49,inx:33,zpg:37,zpx:53},asl:{abs:14,abx:30,acc:10,imp:10,zpg:6,zpx:22},bcc:{rel:144},bcs:{rel:176},beq:{rel:240},bit:{abs:44,zpg:36},bmi:{rel:48},bne:{rel:208},bpl:{rel:16},brk:{imp:0},bvc:{rel:80},bvs:{rel:112},clc:{imp:24},cld:{imp:216},cli:{imp:88},clv:{imp:184},cmp:{abs:205,abx:221,aby:217,imm:201,iny:209,inx:193,zpg:197,zpx:213},cpx:{abs:236,imm:224,zpg:228},cpy:{abs:204,imm:192,zpg:196},dec:{abs:206,abx:222,zpg:198,zpx:214},dex:{imp:202},dey:{imp:136},eor:{abs:77,abx:93,aby:89,imm:73,iny:81,inx:65,zpg:69,zpx:85},inc:{abs:238,abx:254,zpg:230,zpx:246},inx:{imp:232},iny:{imp:200},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{abs:173,abx:189,aby:185,imm:169,iny:177,inx:161,zpg:165,zpx:181},ldx:{abs:174,aby:190,imm:162,zpg:166,zpy:182},ldy:{abs:172,abx:188,imm:160,zpg:164,zpx:180},lsr:{abs:78,abx:94,acc:74,imp:74,zpg:70,zpx:86},nop:{imp:234},ora:{abs:13,abx:29,aby:25,imm:9,iny:17,inx:1,zpg:5,zpx:21},pha:{imp:72},php:{imp:8},pla:{imp:104},plp:{imp:40},rol:{abs:46,abx:62,acc:42,imp:42,zpg:38,zpx:54},ror:{abs:110,abx:126,acc:106,imp:106,zpg:102,zpx:118},rti:{imp:64},rts:{imp:96},sbc:{abs:237,abx:253,aby:249,imm:233,iny:241,inx:225,zpg:229,zpx:245},sec:{imp:56},sed:{imp:248},sei:{imp:120},sta:{abs:141,abx:157,aby:153,iny:145,inx:129,zpg:133,zpx:149},stx:{abs:142,zpg:134,zpy:150},sty:{abs:140,zpg:132,zpx:148},tax:{imp:170},tay:{imp:168},tsx:{imp:186},txa:{imp:138},txs:{imp:154},tya:{imp:152},slo:{abs:15,abx:31,aby:27,zpg:7,zpx:23,inx:3,iny:19},rla:{abs:47,abx:63,aby:59,zpg:39,zpx:55,inx:35,iny:51},sre:{abs:79,abx:95,aby:91,zpg:71,zpx:87,inx:67,iny:83},rra:{abs:111,abx:127,aby:123,zpg:103,zpx:119,inx:99,iny:115},sax:{abs:143,zpg:135,zpy:151,inx:131},lax:{abs:175,aby:191,zpg:167,zpy:183,inx:163,iny:179},dcp:{abs:207,abx:223,aby:219,zpg:199,zpx:215,inx:195,iny:211},isc:{abs:239,abx:255,aby:251,zpg:231,zpx:247,inx:227,iny:243},alr:{imm:75},arr:{imm:107},axs:{imm:203},tas:{aby:155},shy:{abx:156},shx:{aby:158},ahx:{aby:159,iny:147},anc:{imm:43},las:{aby:187}}))(Lt||(Lt={}));var es;(e=>{class o{next(){for(;;){this.sink||(this.sink=this.pump());let{value:r,done:n}=this.sink.next();if(!n)return r;this.sink=void 0}}}e.Abstract=o;function t(...s){let r;return{next:()=>{for(;;){if(r||(r=s.shift()),!r)return;let n=r.next();if(n)return n;r=void 0}}}}e.concat=t})(es||(es={}));var b;(H=>{H.LB={token:"lb"},H.LC={token:"lc"},H.LP={token:"lp"},H.RB={token:"rb"},H.RC={token:"rc"},H.RP={token:"rp"},H.EOL={token:"eol"},H.EOF={token:"eof"},H.DEFINE={token:"cs",str:".define"},H.DOT_EOL={token:"cs",str:".eol"},H.ELSE={token:"cs",str:".else"},H.ELSEIF={token:"cs",str:".elseif"},H.ENDIF={token:"cs",str:".endif"},H.ENDMAC={token:"cs",str:".endmac"},H.ENDMACRO={token:"cs",str:".endmacro"},H.ENDREP={token:"cs",str:".endrep"},H.ENDREPEAT={token:"cs",str:".endrepeat"},H.ENDPROC={token:"cs",str:".endproc"},H.ENDSCOPE={token:"cs",str:".endscope"},H.LOCAL={token:"cs",str:".local"},H.MACRO={token:"cs",str:".macro"},H.REPEAT={token:"cs",str:".repeat"},H.SET={token:"cs",str:".set"},H.SKIP={token:"cs",str:".skip"},H.BYTE={token:"cs",str:".byte"},H.WORD={token:"cs",str:".word"},H.COLON={token:"op",str:":"},H.COMMA={token:"op",str:","},H.STAR={token:"op",str:"*"},H.IMMEDIATE={token:"op",str:"#"},H.ASSIGN={token:"op",str:"="};function Hs(R,D){return R.token!==D.token?!1:R.token==="num"||R.token==="str"?!0:R.str===D.str}H.match=Hs;function Je(R,D){return!(!R||!D||R.token!==D.token||R.token==="grp"||R.str!==D.str||R.num!==D.num)}H.eq=Je;function Ft(R){switch(R.token){case"num":return`NUM[$${R.num.toString(16)}]`;case"str":return`STR[$${R.str}]`;case"lb":return"[";case"rb":return"]";case"grp":return"{";case"lc":return"{";case"rc":return"}";case"lp":return"(";case"rp":return")";case"eol":return"EOL";case"eof":return"EOF";case"ident":return R.str;case"cs":case"op":return`${R.str.toUpperCase()}`;default:et(R)}}H.name=Ft;function zt(R){let D=R.source;if(!D)return"";let Y=D.parent?zt({source:D.parent}):"";return`
  at ${D.file}:${D.line}:${D.column}${Y}`}H.at=zt;function Xe(R){if(!R)return"at unknown";let D=R;return(D.token?Ft(D):"")+zt(R)}H.nameAt=Xe;function Ai(R,D="end of line"){if(R)throw new Error(`Expected ${D}: ${H.nameAt(R)}`)}H.expectEol=Ai;function Ri(R,D,Y){if(!D)throw Y?new Error(`Expected ${Ft(R)} after ${Xe(D)}`):new Error(`Expected ${Ft(R)}`);if(!Je(R,D))throw new Error(`Expected ${Ft(R)}: ${Xe(D)}`)}H.expect=Ri;function Ks(R,D){return Vs("ident","identifier",R,D)}H.expectIdentifier=Ks;function Mi(R,D){return Vs("str","constant string",R,D)}H.expectString=Mi;function Vs(R,D,Y,ae){if(!Y)throw ae?new Error(`Expected ${D} after ${Xe(ae)}`):new Error(`Expected ${D}`);if(Y.token!==R)throw new Error(`Expected ${D}: ${Xe(Y)}`);return Y.str}function Ci(R){if(!R.length)return[];let D=[];for(let Y=0;Y<=R.length;Y+=2){let ae=R[Y];if(ae?.token!=="ident"){if(ae)throw new Error(`Expected identifier: ${Xe(ae)}`);let Le=R[R.length-1];throw new Error(`Expected identifier after ${Xe(Le)}`)}else if(Y+1<R.length&&!Je(R[Y+1],H.COMMA)){let Le=R[Y+1];throw new Error(`Expected comma: ${Xe(Le)}`)}D.push(ae.str)}return D}H.identsFromCList=Ci;function Ni(R,D){let Y=R[D++].token;if(Y!=="lp"&&Y!=="lb")throw new Error("non-grouping token");let ae=Y==="lp"?"rp":"rb",Le=1;for(;D<R.length;D++){let Oe=R[D].token;if(Le+=Number(Oe===Y)-Number(Oe===ae),!Le)return D}return-1}H.findBalanced=Ni;function Ii(R,D=0,Y=R.length){let ae=[],Le=[ae],Oe=0;for(let C=D;C<Y;C++){let de=R[C];if(!Oe&&Je(de,H.COMMA))Le.push(ae=[]);else if(ae.push(de),Je(de,H.LP)&&Oe++,Je(de,H.RP)&&--Oe<0)throw new Error(`Unbalanced paren${zt(de)}`)}return Le}H.parseArgList=Ii;function Pi(R,D){let Y=new Map,ae,Le=[];if(D>=R.length)return Y;if(!Je(R[D],H.COLON))throw new Error(`Unexpected: ${Xe(R[D])}`);for(let Oe=D+1;Oe<R.length;Oe++){let C=R[Oe];if(Je(C,H.COLON)){if(ae==null)throw new Error(`Missing key${zt(C)}`);Y.set(ae,Le),ae=void 0,Le=[]}else ae==null?ae=Ks(C):Le.push(C)}return ae!=null?Y.set(ae,Le):Ks(void 0,R[R.length-1]),Y}H.parseAttrList=Pi;function Di(R,D){let Y=Fr(R,H.COMMA,D);return Y<0?R.length:Y}H.findComma=Di;function Fr(R,D,Y){for(let ae=Y;ae<R.length;ae++)if(Je(R[ae],D))return ae;return-1}H.find=Fr;function zr(R){let D=0;for(let Y of R)Y.token==="grp"?D+=2+zr(Y.inner):D++;return D}H.count=zr;function $i(R,D){return R.token==="ident"&&R.str.toLowerCase()===D}H.isRegister=$i;function Bi(R){switch(R.token){case"cs":case"ident":case"str":case"op":return R.str}throw new Error(`Non-string token: ${H.nameAt(R)}`)}H.str=Bi;function Wi(R){return delete R.source,R}H.strip=Wi})(b||(b={}));var Q;(k=>{function o(p){return p.source?{source:{parent:p.source,file:"js",line:0,column:0}}:{}}function t(p){return{op:"<",args:[p],...o(p)}}k.loByte=t;function e(p){return{op:">",args:[p],...o(p)}}k.hiByte=e;function s(p,y){function w(B){return B.args?{...B,args:B.args.map(O=>E(O,B))}:B}function E(B,O){let q=B.source;return B=y(B,w,O),q&&!B.source&&(B.source=q),B}return E(p)}k.traverse=s;function r(p,y){return s(p,(w,E)=>y(E(w)))}k.traversePost=r;function n(p){switch(p.op){case".move":case"im":case"sym":return p;case"num":if(p.meta?.rel&&p.meta.org!=null){let{rel:y,...w}=p.meta;return{op:"num",num:p.num+w.org,meta:w}}return p;case".max":return c(p,Math.max);case".min":return c(p,Math.min);default:}if(p.args?.length===1)switch(p.op){case"+":return p.args[0];case"-":return u(p,y=>-y);case"~":return u(p,y=>~y);case"!":return u(p,y=>+!y);case"<":return u(p,y=>y&255);case">":return u(p,y=>y>>8&255);case"^":return h(p.args[0].meta?.bank)??p;default:throw new Error(`Unknown unary operator: ${p.op}`)}switch(p.op){case"+":return f(p);case"-":return S(p);case"*":return m(p,(y,w)=>y*w);case"/":return m(p,(y,w)=>Math.floor(y/w));case".mod":return m(p,(y,w)=>y%w);case"&":return m(p,(y,w)=>y&w);case"|":return m(p,(y,w)=>y|w);case"^":return m(p,(y,w)=>y^w);case"<<":return m(p,(y,w)=>y<<w);case">>":return m(p,(y,w)=>y>>>w);case"<":return m(p,(y,w)=>+(y<w));case"<=":return m(p,(y,w)=>+(y<=w));case">":return m(p,(y,w)=>+(y>w));case">=":return m(p,(y,w)=>+(y>=w));case"=":return m(p,(y,w)=>+(y==w));case"<>":return m(p,(y,w)=>+(y!=w));case"&&":return m(p,(y,w)=>y&&w);case"||":return m(p,(y,w)=>y||w);case".xor":return m(p,(y,w)=>!y&&w||!w&&y||0);default:throw new Error(`Unknown operator: ${p.op}`)}}k.evaluate=n;function i(p){if(p.op==="sym"&&p.sym)return p.sym;throw new Error(`Expected identifier but got op: ${p.op}`)}k.identifier=i;function a(p,y=0){let[w,E]=l(p,y);if(E<p.length)throw l(p,y),new Error(`Garbage after expression: ${b.nameAt(p[E])}`);if(!w)throw new Error("No expression?");return w}k.parseOnly=a;function l(p,y=0){let w=[],E=[];function B(){let[P,[,,oe]]=w.pop(),se=E.splice(E.length-oe,oe);if(se.length!==oe)throw new Error(`shunting parse failed? ${b.nameAt(p[q])}`);E.push(yn({op:P,args:se}))}let O=!0,q=y;for(;q<p.length;q++){let P=p[q];if(O)if(P.token==="cs"||P.token==="op"){let oe=gn.get(P.str),se=to.get(oe??P.str);if(se)w.push([P.str,se]);else if(P.token==="cs"){let fe=P.str;if(!so.has(fe))throw new Error(`No such function: ${b.nameAt(P)}`);let _e=p[q+1];if(_e?.token!=="lp")throw new Error(`Bad funcall: ${b.nameAt(_e??P)}`);let ht=b.findBalanced(p,q+1);if(ht<0)throw new Error(`Never closed: ${b.nameAt(_e)}`);let Jt=[];for(let Hs of b.parseArgList(p,q+2,ht))Jt.push(a(Hs));q=ht,E.push(yn({op:fe,args:Jt})),O=!1}else if(b.eq(P,b.STAR))E.push({op:"sym",sym:"*"}),O=!1;else throw new Error(`Unknown prefix operator: ${b.nameAt(P)}`)}else if(P.token==="lp"){let oe=b.findBalanced(p,q);if(oe<0)throw new Error(`No close paren: ${b.nameAt(P)}`);let se=a(p.slice(q+1,oe));E.push(se),q=oe,O=!1}else if(P.token==="ident")E.push({op:"sym",sym:P.str}),O=!1;else if(P.token==="num"){let oe=P.num;E.push({op:"num",num:oe,meta:At(oe,P)}),O=!1}else throw new Error(`Bad expression token: ${b.nameAt(P)}`);else{if(b.eq(P,b.COMMA))break;if(P.token==="cs"||P.token==="op"){let oe=gn.get(P.str),se=eo.get(oe??P.str);if(!se)break;for(;w.length;){let fe=w[w.length-1],_e=Qi(fe[1],se);if(_e<0)break;if(_e===0)throw new Error(`Mixing ${fe[0]} and ${P.str} needs explicit parens.${b.at(P)}`);B()}w.push([P.str,se]),O=!0}else break}}for(;w.length;)B();if(!p[y])throw new Error(`No token at ${y}:
${p.map(P=>"  "+b.nameAt(P)+`
`)}`);if(E.length!==1)throw new Error(`expression parse failed: nonunique result ${b.nameAt(p[y])}`);return p[y].source&&(E[0].source=p[y].source),[E[0],q]}k.parse=l;function c(p,y){throw new Error}function h(p){if(p!=null)return{op:"num",num:p,meta:At(p)}}function u(p,y){let w=p.args[0];if(!v(w))return p;let E=y(w.num);return{op:"num",num:E,meta:At(E)}}function m(p,y){let[w,E]=p.args;if(!v(w)||!v(E))return p;let B=y(w.num,E.num);return{op:"num",num:B,meta:At(B)}}function f(p){let[y,w]=p.args;if(y.op!=="num"||w.op!=="num")return p;let E={op:"num",num:y.num+w.num};if(y.meta||w.meta){if(y.meta?.rel&&w.meta?.rel)return p;y.meta?.rel?E.meta=y.meta:w.meta?.rel&&(E.meta=w.meta)}return!E.meta?.rel&&E.meta?.size==null&&((E.meta||(E.meta={})).size=At(E.num).size),E}function S(p){let[y,w]=p.args;if(y.op!=="num"||w.op!=="num")return p;let E={op:"num",num:y.num-w.num};return w.meta?.rel?y.meta?.rel&&y.meta.chunk===w.meta.chunk?E:p:(y.meta?.rel&&(E.meta=y.meta),!E.meta?.rel&&E.meta?.size==null&&((E.meta||(E.meta={})).size=At(E.num).size),E)}function v(p){return p.op==="num"&&!p.meta?.rel}})(Q||(Q={}));function Qi(o,t){return o[0]>t[0]?1:o[0]<t[0]?-1:o[1]!==t[1]?0:o[1]}var ge=2,mt=1,eo=new Map([["*",[5,4,ge]],["/",[5,4,ge]],[".mod",[5,3,ge]],["&",[5,2,ge]],["^",[5,1,ge]],["<<",[5,0,ge]],[">>",[5,0,ge]],["+",[4,2,ge]],["-",[4,2,ge]],["|",[4,1,ge]],["<",[3,0,ge]],["<=",[3,0,ge]],[">",[3,0,ge]],[">=",[3,0,ge]],["=",[3,0,ge]],["<>",[3,0,ge]],["&&",[2,3,ge]],[".xor",[2,2,ge]],["||",[2,1,ge]]]),to=new Map([["+",[9,-1,mt]],["-",[9,-1,mt]],["~",[9,-1,mt]],["<",[9,-1,mt]],[">",[9,-1,mt]],["^",[9,-1,mt]],["!",[2,-1,mt]]]),so=new Set([".byteat",".wordat",".max",".min"]),gn=new Map([[".bitand","&"],[".bitxor","^"],[".bitor","|"],[".shl","<<"],[".shr",">>"],[".and","&&"],[".or","||"],[".bitnot","~"],[".lobyte","<"],[".hibyte",">"],[".bankbyte","^"],[".not","!"]]),ro=new Map([["^",(...o)=>o.length===1?1:Math.max(...o)],["<",()=>1],[">",()=>1],["!",()=>1],["<=",()=>1],[">=",()=>1],["<>",()=>1],["=",()=>1],["&",Math.max],["&&",Math.max],["|",Math.max],["||",Math.max],[".xor",Math.max],[".max",Math.max],[".min",Math.max]]);function yn(o){let e=ro.get(o.op)?.(...o.args.map(s=>Number(s.meta?.size)));return e&&((o.meta||(o.meta={})).size=e),o}function At(o,t){return o<256&&t&&t.token==="num"&&t.width!=null?{size:t.width}:{size:0<=o&&o<256?1:2}}var Rt;(t=>{function o(e,s){let r={...e,...s},n=[...e.free||[],...s.free||[]];return n.length&&(r.free=n),r}t.merge=o})(Rt||(Rt={}));var dr=class{constructor(t,e,s,r,n){this.line=t;this.column=e;this.prefix=s;this.remainder=r;this.match=n}},ts=class{constructor(t,e=1,s=0){this.content=t;this.line=e;this.column=s;this.prefix="";this.remainder=t}advance(t){let e=this.remainder.substring(0,t.length);if(t!==e)throw new Error(`Non-rooted token: '${t}' vs '${e}'`);this.prefix+=t,this.remainder=this.remainder.substring(t.length),t=t.replace(`
`,t.includes("\r")?"":"\r");let s=t.split(/\r/g);s.length>1&&(this.line+=s.length-1,this.column=0),this.column+=s[s.length-1].length}saveState(){return new dr(this.line,this.column,this.prefix,this.remainder,this.lastMatch)}restoreState(t){this.line=t.line,this.column=t.column,this.prefix=t.prefix,this.remainder=t.remainder,this.lastMatch=t.match}skip(t){let e=t.exec(this.remainder);return e?(this.advance(e[0]),!0):!1}space(){return this.skip(/^[ \t]+/)}newline(){return this.skip(/^(\r\n|\n|\r)/)}lookingAt(t){return typeof t=="string"?this.remainder.startsWith(t):t.test(this.remainder)}token(t){let e;if(typeof t=="string"){if(!this.remainder.startsWith(t))return!1;e=[t]}else e=t.exec(this.remainder);return e?(e.line=this.line,e.column=this.column,this.lastMatch=e,this.advance(e[0]),!0):!1}lookBehind(t){if(typeof t=="string")return this.prefix.endsWith(t);let e=t.exec(this.prefix);return e?(e.line=this.line,e.column=this.line,this.lastMatch=e,!0):!1}match(){return this.lastMatch}group(t=0){return this.lastMatch?.[t]}eof(){return!this.remainder}};var Mt=class{constructor(t,e="input.s",s={}){this.file=e;this.opts=s;this.buffer=new ts(t)}next(){let t=this.token();for(;b.eq(t,b.EOL);)t=this.token();let e=[[]],s=0;for(;!b.eq(t,b.EOL)&&!b.eq(t,b.EOF);){if(b.eq(t,b.LC))e[s++].push(t),e.push([]);else if(b.eq(t,b.RC)){if(!s)throw new Error(`Missing open curly: ${b.nameAt(t)}`);let r=e.pop(),n=e[--s].pop().source,i={token:"grp",inner:r};n&&(i.source=n),e[s].push(i)}else e[s].push(t);t=this.token()}if(s){let r=e[s-1].pop();throw new Error(`Missing close curly: ${b.nameAt(r)}`)}return e[0].length?e[0]:void 0}token(){for(;this.buffer.space()||this.buffer.token(/^;.*/)||this.opts.lineContinuations&&this.buffer.token(/^\\(\r\n|\n|\r)/););if(this.buffer.eof())return b.EOF;let t={file:this.file,line:this.buffer.line,column:this.buffer.column};try{let e=this.tokenInternal();return this.opts.skipSourceAnnotations||(e.source=t),e}catch(e){let{file:s,line:r,column:n}=t,i=this.buffer.group();throw i=i?` near '${i}'`:"",e.message+=`
  at ${s}:${r}:${n}${i}`,e}}tokenInternal(){if(this.buffer.newline())return{token:"eol"};if(this.buffer.token(/^@+[a-z0-9_]*/i)||this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i))return this.strTok("ident");if(this.buffer.token(/^\.[a-z]+/i))return this.strTok("cs");if(this.buffer.token(/^:([+-]\d+|[-+]+|<+rts|>*rts)/))return this.strTok("ident");if(this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/))return this.strTok("op");if(this.buffer.token("["))return{token:"lb"};if(this.buffer.token("{"))return{token:"lc"};if(this.buffer.token("("))return{token:"lp"};if(this.buffer.token("]"))return{token:"rb"};if(this.buffer.token("}"))return{token:"rc"};if(this.buffer.token(")"))return{token:"rp"};if(this.buffer.token(/^["']/))return this.tokenizeStr();if(this.buffer.token(/^[$%]?[0-9a-z_]+/i))return this.tokenizeNum();throw new Error("Syntax error")}tokenizeStr(){let t=this.buffer,s=t.match()[0],r="";for(;!t.lookingAt(s);){if(t.eof())throw new Error(`EOF while looking for ${s}`);t.token(/^\\u([0-9a-f]{4})/i)?r+=String.fromCodePoint(parseInt(t.group(1),16)):t.token(/^\\x([0-9a-f]{2})/i)?r+=String.fromCharCode(parseInt(t.group(1),16)):t.token(/^\\(.)/)?r+=t.group(1):(t.token(/^./),r+=t.group(0))}return t.token(s),{token:"str",str:r}}strTok(t){return{token:t,str:this.buffer.group()}}tokenizeNum(t=this.buffer.group()){return this.opts.numberSeparators&&(t=t.replace(/_/g,"")),t[0]==="$"?io(t.substring(1)):t[0]==="%"?lo(t.substring(1)):t[0]==="0"?ao(t):oo(t)}};function io(o){if(!/^[0-9a-f]+$/i.test(o))throw new Error(`Bad hex number: $${o}`);return{token:"num",num:Number.parseInt(o,16),width:Math.ceil(o.length/2)}}function oo(o){if(!/^[0-9]+$/.test(o))throw new Error(`Bad decimal number: ${o}`);return{token:"num",num:Number.parseInt(o,10)}}function ao(o){if(!/^[0-7]+$/.test(o))throw new Error(`Bad octal number: ${o}`);return{token:"num",num:Number.parseInt(o,8)}}function lo(o){if(!/^[01]+$/.test(o))throw new Error(`Bad binary number: %${o}`);return{token:"num",num:Number.parseInt(o,2),width:Math.ceil(o.length/8)}}var ss=class{constructor(){this.symbols=new Map}pickScope(t){return[t,this]}resolve(t,e={}){let{allowForwardRef:s=!1,ref:r}=e,[n,i]=this.pickScope(t),a=i.symbols.get(n);if(a)return n!==t&&(a.scoped=!0),a;if(!s)return;let l={ref:r};return i.symbols.set(n,l),n!==t&&(l.scoped=!0),l}},rs=class extends ss{constructor(e,s){super();this.parent=e;this.kind=s;this.children=new Map;this.anonymousChildren=[];this.global=e?e.global:this}pickScope(e){let s=this,r=e.split(/::/g),n=r.pop();for(let i=0;i<r.length;i++){if(!i&&!r[i]){s=s.global;continue}let a=s.children.get(r[i]);for(;!i&&s.parent&&!a;)a=(s=s.parent).children.get(r[i]);if(!a){let l=r.slice(0,i+1).join("::");throw new Error(`Could not resolve scope ${l}`)}s=a}return[n,s]}},hr=class extends ss{clear(){for(let[t,e]of this.symbols)if(!e.expr){let s=e.ref?b.at(e.ref):"";throw new Error(`Cheap local label never defined: ${t}${s}`)}this.symbols.clear()}},Ct=class{constructor(t=Lt.P02,e={}){this.cpu=t;this.opts=e;this.segments=["code"];this.segmentData=new Map;this.segmentStack=[];this.symbols=[];this.globals=new Map;this.currentScope=new rs;this.cheapLocals=new hr;this.anonymousForward=[];this.anonymousReverse=[];this.relativeForward=[];this.relativeReverse=[];this.rtsRefsForward=[];this.rtsRefsReverse=[];this.chunks=[];this._chunk=void 0;this._name=void 0;this._org=void 0;this._segmentPrefix=""}get chunk(){return this.ensureChunk(),this._chunk}ensureChunk(){this._chunk||(this._chunk={segments:this.segments,data:[]},this._org!=null&&(this._chunk.org=this._org),this._name&&(this._chunk.name=this._name),this.chunks.push(this._chunk))}definedSymbol(t){let e=this.currentScope,s=!t.includes("::");do{let r=e.resolve(t,{allowForwardRef:!1});if(r)return Boolean(r.expr)}while(s&&(e=e.parent));return!1}constantSymbol(t){let e=this.currentScope.resolve(t,{allowForwardRef:!1});return Boolean(e&&e.expr&&!(e.id<0))}referencedSymbol(t){return this.currentScope.resolve(t,{allowForwardRef:!1})!=null}evaluate(t){if(t=this.resolve(t),t.op==="num"&&!t.meta?.rel)return t.num}pc(){let t=this.chunk.data.length,e={rel:!0,chunk:this.chunks.length-1};return this._chunk?.org!=null&&(e.org=this._chunk.org),Q.evaluate({op:"num",num:t,meta:e})}resolve(t){return Q.traverse(t,(e,s)=>{for(;e.op==="sym"&&e.sym;)e=this.resolveSymbol(e);return Q.evaluate(s(e))})}resolveSymbol(t){let e=t.sym,s=ho(e);if(s.type==="pc")return this.pc();if(s.type==="anon"&&s.num>0){let i=s.num-1,a=this.anonymousForward[i];return a!=null?{op:"sym",num:a}:(this.anonymousForward[i]=a=this.symbols.length,this.symbols.push({id:a}),{op:"sym",num:a})}else if(s.type==="rts"&&s.num>0){let i=s.num-1,a=this.rtsRefsForward[i];return a!=null?{op:"sym",num:a}:(this.rtsRefsForward[i]=a=this.symbols.length,this.symbols.push({id:a}),{op:"sym",num:a})}else if(s.type==="rel"&&s.num>0){let i=this.relativeForward[s.num-1];return i!=null?{op:"sym",num:i}:(this.relativeForward[e.length-1]=i=this.symbols.length,this.symbols.push({id:i}),{op:"sym",num:i})}else if(s.type==="anon"&&s.num<0){let i=this.anonymousReverse.length+s.num;return i<0&&this.fail(`Bad anonymous backref: ${e}`),this.anonymousReverse[i]}else if(s.type==="rts"&&s.num<0){let i=this.rtsRefsReverse.length+s.num;return i<0&&this.fail(`Bad rts backref: ${e}`),this.rtsRefsReverse[i]}else if(s.type==="rel"&&s.num<0){let i=this.relativeReverse[e.length-1];return i==null&&this.fail(`Bad relative backref: ${e}`),i}let n=(e.startsWith("@")?this.cheapLocals:this.currentScope).resolve(e,{allowForwardRef:!0,ref:t});return n.expr?n.expr:(n.id==null&&(n.id=this.symbols.length,this.symbols.push(n)),{op:"sym",num:n.id})}chunkData(t){return{org:this.chunks[t].org}}closeScopes(){this.cheapLocals.clear();function t(e){for(let s of e.children.values())t(s);for(let s of e.anonymousChildren)t(s);for(let[s,r]of e.symbols)if(!(r.expr||r.id==null)&&e.parent){if(r.scoped)throw new Error(`Symbol '${s}' undefined: ${b.nameAt(r.ref)}`);let n=e.parent.symbols.get(s);if(!n)e.parent.symbols.set(s,r);else if(n.id!=null)r.expr={op:"sym",num:n.id};else if(n.expr)r.expr=n.expr;else throw new Error(`Impossible: ${s}`)}}if(this.currentScope.parent)throw new Error("Scope never closed");t(this.currentScope);for(let[e,s]of this.globals){let r=this.currentScope.symbols.get(e);if(s==="export"){if(!r?.expr)throw new Error(`Symbol '${e}' undefined`);r.id==null&&(r.id=this.symbols.length,this.symbols.push(r)),r.export=e}else if(s==="import"){if(!r)continue;if(r.expr)throw new Error(`Already defined: ${e}`);r.expr={op:"im",sym:e}}else et(s)}for(let[e,s]of this.currentScope.symbols)if(!s.expr)throw new Error(`Symbol '${e}' undefined: ${b.nameAt(s.ref)}`)}module(){this.closeScopes();let t=[];for(let r of this.chunks)t.push({...r,data:Uint8Array.from(r.data)});let e=[];for(let r of this.symbols){if(r.expr==null)throw new Error("Symbol undefined");let n={expr:r.expr};r.export!=null&&(n.export=r.export),e.push(n)}let s=[...this.segmentData.values()];return{chunks:t,symbols:e,segments:s}}line(t){this._source=t[0].source,t.length<3&&b.eq(t[t.length-1],b.COLON)?this.label(t[0]):b.eq(t[1],b.ASSIGN)?this.assign(b.str(t[0]),this.parseExpr(t,2)):b.eq(t[1],b.SET)?this.set(b.str(t[0]),this.parseExpr(t,2)):t[0].token==="cs"?this.directive(t):this.instruction(t)}tokens(t){let e;for(;e=t.next();)this.line(e)}async tokensAsync(t){let e;for(;e=await t.nextAsync();)this.line(e)}directive(t){switch(b.str(t[0])){case".org":return this.org(this.parseConst(t));case".reloc":return this.parseNoArgs(t),this.reloc();case".assert":return this.assert(this.parseExpr(t));case".segment":return this.segment(...this.parseSegmentList(t));case".byte":return this.byte(...this.parseDataList(t,!0));case".res":return this.res(...this.parseResArgs(t));case".word":return this.word(...this.parseDataList(t));case".free":return this.free(this.parseConst(t),t[0]);case".segmentprefix":return this.segmentPrefix(this.parseStr(t));case".import":return this.import(...this.parseIdentifierList(t));case".export":return this.export(...this.parseIdentifierList(t));case".scope":return this.scope(this.parseOptionalIdentifier(t));case".endscope":return this.parseNoArgs(t),this.endScope();case".proc":return this.proc(this.parseRequiredIdentifier(t));case".endproc":return this.parseNoArgs(t),this.endProc();case".pushseg":return this.pushSeg(...this.parseSegmentList(t));case".popseg":return this.parseNoArgs(t),this.popSeg();case".move":return this.move(...this.parseMoveArgs(t))}this.fail(`Unknown directive: ${b.nameAt(t[0])}`)}label(t){let e,s,r=this.pc();if(typeof t=="string"?e=t:(e=b.str(s=t),t.source&&(r.source=t.source)),e===":"){this.anonymousReverse.push(r);let n=this.anonymousForward.shift();n!=null&&(this.symbols[n].expr=r);return}else if(/^\++$/.test(e)){let n=this.relativeForward[e.length-1];delete this.relativeForward[e.length-1],n!=null&&(this.symbols[n].expr=r);return}else if(/^-+$/.test(e)){this.relativeReverse[e.length-1]=r;return}e.startsWith("@")||(this.cheapLocals.clear(),!this.chunk.name&&!this.chunk.data.length&&(this.chunk.name=e)),this.assignSymbol(e,!1,r,s)}assign(t,e){t.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${t}`),typeof e!="number"&&(e=this.resolve(e)),this.assignSymbol(t,!1,e)}set(t,e){t.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${t}`),typeof e!="number"&&(e=this.resolve(e)),this.assignSymbol(t,!0,e)}assignSymbol(t,e,s,r){typeof s=="number"&&(s={op:"num",num:s});let n=t.startsWith("@")?this.cheapLocals:this.currentScope,i=n.resolve(t,{allowForwardRef:!e,ref:r});if(i&&e!==i.id<0)this.fail(`Cannot change mutability of ${t}`,r);else if(e&&s.op!="num")this.fail("Mutable set requires constant",r);else if(i){if(!e&&i.expr){let a=i.expr.source?`
Originally defined${b.at(i.expr)}`:"",l=r?b.nameAt(r):t+(this._source?b.at({source:this._source}):"");throw new Error(`Redefining symbol ${l}${a}`)}}else{if(!e)throw new Error("impossible");n.symbols.set(t,i={id:-1})}i.expr=s}instruction(...t){let e,s;if(t.length===1&&Array.isArray(t[0])){let i=t[0];e=b.expectIdentifier(i[0]).toLowerCase(),s=this.parseArg(i)}else if(typeof t[1]=="string"){e=t[0];let i=new Mt(t[1]);s=this.parseArg(i.next(),0)}else[e,s]=t,s||(s=["imp"]),e=e.toLowerCase();if(e==="rts"){let i=this.pc();this.rtsRefsReverse.push(i);let a=this.rtsRefsForward.shift();a!=null&&(this.symbols[a].expr=i)}let r=this.cpu.op(e),n=s[0];if(n==="add"||n==="a,x"||n==="a,y"){let i=s[1],a=i.meta?.size||2;if(n==="add"&&a===1&&"zpg"in r)return this.opcode(r.zpg,1,i);if(n==="add"&&"abs"in r)return this.opcode(r.abs,2,i);if(n==="add"&&"rel"in r)return this.relative(r.rel,1,i);if(n==="a,x"&&a===1&&"zpx"in r)return this.opcode(r.zpx,1,i);if(n==="a,x"&&"abx"in r)return this.opcode(r.abx,2,i);if(n==="a,y"&&a===1&&"zpy"in r)return this.opcode(r.zpy,1,i);if(n==="a,y"&&"aby"in r)return this.opcode(r.aby,2,i);this.fail(`Bad address mode ${n} for ${e}`)}if(n in r){let i=this.cpu.argLen(n);return n==="rel"?this.relative(r[n],i,s[1]):this.opcode(r[n],i,s[1])}this.fail(`Bad address mode ${n} for ${e}`)}parseArg(t,e=1){if(t.length===e)return["imp"];let s=t[e],r=t[e+1];if(t.length===e+1){if(b.isRegister(s,"a"))return["acc"]}else if(b.eq(s,b.IMMEDIATE))return["imm",Q.parseOnly(t,e+1)];if(b.eq(s,b.COLON)&&t.length===e+2&&r.token==="op"&&/^[-+]+$/.test(r.str))return["add",{op:"sym",sym:":"+r.str}];if(t.length===e+1&&s.token==="op"&&/^[-+]+$/.test(s.str))return["add",{op:"sym",sym:s.str}];if(b.eq(s,b.LP)||this.opts.allowBrackets&&b.eq(s,b.LB)){let a=b.findBalanced(t,e);a<0&&this.fail(`Unbalanced ${b.name(s)}`,s);let l=b.parseArgList(t,e+1,a);l.length||this.fail("Bad argument",s);let c=Q.parseOnly(l[0]);if(l.length===1)return b.eq(t[a+1],b.COMMA)&&b.isRegister(t[a+2],"y")?(b.expectEol(t[a+3]),["iny",c]):(b.expectEol(t[a+1]),["ind",c]);if(l.length===2&&l[1].length===1&&b.isRegister(l[1][0],"x"))return["inx",c];this.fail("Bad argument",s)}let n=b.parseArgList(t,e);n.length||this.fail("Bad arg",s);let i=Q.parseOnly(n[0]);if(n.length===1)return["add",i];if(n.length===2&&n[1].length===1){if(b.isRegister(n[1][0],"x"))return["a,x",i];if(b.isRegister(n[1][0],"y"))return["a,y",i]}this.fail("Bad arg",s)}relative(t,e,s){let r=this.chunk.data.length+e+1,n={rel:!0,chunk:this.chunks.length-1};this._chunk?.org&&(n.org=this._chunk.org);let a={op:"-",args:[s,{op:"num",num:r,meta:n}]};s.source&&(a.source=s.source),this.opcode(t,e,a)}opcode(t,e,s){e&&(s=this.resolve(s));let{chunk:r}=this;r.data.push(t),e&&this.append(s,e),r.name||(r.name="Code")}append(t,e){let{chunk:s}=this;t=this.resolve(t);let r=t.num;if(t.op!=="num"||t.meta?.rel){let n=s.data.length;(s.subs||(s.subs=[])).push({offset:n,size:e,expr:t}),this.writeNumber(s.data,e)}else this.writeNumber(s.data,e,r)}org(t,e){this._org!=null&&this._chunk!=null&&this._org+this._chunk.data.length===t||(this._org=t,this._chunk=void 0,this._name=e)}reloc(t){this._org=void 0,this._chunk=void 0,this._name=t}segment(...t){this.segments=t.map(e=>typeof e=="string"?e:e.name);for(let e of t)if(typeof e=="object"){let s=this.segmentData.get(e.name)||{name:e.name};this.segmentData.set(e.name,Rt.merge(s,e))}this._chunk=void 0,this._name=void 0}assert(t){t=this.resolve(t);let e=this.evaluate(t);if(e!=null){if(!e){let s="",r=this.chunk;r.org!=null&&(s=` (PC=$${(r.org+r.data.length).toString(16)})`),this.fail(`Assertion failed${s}`,t)}}else{let{chunk:s}=this;(s.asserts||(s.asserts=[])).push(t)}}byte(...t){let{chunk:e}=this;for(let s of t)typeof s=="number"?this.writeNumber(e.data,1,s):typeof s=="string"?co(e.data,s):this.append(s,1)}res(t,e){!t||this.byte(...new Array(t).fill(e??0))}word(...t){let{chunk:e}=this;for(let s of t)typeof s=="number"?this.writeNumber(e.data,2,s):this.append(s,2)}free(t,e){this._org==null&&this.fail(".free in .reloc mode",e);let s=this.segments.length>1?this.segments.filter(i=>{let a=this.segmentData.get(i);return!(!a||a.memory==null||a.size==null||a.memory>this._org||a.memory+a.size<=this._org)}):this.segments;s.length!==1?this.fail(`.free with non-unique segment: ${this.segments}`,e):t<0&&this.fail(`.free with negative size: ${t}`,e),this._chunk&&(this._org+=this._chunk.data.length),this._chunk=void 0;let r=s[0],n=this.segmentData.get(r);n||this.segmentData.set(r,n={name:r}),(n.free||(n.free=[])).push([this._org,this._org+t]),this._org+=t}segmentPrefix(t){this._segmentPrefix=t}import(...t){for(let e of t)this.globals.set(e,"import")}export(...t){for(let e of t)this.globals.set(e,"export")}scope(t){this.enterScope(t,"scope")}proc(t){this.label(t),this.enterScope(t,"proc")}enterScope(t,e){let s=t?this.currentScope.children.get(t):void 0;if(s){if(this.opts.reentrantScopes){this.currentScope=s;return}this.fail(`Cannot re-enter scope ${t}`)}let r=new rs(this.currentScope,e);t?this.currentScope.children.set(t,r):this.currentScope.anonymousChildren.push(r),this.currentScope=r}endScope(){this.exitScope("scope")}endProc(){this.exitScope("proc")}exitScope(t){(this.currentScope.kind!==t||!this.currentScope.parent)&&this.fail(`.end${t} without .${t}`),this.currentScope=this.currentScope.parent}pushSeg(...t){this.segmentStack.push([this.segments,this._chunk]),this.segment(...t)}popSeg(){this.segmentStack.length||this.fail(".popseg without .pushseg"),[this.segments,this._chunk]=this.segmentStack.pop()}move(t,e){this.append({op:".move",args:[e],meta:{size:t}},t)}parseConst(t,e=1){let s=this.evaluate(Q.parseOnly(t,e));if(s!=null)return s;this.fail("Expression is not constant",t[1])}parseNoArgs(t,e=1){b.expectEol(t[1])}parseExpr(t,e=1){return Q.parseOnly(t,e)}parseStr(t,e=1){let s=b.expectString(t[e]);return b.expectEol(t[e+1],"a single string"),s}parseSegmentList(t,e=1){return t.length<e+1&&this.fail("Expected a segment list",t[e-1]),b.parseArgList(t,1).map(s=>{let r=this._segmentPrefix+b.expectString(s[0]);if(s.length===1)return r;b.eq(s[1],b.COLON)||this.fail(`Expected comma or colon: ${b.name(s[1])}`,s[1]);let n={name:r},i=b.parseAttrList(s,1);for(let[a,l]of i)switch(a){case"bank":n.bank=this.parseConst(l,0);break;case"size":n.size=this.parseConst(l,0);break;case"off":n.offset=this.parseConst(l,0);break;case"mem":n.memory=this.parseConst(l,0);break;default:this.fail(`Unknown segment attr: ${a}`)}return n})}parseResArgs(t){let e=this.parseDataList(t);e.length>2&&this.fail("Expected at most 2 args",e[2]),e.length||this.fail("Expected at least 1 arg");let s=this.evaluate(e[0]);s==null&&this.fail("Expected constant count");let r=e[1]&&this.evaluate(e[1]);return e[1]&&r==null&&this.fail("Expected constant value"),[s,r]}parseDataList(t,e=!1){t.length<2&&this.fail("Expected a data list",t[0]);let s=[];for(let r of b.parseArgList(t,1))e&&r.length===1&&r[0].token==="str"?s.push(r[0].str):r.length<1?this.fail("Missing term"):s.push(this.resolve(Q.parseOnly(r)));return s}parseIdentifierList(t){t.length<2&&this.fail("Expected identifier(s)",t[0]);let e=[];for(let s of b.parseArgList(t,1))(s.length!==1||s[0].token!=="ident")&&this.fail(`Expected identifier: ${b.name(s[0])}`,s[0]),e.push(b.str(s[0]));return e}parseOptionalIdentifier(t){let e=t[1];if(!e)return;let s=b.expectIdentifier(e);return b.expectEol(t[2]),s}parseRequiredIdentifier(t){let e=b.expectIdentifier(t[1]);return b.expectEol(t[2]),e}parseMoveArgs(t){let e=b.parseArgList(t,1);e.length!==2&&this.fail("Expected constant number, then identifier");let s=this.evaluate(Q.parseOnly(e[0]));s==null&&this.fail("Expected a constant number");let r=this.resolve(Q.parseOnly(e[1]));if(r.op==="num"&&r.meta?.chunk!=null)return[s,r];this.fail("Expected a constant offset",e[1][0])}fail(t,e){throw e?.source?new Error(t+b.at(e)):!this._source&&this._chunk?.name?new Error(t+`
  in ${this._chunk.name}`):new Error(t+b.at({source:this._source}))}writeNumber(t,e,s){let r=e<<3;if(s!=null&&(s<-1<<r||s>=1<<r)){let n=["byte","word","farword","dword"][e-1];this.fail(`Not a ${n}: $${s.toString(16)}`)}for(let n=0;n<e;n++)t.push(s!=null?s&255:255),s!=null&&(s>>=8)}};function co(o,t){for(let e=0;e<t.length;e++)o.push(t.charCodeAt(e))}function ho(o){return o==="*"?{type:"pc"}:/^:\++$/.test(o)?{type:"anon",num:o.length-1}:/^:\+\d+$/.test(o)?{type:"anon",num:parseInt(o.substring(2))}:/^:-+$/.test(o)?{type:"anon",num:1-o.length}:/^:-\d+$/.test(o)?{type:"anon",num:-parseInt(o.substring(2))}:/^:>*rts$/.test(o)?{type:"rts",num:Math.max(o.length-4,1)}:/^:<+rts$/.test(o)?{type:"rts",num:4-o.length}:/^\++$/.test(o)?{type:"rel",num:o.length}:/^-+$/.test(o)?{type:"rel",num:-o.length}:{type:"none"}}var uo=!1,ot=class{constructor(t){this.overloads=t}canOverload(){return this.overloads[this.overloads.length-1].canOverload()}append(t){if(!this.canOverload()){let e=this.overloads[this.overloads.length-1].definition,r=(e?b.at(e):"").replace(/at/,"previously defined at"),n=t.overloads[0].definition,i=n?b.nameAt(n):"";throw new Error(`Non-overloadable: ${i}${r}`)}this.overloads.push(...t.overloads)}expand(t,e){let s=[];for(let r of this.overloads){let n=r.expand(t,e);if(Array.isArray(n))return n;s.push(n)}uo&&console.error(s.join(`
`))}static from(t){if(!b.eq(t[0],b.DEFINE))throw new Error("invalid");if(t[1]?.token!=="ident")throw new Error("invalid");let e=t[2],s;if(!e)s=new Ut([],[],t[1]);else if(e.token==="grp")s=new Ut(e.inner,t.slice(3),t[1]);else if(e.token==="lp"){let r=b.findBalanced(t,2);if(r<0)throw new Error(`Expected close paren ${b.nameAt(t[2])}`);s=new ur(b.identsFromCList(t.slice(3,r)),t.slice(r+1),t[1])}else s=new Ut([],t.slice(2),t[1]);return new ot([s])}};function wn(o,t,e,s,r){let n=[],i=[],a=n;for(let l of r){if(l.token==="ident"){let h=s.get(l.str);if(h){a.push(...h);continue}}else if(b.eq(l,b.DOT_EOL)){i.push(a=[]);continue}let c=l.source&&o[0].source?{...l.source,parent:o[0].source}:l.source||o[0].source;a.push(c?{...l,source:c}:l)}return i=i.filter(l=>l.length),i.length&&e<o.length?"cannot expand .eol without consuming to end of line":(o.splice(t,e-t,...n),i)}var ur=class{constructor(t,e,s){this.params=t;this.production=e;this.definition=s}expand(t,e){let s=e+1,r=this.params.length?t.length:e,n=r,i=new Map;if(e<t.length&&b.eq(b.LP,t[s])){if(n=b.findBalanced(t,s),n<0)return"missing close paren for enclosed C-style expansion";r=n+1,s++}let a=b.parseArgList(t,s,n);if(a.length>this.params.length)return"too many args";for(s=0;s<this.params.length;s++){let l=a[s]||[],c=l[0];l.length===1&&c.token==="grp"&&(l=c.inner),i.set(this.params[s],l)}return wn(t,e,r,i,this.production)}canOverload(){return Boolean(this.params.length)}},Ut=class{constructor(t,e,s){this.pattern=t;this.production=e;this.definition=s}expand(t,e){let s=e+1,r=new Map;for(let n=0;n<this.pattern.length;n++){let i=this.pattern[n];if(i.token==="ident"){let a=this.pattern[n+1];if(!a||a?.token==="ident"){let l=t[s++];if(!l)return`missing undelimited argument ${b.name(i)}`;r.set(i.str,l.token==="grp"?l.inner:[l])}else{let l=b.eq(a,b.DOT_EOL)?t.length:b.find(t,a,s);if(l<0)return`could not find delimiter ${b.name(a)}`;r.set(i.str,t.slice(s,l)),s=l}}else if(b.eq(i,b.DOT_EOL)){if(s<t.length)return"could not match .eol"}else if(!b.eq(t[s++],i))return`could not match: ${b.name(i)}`}return wn(t,e,s,r,this.production)}canOverload(){return Boolean(this.pattern.length)}};var at=class{constructor(t,e){this.params=t;this.production=e}static from(t,e){if(!b.eq(t[0],b.MACRO))throw new Error("invalid");if(t[1]?.token!=="ident")throw new Error("invalid");let s=b.identsFromCList(t.slice(2)),r=[],n;for(;n=e.next();){if(b.eq(n[0],b.ENDMACRO))return new at(s,r);if(b.eq(n[0],b.ENDMAC))return new at(s,r);r.push(n)}throw new Error(`EOF looking for .endmacro: ${b.nameAt(t[1])}`)}expand(t,e){let s=1,r=new Map,n=[];for(let a of this.params){let l=b.findComma(t,s),c=t.slice(s,l);s=l+1,c.length===1&&c[0].token==="grp"&&(c=c[0].inner),r.set(a,c)}if(s<t.length)throw new Error(`Too many macro parameters: ${b.nameAt(t[s])}`);let i=new Map;for(let a of this.production){let l=function(c){let h=[];for(let u of c){if(u.token==="ident"){let f=r.get(u.str);if(f){h.push(...f);continue}let S=i.get(u.str);if(S){h.push({token:"ident",str:S});continue}}else if(u.token==="grp"){h.push({token:"grp",inner:l(u.inner)});continue}let m=u.source&&t[0].source?{...u.source,parent:t[0].source}:u.source||t[0].source;h.push(m?{...u,source:m}:u)}return h};if(b.eq(a[0],b.LOCAL))for(let c of b.identsFromCList(a.slice(1)))i.set(c,`${c}@${e.next()}`);n.push(l(a))}return n}};var fo=100,Sn=new WeakMap;function mo(o){let t=Sn.get(o);return t||Sn.set(o,t=(e=>({next:()=>e++}))(0)),t}var ns=class extends es.Abstract{constructor(e,s,r){super();this.stream=e;this.env=s;this.repeats=[];this.runDirectives={".define":e=>this.parseDefine(e),".undefine":e=>this.parseUndefine(e),".else":([e])=>jt(".if",e),".elseif":([e])=>jt(".if",e),".endif":([e])=>jt(".if",e),".endmac":([e])=>jt(".macro",e),".endmacro":([e])=>jt(".macro",e),".endrep":e=>this.parseEndRepeat(e),".endrepeat":e=>this.parseEndRepeat(e),".exitmacro":([,e])=>{xo(e),this.stream.exit()},".if":([e,...s])=>this.parseIf(!!this.evaluateConst(fr(s,e))),".ifdef":([e,...s])=>this.parseIf(this.macros.has(lt(s,e))),".ifndef":([e,...s])=>this.parseIf(!this.macros.has(lt(s,e))),".ifblank":([,...e])=>this.parseIf(!e.length),".ifnblank":([,...e])=>this.parseIf(!!e.length),".ifref":([e,...s])=>this.parseIf(this.env.referencedSymbol(lt(s,e))),".ifnref":([e,...s])=>this.parseIf(!this.env.referencedSymbol(lt(s,e))),".ifsym":([e,...s])=>this.parseIf(this.env.definedSymbol(lt(s,e))),".ifnsym":([e,...s])=>this.parseIf(!this.env.definedSymbol(lt(s,e))),".ifconst":([e,...s])=>this.parseIf(this.env.constantSymbol(lt(s,e))),".ifnconst":([e,...s])=>this.parseIf(!this.env.constantSymbol(lt(s,e))),".macro":e=>this.parseMacro(e),".repeat":e=>this.parseRepeat(e)};this.macros=r?r.macros:new Map}*pump(){let e=this.readLine();if(e==null)return void(yield e);for(;e.length;){let s=e[0];switch(s.token){case"ident":if(b.eq(e[1],b.COLON)){yield e.splice(0,2);break}this.tryExpandMacro(e)||(yield e);return;case"cs":this.tryRunDirective(e)||(yield e);return;case"op":if(/^[-+]+$/.test(s.str)){let r=[s],n=e[1];n&&b.eq(n,b.COLON)?(r.push(n),e.splice(0,2)):(r.push({token:"op",str:":"}),e.splice(0,1)),yield r;break}else if(s.str===":"){yield e.splice(0,1);break}default:throw new Error(`Unexpected: ${b.nameAt(e[0])}`)}}}readLine(){let e=this.stream.next();return e==null?e:this.expandLine(e)}expandLine(e,s=0){let r=e[0],n=0,i=0;for(;s<e.length;){if(s>i)i=s,n=0;else if(n++>fo)throw new Error(`Maximum expansion depth reached: ${e.map(b.name).join(" ")}${b.at(r)}`);s=this.expandToken(e,s)}return e}expandToken(e,s){let r=e[s];if(r.token==="ident"){let n=this.macros.get(r.str);if(n instanceof ot){let i=n.expand(e,s);if(i)return i.length&&this.stream.unshift(...i),s}}else if(r.token==="cs")return this.expandDirective(r.str,e,s);return s+1}tryExpandMacro(e){let[s]=e;if(s.token!=="ident")throw new Error("impossible");let r=this.macros.get(s.str);if(!(r instanceof at))return!1;let n=r.expand(e,mo(this.env));return this.stream.enter(),this.stream.unshift(...n),!0}expandDirective(e,s,r){switch(e){case".define":case".ifdef":case".ifndef":case".undefine":return this.skipIdentifier(s,r);case".skip":return this.skip(s,r);case".noexpand":return this.noexpand(s,r);case".tcount":return this.parseArgs(s,r,1,this.tcount);case".ident":return this.parseArgs(s,r,1,this.ident);case".string":return this.parseArgs(s,r,1,this.string);case".concat":return this.parseArgs(s,r,0,this.concat);case".sprintf":return this.parseArgs(s,r,0,this.sprintf);case".cond":return this.parseArgs(s,r,0,this.cond);case".def":case".defined":return this.parseArgs(s,r,1,this.defined);case".definedsymbol":return this.parseArgs(s,r,1,this.definedSymbol);case".constantsymbol":return this.parseArgs(s,r,1,this.constantSymbol);case".referencedsymbol":return this.parseArgs(s,r,1,this.referencedSymbol)}return r+1}skip(e,s){e.splice(s,1);let r=e[s];return r?.token==="grp"?this.expandToken(r.inner,0):this.expandToken(e,s+1),s}noexpand(e,s){let r=e[s+1];return r.token==="grp"?(e.splice(s,2,...r.inner),s+=r.inner.length-1):e.splice(s,1),s+1}parseArgs(e,s,r,n){let i=e[s];b.expect(b.LP,e[s+1],i);let a=b.findBalanced(e,s+1),l=b.parseArgList(e,s+2,a).map(h=>(h.length===1&&h[0].token==="grp"&&(h=h[0].inner),this.expandLine(h)));if(r&&l.length!==r)throw new Error(`Expected ${r} parameters: ${b.nameAt(i)}`);let c=n.call(this,i,...l);return e.splice(s,a+1-s,...c),s}tcount(e,s){return[{token:"num",num:b.count(s),source:e.source}]}ident(e,s){let r=b.expectString(s[0],e);return b.expectEol(s[1],"a single token"),[{token:"ident",str:r,source:s[0].source}]}string(e,s){let r=b.expectIdentifier(s[0],e);return b.expectEol(s[1],"a single token"),[{token:"str",str:r,source:s[0].source}]}concat(e,...s){return[{token:"str",str:s.map(n=>{let i=b.expectString(n[0]);return b.expectEol(n[1],"a single string"),i}).join(""),source:e.source}]}sprintf(e,s,...r){let n=b.expectString(s[0],e);b.expectEol(s[1],"a single format string");let[]=[n];throw new Error("unimplemented")}cond(e,...s){throw new Error("unimplemented")}defined(e,s){let r=b.expectIdentifier(s[0],e);return b.expectEol(s[1],"a single identifier"),[{token:"num",num:this.macros.has(r)?1:0}]}definedSymbol(e,s){let r=b.expectIdentifier(s[0],e);return b.expectEol(s[1],"a single identifier"),[{token:"num",num:this.env.definedSymbol(r)?1:0}]}constantSymbol(e,s){let r=b.expectIdentifier(s[0],e);return b.expectEol(s[1],"a single identifier"),[{token:"num",num:this.env.constantSymbol(r)?1:0}]}referencedSymbol(e,s){let r=b.expectIdentifier(s[0],e);return b.expectEol(s[1],"a single identifier"),[{token:"num",num:this.env.referencedSymbol(r)?1:0}]}skipIdentifier(e,s){return e[s+1]?.token==="ident"?s+2:s+1}tryRunDirective(e){let s=e[0];if(s.token!=="cs")throw new Error("impossible");let r=this.runDirectives[s.str];return r?(r(e),!0):!1}evaluateConst(e){if(e=Q.traversePost(e,Q.evaluate),e.op==="num"&&!e.meta?.rel)return e.num;let s=b.at(e);throw new Error(`Expected a constant${s}`)}parseDefine(e){let s=b.expectIdentifier(e[1],e[0]),r=ot.from(e),n=this.macros.get(s);if(n instanceof ot)n.append(r);else{if(n)throw new Error(`Already defined: ${s}`);this.macros.set(s,r)}}parseUndefine(e){let[s,r,n]=e,i=b.expectIdentifier(r,s);if(b.expectEol(n),!this.macros.has(i))throw new Error(`Not defined: ${b.nameAt(r)}`);this.macros.delete(i)}parseMacro(e){let s=b.expectIdentifier(e[1],e[0]),r=at.from(e,this.stream);if(this.macros.get(s))throw new Error(`Already defined: ${s}`);this.macros.set(s,r)}parseRepeat(e){let[s,r]=Q.parse(e,1),n=e[1]||e[0];if(!s)throw new Error(`Expected expression: ${b.nameAt(n)}`);let i=this.evaluateConst(s);if(i==null)throw new Error(`Expected a constant${b.at(s)}`);let a;if(r<e.length){if(!b.eq(e[r],b.COMMA))throw new Error(`Expected comma: ${b.nameAt(e[r])}`);a=b.expectIdentifier(e[r+1]),b.expectEol(e[r+2])}let l=[],c=1;for(;c>0;)e=this.stream.next()??po(".repeat with no .endrep"),b.eq(e[0],b.REPEAT)&&c++,b.eq(e[0],b.ENDREPEAT)&&c--,b.eq(e[0],b.ENDREP)&&c--,l.push(e);this.repeats.push([l,i,-1,a]),this.parseEndRepeat(e)}parseEndRepeat(e){b.expectEol(e[1]);let s=this.repeats.pop();if(!s)throw new Error(`.endrep with no .repeat${b.at(e[0])}`);++s[2]>=s[1]||(this.repeats.push(s),this.stream.unshift(...s[0].map(r=>r.map(n=>{if(n.token!=="ident"||n.str!==s[3])return n;let i={token:"num",num:s[2]};return n.source&&(i.source=n.source),i}))))}parseIf(e){let s=1,r=!1,n=[];for(;s>0;){let i=this.stream.next();if(!i)throw new Error("EOF looking for .endif");let a=i[0];if(b.eq(a,b.ENDIF)){if(s--,!s)break}else if(a.token==="cs"&&a.str.startsWith(".if"))s++;else if(s===1&&!r){if(e&&(b.eq(a,b.ELSE)||b.eq(a,b.ELSEIF))){e=!1,r=!0;continue}else if(b.eq(a,b.ELSEIF)){e=!!this.evaluateConst(fr(i.slice(1),a));continue}else if(b.eq(a,b.ELSE)){e=!0;continue}}e&&n.push(i)}this.stream.unshift(...n)}};function lt(o,t){let e=fr(o,t);return Q.identifier(e)}function fr(o,t){if(!o.length)throw t?new Error(`Expected expression: ${b.nameAt(t)}`):new Error("Expected expression");return Q.parseOnly(o)}function xo(o){if(o)throw new Error(`garbage at end of line: ${b.nameAt(o)}`)}function jt(o,t){throw new Error(`${b.name(t)} with no ${o}${b.at(t)}`)}function po(o){throw new Error(o)}var bo=100,is=class{constructor(){this.stack=[]}next(){for(;this.stack.length;){let[t,e]=this.stack[this.stack.length-1];if(e.length)return e.pop();let s=t?.next();if(s)return s;this.stack.pop()}}unshift(...t){if(!this.stack.length)throw new Error("Cannot unshift after EOF");let e=this.stack[this.stack.length-1][1];for(let s=t.length-1;s>=0;s--)e.push(t[s])}enter(t){let e=[void 0,[]];if(t&&(e[0]=t),this.stack.push(e),this.stack.length>bo)throw new Error("Stack overflow")}exit(){this.stack.pop()}};function xr(o,t){if(!o)return-1;let e=t(0),s=t(o-1);if(e<0)return-1;if(e===0)return 0;if(s>0)return~o;if(s===0)return o-1;let r=0,n=o-1;for(;n-r>1;){let i=r+n>>1,a=t(i);if(a>0)r=i;else if(a<0)n=i;else return i}return~n}function pr(o,t,e){let s=t(e),r=xr(o.length,n=>s<t(o[n])?-1:1);o.splice(~r,0,e)}var mr=class{constructor(){this._chunks=[];this._length=0}get length(){return this._length}_find(t){return xr(this._chunks.length,e=>{let[s,r]=this._chunks[e];return t<s?-1:t>=s+r.length?1:0})}apply(t){if(t.length<this._length)throw new Error("Target too small.");for(let[e,s]of this._chunks)for(let r=0;r<s.length;r++)t[e+r]=s[r]}chunks(){return this._chunks}get(t){let e=this._find(t);if(e<0)return;let[s,r]=this._chunks[e];return r[t-s]}set(t,...e){this.setInternal(t,e)}setInternal(t,e){if(!e.length)return;let s=t+e.length;this._length=Math.max(this._length,s);let r=this._find(t),n=this._find(s);if(r>=0&&r===n){let[c,h]=this._chunks[r];for(let u=0;u<e.length;u++)h[t+u-c]=e[u];return}let i=this._chunks[~r-1];if(i&&i[0]+i[1].length===t&&(r=~r-1),this._chunks[~n]?.[0]===s&&(n=~n),r>=0){let[c,h]=this._chunks[r];n!==r||!Array.isArray(e)?e=go(h,t-c,e):e.unshift(...h.slice(0,t-c)),t=c}if(n>=0){let[c,h]=this._chunks[n];e=yo(e,s-c,h)}let a=r<0?~r:r,l=n<0?~n:n;n>=0&&l++,Array.isArray(e)||(e=Array.from(e)),this._chunks.splice(a,l-a,[t,e])}splice(t,e=1){let s=t+e,r=this._find(t),n=this._find(s),i=r>=0?this._chunks[r]:void 0,a=n>=0?this._chunks[n]:void 0;if(i){let u=t-i[0];u?i=[i[0],i===a?i[1].slice(0,u):vn(i[1],u)]:(i=void 0,r=~r)}a&&(a=[s,Tn(a[1],s-a[0])],a[1].length||(a=void 0,n=~n));let l=[];i&&l.push(i),a&&l.push(a);let c=r<0?~r:r,h=n<0?~n:n;n>=0&&h++,this._chunks.splice(c,h-c,...l)}slice(t,e){if(e<=t)return[];let s=this._find(t);if(s<0)throw new Error(`Absent: ${t}`);let[r,n]=this._chunks[s];if(r+n.length<e)throw new Error(`Absent: ${r+n.length}`);return n.slice(t-r,e-r)}},tt=class extends mr{set(t,...e){this.setInternal(t,e[0]instanceof Uint8Array?e[0]:Uint8Array.from(e))}search(t,e,s){return this.pattern(t).search(e,s)}pattern(t){if(!t.length)return{search:(l=0)=>l};let e=t.length,s=new Array(256).fill(e);for(let l=0;l<t.length;l++)s[t[l]]=e-1-l;let r=[],n=e;for(let l=e;l>0;--l){i(l)&&(n=l),r[e-l]=n-l+e;for(let c=0;c<e-1;++c){let h=a(c);r[h]=e-1-c+h}}return{search:(l=0,c=this._length)=>{if(!this._chunks.length||c<l)return-1;let h=this._find(l),u=0;for(h>=0?u=l-this._chunks[h][0]:h=~h;h<this._chunks.length;){let[m,f]=this._chunks[h++],S=Math.min(c-m,f.length);if(S<0)break;for(let v=e-1+u,k;v<S;){for(k=e-1;t[k]===f[v];--v,--k)if(k===0)return v+m;v+=Math.max(r[e-1-k],s[f[v]])}u=0}return-1}};function i(l){for(let c=l,h=0;c<e;++c,++h)if(t[c]!==t[h])return!1;return!0}function a(l){let c=0;for(let h=l,u=e-1;h>=0&&t[h]===t[u];--h,--u)++c;return c}}addOffset(t){let e=new tt;for(let[s,r]of this._chunks)e._chunks.push([s+t,r]);return e}toIpsPatch(){let t=8;for(let[,r]of this._chunks)t+=5+r.length;let e=new Uint8Array(t),s=5;e[0]=80,e[1]=65,e[2]=84,e[3]=67,e[4]=72;for(let[r,n]of this._chunks){if(n.length>65535)throw new Error("Oops!");e[s++]=r>>>16,e[s++]=r>>>8&255,e[s++]=r&255,e[s++]=n.length>>>8,e[s++]=n.length&255,e.subarray(s,s+n.length).set(n),s+=n.length}return e[s]=69,e[s+1]=79,e[s+2]=70,e}toIpsHexString(){let t=[...this.toIpsPatch()],e=[];for(let s=0;s<t.length;s+=16)e.push([s.toString(16).padStart(8,"0")+":",...t.slice(s,s+16).map(r=>r.toString(16).padStart(2,"0"))].join(" "));return e.join(`
`)}};function go(o,t,e){let s=o.length;return e.length<s||!Array.isArray(e)?(o.splice(t,s-t,...e),o):(e.unshift(...vn(o,t)),e)}function yo(o,t,e){let s=e.length;return o.length<s||!Array.isArray(o)?(e.splice(0,t,...o),e):(o.push(...Tn(e,t)),o)}function vn(o,t){let e=o.length;return t<<1<e?o.slice(0,t):(o.splice(t,e-t),o)}function Tn(o,t){let e=o.length;return t<<1<e?(o.splice(0,t),o):o.slice(t)}var os=class{constructor(){this.data=[]}[Symbol.iterator](){return this.data[Symbol.iterator]()}_find(t){return xr(this.data.length,e=>{let s=this.data[e];return t<s[0]?-1:t>=s[1]?1:0})}has(t){return this._find(t)>=0}add(t,e){let s=this._find(t),r=this._find(e);this.data[~s-1]?.[1]===t&&(s=~s-1),this.data[~r]?.[0]===e&&(r=~r);let n=[t,e];s>=0&&(n[0]=this.data[s][0]),r>=0&&(n[1]=this.data[r][1]);let i=s<0?~s:s,a=r<0?~r:r;r>=0&&a++,this.data.splice(i,a-i,n)}delete(t,e){let s=this._find(t),r=this._find(e),n=s>=0?this.data[s]:void 0,i=r>=0?this.data[r]:void 0;n&&(n=[n[0],Math.min(n[1],t)],n[0]===n[1]&&(n=void 0,s=~s)),i&&(i=[Math.max(i[0],e),i[1]],i[0]===i[1]&&(i=void 0,r=~r));let a=[];n&&a.push(n),i&&a.push(i);let l=s<0?~s:s,c=r<0?~r:r;r>=0&&c++,this.data.splice(l,c-l,...a)}tail(t){let e=this._find(t);e<0&&(e=~e);let s=this.data;return{[Symbol.iterator](){return this},next(){if(e>=s.length)return{value:void 0,done:!0};let r=s[e++];return{value:[Math.max(t,r[0]),r[1]],done:!1}}}}};var xt=class{constructor(){this._link=new wr}static assemble(t){let e=new Mt(t,"contents.s",{lineContinuations:!0}),s=new Ct(Lt.P02),r=new is;r.enter(e);let n=new ns(r,s);s.tokens(n);let i=new xt;i.read(s.module());let a=i.link(),l=new Uint8Array(a.length);return a.apply(l),l}static link(...t){let e=new xt;for(let s of t)e.read(s);return e.link()}read(t){return this._link.readFile(t),this}base(t,e=0){return this._link.base(t,e),this}link(){return this._link.link()}report(t=!1){console.log(this._link.report(t))}exports(){return this._exports?this._exports:this._exports=this._link.buildExports()}watch(...t){this._link.watches.push(...t)}};function qt(o){throw new Error(o)}var gr=class{constructor(t){let e=this.name=t.name;this.bank=t.bank??0,this.addressing=t.addressing??2,this.size=t.size??qt(`Size must be specified: ${e}`),this.offset=t.offset??qt(`OFfset must be specified: ${e}`),this.memory=t.memory??qt(`OFfset must be specified: ${e}`)}get delta(){return this.offset-this.memory}},yr=class{constructor(t,e,s,r,n){this.linker=t;this.index=e;this.subs=new Set;this.selfSubs=new Set;this.deps=new Set;this.imports=new Set;this.follow=new Map;this.overlaps=!1;this.name=s.name,this.size=s.data.length,this.segments=s.segments,this._data=s.data;for(let i of s.subs||[])this.subs.add(wo(i,r,n));this.asserts=(s.asserts||[]).map(i=>as(i,r,n)),s.org&&(this._org=s.org)}get org(){return this._org}get offset(){return this._offset}get segment(){return this._segment}get data(){return this._data??qt("no data")}initialPlacement(){if(this._org==null)return;let t=[];for(let s of this.segments){let r=this.linker.segments.get(s);if(!r)throw new Error(`Unknown segment: ${s}`);this._org>=r.memory&&this._org<r.memory+r.size&&t.push(r)}if(t.length!==1)throw new Error(`Non-unique segment for ${this.name}:
Segments: ${this.segments.join(",")}, org: $${this.org?.toString(16)}, offset: $${this.offset?.toString(16)}
Eligible: [${t}]`);let e=t[0];if(this._org>=e.memory+e.size)throw new Error(`Chunk does not fit in segment ${e.name}`);this.place(this._org,e)}place(t,e){this._org=t,this._segment=e;let s=this._offset=t+e.delta;for(let i of this.linker.watches)if(i>=s&&i<s+this.size)debugger;pr(this.linker.placed,i=>i[0],[s,this]);let r=this.linker.data,n=this._data??qt("No data");if(this._data=void 0,this.subs.size){r.splice(s,n.length);let i=new tt;i.set(0,n);for(let a of this.subs)i.splice(a.offset,a.size);for(let[a,l]of i.chunks())r.set(s+a,...l)}else r.set(s,n);for(let[i,a]of this.follow)a.resolveSub(i,!1);this.linker.free.delete(this.offset,this.offset+this.size)}resolveSubs(t=!1){for(let e of this.selfSubs)this.resolveSub(e,t);for(let e of this.subs)this.resolveSub(e,t)}addDep(t,e){e===this.index&&this.subs.delete(t)&&this.selfSubs.add(t),this.linker.chunks[e].follow.set(t,this),this.deps.add(e)}resolveSub(t,e){if(!this.subs.has(t)&&!this.selfSubs.has(t))return;t.expr=Q.traverse(t.expr,(r,n,i)=>e&&i?.op==="^"&&i.args.length===1&&r.meta?(r.meta.bank==null&&this.addDep(t,r.meta.chunk),r):(r=this.linker.resolveLink(Q.evaluate(n(r))),e&&r.meta?.rel&&this.addDep(t,r.meta.chunk),r));let s=!1;if(t.expr.op==="num"&&!t.expr.meta?.rel)this.writeValue(t.offset,t.expr.num,t.size),s=!0;else if(t.expr.op===".move"){if(t.expr.args.length!==1)throw new Error("bad .move");let r=t.expr.args[0];if(r.op==="num"&&r.meta?.offset!=null){let n=r.meta.offset-(r.meta.rel?0:r.meta.org),i=r.num+n,a=this.linker.orig.slice(i,i+t.size);this.writeBytes(t.offset,Uint8Array.from(a)),s=!0}}s&&(this.subs.delete(t)||this.selfSubs.delete(t),this.subs.size||this.linker.unresolvedChunks.delete(this)&&this.linker.insertResolved(this))}writeBytes(t,e){if(this._data)this._data.subarray(t,t+e.length).set(e);else if(this._offset!=null)this.linker.data.set(this._offset+t,e);else throw new Error("Impossible")}writeValue(t,e,s){let r=s<<3;if(e!=null&&(e<-1<<r||e>=1<<r)){let i=["byte","word","farword","dword"][s-1];throw new Error(`Not a ${i}: $${e.toString(16)} at $${(this.org+t).toString(16)}`)}let n=new Uint8Array(s);for(let i=0;i<s;i++)n[i]=e&255,e>>=8;this.writeBytes(t,n)}};function wo(o,t,e){return o={...o},o.expr=as(o.expr,t,e),o}function as(o,t,e){return o={...o},o.meta&&(o.meta={...o.meta}),o.args&&(o.args=o.args.map(s=>as(s,t,e))),o.meta?.chunk!=null&&(o.meta.chunk+=t),o.op==="sym"&&o.num!=null&&(o.num+=e),o}function So(o,t,e){return o={...o},o.expr&&(o.expr=as(o.expr,t,e)),o}var wr=class{constructor(){this.data=new tt;this.orig=new tt;this.exports=new Map;this.chunks=[];this.symbols=[];this.free=new os;this.rawSegments=new Map;this.segments=new Map;this.resolvedChunks=[];this.unresolvedChunks=new Set;this.watches=[];this.placed=[];this.initialReport=""}insertResolved(t){pr(this.resolvedChunks,e=>e.size,t)}base(t,e=0){this.data.set(e,t),this.orig.set(e,t)}readFile(t){let e=this.chunks.length,s=this.symbols.length;for(let r of t.segments||[])this.addRawSegment(r);for(let r of t.chunks||[]){let n=new yr(this,this.chunks.length,r,e,s);this.chunks.push(n)}for(let r of t.symbols||[])this.symbols.push(So(r,e,s))}resolveLink(t){if(t.op===".orig"&&t.args?.length===1){let e=t.args[0],s=e.meta?.offset;if(s!=null){let r=this.orig.get(s+e.num);if(r!=null)return{op:"num",num:r}}}else if(t.op==="num"&&t.meta?.chunk!=null){let e=t.meta,s=this.chunks[e.chunk];if(s.org!==e.org||s.segment?.bank!==e.bank||s.offset!==e.offset){let r={org:s.org,offset:s.offset,bank:s.segment?.bank};t=Q.evaluate({...t,meta:{...e,...r}})}}return t}resolveExpr(t){if(t=Q.traverse(t,(s,r)=>this.resolveLink(Q.evaluate(r(s)))),t.op==="num"&&!t.meta?.rel)return t.num;let e=b.at(t);throw new Error(`Unable to fully resolve expr${e}`)}link(){for(let[r,n]of this.rawSegments){let i=n[0];for(let a=1;a<n.length;a++)i=Rt.merge(i,n[a]);this.segments.set(r,new gr(i))}for(let[r,n]of this.rawSegments){let i=this.segments.get(r);for(let a of n){let l=a.free;for(let[c,h]of l||[])this.free.add(c+i.delta,h+i.delta),this.data.splice(c+i.delta,h-c)}}for(let r of this.chunks)r.initialPlacement();br&&(this.initialReport=`Initial:
${this.report(!0)}`);for(let r=0;r<this.symbols.length;r++){let n=this.symbols[r];if(!n.expr)throw new Error(`Symbol ${r} never resolved`);n.export!=null&&this.exports.set(n.export,r)}for(let r of this.symbols)r.expr=this.resolveSymbols(r.expr);for(let r of this.chunks){for(let n of[...r.subs,...r.selfSubs])n.expr=this.resolveSymbols(n.expr);for(let n=0;n<r.asserts.length;n++)r.asserts[n]=this.resolveSymbols(r.asserts[n])}for(let r of this.chunks)r.resolveSubs(!0);let t=[...this.chunks];t.sort((r,n)=>n.size-r.size);for(let r of t)r.resolveSubs(),r.subs.size?this.unresolvedChunks.add(r):this.insertResolved(r);let e=this.resolvedChunks.length+2*this.unresolvedChunks.size;for(;e;){let r=this.resolvedChunks.pop();if(r)this.placeChunk(r);else{let[i]=this.unresolvedChunks;for(let a of i.deps){let l=this.chunks[a];l.org==null&&this.placeChunk(l)}}let n=this.resolvedChunks.length+2*this.unresolvedChunks.size;if(n===e)throw console.error(this.resolvedChunks,this.unresolvedChunks),new Error("Not making progress");e=n}let s=new tt;for(let r of this.chunks){for(let n of r.asserts){if(this.resolveExpr(n))continue;let a=b.at(n);throw new Error(`Assertion failed${a}`)}r.overlaps||s.set(r.offset,...this.data.slice(r.offset,r.offset+r.size))}return br&&console.log(this.report(!0)),s}placeChunk(t){if(t.org!=null)return;let e=t.size;if(!t.subs.size&&!t.selfSubs.size){let r=this.data.pattern(t.data);for(let n of t.segments){let i=this.segments.get(n),a=i.offset,l=a+i.size,c=r.search(a,l);if(!(c<0)){t.place(c-i.delta,i),t.overlaps=!0;return}}}for(let r of t.segments){let n=this.segments.get(r),i=n.offset,a=i+n.size,l,c=1/0;for(let[h,u]of this.free.tail(i)){if(h>=a)break;let m=Math.min(u,a)-h;m<e||m<c&&(l=h,c=m)}if(l!=null){t.place(l-n.delta,n);return}}br&&console.log(`Initial:
${this.initialReport}`),console.log(`After filling:
${this.report(!0)}`);let s=t.name?`${t.name} `:"";throw console.log(this.segments.get(t.segments[0])),new Error(`Could not find space for ${e}-byte chunk ${s}in ${t.segments.join(", ")}`)}resolveSymbols(t){return Q.traverse(t,(e,s)=>{for(;e.op==="im"||e.op==="sym";)if(e.op==="im"){let r=e.sym,n=this.exports.get(r);if(n==null){let i=b.at(t);throw new Error(`Symbol never exported ${r}${i}`)}e=this.symbols[n].expr}else{if(e.num==null)throw new Error("Symbol not global");e=this.symbols[e.num].expr}return Q.evaluate(s(e))})}addRawSegment(t){let e=this.rawSegments.get(t.name);e||this.rawSegments.set(t.name,e=[]),e.push(t)}buildExports(){let t=new Map;for(let e of this.symbols){if(!e.export)continue;let s=Q.traverse(e.expr,(i,a)=>this.resolveLink(Q.evaluate(a(i))));if(s.op!=="num")throw new Error(`never resolved: ${e.export}`);let r=s.num,n={value:r};s.meta?.offset!=null&&s.meta.org!=null&&(n.offset=s.meta.offset+r-s.meta.org),s.meta?.bank!=null&&(n.bank=s.meta.bank),t.set(e.export,n)}return t}report(t=!1){let e="";for(let[s,r]of this.free)e+=`Free: ${s.toString(16)}..${r.toString(16)}: ${r-s} bytes
`;if(t)for(let[s,r]of this.placed){let n=r.name??`Chunk ${r.index}`,i=r.offset+r.size;e+=`${s.toString(16).padStart(5,"0")} .. ${i.toString(16).padStart(5,"0")}: ${n} (${i-s} bytes)
`}return e}},br=!1;var K=class{constructor(t,e){this.rom=t;this.id=e}write(){return[]}toString(){return`${this.constructor.name} $${L(this.id)}`}},Ce=class extends Array{static get[Symbol.species](){return Array}};var ls=class extends K{constructor(e,s){super(e,s);this.data=U(e.prg,this.base,4)}get base(){return(this.id<<2)+171008}get slotRangeLower(){return this.data[0]}set slotRangeLower(e){this.data[0]=e}get slotRangeUpper(){return this.data[1]}set slotRangeUpper(e){this.data[1]=e}get objectId(){return this.data[2]}set objectId(e){this.data[2]=e}get count(){return this.data[3]}set count(e){this.data[3]=e}write(){let e=this.rom.assembler();return e.segment("14"),e.org(39936+(this.id<<2)),e.byte(...this.data),[e.module()]}};var cs=class extends K{constructor(e,s){super(e,s);this.base=ne(e.prg,this.pointer),this.data=e.prg.slice(this.base+81920,this.base+81941),this.palettes=this.data.subarray(5,13),this.patterns=this.data.subarray(13,19)}get pointer(){return 129387+2*this.id}get routine(){let e=ne(this.data,0);return e&&e+81920}set routine(e){Vr(this.data,0,e?e-81920:0)}get restoreMusic(){return this.data[3]}set restoreMusic(e){this.data[3]=e}get itemDrop(){return this.data[4]}set itemDrop(e){this.data[4]=e}get restoreAnimation(){return this.data[19]}set restoreAnimation(e){this.data[19]=e}get explode(){return!!this.data[20]}set explode(e){this.data[20]=e?1:0}write(){if(!this.base)return[];let e=this.rom.assembler();return e.segment("0f"),e.org(this.base),e.byte(this.data[0],this.data[1]),e.org(this.base+4),e.byte(this.data[4]),[e.module()]}};var vo=!0;function dc(){if(vo)throw new Error("impossible")}function En(o){throw new Error(o)}var{$0f:ct,$1b:To}=G,ds=class{constructor(t){this.rom=t;this.Vampire1=new ye(this,{flag:this.rom.flags.Vampire1,kill:0,npc:this.rom.npcs.Vampire1,shuffled:!0,sword:1});this.Insect=new ye(this,{flag:this.rom.flags.GiantInsect,kill:1,npc:this.rom.npcs.Insect,sword:1});this.Kelbesque1=new ye(this,{flag:this.rom.flags.Kelbesque1,kill:2,npc:this.rom.npcs.Kelbesque1,shuffled:!0});this.Rage=new ye(this,{flag:this.rom.flags.Rage,kill:3,npc:this.rom.npcs.Rage});this.Sabera1=new ye(this,{address:222574,flag:this.rom.flags.Sabera1,kill:4,npc:this.rom.npcs.SaberaDisguisedAsMesia,shuffled:!0});this.Vampire2=new ye(this,{flag:this.rom.flags.Vampire2,kill:12,npc:this.rom.npcs.Vampire2,shuffled:!0,sword:1});this.Mado1=new ye(this,{address:514080,flag:this.rom.flags.Mado1,kill:5,shuffled:!0});this.Kelbesque2=new ye(this,{flag:this.rom.flags.Kelbesque2,kill:6,npc:this.rom.npcs.Kelbesque2,shuffled:!0});this.Sabera2=new ye(this,{flag:this.rom.flags.Sabera2,kill:7,npc:this.rom.npcs.Sabera2,shuffled:!0});this.Mado2=new ye(this,{flag:this.rom.flags.Mado2,kill:8,npc:this.rom.npcs.Mado2,shuffled:!0});this.Karmine=new ye(this,{flag:this.rom.flags.Karmine,kill:9,npc:this.rom.npcs.Karmine,shuffled:!0,sword:2});this.Draygon1=new ye(this,{flag:this.rom.flags.Draygon1,kill:10,npc:this.rom.npcs.Draygon,shuffled:!0,sword:2});this.StatueOfMoon=new ye(this,{flag:this.rom.flags.UsedBowOfMoon,npc:this.rom.npcs.StatueOfMoon});this.StatueOfSun=new ye(this,{flag:this.rom.flags.UsedBowOfSun,npc:this.rom.npcs.StatueOfSun});this.Draygon2=new ye(this,{flag:this.rom.flags.Draygon2,kill:11,npc:this.rom.npcs.Draygon});this.Dyna=new ye(this,{kill:13,object:164});this.musics=[new Ge(ct,42168,[this.Vampire1,this.Vampire2]),new Ge(ct,42640,[this.Insect]),new Ge(ct,43419,[this.Kelbesque1,this.Kelbesque2]),new Ge(ct,44209,[this.Sabera1,this.Sabera2]),new Ge(ct,44559,[this.Mado1,this.Mado2]),new Ge(ct,44931,[this.Karmine]),new Ge(ct,45447,[this.Draygon1]),new Ge(ct,45841,[this.Draygon2]),new Ge(To,48176,[this.Dyna])];this.all=[];for(let e in this){if(!this.hasOwnProperty(e))continue;let s=this[e];s instanceof ye&&(s.name=Qe(e),this.all.push(s))}}isBossFlag(t){return(this.flags||(this.flags=(()=>{let s=new Set;for(let r of this.all)r.flag!=null&&s.add(r.flag.id);return s})())).has(t)}fromLocation(t){return this.all.find(e=>e.location===t)}fromBossKill(t){return this.all.find(e=>e.kill===t)}fromObject(t){return this.all.find(e=>e.object===t)}[Symbol.iterator](){return this.all[Symbol.iterator]()}write(){let t=this.rom.assembler();for(let e of this.musics)e.addr.loc(t),t.byte(e.bgm);return[t.module()]}},Ge=class{constructor(t,e,s){this.bosses=s;this.addr=j.of(t,e);let r=s[0].bosses.rom;this.bgm=this.addr.read(r.prg)}},ye=class{constructor(t,{flag:e,npc:s,kill:r,shuffled:n,address:i,sword:a=3,object:l}){this.bosses=t;let{prg:c}=t.rom;if(this.flag=e,this.npc=s,this.object=i?c[i]:s?s.data[1]:l??En("address, npc, or object is required"),this.swordLevel=a,this.shuffled=Boolean(n),this.kill=r,r!=null){let h=81920+ne(c,129387+2*r),u=c[h+4];u!==255&&(this.drop=u),this.location=c[129373+r]}}};var hs=class{constructor(t){this.rom=t;this.values=U(t.prg,_n.offset,Eo)}write(){let t=this.rom.assembler();return _n.loc(t),t.word(...this.values),[t.module()]}},_n=j.of(G.$1a,35806),Eo=16;var _o=!1,bt=Symbol(),Sr={assumeFalse:!0},kn={assumeTrue:!0},re={track:!0},fs={},pt=class{constructor(t,e,s,r){this.flags=t;this.name=e;this.id=s;this.fixed=r.fixed||!1,this.obsolete=r.obsolete,this.logic=r.logic??re}get c(){return this.id}get r(){return[[this.id]]}get debug(){return this.id.toString(16).padStart(3,"0")+" "+this.name}get item(){if(this.id<256||this.id>383)throw new Error(`not a slot: ${this.id}`);let t=this.flags.rom.slots[this.id&255],e=this.flags.rom.itemGets[t].itemId,s=this.flags.rom.items[e];if(!s)throw new Error("no item");return s}};function _(o){return typeof o=="number"&&(o=(t=>()=>t)(o)),{obsolete:o,[bt]:!0}}function le(o,t=fs){return{id:o,fixed:!0,[bt]:!0,logic:t}}function g(o){return le(o,re)}function ee(o,t=fs){return{id:o,[bt]:!0,logic:t}}function Z(o,t=fs){return{name:o,[bt]:!0,logic:t}}function Ne(o,t=fs){return{name:o,[bt]:!0,logic:t}}function we(o){let t=Ln.get(o)||1024;return Ln.set(o,t+1),{id:t,[bt]:!0,logic:re}}var Ln=new WeakMap,us=class{constructor(t){this.rom=t;this[0]=le(0,Sr);this[1]=le(1);this[2]=le(2);this[3]=le(3);this[4]=le(4);this[5]=le(5);this[6]=le(6);this[7]=le(7);this[8]=le(8);this[9]=le(9);this.UsedWindmillKey=le(10,re);this[11]=_(256);this[12]=Ne("Leaf villager");this.LeafVillagersRescued=ee(13);this[14]=_(t=>t.trigger?.id===133?323:579);this.WokeWindmillGuard=ee(15,re);this.TurnedInKirisaPlant=ee(16);this[17]=Z("Welcomed to Amazones");this[18]=Z("Treasure hunter dead");this[19]=_(312);this[22]=Z("Portoa queen Rage hint");this[23]=_(258);this.EnteredUndergroundChannel=ee(24,re);this[25]=Ne("Portoa queen tired of talking");this[26]=Z("Initial talk with Portoa queen");this.MesiaRecording=ee(27,re);this[28]=_(272);this.TalkedToFortuneTeller=ee(29,re);this.QueenRevealed=ee(30,re);this[31]=_(265);this.QueenNotInThroneRoom=ee(32,re);this.ReturnedFogLamp=ee(33,re);this[34]=Z("Sahara elder");this[35]=Z("Sahara elder daughter");this[36]=_(317);this[37]=_(310);this[38]=_(765);this.ShyronMassacre=le(39,re);this.ChangeWoman=le(40);this.ChangeAkahana=le(41);this.ChangeSoldier=le(42);this.ChangeStom=le(43);this[45]=Z("Shyron sages");this[46]=_(301);this.UsedBowOfTruth=le(47);this[49]=Z("Zombie town");this[50]=_(311);this[52]=Z("Akahana in waterfall cave");this.CuredAkahana=ee(53,re);this[54]=Z("Akahana Shyron");this[55]=_(322);this.LeafAbduction=ee(56,re);this[57]=_(321);this.TalkedToZebuInCave=ee(58,re);this.TalkedToZebuInShyron=ee(59,re);this[60]=_(315);this[61]=Z("Asina in Shyron temple");this.FoundKensuInDanceHall=ee(62,re);this[63]=_(t=>t.trigger?.id===186?580:324);this[64]=Z("Tornel in Shyron temple");this[65]=_(263);this[68]=_(263);this.RescuedChild=le(69,re);this.UsedInsectFlute=le(70);this.RescuedLeafElder=ee(71);this[72]=Z("Treasure hunter embarked");this[73]=_(257);this[74]=Z("Boat owner");this[75]=Ne("Shyron sick men");this[76]=Ne("Shyron training men 1");this[77]=Ne("Shyron training men 2");this[78]=_(262);this[79]=_(299);this.GivenStatueToAkahana=ee(80);this[81]=_(326);this.TalkedToDwarfMother=ee(82,re);this.LeadingChild=le(83,re);this[85]=Z("Zebu rescued");this[86]=Z("Tornel rescued");this[87]=Z("Asina rescued");this.MtSabreGuardsDespawned=ee(91,kn);this[94]=_(653);this[95]=_(515);this.TalkedToStomInSwan=ee(97,re);this[98]=_(337);this[99]=_(327);this.CuredKensu=ee(101,re);this[103]=_(267);this[104]=_(260);this.StonedPeopleCured=ee(106,re);this[108]=_(284);this.CurrentlyRidingDolphin=le(-111,re);this.ParalyzedKensuInTavern=le(112);this.ParalyzedKensuInDanceHall=le(113);this.FoundKensuInTavern=ee(114,re);this[115]=Z("Startled man in Leaf");this[117]=_(313);this[118]=Z("Kensu in Goa");this[119]=_(264);this[120]=_(268);this[121]=_(320);this[122]=_(266);this[123]=_(265);this[125]=_(319);this[126]=Z("Mt Sabre guards 1");this[127]=Z("Mt Sabre guards 2");this.AlarmFluteUsedOnce=le(118);this.FluteOfLimeUsedOnce=le(119);this[130]=_(320);this[131]=Z("Rescued Leaf elder");this.LeafVillagersCurrentlyAbducted=ee(132);this.LeafElderCurrentlyAbducted=ee(133);this[135]=_(261);this[136]=_(306);this[137]=Z("Dead Stom's girlfriend");this[138]=Z("Dead Stom");this[139]=_(566);this[141]=_(311);this[143]=_(643);this[144]=Z("Stoned people gone");this[146]=_(296);this[150]=Ne("Leaf elder daughter");this[151]=Ne("Leaf villager");this[152]=Z("Nadare villager");this.AbleToRideDolphin=ee(155,re);this.PortoaQueenGoingAway=ee(156);this[160]=_(295);this[163]=Ne("Portoa queen/fortune teller");this.WokeKensuInLighthouse=ee(164,re);this[165]=_(305);this[166]=Z("Oak elder 1",Sr);this[167]=Ne("Swan dancer");this[168]=Z("Oak elder 2",Sr);this.TalkedToLeafRabbit=ee(169,re);this[170]=_(285);this[171]=_(336);this[173]=_(338);this[174]=_(339);this[175]=_(340);this[176]=_(341);this[177]=_(342);this[178]=_(343);this[179]=_(344);this[180]=_(345);this[181]=_(346);this[182]=_(287);this[183]=_(348);this[184]=_(349);this[185]=_(286);this[186]=_(350);this[187]=_(351);this[188]=_(352);this[189]=_(288);this[190]=_(289);this[191]=_(354);this[192]=_(355);this[193]=_(356);this[194]=_(290);this[195]=_(357);this[196]=_(358);this[197]=_(363);this[198]=_(364);this[199]=_(291);this[200]=_(292);this[201]=_(362);this[202]=_(317);this[203]=_(298);this[204]=_(284);this[205]=_(276);this[206]=_(293);this[207]=_(307);this[208]=_(296);this[209]=_(309);this[210]=_(361);this[211]=_(294);this[212]=_(347);this[213]=Ne("Portoa queen 1");this[214]=Ne("Portoa queen 2");this[215]=Ne("Portoa queen 3");this[216]=Z("Kensu rescued");this[217]=Ne("Stoned pair");this[218]=Z("Kensu gone from tavern");this[219]=Ne("In Sabera's trap");this[220]=_(367);this[221]=_(368);this[222]=_(300);this[223]=_(283);this[224]=Z("Dead Akahana");this[228]=_(316);this[229]=_(366);this[230]=_(365);this[231]=_(303);this[232]=Z("Dead Shyron villager");this[233]=Z("Dead Shyron guard");this[234]=Z("Tower message 1");this[235]=Z("Tower message 2");this[236]=Z("Tower message 3");this[237]=Z("Mesia");this.TalkedToZebuStudent=ee(238,re);this[256]=_(302);this[257]=_(263);this[258]=_(264);this[259]=_(265);this[261]=_(294);this[262]=_(291);this[263]=_(274);this[264]=_(317);this.UsedBowOfMoon=ee(265);this.UsedBowOfSun=ee(266);this[267]=_(284);this[268]=_(353);this.LeafElder=g(-257);this.OakElder=g(-258);this.WaterfallCaveSwordOfWaterChest=g(-259);this.StxyLeftUpperSwordOfThunderChest=g(-260);this.MesiaInTower=g(260);this.SealedCaveBallOfWindChest=g(-262);this.MtSabreWestTornadoBraceletChest=g(-263);this.GiantInsect=g(-264);this.Kelbesque1=g(-265);this.Rage=g(-266);this.AryllisBasementChest=g(-267);this.Mado1=g(-268);this.StormBraceletChest=g(-269);this.WaterfallCaveRiverLeftChest=g(272);this.Mado2=g(274);this.StxyRightMiddleChest=g(276);this.BattleArmorChest=g(283);this.Draygon1=g(284);this.SealedCaveSmallRoomBackChest=g(285);this.SealedCaveBigRoomNortheastChest=g(286);this.FogLampCaveFrontChest=g(287);this.MtHydraRightChest=g(288);this.SaberaUpstairsLeftChest=g(289);this.EvilSpiritIslandLowerChest=g(290);this.Sabera2=g(291);this.SealedCaveSmallRoomFrontChest=g(292);this.CordelGrass=g(293);this.Kelbesque2=g(294);this.OakMother=g(295);this.PortoaQueen=g(296);this.AkahanaStatueOfOnyxTradein=g(297);this.OasisCaveFortressBasementChest=g(298);this.Brokahana=g(299);this.EvilSpiritIslandRiverLeftChest=g(300);this.Deo=g(301);this.Vampire1=g(302);this.OasisCaveNorthwestChest=g(303);this.AkahanaFluteOfLimeTradein=g(304);this.ZebuStudent=g(305);this.WindmillGuardAlarmFluteTradein=g(306);this.MtSabreNorthBackOfPrisonChest=g(307);this.ZebuInShyron=g(308);this.FogLampCaveBackChest=g(309);this.InjuredDolphin=g(310);this.Clark=g(311);this.Sabera1=g(312);this.KensuInLighthouse=g(313);this.RepairedStatue=g(314);this.UndergroundChannelUnderwaterChest=g(315);this.KirisaMeadow=g(316);this.Karmine=g(317);this.Aryllis=g(318);this.MtHydraSummitChest=g(319);this.AztecaInPyramid=g(320);this.ZebuAtWindmill=g(321);this.MtSabreNorthSummit=g(322);this.StomFightReward=g(323);this.MtSabreWestTornel=g(324);this.AsinaInBackRoom=g(325);this.BehindWhirlpool=g(326);this.KensuInSwan=g(327);this.SlimedKensu=g(328);this.MezameShrineLeftChest=g(329);this.SealedCaveBigRoomSouthwestChest=g(336);this.MtSabreWestRightChest=g(338);this.MtSabreNorthMiddleChest=g(339);this.FortressMadoHellwayChest=g(340);this.SaberaUpstairsRightChest=g(341);this.MtHydraFarLeftChest=g(342);this.StxyLeftLowerChest=g(343);this.KarmineBasementLowerMiddleChest=g(344);this.EastCaveNortheastChest=g(345);this.OasisCaveEntranceAcrossRiverChest=g(346);this.EvilSpiritIslandExitChest=g(348);this.FortressSaberaMiddleChest=g(349);this.MtSabreNorthUnderBridgeChest=g(350);this.KirisaPlantCaveChest=g(351);this.FortressMadoUpperNorthChest=g(352);this.Vampire2=g(353);this.FortressSaberaNorthwestChest=g(354);this.FortressMadoLowerCenterNorthChest=g(355);this.OasisCaveNearEntranceChest=g(356);this.MtHydraLeftRightChest=g(357);this.FortressSaberaSoutheastChest=g(358);this.KensuInCabin=g(359);this.MtSabreWestNearKensuChest=g(361);this.MtSabreWestLeftChest=g(362);this.FortressMadoUpperBehindWallChest=g(363);this.PyramidChest=g(364);this.CryptRightChest=g(365);this.KarmineBasementLowerLeftChest=g(366);this.FortressMadoLowerSoutheastChest=g(367);this.FogLampCaveMiddleNorthMimic=g(368);this.FogLampCaveMiddleSouthwestMimic=g(369);this.WaterfallCaveFrontMimic=g(370);this.EvilSpiritIslandRiverRightMimic=g(371);this.MtHydraFinalCaveMimic=g(372);this.StxyLeftNorthMimic=g(373);this.StxyRightNorthMimic=g(374);this.StxyRightSouthMimic=g(375);this.CryptLeftPitMimic=g(376);this.KarmineBasementUpperMiddleMimic=g(377);this.KarmineBasementUpperRightMimic=g(378);this.KarmineBasementLowerRightMimic=g(379);this.EastCaveNorthwestMimic=g(380);this.SwordOfWind=g(512);this.SwordOfFire=g(513);this.SwordOfWater=g(514);this.SwordOfThunder=g(515);this.Crystalis=g(516);this.BallOfWind=g(517);this.TornadoBracelet=g(518);this.BallOfFire=g(519);this.FlameBracelet=g(520);this.BallOfWater=g(521);this.BlizzardBracelet=g(522);this.BallOfThunder=g(523);this.StormBracelet=g(524);this.CarapaceShield=g(525);this.BronzeShield=g(526);this.PlatinumShield=g(527);this.MirroredShield=g(528);this.CeramicShield=g(529);this.SacredShield=g(530);this.BattleShield=g(531);this.PsychoShield=g(532);this.TannedHide=g(533);this.LeatherArmor=g(534);this.BronzeArmor=g(535);this.PlatinumArmor=g(536);this.SoldierSuit=g(537);this.CeramicSuit=g(538);this.BattleArmor=g(539);this.PsychoArmor=g(540);this.MedicalHerb=g(541);this.Antidote=g(542);this.LysisPlant=g(543);this.FruitOfLime=g(544);this.FruitOfPower=g(545);this.MagicRing=g(546);this.FruitOfRepun=g(547);this.WarpBoots=g(548);this.StatueOfOnyx=g(549);this.OpelStatue=g(550);this.InsectFlute=g(551);this.FluteOfLime=g(552);this.GasMask=g(553);this.PowerRing=g(554);this.WarriorRing=g(555);this.IronNecklace=g(556);this.DeosPendant=g(557);this.RabbitBoots=g(558);this.LeatherBoots=g(559);this.ShieldRing=g(560);this.AlarmFlute=g(561);this.WindmillKey=g(562);this.KeyToPrison=g(563);this.KeyToStxy=g(564);this.FogLamp=g(565);this.ShellFlute=g(566);this.EyeGlasses=g(567);this.BrokenStatue=g(568);this.GlowingLamp=g(569);this.StatueOfGold=g(570);this.LovePendant=g(571);this.KirisaPlant=g(572);this.IvoryStatue=g(573);this.BowOfMoon=g(574);this.BowOfSun=g(575);this.BowOfTruth=g(576);this.Refresh=g(577);this.Paralysis=g(578);this.Telepathy=g(579);this.Teleport=g(580);this.Recover=g(581);this.Barrier=g(582);this.Change=g(583);this.Flight=g(584);this.CalmedAngrySea=g(643);this.OpenedJoelShed=g(647);this.Draygon2=g(653);this.OpenedCrypt=g(654);this.OpenedStxy=g(688);this.OpenedSwanGate=g(691);this.OpenedPrison=g(728);this.OpenedSealedCave=g(750);this.AlwaysTrue=le(752,kn);this.WarpLeaf=g(757);this.WarpBrynmaer=g(758);this.WarpOak=g(759);this.WarpNadare=g(760);this.WarpPortoa=g(761);this.WarpAmazones=g(762);this.WarpJoel=g(763);this.WarpZombie=g(-764);this.WarpSwan=g(764);this.WarpShyron=g(765);this.WarpGoa=g(766);this.WarpSahara=g(767);this.Sword=we(this);this.Money=we(this);this.BreakStone=we(this);this.BreakIce=we(this);this.FormBridge=we(this);this.BreakIron=we(this);this.TravelSwamp=we(this);this.CrossPain=we(this);this.ClimbWaterfall=we(this);this.BuyHealing=we(this);this.BuyWarp=we(this);this.ShootingStatue=we(this);this.ClimbSlope8=we(this);this.ClimbSlope9=we(this);this.ClimbSlope10=we(this);this.WildWarp=we(this);this.TriggerSkip=we(this);this.RageSkip=we(this);this.ShootingStatueSouth=we(this);this.unallocated=new Map;for(let e in this){if(!this.hasOwnProperty(e))continue;let s=this[e];if(!s[bt])continue;let r=Number(e),n=typeof s.id=="number"?s.id:r;if(isNaN(n))throw new Error(`Bad flag: ${e}`);let i=s.name||(isNaN(r)?Qe(e):ko(n)),a=new pt(this,i,n,s);this[e]=a,a.id<0?this.unallocated.set(~a.id,a):this[a.id]||(this[a.id]=a)}for(let e=256;e<384;e++){let s=`Check ${L(e&255)}`;this[e]?!this[e].fixed&&!this.unallocated.has(e)&&this.unallocated.set(e,new pt(this,s,~e,{fixed:!0})):this[e]=new pt(this,s,e,{fixed:!0})}for(let e=384;e<640;e++)if(!this[e]){let s=e<512?"Buffer ":"Item ";this[e]=new pt(this,s+L(e),e,{fixed:!0})}for(let e of t.locations)for(let s of e.flags)this[s.flag]||(this[s.flag]=An(this,s.flag))}defrag(){let t=new Map,e=new Set;for(let a=0;a<768;a++){let l=this[a],c=l?.obsolete;c?(t.set(a,h=>h.set?-1:c.call(l,h)),delete this[a]):l||e.add(a)}let s=0,r=767;function n(a){return()=>a}for(;s<r;){if(this[s]||this.unallocated.has(s)){s++;continue}let a=this[r];if(!a||a.fixed){r--;continue}t.set(r,n(s)),a.id=s,this[s]=a,delete this[r],s++,r--}this.remapFlags(t,e);for(let[a,l]of this.unallocated)this[a]||(this.unallocated.delete(a),(this[a]=l).id=a);let i=[];for(let a=0;a<768;a++)this[a]||i.push(er(a));_o&&console.log(`Free flags: ${i.join(" ")}`)}insertZombieWarpFlag(){let t=new Map;if(this[756])throw new Error("No space to insert warp flag");let e=~this.WarpZombie.id;if(e<0)throw new Error("Bad WarpZombie id");for(let s=756;s<e;s++)this[s]=this[s+1],this[s].id=s,t.set(s+1,()=>s);this.WarpZombie.id=e,this[e]=this.WarpZombie,this.remapFlags(t)}remap(t,e){this.remapFlags(new Map([[t,()=>e]]))}remapFlags(t,e){function s(n,i){for(let a=n.length-1;a>=0;a--){let l=n[a];if(l<0&&(l=~l),e&&e.has(l))throw new Error(`SHOULD BE UNUSED: ${L(l)}`);let c=t.get(l);if(c==null)continue;let h=c({...i,index:a});h>=0?n[a]=n[a]<0?~h:h:n.splice(a,1)}}function r(n,i){let a=n<0?~n:n;if(e&&e.has(a))throw new Error(`SHOULD BE UNUSED: ${L(a)}`);let l=t.get(a);if(l==null)return n;let c=l(i);if(c<0)throw new Error("Bad flag delete");return n<0?~c:c}for(let n of this.rom.locations)if(!!n.used)for(let i of n.flags)i.flag=r(i.flag,{location:n});for(let n of this.rom.npcs)if(!!n.used){for(let[i,a]of n.spawnConditions)s(a,{npc:n,spawn:i});for(let i of n.globalDialogs)i.condition=r(i.condition,{npc:n,dialog:!0});for(let[,i]of n.localDialogs)for(let a of i)a.condition=r(a.condition,{npc:n,dialog:!0}),s(a.flags,{npc:n,dialog:!0,set:!0})}for(let n of this.rom.triggers)!n.used||(s(n.conditions,{trigger:n}),s(n.flags,{trigger:n,set:!0}));for(let n of this.rom.itemGets)s(n.flags,{set:!0});for(let n of this.rom.items)for(let i of n.itemUseData)i.kind==="flag"&&(i.want=r(i.want,{})),s(i.flags,{set:!0})}alloc(t=0){if(t!==512)throw new Error("Cannot allocate outside 2xx");for(let e=640;e<768;e++)if(!this[e])return this[e]=An(this,e),e;throw new Error("No free flags.")}free(t){delete this[t]}};function ko(o){return"Flag "+er(o)}function An(o,t){return new pt(o,"Wall "+L(t&255),t,{fixed:!0})}var ms=class extends K{constructor(e,s){super(e,s);this.coordinates=U(e.prg,this.base,4)}get base(){return 218769+(this.id<<2)}get w(){return this.coordinates[1]}set w(e){this.coordinates[1]=e}get x0(){return Xs(this.coordinates[0])}set x0(e){this.coordinates[0]=Qs(e)}get x1(){return this.x0+this.w}get h(){return this.coordinates[3]}set h(e){this.coordinates[3]=e}get y0(){return Xs(this.coordinates[2])}set y0(e){this.coordinates[2]=Qs(e)}get y1(){return this.y0+this.h}write(){let e=this.rom.assembler();return e.segment("1a"),e.org(38545+(this.id<<2)),e.byte(...this.coordinates),[e.module()]}};var Se=class extends Fe{constructor(){super(...arguments);this.action=this.prop([0,248,3]);this.part=this.prop([0,7,-3],[1,224,5]);this.index=this.prop([1,31])}toString(){let e=this.action?` (action ${L(this.action)})`:"";return`MessageId ${this.hex()}: (${L(this.part)}:${L(this.index)}${e}`}get mid(){return`${L(this.part)}:${L(this.index)}`}set mid(e){let s=e.split(":");if(s.length!==2)throw new Error(`oops: ${e}`);if(this.part=Number.parseInt(s[0],16),this.index=Number.parseInt(s[1],16),isNaN(this.part)||isNaN(this.index))throw new Error(`oops: ${e}`)}nonzero(){return!!(this.part||this.index)}};Se.size=2;var{$0e:gt,$0f:xs,$10:bs,$1a:Nn,$fe:Lo,$ff:Ao}=G,Ro=j.of(gt,33689),Mo=j.of(gt,39906),Co=j.of(bs,36848),No=j.of(bs,36923),Io=j.of(bs,36998),Rn=j.of(Nn,35776),Mn=j.of(Nn,35785),Cn=[["Sword",`
\v\f`],[" of ","\\]"],["Bracelet","<=>["],["Shield","\r"],["Armor","{"],["Magic","#%("],["Power",""],["Item","^"]],I=class extends K{constructor(e,s,r={}){super(e.rom,s);this.items=e;let n=this.rom;if(e[s]=this,this.itemUseData=[],this.trades=r.trades||[],this.use=r.use||!1,this.weight=r.weight||1,this.valueAddr=r.valueAddr!=null?j.of(gt,r.valueAddr):void 0,this.valueAddr!=null&&(this.value=this.valueAddr.read(n.prg)),this.use){this.itemUseJump=this.itemUseJumpPointer.readAddress(n.prg,gt,xs);let a=e.itemUseJumps[this.itemUseJump.org];if(!a)throw new Error(`Bad ItemUseJump: ${this.itemUseJump}`);let l=this.itemUseDataPointer.readAddress(n.prg,gt,xs);for(let c of a){let h=Ht.from(c,n.prg,l);this.itemUseData.push(h),l=l.plus(h.length)}}this.itemDataValue=this.itemDataPointer.read(n.prg),this.selectedItemValue=this.selectedItemPointer.read(n.prg);let i=this.menuNamePointer.readAddress(n.prg);this.menuName=Cn.reduce((a,[l,c])=>a.replace(c,l),Qt(n.prg,i.offset,255))}get messageName(){return this.rom.messages.itemNames[this.id]}set messageName(e){this.rom.messages.itemNames[this.id]=e}get basePrice(){return this.rom.shops.basePrices[this.id]}set basePrice(e){this.rom.shops.basePrices[this.id]=e}get itemUseJumpPointer(){return Ro.plus(this.id<<1)}get itemUseDataPointer(){return Mo.plus(this.id<<1)}get itemDataPointer(){return Co.plus(this.id)}get selectedItemPointer(){return No.plus(this.id)}get menuNamePointer(){return Io.plus(this.id<<1)}itemUseMessages(){let e=new Map;for(let{message:s}of this.itemUseData)e.set(s.mid,s);return[...e.values()]}setName(e){this.messageName=this.menuName=e}get palette(){return this.itemDataValue&3}set palette(e){this.itemDataValue=this.itemDataValue&-4|e&3}get unique(){return!!(this.itemDataValue&64)}set unique(e){this.itemDataValue=this.itemDataValue&-65|(e?64:0)}get worn(){return!!(this.itemDataValue&32)}set worn(e){this.itemDataValue=this.itemDataValue&-33|(e?32:0)}get solid(){return!!(this.itemDataValue&128)}set solid(e){this.itemDataValue=this.itemDataValue&-129|(e?128:0)}assemble(e){let s=L(this.id);this.itemDataPointer.loc(e,`ItemData_${s}`),e.byte(this.itemDataValue),this.selectedItemPointer.loc(e,`ItemSelectedValue_${s}`),e.byte(this.selectedItemValue);let r=Cn.reduce((i,[a,l])=>i.replace(a,l),this.menuName);e.segment(bs,Lo,Ao),e.reloc(`ItemMenuName_${L(this.id)}`);let n=e.pc();if(e.byte(r,255),this.menuNamePointer.loc(e,`ItemMenuName_${s}`),e.word(n),this.itemUseJump){this.itemUseJumpPointer.loc(e,`ItemUseJump_${s}_Ptr`),e.word(this.itemUseJump.org);let i=[];for(let l of this.itemUseData)i.push(...l.bytes());e.segment(gt.name,xs.name),e.reloc(`ItemUseData_${s}`);let a=e.pc();e.byte(...i),this.itemUseDataPointer.loc(e,`ItemUseData_${s}_Ptr`),e.word(a)}this.valueAddr&&(this.valueAddr.loc(e,`ItemValue_${s}`),e.byte(this.value)),this.itemUseData.some(i=>i.tradeNpc()===this.rom.npcs.Aryllis.id)&&(e.segment("fe"),e.org(54453),e.byte(this.id-28))}isMagic(){return this.id>=65&&this.id<=72}},Ht=class{constructor(t,e,s,r){this.kind=t;this.want=e;this.message=s;this.flags=r}static from(t,e,s){let{offset:r}=s,n=0;if(t==="expect"||t==="screen")n=e[r+1]<<8|e[r],r+=2;else if(t==="flag"){let l=nr.read(e,r);if(l.length||l.push(-1),l.length>1)throw new Error(`Flag list too long: ${l}`);n=l[0],r+=2}else t==="location"?n=e[r++]:t!=="empty"&&et(t);let i=Se.from(e,r),a=rr.read(e,r+2);return new Ht(t,n,i,a)}bytes(){let t=[];if(this.kind==="expect"||this.kind==="screen")t.push(this.want&255,this.want>>>8&255);else if(this.kind==="flag"){let e=nr.bytes([this.want]);if(e.length!==2)throw new Error(`bad data: ${e}`);t.push(...e)}else this.kind==="location"?t.push(this.want):this.kind!=="empty"&&et(this.kind);return t.push(...this.message.data),t.push(...rr.bytes(this.flags)),t}tradeNpc(){return this.kind!=="expect"||this.want>>>8!==1?null:this.want&255}get length(){let t=this.kind==="empty"?0:this.kind==="location"?1:2;return 2*(1+Math.max(1,this.flags.length))+t}},Ke=class extends I{get defense(){return this.items.shieldDefense[this.id-12]}set defense(t){this.items.shieldDefense[this.id-12]=t}},Ve=class extends I{get defense(){return this.items.armorDefense[this.id-20]}set defense(t){this.items.armorDefense[this.id-20]=t}},ps=class extends Ce{constructor(e){super(73);this.rom=e;this.itemUseJumps=Po;this.SwordOfWind=new I(this,0);this.SwordOfFire=new I(this,1);this.SwordOfWater=new I(this,2);this.SwordOfThunder=new I(this,3);this.Crystalis=new I(this,4);this.BallOfWind=new I(this,5);this.TornadoBracelet=new I(this,6);this.BallOfFire=new I(this,7);this.FlameBracelet=new I(this,8);this.BallOfWater=new I(this,9);this.BlizzardBracelet=new I(this,10);this.BallOfThunder=new I(this,11);this.StormBracelet=new I(this,12);this.CarapaceShield=new Ke(this,13);this.BronzeShield=new Ke(this,14);this.PlatinumShield=new Ke(this,15);this.MirroredShield=new Ke(this,16);this.CeramicShield=new Ke(this,17);this.SacredShield=new Ke(this,18);this.BattleShield=new Ke(this,19);this.PsychoShield=new Ke(this,20);this.TannedHide=new Ve(this,21);this.LeatherArmor=new Ve(this,22);this.BronzeArmor=new Ve(this,23);this.PlatinumArmor=new Ve(this,24);this.SoldierSuit=new Ve(this,25);this.CeramicSuit=new Ve(this,26);this.BattleArmor=new Ve(this,27);this.PsychoArmor=new Ve(this,28);this.MedicalHerb=new I(this,29,{use:!0,trades:[0],valueAddr:34026});this.Antidote=new I(this,30,{use:!0});this.LysisPlant=new I(this,31,{use:!0});this.FruitOfLime=new I(this,32,{use:!0});this.FruitOfPower=new I(this,33,{use:!0,valueAddr:34060});this.MagicRing=new I(this,34,{use:!0});this.FruitOfRepun=new I(this,35,{use:!0});this.WarpBoots=new I(this,36,{use:!0});this.StatueOfOnyx=new I(this,37,{use:!0,trades:[0]});this.OpelStatue=new I(this,38,{use:!0});this.InsectFlute=new I(this,39,{use:!0});this.FluteOfLime=new I(this,40,{use:!0,trades:[0,1,2,3]});this.GasMask=new I(this,41);this.PowerRing=new I(this,42);this.WarriorRing=new I(this,43);this.IronNecklace=new I(this,44);this.DeosPendant=new I(this,45);this.RabbitBoots=new I(this,46);this.LeatherBoots=new I(this,47);this.ShieldRing=new I(this,48);this.AlarmFlute=new I(this,49,{use:!0,trades:[0,1]});this.WindmillKey=new I(this,50,{use:!0});this.KeyToPrison=new I(this,51,{use:!0});this.KeyToStyx=new I(this,52,{use:!0});this.FogLamp=new I(this,53,{use:!0,trades:[0]});this.ShellFlute=new I(this,54,{use:!0});this.EyeGlasses=new I(this,55,{use:!0});this.BrokenStatue=new I(this,56,{use:!0});this.GlowingLamp=new I(this,57,{use:!0});this.StatueOfGold=new I(this,58,{use:!0});this.LovePendant=new I(this,59,{use:!0,trades:[0]});this.KirisaPlant=new I(this,60,{use:!0,trades:[0]});this.IvoryStatue=new I(this,61,{use:!0,trades:[0]});this.BowOfMoon=new I(this,62,{use:!0});this.BowOfSun=new I(this,63,{use:!0});this.BowOfTruth=new I(this,64,{use:!0});this.Refresh=new I(this,65);this.Paralysis=new I(this,66);this.Telepathy=new I(this,67);this.Teleport=new I(this,68);this.Recover=new I(this,69);this.Barrier=new I(this,70);this.Change=new I(this,71);this.Flight=new I(this,72);this.armorDefense=U(e.prg,Rn.offset,9),this.shieldDefense=U(e.prg,Mn.offset,9)}write(){let e=this.rom.assembler();Rn.loc(e),e.byte(...this.armorDefense),Mn.loc(e),e.byte(...this.shieldDefense);let s=new Array(10).fill(0);for(let r of this)r.assemble(e),r.unique&&(s[r.id>>>3]|=1<<(r.id&7));return ze(e,[gt,xs],"KeyItemData"),e.byte(...s),[e.module()]}},Po={33849:["expect"],33858:["screen"],33872:["empty"],33873:["screen"],33887:["location"],33937:["expect"],33961:["expect","expect"],33971:["location"],34e3:["expect"],34011:[],34016:["expect","empty"],34055:["empty"],34077:["empty"],34084:["empty"],34095:["empty"],34106:["empty"],34122:["empty"],34148:["empty"],34149:["expect"],34155:["flag"],34181:["empty"],34206:["expect","expect","expect","expect"]};var{$0e:gs,$0f:In,$14:Do,$fe:$o,$ff:Bo}=G,Wo=j.of(gs,39680),Oo=j.of(gs,40294),Fo=73,ys=class extends Ce{constructor(e){super(113);this.rom=e;this.actionGrants=new Map;for(let s=0;s<113;s++)this[s]=new vr(e,s);this.actionGrants.set(37,41),this.actionGrants.set(57,58),this.actionGrants.set(59,71),this.actionGrants.set(60,62),this.actionGrants.set(132,70),this.actionGrants.set(178,66),this.actionGrants.set(180,65)}write(){let e=this.rom.assembler();for(let s of this)s.assemble(e);ze(e,[Do,$o,Bo],"GrantItemTable");for(let[s,r]of this.actionGrants)e.byte(s,r);return[e.module()]}},vr=class extends K{constructor(e,s){super(e,s);this._itemId=this.itemPointer.read(e.prg);let r=this.tablePointer.readAddress(e.prg,gs,In),n=r.offset;this.inventoryRowStart=e.prg[n++],this.inventoryRowLength=e.prg[n++],this.acquisitionAction=Se.from(e.prg,n),this.flags=sr.read(e.prg,n+2),this.key=e.prg[n+2+2*this.flags.length+1]===254,s!==0&&r.org===ne(e.prg,122214)&&(this.key=!1,this.flags=[])}get itemPointer(){return Oo.plus(this.id)}get tablePointer(){return Wo.plus(this.id<<1)}get itemId(){return this._itemId}set itemId(e){if(this.id<Fo)throw new Error(`${this.id}`);this._itemId=e}isLosable(){return zo.has(this.inventoryRowStart)}copyFrom(e){this.inventoryRowStart=e.inventoryRowStart,this.inventoryRowLength=e.inventoryRowLength,this.acquisitionAction=e.acquisitionAction,this.flags=[...e.flags],this.key=e.key}assemble(e){this.itemPointer.loc(e),e.byte(this.itemId);let s=[this.inventoryRowStart,this.inventoryRowLength,...this.acquisitionAction.data,...sr.bytes(this.flags),this.key?254:255];e.segment(gs.name,In.name),e.reloc(`ItemGetData ${L(this.id)}`);let r=e.pc();e.byte(...s),this.tablePointer.loc(e),e.word(r)}},zo=new Set([4,8,16]);var Go=0,Nt=class{constructor(){this.name=`Area ${++Go}`}},st=class extends Nt{constructor(){super(...arguments);this.type="overworld"}},Ie=class extends Nt{constructor(){super(...arguments);this.type="town"}},ce=class extends Nt{constructor(){super(...arguments);this.type="connector";this.exits=[2,2]}},Te=class extends Nt{constructor(){super(...arguments);this.type="terminal";this.exits=[1,1]}},A;(C=>(C.Unused=new Te,C.ValleyOfWind=new class extends st{constructor(){super(...arguments);this.exits=[3,6]}},C.CordelPlain=new class extends st{constructor(){super(...arguments);this.exits=[5,8]}},C.WaterfallValley=new class extends st{constructor(){super(...arguments);this.exits=[6,6]}},C.AngrySea=new class extends st{constructor(){super(...arguments);this.exits=[0,0]}},C.GoaValley=new class extends st{constructor(){super(...arguments);this.exits=[0,0]}},C.Desert1=new class extends st{constructor(){super(...arguments);this.exits=[0,0]}},C.Desert2=new class extends st{constructor(){super(...arguments);this.exits=[0,0]}},C.Leaf=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Brynmaer=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Oak=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Amazones=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Nadare=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Portoa=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Joel=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.ZombieTown=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Swan=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Shyron=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Goa=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.Sahara=new class extends Ie{constructor(){super(...arguments);this.exits=[0,0]}},C.WindmillCave=new class extends ce{},C.SealedCave=new class extends ce{},C.ZebuCave=new class extends ce{},C.MtSabreWest=new class extends ce{},C.MtSabreNorth=new class extends ce{},C.LimeTreeValley=new class extends ce{},C.PortoaPalace=new class extends ce{},C.FishermanHouse=new class extends ce{},C.UndergroundChannel=new class extends ce{},C.JoelPassage=new class extends ce{},C.EvilSpiritIslandEntrance=new class extends ce{},C.EvilSpiritIsland=new class extends ce{},C.KirisaPlantCave=new class extends ce{},C.SwanGate=new class extends ce{},C.MtHydra=new class extends ce{},C.GoaFortress=new class extends ce{},C.OasisEntrance=new class extends ce{},C.OasisCave=new class extends ce{},C.DesertCave1=new class extends ce{},C.SaharaMeadow=new class extends ce{},C.DesertCave2=new class extends ce{},C.EastCave=new class extends ce{},C.Swamp=new class extends ce{},C.Mezame=new class extends Te{},C.Windmill=new class extends Te{},C.StomHouse=new class extends Te{},C.WaterfallCave=new class extends Te{},C.KirisaMeadow=new class extends Te{},C.FogLampCave=new class extends Te{},C.LimeTreeLake=new class extends Te{},C.Lighthouse=new class extends Te{},C.SaberaFortress=new class extends Te{},C.ShyronTemple=new class extends Te{},C.Styx=new class extends Te{},C.FortressBasement=new class extends Te{},C.Pyramid=new class extends Te{},C.Crypt=new Te,C.Tower=new Te))(A||(A={}));function Uo(o){return o.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace("Of","of")}for(let[o,t]of Object.entries(A))t.name=Uo(o);var $e=class extends Fe{constructor(){super(...arguments);this.x=this.prop([0],[1,255,-8]);this.y=this.prop([2],[3,255,-8]);this.screen=this.prop([3,15,-4],[1,15]);this.tile=this.prop([2,240],[0,240,4]);this.coord=this.prop([2,255,-8],[0,255])}get used(){return this.data[1]<8}toString(){return`Entrance ${this.hex()}: (${L(this.y)}, ${L(this.x)})`}};$e.size=4;var rt=class extends Fe{constructor(){super(...arguments);this.x=this.prop([0,255,-4]);this.xt=this.prop([0]);this.y=this.prop([1,255,-4]);this.yt=this.prop([1]);this.screen=this.prop([1,240],[0,240,4]);this.tile=this.prop([1,15,-4],[0,15]);this.coord=this.prop([1,15,-12],[0,15,-4]);this.dest=this.prop([2]);this.entrance=this.prop([3])}isSeamless(){return Boolean(this.entrance&32)}toString(){return`Exit ${this.hex()}: (${L(this.y)}, ${L(this.x)}) => ${this.dest}:${this.entrance}`}};rt.size=4;var dt=class extends Fe{constructor(){super(...arguments);this.x=this.prop([1,7,-8]);this.xs=this.prop([1,7]);this.y=this.prop([1,240,-4]);this.ys=this.prop([1,240,4]);this.screen=this.prop([1])}get flag(){return this.data[0]|512}set flag(e){if((e&-256)!==512)throw new Error(`bad flag: ${L(e)}`);this.data[0]=e&255}toString(){return`Flag ${this.hex()}: ${L(this.screen)} @ ${L(this.flag)}`}};dt.size=2;var yt=class extends Fe{constructor(){super(...arguments);this.fromXs=this.prop([1,112,4]);this.toXs=this.prop([1,7]);this.fromYs=this.prop([3,240,4]);this.toYs=this.prop([3,15]);this.fromScreen=this.prop([3,240],[1,112,4]);this.toScreen=this.prop([3,15,-4],[1,7]);this.dest=this.prop([0])}toString(){return`Pit ${this.hex()}: (${L(this.fromXs)}, ${L(this.fromYs)}) => ${L(this.dest)}:(${L(this.toXs)}, ${L(this.toYs)})`}};yt.size=4;var Kt=class extends Fe{constructor(){super(...arguments);this.y=this.prop([0,255,-4]);this.yt=this.prop([0]);this.x=this.prop([1,127,-4],[2,64,3]);this.xt=this.prop([1,127]);this.timed=this.booleanProp(1,7);this.screen=this.prop([0,240],[1,112,4]);this.tile=this.prop([0,15,-4],[1,15]);this.coord=this.prop([0,15,-12],[1,15,-4],[2,64,3]);this.type=this.prop([2,7]);this.id=this.prop([3]);this.patternBank=this.prop([2,128,7])}get used(){return this.data[0]!==254}set used(e){this.data[0]=e?0:254}[Symbol.iterator](){return this.used?super[Symbol.iterator]():[254,0,0,0][Symbol.iterator]()}get monsterId(){return this.id+80&255}set monsterId(e){this.id=e-80&255}isChest(){return this.type===2&&this.id<128}isInvisible(){return this.isChest()&&Boolean(this.data[2]&32)}isTrigger(){return this.type===2&&this.id>=128}isNpc(){return this.type===1&&this.id<192}isBoss(){return this.type===1&&this.id>=192}isMonster(){return this.type===0}isGeneric(){return this.type===4}isWall(){return Boolean(this.type===3&&(this.id<4||this.data[2]&32))}isShootingWall(e){return this.isWall()&&!!(this.data[2]&32?this.data[2]&16:e.id===143||e.id===168)}wallType(){if(this.type!==3)return"";let e=this.data[2]&32?this.id>>>4:this.id;return e>=4?"":e===2?"bridge":"wall"}wallElement(){return this.isWall()?this.id&3:-1}toString(){return`Spawn ${this.hex()}: (${L(this.x)}, ${L(this.y)}) ${this.timed?"timed":"fixed"} ${this.type}:${L(this.id)}`}};Kt.size=4;function Tr(o,t){let e=o-t;return e-=(o>>>4)-(t>>>4),e}function Pn(o,...t){for(let e of t){let s=e%15,r=(e-s)/15,n=(o>>4)+r,i=(o&15)+s;i<0?(n--,i=15+i):i>=15&&(n++,i=i-15),o=n<<4|i}return o}var nt=class{constructor(){this.data=new Map;this.sizes=new Map}find(t){if(t!==t)throw"nan";this.data.has(t)||(this.data.set(t,t),this.sizes.set(t,1));let e;for(;!Object.is(e=this.data.get(t),t);)this.data.set(t,t=this.data.get(e));return t}union(t){this.find(t[0]);for(let e=1;e<t.length;e++){if(t[e]!==t[e])throw"nan";this.unionInternal(t[0],t[e])}}unionInternal(t,e){if(t=this.find(t),e=this.find(e),t===e)return;let s=this.sizes.get(t),r=this.sizes.get(e);s<r?(this.sizes.set(e,s+r),this.data.set(t,e)):(this.sizes.set(t,s+r),this.data.set(e,t))}sets(){let t=new Map;for(let e of this.data.keys()){let s=this.find(e),r=t.get(s);r||t.set(s,r=new Set),r.add(e)}return[...t.values()]}map(){let t=new he(()=>new Set);for(let e of this.data.keys()){let s=t.get(this.find(e));t.set(e,s),s.add(e)}return t}roots(){let t=new Set;for(let e of this.data.keys())t.add(this.find(e));return[...t]}};var jo={next(){return{done:!0}}},Vt={get size(){return 0},has(){return!1},[Symbol.iterator](){return jo}},F={get size(){return 1/0},has(){return!0},[Symbol.iterator](){throw new Error("cannot iterate")}},Er=class{constructor(t){this.bit=t}get size(){return 1}has(t){return t===this.bit}[Symbol.iterator](){return[this.bit][Symbol.iterator]()}};function Ze(o){return new Er(o)}var Ue;(r=>{function o(n,i){if(n===F||!i.size)return i;if(i===F||!n.size)return n;let a=new Set;for(let l of n)i.has(l)&&a.add(l);return a.size?a:Vt}r.intersect=o;function t(n,i){if(n===F||!i.size)return n;if(i===F||!n.size)return i;let a=new Set(n);for(let l of i)a.add(l);return a}r.union=t;function e(n,i){if(i===F||!n.size)return!0;if(n.size>i.size)return!1;for(let a of n)if(!i.has(a))return!1;return!0}r.isSubset=e;function s(n){return n===F?"all":[...n].sort().join(" ")}r.label=s})(Ue||(Ue={}));var ue=class{constructor(t,e,s){this.fixed=t;this.float=e;this.shift=s}get pat0(){return this.fixed[0]}get pat1(){return this.fixed[1]}get pal2(){return this.fixed[2]}get pal3(){return this.fixed[3]}static get ALL(){return new ue([F,F,F,F],[],0)}static get NONE(){return new ue([Vt,Vt,Vt,Vt],[],0)}static get MIMIC(){return new ue([F,Ze(108),F,F],[],2)}static get TREASURE_CHEST(){return new ue([F,F,F,F],[Dn],0)}static get BOSS(){return new ue([Dn,F,F,F],[],0)}static get COIN(){return new ue([qo,F,F,F],[],0)}static get STOM_FIGHT(){return new ue([F,new Set([77]),F,F],[],0)}static get GUARDIAN_STATUE(){return new ue([new Set([116]),new Set([98]),F,F],[],0)}static get SHOOTING_WALL(){return new ue([new Set([97]),F,F,F],[],0)}static get KENSU_CHEST(){return new ue([new Set([81]),F,F,F],[],0)}static forLocation(t){switch(t){case 3:return new ue([F,Ze(96),F,Ze(32)],[],0);case 96:case 100:case 104:return new ue([F,Ze(82),F,Ze(8)],[],0)}return ue.ALL}static fromSpawn(t,e,s,r,n){let[i,...a]=e;n=n&&i===2&&!a.length,n&&r.patternBank&&(e=new Set([3]));let l=n||!e.has(2)?F:Ze(s.spritePatterns[0]),c=n||!e.has(3)?F:Ze(s.spritePatterns[1]),h=n?[Ze(s.spritePatterns[r.patternBank])]:[],u=t.has(2)?Ze(s.spritePalettes[0]):F,m=t.has(3)?Ze(s.spritePalettes[1]):F;return new ue([l,c,u,m],h,0)}ignorePalette(){return new ue([this.fixed[0],this.fixed[1],F,F],this.float,this.shift)}shufflePalette(t,e){let s=[...this.fixed];for(let r=2;r<4;r++){if(s[r]===F)continue;let n=Math.floor(5-Math.log2(t.nextInt(15)+2)),i=s[r]=new Set;for(let a=0;a<n;a++)i.add(t.pick(e))}return new ue(s,this.float,this.shift)}shifted(){return new ue(this.fixed,this.float,this.shift|2)}join(t){let e=W(4,r=>Ue.union(this.fixed[r],t.fixed[r]));if(this.float.length!==t.float.length)throw console.dir(this),console.dir(t),new Error(`incompatible float: ${this.float} ${t.float}`);let s=W(this.float.length,r=>Ue.union(this.float[r],t.float[r]));return new ue(e,s,this.shift|t.shift)}fix(t,e){let s=e?i=>e.nextInt(i):()=>0,r=e?i=>e.pick([...i]):i=>i[Symbol.iterator]().next().value,n=[...this.fixed];if(this.float.length){let i=s(2),a=1-i;i<this.float.length&&(n[0]=Ue.intersect(n[0],this.float[i])),a<this.float.length&&(n[1]=Ue.intersect(n[1],this.float[a]))}n[0]!==F&&(t.spritePatterns[0]=r([...n[0]])),n[1]!==F&&(t.spritePatterns[1]=r([...n[1]])),n[2]!==F&&(t.spritePalettes[0]=r([...n[2]])),n[3]!==F&&(t.spritePalettes[1]=r([...n[3]]))}meet(t,e=!1){let s=this.tryMeet(t,e);if(!s)throw new Error("Could not reconcile patterns");return s}tryMeet(t,e=!1){let s=[],r=this.shift|t.shift;for(let a=0;a<4;a++){let l=Ue.intersect(this.fixed[a],t.fixed[a]);if(!l.size){if(!e||a<2)return;l=Ue.union(this.fixed[a],t.fixed[a])}s.push(l)}let n=new Map,i=[];for(let a of De.concat(this.float,t.float)){if(a===F)throw new Error("Unexpected unconstrained float");let l=!1;for(let c of a){let h=n.get(c);if(h!=null){for(let u of i[h])n.delete(u);i[h]=Ue.intersect(i[h],a);for(let u of i[h])n.set(u,h);l=!0;break}}if(l)break;for(let c of a)n.set(c,i.length);if(i.push(a),i.length>2)return}for(let a=0;a<i.length;a++)for(let l=0;l<2;l++){let c=Ue.intersect(i[a],s[l]);if(c.size)c.size,i[a].size;else{let h=s[1-l]=Ue.intersect(i[a],s[1-l]);if(r|=1<<1-l,!h.size)return;i.splice(a,1),a=-1;break}}return new ue(s,i,r)}},Dn=new Set([94,95,96,97,100,101,102,103,104,105,106,108,109,110,111,112,116,117,118,119]),qo=new Set([94,95,96,97,99,100,101,102,103,104,105,106,107,108,109,110,111,112,116,117,118,119]);var ke=class extends K{constructor(e,s,r=""){super(e.rom,s);this.constraint=ue.ALL;if(e[s]=this,this.used=!0,this.name="",e.rom.writeMonsterNames){let a=this.rom.prg[499712|s]|this.rom.prg[499968|s]<<8|458752;this.displayName=Kr(this.rom.prg,a)}else this.displayName=r;this.base=ne(this.rom.prg,this.pointer)+65536,this.sfx=this.rom.prg[this.base],this.data=[];let n=this.base+1,i=0;for(let a=0;a<32;a++)a&7||(i=this.rom.prg[n++]),this.data.push(i&128?this.rom.prg[n++]:0),i<<=1}get pointer(){return 109568+(this.id<<1)}serialize(){let e=[this.sfx];for(let s=0;s<4;s++){let r=e.length;e.push(0);for(let n=0;n<8;n++)this.data[8*s+n]&&(e[r]|=128>>>n,e.push(this.data[8*s+n]))}return e}write(){let e=`Object_${this.id.toString(16).padStart(2,"0")}`,s=this.rom.assembler();s.segment("0d"),s.reloc(e);let r=s.pc();if(s.byte(...this.serialize()),s.org(44032+(this.id<<1),`${e}_Ptr`),s.word(r),this===this.rom.objects.blueSlime){let n=this.elements,i=0;for(;n;)n>>=1,i++;s.segment("1a"),s.org(37421),s.byte(i)}if(this.rom.writeMonsterNames){s.segment("3d");let n;if(this.displayName){let i=`${this.name}_Str`;s.reloc(i),n=s.pc(),s.byte(this.displayName.length),s.byte(...this.displayName)}s.org(40960|this.id),s.byte(n!=null?Q.loByte(n):0),s.org(41216|this.id),s.byte(n!=null?Q.hiByte(n):0)}return[s.module()]}get(e){return this.data[e-768>>>5]}parents(){return[]}spawnedChild(){if(!this.rom.objectActions[this.action]?.data.hasChild)return;let s=this.rom.adHocSpawns[this.child],r=s&&s.objectId;if(r!=null)return this.rom.objects[r]}spawnedReplacement(){if(!!this.replacement)return this.rom.objects[this.replacement]}locations(){return this.rom.locations.filter(e=>e.used&&e.spawns.some(s=>s.isMonster()&&s.monsterId===this.id))}palettes(e=!1){if(this.action===34)return[3];let s=this.data[0];this.action===42&&(s=this.data[31]|1),this.action===41&&(s=107),this.action===38&&(s=156);let r=this.rom.metasprites[s],n=e&&this.child?this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]]:null;return[...new Set([...r?.palettes()??[],...n?.palettes()??[]])]}isVulnerable(e){return!(this.elements&1<<e)}isShadow(){return this.id===123||this.id===140}get metasprite(){return $n.get(this.data)}set metasprite(e){$n.set(this.data,e)}get speed(){return Bn.get(this.data)}set speed(e){Bn.set(this.data,e)}get collisionPlane(){return Wn.get(this.data)}set collisionPlane(e){Wn.set(this.data,e)}get hitbox(){return On.get(this.data)}set hitbox(e){On.set(this.data,e)}get hp(){return Fn.get(this.data)}set hp(e){Fn.set(this.data,e)}get atk(){return zn.get(this.data)}set atk(e){zn.set(this.data,e)}get def(){return Gn.get(this.data)}set def(e){Gn.set(this.data,e)}get level(){return Un.get(this.data)}set level(e){Un.set(this.data,e)}get poison(){return!!jn.get(this.data)}set poison(e){jn.set(this.data,e?1:0)}get child(){return qn.get(this.data)}set child(e){qn.set(this.data,e)}get terrainSusceptibility(){return Hn.get(this.data)}set terrainSusceptibility(e){Hn.set(this.data,e)}get immobile(){return!!Kn.get(this.data)}set immobile(e){Kn.set(this.data,e?1:0)}get action(){return Vn.get(this.data)}set action(e){Vn.set(this.data,e)}get replacement(){return Zn.get(this.data)}set replacement(e){Zn.set(this.data,e)}get goldDrop(){return Yn.get(this.data)}set goldDrop(e){Yn.set(this.data,e)}get elements(){return Jn.get(this.data)}set elements(e){Jn.set(this.data,e)}get expReward(){return Xn.get(this.data)}set expReward(e){Xn.set(this.data,e)}get attackType(){return Qn.get(this.data)}set attackType(e){Qn.set(this.data,e)}get statusEffect(){return ei.get(this.data)}set statusEffect(e){ei.set(this.data,e)}toString(){return super.toString()+(this.name?" "+this.name:"")}};function ve(...o){return new _r(...o)}var _r=class{constructor(...t){this.spec=t}get(t){let e=0;for(let[s,r=255,n=0]of this.spec){let i=s-768>>>5,a=n<0?-n:0,l=n<0?0:n;e|=(t[i]&r)>>>l<<a}return e}set(t,e){for(let[s,r=255,n=0]of this.spec){let i=s-768>>>5,a=n<0?-n:0,l=n<0?0:n,c=e>>>a<<l&r;t[i]=t[i]&~r|c}}},$n=ve([768]),Bn=ve([832,15]),Wn=ve([928,240,4]),On=ve([1056,64,2],[928,15]),Fn=ve([960]),zn=ve([992]),Gn=ve([1024]),Un=ve([1056,31]),jn=ve([1056,128,7]),qn=ve([1088]),Hn=ve([1120]),Kn=ve([1184,128,7]),Vn=ve([1184,127]),Zn=ve([1216]),Yn=ve([1280,240,4]),Jn=ve([1280,15]),Xn=ve([1312]),Qn=ve([1344]),ei=ve([1376,15]);var T=class extends ke{constructor(e,s){super(e,s.id,s.displayName);let r=s.scaling,n=(ti(r)+this.level)/2,i=n+Jo(r,this.elements);this.hits=(this.hp+1)/(i-this.def),this.sdef=this.def/i;let a=Math.min(255,Math.max(16,32+n*16));this.satk=(this.atk-Xo(r,this.attackType))/a,this.extraDifficulty=s.difficulty||0,this.monsterClass=s.class;let l=Ho(this.expReward)/Ko(r),c=Zo[this.goldDrop]/Yo(r);this.type=s.type||"monster",this.wealth=c&&c/(l+c)}isBoss(){return this.type==="boss"}isProjectile(){return this.type==="projectile"}isBird(){return this.rom.objectActions[this.action]?.data.bird||!1}isFlyer(){let e=this.rom.objectActions[this.action];return e?.data.bird||e?.data.moth||!1}placement(){return this.rom.objectActions[this.action]?.data.placement??"normal"}clearance(){return this.rom.objectActions[this.action]?.data.large?6:3}totalDifficulty(){return this.toughness()+this.attack()+this.statusDifficulty()+this.immunities()+this.movement()}collectDifficulty(e,s){let r=e(this),n=this.spawnedChild();n instanceof T&&(r=s(r,n.collectDifficulty(e,s)));let i=this.spawnedReplacement();return i instanceof T&&(r=s(r,i.collectDifficulty(e,s))),r}toughness(){return this.collectDifficulty(e=>ws(e.hits,0,[2,1],[3,2],[5,3],[7,4],[10,5],[13,6]),Math.max)}attack(){return this.collectDifficulty(e=>e.attackType&&e.statusEffect?0:ws(e.satk,0,[.04,1],[.08,2],[.13,3],[.18,4],[.25,5],[.33,6]),Math.max)}addStatusEffects(e){this.attackType&&this.statusEffect?e.add(this.statusEffect):!this.attackType&&this.poison&&e.add(0);let s=this.spawnedReplacement();s instanceof T&&s.addStatusEffects(e);let r=this.spawnedChild();r instanceof T&&r.addStatusEffects(e)}statusDifficulty(){let e=new Set;this.addStatusEffects(e);let s=0;for(let r of e)s+=Vo[r];return s}immunities(){let e=0,s=this.elements;for(;s;)s&1&&e++,s>>>=1;return e&&1<<e-1}movement(){return this.collectDifficulty(e=>{let s=this.rom.objectActions[e.action],r=e.spawnedChild(),n=e.extraDifficulty;return s&&(n+=s.data.movement||0,s.data.large&&n++,r&&!r.statusEffect&&(n+=s.data.projectile||0)),this.metasprite===167&&(n+=2),n},(e,s)=>e+s)}totalReward(){return this.totalDifficulty()/4}normalizedGold(){if(!this.wealth)return 0;let e=this.totalDifficulty()*this.wealth*.6;return Math.max(1,Math.min(15,Math.round(e)))}normalizedExp(){if(this.wealth===1)return 0;let e=.488+this.totalDifficulty()*(1-this.wealth)*.256;return Math.max(1,Math.min(255,Math.round(e*32)))}toString(){return`Monster $${L(this.id)} ${this.name}`}};function Ho(o){return o<128?o:(o&127)<<4}function Ko(o){return 2**(o/5-1)}var Vo=[2,1,3,2,4],Zo=[0,1,2,4,8,16,30,50,100,200,400,50,100,200,400,500];function Yo(o){return 2**(o/7-1)}function ti(o){return o<24?1+o/3:(o+12)/4}function Jo(o,t=0){let e=o<10?1:o<18?2:o<38?4:8;for(let s=e;s;s>>>=1)if(!(s&t))return s<<1;return e<<1}function Xo(o,t){return ti(o)+Qo(o,t)}function Qo(o,t){return t?ws(o,2,[6,6],[18,8],[25,12],[30,18],[37,24],[42,32]):ws(o,2,[6,6],[18,10],[25,14],[30,18],[40,24],[46,32])}function ws(o,t,...e){for(let s=e.length-1;s>=0;s--){let[r,n]=e[s];if(o>=r)return n}return t}var[]=[L],It=class{constructor(t,e,s,r){this.id=t;this.tileset=e;this.customFlags=new Map;this.freeFlags=new Set;this._pos=void 0;this._exits=new Gt;this._pits=new Map;this.rom=e.rom,this._height=s,this._width=r,this._screens=new Array(s<<4).fill(e.empty)}static of(t,e){let{rom:s,width:r,height:n}=t;if(!e){let{fortress:S,labyrinth:v}=s.metatilesets,k=new Set;for(let p of s.metatilesets)t.tileset===p.tileset.id&&k.add(p);k.delete(t.id===169?S:v);for(let p of new Set(De.concat(...t.screens)))for(let y of k)if(y.getMetascreens(p).length||k.delete(y),!k.size)throw new Error(`No tileset for ${L(p)} in ${t}`);if(k.size!==1)throw new Error(`Non-unique tileset for ${t}: [${Array.from(k,p=>p.name).join(", ")}]`);e=[...k][0]}let i=t.reachableTiles(!0),a=new Set;for(let S of i.keys())a.add(S>>>8);for(let S of t.entrances)S.used&&a.add(S.screen);for(let S of t.exits)if(a.add(S.screen),S.isSeamless()){let v=S.tile>>>4;v===0?i.set(S.screen-16<<8|136,1):v===14&&i.set(S.screen<<8|136,1)}let l=new Array(n<<4).fill(e.empty);for(let S=0;S<n;S++)for(let v=0;v<r;v++){let k=S<<4|v,p=e.getMetascreens(t.screens[S][v]),y;if(p.length===1)y=p[0];else if(p.length){let w=t.flags.find(O=>O.screen===(S<<4|v)),E=[],B=[];for(let O of p)O.data.match?E.push(O):O.flag==="always"&&w?.flag===766||!O.flag&&!O.data.wall&&!w?B.unshift(O):B.push(O);if(E.length){let O=function(q,P){let oe=(v<<8)+P,se=(S<<8)+q,fe=se<<4&61440|oe&3840|se&240|oe>>4&15;return i.has(fe)};for(let q of E)if(!!q.data.match(O,w!=null)){y=q;break}}y||(y=B[0])}else throw new Error("impossible");if(!y)throw new Error("impossible");l[k]=y}let c=new Gt,h;for(let S of t.exits){if(S.dest===255)continue;let v=S.screen,k=S.tile;if(S.isSeamless()&&!(S.yt&15)&&(t.id&88)!==88&&(v-=16,k|=240),!a.has(v))throw new Error("impossible?");let p=l[v],y=p.findExitType(k,n===1,!!(S.entrance&32)),w=y?.type;if(!w){let se=t.id<<16|v<<8|S.tile;if(ea.has(se))continue;let fe=p.data.exits?.map(_e=>_e.type+": "+_e.exits.map(L).join(", ")).join(`
  `);console.warn(`Unknown exit ${L(S.tile)}: ${p.name} in ${t} @ ${L(v)}:
  ${fe}`);continue}if(c.has(v,w))continue;let E=s.locations[S.dest];if(w.startsWith("seamless")){let se=w==="seamless:down",fe=y.exits[0]+(se?-16:16),_e=v+(fe<0?-16:0),ht=se?"seamless:up":"seamless:down";c.set(v,w,[E.id<<8|_e,ht]);continue}let B=E.entrances[S.entrance&31],O=B.screen,q=B.coord;w==="door"&&(B.y&240)===0&&(O-=16,q+=65536);let P=E.screens[O>>4][O&15],oe=f(E,P,q);if(!oe){let se=[];for(let fe of s.metascreens.getById(P,E.tileset))for(let _e of fe.data.exits??[])_e.type.startsWith("seamless")||se.push(`  ${fe.name} ${_e.type}: ${L(_e.entrance)}`);console.warn(`Bad entrance ${L(q)}: raw ${L(P)} in ${E} @ ${L(O)}
${se.join(`
`)}`);continue}if(c.set(v,w,[E.id<<8|O,oe]),t.entrances[0].screen===v){let se=t.entrances[0].coord,fe=p.findExitByType(w);((fe.entrance&255)-(se&255))**2+((fe.entrance>>>8)-(se>>>8))**2<=1024&&(h=w)}}let u=new Map;for(let S of t.pits)u.set(S.fromScreen,S.dest<<8|S.toScreen);let m=new It(t.id,e,n,r);m._screens=l,m._exits=c,m._entrance0=h,m._pits=u;for(let S of t.flags){let v=m._screens[S.screen];v.flag?.startsWith("custom")?m.customFlags.set(S.screen,s.flags[S.flag]):v.flag||m.freeFlags.add(s.flags[S.flag])}return m;function f(S,v,k){for(let p of s.metascreens.getById(v,S.tileset)){let y=p.findEntranceType(k,S.height===1);if(y!=null)return y}}}getUid(t){return this._screens[t].uid}get(t){return this._screens[t]}get width(){return this._width}set width(t){this._width=t,this._pos=void 0}get height(){return this._height}set height(t){this._height>t?this._screens.splice(t+2<<4,this._height-t<<4):this._height<t&&(this._screens.length=t+2<<4,this._screens.fill(this.tileset.empty,this.height+2<<4,this._screens.length)),this._height=t,this._pos=void 0}allPos(){if(this._pos)return this._pos;let t=this._pos=[];for(let e=0;e<this._height;e++)for(let s=0;s<this._width;s++)t.push(e<<4|s);return t}set(t,e){this._screens[t]=e??this.tileset.empty}inBounds(t){return(t&15)<this.width&&t>=0&&t>>>4<this.height}set2d(t,e){for(let s of e){let r=0;for(let n of s)n&&this.set(t+r,n),r++;t+=16}}validate(){for(let t of[0,1])for(let e=t?0:1;e<this.height;e++)for(let s=t;s<this.width;s++){let r=e<<4|s,n=this._screens[r],i=r-(t?1:16),a=this._screens[i];if(!n.isEmpty()&&!a.isEmpty()&&!n.checkNeighbor(a,t))throw new Error(on("bad neighbor %s (%02x) %s %s (%02x)",a.name,i,ta[t],n.name,r))}return!0}spliceColumns(t,e,s,r){for(let c=0;c<this._screens.length;c+=16)this._screens.copyWithin(c+t+s,c+t+e,c+10),this._screens.splice(c+t,s,...r[c>>4]);let n=s-e;this.width+=n,this._pos=void 0;let i=[];for(let[c,h]of this._exits){let u=c&15;if(u<t+e){u>=t&&this._exits.delete(c,h);continue}i.push([c,h,c+n,h])}this.moveExits(...i);let a=this.rom.locations[this.id],l=t+e<<4;for(let c of a.spawns)c.xt<l||(c.xt-=n<<4);for(let c of a.flags){if(c.xs<t+e){c.xs>=t&&(c.screen=255);continue}c.xs-=n}a.flags=a.flags.filter(c=>c.screen!==255)}setExit(t,e,s){let r=this.rom.locations[s[0]>>>8].meta;if(!r)throw new Error("Cannot set two-way exit without meta");this.setExitOneWay(t,e,s),r.setExitOneWay(s[0]&255,s[1],[this.id<<8|t,e])}setExitOneWay(t,e,s){this._exits.set(t,e,s)}deleteExit(t,e){this._exits.delete(t,e)}getExit(t,e){return this._exits.get(t,e)}exits(){return this._exits}exitCandidates(t){let e=[];for(let s of this.tileset)s.data.exits?.some(r=>r.type===t)&&e.push(s);return e}show(){let t=[],e=[];for(let s=0;s<this.width;s++)e.push(s.toString(16));t.push("   "+e.join("  "));for(let s=0;s<this.height;s++)for(let r=0;r<3;r++){e=[r===1?s.toString(16):" "," "];for(let n=0;n<this.width;n++){let i=this._screens[s<<4|n];e.push(i?.data.icon?.full[r]??(r===1?" ? ":"   "))}t.push(e.join(""))}return t.join(`
`)}screenNames(){let t=[];for(let e=0;e<this.height;e++){let s=[];for(let r=0;r<this.width;r++){let n=this._screens[e<<4|r];s.push(n?.name)}t.push(s.join(" "))}return t.join(`
`)}traverse(t={}){let e=new nt,s=(t.flight?2:0)|(t.noFlagged?1:0);for(let i of this.allPos()){let a=t.with?.get(i)??this._screens[i];for(let l of a.connections[s])!l.length||e.union(l.map(c=>(i<<8)+c))}let r=new Map,n=e.sets();for(let i=0;i<n.length;i++){let a=n[i];for(let l of a)r.set(l,a)}return r}exitType(t){if((t&240)!==224)return;let e=t>>>8,r=this.get(e).data.exits?.[t&15].type;if(!r?.startsWith("edge:"))return r;if(!(r==="edge:top"&&e>>>4)&&!(r==="edge:bottom"&&e>>>4===this.height-1)&&!(r==="edge:left"&&e&15)&&!(r==="edge:bottom"&&(e&15)===this.width-1))return r}poiTile(t){throw new Error("not implemented")}static connect(t,e,s){let r=t.locations[e[0]>>>8].meta,n=t.locations[s[0]>>>8].meta;r.attach(e[0]&255,n,s[0]&255,e[1],s[1])}static findExitTiles(t,e){return t.locations[e[0]>>>8].meta._screens[e[0]&255].findExitByType(e[1]).exits.map(i=>i|(e[0]&255)<<8)}attach(t,e,s,r,n){r||(r=this.pickTypeFromExits(t)),n||(n=e.pickTypeFromExits(s));let i=e.id<<8|s,a=this.id<<8|t,l=this._exits.get(t,r),c=e._exits.get(s,n);if(l&&c){let[h,u]=l,[m,f]=c;if(h===i&&u===n&&m===a&&f===r)return}if(this._exits.set(t,r,[i,n]),e._exits.set(s,n,[a,r]),c&&l){let[h,u]=l,[m,f]=c,S=this.rom.locations[m>>8].meta,v=this.rom.locations[h>>8].meta;S._exits.set(m&255,f,l),v._exits.set(h&255,u,c)}else if(c||l){let[h,u]=c||l;(h!==a||u!==r)&&(h!==i||u!==n)&&this.rom.locations[h>>8].meta._exits.delete(h&255,u)}}pickTypeFromExits(t){let e=[...this._exits.row(t).keys()];if(!e.length)return this.pickTypeFromScreens(t);if(e.length>1)throw new Error(`No single type for ${L(t)}: [${e.join(", ")}]`);return e[0]}moveExits(...t){let e=[];for(let[s,r,n,i]of t){let a=this._exits.get(s,r),[l,c]=a;this.rom.locations[l>>8].meta._exits.set(l&255,c,[this.id<<8|n,i]),e.push([n,i,a]),this._exits.delete(s,r)}for(let[s,r,n]of e)this._exits.set(s,r,n)}moveExit(t,e,s,r){s||(s=this.pickTypeFromExits(t)),r||(r=this.pickTypeFromScreens(e));let n=this._exits.get(t,s),[i,a]=n;this.rom.locations[i>>8].meta._exits.set(i&255,a,[this.id<<8|e,r]),this._exits.set(e,r,n),this._exits.delete(t,s)}moveExitsAndPitsTo(t){let e=new Set;for(let s of t.allPos())t.get(s).data.delete||e.add(s);for(let[s,r,[n,i]]of this._exits){if(!e.has(s))continue;this.rom.locations[n>>>8].meta._exits.set(n&255,i,[t.id<<8|s,r]),t._exits.set(s,r,[n,i]),this._exits.delete(s,r)}for(let[s,r]of this._pits)!e.has(s)||(t._pits.set(s,r),this._pits.delete(s))}pickTypeFromScreens(t){let s=(this._screens[t].data.exits??[]).map(r=>r.type);if(s.length!==1)throw new Error(`No single type for ${L(t)}: [${s.join(", ")}]`);return s[0]}transferFlags(t,e){this.freeFlags=new Set(t.freeFlags);let s=new he(()=>[]);for(let[r,n]of t.customFlags)s.get(t._screens[r]).push(n);for(let r of s.values())e.shuffle(r);for(let r of this.allPos()){let n=this._screens[r];if(n.flag?.startsWith("custom")){let i=s.get(n).pop();if(!i)throw new Error(`No flag for ${n.name} at ${this.rom.locations[this.id]} @${L(r)}`);this.customFlags.set(r,i)}}}transferPits(t){this._pits=t._pits}shufflePits(t){if(!this._pits.size)return;let e=new Set;for(let[,r]of this._pits)e.add(this.rom.locations[r>>>8].id);this._pits.clear();let s=new he(()=>[]);for(let r of this.allPos()){if(!this.get(r).hasFeature("pit"))continue;let i=[-1,this,1/0];for(let[a,,[l]]of this._exits){let c=si(r,a);if(e.has(l>>>8)&&c<i[2]){let h=this.rom.locations[l>>>8].meta,u=l&255;i=[ri(r,u,a,h),h,c]}}i[0]>=0&&s.get(i[1]).push([r,i[0]])}for(let r of e){let n=s.get(this.rom.locations[r].meta);n.length||n.push([0,240])}for(let[r,n]of s){let i=[[],[]],a=new Map;for(let c of r.allPos()){let h=r.get(c);if(h.hasFeature("river")||h.hasFeature("empty"))continue;let u=(h.data.edges||"").split("").map(m=>m===" "?"":m);u[0]&&u[2]&&i[0].push(c),(u[1]&&u[3]||h.hasFeature("spikes"))&&i[1].push(c),h.hasFeature("spikes")&&a.set(c,[...u].filter(m=>m==="s").length)}let l=[0,0];for(let[c,h]of n){let m=this.get(c).data.edges||"",f=m[1]==="c"&&m[3]==="c"?1:0,S=[-1,1/0,0],v=ri(h,l[0],l[1],r);for(let p of i[f]){let y=a.get(p)??0;if(y<S[2])continue;let w=si(v,p);w<S[1]&&(S=[p,w,y])}let k=S[0];if(k<0)throw new Error("no eligible dest");l=[k,v],this._pits.set(c,r.id<<8|k)}}}transferExits(t,e){let s=new he(()=>[]),r=new he(()=>new Set);for(let n of this.allPos()){let i=this._screens[n];for(let{type:a}of i.data.exits??[])a==="edge:top"&&n>>>4||a==="edge:left"&&n&15||a==="edge:bottom"&&n>>>4<this.height-1||a==="edge:right"&&(n&15)<this.width-1||s.get(a).push(n)}for(let n of s.values())e.shuffle(n);for(let[n,i,a]of t._exits){if(r.get(i).has(n))continue;let l=s.get(i).pop();if(l==null)throw new Error(`Could not transfer exit ${i} in ${this.rom.locations[this.id]}: no eligible screen
${this.show()}`);let c=this.rom.locations[a[0]>>>8].meta,h=a[0]&255,u=a[1];if(c===t){let f=s.get(u).pop();if(f==null)throw new Error("Impossible");this._exits.set(l,i,[this.id<<8|f,u]),this._exits.set(f,u,[this.id<<8|l,i]),r.get(u).add(h);continue}let m=c._exits.get(h,u);if(!m){let f=this.rom.locations[a[0]>>>8];throw console.log(c),new Error(`No exit for ${f} at ${L(h)} ${u}
${c.show()}
${this.rom.locations[this.id]} at ${L(n)} ${i}
${this.show()}`)}m[0]>>>8===this.id&&(m[0]&255)===n&&m[1]===i&&c._exits.set(h,u,[this.id<<8|l,i]),this._exits.set(l,i,a)}}transferSpawns(t,e){let s=new Map,r=new Map,n=[],i=[],a=[],l=[],c=[];for(let f of[this,t]){for(let S of f.allPos()){let v=f._screens[S],k=S&240,p=(S&15)<<4;if(v.hasFeature("pit")&&f===this)r.set(S,v.edgeIndex("c")===5?0:1);else if(v.data.statues?.length&&f===this)for(let y=0;y<v.data.statues.length;y++){let w=v.data.statues[y]<<12,B=(S&15^S>>>4^y)&1?80:160;n.push([S,w|B])}if(f===this&&v.hasFeature("wall")){if(v.data.wall==null)throw new Error("Missing wall prop");let y=[k|v.data.wall>>4,p|v.data.wall&15];a.push(y),v.data.tilesets.lime&&a.push([y[0]-1,y[1]])}else if(f===this&&v.hasFeature("bridge")){if(v.data.wall==null)throw new Error("Missing wall prop");l.push([k|v.data.wall>>4,p|v.data.wall&15])}if(!!v.hasFeature("arena"))if(f===this)c.push([k|8,p|8]);else{let[y,w]=c.pop();i.push([k|8,p|8,y,w,144,"arena"])}}f===this&&(e.shuffle(c),e.shuffle(n))}for(let f of[this,t])for(let[S,v,k]of f._exits){let p=f._screens[S],y=p.data.exits?.find(q=>q.type===v);if(!y)throw new Error(`Invalid exit: ${p.name} ${v}`);let w=S&15,E=S>>>4,B=y.exits[0]&15,O=y.exits[0]>>>4;if(f===this)s.set(k,[E<<4|O,w<<4|B]);else if(k[0]>>>8!==this.id){let[q,P]=s.get(k);i.push([E<<4|O,w<<4|B,q,P,25,"exit"])}}let h=[[],[],[],[],[],[]];for(let f of this.allPos()){let S=this._screens[f];for(let[v,k=112,p=120]of S.data.poi??[]){let y=((f&240)<<4)+k,w=((f&15)<<8)+p;h[v].push([y,w])}}for(let f of h)e.shuffle(f);let u=[...De.concat(...h)],m=this.rom.locations[this.id];for(let f of e.ishuffle(m.spawns)){if(f.isMonster()){let p=ni.indexOf(f.monsterId);if(p>=0&&r.size){let[[y,w]]=r;r.delete(y),f.monsterId=ni[p&2|w],f.screen=y,f.tile=w?115:71}else if(f.monsterId===143&&n.length){let[y,w]=n.pop();f.screen=y,f.coord=w}continue}else if(f.isWall()){let p=(f.wallType()==="bridge"?l:a).pop();if(!p)throw new Error(`Not enough ${f.wallType()} screens in new metalocation: ${m}
${this.show()}`);let[y,w]=p;f.yt=y,f.xt=w;continue}else if(f.isNpc()||f.isBoss()||f.isTrigger()||f.isGeneric()){let p=[-1,-1,1/0];for(let[y,w,E,B,O,q]of i){if(q!=="arena"&&f.isBoss())continue;let P=Tr(f.yt,y)**2+(f.xt-w)**2;P<=O&&P<p[2]&&(p=[Pn(f.yt,Tr(E,y)),f.xt+B-w,P])}if(Number.isFinite(p[2])){[f.yt,f.xt]=p;continue}}if(f.isTrigger()||f.isBoss())throw new Error(`Could not place ${m} ${f.isBoss()?"Boss":"Trigger"} ${f.hex()}
${this.show()}`);let S=u.shift();if(!S)throw new Error(`Ran out of POI for ${m}`);let[v,k]=S;i.push([f.y>>>4,f.x>>>4,v>>>4,k>>>4,4,"???"]),f.y=v,f.x=k}}reconcileExits(t){let e=[],s=[];for(let r of[this,t])for(let[n,i,[a,l]]of r._exits){if(l.startsWith("seamless"))continue;let h=this.rom.locations[a>>>8].meta._exits.get(a&255,l);if(h){let[u,m]=h;if(u>>>8===r.id&&(u&255)===n&&m===i){e.push([r===this?t:this,n,i,[a,l]]);continue}}s.push([r,n,i])}for(let[r,n,i]of s)r._exits.delete(n,i);for(let[r,n,i,a]of e)r._exits.set(n,i,a)}writeEntrance0(){if(!!this._entrance0)for(let[t,e]of this._exits){if(e!==this._entrance0)continue;let s=this._screens[t].findExitByType(e);this.rom.locations[this.id].entrances[0]=$e.of({screen:t,coord:s.entrance});return}}write(){let t=this.rom.locations[this.id],e=new Set;for(let[a,l,[c,h]]of this._exits){let u=this._screens[a],m=c>>8,f=c&255,S=this.rom.locations[m],k=S.meta._screens[c&255],p=u.data.exits?.find(E=>E.type===l),y=k.data.exits?.find(E=>E.type===h);if(!p||!y)throw new Error(`Missing ${p?"dest":"source"} exit:
  From: ${t} @ ${L(a)}:${l} ${u.name}
  To:   ${S} @ ${L(f)}:${h} ${k.name}`);let w=32;if(y.type.startsWith("seamless"))e.add(a);else{let E=y.entrance;E>61439&&(f+=16,E-=65536),w=S.findOrAddEntrance(f,E)}for(let E of p.exits){let B=a;(E&240)===240&&(B+=16,E&=15),t.exits.push(rt.of({screen:B,tile:E,dest:m,entrance:w}))}}t.width=this._width,t.height=this._height,t.screens=[];for(let a=0;a<this._height;a++){let l=[];t.screens.push(l);for(let c=0;c<this._width;c++)l.push(this._screens[a<<4|c].sid)}t.tileset=this.tileset.tilesetId,t.tileEffects=this.tileset.effects().id;let s=new nt;for(let a of this.allPos()){if(e.has(a))continue;let l=this._screens[a],c=a+16,h=a+1;!e.has(c)&&(l.data.edges?.[2]??" ")!==" "&&s.union([a,c]),!e.has(h)&&(l.data.edges?.[3]??" ")!==" "&&s.union([a,h]),s.union([a])}let r=s.map(),n=new Set;for(let[a]of this._exits)for(let l of r.get(a)??[])n.add(l);t.flags=[];let i=[...this.freeFlags];for(let a of this.allPos()){let l=this._screens[a],c;l.data.wall!=null&&n.has(a)?c=i.pop()?.id??this.rom.flags.alloc(512):l.flag==="always"?c=this.rom.flags.AlwaysTrue.id:l.flag==="calm"?c=this.rom.flags.CalmedAngrySea.id:l.flag==="custom:false"?c=this.customFlags.get(a)?.id:l.flag==="custom:true"&&(c=this.customFlags.get(a)?.id??this.rom.flags.AlwaysTrue.id),c!=null&&t.flags.push(dt.of({screen:a,flag:c}))}t.pits=[];for(let[a,l]of this._pits){let c=l&255,h=l>>>8;t.pits.push(yt.of({fromScreen:a,toScreen:c,dest:h}))}}replaceMonsters(t){if(this.id===104)return;let e=this.rom.locations[this.id],s=e.monsterPlacer(t);for(let r of e.spawns){if(!r.used||!r.isMonster())continue;let n=e.rom.objects[r.monsterId];if(!(n instanceof T))continue;let i=s(n);i==null?(console.error(`no valid location for ${L(n.id)} ${n.name} in ${e}`),r.used=!1):n.isBird()?(r.y=4048,r.x=2032,r.timed=!0):(r.screen=i>>>8,r.tile=i&255)}}},ea=new Set([65594,65595,1392800,1716320,4202496,4202544,4292816,6326207,10552102,10552105,11077158,11077161]),ta=["above","left of","below","right of"];function si(o,t){return((o>>>4)-(t>>>4))**2+((o&15)-(t&15))**2}function ri(o,t,e,s){let r=t&15,n=t>>>4,i=e&15,a=e>>>4,l=o&15,c=o>>>4,h=Math.max(0,Math.min(s.width-1,l+r-i));return Math.max(0,Math.min(s.height-1,c+n-a))<<4|h}var ni=[126,127,159,141];var{$0a:sa,$0b:ra,$0c:na,$0d:ii}=G,te={subArea:"cave",music:o=>`${o.name}-Cave`,palette:o=>`${o.name}-Cave`},$={subArea:"house",palette:()=>Symbol()},ia={subArea:"house",palette:()=>Symbol(),music:o=>`${o.name}-FortuneTeller`},oi={name:"mesia",music:o=>`${o.name}-Mesia`,palette:o=>o.name==="Tower"?o.name:`${o.name}-Mesia`},oa={name:"dyna",music:o=>`${o.name}-Dyna`,palette:o=>`${o.name}-Dyna`},ai={name:"goa 1",music:"goa 1",palette:"goa 1"},li={name:"goa 2",music:"goa 2",palette:"goa 2"},hi={name:"goa 3",music:"goa 3",palette:"goa 3"},kr={...hi,palette:"goa 3 upper"},wt={name:"goa 4",music:"goa 4",palette:"goa 4"},ci={...wt,palette:"goa 4 lower"},x=(()=>{let o=Zr(),t;function e(s,r={}){return r={...r},t=r.area=r.area||t,o(s,r)}return e.commit=s=>{o.commit(s,(r,n,i)=>{let a=Qe(r),l=i.area,c=typeof i.music=="function"?i.music(l):i.music!=null?i.music:l.name,h=typeof i.palette=="function"?i.palette(l):i.palette||l.name,u={area:l,name:a,music:c,palette:h};i.houseType!=null&&(u.houseType=i.houseType),i.subArea!=null&&(u.subArea=i.subArea),i.bossScreen!=null&&(u.bossScreen=i.bossScreen);let m=new vs(s.rom,n,u);return n>=0&&(s[n]=m),m})},e})(),Ss=class extends Array{constructor(e){super(256);this.rom=e;this.MezameShrine=x(0,{area:A.Mezame});this.Leaf_OutsideStart=x(1,{music:1});this.Leaf=x(2,{area:A.Leaf});this.ValleyOfWind=x(3,{area:A.ValleyOfWind});this.SealedCave1=x(4,{area:A.SealedCave});this.SealedCave2=x(5);this.SealedCave6=x(6);this.SealedCave4=x(7);this.SealedCave5=x(8);this.SealedCave3=x(9);this.SealedCave7=x(10,{bossScreen:145});this.SealedCave8=x(12);this.WindmillCave=x(14,{area:A.WindmillCave});this.Windmill=x(15,{area:A.Windmill,music:0,houseType:"outside"});this.ZebuCave=x(16,{area:A.ZebuCave});this.MtSabreWest_Cave1=x(17,{area:A.MtSabreWest,...te});this.CordelPlainWest=x(20,{area:A.CordelPlain});this.CordelPlainEast=x(21);this.Brynmaer=x(24,{area:A.Brynmaer});this.OutsideStomHouse=x(25,{area:A.StomHouse,music:0});this.Swamp=x(26,{area:A.Swamp,bossScreen:124});this.Amazones=x(27,{area:A.Amazones,fixed:[13,14]});this.Oak=x(28,{area:A.Oak});this.StomHouse=x(30,{area:A.StomHouse,houseType:"outside"});this.MtSabreWest_Lower=x(32,{area:A.MtSabreWest});this.MtSabreWest_Upper=x(33);this.MtSabreWest_Cave2=x(34,te);this.MtSabreWest_Cave3=x(35,te);this.MtSabreWest_Cave4=x(36,te);this.MtSabreWest_Cave5=x(37,te);this.MtSabreWest_Cave6=x(38,te);this.MtSabreWest_Cave7=x(39,te);this.MtSabreNorth_Main=x(40,{area:A.MtSabreNorth,bossScreen:181});this.MtSabreNorth_Middle=x(41);this.MtSabreNorth_Cave2=x(42,te);this.MtSabreNorth_Cave3=x(43,te);this.MtSabreNorth_Cave4=x(44,te);this.MtSabreNorth_Cave5=x(45,te);this.MtSabreNorth_Cave6=x(46,te);this.MtSabreNorth_PrisonHall=x(47,te);this.MtSabreNorth_LeftCell=x(48,te);this.MtSabreNorth_LeftCell2=x(49,te);this.MtSabreNorth_RightCell=x(50,te);this.MtSabreNorth_Cave8=x(51,te);this.MtSabreNorth_Cave9=x(52,te);this.MtSabreNorth_SummitCave=x(53,te);this.MtSabreNorth_Cave1=x(56,te);this.MtSabreNorth_Cave7=x(57,te);this.Nadare_Inn=x(60,{area:A.Nadare,...$});this.Nadare_ToolShop=x(61,{...$,houseType:"tool"});this.Nadare_BackRoom=x(62,{...$,houseType:"house"});this.WaterfallValleyNorth=x(64,{area:A.WaterfallValley});this.WaterfallValleySouth=x(65);this.LimeTreeValley=x(66,{area:A.LimeTreeValley,music:0});this.LimeTreeLake=x(67,{area:A.LimeTreeLake,music:0});this.KirisaPlantCave1=x(68,{area:A.KirisaPlantCave});this.KirisaPlantCave2=x(69);this.KirisaPlantCave3=x(70);this.KirisaMeadow=x(71,{area:A.KirisaMeadow});this.FogLampCave1=x(72,{area:A.FogLampCave});this.FogLampCave2=x(73);this.FogLampCave3=x(74);this.FogLampCaveDeadEnd=x(75);this.FogLampCave4=x(76);this.FogLampCave5=x(77);this.FogLampCave6=x(78);this.FogLampCave7=x(79);this.Portoa=x(80,{area:A.Portoa});this.Portoa_FishermanIsland=x(81,{area:A.FishermanHouse,music:0});this.MesiaShrine=x(82,{area:A.LimeTreeLake,...oi});this.WaterfallCave1=x(84,{area:A.WaterfallCave});this.WaterfallCave2=x(85);this.WaterfallCave3=x(86);this.WaterfallCave4=x(87);this.TowerEntrance=x(88,{area:A.Tower});this.Tower1=x(89);this.Tower2=x(90);this.Tower3=x(91);this.TowerOutsideMesia=x(92);this.TowerOutsideDyna=x(93);this.TowerMesia=x(94,oi);this.TowerDyna=x(95,oa);this.AngrySea=x(96,{area:A.AngrySea});this.BoatHouse=x(97,{houseType:"outside"});this.JoelLighthouse=x(98,{area:A.Lighthouse,music:0,houseType:"outside"});this.UndergroundChannel=x(100,{area:A.UndergroundChannel});this.ZombieTown=x(101,{area:A.ZombieTown});this.EvilSpiritIsland1=x(104,{area:A.EvilSpiritIslandEntrance,music:1});this.EvilSpiritIsland2=x(105,{area:A.EvilSpiritIsland});this.EvilSpiritIsland3=x(106);this.EvilSpiritIsland4=x(107);this.SaberaPalace1=x(108,{area:A.SaberaFortress,bossScreen:253,houseType:"palace"});this.SaberaPalace2=x(109);this.SaberaPalace2_West=x(-1);this.SaberaPalace3=x(110,{bossScreen:253});this.JoelSecretPassage=x(112,{area:A.JoelPassage});this.Joel=x(113,{area:A.Joel});this.Swan=x(114,{area:A.Swan,music:1});this.SwanGate=x(115,{area:A.SwanGate,music:1});this.GoaValley=x(120,{area:A.GoaValley});this.MtHydra=x(124,{area:A.MtHydra});this.MtHydra_Cave1=x(125,te);this.MtHydra_OutsideShyron=x(126,{fixed:[13,14]});this.MtHydra_Cave2=x(127,te);this.MtHydra_Cave3=x(128,te);this.MtHydra_Cave4=x(129,te);this.MtHydra_Cave5=x(130,te);this.MtHydra_Cave6=x(131,te);this.MtHydra_Cave7=x(132,te);this.MtHydra_Cave8=x(133,te);this.MtHydra_Cave9=x(134,te);this.MtHydra_Cave10=x(135,te);this.Styx1=x(136,{area:A.Styx,houseType:"palace"});this.Styx2=x(137);this.Styx2_East=x(-1);this.Styx3=x(138);this.Shyron=x(140,{area:A.Shyron});this.Goa=x(142,{area:A.Goa});this.GoaFortressBasement=x(143,{area:A.FortressBasement,music:0});this.Desert1=x(144,{area:A.Desert1});this.OasisCaveMain=x(145,{area:A.OasisCave});this.DesertCave1=x(146,{area:A.DesertCave1,music:0});this.Sahara=x(147,{area:A.Sahara});this.SaharaOutsideCave=x(148,{music:0});this.DesertCave2=x(149,{area:A.DesertCave2,music:1});this.SaharaMeadow=x(150,{area:A.SaharaMeadow,music:0});this.Desert2=x(152,{area:A.Desert2});this.Pyramid_Entrance=x(156,{area:A.Pyramid,houseType:"palace"});this.Pyramid_Branch=x(157);this.Pyramid_Main=x(158);this.Pyramid_Draygon=x(159);this.Crypt_Entrance=x(160,{area:A.Crypt});this.Crypt_Hall1=x(161);this.Crypt_Branch=x(162);this.Crypt_DeadEndLeft=x(163);this.Crypt_DeadEndRight=x(164);this.Crypt_Hall2=x(165);this.Crypt_Draygon2=x(166);this.Crypt_Teleporter=x(167,{music:"Crypt-Teleporter"});this.GoaFortress_Entrance=x(168,{area:A.GoaFortress,music:1,houseType:"palace"});this.GoaFortress_Kelbesque=x(169,{bossScreen:115,...ai});this.GoaFortress_Zebu=x(170,{...ai,palette:1});this.GoaFortress_Sabera=x(171,li);this.GoaFortress_Tornel=x(172,{bossScreen:145,...li,palette:1});this.GoaFortress_Mado1=x(173,hi);this.GoaFortress_Mado2=x(174,kr);this.GoaFortress_Mado3=x(175,kr);this.GoaFortress_Karmine1=x(176,wt);this.GoaFortress_Karmine2=x(177,wt);this.GoaFortress_Karmine3=x(178,wt);this.GoaFortress_Karmine4=x(179,wt);this.GoaFortress_Karmine5=x(180,wt);this.GoaFortress_Karmine6=x(181,ci);this.GoaFortress_Karmine7=x(182,{bossScreen:253,...ci});this.GoaFortress_Exit=x(183,{music:0});this.OasisCave_Entrance=x(184,{area:A.OasisEntrance,music:2});this.GoaFortress_Asina=x(185,{area:A.GoaFortress,...kr,bossScreen:145});this.GoaFortress_Kensu=x(186,wt);this.Goa_House=x(187,{area:A.Goa,...$,houseType:"house"});this.Goa_Inn=x(188,{...$,houseType:"inn"});this.Goa_ToolShop=x(190,{...$,houseType:"tool"});this.Goa_Tavern=x(191,{...$,houseType:"tavern"});this.Leaf_ElderHouse=x(192,{area:A.Leaf,...$,houseType:"house"});this.Leaf_RabbitHut=x(193,{...$,houseType:"shed"});this.Leaf_Inn=x(194,{...$,houseType:"inn"});this.Leaf_ToolShop=x(195,{...$,houseType:"tool"});this.Leaf_ArmorShop=x(196,{...$,houseType:"armor"});this.Leaf_StudentHouse=x(197,{...$,houseType:"house"});this.Brynmaer_Tavern=x(198,{area:A.Brynmaer,...$,houseType:"tavern"});this.Brynmaer_PawnShop=x(199,{...$,houseType:"pawn"});this.Brynmaer_Inn=x(200,{...$,houseType:"inn"});this.Brynmaer_ArmorShop=x(201,{...$,houseType:"armor"});this.Brynmaer_ItemShop=x(203,{...$,houseType:"tool"});this.Oak_ElderHouse=x(205,{area:A.Oak,...$,houseType:"house"});this.Oak_MotherHouse=x(206,{...$,houseType:"house"});this.Oak_ToolShop=x(207,{...$,houseType:"tool"});this.Oak_Inn=x(208,{...$,houseType:"inn"});this.Amazones_Inn=x(209,{area:A.Amazones,...$,houseType:"inn"});this.Amazones_ItemShop=x(210,{...$,houseType:"tool"});this.Amazones_ArmorShop=x(211,{...$,houseType:"armor"});this.Amazones_Elder=x(212,{...$,houseType:"house",fixed:[13,14]});this.Nadare=x(213,{area:A.Nadare});this.Portoa_FishermanHouse=x(214,{area:A.FishermanHouse,...$,music:0,houseType:"outside"});this.Portoa_PalaceEntrance=x(215,{area:A.PortoaPalace,houseType:"palace"});this.Portoa_FortuneTeller=x(216,{area:A.Portoa,fixed:[13,14],...ia,houseType:"house"});this.Portoa_PawnShop=x(217,{...$,houseType:"pawn"});this.Portoa_ArmorShop=x(218,{...$,houseType:"armor"});this.Portoa_Inn=x(220,{...$,houseType:"inn"});this.Portoa_ToolShop=x(221,{...$,houseType:"tool"});this.PortoaPalace_Left=x(222,{area:A.PortoaPalace,...$,houseType:"house"});this.PortoaPalace_ThroneRoom=x(223,$);this.PortoaPalace_Right=x(224,{...$,houseType:"house"});this.Portoa_AsinaRoom=x(225,{area:A.UndergroundChannel,...$,music:"asina"});this.Amazones_ElderDownstairs=x(226,{area:A.Amazones,...$});this.Joel_ElderHouse=x(227,{area:A.Joel,...$,houseType:"house"});this.Joel_Shed=x(228,{...$,houseType:"shed"});this.Joel_ToolShop=x(229,{...$,houseType:"tool"});this.Joel_Inn=x(231,{...$,houseType:"inn"});this.ZombieTown_House=x(232,{area:A.ZombieTown,...$,houseType:"house"});this.ZombieTown_HouseBasement=x(233,$);this.Swan_ToolShop=x(235,{area:A.Swan,...$,houseType:"tool"});this.Swan_StomHut=x(236,{...$,houseType:"shed"});this.Swan_Inn=x(237,{...$,houseType:"inn"});this.Swan_ArmorShop=x(238,{...$,houseType:"armor"});this.Swan_Tavern=x(239,{...$,houseType:"tavern"});this.Swan_PawnShop=x(240,{...$,houseType:"pawn"});this.Swan_DanceHall=x(241,{...$,houseType:"house"});this.Shyron_Temple=x(242,{area:A.ShyronTemple,bossScreen:112,houseType:"palace"});this.Shyron_TrainingHall=x(243,{area:A.Shyron,...$,houseType:"house"});this.Shyron_Hospital=x(244,{...$,houseType:"house"});this.Shyron_ArmorShop=x(245,{...$,houseType:"armor"});this.Shyron_ToolShop=x(246,{...$,houseType:"tool"});this.Shyron_Inn=x(247,{...$,houseType:"inn"});this.Sahara_Inn=x(248,{area:A.Sahara,...$,houseType:"inn"});this.Sahara_ToolShop=x(249,{...$,houseType:"tool"});this.Sahara_ElderHouse=x(250,{...$,houseType:"house"});this.Sahara_PawnShop=x(251,{...$,houseType:"pawn"});this.EastCave1=x(-1,{area:A.EastCave});this.EastCave2=x(-1);this.EastCave3=x(-1);this.FishermanBeach=x(-1,{area:A.FishermanHouse,...$});this.locsByScreen=new he(()=>[]);x.commit(this);for(let s=0;s<256;s++){if(this[s]){this.indexScreens(this[s]);continue}this[s]=new vs(e,s,{area:A.Unused,name:"",music:"",palette:""})}}indexScreens(e){for(let s of e.screens)for(let r of s)this.locsByScreen.get(r).push(e)}renumberScreen(e,s){let r=this.locsByScreen.get(e);this.locsByScreen.set(s,r),this.locsByScreen.delete(e);for(let n of r)for(let i of n.screens)for(let a=0;a<i.length;a++)i[a]===e&&(i[a]=s)}allocate(e,s){for(let r of this)if(!(r.used||s&&r.id<s.id))return e.id=r.id,e.used=!0,this.indexScreens(e),this[r.id]=e;throw new Error("No unused location")}write(){let e=this.rom.assembler();ie(e,sa,34040,40960),ie(e,ra,40960,48640),ie(e,na,37881,40960),ie(e,ii,40960,44032),ie(e,ii,44544,49152);for(let s of this)s.assemble(e);return[e.module()]}location(){}},vs=class extends K{constructor(e,s,r){super(e,s);this.data=r;this.monstersMoved=!1;this._isShop=void 0;this._meta=void 0;let n=s>=0?ne(e.prg,this.mapDataPointer)+49152:0;if(this.used=n>49152&&!!this.name,!this.used){this.bgm=this.originalBgm=0,this.layoutWidth=0,this.layoutHeight=0,this.animation=0,this.screens=[[0]],this.tilePalettes=[36,1,38],this.originalTilePalettes=[36,1,38],this.tileset=128,this.tileEffects=179,this.tilePatterns=[2,4],this.exits=[],this.entrances=[],this.flags=[],this.pits=[],this.spawns=[],this.spritePalettes=[0,0],this.spritePatterns=[0,0],this.checkpoint=this.saveable=!1;return}let i=ne(e.prg,n)+49152,a=ne(e.prg,n+2)+49152,l=ne(e.prg,n+4)+49152,c=ne(e.prg,n+6)+49152,h=ne(e.prg,n+8)+49152,u=this.used&&i!==n+10,m=c-l;this.exits=(()=>{let p=[],y=c;for(;!(e.prg[y]&128);)e.prg[y+2]!=255&&p.push(rt.from(e.prg,y)),y+=4;return e.prg[y]!==255&&(u=!!(e.prg[y]&64),m=(e.prg[y]&31)<<2),p})();let f=u?ne(e.prg,n+10)+49152:0;this.bgm=this.originalBgm=e.prg[i],this.layoutWidth=e.prg[i+1],this.layoutHeight=e.prg[i+2],this.animation=e.prg[i+3];let S=e.prg[i+4]?256:0;this.screens=W(this.height,p=>U(e.prg,i+5+p*this.width,this.width).map(y=>S|y)),this.tilePalettes=U(e.prg,a,3),this.originalTilePalettes=U(this.tilePalettes,0,3),this.tileset=e.prg[a+3],this.tileEffects=e.prg[a+4],this.tilePatterns=U(e.prg,a+5,2),this.entrances=qr(4,e.prg.slice(l,l+m),p=>$e.from(p)),this.flags=Xt(e.prg,h,2,255,1/0,p=>dt.from(p)),this.pits=f?Xt(e.prg,f,4,255,1/0,p=>yt.from(p)):[];let v=ne(e.prg,this.npcDataPointer)+65536,k=v!==65536;this.spritePalettes=k?U(e.prg,v+1,2):[0,0],this.spritePatterns=k?U(e.prg,v+3,2):[0,0],this.spawns=k?Xt(e.prg,v+5,4,255,1/0,p=>Kt.from(p)):[],this.checkpoint=!!(e.prg[196352|s]&128),this.saveable=!!(e.prg[196352|s]&1)}set meta(e){this._meta=e}get meta(){return this.ensureMeta(),this._meta}ensureMeta(){this._meta||(this._meta=It.of(this))}set musicGroup(e){this._musicGroup=e}get musicGroup(){return this.ensureMusicGroup(),this._musicGroup}ensureMusicGroup(){if(this._musicGroup==null){let e=this.data.music;this._musicGroup=typeof e!="number"?e:this.rom.locations[this.exits[e].dest].musicGroup}}set colorGroup(e){this._colorGroup=e}get colorGroup(){return this.ensureColorGroup(),this._colorGroup}ensureColorGroup(){if(this._colorGroup==null){let e=this.data.music;this._colorGroup=typeof e!="number"?e:this.rom.locations[this.exits[e].dest].colorGroup}}lazyInitialization(){this.ensureMeta(),this.ensureMusicGroup(),this.ensureColorGroup()}get name(){return this.data.name}get mapDataPointer(){if(this.id<0)throw new Error(`no mapdata pointer for ${this.name}`);return 82688+(this.id<<1)}get npcDataPointer(){if(this.id<0)throw new Error(`no npcdata pointer for ${this.name}`);return 102913+(this.id<<1)}get hasSpawns(){return this.spawns.length>0}mapPlane(){let e=new he(()=>new Set);for(let r of this.screens)for(let n of r)e.get(n>>>8).add(n);if(e.size!==1)throw new Error(`Non-unique screen page for ${this}: ${[...e.values()].map(r=>[...r].map(n=>{let[i]=this.rom.metascreens.getById(n);return`${L(n)} ${i?.name??"??"}`}).join(", ")).join(", ")}`);let[s]=e.keys();return s}isShop(){return this._isShop==null&&(this._isShop=this.rom.shops.findIndex(e=>e.location===this.id)>=0,this.id===251&&(this._isShop=!0)),this._isShop}spawn(e){let s=this.spawns[e-13];if(!s)throw new Error(`Expected spawn $${L(e)}`);return s}get width(){return this.layoutWidth+1}set width(e){this.layoutWidth=e-1}get height(){return this.layoutHeight+1}set height(e){this.layoutHeight=e-1}findOrAddEntrance(e,s){for(let r=0;r<this.entrances.length;r++){let n=this.entrances[r];if(n.screen===e&&n.coord===s)return r}return this.entrances.push($e.of({screen:e,coord:s})),this.entrances.length-1}assemble(e){if(!this.used)return;let s=this.id.toString(16).padStart(2,"0"),r=this.spawns.length?this.spritePalettes:[255,255],n=this.spawns.length?this.spritePatterns:[255,255],i=[],a=[0,...r,...n,...ft(this.spawns),255];e.segment("0c","0d"),e.reloc(`NpcData_${s}`);let l=e.pc();e.byte(...a),e.org(37377+(this.id<<1),`NpcData_${s}_Ptr`),e.word(l),e.segment("17"),e.org(48896|this.id),e.byte(+this.checkpoint<<7|+this.saveable),e.segment("0a","0b");let c=[];for(let w of ft(this.screens))c.push(w&255);let h=this.rom.compressedMapData?[this.bgm,this.layoutHeight<<4|this.layoutWidth,this.mapPlane()<<2|this.animation,...c]:[this.bgm,this.layoutWidth,this.layoutHeight,this.animation,this.mapPlane()?128:0,...c];e.reloc(`MapData_${s}_Layout`);let u=e.pc();e.byte(...h),i.push(u),e.reloc(`MapData_${s}_Graphics`);let m=e.pc();if(e.byte(...this.tilePalettes,this.tileset,this.tileEffects,...this.tilePatterns),i.push(m),this.height===1){for(let w of this.entrances)!w.used||w.y>191&&(w.y=191);for(let w of this.exits)w.yt>12&&(w.yt=12)}e.reloc(`MapData_${s}_Entrances`);let f=e.pc();e.byte(...ft(this.entrances)),i.push(f),e.reloc(`MapData_${s}_Exits`);let S=e.pc();e.byte(...ft(this.exits),128|(this.pits.length?64:0)|this.entrances.length),i.push(S),e.reloc(`MapData_${s}_Flags`);let v=e.pc();e.byte(...ft(this.flags),255),i.push(v);let k=ft(this.pits);if(k.length){e.reloc(`MapData_${s}_Pits`);let w=e.pc();e.byte(...k),i.push(w)}e.reloc(`MapData_${s}`);let p=e.pc();e.word(...i),e.org(33536+(this.id<<1),`MapData_${s}_Ptr`),e.word(p);let y=this.bossId();if(y!=null&&this.id!==95){let w=[n[0],void 0];this.id===166&&(w=[83,80]);let E=this.rom.bossKills[y].base,B=this.id===166?0:this.bgm,O=[,,,B,,...this.tilePalettes,,,,this.spritePalettes[0],,,,,,,,this.animation],[]=[w];e.segment("0f");for(let P=0;P<O.length;P++){let oe=O[P];oe!=null&&(e.org(E+P,`Boss_${y}_${P}`),e.byte(oe))}let q=47041+5*y;e.org(q,`Boss_${y}_Post`),e.byte(r[1])}}allScreens(){let e=new Set;for(let s of this.screens)for(let r of s)e.add(this.rom.screens[r]);return e}bossId(){for(let e=0;e<14;e++)if(this.rom.prg[129373+e]===this.id)return e}hasDolphin(){return this.id===96||this.id===100||this.id===104}isTower(){return(this.id&248)===88}reachableTiles(e=!1){this.hasDolphin()&&(e=!0);let s=new Set(this.exits.map(u=>u.screen<<8|u.tile)),r=new nt,n=this.rom.tilesets[this.tileset],i=this.rom.tileEffects[this.tileEffects-179],a=new Set;for(let u=0;u<this.height;u++){let m=this.screens[u];for(let f=0;f<this.width;f++){let S=this.rom.screens[m[f]],v=u<<4|f,k=this.flags.find(p=>p.screen===v);for(let p=0;p<240;p++){let y=v<<8|p;if(s.has(y))continue;let w=S.tiles[p],E=i.effects[w],B=e?E&4:E&6;k&&B&&w<32&&n.alternates[w]!=w&&(w=n.alternates[w],E=i.effects[w],B=e?E&4:E&6),B||a.add(y)}}}for(let u of a){let m=(u&15)===15?u+241:u+1;a.has(m)&&r.union([u,m]);let f=(u&240)===224?u+3872:u+16;a.has(f)&&r.union([u,f])}let l=r.map(),c=new Set;for(let u of this.entrances){if(!u.used)continue;let m=u.screen<<8|u.tile;c.add(l.get(m)||new Set)}let h=new Map;for(let u of c)for(let m of u){let f=this.screens[m>>>12][m>>>8&15],S=this.rom.screens[f];h.set(m,i.effects[S.tiles[m&255]])}return h}screenMover(){let e=new he(()=>[]),s=De.concat(this.spawns,this.exits,this.entrances);for(let r of s)e.get(r.screen).push(r);return(r,n)=>{for(let i of e.get(r))i.screen=n}}moveScreen(e,s){let r=De.concat(this.spawns,this.exits,this.entrances);for(let n of r)n.screen===e&&(n.screen=s)}monsterPlacer(e){this.monstersMoved=!0;let s=this.data.bossScreen,r=this.reachableTiles(!1),n=new Map([...r.keys()].map(m=>[m,0])),i=[],a=[],l=[],c=[],h=[],u=this.hasDolphin()?37:39;for(let[m,f]of n){let S=this.screens[m>>>12][m>>>8&15];if(S!==s){for(let v of aa(m,this.width,this.height))n.has(v)||n.set(v,f+1);!f&&!(r.get(m)&u)&&i.push(m),this.id===26?this.rom.screens[S].tiles[m&255]===240&&c.push(m):f>=2&&f<=4&&c.push(m),f>=3&&f<=7&&a.push(m),f>=12&&l.push(m)}}return m=>{let f=m.clearance(),S=m.placement(),v=[...S==="normal"?i:S==="moth"?a:S==="bird"?l:S==="plant"?c:et(S)],k;e:for(;v.length;){let p=e.nextInt(v.length),[y]=v.splice(p,1),w=(y&3840)>>>4|y&15,E=(y&61440)>>>8|(y&240)>>>4;for(let{x:B,y:O,used:q}of this.entrances){if(!q)continue;if((E-(O>>4))**2+(w-(B>>4))**2<(f+1)**2)continue e}for(let B of this.exits){if(!B.isSeamless())continue;let{x:O,y:q}=B;if((E-(q>>4))**2+(w-(O>>4))**2<(f+8)**2)continue e}for(let[,B,O,q]of h){let P=(E-O)**2+(w-B)**2;if(!P)continue e;if(P<(f+q)**2){(!k||k[2]<P)&&(k=[w,E,P]);continue e}}k=[w,E,1/0];break}if(k){let[p,y]=k;h.push([m,p,y,f]);let w=y&240|(p&240)>>>4,E=(y&15)<<4|p&15;return w<<8|E}}}resizeScreens(e,s,r,n,i=0){let a=this.width+s+n,l=this.height+e+r,c=Array.from({length:l},(h,u)=>(u-=e,Array.from({length:a},(m,f)=>(f-=s,u<0||f<0||u>=this.height||f>=this.width?i:this.screens[u][f]))));this.width=a,this.height=l,this.screens=c;for(let h of this.flags)h.xs+=s,h.ys+=e;for(let h of this.pits)h.fromXs+=s,h.fromYs+=e;for(let h of[...this.spawns,...this.exits])h.xt+=16*s,h.yt+=16*e;for(let h of this.entrances)!h.used||(h.x+=256*s,h.y+=256*e)}writeScreens2d(e,s){let r=e&15,n=e>>>4;for(let i=0;i<s.length;i++){let a=s[i];for(let l=0;l<a.length;l++){let c=a[l];c!=null&&(c<0&&(c=~c,this.flags.push(dt.of({screen:n+i<<4|r+l,flag:this.rom.flags.AlwaysTrue.id}))),this.screens[n+i][r+l]=c)}}}connect(e,s,r){let n=e<0?256:0,i=r<0?256:0;e=e<0?~e:e,r=r<0?~r:r;let a=e>>>4,l=e&15,c=r>>>4,h=r&15,u=this.screens[a][l],m=s.screens[c][h],[f,S]=di[n|u],[v,k]=di[i|m],p=this.entrances.length,y=s.entrances.length;this.entrances.push($e.of({y:a<<8|f>>>8,x:l<<8|f&255})),s.entrances.push($e.of({y:c<<8|v>>>8,x:h<<8|v&255}));for(let w of S)this.exits.push(rt.of({screen:e,tile:w,dest:s.id,entrance:y}));for(let w of k)s.exits.push(rt.of({screen:r,tile:w,dest:this.id,entrance:p}))}neighborForEntrance(e){let s=this.entrances[e];if(!s)throw new Error(`no entrance ${L(this.id)}:${e}`);for(let r of this.exits){if(r.screen!==s.screen)continue;let n=Math.abs(r.x-s.x),i=Math.abs(r.y-s.y);if(n<24&&i<24)return this.rom.locations[r.dest]}throw new Error(`no exit found near ${L(this.id)}:${e}`)}toString(){return`${super.toString()} ${this.name}`}};function aa(o,t,e){let s=[],r=o&61680,n=o&3855;return r<(e-1<<12|224)&&s.push((o&240)===224?o+3872:o+16),r&&s.push((o&240)===0?o-3872:o-16),n<(t-1<<8|15)&&s.push((o&15)===15?o+241:o+1),n&&s.push((o&15)===0?o-241:o-1),s}var di={21:[37024,[137,138]],25:[24720,[88,89]],150:[16432,[50,51]],151:[44848,[178,179]],152:[16592,[60,61]],153:[45008,[188,189]],154:[8064,[39,40]],158:[57216,[231,232]],193:[20640,[73,74]],194:[24752,[90,91]],410:[53376,[199,200]]};var je={empty:1,pit:2,arena:4,spikes:8,wide:16,river:32,bridge:64,wall:128,ramp:256,overpass:512,underpass:1024,whirlpool:2048,deadend:4096,"stair:up":65536,"stair:down":131072,portoa1:117440512,portoa2:184549376,portoa3:218103808,lake:234881024,lighthouse:318767104,cabin:352321536,windmill:369098752,altar:419430400,pyramid:436207616,crypt:469762048,manual:1073741824,consolidate:2147483648};function d(o){if(o.length!=1)throw new Error("Bad icon input");let e=o[0].split(`
`),s=e.slice(1).map(n=>n.replace(/^\s*\||\|\s*$/g,""));return{short:/\S/.test(e[0])?e[0][0]:s[1][1],full:[s[0],s[1],s[2]]}}function qe(o,...t){let e=o.split(/\s+/g);if(e[0]||e.shift(),e[e.length-1]||e.pop(),e.length!==240)throw new Error(`Bad screen definition: ${e.length}`);let s=new Map(t);return Uint8Array.from(e,(r,n)=>{let i=s.get(r);return typeof i=="number"?i:i?i.screen.tiles[n]:parseInt(r,16)})}function Re(o,t=2){let e=o>>>4,s=o&15;if(t===1){let n=e===14?10240:6144;return{type:"stair:up",dir:2,entrance:(e<<12)+n|(s<<4)+8,exits:[o]}}return{type:"stair:up",dir:0,entrance:e<<12|(s<<4)+(t<<3),exits:W(t,n=>o-16+n)}}function Ye(o,t=2){let e=o>>>4,s=o&15;return t===1?{type:"stair:down",dir:2,entrance:(e<<12)-2048|(s<<4)+8,exits:[o],allowedExits:[o+16,o-16]}:{type:"stair:down",dir:2,entrance:e<<12|3840|(s<<4)+(t<<3),exits:W(t,n=>o+16+n),allowedExits:[...W(t,n=>o+32+n),...W(t,n=>o+n)]}}function J(o,t="cave"){return{...Re(o+16),type:t}}function N(o,t="door"){return{...Re(o,1),type:t}}function ui(o){let t=o>>>4,e=o&15;return{type:"cave",dir:0,entrance:t<<12|e<<4|15,exits:[o-15,o+1]}}function V({left:o=7,width:t=2,top:e=2,manual:s=!1}={}){return{type:"edge:top",manual:s,dir:0,entrance:e+1<<12|(o<<4)+(t<<3),exits:W(t,r=>e<<4|r+o)}}function X({left:o=7,width:t=2,shift:e=0,type:s="edge:bottom",manual:r=!1}={}){return{type:s,manual:r,dir:2,entrance:57088|(o<<4)+(t<<3)+16*e,exits:W(t,n=>224|n+o)}}function Ee({left:o=7,width:t=2,shift:e=0}={}){return{type:"edge:bottom",dir:2,entrance:44800|(o<<4)+(t<<3)+16*e,exits:W(t,s=>176|s+o)}}function xe({top:o=7,height:t=2,shift:e=0}={}){return{type:"edge:left",dir:1,entrance:(o<<12)+(16*e<<8)+(t<<11)|16,exits:W(t,s=>s+o<<4)}}function pe({top:o=7,height:t=2,shift:e=0}={}){return{type:"edge:right",dir:3,entrance:(o<<12)+(16*e<<8)+(t<<11)|239,exits:W(t,s=>s+o<<4|15)}}function Pt(o,t=2){return{type:"seamless:up",dir:0,get entrance(){throw new Error("does not make sense")},exits:W(t,e=>o+e)}}function St(o,t=2){return{type:"seamless:down",dir:2,get entrance(){throw new Error("does not make sense")},exits:W(t,e=>o+e)}}var Zt=class{constructor(t,e,s){this.rom=t;this.uid=e;this.data=s;this._tilesets=new Set;this.used=!1;this.neighbors=[new he(t=>this._checkNeighbor(t,0)),new he(t=>this._checkNeighbor(t,1))];for(let i of Object.values(s.tilesets))i.requires||(this.used=!0);let r=0;for(let i of s.feature??[]){let a=je[i];a!=null&&(r|=a)}for(let i of s.exits??[])(i.type==="stair:down"||i.type==="stair:up")&&(r|=je[i.type]);this._features=r,this._isEmpty=Boolean(r&je.empty),this.flag=s.flag;let n=[[[]],[[]],[[]],[[]]];this.connections=n;for(let i=0;i<4;i++){let a=0,l=0,c=n[i][0];for(let h of this.data.connect??""){if(ca[i].includes(h)){n[i].push(c=[]);continue}let u;if(!da.has(h)){if(h==="p")u=240|a++;else if(h==="x")u=224|l++;else{let m=parseInt(h,16);if(!m)throw new Error(`bad term: '${h}'`);let f=(m&3)<<(m&4),S=m&8?m&4?256:4096:0;u=f|S}c.push(u)}}for(;a<this.data.poi?.length;)c.push(240|a++);for(;l<this.data.exits?.length;)c.push(224|l++)}}get features(){return this._features}get manual(){return Boolean(this._features&fa)}get counted(){return Boolean(this._features&ma)}hasFeature(t){return Boolean(this._features&je[t])}hasFeatures(t){return(this._features&t)===t}withFeature(t){throw new Error}isEmpty(){return this._isEmpty}hasStair(){return Boolean(this._features&(je["stair:up"]|je["stair:down"]))}withObstruction(){throw new Error}isCompatibleWithTileset(t){for(let e of this._tilesets)if(e.tilesetId===t)return!0;return!1}replace(t,e){let{tiles:s}=this.screen;for(let r=0;r<s.length;r++)s[r]===t&&(s[r]=e);return this}remove(){for(let t of this.tilesets())t.deleteScreen(this)}tilesets(){let t=[];for(let e in this.data.tilesets)t.push(this.rom.metatilesets[e]);return t}setGridTile(...t){this.data.tile=t;for(let e of this.tilesets())e.invalidate()}gridTiles(){let t=this.data.tile??[];return Array.isArray(t)||(t=[t]),t.map(e=>e.replace(/\|/g,""))}get sid(){return this.data.id}set sid(t){this.sid!==t&&this.rom.metascreens.renumber(this.sid,t,new Set(this.tilesets()))}get screen(){let{sid:t,rom:{screens:e}}=this;return t<0?e.unallocated[~t]:e[t]}unsafeSetId(t){this.data.id=t;for(let e of this._tilesets)e.invalidate()}unsafeAddTileset(t){this._tilesets.add(t)}unsafeRemoveTileset(t){this._tilesets.delete(t)}edgeExits(){let t=0;for(let e of this.data.exits??[]){let s=la[e.type];s!=null&&(t|=1<<s)}return t}edgeIndex(t){let e=0,s=this.data.edges??"";for(let r=0;r<4;r++)if(s[r]!==" "){if(s[r]!==t)return;e|=1<<r}return e}findExitType(t,e,s){for(let r of this.data.exits??[]){if(r.type.startsWith("seamless")!==s)continue;let n=e&&r.type==="edge:bottom"&&t>=192?t+32:t;if(r.exits.includes(n)||(r.allowedExits??[]).includes(n))return r}}findExitByType(t){let e=this.data.exits.find(s=>s.type===t);if(!e)throw new Error(`no exit ${t}`);return e}findEntranceType(t,e){for(let s of this.data.exits??[]){if(s.type.startsWith("seamless"))continue;let r=e&&s.type==="edge:bottom"&&t>=48896?t+8192:t,n=(r&240)>>4|(r&61440)>>8;if(s.entrance===r||s.exits.includes(n)||(s.allowedExits??[]).includes(n))return s.type}}addCustomFlag(t){this.flag=t?"custom:true":"custom:false"}checkNeighbor(t,e){let s=e&2?this:t,r=e&2?t:this;return s.neighbors[e&1].get(r)}_checkNeighbor(t,e){let s=this.data.edges,r=t.data.edges;if(s&&r){let n=e^2;if(s[n]!=="*"&&s[n]===r[e])return!0}return!1}toString(){return`${Et(this.sid)} ${this.name}`}},la={"edge:top":0,"edge:left":1,"edge:bottom":2,"edge:right":3},ca=["|:","|:=-","|","|="],da=new Set(["|",":","-","="]),ha=new Set(["arena","portoa1","portoa2","portoa3","lake","overpass","underpass","lighthouse","cabin","windmill","altar","pyramid","crypt"]),ua=new Set(["pit","spikes","bridge","wall","ramp","whirlpool"]),fa=[...ha].map(o=>je[o]).reduce((o,t)=>o|t),ma=[...ua].map(o=>je[o]).reduce((o,t)=>o|t);var xa=!1,Ts=class{constructor(t){this.rom=t;this.length=0;this.screensByFix=new he(()=>[]);this.screensById=new he(()=>[]);this.registeredFixes=new Set;this.overworldEmpty=this.metascreen({id:0,icon:d`
      ||
      ||
      ||`,tile:"   |   |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryW_trees=this.metascreen({id:1,icon:d`
      | |
      |^|
      | |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},desert:{requires:[11]},sea:{requires:[7]}},edges:"> >o"});this.boundaryW=this.metascreen({id:2,icon:d`
      | |
      | |
      | |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"> >o"});this.boundaryE_rocks=this.metascreen({id:3,icon:d`
      |.|
      | |
      |.|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},desert:{requires:[11]},sea:{requires:[5]}},edges:"<o< "});this.boundaryE=this.metascreen({id:4,icon:d`
      | |
      | |
      | |`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<o< "});this.longGrassS=this.metascreen({id:5,icon:d`
      |vv |
      | vv|
      |   |`,tile:"olo|ooo|   ",tilesets:{river:{},grass:{requires:[1]}},edges:"looo"});this.longGrassN=this.metascreen({id:6,icon:d`
      |   |
      | vv|
      |vv |`,tile:"   |ooo|olo",tilesets:{river:{},grass:{requires:[1]}},edges:"oolo"});this.boundaryS_rocks=this.metascreen({id:7,icon:d`
      | . |
      ||
      ||`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},desert:{requires:[11]},sea:{requires:[5]}},edges:"o^ ^"});this.fortressTownEntrance=this.metascreen({id:8,icon:d`
      ||
      ||
      |   |`,placement:"manual",tile:["   |oFo|ooo","oo |oFo|ooo"],tilesets:{grass:{}},edges:" vov",exits:[{...Re(166,3),type:"fortress"}]});this.bendSE_longGrass=this.metascreen({id:9,icon:d`
      | v |
      |vv|
      | |`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.exitW_cave=this.metascreen({id:10,icon:d`
      ||
      |  |
      ||`,tile:["   |o< |   ","   |x< |   "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[4]}},edges:" n  ",exits:[J(72),xe({top:6})]});this.bendNE_grassRocks=this.metascreen({id:11,icon:d`
      |.|
      |  |
      |;;;|`,tile:"oo |ooo|ogo",tilesets:{grass:{},river:{requires:[3]},desert:{requires:[8,11]}},edges:"<osv"});this.cornerNW=this.metascreen({id:12,icon:d`
      ||
      | |
      | |`,tile:"   | oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"  >v"});this.overworldEmpty_alt=this.metascreen({id:12,icon:d`
      ||
      ||
      ||`,placement:"manual",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty","manual"],edges:"    ",match:()=>!1,delete:!0});this.cornerNE=this.metascreen({id:13,icon:d`
      ||
      ||
      | |`,tile:"   |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:" v< "});this.cornerSW=this.metascreen({id:14,icon:d`
      | |
      ||
      ||`,tile:" oo| oo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">  ^"});this.cornerSE=this.metascreen({id:15,icon:d`
      | |
      ||
      ||`,tile:"oo |oo |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  "});this.exitE=this.metascreen({id:16,icon:d`
      | |
      |   |
      | |`,tile:["oo |ooo|oo ","oo |oox|oo "],tilesets:{grass:{},river:{},desert:{requires:[11]}},edges:"<o<n",exits:[pe({top:6})]});this.boundaryN_trees=this.metascreen({id:17,icon:d`
      ||
      ||
      | ^ |`,tile:"   |ooo|ooo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[7]}},edges:" vov"});this.bridgeToPortoa=this.metascreen({id:18,icon:d`
      |  |
      ||
      |  |`,placement:"manual",tile:"roo|1rr| oo",tilesets:{river:{}},feature:["portoa3"],edges:"2*>r",exits:[xe({top:1})]});this.slopeAbovePortoa=this.metascreen({id:19,icon:d`
      ||
      ||
      |  |`,placement:"manual",tile:" \u2193 | oo|roo",tilesets:{river:{}},feature:["portoa2"],edges:"1*2v"});this.riverBendSE=this.metascreen({id:20,icon:d`
      |w  |
      | |
      |  |`,tile:"ooo|orr|oro",tilesets:{river:{}},edges:"oorr"});this.boundaryW_cave=this.metascreen({id:21,icon:d`
      | |
      | |
      | |`,tile:" oo| <o| oo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[4]}},edges:"> >o",exits:[J(137)]});this.exitN=this.metascreen({id:22,icon:d`
      | |
      | |
      | ^ |`,tile:[" o |ooo|ooo"," x |ooo|ooo"],tilesets:{grass:{},river:{},desert:{}},edges:"nvov",exits:[V()]});this.riverWE_woodenBridge=this.metascreen({id:23,icon:d`
      |   |
      ||
      |   |`,tile:"ooo|ror|ooo",tilesets:{river:{}},edges:"oror",exits:[Pt(119),St(135)]});this.riverBoundaryE_waterfall=this.metascreen({id:24,icon:d`
      | |
      |/|
      | |`,tile:"oo |rr |oo ",tilesets:{river:{}},edges:"<r< "});this.boundaryE_cave=this.metascreen({id:25,icon:d`
      | |
      |v|
      |v|`,tile:"oo |o< |oo ",tilesets:{river:{},grass:{requires:[1]},desert:{requires:[9]}},edges:"<o< ",exits:[J(88)]});this.exitW_southwest=this.metascreen({id:26,icon:d`
      | |
      | |
      ||`,tile:" oo|Boo|   ",tilesets:{grass:{},river:{},desert:{requires:[11]},sea:{requires:[5]}},edges:">* ^",exits:[xe({top:11})]});this.nadare=this.metascreen({id:27,tilesets:{house:{}},exits:[Ee(),N(35),N(37,"door2"),N(42,"door3")]});this.townExitW=this.metascreen({id:28,icon:d`
      | |
      | ^|
      | |`,tile:" oo|8oo| oo",tilesets:{grass:{},river:{}},edges:">n>o",exits:[xe({top:8,height:3,shift:-.5})]});this.shortGrassS=this.metascreen({id:29,icon:d` |
      |;;;|
      | v |
      |   |`,tile:"ogo|ooo|ooo",tilesets:{grass:{},river:{requires:[3,2]}},edges:"sooo"});this.townExitS=this.metascreen({id:30,icon:d`
      | ^ |
      | |
      | |`,tile:["ooo|ooo| o ","ooo|ooo| x "],tilesets:{grass:{},river:{},desert:{requires:[11,13]}},edges:"o^n^",exits:[X()]});this.swanGate=this.metascreen({id:31,tilesets:{town:{}},exits:[xe({top:3}),pe({top:9})],flag:"custom:false"});this.riverBranchNSE=this.metascreen({id:32,icon:d`
      |  |
      | |
      |  |`,tile:"oro|orr|oro",tilesets:{river:{}},edges:"rorr"});this.riverWE=this.metascreen({id:33,icon:d`
      |   |
      ||
      |   |`,tile:"ooo|rrr|ooo",tilesets:{river:{}},edges:"oror"});this.riverBoundaryS_waterfall=this.metascreen({id:34,icon:d`
      |  |
      ||
      |/|`,tile:"oro|oro|   ",tilesets:{river:{}},edges:"r^ ^"});this.shortGrassSE=this.metascreen({id:35,icon:d`
      |;;;|
      |;  |
      |; ^|`,tile:"ogo|goo|ooo",tilesets:{grass:{}},edges:"ssoo"});this.shortGrassNE=this.metascreen({id:36,icon:d` |
      |;  |
      |;v |
      |;;;|`,tile:"ooo|goo|ogo",tilesets:{grass:{}},edges:"osso"});this.stomHouseOutside=this.metascreen({id:37,icon:d`
      ||
      ||
      | |`,placement:"manual",tile:["   | H | o ","   | H | x "],tilesets:{grass:{}},exits:[N(104),X({shift:.5})]});this.bendNW_trees=this.metascreen({id:38,icon:d`
      | |
      | ^|
      | ^^|`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[11,12]},sea:{requires:[5,7]}},edges:">voo"});this.shortGrassSW=this.metascreen({id:39,icon:d`
      |;;;|
      |  ;|
      |^ ;|`,tile:"ogo|oog|ooo",tilesets:{grass:{},river:{requires:[3]}},edges:"soos"});this.riverBranchNWS=this.metascreen({id:40,icon:d`
      |  |
      | |
      |  |`,tile:"oro|rro|oro",tilesets:{river:{}},edges:"rrro"});this.shortGrassNW=this.metascreen({id:41,icon:d`
      |  ;|
      | v;|
      |;;;|`,tile:"ooo|oog|ogo",tilesets:{grass:{},river:{requires:[3,2]}},edges:"ooss"});this.valleyBridge=this.metascreen({id:42,icon:d` |
      ||
      |  |
      ||`,tile:[" o | o | o "," x | o | o "," o | o | x "],tilesets:{grass:{},river:{}},edges:"n n ",exits:[Pt(119),St(135),V(),X()]});this.exitS_cave=this.metascreen({id:43,icon:d`
      ||
      | |
      | |`,tile:["   | < | o ","   | < | x "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[4]}},edges:"  n ",exits:[J(103),X()]});this.outsideWindmill=this.metascreen({id:44,icon:d`
      ||
      ||
      | |`,placement:"manual",tile:["   | W | o ","   | W | x "],tilesets:{grass:{}},flag:"custom:false",feature:["windmill"],edges:"  n ",exits:[J(99),X(),N(137,"windmill"),N(140)]});this.townExitW_cave=this.metascreen({id:45,icon:d`
      ||
      ||
      ||`,tile:"   |x< |   ",tilesets:{grass:{}},edges:" n  ",exits:[J(74),xe({top:5,height:3,shift:-.5})],flag:"custom:true"});this.riverNS=this.metascreen({id:46,icon:d`
      |  |
      |  |
      |  |`,tile:"oro|ooo|oro",tilesets:{river:{}},edges:"roro",mod:"bridge"});this.riverNS_bridge=this.metascreen({id:47,icon:d`
      |  |
      |ww|
      |  |`,placement:"mod",tile:"oro|oro|oro",tilesets:{river:{}},feature:["bridge"],edges:"roro",wall:119});this.riverBendWS=this.metascreen({id:48,icon:d`
      | w|
      |w|
      |  |`,tile:"oo |rro|oro",tilesets:{river:{}},edges:"<rrv"});this.boundaryN_waterfallCave=this.metascreen({id:49,icon:d`
      |/|
      ||
      |  |`,tile:"   |oro|oro",tilesets:{river:{}},edges:" vrv",exits:[ui(117)]});this.open_trees=this.metascreen({id:50,icon:d`
      | ^ |
      |^ ^|
      | ^ |`,tile:"ooo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[12,11]}},edges:"oooo"});this.exitS=this.metascreen({id:51,icon:d`
      | w |
      | |
      | |`,tile:["ooo|ooo| o ","ooo|ooo| x |"],tilesets:{grass:{},river:{},desert:{requires:[10]},sea:{requires:[6]}},edges:"o^n^",exits:[X()]});this.bendNW=this.metascreen({id:52,icon:d`
      | |
      | |
      |   |`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">voo"});this.bendNE=this.metascreen({id:53,icon:d`
      | |
      |  |
      |   |`,tile:"oo |ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<oov"});this.bendSE=this.metascreen({id:54,icon:d`
      |   |
      | |
      | |`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.bendWS=this.metascreen({id:55,icon:d`
      |   |
      | |
      | |`,tile:"ooo|ooo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^>o"});this.towerPlain_upStair=this.metascreen({id:56,icon:d`
      |  |
      ||
      |   |`,tile:" t |ttt|   ",tilesets:{tower:{}},edges:"st t",exits:[V({left:8}),St(8,2)]});this.towerRobotDoor_downStair=this.metascreen({id:57,icon:d`
      |  |
      ||
      |  |`,tile:"   |ttt| t ",tilesets:{tower:{}},edges:" tst",exits:[Pt(232,2),St(248,2)]});this.towerDynaDoor=this.metascreen({id:58,icon:d`
      |  |
      ||
      |  |`,tile:"   | < | t ",tilesets:{tower:{}},edges:"  s ",exits:[J(103,"door")]});this.towerLongStairs=this.metascreen({id:59,icon:d`
      |  |
      |  |
      |  |`,tile:" t | t | t ",tilesets:{tower:{}},edges:"s s ",exits:[X()]});this.towerMesiaRoom=this.metascreen({id:60,tilesets:{tower:{}},exits:[Ee()]});this.towerTeleporter=this.metascreen({id:61,tilesets:{tower:{}},exits:[Ee(),J(87,"teleporter")]});this.caveAbovePortoa=this.metascreen({id:62,icon:d`
      ||
      ||
      ||`,placement:"manual",tile:"   | < | \u2193 ",tilesets:{river:{}},edges:"  1 ",feature:["portoa1"],exits:[J(102)]});this.cornerNE_flowers=this.metascreen({id:63,icon:d`
      ||
      |*|
      | |`,tile:"   |oo |oo ",tilesets:{grass:{}},edges:" v< "});this.towerEdge=this.metascreen({id:64,icon:d` |
      |   |
      | |
      |   |`,tile:"   |t t|   ",tilesets:{tower:{}},edges:" t t"});this.towerEdgeW=this.metascreen({id:64,icon:d` |
      |   |
      |  |
      |   |`,tile:"   |t  |   ",tilesets:{tower:{}},edges:" t  "});this.towerEdgeE=this.metascreen({id:64,icon:d` |
      |   |
      |  |
      |   |`,tile:"   |  t|   ",tilesets:{tower:{}},edges:"   t"});this.towerRobotDoor=this.metascreen({id:65,icon:d`
      | O |
      ||
      |   |`,tile:"   |ttt|   ",tilesets:{tower:{}},edges:" t t"});this.towerDoor=this.metascreen({id:66,icon:d`
      |  |
      ||
      |   |`,tile:"   |t<t|   ",tilesets:{tower:{}},edges:" t t",exits:[J(88)]});this.house_bedroom=this.metascreen({id:67,tilesets:{house:{}},exits:[Ee()]});this.shed=this.metascreen({id:68,tilesets:{house:{}},exits:[Ee(),J(73)],flag:"custom:false"});this.tavern=this.metascreen({id:69,tilesets:{house:{}},exits:[Ee()]});this.house_twoBeds=this.metascreen({id:70,tilesets:{house:{}},exits:[Ee()]});this.throneRoom_amazones=this.metascreen({id:71,tilesets:{house:{}},exits:[Ee({width:3}),Ye(76,1)]});this.house_ruinedUpstairs=this.metascreen({id:72,tilesets:{house:{}},exits:[Ee(),Ye(156,1)]});this.house_ruinedDownstairs=this.metascreen({id:73,tilesets:{house:{}},exits:[Re(86,1)]});this.foyer=this.metascreen({id:74,tilesets:{house:{}},exits:[Ee({shift:.5}),N(40),N(83,"door2"),N(92,"door3")]});this.throneRoom_portoa=this.metascreen({id:75,tilesets:{house:{}},exits:[Ee(),N(43)]});this.fortuneTeller=this.metascreen({id:76,tilesets:{house:{}},exits:[Ee(),N(86),N(89,"door2")]});this.backRoom=this.metascreen({id:77,tilesets:{house:{}},exits:[Ee()]});this.dojo=this.metascreen({id:78,tilesets:{house:{}},exits:[Ee({shift:-.5})]});this.windmillInside=this.metascreen({id:79,tilesets:{house:{}},exits:[Ee({left:9,width:1})]});this.horizontalTownMiddle=this.metascreen({id:80,tilesets:{town:{}},exits:[N(76),N(85,"door2")],tallHouses:[53]});this.brynmaerRight_exitE=this.metascreen({id:81,tilesets:{town:{type:"horizontal"}},exits:[pe({top:8}),N(65)]});this.brynmaerLeft_deadEnd=this.metascreen({id:82,tilesets:{town:{type:"horizontal"}},exits:[N(73),N(76,"door2")]});this.swanLeft_exitW=this.metascreen({id:83,tilesets:{town:{type:"horizontal"}},exits:[xe({top:9}),N(73),N(94,"door2")]});this.swanRight_exitS=this.metascreen({id:84,tilesets:{town:{type:"horizontal"}},exits:[X({left:3}),N(65),N(67,"door2"),N(87,"door3")]});this.horizontalTownLeft_exitN=this.metascreen({id:85,tilesets:{town:{type:"horizontal"}},exits:[V({left:13}),N(70),N(75,"door2")]});this.amazonesRight_deadEnd=this.metascreen({id:86,tilesets:{town:{type:"horizontal"}},exits:[N(64),N(88,"door2")]});this.saharaRight_exitE=this.metascreen({id:87,tilesets:{town:{type:"horizontal"}},exits:[pe({top:7}),N(64),N(102,"door2")]});this.portoaNW=this.metascreen({id:88,tilesets:{town:{type:"square"}},exits:[J(71,"fortress"),X()]});this.portoaNE=this.metascreen({id:89,tilesets:{town:{type:"square"}},exits:[N(99),N(138,"door2"),X({left:3,width:4})]});this.portoaSW_exitW=this.metascreen({id:90,tilesets:{town:{type:"square"}},exits:[xe({top:9}),N(134),V()]});this.portoaSE_exitE=this.metascreen({id:91,tilesets:{town:{type:"square"}},exits:[pe({top:9}),N(122),N(135,"door2")],tallHouses:[90]});this.dyna=this.metascreen({id:92,tilesets:{tower:{}},exits:[{type:"stair:down",manual:!0,dir:2,entrance:49024,exits:[]}]});this.portoaFisherman=this.metascreen({id:93,tilesets:{town:{type:"square"}},exits:[pe({top:6}),xe({top:4,height:6,shift:.5}),N(104)]});this.verticalTownTop_fortress=this.metascreen({id:94,tilesets:{town:{type:"vertical"}},exits:[J(71,"fortress"),X()]});this.shyronMiddle=this.metascreen({id:95,tilesets:{town:{type:"vertical"}},exits:[N(84),N(91,"door2"),V()]});this.shyronBottom_exitS=this.metascreen({id:96,tilesets:{town:{type:"vertical"}},exits:[X({left:3}),N(4),N(6,"door2"),N(153,"door3")]});this.zombieTownMiddle=this.metascreen({id:97,tilesets:{town:{type:"vertical"}},exits:[N(153),V()]});this.zombieTownBottom_caveExit=this.metascreen({id:98,tilesets:{town:{type:"vertical"}},exits:[J(146),N(35),N(77,"door2")]});this.leafNW_houseShed=this.metascreen({id:99,tilesets:{town:{type:"square"}},exits:[N(140),N(149,"door2")]});this.squareTownNE_house=this.metascreen({id:100,tilesets:{town:{type:"square"}},exits:[V({left:1}),N(183)]});this.leafSW_shops=this.metascreen({id:101,tilesets:{town:{type:"square"}},exits:[N(119),N(138,"door2")],tallHouses:[106]});this.leafSE_exitE=this.metascreen({id:102,tilesets:{town:{type:"square"}},exits:[pe({top:3,height:3,shift:-.5}),N(132)]});this.goaNW_tavern=this.metascreen({id:103,tilesets:{town:{type:"square"}},exits:[N(186)]});this.squareTownSW_exitS=this.metascreen({id:104,tilesets:{town:{type:"square"}},exits:[X({left:8}),N(132)]});this.goaSE_shop=this.metascreen({id:105,tilesets:{town:{type:"square"}},exits:[N(130)]});this.joelNE_shop=this.metascreen({id:106,tilesets:{town:{type:"square"}},exits:[N(167)]});this.joelSE_lake=this.metascreen({id:107,tilesets:{town:{type:"square"}}});this.oakNW=this.metascreen({id:108,tilesets:{town:{type:"square"}},exits:[N(231)]});this.oakNE=this.metascreen({id:109,tilesets:{town:{type:"square"}},exits:[N(96)]});this.oakSW=this.metascreen({id:110,tilesets:{town:{type:"square"}},exits:[N(124)]});this.oakSE=this.metascreen({id:111,tilesets:{town:{type:"square"}},exits:[X({left:0,shift:.5}),N(151)]});this.temple=this.metascreen({id:112,tilesets:{house:{}},exits:[Ee()]});this.wideDeadEndN=this.metascreen({id:113,icon:d`
      |  |
      | > |
      |   |`,tile:" w | > |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",exits:[Ye(199)],statues:[4]});this.goaWideDeadEndN=this.metascreen({id:113,icon:d`
      ||
      | > |
      |   |`,tile:" w | > |   ",tilesets:{labyrinth:{}},edges:"w   ",connect:"1|2x|3",exits:[Ye(199)],statues:[4]});this.wideHallNS=this.metascreen({id:114,icon:d`
      |  |
      |  |
      |  |`,tile:" w | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2a",statues:[1,7,13]});this.goaWideHallNS=this.metascreen({id:114,icon:d`
      ||
      ||
      ||`,tile:" w | w | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"19|2a|3b",statues:[1,7,13]});this.goaWideHallNS_blockedRight=this.metascreen({id:114,icon:d`
      ||
      | |
      ||`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[14],addWall:[157]}},edges:"w w ",connect:"19|2a|3|b"});this.goaWideHallNS_blockedLeft=this.metascreen({id:114,icon:d`
      ||
      | |
      ||`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[14],addWall:[81]}},edges:"w w ",connect:"1|9|2a|3b"});this.goaWideArena=this.metascreen({id:115,icon:d`<
      |<|
      ||
      ||`,placement:"manual",tile:"   | < | w ",tilesets:{labyrinth:{}},feature:["arena"],edges:"w w ",connect:"9b|a",exits:[Re(55)]});this.limeTreeLake=this.metascreen({id:116,tilesets:{lime:{}},exits:[Ee(),J(71)],feature:["bridge"],wall:103});this.swampNW=this.metascreen({id:117,icon:d`
      |  |
      | |
      |   |`,tile:" c |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss  ",connect:"26",exits:[V({left:6,width:4}),xe({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampE=this.metascreen({id:118,icon:d`
      |   |
      | |
      |   |`,tile:"   | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"   s",connect:"e",exits:[],poi:[[0]]});this.swampE_door=this.metascreen({id:118,icon:d`
      |  |
      | |
      |   |`,tile:"   | <c|   ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],flag:"always",edges:"   s",connect:"e",exits:[J(92,"swamp")]});this.swampNWSE=this.metascreen({id:119,icon:d`
      |  |
      ||
      |  |`,tile:" c |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ssss",connect:"26ae",exits:[V({left:6,width:4}),xe({top:7,height:4,shift:-.5}),X({left:6,width:4}),pe({top:7,height:4,shift:-.5})]});this.swampNWS=this.metascreen({id:120,icon:d`
      |  |
      | |
      |  |`,tile:" c |cc | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"sss ",connect:"26a",exits:[V({left:6,width:4}),xe({top:7,height:4,shift:-.5}),X({left:6,width:4})]});this.swampNE=this.metascreen({id:121,icon:d`
      |  |
      | |
      |   |`,tile:" c | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s  s",connect:"2e",exits:[V({left:6,width:4}),pe({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampWSE=this.metascreen({id:122,icon:d`
      |   |
      ||
      |  |`,tile:"   |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" sss",connect:"6ae",exits:[xe({top:7,height:4,shift:-.5}),X({left:6,width:4}),pe({top:7,height:4,shift:-.5})]});this.swampWSE_door=this.metascreen({id:122,icon:d`
      |  |
      ||
      |  |`,tile:"   |c<c| c ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],flag:"always",edges:" sss",connect:"6ae",exits:[J(86,"swamp")]});this.swampW=this.metascreen({id:123,icon:d`
      |   |
      | |
      |   |`,tile:"   |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s  ",connect:"6",poi:[[0]]});this.swampW_door=this.metascreen({id:123,icon:d`
      |  |
      | |
      |   |`,tile:"   |c< |   ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],flag:"always",edges:" s  ",connect:"6",exits:[J(84,"swamp")]});this.swampArena=this.metascreen({id:124,icon:d`
      |   |
      ||
      |  |`,tile:"   | a | c ",tilesets:{swamp:{}},feature:["arena"],edges:"  s ",connect:"a"});this.swampNWE=this.metascreen({id:125,icon:d`
      |  |
      ||
      |   |`,tile:" c |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss s",connect:"26e",exits:[V({left:6,width:4}),xe({top:7,height:4}),pe({top:7,height:4})]});this.swampWS=this.metascreen({id:126,icon:d`
      |   |
      | |
      |  |`,tile:"   |cc | c ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],update:[[15,(t,e,s)=>(s.metascreens.swampWS_door.flag="always",!0)]],edges:" ss ",connect:"6a",exits:[xe({top:7,height:4}),X({left:6,width:4})],poi:[[2]]});this.swampWS_door=this.metascreen({id:126,icon:d`
      |  |
      | |
      |  |`,tile:"   |c< | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" ss ",connect:"6a",exits:[J(87,"swamp")]});this.swampEmpty=this.metascreen({id:127,icon:d`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{swamp:{}},feature:["empty"],edges:"    ",connect:"",delete:!0});this.swampN=this.metascreen({id:-113,icon:d`
      |  |
      |  |
      |   |`,tile:" c | c |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s   ",connect:"2",poi:[[0]],definition:vt(qe(`.  .  .  .  cf f6 c7 ad c4 b7 f6 cc .  .  .  .
         .  .  .  .  cf f6 b8 b9 c3 b7 f6 cc .  .  .  .
         .  .  .  .  cf f6 b7 b8 ad ad d2 cc .  .  .  .
         .  .  .  .  cf d3 c2 c3 b7 b8 d2 cc .  .  .  .
         .  .  .  .  cf d3 b6 c2 b7 b7 f6 cc .  .  .  .
         .  .  .  .  cf d3 ad ad b9 b7 f6 cc .  .  .  .
         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .
         .  .  .  .  cf d3 b9 b8 ad ad d2 e2 .  .  .  .
         .  .  .  .  e3 f6 c3 c3 b8 b6 d2 .  .  .  .  .
         .  .  .  .  .  e3 fd ad ad fc e2 .  .  .  .  .
         .  .  .  .  .  .  ff fb fb fa .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .`,[".",200]))});this.swampS=this.metascreen({id:-114,icon:d`
      |   |
      |  |
      |  |`,tile:"   | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  s ",connect:"a",poi:[[0]],definition:vt(qe(`.  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  cd c9 c9 ca .  .  .  .  .  .
         .  .  .  .  .  cd eb a0 a0 cb ca .  .  .  .  .
         .  .  .  .  cf a0 f9 f5 f7 f8 cb cc .  .  .  .
         .  .  .  .  cf a0 ed 08 09 a0 a0 cc .  .  .  .
         .  .  .  .  cf db ee 0c 0b ef a0 cc .  .  .  .
         .  .  .  .  cf d0 d1 03 03 d8 db cc .  .  .  .
         .  .  .  .  cf f6 c7 ad ad ae d2 cc .  .  .  .
         .  .  .  .  cf d3 ad b9 b7 b7 f6 cc .  .  .  .
         .  .  .  .  cf d3 c2 c3 c3 b7 f6 cc .  .  .  .
         .  .  .  .  cf f6 c5 c3 c3 b7 f6 cc .  .  .  .
         .  .  .  .  cf d3 b6 c2 c3 c3 f6 cc .  .  .  .
         .  .  .  .  cf f6 b8 b6 b6 b6 d2 cc .  .  .  .
         .  .  .  .  cf f6 b7 b7 b7 b7 f6 cc .  .  .  .
         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .`,[".",200]))});this.swampNS=this.metascreen({id:-115,icon:d`
      |  |
      |  |
      |  |`,tile:" c | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s s ",connect:"2a",exits:[V({left:6,width:4}),X({left:6,width:4})],definition:vt(qe(`.  .  .  .  cf d3 b6 b6 c6 b6 f6 cc .  .  .  .
         .  .  .  .  cf d3 b6 c3 c7 b6 f6 cc .  .  .  .
         .  .  .  .  cf f5 c3 c7 b6 b6 d2 cc .  .  .  .
         .  .  .  .  cf d3 b6 b6 c6 c5 f6 cc .  .  .  .
         .  .  .  .  cf d9 b6 c6 c3 c7 d2 cc .  .  .  .
         .  .  .  .  cf f5 c3 c3 c3 c3 f6 cc .  .  .  .
         .  .  .  .  cf d9 ad c2 c3 c3 f6 cc .  .  .  .
         .  .  .  .  cf d9 c4 c5 c3 c3 f6 cc .  .  .  .
         .  .  .  .  cf f5 b7 b7 b8 b6 d2 cc .  .  .  .
         .  .  .  .  cf d9 c2 b8 b6 b6 d2 cc .  .  .  .
         .  .  .  .  cf d9 b6 c2 b7 b7 f6 cc .  .  .  .
         .  .  .  .  cf d9 b6 b6 b6 b6 d2 cc .  .  .  .
         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .
         .  .  .  .  cf d3 b9 b7 b7 b7 f6 cc .  .  .  .
         .  .  .  .  cf f6 b7 b7 c7 b6 d2 cc .  .  .  .`,[".",200]))});this.swampWE=this.metascreen({id:-116,icon:d`
      |   |
      ||
      |   |`,tile:"   |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s s",connect:"6e",exits:[xe({top:7,height:4,shift:-.5}),pe({top:7,height:4,shift:-.5})],definition:vt(qe(`.  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9
         a0 e4 e8 eb e4 a0 a0 a0 eb eb e8 f0 f1 a0 e4 a0
         a0 e5 e9 f9 f5 f6 f6 f7 ec f9 f7 f8 f2 a0 e5 a0
         a0 e6 f0 f1 e6 e0 08 09 ed de ea de f2 a0 e6 a0
         db e7 db f3 e7 e1 0c 0b dd df e0 df f3 db e7 e0
         d0 d1 da da d0 d1 03 03 d0 d1 d0 d1 da da da da
         ad c4 ad ad ad ad ad ad ad ad ad ad ad ad ad ad
         c2 c5 b8 c6 c4 c4 b9 c7 c4 c5 c5 c7 ad ad ad ad
         ad ad ad ad c2 c3 c3 c3 c3 c3 c7 ad ad ad ad ad
         fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .`,[".",200]))});this.swampWE_door=this.metascreen({id:-116,icon:d`
      |  |
      ||
      |   |`,tile:"   |c<c|   ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],flag:"always",edges:" s s",connect:"6e",exits:[J(86,"swamp")]});this.swampSE=this.metascreen({id:-117,icon:d`
      |   |
      | |
      |  |`,tile:"   | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  ss",connect:"ae",exits:[pe({top:7,height:4,shift:-.5}),X({left:6,width:4})],poi:[[2]],definition:vt(qe(`.  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .
         .  .  .  .  .  .  cd c9 c9 c9 c9 c9 c9 c9 c9 c9
         .  .  .  .  .  cd a0 a0 a0 e8 04 a0 e8 a0 a0 e4
         .  .  .  .  cf f8 a0 f0 f1 f5 f5 f7 e9 f4 f7 e5
         .  .  .  .  cf f6 f7 f8 f2 ea 06 aa e9 f0 f1 e6
         .  .  .  .  cf a0 dd e0 f3 e0 07 0c ea db f3 e7
         .  .  .  .  cf db d5 d0 d1 d1 03 03 d0 d1 da da
         .  .  .  .  cf d5 af c4 c4 ad ad ad ad ad c4 ad
         .  .  .  .  cf d3 b9 c3 c3 b8 ad ad ad c2 b7 b8
         .  .  .  .  cf f6 c3 c3 c3 c3 b8 ad ad ad ad ad
         .  .  .  .  cf f6 c7 ad c2 c3 c7 fc fb fb fb fb
         .  .  .  .  cf d3 ad ad ad ad d6 cc .  .  .  .
         .  .  .  .  cf d3 b9 b8 ad b9 f6 cc .  .  .  .
         .  .  .  .  cf f6 c7 ad b9 c7 d2 cc .  .  .  . 
         .  .  .  .  cf d3 b6 b9 c3 b8 d2 cc .  .  .  .`,[".",200]))});this.swampSE_door=this.metascreen({id:-117,icon:d`
      |  |
      | |
      |  |`,tile:"   | <c| c ",tilesets:{swamp:{requires:[15]}},feature:["consolidate"],flag:"always",edges:"  ss",connect:"ae",exits:[J(90,"swamp")]});this.swampNSE=this.metascreen({id:-118,icon:d`
      |  |
      | |
      |  |`,tile:" c | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s ss",connect:"2ae",exits:[V({left:6,width:4}),X({left:6,width:4}),pe({top:7,height:4,shift:-.5})],definition:vt(qe(`.  .  .  .  cf d3 c4 c3 c3 c3 f7 f8 ca .  .  .
         .  .  .  .  cf f5 c3 c3 c3 c3 f7 f7 a0 ca c9 c9
         .  .  .  .  cf f6 c3 c3 b8 b6 d2 f7 f8 e8 e4 a0
         .  .  .  .  cf f5 b7 c3 b7 b8 d2 f0 f1 e9 e5 de
         .  .  .  .  cf d3 c2 b8 c2 b8 d8 db f2 ea e6 df
         .  .  .  .  cf d3 ad ad ad ad ae d4 f3 dd e7 df
         .  .  .  .  cf d3 ad ad ad ad ad ae d0 d1 d0 d1
         .  .  .  .  cf d3 c2 c3 c3 b7 b8 ad ad ad ad ad
         .  .  .  .  cf d3 ad ad c2 b7 b7 b7 b8 c4 ad ad
         .  .  .  .  cf d3 ad ad b6 b9 b7 b7 b7 b7 b8 ad
         .  .  .  .  cf d3 ad c4 c3 b7 b8 fc fb fb fb fb
         .  .  .  .  cf d3 b6 ad ad ad d6 cc .  .  .  .
         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .
         .  .  .  .  cf d3 c4 c3 b7 b8 d2 cc .  .  .  .
         .  .  .  .  cf d3 b6 b9 b7 b7 f6 cc .  .  .  .`,[".",200]))});this.caveEmpty=this.metascreen({id:128,icon:d`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{cave:{},fortress:{},labyrinth:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"    ",delete:!0});this.dolphinCave_empty=this.metascreen({id:128,icon:d`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{dolphinCave:{}},feature:["empty"],edges:"    ",delete:!0});this.open=this.metascreen({id:128,icon:d`
      |   |
      |   |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{},sea:{}},edges:"oooo"});this.hallNS=this.metascreen({id:129,icon:d`
      |  |
      |  |
      |  |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",connect:"2a",poi:[[4]],exits:[X({left:6,width:4,manual:!0}),V({left:6,width:4,manual:!0})]});this.hallNS_unreachable=this.metascreen({id:129,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallWE=this.metascreen({id:130,icon:d`
      |   |
      ||
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",poi:[[4]]});this.hallWE_unreachable=this.metascreen({id:130,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallSE=this.metascreen({id:131,icon:d`
      |   |
      | |
      |  |`,tile:"   | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"  cc",connect:"ae",poi:[[2]]});this.hallSE_unreachable=this.metascreen({id:131,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallWS=this.metascreen({id:132,icon:d`
      |   |
      | |
      |  |`,tile:"   |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" cc ",connect:"6a",poi:[[2]]});this.hallWS_unreachable=this.metascreen({id:132,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNE=this.metascreen({id:133,icon:d`
      |  |
      | |
      |   |`,tile:" c | cc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c  c",connect:"2e",poi:[[2]],exits:[V({left:6,width:4,manual:!0})]});this.hallNE_unreachable=this.metascreen({id:133,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNW=this.metascreen({id:134,icon:d`
      |  |
      | |
      |   |`,tile:" c |cc |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc  ",connect:"26",poi:[[2]],exits:[V({left:6,width:4,manual:!0})]});this.hallNW_unreachable=this.metascreen({id:134,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchNSE=this.metascreen({id:135,icon:d`
      |  |
      | |
      |  |`,tile:" c | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c cc",connect:"2ae",poi:[[3]],exits:[V({left:6,width:4,manual:!0})]});this.branchNSE_unreachable=this.metascreen({id:135,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchNWSE=this.metascreen({id:136,icon:d`
      |  |
      ||
      |  |`,tile:" c |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cccc",connect:"26ae",poi:[[3]],exits:[V({left:6,width:4,manual:!0})]});this.branchNWSE_unreachable=this.metascreen({id:136,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchNWS=this.metascreen({id:137,icon:d`
      |  |
      | |
      |  |`,tile:" c |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"ccc ",connect:"26a",poi:[[3]],exits:[V({left:6,width:4,manual:!0})]});this.branchNWS_unreachable=this.metascreen({id:137,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchWSE=this.metascreen({id:138,icon:d`
      |   |
      ||
      |  |`,tile:"   |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" ccc",connect:"6ae",poi:[[3]]});this.branchWSE_unreachable=this.metascreen({id:138,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchNWE=this.metascreen({id:139,icon:d`
      |  |
      ||
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc c",connect:"26e",poi:[[3]],exits:[V({left:6,width:4,manual:!0})]});this.branchNWE_unreachable=this.metascreen({id:139,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNS_ramp=this.metascreen({id:140,icon:d`
      |  |
      |  |
      |  |`,tile:" c | / | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["ramp"],edges:"c c ",connect:"2a",exits:[V({left:6,width:4,manual:!0})]});this.hallNS_ramp_unreachable=this.metascreen({id:140,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNS_overBridge=this.metascreen({id:141,icon:d`
      |  |
      ||
      |  |`,tile:" c | b | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["overpass"],edges:"cbcb",connect:"2a",exits:[V({left:6,width:4,manual:!0})]});this.hallWE_underBridge=this.metascreen({id:142,icon:d`
      |  |
      ||
      |  |`,tile:"   |cbc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["underpass"],edges:"bcbc",connect:"6e"});this.hallNS_wall=this.metascreen({id:143,icon:d`
      |  |
      |  |
      |  |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",feature:["wall"],connect:"2=a",wall:135,mod:"wall",exits:[V({left:6,width:4,manual:!0})]});this.hallNS_wall_unreachable=this.metascreen({id:143,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallWE_wall=this.metascreen({id:144,icon:d`
      |   |
      ||
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},iceCave:{}},feature:["wall"],edges:" c c",connect:"6=e",wall:103,mod:"wall"});this.hallWE_wall_unreachable=this.metascreen({id:144,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNS_arena=this.metascreen({id:145,icon:d`
      ||
      |&|
      ||`,tile:[" n | a | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena"],edges:"c c ",connect:"2a",poi:[[1,96,120]],exits:[V(),X({left:6,width:4,manual:!0}),Pt(230,4),St(246,4)],arena:1});this.hallNS_arena_unreachable=this.metascreen({id:145,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.hallNS_arenaWall=this.metascreen({id:146,icon:d`
      ||
      |&|
      ||`,placement:"manual",tile:[" n | a | c "],tilesets:{cave:{},iceCave:{}},feature:["arena","wall"],edges:"n c ",connect:"2x=apx",wall:39,mod:"wall",poi:[[1,96,120]],exits:[V({top:1}),X({left:6,width:4,manual:!0})],arena:1});this.branchNWE_wall=this.metascreen({id:148,icon:d`
      |  |
      ||
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wall"],edges:"cc c",connect:"2x=6e",exits:[V({left:6,width:4})],mod:"wall",wall:55});this.branchNWE_wall_unreachable=this.metascreen({id:148,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.branchNWE_upStair=this.metascreen({id:149,icon:d`<
      | < |
      ||
      |   |`,tile:"   |c<c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",exits:[Re(71)]});this.branchNWE_upStair_unreachable=this.metascreen({id:149,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.deadEndW_upStair=this.metascreen({id:150,icon:d`<
      | < |
      | |
      |   |`,tile:"   |c< |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Re(66)]});this.deadEndW_upStair_unreachable=this.metascreen({id:150,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,32),delete:!0});this.deadEndW_downStair=this.metascreen({id:151,icon:d`>
      |   |
      | |
      | > |`,tile:"   |c> |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Ye(162)]});this.deadEndW_downStair_unreachable=this.metascreen({id:151,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,32),delete:!0});this.deadEndE_upStair=this.metascreen({id:152,icon:d`<
      | < |
      | |
      |   |`,tile:"   | <c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Re(76)]});this.deadEndE_upStair_unreachable=this.metascreen({id:152,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,208),delete:!0});this.deadEndE_downStair=this.metascreen({id:153,icon:d`>
      |   |
      | |
      | > |`,tile:"   | >c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Ye(172)]});this.deadEndE_downStair_unreachable=this.metascreen({id:153,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,208),delete:!0});this.deadEndNS_stairs=this.metascreen({id:154,icon:d`
      | > |
      |   |
      | < |`,placement:"manual",tile:" > |   | < ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2x|ax",exits:[Ye(23),Re(215)],match:t=>t(264,120)&&t(-48,120)});this.deadEndNS_stairs_unreachable=this.metascreen({id:154,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(264,120)&&!t(-48,120),delete:!0});this.deadEndN_stairs=this.metascreen({id:154,icon:d`
      | > |
      |   |
      |   |`,tile:[" c | > |   "," > |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",exits:[Ye(23)],match:t=>!t(264,120)&&t(-48,120)});this.deadEndS_stairs=this.metascreen({id:154,icon:d`
      |   |
      |   |
      | < |`,tile:["   | < | c ","   |   | < "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",exits:[Re(215)],match:t=>!t(-48,120)&&t(264,120)});this.deadEndNS=this.metascreen({id:155,icon:d`
      |  |
      |   |
      |  |`,placement:"manual",tile:" c |   | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c c ",connect:"2p|ap",poi:[[0,-48,120],[0,272,120]],match:t=>t(-48,120)&&t(272,120)});this.deadEndNS_unreachable=this.metascreen({id:155,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(-48,120)&&!t(272,120),delete:!0});this.deadEndN=this.metascreen({id:155,icon:d`
      |  |
      |   |
      |   |`,tile:[" c | c |   "," c |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c   ",connect:"2",poi:[[0,-48,120]],match:t=>!t(272,120)&&t(-48,120)});this.deadEndS=this.metascreen({id:155,icon:d`
      |   |
      |   |
      |  |`,tile:["   | c | c ","   |   | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"  c ",connect:"a",poi:[[0,272,120]],match:t=>!t(-48,120)&&t(272,120)});this.deadEndWE=this.metascreen({id:156,icon:d`
      |   |
      | |
      |   |`,placement:"manual",tile:"   |c c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c c",connect:"6p|ep",poi:[[0,112,-40],[0,112,264]],match:t=>t(112,-40)&&t(112,264)});this.deadEndWE_unreachable=this.metascreen({id:156,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(112,-40)&&!t(112,264),delete:!0});this.deadEndW=this.metascreen({id:156,icon:d`
      |   |
      |  |
      |   |`,tile:["   |cc |   ","   |c  |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c  ",connect:"6",poi:[[0,112,-40]],match:t=>!t(112,264)&&t(112,-40)});this.deadEndE=this.metascreen({id:156,icon:d`
      |   |
      |  |
      |   |`,tile:["   | cc|   ","   |  c|   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"   c",connect:"e",poi:[[0,112,264]],match:t=>!t(112,-40)&&t(112,264)});this.hallNS_entrance=this.metascreen({id:158,icon:d`
      |  |
      |  |
      |  |`,tile:" c | c | n ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c n ",connect:"2a",exits:[X()]});this.hallNS_entrance_unreachable=this.metascreen({id:158,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.channelExitSE=this.metascreen({id:159,icon:d`
      |   |
      | |
      |  |`,tilesets:{dolphinCave:{}},feature:["river"],edges:"  rr",exits:[X({left:5})]});this.channelBendWS=this.metascreen({id:160,icon:d`
      |  |
      | |
      | |`,tilesets:{dolphinCave:{}},feature:["river"],edges:" rr "});this.channelHallNS=this.metascreen({id:161,icon:d`
      |  |
      | |
      |  |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],wall:139,edges:"r r "});this.channelEntranceSE=this.metascreen({id:162,icon:d`
      |   |
      | |
      | |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[X({left:2})],wall:124,edges:"  rr"});this.channelCross=this.metascreen({id:163,icon:d`
      |  |
      ||
      ||`,tilesets:{dolphinCave:{}},feature:["river"],exits:[X({left:3}),X({left:11,type:"door"})],edges:"  rr"});this.channelDoor=this.metascreen({id:164,icon:d`
      | |
      ||
      |  |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[N(56)],wall:115,edges:" r  "});this.mountainFloatingIsland=this.metascreen({id:165,icon:d`*
      ||
      |* |
      ||`,placement:"manual",tile:"   | ap|   ",tilesets:{mountainRiver:{}},edges:"  wp",connect:"e"});this.mountainPathNE_stair=this.metascreen({id:166,icon:d`
      ||
      |  |
      ||`,tile:" / | pp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"l  p",connect:"2e",exits:[V()]});this.mountainBranchNWE=this.metascreen({id:167,icon:d`
      | |
      |   |
      ||`,tile:" p |ppp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp p",connect:"26e"});this.mountainPathWE_iceBridge=this.metascreen({id:168,icon:d`
      ||
      |  |
      ||`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},feature:["bridge"],edges:"wpwp",connect:"6-e:2a",wall:135});this.mountainPathSE=this.metascreen({id:169,icon:d`
      ||
      |  |
      | |`,tile:"   | pp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:"  pp",connect:"ae",exits:[pe({top:6,height:4}),X({left:6,width:4})]});this.mountainDeadEndW_caveEmpty=this.metascreen({id:170,icon:d`
      ||
      | |
      ||`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[J(56)]});this.mountainPathNE=this.metascreen({id:171,icon:d`
      | |
      |  |
      ||`,tile:" p | pp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"p  p",connect:"2e",exits:[pe({top:6,height:4}),V({left:6,width:4})]});this.mountainBranchWSE=this.metascreen({id:172,icon:d`
      ||
      |   |
      | |`,tile:"   |ppp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:" ppp",connect:"6ae"});this.mountainPathW_cave=this.metascreen({id:173,icon:d`
      ||
      |  |
      ||`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[J(85)]});this.mountainPathE_slopeS=this.metascreen({id:174,icon:d`
      ||
      |  |
      ||`,tile:"   | pp| \u2193 ",tilesets:{mountain:{}},edges:"  sp",connect:"ae"});this.mountainPathNW=this.metascreen({id:175,icon:d`
      | |
      |  |
      ||`,tile:" p |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp  ",connect:"26",exits:[xe({top:6,height:4}),V({left:6,width:4})]});this.mountainCave_empty=this.metascreen({id:176,icon:d`
      ||
      | |
      ||`,tile:"   | < |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"    ",connect:"",exits:[J(88)]});this.mountainPathE_cave=this.metascreen({id:177,icon:d`
      ||
      |  |
      ||`,tile:"   | <p|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"   p",connect:"e",exits:[J(87)]});this.mountainPathWE_slopeN=this.metascreen({id:178,icon:d`
      ||
      |   |
      ||`,tile:" \u2193 |ppp|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e"});this.mountainDeadEndW=this.metascreen({id:179,icon:d`
      ||
      |  |
      ||`,tile:"   |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6"});this.mountainPathWE=this.metascreen({id:180,icon:d`
      ||
      |   |
      ||`,tile:"   |ppp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p p",connect:"6e",exits:[xe({top:6,height:4}),pe({top:6,height:4})]});this.mountainArena_gate=this.metascreen({id:181,icon:d`#
      |#|
      | |
      ||`,tile:"   | < | / ",tilesets:{mountain:{},mountainRiver:{}},feature:["arena"],edges:"  l ",connect:"a",exits:[{...Re(71,3),type:"gate"}],flag:"custom:false"});this.mountainPathN_slopeS_cave=this.metascreen({id:182,icon:d`
      ||
      | |
      ||`,tile:" / | < | \u2193 ",tilesets:{mountain:{}},edges:"l s ",connect:"2a",exits:[J(90),V()]});this.mountainPathWE_slopeNS=this.metascreen({id:183,icon:d`
      ||
      |   |
      ||`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"26ae"});this.mountainPathWE_slopeN_cave=this.metascreen({id:184,icon:d`
      ||
      |   |
      ||`,tile:" \u2193 |p<p|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e",exits:[J(92)]});this.mountainPathWS=this.metascreen({id:185,icon:d`
      ||
      |  |
      | |`,tile:"   |pp | p ",tilesets:{mountain:{},mountainRiver:{}},edges:" pp ",connect:"6a",exits:[xe({top:6,height:4}),X({left:6,width:4})]});this.mountainSlope=this.metascreen({id:186,icon:d`
      ||
      ||
      ||`,tile:" \u2193 | \u2193 | \u2193 ",tilesets:{mountain:{}},edges:"s s ",connect:"2a"});this.mountainRiver=this.metascreen({id:186,icon:d`
      ||
      ||
      ||`,tile:[" r | r | r "," r | r |   "],tilesets:{mountainRiver:{}},edges:"w w ",connect:"2:e"});this.mountainPathE_gate=this.metascreen({id:187,icon:d`
      ||
      |  |
      ||`,tile:"   | <p|   ",tilesets:{mountain:{}},edges:"   p",connect:"e",exits:[J(87,"gate")]});this.mountainPathWE_inn=this.metascreen({id:188,icon:d`
      ||
      |   |
      ||`,tile:"   |p<p|   ",placement:"manual",tilesets:{mountain:{}},edges:" p p",connect:"6e",exits:[N(118)]});this.mountainPathWE_bridgeOverSlope=this.metascreen({id:189,icon:d`
      ||
      |  |
      ||`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"6e",exits:[Pt(182,4)]});this.mountainPathWE_bridgeOverRiver=this.metascreen({id:189,icon:d`
      ||
      |  |
      ||`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},edges:"wpwp",connect:"6e|2|a"});this.mountainSlope_underBridge=this.metascreen({id:190,icon:d`
      ||
      |  |
      ||`,tile:" \u2193 |p\u2193p| \u2193 ",placement:"manual",tilesets:{mountain:{}},edges:"spsp",connect:"2a",exits:[St(198,4)]});this.mountainEmpty=this.metascreen({id:191,icon:d`
      ||
      ||
      ||`,tile:"   |   |   ",tilesets:{mountain:{},mountainRiver:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryS=this.metascreen({id:192,icon:d`
      |   |
      ||
      ||`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^ ^"});this.boundaryN_cave=this.metascreen({id:193,icon:d`
      ||
      ||
      |   |`,tile:"   |o<o|ooo",tilesets:{grass:{},sea:{},desert:{},river:{requires:[4]}},edges:" vov",exits:[J(73)]});this.cornerSE_cave=this.metascreen({id:194,icon:d`
      | |
      ||
      ||`,tile:"oo |o< |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  ",exits:[J(90)]});this.waterfall=this.metascreen({id:195,icon:d`
      |   |
      ||
      |   |`,tile:"ooo|\u2193\u2193\u2193|ooo",tilesets:{sea:{}},edges:"oooo"});this.whirlpoolBlocker=this.metascreen({id:196,icon:d`
      |   |
      ||
      |   |`,tile:"ooo|\u2193#\u2193|ooo",tilesets:{sea:{}},feature:["whirlpool"],flag:"calm",edges:"oooo"});this.beachExitN=this.metascreen({id:197,icon:d`
      | |
      ||
      | |`,placement:"manual",tile:" x | bo| oo",tilesets:{sea:{}},edges:"n >v",exits:[V({left:9})]});this.whirlpoolOpen=this.metascreen({id:198,icon:d`
      |   |
      |  |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{sea:{}},feature:["whirlpool"],edges:"oooo",flag:"calm"});this.quicksandOpen=this.metascreen({id:198,icon:d`
      |   |
      |  |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{}},feature:["whirlpool"],edges:"oooo"});this.lighthouseEntrance=this.metascreen({id:199,icon:d`
      ||
      ||
      ||`,placement:"manual",tile:"oo |oLo|ooo",tilesets:{sea:{}},feature:["lighthouse"],edges:"<oov",exits:[J(42),N(117)]});this.beachCave=this.metascreen({id:200,icon:d`
      ||
      ||
      |   |`,placement:"manual",tile:"   |o<o|ooo",tilesets:{sea:{}},edges:" vov",exits:[J(40)]});this.beachCabinEntrance=this.metascreen({id:201,icon:d`
      | |
      | |
      ||`,placement:"manual",tile:"oo |oC8|   ",tilesets:{sea:{}},feature:["cabin"],edges:"<^ b",exits:[N(85),pe({top:8,height:3})]});this.oceanShrine=this.metascreen({id:202,icon:d`
      ||
      |*|
      | |`,placement:"manual",tile:"ooo|oAo|ooo",tilesets:{sea:{}},feature:["altar"],edges:"oooo"});this.pyramidEntrance=this.metascreen({id:203,icon:d`
      |  |
      ||
      |  |`,placement:"manual",tile:"ooo|oPo|ooo",tilesets:{desert:{}},feature:["pyramid"],edges:"oooo",exits:[J(167,"fortress")]});this.cryptEntrance=this.metascreen({id:204,icon:d`
      |  |
      |>|
      ||`,placement:"manual",tile:"ooo|oYo|ooo",tilesets:{desert:{}},feature:["crypt"],edges:"oooo",exits:[Ye(103)]});this.oasisLake=this.metascreen({id:205,icon:d`
      | ^ |
      |vOv|
      | vv|`,tile:"ooo|ooo|oro",placement:"manual",tilesets:{desert:{}},feature:["lake"],edges:"oo3o"});this.desertCaveEntrance=this.metascreen({id:206,icon:d`
      ||
      ||
      |  |`,tile:"ooo|o<o|ooo",tilesets:{desert:{},sea:{requires:[4]}},edges:"oooo",exits:[J(167)]});this.oasisCave=this.metascreen({id:207,icon:d`
      | vv|
      |v|
      | |`,placement:"manual",tile:"oro|o<o| oo",tilesets:{desert:{}},edges:"3^>o",exits:[Re(55)]});this.channelEndW_cave=this.metascreen({id:208,icon:d`
      ||
      | |
      ||`,tile:"   |r< |   ",tilesets:{dolphinCave:{}},feature:["river"],exits:[Re(87)]});this.boatChannel=this.metascreen({id:209,icon:d`
      ||
      ||
      ||`,tile:["   |888|   ","   |88x|   "],tilesets:{sea:{}},edges:" b b",exits:[{...pe({top:8,height:3}),entrance:40168},xe({top:8,height:3})]});this.channelWE=this.metascreen({id:210,icon:d`
      ||
      ||
      ||`,tile:"   |rrr|   ",tilesets:{dolphinCave:{}},feature:["river"]});this.riverCaveNWSE=this.metascreen({id:211,icon:d`
      ||
      ||
      ||`,tile:" r |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"rrrr",connect:"15p:3dp:79-bf",wall:182,poi:[[4,0,72],[4,0,152]]});this.riverCaveNS=this.metascreen({id:212,icon:d`
      ||
      ||
      ||`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3b",mod:"bridge"});this.riverCaveWE=this.metascreen({id:213,icon:d`
      ||
      ||
      ||`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" r r",connect:"5d:7f",mod:"bridge"});this.riverCaveNS_bridge=this.metascreen({id:214,icon:d`
      ||
      ||
      ||`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r r ",connect:"19-3b",wall:135});this.riverCaveWE_bridge=this.metascreen({id:215,icon:d`
      ||
      ||
      ||`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:" r r",connect:"5d-7f",wall:134});this.riverCaveSE=this.metascreen({id:216,icon:d`
      ||
      ||
      ||`,tile:"   | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"  rr",connect:"9d:bf"});this.riverCaveWS=this.metascreen({id:217,icon:d`
      ||
      ||
      ||`,tile:"   |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rr ",connect:"5b:79"});this.riverCaveNE=this.metascreen({id:218,icon:d`
      ||
      ||
      ||`,tile:" r | rr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r  r",connect:"1f:3d"});this.riverCaveNW=this.metascreen({id:219,icon:d`
      ||
      ||
      ||`,tile:" r |rr |   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr  ",connect:"15:37"});this.riverCaveWE_passageN=this.metascreen({id:220,icon:d`
      ||
      ||
      ||`,tile:" c |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"cr r",connect:"25d:7f"});this.riverCaveWE_passageS=this.metascreen({id:221,icon:d`
      ||
      ||
      ||`,tile:"   |rrr| c ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rcr",connect:"5d:7af"});this.riverCaveNS_passageW=this.metascreen({id:222,icon:d`
      ||
      ||
      ||`,tile:" r |cr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rcr ",connect:"169:3b"});this.riverCaveNS_passageE=this.metascreen({id:223,icon:d`
      ||
      ||
      ||`,tile:" r | rc| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rc",connect:"19:3be"});this.wideHallNE=this.metascreen({id:224,icon:d`
      |  |
      | |
      |   |`,tile:" w | ww|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w  w",connect:"2e"});this.goaWideHallNE=this.metascreen({id:224,icon:d`
      ||
      ||
      ||`,tile:" w | ww|   ",tilesets:{labyrinth:{}},edges:"w  w",connect:"1f|2e|3d"});this.goaWideHallNE_blockedLeft=this.metascreen({id:224,icon:d`
      ||
      | |
      ||`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[14],addWall:[97]}},edges:"w  w",connect:"1|f|2e|3d"});this.goaWideHallNE_blockedRight=this.metascreen({id:224,icon:d`
      | |
      ||
      ||`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[14],addWall:[13]}},edges:"w  w",connect:"1f|2e|3|d"});this.wideHallNW=this.metascreen({id:225,icon:d`
      |  |
      | |
      |   |`,tile:" w |ww |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww  ",connect:"26"});this.goaWideHallNW=this.metascreen({id:225,icon:d`
      ||
      ||
      ||`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[14],removeWall:109}},edges:"ww  ",connect:"15|26|37"});this.goaWideHallNW_blockedRight=this.metascreen({id:225,icon:d`
      ||
      | |
      ||`,tile:" w |ww |   ",tilesets:{labyrinth:{}},edges:"ww  ",connect:"15|26|3|7"});this.goaWideHallNW_blockedLeft=this.metascreen({id:225,icon:d`
      | |
      ||
      ||`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[14],addWall:[1],removeWall:109}},edges:"ww  ",connect:"1|5|26|37"});this.wideHallSE=this.metascreen({id:226,icon:d`
      |   |
      | |
      |  |`,tile:"   | ww| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  ww",connect:"ae"});this.goaWideHallSE=this.metascreen({id:226,icon:d`
      ||
      ||
      ||`,tile:"   | ww| w ",tilesets:{labyrinth:{}},edges:"  ww",connect:"9d|ae|bf"});this.goaWideHallSE_blockedLeft=this.metascreen({id:226,icon:d`
      ||
      | |
      ||`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[14],addWall:[97]}},edges:"  ww",connect:"9|d|ae|bf"});this.goaWideHallSE_blockedRight=this.metascreen({id:226,icon:d`
      ||
      ||
      | |`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[14],addWall:[221]}},edges:"  ww",connect:"9d|ae|b|f"});this.wideHallWS=this.metascreen({id:227,icon:d`
      |   |
      | |
      |  |`,tile:"   |ww | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" ww ",connect:"6a"});this.goaWideHallWS=this.metascreen({id:227,icon:d`
      ||
      ||
      ||`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[14],removeWall:157}},edges:" ww ",connect:"5b|6a|79"});this.goaWideHallWS_blockedRight=this.metascreen({id:227,icon:d`
      ||
      | |
      ||`,tile:"   |ww | w ",tilesets:{labyrinth:{}},edges:" ww ",connect:"5|b|6a|79"});this.goaWideHallWS_blockedLeft=this.metascreen({id:227,icon:d`
      ||
      ||
      | |`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[14],addWall:[209],removeWall:157}},edges:" ww ",connect:"5b|6a|7|9"});this.goaWideHallNS_stairs=this.metascreen({id:228,icon:d`
      ||
      ||
      ||`,tile:" w | H | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"1239ab"});this.goaWideHallNS_stairsBlocked13=this.metascreen({id:228,icon:d`
      ||
      ||
      ||`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[14],addWall:[65,141]}},edges:"w w ",connect:"12ab|3|9"});this.goaWideHallNS_stairsBlocked24=this.metascreen({id:228,icon:d`
      ||
      ||
      ||`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[14],addWall:[1,205]}},edges:"w w ",connect:"1|239a|b"});this.wideHallNS_deadEnds=this.metascreen({id:229,icon:d`
      |  |
      |   |
      |  |`,tile:" w |   | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2|a",match:t=>t(272,120)&&t(-48,120)});this.wideHall_deadEndN=this.metascreen({id:229,icon:d`
      |  |
      |   |
      |   |`,tile:[" w |   |   "," w | w |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",match:t=>!t(272,120)&&t(-48,120)});this.wideHall_deadEndS=this.metascreen({id:229,icon:d`
      |   |
      |   |
      |  |`,tile:["   |   | w ","   | w | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  w ",connect:"a",match:t=>t(272,120)&&!t(-48,120)});this.goaWideHallNS_deadEnd=this.metascreen({id:229,icon:d`
      ||
      ||
      ||`,tile:" w | = | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"139b|2|a"});this.goaWideHallNS_deadEndBlocked24=this.metascreen({id:229,icon:d`
      ||
      ||
      ||`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[14],addWall:[97,173]}},edges:"w w ",connect:"1|2|39|a|b"});this.goaWideHallNS_deadEndBlocked13=this.metascreen({id:229,icon:d`
      ||
      ||
      ||`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[14],addWall:[109,161]}},edges:"w w ",connect:"1b|2|3|9|a"});this.wideHallNWSE=this.metascreen({id:230,icon:d`
      |  |
      ||
      |  |`,tile:" w |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"wwww",connect:"26ae"});this.goaWideHallNWSE=this.metascreen({id:230,icon:d`
      ||
      ||
      ||`,tile:" w |www| w ",tilesets:{labyrinth:{}},edges:"wwww",connect:"26ae|15|3d|79|bf"});this.goaWideHallNWSE_blocked13=this.metascreen({id:230,icon:d`
      | |
      ||
      | |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[14],addWall:[13,209]}},edges:"wwww",connect:"26ae|15|3|d|7|9|bf"});this.goaWideHallNWSE_blocked24=this.metascreen({id:230,icon:d`
      | |
      ||
      | |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[14],addWall:[1,221]}},edges:"wwww",connect:"26ae|1|5|3d|79|b|f"});this.wideHallNWE=this.metascreen({id:231,icon:d`
      |  |
      ||
      |   |`,tile:" w |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww w",connect:"26e"});this.goaWideHallNWE=this.metascreen({id:231,icon:d`
      ||
      ||
      ||`,tile:" w |www|   ",tilesets:{labyrinth:{}},edges:"ww w",connect:"26e|15|3d|7f"});this.goaWideHallNWE_blockedTop=this.metascreen({id:231,icon:d`
      |  |
      ||
      ||`,tile:" w |www|   ",tilesets:{labyrinth:{requires:[14],addWall:[1,13]}},edges:"ww w",connect:"26e|1|5|3|d|7f"});this.wideHallWSE=this.metascreen({id:232,icon:d`
      |   |
      ||
      |  |`,tile:"   |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" www",connect:"6ae"});this.goaWideHallWSE=this.metascreen({id:232,icon:d`
      ||
      ||
      ||`,tile:"   |www| w ",tilesets:{labyrinth:{}},edges:" www",connect:"6ae|5d|79|bf"});this.goaWideHallWSE_blockedBottom=this.metascreen({id:232,icon:d`
      ||
      ||
      |  |`,tile:"   |www| w ",tilesets:{labyrinth:{requires:[14],addWall:[209,221]}},edges:" www",connect:"6ae|5d|7|9|b|f"});this.wideHallNS_wallTop=this.metascreen({id:233,icon:d`
      |  |
      |  |
      |  |`,tile:" n | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide","wall"],edges:"c w",connect:"2a",exits:[V({left:6,width:4})],wall:55,statues:[10]});this.goaWideHallNS_wallTop=this.metascreen({id:233,icon:d`
      |  |
      ||
      ||`,tile:" n | w | w ",tilesets:{labyrinth:{}},feature:["wall"],edges:"c w ",connect:"2ax|9|b",exits:[V({left:6,width:4})],wall:55,statues:[10]});this.wideHallWE=this.metascreen({id:234,icon:d`
      |   |
      ||
      |   |`,tile:"   |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" w w",connect:"6e"});this.goaWideHallWE=this.metascreen({id:234,icon:d`
      ||
      ||
      ||`,tile:"   |www|   ",tilesets:{labyrinth:{}},edges:" w w",connect:"5d|6e|7f"});this.pitWE=this.metascreen({id:235,tile:"   |cpc|   ",icon:d`
      |   |
      ||
      |   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:" c c",connect:"6e",platform:{type:"horizontal",coord:28728}});this.pitNS=this.metascreen({id:236,icon:d`
      |  |
      |  |
      |  |`,tile:" c | p | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:"c c ",connect:"2a",platform:{type:"vertical",coord:16504}});this.pitNS_unreachable=this.metascreen({id:236,icon:d`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:t=>!t(128,128),delete:!0});this.spikesNS_hallS=this.metascreen({id:237,icon:d`
      |  |
      |  |
      |  |`,tile:" s | s | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s c ",connect:"2a"});this.spikesNS_hallN=this.metascreen({id:238,icon:d`
      |  |
      |  |
      |  |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" c | s | s ",feature:["spikes"],edges:"c s ",connect:"2a"});this.spikesNS_hallWE=this.metascreen({id:239,icon:d`
      |  |
      ||
      |  |`,tile:" s |csc| s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"scsc",connect:"26ae"});this.spikesNS_hallW=this.metascreen({id:-225,icon:d`
      |  |
      | |
      |  |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s |cs | s ",feature:["spikes"],edges:"scs ",connect:"26a",definition:t=>qe(`L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R`,["L",t.metascreens.spikesNS_hallWE],["R",t.metascreens.spikesNS])});this.spikesNS_hallE=this.metascreen({id:-226,icon:d`
      |  |
      | |
      |  |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s | sc| s ",feature:["spikes"],edges:"s sc",connect:"2ae",definition:t=>qe(`L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R
         L L L L L L L L R R R R R R R R`,["L",t.metascreens.spikesNS],["R",t.metascreens.spikesNS_hallWE])});this.riverCave_deadEndsNS=this.metascreen({id:240,icon:d`
      |  |
      |   |
      |  |`,tile:" r |   | r ",placement:"manual",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r r ",connect:"1p:3p|9p:bp",poi:[[1,-48,72],[1,-48,152],[1,272,72],[1,272,152]]});this.riverCave_deadEndsN=this.metascreen({id:240,icon:d`
      |  |
      |   |
      |   |`,tile:[" r |   |   "," r | r |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r   ",connect:"1p:3p",poi:[[1,-48,72],[1,-48,152]],match:t=>!t(264,72)&&!t(264,152),mod:"bridge"});this.riverCave_deadEndsS=this.metascreen({id:240,icon:d`
      |   |
      |   |
      |  |`,tile:["   |   | r ","   | r | r "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"  r ",connect:"9p:bp",poi:[[1,272,72],[1,272,152]],match:t=>!t(-48,72)&&!t(-48,152),mod:"bridge"});this.riverCave_deadEndsWE=this.metascreen({id:241,icon:d`
      |   |
      | |
      |   |`,tile:"   |r r|   ",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r r",connect:"5p:7p|dp:fp",poi:[[1,96,-40],[1,160,-40],[1,96,264],[1,160,264]]});this.riverCave_deadEndsW=this.metascreen({id:241,icon:d`
      |   |
      |  |
      |   |`,tile:["   |r  |   ","   |rr |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r  ",connect:"5p:7p",poi:[[1,96,-40],[1,160,-40]],match:t=>!t(96,264)&&!t(160,264)});this.riverCave_deadEndsE=this.metascreen({id:241,icon:d`
      |   |
      |  |
      |   |`,tile:["   |  r|   ","   | rr|   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"   r",connect:"dp:fp",poi:[[1,96,264],[1,160,264]],match:t=>!t(96,-40)&&!t(160,-40)});this.riverCaveN_bridge=this.metascreen({id:242,icon:d`
      |  |
      |  |
      |   |`,tile:[" r | r |   "," r |   |   "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r   ",connect:"1-3",wall:23,match:t=>!t(208,72)&&!t(208,152)});this.riverCaveS_bridge=this.metascreen({id:242,icon:d`
      |   |
      |  |
      |  |`,tile:["   | r | r ","   |   | r "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"  r ",connect:"9-b",wall:198,match:t=>!t(16,72)&&!t(16,152)});this.riverCaveWSE=this.metascreen({id:243,icon:d`
      ||
      ||
      ||`,tile:"   |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rrr",connect:"5d:79:bf"});this.riverCaveNWE=this.metascreen({id:244,icon:d`
      ||
      ||
      ||`,tile:" r |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr r",connect:"15p:3dp:7f",poi:[[4,0,72],[4,0,152]]});this.riverCaveNWS=this.metascreen({id:-241,icon:d`
      ||
      ||
      ||`,tile:" r |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rrr ",connect:"15p:3b:79",poi:[[4,0,72]],definition:t=>qe(`A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         A A A A A A A A R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R
         B B B B B B B B R R R R R R R R`,["A",t.metascreens.riverCaveNWE],["B",t.metascreens.riverCaveWSE],["R",t.metascreens.riverCaveNS])});this.riverCaveNSE=this.metascreen({id:-242,icon:d`
      ||
      ||
      ||`,tile:" r | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rr",connect:"19:3dp:bf",poi:[[4,0,152]],definition:t=>qe(`L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L A A A A A A A A
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B
         L L L L L L L L B B B B B B B B`,["A",t.metascreens.riverCaveNWE],["B",t.metascreens.riverCaveWSE],["L",t.metascreens.riverCaveNS])});this.riverCaveNS_blockedRight=this.metascreen({id:245,icon:d`
      ||
      | |
      ||`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3p:bp",poi:[[0,64,152],[0,192,152]],mod:"block"});this.riverCaveNS_blockedLeft=this.metascreen({id:246,icon:d`
      ||
      | |
      ||`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"1p:3b:9p",poi:[[0,48,72],[0,176,72]],mod:"block"});this.spikesNS=this.metascreen({id:247,icon:d`
      |  |
      |  |
      |  |`,tile:" s | s | s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s s ",connect:"2a"});this.cryptArena_statues=this.metascreen({id:248,icon:d`<
      |&<&|
      | |
      ||`,tile:"   | a | c ",tilesets:{pyramid:{}},feature:["arena"],edges:"  c ",connect:"a",exits:[{...Re(87),type:"crypt"}],flag:"custom:false",arena:2});this.pyramidArena_draygon=this.metascreen({id:249,icon:d`
      ||
      ||
      ||`,tile:"   | a | w ",tilesets:{pyramid:{}},feature:["arena","pit"],edges:"  w ",connect:"a",arena:3});this.cryptArena_draygon2=this.metascreen({id:250,icon:d`
      ||
      |&|
      ||`,tile:" x | a | w ",tilesets:{pyramid:{}},feature:["arena"],edges:"c w ",connect:"2a",exits:[V({left:6,width:4})],flag:"custom:false",arena:4});this.cryptArena_entrance=this.metascreen({id:251,icon:d`
      |  |
      |  |
      |  |`,tile:" w | w | x ",tilesets:{pyramid:{}},edges:"w n ",connect:"2a",exits:[X()]});this.cryptTeleporter=this.metascreen({id:252,tilesets:{pyramid:{},tower:{}},exits:[X({left:6,width:4}),J(87,"teleporter")]});this.fortressArena_through=this.metascreen({id:253,icon:d`
      ||
      | |
      ||`,tile:[" c | a | w "," n | a | w "],tilesets:{fortress:{},pyramid:{}},feature:["arena"],edges:"n w ",connect:"2a",exits:[V()],arena:5});this.fortressTrap=this.metascreen({id:254,icon:d`
      ||
      |  |
      ||`,tile:"   | x | n ",tilesets:{fortress:{},pyramid:{}},feature:["pit"],edges:"  n ",connect:"a",exits:[X()]});this.shrine=this.metascreen({id:255,tilesets:{shrine:{}},exits:[X({left:6,width:5}),N(104)]});this.inn=this.metascreen({id:256,tilesets:{house:{}},exits:[{...N(134),entrance:37992}]});this.toolShop=this.metascreen({id:257,tilesets:{house:{}},exits:[{...N(134),entrance:37992}]});this.armorShop=this.metascreen({id:258,tilesets:{house:{}},exits:[{...N(134),entrance:37992}]});for(let e in this){let s=this[e];s instanceof Zt&&(s.name=e)}}metascreen(t){let e=this,s=new Zt(this.rom,e.length,t);e[e.length++]=s,this.screensById.get(s.sid).push(s);for(let r in t.tilesets){let n=r,i=t.tilesets[n];if(i.requires)for(let a of i.requires)this.screensByFix.get(a).push(s);else this.rom.metatilesets[n].addScreen(s)}return s}getById(t,e){let s=this.screensById.has(t)?[...this.screensById.get(t)]:[];return e!=null&&(s=s.filter(r=>r.isCompatibleWithTileset(e))),s}registerFix(t,e){for(let s of this.screensByFix.get(t)){let r=(s.data.update||[]).find(n=>n[0]===t);if(r){if(e==null)throw new Error("Seed required for update");if(!r[1](s,e,this.rom))continue}for(let n in s.data.tilesets){let i=n,a=s.data.tilesets[i];if(!a.requires)continue;let l=a.requires.indexOf(t);l<0||(a.requires.splice(l,1),a.requires.length||this.rom.metatilesets[i].addScreen(s))}}this.registeredFixes.add(t)}isFixed(t){return this.registeredFixes.has(t)}renumber(t,e,s){if(t===e)return;xa&&console.log(`renumber ${Et(t)} -> ${Et(e)}`);let r=this.screensById.get(e);if(r.length)throw new Error(`ID already used: ${Et(e)}: ${r.join(", ")}`);let n;for(let l of this.getById(t))s&&!l.tilesets().some(c=>s.has(c))||(l.data.definition&&(n=l.data.definition(this.rom),l.data.definition=void 0),l.unsafeSetId(e),r.push(l));this.screensById.delete(t);let i=this.rom.screens.getScreen(t);t>=0&&e<0&&(r[0].data.definition=vt(Uint8Array.from(i.tiles)));let a=i.clone(e);this.rom.screens.setScreen(e,a),i.used=!1,t<0&&(this.rom.screens.deleteScreen(t),n&&e>=0&&(a.tiles=Array.from(n))),this.rom.locations.renumberScreen(t,e)}checkExitTypes(){for(let t in this){let e=this[t],s=new Set;for(let r of e?.data?.exits||[])s.has(r.type)&&console.log(`duplicate: ${t} ${r.type}`),s.add(r.type)}}};function vt(o){return()=>o}var fi=230492,Es=class extends K{constructor(e,s){super(e,s);this.mirrored=null;if(this.pointer=fi+(this.id<<1),this.base=ne(e.prg,this.pointer)+196608,this.used=this.base>=229376,e.prg[this.base]===255){let r=ne(e.prg,this.base+1);for(let n=0;n<256;n++)if(ne(e.prg,fi+(n<<1))===r){this.mirrored=n;break}if(this.mirrored==null)throw new Error(`could not find mirrored sprite for ${L(s)}: ${L(r)}`);this.size=0,this.frameMask=0,this.frames=0,this.sprites=[]}else this.mirrored=null,this.size=e.prg[this.base],this.frameMask=e.prg[this.base+1],this.frames=this.frameMask+1,this.sprites=W(this.frames,r=>{let n=this.base+2+r*4*this.size,i=[];for(let a=0;a<this.size&&e.prg[n+4*a]!==128;a++)i.push(U(e.prg,n+4*a,4));return i})}patternBanks(e=0){if(!this.used)return[];let s=this;s.mirrored&&(s=this.rom.metasprites[s.mirrored]);let r=new Set;for(let n of s.sprites)for(let[i,,,a]of n){if(i===128)break;r.add(a+e>>>6&255)}return[...r]}palettes(){if(!this.used)return[];let e=this;e.mirrored&&(e=this.rom.metasprites[e.mirrored]);let s=new Set;for(let r of e.sprites)for(let[n,,i]of r){if(n===128)break;s.add(i&3)}return[...s]}};var _s=class{constructor(t){this.rom=t;this._all=[];this.grass=this.tileset(128,{patterns:[0,12]});this.town=this.tileset(132,{});this.cave=this.tileset(136,{});this.dolphinCave=this.tileset(136,{});this.pyramid=this.tileset(140,{});this.river=this.tileset(144,{animated:[0,1],patterns:[20,0]});this.sea=this.tileset(148,{});this.lime=this.tileset(148,{});this.mountain=this.tileset(148,{});this.shrine=this.tileset(152,{});this.desert=this.tileset(156,{});this.mountainRiver=this.tileset(156,{});this.swamp=this.tileset(160,{consolidated:!0});this.house=this.tileset(160,{});this.fortress=this.tileset(164,{});this.labyrinth=this.tileset(164,{});this.iceCave=this.tileset(168,{});this.tower=this.tileset(172,{});for(let e in this){let s=this[e];s instanceof ks&&(s.name=e)}}tileset(t,e){let s=new ks(this.rom,t,e);return this._all.push(s),s}[Symbol.iterator](){return this._all[Symbol.iterator]()}},ks=class{constructor(t,e,s){this.rom=t;this.tilesetId=e;this.data=s;this._screens=new Set;this._cache=void 0}[Symbol.iterator](){return this._screens[Symbol.iterator]()}get cache(){return this._cache||(this._cache=new Lr(this)),this._cache}get tileset(){return this.rom.tilesets[this.tilesetId]}get empty(){let t=this.cache.empty;if(!t)throw new Error(`No empty screen for ${this.name}`);return t}effects(){return this.tileset.effects()}getTile(t){return this.tileset.getTile(t)}addScreen(t){this._screens.add(t),t.unsafeAddTileset(this),this.invalidate()}deleteScreen(t){this._screens.delete(t),t.unsafeRemoveTileset(this),this.invalidate()}getMetascreens(t){return this.cache.fromId.get(t)??[]}getExits(t){return this.cache.exits.get(t)}getMetascreensFromTileString(t){return this.cache.tiles.has(t)?this.cache.tiles.get(t):[]}getScreensWithOnlyFeatures(...t){let e=0;for(let r of t)e|=je[r];let s=[];for(let r of this)r.features&~e||s.push(r);return s}withMod(t,e){let s=[];for(let r of this.cache.tiles.get(t))r.data.mod===e&&s.push(r);return s}unreachableVariant(t){for(let e of this)if(e.sid===t.sid&&e.isEmpty())return e;return t}isBannedVertical(t,e){return this.cache.bannedNeighbors[0].has(t.uid<<16|e.uid)}isBannedHorizontal(t,e){return this.cache.bannedNeighbors[1].has(t.uid<<16|e.uid)}invalidate(){this._cache=void 0}},mi;(r=>(r.N=0,r.W=1,r.S=2,r.E=3))(mi||(mi={}));var Lr=class{constructor(t){this.tileset=t;this.fromId=new he(()=>[]);this.exits=new he(()=>[]);this.tiles=new he(()=>[]);this.bannedNeighbors=[new Set,new Set];let e;for(let s of t){s.sid>=0&&this.fromId.get(s.sid).push(s),!e&&s.data.edges==="    "&&s.data.placement!=="manual"&&s.hasFeature("empty")&&!s.data.exits?.length&&(e=s);for(let i of s.data.exits??[])this.exits.get(i.type).push(s);let r=typeof s.data.tile=="string"?[s.data.tile]:s.data.tile;for(let i of r??[])this.tiles.get(i.replace(/\|/g,"")).push(s);(s.hasFeature("ramp")||s.hasFeature("overpass")||s.hasFeature("pit")||s.isEmpty())&&this.banDeadEndNeighbor(s);let n=t.rom.metascreens;this.banDeadEndNeighbor(n.branchNWE_wall,1),this.banNeighbor(n.deadEndS_stairs,n.deadEndN_stairs,2),this.banNeighbor(n.deadEndNS_stairs,n.deadEndN_stairs,2),this.banNeighbor(n.deadEndS_stairs,n.deadEndNS_stairs,2),this.banNeighbor(n.deadEndNS_stairs,n.deadEndNS_stairs,2)}this.empty=e??t.rom.metascreens.caveEmpty}banDeadEndNeighbor(t,e=15){for(let s of this.tileset)if(!!s.hasFeature("deadend"))for(let r=0;r<4;r++){let n=1<<r;!(e&n)||t.data.edges?.[r]!==" "&&s.data.edges?.[r^2]!==" "&&this.banNeighbor(t,s,r)}}banNeighbor(t,e,s){this.bannedNeighbors[s&1].add((s&2?t:e).uid<<16|(s&2?e:t).uid)}};var{$04:pa,$05:ba,$0e:xi,$1b:Si,$fe:As}=G,Ls=class extends Ce{constructor(e){super(205);this.rom=e;this.GoaSoldier=new M(this,11);this.LeafElder=new M(this,13);this.LeafElderDaughter=new M(this,17);this.LeafRabbit=new M(this,19);this.WindmillGuard=new M(this,20);this.SleepingWindmillGuard=new M(this,21);this.Akahana=new M(this,22);this.OakElder=new M(this,29);this.OakMother=new M(this,30);this.OakChild=new M(this,31);this.Aryllis=new M(this,35);this.AmazonesGuard=new M(this,37);this.AryllisRightAttendant=new M(this,38);this.AryllisLeftAttendant=new M(this,39);this.Nadare=new M(this,40);this.SoldierGuard=new M(this,45);this.PortoaThroneRoomBackDoorGuard=new M(this,51);this.PortoaPalaceFrontGuard=new M(this,52);this.PortoaQueen=new Rr(this,56);this.FortuneTeller=new M(this,57);this.WaterfallCaveAdventurers=new M(this,58);this.JoelElder=new M(this,61);this.Clark=new M(this,68);this.ShyronGuard=new M(this,78);this.Brokahana=new M(this,84);this.SaharaBunny=new M(this,89);this.Deo=new M(this,90);this.SaharaElder=new M(this,91);this.SaharaElderDaughter=new M(this,92);this.Zebu=new M(this,94);this.Tornel=new M(this,95);this.Stom=new M(this,96);this.MesiaRecording=new M(this,97);this.Asina=new M(this,98);this.HurtDolphin=new M(this,99);this.Fisherman=new M(this,100);this.StartledVillagerOutsideCave=new M(this,101);this.KensuInCabin=new M(this,104);this.Dolphin=new Mr(this,105);this.SleepingKensu=new M(this,107);this.KensuDisguisedAsDancer=new M(this,108);this.KensuDisguisedAsSoldier=new M(this,109);this.AztecaInShyron=new M(this,110);this.DeadAkahana=new M(this,112);this.DeadStomsGirlfriend=new M(this,113);this.DeadStom=new M(this,114);this.KensuInSwan=new M(this,116);this.SlimedKensu=new M(this,117);this.FishermanDaughter=new M(this,123);this.Kensu=new M(this,126);this.AkahanaInBrynmaer=new M(this,130);this.AztecaInPyramid=new M(this,131);this.SaberaDisguisedAsMesia=new M(this,132);this.StonedWaterfallCaveAdventurers=new M(this,133);this.StonedAkahana=new M(this,136);this.Mesia=new M(this,142);this.Vampire1=new M(this,192);this.Insect=new M(this,193);this.Kelbesque1=new M(this,194);this.Rage=new M(this,195);this.Kelbesque2=new M(this,197);this.Sabera2=new M(this,198);this.Mado2=new M(this,199);this.Karmine=new M(this,200);this.StatueOfMoon=new M(this,201);this.StatueOfSun=new M(this,202);this.Draygon=new M(this,203);this.Vampire2=new M(this,204);for(let r in this){let n=this[r];!this.hasOwnProperty(r)||!(n instanceof M)||(this[n.id]=n,n.name=Qe(r))}for(let r=0;r<205;r++)this[r]||(this[r]=new M(this,r));let s=Ar.readAddress(e.prg);this.movementScripts=W(16,r=>{let n=s.plus(2*r).readAddress(e.prg).offset,i=[];for(;e.prg[n]<128;)i.push(e.prg[n++]);let a=e.prg[n];return{steps:i,terminate:a}})}write(){let e=this.rom.assembler();for(let i of this)!i||!i.used||i.assemble(e);ie(e,Si,44804,44969);let s=[];e.segment("1b","fe","ff");let r=0;for(let i of this.movementScripts){let a=(e.reloc(`MovementScript_${L(r++)}`),e.pc());e.byte(...i.steps,i.terminate),s.push(a)}let n=(e.reloc("MovementScriptTable"),e.pc());return e.word(...s),Ar.loc(e,"MovementScriptTablePtr"),e.word(n),Ar.plus(5).loc(e,"MovementScriptTablePlus1Ptr"),e.word({op:"+",args:[n,{op:"num",num:1}]}),[e.module()]}},M=class extends K{constructor(e,s){super(e.rom,s);this.npcs=e;this.spawnConditions=new Map;this.localDialogs=new Map;let r=e.rom;if(s>204)throw new Error(`Unavailable: ${s}`);this._used=!ga.has(s)&&(s<143||s>=192);let n=s<196?this.dialogPointer.readAddress(r.prg):null;n&&n.org===35641&&(n=null),this.data=U(r.prg,this.dataBase.offset,4);let a=this.spawnPointer.readAddress(r.prg).offset,l;for(;this.used&&(l=r.prg[a++])!==255;){let c=ir.read(r.prg,a);a+=2*c.length,this.spawnConditions.set(l,c)}if(this.globalDialogs=[],n){let c=n.offset;for(;;){let[m,f]=Dt.parse(r.prg,c);if(c+=4,m.condition&&this.globalDialogs.push(m),f)break}let h=[];for(;;){let m=r.prg[c++];if(m===255)break;h.push([m,r.prg[c++]])}h.length||h.push([-1,0]);let u=c;for(let[m,f]of h){let S=[];for(this.localDialogs.set(m,S),c=u+f;;){let[v,k]=Tt.parse(r.prg,c);if(c+=v.byteLength(),S.push(v),k)break}}}}get dataBase(){let e=this.id&128?ba:pa,s=33008|(this.id&252)<<6|(this.id&3)<<2;return j.of(e,s)}get spawnPointer(){return j.of(xi,34272+(this.id<<1))}get dialogPointer(){return j.of(xi,35165+(this.id<<1))}get used(){return this._used}set used(e){if(e&&this.id>136&&this.id<192&&this.id!==142)throw new Error(`invalid: ${this.id}`);this._used=e}spawnConditionsBytes(){let e=[];for(let[s,r]of this.spawnConditions)e.push(s,...ir.bytes(r));return e.push(255),e}dialog(e){let s=e?e.id:-1,r=this.localDialogs.get(s);if(r)return r;throw new Error(`No local dialog for NPC ${L(this.id)} at ${L(s)}`)}spawns(e){let s=e.id,r=this.spawnConditions.get(e.id);if(r)return r;throw new Error(`No spawn condition for NPC ${L(this.id)} at ${L(s)}`)}hasDialog(){let e=Boolean(this.globalDialogs.length||this.localDialogs.size);if(this.id>142&&this.id!==195&&e)throw new Error(`invalid: ${this.id}`);return e}*allDialogs(){yield*this.globalDialogs;for(let e of this.localDialogs.values())yield*e}dialogBytes(){if(!this.hasDialog())return[];let e=[];function s(i){let a=[];for(let l=0;l<i.length;l++)a.push(...i[l].bytes(l===i.length-1));return a}this.globalDialogs.length?e.push(...s(this.globalDialogs)):e.push(128,0,0,0);let r=[],n=new Map;for(let[i,a]of this.localDialogs){let l=s(a),c=l.join(","),h=n.get(c);if(h!=null){e.push(i,h);continue}n.set(c,r.length),i!==-1&&e.push(i,r.length),r.push(...l)}return r.length&&e.push(255,...r),e}link(e){let s=this.rom.npcs[e];this.spawnConditions=s.spawnConditions,this.linkDialog(e)}linkDialog(e){let s=this.rom.npcs[e];this.globalDialogs=s.globalDialogs,this.localDialogs=s.localDialogs}localDialog(e,s){s==null&&(s=e,e=-1);let r=this.localDialogs.get(e);if(r==null||s>=r.length)throw new Error(`No local dialog ${s} for location ${L(e)}`);return r[s]}isParalyzable(){for(let e=217176;e<217196;e++)if(this.rom.prg[e]===this.id)return!1;return!0}assemble(e){if(!this.used)return;let s=L(this.id);this.dataBase.loc(e,"PersonData_${id}"),e.byte(...this.data),e.segment("0e","fe","ff"),e.reloc(`SpawnCondition_${s}`);let r=e.pc();if(e.byte(...this.spawnConditionsBytes()),this.spawnPointer.loc(e,`SpawnCondition_${s}_Pointer`),e.word(r),this.hasDialog()){e.segment("0e","fe","ff"),e.reloc(`Dialog_${s}`);let n=e.pc();e.byte(...this.dialogBytes()),this.dialogPointer.loc(e,`Dialog_${s}_Pointer`),e.word(n)}}},Dt=class{constructor(t,e){this.condition=t;this.message=e}static of(t,e){let[s,r,n=0]=e;return new Dt(t,Se.of({part:s,index:r,action:n}))}static parse(t,e=0){let s=it(t,e),r=Se.from(t,e+2),n=s&1023,i=!!(s&32768);return s&8192&&(n=~n),[new Dt(n,r),i]}bytes(t){let e=this.condition;return e<0&&(e=~e|8192),t&&(e|=32768),[e>>>8,e&255,...this.message.data]}},Tt=class{constructor(t,e,s,r){this.condition=t;this.message=e;this.update=s;this.flags=r}clone(){return Tt.parse(this.bytes(!1))[0]}static parse(t,e=0){let s=it(t,e),r=Se.from(t,e+2),n=t[e+4];e+=5;let i=s&1023,a=!!(s&32768);s&8192&&(i=~i);let c=s&16384?tr.read(t,e):[];return[new Tt(i,r,n,c),a]}static of(t,e,s=[]){let[r,n,i=0]=e;return new Tt(t,Se.of({part:r,index:n,action:i}),0,s)}byteLength(){return 5+2*this.flags.length}bytes(t){let e=this.condition;return e<0&&(e=~e|8192),t&&(e|=32768),this.flags.length&&(e|=16384),[e>>>8,e&255,...this.message.data,this.update,...tr.bytes(this.flags)]}},ga=new Set([49,59,60,102,103,106,115,116,130,134,135,137,138,139,140,141,196]),Rr=class extends M{get expectedSword(){return this.localDialog(3).condition&255}set expectedSword(t){this.localDialog(3).condition=512|t}},Mr=class extends M{constructor(e,s){super(e,s);let r=e.rom.prg,n=yi.readAddress(r).offset,i=a=>{let l=$e.from(r,n+5*a),c=r[n+5*a+4];return{entrance:l,movement:c}};this.spawnScripts=W(9,i),this.channelSpawn=wi(bi.read(r)/5),this.evilSpiritIslandSpawn=wi(gi.read(r)/5)}assemble(e){super.assemble(e),e.segment("fe"),e.org(54952),e.free(45),e.segment("fe","ff"),e.reloc("DolphinSpawnTable");let s=e.pc();for(;!this.spawnScripts[this.spawnScripts.length-1].entrance.used;)this.spawnScripts.pop();for(let r=0;r<this.rom.locations.AngrySea.entrances.length;r++){let n=this.spawnScripts[r];n?e.byte(...n.entrance.data,n.movement):e.byte(255,15,255,15,15)}bi.loc(e,"DolphinChannelSpawn"),e.byte(this.channelSpawn*5),gi.loc(e,"DolphinEvilSpiritIslandSpawn"),e.byte(this.evilSpiritIslandSpawn*5),yi.loc(e,"DolphinSpawnTablePtr"),e.word(s);for(let r=0;r<4;r++)ya.plus(5*r).loc(e,`DolphinSpawnTablePlus${r+1}Ptr`),e.word({op:"+",args:[s,{op:"num",num:r+1}]})}},pi;(i=>(i.UP=0,i.RIGHT=2,i.DOWN=4,i.LEFT=6,i.DOLPHIN=255,i.DESPAWN=254))(pi||(pi={}));var bi=j.of(As,54884),gi=j.of(As,54892),yi=j.of(As,54906),ya=j.of(As,54926),Ar=j.of(Si,44627);function wi(o){if(o!==Math.floor(o))throw new Error(`Expected integer: ${o}`);return o}var z=class extends K{constructor(e,s,r,n={}){super(e.rom,s);this.type=r;this.data=n;e[s]=this}},Rs=class extends Ce{constructor(e){super();this.rom=e;this.straightShotOptionalBounce=new z(this,16,"projectile");this.straightShotNoBounce=new z(this,17,"projectile");this.madoShuriken=new z(this,22,"projectile");this.demonWallFire=new z(this,23,"projectile");this.popcorn=new z(this,27,"projectile");this.harpoonSource=new z(this,29,"source");this.lasers=new z(this,30,"projectile");this.paralysisPowder=new z(this,31,"projectile");this.randomMovement=new z(this,32,"monster",{movement:1});this.randomLargeStoner=new z(this,33,"monster",{hasChild:!0,large:!0,movement:2});this.slowHoming=new z(this,34,"monster",{hasChild:!0,movement:3});this.smallHoming1=new z(this,36,"monster",{movement:3});this.smallHoming2=new z(this,37,"monster",{movement:3});this.homingShooter1=new z(this,38,"monster",{hasChild:!0,projectile:1,movement:3});this.homingShooter2=new z(this,39,"monster",{hasChild:!0,projectile:1,movement:3});this.headShooter=new z(this,40,"monster",{hasChild:!0,projectile:2,movement:3,metasprites:()=>[101,145]});this.puddle=new z(this,41,"monster",{hasChild:!0,movement:5,metasprites:()=>[107,104]});this.soldier=new z(this,42,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:e=>[0,1,2,3].map(s=>s+e.data[31])});this.mimic=new z(this,43,"monster",{movement:4});this.mothResidueSource=new z(this,44,"source",{hasChild:!0});this.flailGuy=new z(this,46,"monster",{hasChild:!0,large:!0,projectile:2,movement:3});this.dynaLaser=new z(this,47,"projectile");this.guardianStatue=new z(this,52,"source",{hasChild:!0});this.movingPlatform=new z(this,56,"other");this.crumblingMovingPlatform=new z(this,60,"other");this.erraticFlyer=new z(this,64,"monster",{hasChild:!0,moth:!0,movement:4,placement:"moth"});this.skeleton=new z(this,65,"monster",{hasChild:!0,movement:3});this.swampTomato=new z(this,68,"monster",{movement:3});this.shootingFlyer=new z(this,69,"monster",{hasChild:!0,bird:!0,projectile:2,movement:5,placement:"bird"});this.swampPlant=new z(this,76,"monster",{hasChild:!0,stationary:!0,projectile:3,placement:"plant"});this.kraken=new z(this,77,"monster",{hasChild:!0,stationary:!0,projectile:3});this.burt=new z(this,78,"monster",{hasChild:!0,stationary:!0});this.dynaShot=new z(this,87,"projectile",{});this.popcorn2=new z(this,88,"projectile");this.towerSentinel=new z(this,92,"monster",{hasChild:!0,projectile:3,movement:1});this.helicopter=new z(this,93,"monster",{bird:!0,movement:6,placement:"bird"});this.whiteRobot=new z(this,94,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:e=>[0,1,2,3].map(s=>s+e.data[31])});this.vampire=new z(this,96,"boss");this.vampireBat=new z(this,97,"monster");this.kelbesque=new z(this,99,"boss");this.kelbesqueRock=new z(this,100,"projectile");this.sabera=new z(this,102,"boss");this.mado=new z(this,103,"boss");this.karmine=new z(this,104,"boss");this.draygon1=new z(this,106,"boss");this.draygon2=new z(this,107,"boss");this.dyna=new z(this,112,"boss");this.giantBug=new z(this,127,"boss")}};var Ms=class extends Ce{constructor(e){super(256);this.rom=e;this.mesiaSabera=new ke(this,42,"Mesia");this.sorcerorShot=new T(this,{id:63,scaling:37,type:"projectile"});this.wraith1=new T(this,{id:75,scaling:24,class:"wraith",displayName:"Wraith"});this.paralysisPowderSource=new T(this,{id:77,scaling:23,type:"projectile"});this.wraith2=new T(this,{id:79,scaling:28,class:"wraith",displayName:"Wraith"});this.blueSlime=new T(this,{id:80,scaling:1,class:"slime",displayName:"Slime"});this.weretiger=new T(this,{id:81,scaling:1,displayName:"Weretiger"});this.greenJelly=new T(this,{id:82,scaling:4,class:"jelly",displayName:"Slug"});this.redSlime=new T(this,{id:83,scaling:4,class:"slime",displayName:"Poison Slime"});this.rockGolem=new T(this,{id:84,scaling:4,class:"golem",displayName:"Mud Golem"});this.blueBat=new T(this,{id:85,scaling:4,displayName:"Bat"});this.greenWyvern=new T(this,{id:86,scaling:4,class:"wyvern",displayName:"Wyvern"});this.vampire1=new T(this,{id:87,scaling:5,type:"boss",displayName:"Vampire"});this.orc=new T(this,{id:88,scaling:6,displayName:"Axe Wereboar"});this.redMosquito=new T(this,{id:89,scaling:10,class:"mosquito",displayName:"Mosquito"});this.blueMushroom=new T(this,{id:90,scaling:10,class:"mushroom",displayName:"Mushroom"});this.swampTomato=new T(this,{id:91,scaling:10,displayName:"Pillbug"});this.blueMosquito=new T(this,{id:92,scaling:23,class:"mosquito",displayName:"Mosquito"});this.swampPlant=new T(this,{id:93,scaling:10,displayName:"Swamp Dandelion"});this.giantInsect=new T(this,{id:94,scaling:11,type:"boss",displayName:"Giant Insect"});this.largeBlueSlime=new T(this,{id:95,scaling:11,class:"slime",displayName:"Large Slime"});this.iceZombie=new T(this,{id:96,scaling:12,class:"zombie",displayName:"Ice Zombie"});this.greenBrain=new T(this,{id:97,scaling:12,class:"brain",displayName:"Brain"});this.greenSpider=new T(this,{id:98,scaling:12,class:"spider",displayName:"Spider"});this.redWyvern=new T(this,{id:99,scaling:12,class:"wyvern",displayName:"Wyvern"});this.soldier=new T(this,{id:100,scaling:14,class:"soldier",displayName:"Draygonia Soldier"});this.iceEntity=new T(this,{id:101,scaling:14,class:"entity",displayName:"Ice Plant"});this.redBrain=new T(this,{id:102,scaling:14,class:"brain",displayName:"Poison Brain"});this.iceGolem=new T(this,{id:103,scaling:14,class:"golem",displayName:"Ice Golem"});this.kelbesque1=new T(this,{id:104,scaling:15,type:"boss",displayName:"General Kelbesque"});this.largeRedSlime=new T(this,{id:105,scaling:18,class:"slime",displayName:"Large Poison Slime"});this.troll=new T(this,{id:106,scaling:18,displayName:"Troll"});this.redJelly=new T(this,{id:107,scaling:18,class:"jelly",displayName:"Poison Jelly"});this.medusa=new T(this,{id:108,scaling:19,displayName:"Medusa"});this.crab=new T(this,{id:109,scaling:19,displayName:"Crab"});this.medusaHead=new T(this,{id:110,scaling:20,displayName:"Flying Plant"});this.bird=new T(this,{id:111,scaling:20,class:"bird",displayName:"Bird"});this.redMushroom=new T(this,{id:113,scaling:21,class:"mushroom",displayName:"Poison Mushroom"});this.earthEntity=new T(this,{id:114,scaling:22,class:"entity",displayName:"Poison Plant"});this.mimic=new T(this,{id:115,scaling:22,displayName:"Mimic"});this.redSpider=new T(this,{id:116,scaling:22,class:"spider",displayName:"Paralyzing Spider"});this.fishman=new T(this,{id:117,scaling:25,displayName:"Mutant Fish"});this.jellyfish=new T(this,{id:118,scaling:25,displayName:"Jellyfish"});this.kraken=new T(this,{id:119,scaling:25,displayName:"Kraken"});this.darkGreenWyvern=new T(this,{id:120,scaling:27,class:"wyvern",displayName:"Wyvern Mage"});this.sandZombie=new T(this,{id:121,scaling:38,class:"zombie",displayName:"Sand Zombie"});this.wraithShadow1=new T(this,{id:123,scaling:28,class:"wraith",displayName:"Shadow"});this.moth=new T(this,{id:124,scaling:28,difficulty:3,displayName:"Butterfly"});this.sabera1=new T(this,{id:125,scaling:29,type:"boss",displayName:"General Sabera"});this.verticalPlatform=new ke(this,126);this.horizotalPlatform=new ke(this,127);this.archer=new T(this,{id:128,scaling:33,class:"soldier",displayName:"Draygonia Archer"});this.bomberBird=new T(this,{id:129,scaling:33,class:"bird",displayName:"Bomber Bird"});this.lavaBlob=new T(this,{id:130,scaling:37,class:"puddle",displayName:"Lava Blob"});this.flailGuy=new T(this,{id:132,scaling:37,displayName:"Flail Guy"});this.blueEye=new T(this,{id:133,scaling:37,class:"eye",displayName:"Beholder"});this.salamander=new T(this,{id:134,scaling:37,displayName:"Salamander"});this.sorceror=new T(this,{id:135,scaling:37,displayName:"Burt"});this.mado1=new T(this,{id:136,scaling:37,displayName:"General Mado"});this.knight=new T(this,{id:137,scaling:41,difficulty:1,displayName:"Ninja"});this.devil=new T(this,{id:138,scaling:41,displayName:"Devil Bat"});this.kelbesque2=new T(this,{id:139,scaling:41,type:"boss",displayName:"General Kelbesque"});this.wraithShadow2=new T(this,{id:140,scaling:41,class:"wraith",displayName:"Shadow"});this.glitch1=new ke(this,141);this.glitch2=new ke(this,142);this.guardianStatue=new ke(this,143);this.sabera2=new T(this,{id:144,scaling:41,type:"boss",displayName:"General Sabera"});this.tarantula=new T(this,{id:145,scaling:41,displayName:"Tarantula"});this.skeleton=new T(this,{id:146,scaling:41,displayName:"Skeleton"});this.mado2=new T(this,{id:147,scaling:41,type:"boss",displayName:"General Mado"});this.purpleEye=new T(this,{id:148,scaling:41,class:"eye",displayName:"Beholder"});this.flailKnight=new T(this,{id:149,scaling:41,displayName:"Flail Knight"});this.scorpion=new T(this,{id:150,scaling:41,displayName:"Scorpion"});this.karmine=new T(this,{id:151,scaling:41,type:"boss",displayName:"General Karmine"});this.sandBlob=new T(this,{id:152,scaling:44,class:"puddle",displayName:"Sand Blob"});this.mummy=new T(this,{id:153,scaling:44,displayName:"Mummy"});this.warlock=new T(this,{id:154,scaling:46,displayName:"Warlock"});this.draygon1=new T(this,{id:155,scaling:45,type:"boss",displayName:"Emperor Draygon"});this.statueOfSun=new ke(this,156);this.statueOfMoon=new ke(this,157);this.draygon2=new T(this,{id:158,scaling:47,type:"boss",displayName:"Emperor Draygon"});this.crumblingVerticalPlatform=new ke(this,159);this.brownRobot=new T(this,{id:160,scaling:47,difficulty:1,displayName:"Robot Sentry"});this.whiteRobot=new T(this,{id:161,scaling:47,displayName:"Robot Enforcer"});this.towerSentinel=new T(this,{id:162,scaling:47,displayName:"Tower Sentinel"});this.helicopter=new T(this,{id:163,scaling:47,displayName:"Robocopter"});this.dyna=new T(this,{id:164,scaling:47,type:"boss",displayName:"DYNA"});this.vampire2=new T(this,{id:165,scaling:28,type:"boss",displayName:"Vampire"});this.glitch3=new ke(this,166);this.dynaPod=new T(this,{id:180,scaling:47,type:"boss",displayName:"DYNA Defense Pod"});this.dynaCounter=new T(this,{id:184,scaling:47,type:"projectile"});this.dynaLaser=new T(this,{id:185,scaling:47,type:"projectile"});this.dynaBubble=new T(this,{id:186,scaling:47,type:"projectile"});this.vampire2Bat=new T(this,{id:188,scaling:28});this.brownRobotLaserSource=new T(this,{id:190,scaling:47,type:"projectile"});this.draygon2Fireball=new T(this,{id:191,scaling:47,type:"projectile"});this.vampire1Bat=new T(this,{id:193,scaling:5});this.giantInsectFireball=new T(this,{id:195,scaling:11,type:"projectile"});this.greenMosquito=new T(this,{id:196,scaling:11,displayName:"Mosquito"});this.kelbesque1Rock=new T(this,{id:197,scaling:15,type:"projectile"});this.sabera1Balls=new T(this,{id:198,scaling:29,type:"projectile"});this.kelbesque2Fire=new T(this,{id:199,scaling:41,type:"projectile"});this.sabera2Fire=new T(this,{id:200,scaling:41,type:"projectile"});this.sabera2Balls=new T(this,{id:201,scaling:41,type:"projectile"});this.karmineBalls=new T(this,{id:202,scaling:41,type:"projectile"});this.statueBalls=new T(this,{id:203,scaling:47,type:"projectile"});this.draygon1Lightning=new T(this,{id:204,scaling:45,type:"projectile"});this.draygon2Laser=new T(this,{id:205,scaling:47,type:"projectile"});this.draygon2Breath=new T(this,{id:206,scaling:47,type:"projectile"});this.birdBomb=new T(this,{id:224,scaling:33,type:"projectile"});this.greenMosquitoShot=new T(this,{id:226,scaling:11,type:"projectile"});this.paralysisBeam=new T(this,{id:227,scaling:25,type:"projectile"});this.stoneGaze=new T(this,{id:228,scaling:19,type:"projectile"});this.rockGolemRock=new T(this,{id:229,scaling:4,type:"projectile"});this.curseBeam=new T(this,{id:230,scaling:41,type:"projectile"});this.mpDrainWeb=new T(this,{id:231,scaling:41,type:"projectile"});this.fishmanTrident=new T(this,{id:232,scaling:25,type:"projectile"});this.orcAxe=new T(this,{id:233,scaling:6,type:"projectile"});this.swampPollen=new T(this,{id:234,scaling:10,type:"projectile"});this.paralysisPowder=new T(this,{id:235,scaling:23,type:"projectile"});this.soldierSword=new T(this,{id:236,scaling:14,type:"projectile"});this.iceGolemRock=new T(this,{id:237,scaling:14,type:"projectile"});this.trollAxe=new T(this,{id:238,scaling:18,type:"projectile"});this.krakenInk=new T(this,{id:239,scaling:25,type:"projectile"});this.archerArrow=new T(this,{id:240,scaling:33,type:"projectile"});this.knightSword=new T(this,{id:242,scaling:41,type:"projectile"});this.mothResidue=new T(this,{id:243,scaling:28,type:"projectile"});this.brownRobotLaser=new T(this,{id:244,scaling:47,type:"projectile"});this.whiteRobotLaser=new T(this,{id:245,scaling:47,type:"projectile"});this.towerSentinelLaser=new T(this,{id:246,scaling:47,type:"projectile"});this.skeletonShot=new T(this,{id:247,scaling:41,type:"projectile"});this.blobShot=new T(this,{id:248,scaling:37,type:"projectile"});this.flailKnightFlail=new T(this,{id:249,scaling:41,type:"projectile"});this.flailGuyFlail=new T(this,{id:250,scaling:37,type:"projectile"});this.madoShuriken=new T(this,{id:252,scaling:37,type:"projectile"});this.guardianStatueMissile=new T(this,{id:253,scaling:36,type:"projectile"});this.demonWallFire=new T(this,{id:254,scaling:37,type:"projectile"});for(let s in this){let r=this[s];r instanceof ke&&(r.name=Ur(s))}for(let s=0;s<this.length;s++)this[s]||(this[s]=new ke(this,s))}write(){let e=[];for(let s of this)e.push(...s.write());if(this.rom.writeMonsterNames){let s=this.rom.assembler(),r=Math.max(...this.map(l=>l.displayName.length)),n=27;if(r>n)throw new Error(`Longest displayName length is greater than ${n}. (${r} > ${n})
Crystalis HUD can't comfortably fit that many characters.`);s.assign("ENEMY_NAME_LENGTH",r),s.export("ENEMY_NAME_LENGTH"),s.segment("1a"),s.reloc("EnemyNameBlocklist"),s.label("EnemyNameBlocklist"),s.export("EnemyNameBlocklist");let i=[this.dynaCounter,this.dynaLaser,this.dynaBubble],a=this.filter(l=>l.hp>0&&l.displayName=="").concat(i);s.byte(...a.map(l=>l.id)),s.assign("ENEMY_NAME_BLOCKLIST_LEN",a.length),s.export("ENEMY_NAME_BLOCKLIST_LEN"),e.push(s.module())}return e}};var Be;(s=>(s.bit=(r,n)=>new Cr(r,n),s.byte=r=>new Nr(r),s.address=r=>new Ir(r)))(Be||(Be={}));var Cr=class{constructor(t,e){this.address=t;this.bit=e}get(t){return!!(t[this.address]&1<<this.bit)}set(t,e){let s=1<<this.bit;e?t[this.address]|=s:t[this.address]&=~s}},Nr=class{constructor(t){this.address=t}get(t){return t[this.address]}set(t,e){t[this.address]=e&255}},Ir=class{constructor(t){this.address=t}get(t){return t[this.address]<<16|t[this.address+1]<<8|t[this.address+2]}set(t,e){t[this.address]=e>>>16&255,t[this.address+1]=e>>>8&255,t[this.address+2]=e&255}};var Cs=class extends K{constructor(e,s){super(e,s);this.base=(s&3)<<2|(s&252)<<6|16624,this.colors=U(e.prg,this.base,4)}color(e){return this.colors[e]&63}};var Bt=class extends K{constructor(e,s,r){super(e,s);this.pixels=r||U(e.chr,s<<4,16)}pixelAt(e,s){return(this.pixels[e|8]>>s&1)<<1|this.pixels[e]>>s&1}flipH(){return new Bt(this.rom,-1,this.pixels.map(Hr))}flipV(){return new Bt(this.rom,-1,W(16,e=>this.pixels[e&8|~e&7]))}flip(e){let s=this;return e&Pr.HORIZONTAL&&(s=s.flipH()),e&Pr.VERTICAL&&(s=s.flipV()),s}write(){let e=this.id<<4;return this.rom.chr.subarray(e,e+16).set(this.pixels),[]}},$t=class{constructor(t){this._all=[];this._all=W(t.chr.length>>4,e=>new Bt(t,e))}get(t,e){return e?this._all[t|e]:this._all[t]}set(t,e,s){this._all[t|e].pixels=s}[Symbol.iterator](){return this._all[Symbol.iterator]()}},Me=$t;Me.HUD_LF=Pe(`
    |L     ..|
    |L.    .#|
    |L.  FF.#|
    |L.  F..#|
    |LLL FF.#|
    | ...F..#|
    |    F ..|
    |    .   |
  `,{" ":2,L:1,F:1,"#":1,".":3}),Me.HUD_PW=Pe(`
    |PPP     |
    |P..P.   |
    |PPP.    |
    |P..     |
    |P.w.w.w |
    | .w.w.w |
    |  .w.w. |
    |   . .  |
  `,{" ":2,P:1,w:1,".":3}),Me.HUD_EY=Pe(`
    |EEE     |
    |E...    |
    |EEE Y.Y.|
    |E...Y.Y.|
    |EEE  Y. |
    | ... Y. |
    |     Y. |
    |        |
  `,{" ":2,E:1,Y:1,"#":1,".":3}),Me.HUD_LV=Pe(`
    |        |
    |L       |
    |L.      |
    |L.  v.v.|
    |L.  v.v.|
    |LLL  v. |
    | ... v. |
    |     .  |
  `,{" ":2,L:1,v:1,".":3}),Me.HUD_DL=Pe(`
    |        |
    |DD      |
    |D.D.L   |
    |D.D.L.  |
    |D.D.L.  |
    |DD. L.  |
    | .  LLL |
    |     ...|
  `,{" ":2,D:1,L:1,".":3}),Me.HUD_MP=Pe(`
    |M.  M   |
    |MM.MM.  |
    |M.M.M.  |
    |M. .PPP |
    |M. .P..P|
    |    PPP.|
    |    P.. |
    |    P.  |
  `,{" ":2,M:1,P:1,".":3}),Me.HUD_EX=Pe(`
    |EEE     |
    |E...    |
    |EEE     |
    |E...    |
    |EEE x.x.|
    | ... x. |
    |    x.x.|
    |     . .|
  `,{" ":2,E:1,x:1,".":3}),Me.HUD_CLOSE_RIGHT=Pe(`
    |________|
    |____oooo|
    |____o...|
    |__ooo...|
    |__o....o|
    |__o....o|
    |__o..oo |
    |__o..o  |
  `,{" ":0,".":1,_:2,o:3}),Me.HUD_CLOSE_LEFT=Pe(`
    |________|
    |oooo____|
    |...o____|
    |...ooo__|
    |o....o__|
    |o....o__|
    | oo..o__|
    |  o..o__|
  `,{" ":0,".":1,_:2,o:3}),Me.BLANK_TILE_TEMPLATE=`
    |        |
    |        |
    |        |
    |        |
    |        |
    |        |
    |        |
    |        |
  `,Me.BLANK_TILES=[Pe($t.BLANK_TILE_TEMPLATE,{" ":0}),Pe($t.BLANK_TILE_TEMPLATE,{" ":1}),Pe($t.BLANK_TILE_TEMPLATE,{" ":2}),Pe($t.BLANK_TILE_TEMPLATE,{" ":3})];function Pe(o,t){let e=o.trim().replace(/^[^|]*\||\|[^|]*$/mg,"").replace(/\n/g,"");if(e.length!==64)throw new Error(`Bad CHR tile: ${e}`);let s=new Array(16).fill(0);for(let r=0,n="";n=e.charAt(r);++r){let i=r>>>3,a=i,l=i|8,c=~r&7,h=t[n]||0;h&1&&(s[a]|=1<<c),h&2&&(s[l]|=1<<c)}return s}var Pr=(e=>(e[e.HORIZONTAL=64]="HORIZONTAL",e[e.VERTICAL=128]="VERTICAL",e))(Pr||{});var Ns=class{constructor(t){this.rom=t;this.values=U(t.prg,vi.offset,wa)}write(){let t=this.rom.assembler();return vi.loc(t),t.byte(...this.values),[t.module()]}},vi=j.of(G.$1a,38884),wa=64;var{$0d:Is,$fe:Ps,$ff:Ds}=G,$s=class{constructor(t){this.rom=t;this.patk=new Array(48).fill(0);this.pdef=new Array(48).fill(0);this.php=new Array(48).fill(0);this.exp=new Array(48).fill(0);this.setPAtkFormula(e=>5+e*15/32),this.setPDefFormula(e=>e),this.setPhpFormula(e=>48+5.5*e),this.setExpScalingFactor(1)}setExpScalingFactor(t){this.setExpFormula(e=>Math.floor(4*2**((16+9*e)/32)*t))}setPAtkFormula(t){this.patk=this.patk.map((e,s)=>Math.round(8*t(s)))}setPDefFormula(t){this.pdef=this.pdef.map((e,s)=>Math.round(4*t(s)))}setPhpFormula(t){this.php=this.php.map((e,s)=>Math.min(255,Math.max(5,Math.round(t(s)))))}setExpFormula(t){this.exp=this.exp.map((e,s)=>{let r=t(s);return r<128?r:Math.min(255,128+(r>>4))})}write(){let t=this.rom.assembler();return ze(t,[Is,Ps,Ds],"DiffAtk"),t.byte(...this.patk),ze(t,[Is,Ps,Ds],"DiffDef"),t.byte(...this.pdef),ze(t,[Is,Ps,Ds],"DiffHP"),t.byte(...this.php),ze(t,[Is,Ps,Ds],"DiffExp"),t.byte(...this.exp),[t.module()]}};var Wt=class extends K{constructor(e,s){super(e,s);this.used=!0;let r=(s>255?64+s:s)<<8;this.tiles=U(e.prg,r,240)}clone(e){let s=new Wt(this.rom,e);return s.used=this.used,s.tiles=[...this.tiles],s}allTilesSet(){return new Set(this.tiles)}set2d(e,s){let r=e&15,n=e>>>4;for(let i=0;i<s.length;i++){let a=s[i];for(let l=0;l<a.length;l++){let c=a[l];c!=null&&(this.tiles[n+i<<4|r+l]=c)}}}get2d(e,s){let r=e&15,n=e>>>4,i=(s&15)+1,a=n+(s>>>4),l=[];for(let c=n;c<=a;c++){let h=c<<4|r;l.push(this.tiles.slice(h,h+i))}return l}assemble(e){let s=this.id.toString(16).padStart(2,"0"),r=this.tiles;if(this.rom.compressedMapData||this.id<256){let n=(this.id>>5).toString(16).padStart(2,"0");e.segment(n),n==="0a"&&(r=r.slice(192))}else e.segment("0a"),r=r.slice(0,192);e.org(32768|(this.id&63)<<8,`Screen_${s}`),e.byte(...r)}},Bs=class extends Array{constructor(e){super(259);this.rom=e;this.unallocated=[];for(let s=0;s<259;s++)this[s]=new Wt(e,s)}getScreen(e){let s=e<0?this.unallocated:this,r=e<0?~e:e;return s[r]||(s[r]=new Wt(this.rom,e))}setScreen(e,s){let r=e<0?this.unallocated:this,n=e<0?~e:e;r[n]=s}deleteScreen(e){let s=e<0?this.unallocated:this,r=e<0?~e:e;delete s[r]}write(){let e=this.rom.assembler();for(let s of this)s?.used&&s.assemble(e);return[e.module()]}};var Ws=class extends Ce{constructor(e){super(44);this.rom=e;this.innBasePrice=20;this.toolShopScaling=new Array(48).fill(0);this.armorShopScaling=new Array(48).fill(0);for(let s=0;s<44;s++)this[s]=new Dr(e,s);if(e.shopDataTablesAddress!=null){let s=e.shopDataTablesAddress+21*e.shopCount+2*e.scalingLevels;this.basePrices=W(73,r=>r>=13&&r<39?ne(e.prg,s+2*(r-13)):0)}else this.basePrices=W(73,s=>ne(e.prg,Na+2*s)*2)}armorShops(){return W(11,e=>this[4*e])}toolShops(){return W(11,e=>this[4*e+1])}inns(){return W(11,e=>this[4*e+2])}pawnShops(){return W(11,e=>this[4*e+3])}write(){let e=this.rom.assembler();if(this.rescale){let s=function(r){e.export(r),e.label(r)};e.segment("10","fe","ff"),e.reloc("ShopData"),s("ShopData"),s("ArmorShopIdTable");for(let r of this.armorShops())for(let n=0;n<4;n++)e.byte(r.contents[n]??255);s("ToolShopIdTable");for(let r of this.toolShops())for(let n=0;n<4;n++)e.byte(r.contents[n]??255);s("ArmorShopPriceTable");for(let r of this.armorShops())for(let n=0;n<4;n++)e.byte(Math.round((r.prices[n]??0)*32));s("ToolShopPriceTable");for(let r of this.toolShops())for(let n=0;n<4;n++)e.byte(Math.round((r.prices[n]??0)*32));s("InnPrices");for(let r of this.inns())e.byte(Math.round((r.prices[0]??0)*32));s("ShopLocations");for(let r of this)e.byte(r.location);s("ToolShopScaling"),e.byte(...this.toolShopScaling),s("ArmorShopScaling"),e.byte(...this.armorShopScaling),s("BasePrices"),e.word(...this.basePrices.slice(13,39).map(r=>r??0)),s("InnBasePrice"),e.word(this.innBasePrice)}else{e.segment("10","fe","ff"),e.org(40356,"ShopData");for(let s of this.armorShops())for(let r=0;r<4;r++)e.byte(s.contents[r]??255);for(let s of this.armorShops())for(let r=0;r<4;r++)e.word(s.prices[r]??0);for(let s of this.toolShops())for(let r=0;r<4;r++)e.byte(s.contents[r]??255);for(let s of this.toolShops())for(let r=0;r<4;r++)e.word(s.prices[r]??0)}return[e.module()]}};var Sa=[0,1,2,3],va=[(o,t)=>o||La,(o,t)=>o?o+4*t:Ra,(o,t)=>0,(o,t)=>0],Ta=[4,4,0,0],Ea=[(o,t)=>o?o+8*t:Aa,(o,t)=>o?o+12*t:Ma,(o,t)=>o?o+16*t:Ca,(o,t)=>0],Ti=[4,4,1,0],Dr=class extends K{constructor(e,s){super(e,s);if(this.type=Sa[s&3],this.index=s>>>2,e.shopDataTablesAddress){let n=e.shopDataTablesAddress,i=e.shopCount,a=n+17*i;this.location=e.prg[a+s]}else{let n=255;for(let i=0;i<33&&n===255;i++){if(e.prg[ka+i]!==this.index)continue;let a=e.prg[_a+i];for(let l of e.locations[a].spawns){if(l.type!==4)continue;if(e.objects[l.id].data[25]===32+this.type){n=a;break}}}this.location=n}let r=e.shopDataTablesAddress?n=>e.prg[this.pricesAddress+n]/32:n=>ne(e.prg,this.pricesAddress+2*n);this.contents=U(e.prg,this.contentsAddress,Ta[this.type]),this.prices=W(Ti[this.type],r),this.used=this.location!==255}get contentsAddress(){return va[this.type](this.rom.shopDataTablesAddress,this.rom.shopCount)+4*this.index}get pricesAddress(){let e=this.rom.shopDataTablesAddress;return Ea[this.type](e,this.rom.shopCount)+(e?1:2)*Ti[this.type]*this.index}updateShopkeeper(){throw new Error("not implemented")}},_a=139092,ka=139125,La=138660,Aa=138704,Ra=138792,Ma=138836,Ca=138924,Na=138946;var{$0e:Ia}=G,Os=class extends Array{constructor(e){super(128);this.rom=e;this.checkCount=112;this.mimicCount=16;for(let s=0;s<128;s++)this[s]=s}setCheckCount(e){this.checkCount=e}setMimicCount(e){this.mimicCount=e}swap(e,s){if(e===s)return;let r=this[e];this[e]=this[s],this[s]=r}exportDigits(e,s,r){let n=r.toString().padStart(3,"0");e.assign(`${s}_HUN`,Number(n[0])),e.export(`${s}_HUN`),e.assign(`${s}_TEN`,Number(n[1])),e.export(`${s}_TEN`),e.assign(`${s}_ONE`,Number(n[2])),e.export(`${s}_ONE`)}write(){let e=this.rom.assembler();return ze(e,[Ia],"CheckToItemGetMap"),this.exportDigits(e,"CHECK_COUNT",this.checkCount),this.exportDigits(e,"MIMIC_COUNT",this.mimicCount),e.byte(...this),[e.module()]}};var{$0e:$r,$fe:Pa,$ff:Da}=G;var $a=115247,Ba=115219,Wa=121076,Oa=121332,Fa=121388,Fs=class{constructor(t){this.rom=t;this.sages=W(4,e=>new Br(this,e)),this.resultTable=U(t.prg,$a,64),t.telepathyTablesAddress?(this.groupsByLocation=[],this.minimumLevels=[]):(this.groupsByLocation=U(t.prg,Wa,256),this.minimumLevels=U(t.prg,Ba,7))}write(){let t=this.rom.telepathyTablesAddress,e=this.rom.assembler();if(e.segment($r.name,Pa.name,Da.name),t){ie(e,$r,39156,39680);let s=this.sages.map((r,n)=>{e.reloc(`Telepathy_Sage_${n}`);let i=e.pc();return e.byte(...r.messageGroups[0].bytes()),i});e.org(33327,"Telepathy_ResultTable"),e.byte(...this.resultTable.map(r=>r<4?r:r>>>1)),e.reloc("TelepathyTable"),e.export("TelepathyTable"),e.label("TelepathyTable"),e.word(...s);for(let r=1;r<4;r++)for(let n=0;n<4;n++)e.byte(...this.sages[n].defaultMessages[r].data)}else{ie(e,$r,39500,39680),e.org(33327,"Telepathy_ResultTable"),e.byte(...this.resultTable),e.org(33299,"Telepathy_LevelsTable"),e.byte(...this.minimumLevels),e.org(39156,"Telepathy_LocationTable"),e.byte(...this.groupsByLocation),e.org(39468,"Telepathy_VanillaDefaultsTable");for(let r=0;r<4;r++)for(let n=0;n<4;n++){let i=this.sages[n];e.byte(...i.defaultMessages[r].data)}let s=[];for(let r=0;r<4;r++){let n=this.sages[r];for(let i=0,a=n.messageGroups.length;i<a;i++)e.reloc(`Telepathy_Sage_${r}_Group_${i}`),s[4*i+r]=e.pc(),e.byte(...n.messageGroups[i].bytes())}e.org(39412,"Telepathy_VanillaMainTable"),e.word(...s)}return[e.module()]}},Br=class{constructor(t,e){this.telepathy=t;this.sage=e;let s=t.rom,r,n,i;s.telepathyTablesAddress?(n=r=s.telepathyTablesAddress+2*e,i=1):(r=Fa+2*e,n=Oa+2*e,i=7),this.defaultMessages=W(4,a=>Se.from(s.prg,r+8*a)),this.messageGroups=W(i,a=>Yt.from(s.prg,n+8*a))}},Yt=class{constructor(t){this.messages=t}bytes(){let t=[];for(let e=0,s=this.messages.length;e<s;e++){let[r,n,i]=this.messages[e],a=r>=0?r:8192|~r;e===s-1&&(a|=32768),i&&(a|=16384),t.push(a>>=8,a&255,...n.data,...i?i.data:[])}return t}static from(t,e){let s=new Yt([]);e=ne(t,e)+81920;let r=0;for(;!(r&32768);){r=it(t,e),e+=2;let n=r&8191;r&8192&&(n=~n);let i=[n,Se.from(t,e)];e+=2,r&16384&&(i.push(Se.from(t,e)),e+=2),s.messages.push(i)}return s}};var zs=class extends K{constructor(e,s){super(e,s);this.base=255865+(s<<3),this.pages=U(e.prg,this.base,8)}};var We=class extends K{constructor(e,s){super(e,s);this.effects=U(e.prg,this.base,256)}get base(){return this.id<<8&8191|73728}get org(){return this.id<<8&8191|40960}write(){let e=this.rom.assembler();return e.segment("09","fe","ff"),e.org(this.org,`TileEffects_${this.id.toString(16)}_Tiles`),e.byte(...this.effects),[e.module()]}};We.PIT=1,We.NO_WALK=2,We.IMPASSIBLE=4,We.ALTERNATIVE=8,We.BEHIND=16,We.SLOPE=32,We.SLOW=64,We.PAIN=128;var Ot=class{constructor(t,e){this.tileset=t;this.id=e;this.copiedFrom=-1}get tiles(){return[0,1,2,3].map(t=>this.tileset.tiles[t][this.id])}setTiles(t){for(let e=0;e<4;e++){let s=t[e];s!=null&&(this.tileset.tiles[e][this.id]=s)}return this}get alternative(){let t=this.id<32?this.tileset.alternates[this.id]:this.id;return t!==this.id?t:null}setAlternative(t){return this.id>=32?this:(this.tileset.alternates[this.id]=t??this.id,this.tileset.effects().effects[this.id]|=8,this)}get attrs(){return this.tileset.attrs[this.id]}setAttrs(t){return this.tileset.attrs[this.id]=t,this}get effects(){return this.tileset.effects().effects[this.id]}setEffects(t){return this.tileset.effects().effects[this.id]=t,this}copyFrom(t,...e){let s=new Ot(this.tileset,t);return this.copiedFrom=t,this.setTiles(s.tiles),(this.id|s.id)<32&&this.setAlternative(s.alternative),this.setAttrs(s.attrs),this.setEffects(s.effects),this}replaceIn(...t){if(this.copiedFrom<0)throw new Error("Must copyFrom first.");for(let e of t)e.replace(this.copiedFrom,this.id);return this}};var Gs=class{constructor(t){this.rom=t;this.tilesets=[];for(let e=128;e<176;e+=4)this.tilesets.push(this[e]=new Wr(t,e))}[Symbol.iterator](){return this.tilesets[Symbol.iterator]()}},Wr=class extends K{constructor(e,s){super(e,s);this.tiles=W(4,r=>U(e.prg,this.tileBase|r<<8,256)),this.attrs=W(256,r=>e.prg[this.attrBase|r>>2]>>((r&3)<<1)&3),this.alternates=U(e.prg,this.alternatesBase,32)}get map(){return this.id&63}get tileBase(){return 65536|this.map<<8}get attrBase(){return 77824|this.map<<4}get alternatesBase(){return 81408|this.map<<3}getTile(e){return new Ot(this,e)}write(){let e=W(64,n=>{let i=n<<2;return this.attrs[i]&3|(this.attrs[i+1]&3)<<2|(this.attrs[i+2]&3)<<4|(this.attrs[i+3]&3)<<6}),s=this.rom.assembler(),r=`Tileset_${this.id.toString(16).padStart(2,"0")}`;return s.segment("08","09"),s.org(32768|this.map<<8,`${r}_Tiles`),s.byte(...[].concat(...this.tiles)),s.org(45056|this.map<<4,`${r}_Attrs`),s.byte(...e),s.org(48640|this.map<<3,`${r}_Alternates`),s.byte(...this.alternates),[s.module()]}effects(){let e=this.id>>>2&15;return this.id===168&&(e=2),this.id===172&&e--,this.rom.tileEffects[e]}};var Us=class{constructor(t){this.rom=t;this.locations=U(t.prg,Ei.offset,za),this.thunderSwordWarp=[t.prg[251338],t.prg[251342]]}write(){let t=this.rom.assembler();return Ei.loc(t),t.label("TownWarpTable"),t.byte(...this.locations),t.org(56460),t.instruction("lda","TownWarpTable,y"),t.org(54729),t.instruction("lda","#"+this.thunderSwordWarp[0]),t.org(54733),t.instruction("lda","#"+this.thunderSwordWarp[1]),[t.module()]}},Ei=j.of(G.$fe,56408),za=12;var Ga=new Set([131,135,136,137,143,147,150,152,155,156,157,158,159,170,179,181,185,190,192]),js=class extends K{constructor(e,s){super(e,s);this.used=!Ga.has(s),this.pointer=123258+((s&127)<<1),this.base=jr(e.prg,this.pointer,81920),this.conditions=[],this.message=Se.of({}),this.flags=[];let r,n=this.base;do{r=it(e.prg,n);let i=r&4095;this.conditions.push(r&8192?~i:i),n+=2}while(!(r&32768));this.message=Se.from(e.prg,n);do{n+=2,r=it(e.prg,n);let i=r&4095;this.flags.push(r&32768?~i:i)}while(!(r&16384))}bytes(){let e=[];this.conditions.length||this.conditions.push(-1);for(let s=0;s<this.conditions.length;s++){let r=this.conditions[s];r<0&&(r=~r|8192),s===this.conditions.length-1&&(r=r|32768),e.push(r>>>8,r&255)}e.push(...this.message.data),this.flags.length||this.flags.push(-1);for(let s=0;s<this.flags.length;s++){let r=this.flags[s];r<0&&(r=~r|32768),s===this.flags.length-1&&(r=r|16384),e.push(r>>>8,r&255)}return e}write(){if(!this.used)return[];let e=this.rom.assembler(),s=`Trigger_${L(this.id)}`;e.segment("0f"),e.reloc(s);let r=e.pc();return e.byte(...this.bytes()),e.org(41338+2*(this.id&127),s+"_Ptr"),e.word(r),[e.module()]}};var qs=class{constructor(t){this.rom=t;this.locations=U(t.prg,_i.offset,Ua)}write(){let t=this.rom.assembler();return _i.loc(t),t.label("WildWarpLocations"),t.byte(...this.locations),t.org(52185),t.instruction("lda","WildWarpLocations,y"),[t.module()]}},_i=j.of(G.$fe,52204),Ua=16;var{$0e:Or,$0f:ki,$10:ja}=G,ku=o=>Symbol(o),be=class{constructor(t){this.modules=new Map;this.allocatedTriggers=new Map;let e=t[4]*16384,s=16+(t[6]&4?512:0),r=s+e;this.prg=t.subarray(s,r),this.chr=t.subarray(r),this.shopCount=be.SHOP_COUNT.get(t),this.scalingLevels=be.SCALING_LEVELS.get(t),this.uniqueItemTableAddress=be.UNIQUE_ITEM_TABLE.get(t),this.shopDataTablesAddress=be.SHOP_DATA_TABLES.get(t),this.telepathyTablesAddress=be.TELEPATHY_TABLES.get(t),this.omitItemGetDataSuffix=be.OMIT_ITEM_GET_DATA_SUFFIX.get(t),this.omitLocalDialogSuffix=be.OMIT_LOCAL_DIALOG_SUFFIX.get(t),this.compressedMapData=be.COMPRESSED_MAPDATA.get(t),this.writeMonsterNames=be.WRITE_MONSTER_NAMES.get(t);for(let[n,i,a]of qa)this.prg[n]===i&&(this.prg[n]=a);this.tilesets=new Gs(this),this.tileEffects=W(11,n=>new We(this,n+179)),this.screens=new Bs(this),this.metatilesets=new _s(this),this.metascreens=new Ts(this),this.triggers=W(67,n=>new js(this,128|n)),this.patterns=new Me(this),this.palettes=W(256,n=>new Cs(this,n)),this.locations=new Ss(this),this.tileAnimations=W(4,n=>new zs(this,n)),this.hitboxes=W(24,n=>new ms(this,n)),this.objectActions=new Rs(this),this.objects=new Ms(this),this.adHocSpawns=W(96,n=>new ls(this,n)),this.metasprites=W(256,n=>new Es(this,n)),this.messages=new kt(this),this.telepathy=new Fs(this),this.itemGets=new ys(this),this.items=new ps(this),this.shops=new Ws(this),this.slots=new Os(this),this.npcs=new Ls(this),this.bossKills=W(14,n=>new cs(this,n)),this.wildWarp=new qs(this),this.townWarp=new Us(this),this.coinDrops=new hs(this),this.flags=new us(this),this.bosses=new ds(this),this.scaling=new $s(this),this.randomNumbers=new Ns(this);for(let n of this.locations)n.used&&n.lazyInitialization()}trigger(t){if(t<128||t>255)throw new Error(`Bad trigger id $${L(t)}`);return this.triggers[t&127]}get projectiles(){let t=new Set;for(let e of this.objects.filter(s=>s instanceof T))e.child&&t.add(this.objects[this.adHocSpawns[e.child].objectId]);return[...t].sort((e,s)=>e.id-s.id)}get monsterGraphics(){let t={};for(let e of this.locations)if(!(!e.used||!e.hasSpawns)){for(let s of e.spawns)if(!(s.data[2]&7)){let r=s.data[2]&128?1:0,n=L(s.data[3]+80),i=t[n]=t[n]||{};i[`${r}:${e.spritePatterns[r].toString(16)}:${e.spritePalettes[r].toString(16)}`]={pal:e.spritePalettes[r],pat:e.spritePatterns[r],slot:r}}}return t}get locationMonsters(){let t={};for(let e of this.locations){if(!e.used||!e.hasSpawns)continue;let s=t["$"+L(e.id)]={};for(let r of e.spawns)if(!(r.data[2]&7)){let n=r.data[2]&128?1:0,i=r.data[3]+80;s[`${n}:${i.toString(16)}`]=(s[`${n}:${i.toString(16)}`]||0)+1}}return t}assembler(){return new Ct}writeData(t=this.prg){let e=this.assembler();ie(e,Or,34682,35165),ie(e,Or,35557,39156),ie(e,Or,40422,40960),ie(e,ki,40960,41222),ie(e,ki,41472,41920),ie(e,ja,37146,37992);let s=[...this.modules.values(),e.module()],r=l=>{for(let c of l)s.push(...c.write())};s.push(...this.locations.write()),s.push(...this.objects.write()),r(this.hitboxes),r(this.triggers),s.push(...this.npcs.write()),r(this.tilesets),r(this.tileEffects),r(this.adHocSpawns),s.push(...this.itemGets.write()),s.push(...this.slots.write()),s.push(...this.items.write()),s.push(...this.shops.write()),r(this.bossKills),r(this.patterns),s.push(...this.wildWarp.write()),s.push(...this.townWarp.write()),s.push(...this.coinDrops.write()),s.push(...this.scaling.write()),s.push(...this.bosses.write()),s.push(...this.randomNumbers.write()),s.push(...this.telepathy.write()),s.push(...this.messages.write()),s.push(...this.screens.write());let n=new xt;n.base(this.prg,0);for(let l of s)n.read(l);if(n.link().apply(t),t!==this.prg)return;let a=n.exports();this.uniqueItemTableAddress=a.get("KeyItemData").offset,this.shopCount=11,this.shopDataTablesAddress=a.get("ShopData")?.offset||0,be.SHOP_COUNT.set(this.prg,this.shopCount),be.SCALING_LEVELS.set(this.prg,this.scalingLevels),be.UNIQUE_ITEM_TABLE.set(this.prg,this.uniqueItemTableAddress),be.SHOP_DATA_TABLES.set(this.prg,this.shopDataTablesAddress||0),be.OMIT_ITEM_GET_DATA_SUFFIX.set(this.prg,this.omitItemGetDataSuffix),be.OMIT_LOCAL_DIALOG_SUFFIX.set(this.prg,this.omitLocalDialogSuffix),be.COMPRESSED_MAPDATA.set(this.prg,this.compressedMapData),be.WRITE_MONSTER_NAMES.set(this.prg,this.writeMonsterNames)}analyzeTiles(){}disjointTilesets(){let t=[];for(let s of this.locations){if(!s.used)continue;let r=s.tileset;for(let n of s.screens)for(let i of n)(t[i]||(t[i]=new Set)).add(r)}let e=W(256,()=>new nt);for(let s=0;s<t.length;s++)if(!!t[s])for(let r of this.screens[s].allTilesSet())e[r].union([...t[s]]);for(let s=0;s<e.length;s++){let r=e[s].sets().map(n=>[...n].map(L).join(" ")).join(" | ");console.log(`Tile ${L(s)}: ${r}`)}}swapMetatiles(t,...e){let s=new Map,r=W(256),n=new Map,i=h=>Array.isArray(h)?h[0]:h<0?~h:h;for(let h of e){for(let u=0;u<h.length-1;u++)if(Array.isArray(h[u])){let m=h[u];n.set(m[0],m[1]),h[u]=m[0]}for(let u=0;u<h.length-1;u++){let m=h[u],f=h[u+1];m<0||f<0||(s.set(f,m),r[f]=m)}}let a=new Set,l=new Set,c=new Set(t);for(let h of this.locations)if(!!h.used&&!!c.has(h.tileset)){l.add(h.tileEffects);for(let u of h.allScreens())a.add(u)}for(let h of a)for(let u=0,m=h.tiles.length;u<m;u++)h.tiles[u]=r[h.tiles[u]];for(let h of c){let u=this.tilesets[h];for(let m of e)for(let f=0;f<m.length-1;f++){let S=i(m[f]),v=i(m[f+1]);for(let k=0;k<4;k++)u.tiles[k][S]=u.tiles[k][v];if(u.attrs[S]=u.attrs[v],v<32&&u.alternates[v]!==v){if(S>=32)throw new Error(`Cannot unflag: ${h} ${S} ${v} ${u.alternates[v]}`);u.alternates[S]=u.alternates[v]}}for(let[m,f]of n)u.alternates[m]=f}for(let h of l){let u=this.tileEffects[h-179];for(let m of e)for(let f=0;f<m.length-1;f++){let S=i(m[f]),v=i(m[f+1]);u.effects[S]=u.effects[v]}for(let m of n.keys())u.effects[m]|=8}}moveFlag(t,e){function s(r){for(let n=0;n<r.length;n++)r[n]===t&&(r[n]=e),r[n]===~t&&(r[n]=~e)}for(let r of this.triggers)s(r.conditions),s(r.flags);for(let r of this.npcs){for(let n of r.spawnConditions.values())s(n);for(let n of[r.globalDialogs,...r.localDialogs.values()])for(let i of n)i.condition===t&&(i.condition=e),i.condition===~t&&(i.condition=~e)}if((t&-256)===512&&(e&-256)===512)for(let r of this.locations)for(let n of r.flags)n.flag===t&&(n.flag=e)}nextFreeTrigger(t){for(let e of this.triggers)if(!e.used)return t&&this.allocatedTriggers.set(t,e.id),e;throw new Error("Could not find an unused trigger.")}moveScreens(t,e){if(!this.compressedMapData)throw new Error("Must compress maps first.");let s=new Map,r=e<<8;for(;this.screens[r];)r++;let n=new Set(t);for(let a of n)for(let l of a){if(l.sid>=256){s.set(l.sid,l.sid);continue}let c=l.sid;if(!s.has(c)){let h=r++;s.set(c,h),s.set(h,h),this.metascreens.renumber(c,h,n)}}if(r>>>8!==e)throw new Error(`Out of space on page ${e}`);let i=new Set;for(let a of this.locations){if(!n.has(a.meta.tileset))continue;let l=!1;for(let c of a.screens)for(let h=0;h<c.length;h++){let u=s.get(c[h]);u!=null?(c[h]=u,l=!0):i.add(a.name)}if(l&&i.size)throw new Error(`Inconsistent move [${[...n].map(c=>c.name).join(", ")}] to plane ${e}: missed ${[...i].join(", ")}`)}}static async load(t,e){let s=await Li(e);return t&&await t(s),new be(s)}static async loadBytes(){return await Li()}},He=be;He.OMIT_ITEM_GET_DATA_SUFFIX=Be.bit(82624,0),He.OMIT_LOCAL_DIALOG_SUFFIX=Be.bit(82624,1),He.COMPRESSED_MAPDATA=Be.bit(82624,2),He.WRITE_MONSTER_NAMES=Be.bit(82624,3),He.SHOP_COUNT=Be.byte(82625),He.SCALING_LEVELS=Be.byte(82626),He.UNIQUE_ITEM_TABLE=Be.address(82640),He.SHOP_DATA_TABLES=Be.address(82643),He.TELEPATHY_TABLES=Be.address(82646);function Li(o){return o||(o=t=>document.body.appendChild(t)),new Promise(t=>{if(window.location.hash!=="#reset"){let s=localStorage.getItem("rom");if(s)return t(Uint8Array.from(new Array(s.length/2).fill(0).map((r,n)=>Number.parseInt(s[2*n]+s[2*n+1],16))))}let e=document.createElement("input");document.body.appendChild(e),e.type="file",e.addEventListener("change",()=>{let s=e.files[0],r=new FileReader;r.addEventListener("loadend",()=>{let n=new Uint8Array(r.result),i=Array.from(n,L).join("");localStorage.setItem("rom",i),e.remove(),t(n)}),r.readAsArrayBuffer(s)})})}var Lu=466849842,qa=[[83272,86,80],[83306,0,255],[83343,56,48],[83480,96,112],[83494,168,160],[83507,21,22],[83511,21,22],[84305,168,160],[84307,152,144],[84505,120,112],[84715,9,255],[84809,128,136],[84871,32,48],[84890,1,2],[84894,1,2],[85433,8,128],[85750,104,96],[87133,255,0],[87145,120,112],[88070,152,160],[88074,152,160],[88078,88,80],[88093,0,255],[88142,219,255],[88181,120,112],[88911,120,128],[89007,240,128],[89014,223,128],[89015,150,128],[89315,223,207],[89326,110,109],[89330,110,109],[89486,223,207],[89489,46,45],[89493,46,45],[89658,216,223],[89913,120,112],[89920,2,255],[89953,141,255],[89957,141,255],[91133,72,64],[91139,85,80],[91227,216,223],[91340,4,32],[91391,11,10],[91661,32,48],[91684,1,2],[91688,1,2],[93616,154,128],[93620,158,128],[93624,145,128],[93628,158,128],[93632,145,128],[93672,0,255],[93677,223,208],[93688,12,92],[93689,176,185],[93690,0,2],[93692,12,92],[93693,176,185],[93694,0,2],[93695,7,255],[93789,2,255],[93802,173,255],[93806,173,255],[94209,2,255],[94254,183,255],[94258,183,255],[94379,3,255],[94383,2,255],[94387,5,255],[94391,6,255],[94395,0,255],[94404,178,255],[94408,178,255],[94412,177,255],[94416,177,255],[94420,179,255],[94424,179,255],[94428,181,255],[94432,181,255],[94436,181,255],[94440,181,255],[95470,128,136],[96193,136,128],[96197,152,160],[96199,88,80],[96298,16,1],[96343,16,1],[96596,128,120],[96674,128,120],[97162,0,64],[97168,0,64],[97230,0,64],[97236,0,64],[97294,0,64],[97300,0,64],[97358,0,64],[97364,0,64],[106242,64,128],[106243,51,50],[106976,64,192],[106977,61,52],[118533,71,72],[119569,32,160],[119570,48,0],[118777,96,224],[182928,2,0],[193907,2,0],[195300,95,0]];export{Ha as a,Ka as b,Va as c,Za as d,Lt as e,Jr as f,he as g,De as h,el as i,Xr as j,en as k,tl as l,tn as m,sn as n,rn as o,es as p,Mt as q,Ct as r,ns as s,is as t,W as u,L as v,Hi as w,Ja as x,dc as y,En as z,nt as A,ue as B,T as C,$e as D,rt as E,dt as F,Kt as G,It as H,vs as I,Se as J,Dt as K,Tt as L,Me as M,I as N,nl as O,il as P,ku as Q,He as R,Lu as S};
