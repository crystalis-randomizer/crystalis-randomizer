import{A as ut,B as Fs,C as Re,D as ge,E as me,F as He,G as Qe,H as Ri,I as Ti,J as z,K as be,L as qt,M as Ft,N as Gs,O as De,P as Se,Q as Mi,R as Fi,S as Gi,T as Ai,U as Pi,a as vs,b as _,c as se,d as $t,e as Tt,f as Is,g as xi,h as Es,i as Rs,j as Ts,k as gi,l as bi,m as C,n as oe,o as Mt,p as wi,q as Ms,r as yi,s as Si,t as Ci,u as ki,v as vi,w as Ii,x as te,y as V,z as Ei}from"./chunk-SR26D2GK.js";var Ht,Ur=()=>{let r;Ht=new Uint32Array(256);for(let t=0;t<256;t++){r=t;for(let e=0;e<8;e++)r=r&1?3988292384^r>>>1:r>>>1;Ht[t]=r}};var jr=r=>r.split("").map(t=>t.charCodeAt(0)),Ut=r=>{Ht||Ur(),typeof r=="string"&&(r=jr(r));let t=-1;for(let e=0,s=r.length;e<s;e++)t=t>>>8^Ht[(t^r[e])&255];return(t^-1)>>>0};var jt=r=>"",As=r=>r===!0?!1:r,Ps=class{constructor(t,e){this.flag=t;this.opts=e;Ps.flags.set(t,this)}static all(){return[...this.flags.values()]}},we=Ps;we.flags=new Map;var le=class{constructor(t,e,s,i){this.name=e;this.description=s;this.flags=i.map(n=>n instanceof we?[n,!0]:n),t.presets.set(Li(e),this)}static all(){return We.instance||(We.instance=new We),[...We.instance.presets.values()]}get flagString(){return this._flagString==null&&(this._flagString=String(new tt(`@${this.name}`))),this._flagString}};function Li(r){return r.toLowerCase().replace(/[^a-z]/g,"")}var We=class{constructor(){this.presets=new Map;this.Casual=new le(this,"Casual",`
      Basic flags for a relatively easy playthrough.  This is a good
      place to start.`,[$.PreserveUniqueChecks,$.NoShuffleMimics,$.DecreaseEnemyDamage,$.GuaranteeRefresh,$.GuaranteeStartingSword,$.ExperienceScalesFaster,$.NoCommunityJokes,D.NoThunderSwordWarp,U.Shops,U.Dyna,[U.Maps,"!"],[U.WildWarp,"!"],ne.SpoilerLog]);this.Classic=new le(this,"Classic",`
      Provides a relatively quick playthough with a reasonable amount of
      challenge.  Similar to older versions.`,[$.GuaranteeStartingSword,$.NoCommunityJokes,B.StatueGlitch,[D.NoThunderSwordWarp,"!"],[U.Maps,"!"],ne.SpoilerLog]);this.Standard=new le(this,"Standard",`
      Well-balanced, standard race flags.`,[Y.RandomizeWeaknesses,D.StoryMode,ne.SpoilerLog]);this.NoBowMode=new le(this,"No Bow Mode",`
      The tower is open from the start, as soon as you're ready for it.`,[Y.RandomizeWeaknesses,Y.TowerRobots,j.MaxScalingInTower,D.NoBowMode,ne.SpoilerLog]);this.Advanced=new le(this,"Advanced",`
      A balanced randomization with quite a bit more difficulty.`,[B.GhettoFlight,B.MtSabreRequirementSkip,B.StatueGlitch,[B.SwordChargeGlitch,"!"],Z.Barrier,Z.BattleMagic,Z.GasMask,j.MaxScalingInTower,Y.RandomizeWeaknesses,Y.TowerRobots,D.OrbsNotRequired,D.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.UnidentifiedKeyItems,ne.SpoilerLog]);this.WildWarp=new le(this,"Wild Warp",`
      Significantly opens up the game right from the start with wild
      warp in logic.`,[$.GuaranteeRefresh,R.RandomizeWildWarp,Y.RandomizeWeaknesses,Y.TowerRobots,D.OrbsNotRequired,D.StoryMode,ne.SpoilerLog]);this.Mystery=new le(this,"Mystery",`
      Even the options are random.`,[[R.ShuffleAreas,"?"],[R.ShuffleHouses,"?"],[R.RandomizeMaps,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeWildWarp,"?"],[D.OrbsNotRequired,"?"],[D.NoBowMode,"?"],[D.StoryMode,"?"],[D.VanillaDolphin,"?"],[D.NoThunderSwordWarp,"?"],[B.RageSkip,"?"],[B.TriggerSkip,"?"],[B.StatueGlitch,"?"],[B.GhettoFlight,"?"],[B.SwordChargeGlitch,"?"],[B.MtSabreRequirementSkip,"?"],[Te.RandomizeMusic,"?"],[Te.RandomizeMapColors,"?"],[Y.RandomizeWeaknesses,"?"],[Y.TowerRobots,"?"],[$.NoShuffleMimics,"?"],[$.PreserveUniqueChecks,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],[Z.GasMask,"?"],[U.Dyna,"?"],[U.BonusItems,"?"],[U.Maps,"?"],ne.SpoilerLog]);this.Hardcore=new le(this,"Hardcore",`
      Not for the faint of heart.  Good luck.`,[Z.Barrier,Z.BattleMagic,j.ExperienceScalesSlower,j.MaxScalingInTower,j.Permadeath,D.OrbsNotRequired,D.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.UnidentifiedKeyItems]);this.FullStupid=new le(this,"The Full Stupid",`
      Only a few noble fools have ever completed this.  Be sure to record this
      because pics or it didn't happen.`,[Z.Barrier,Z.BattleMagic,j.Blackout,j.ExperienceScalesSlower,j.MaxScalingInTower,j.Permadeath,Y.RandomizeWeaknesses,Y.TowerRobots,D.OrbsNotRequired,D.StoryMode,R.RandomizeMaps,R.ShuffleAreas,R.ShuffleHouses,R.RandomizeTrades,R.RandomizeWallElements,R.ShuffleGoaFloors,R.UnidentifiedKeyItems]);this.Tournament2022Early=new le(this,"Tournament 2022 Early Rounds",`
      Lots of potential complexity, but within reason.  Requires all swords and
      bosses, as well as a few glitches, but guarantees a starting sword.`,[$.GuaranteeStartingSword,B.StatueGlitch,B.StatueGauntletSkip,[Y.RandomizeWeaknesses,"?"],D.OrbsNotRequired,D.StoryMode,[D.VanillaDolphin,"?"],[D.NoThunderSwordWarp,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new le(this,"Tournament 2022 Mid Rounds",`
      Some additional challenges compared to the early rounds: some additional
      mystery flags and glitches, as well as max difficulty scaling in the
      tower.`,[[$.GuaranteeStartingSword,"?"],[B.GhettoFlight,"?"],[B.StatueGlitch,"?"],[B.MtSabreRequirementSkip,"?"],[B.StatueGauntletSkip,"?"],j.MaxScalingInTower,[j.NoBuffMedicalHerb,"?"],[Y.RandomizeWeaknesses,"?"],[Y.TowerRobots,"?"],[Z.Barrier,"?"],[Z.BattleMagic,"?"],D.StoryMode,[D.VanillaDolphin,"?"],[D.OrbsNotRequired,"?"],[D.NoThunderSwordWarp,"?"],[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new le(this,"Tournament 2022 Finals Round",`
      Many of the more difficult mystery flags from the mid rounds are now
      always on, plus entrance shuffle.`,[[$.GuaranteeStartingSword,"?"],B.GhettoFlight,B.StatueGlitch,B.MtSabreRequirementSkip,B.StatueGauntletSkip,j.NoBuffMedicalHerb,j.MaxScalingInTower,[Y.RandomizeWeaknesses,"?"],[Y.TowerRobots,"?"],Z.Barrier,Z.BattleMagic,D.StoryMode,[D.VanillaDolphin,"?"],[D.OrbsNotRequired,"?"],[D.NoThunderSwordWarp,"?"],R.ShuffleHouses,[R.RandomizeWallElements,"?"],[R.ShuffleGoaFloors,"?"],[R.RandomizeSpriteColors,"?"],[R.RandomizeTrades,"?"],[R.UnidentifiedKeyItems,"?"]])}static get(t){return this.instance||(this.instance=new We),this.instance.presets.get(Li(t))}},Ls=class{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(t,e){Ls.sections.add(this.instance||(this.instance=new this));let s=new we(t,e);if(!t.startsWith(this.instance.prefix))throw new Error(`bad flag ${t} ${e}`);return this.instance.flags.set(t,s),s}},de=Ls;de.sections=new Set;var Ce=class extends de{constructor(){super(...arguments);this.prefix="W";this.name="World"}},R=Ce;R.RandomizeMaps=Ce.flag("Wm",{name:"Randomize maps",text:`Individual maps are randomized.  For now this is only a subset of
           possible maps.  A randomized map will have all the same features
           (exits, chests, NPCs, etc) except things are moved around.`,hard:!0}),R.ShuffleAreas=Ce.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0}),R.ShuffleHouses=Ce.flag("Wh",{name:"Shuffle house entrances",text:`Shuffles all the house entrances, as well as a handful of other
           things, like the palace/fortress-type entrances at the top of
           several towns, and standalone houses.`,hard:!0}),R.RandomizeTrades=Ce.flag("Wt",{name:"Randomize trade-in items",text:`Items expected by various NPCs will be shuffled: specifically,
           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog
           Lamp, and Flute of Lime (for Akahana).  Rage will expect a
           random sword, and Tornel will expect a random bracelet.`,hard:!0}),R.UnidentifiedKeyItems=Ce.flag("Wu",{name:"Unidentified key items",text:`Item names will be generic and effects will be shuffled.  This
           includes keys, flutes, lamps, and statues.`,hard:!0}),R.RandomizeWallElements=Ce.flag("We",{name:"Randomize elements to break walls",text:`Walls will require a randomized element to break.  Normal rock and
           ice walls will indicate the required element by the color (light
           grey or yellow for wind, blue for fire, bright orange ("embers") for
           water, or dark grey ("steel") for thunder.  The element to break
           these walls is the same throughout an area.  Iron walls require a
           one-off random element, with no visual cue, and two walls in the
           same area may have different requirements.`}),R.ShuffleGoaFloors=Ce.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."}),R.RandomizeSpriteColors=Ce.flag("Ws",{name:"Randomize sprite colors",text:`Monsters and NPCs will have different colors.  This is not an
           optional flag because it affects what monsters can be grouped
           together.`}),R.RandomizeWildWarp=Ce.flag("Ww",{name:"Randomize wild warp",text:`Wild warp will go to Mezame Shrine and 15 other random locations.
           These locations will be considered in-logic.`,excludes:["Vw"]});var et=class extends de{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}},D=et;D.StoryMode=et.flag("Rs",{name:"Story Mode",text:`Draygon 2 won't spawn unless you have all four swords and have
           defeated all major bosses of the tetrarchy.`}),D.NoBowMode=et.flag("Rb",{name:"No Bow mode",text:`No items are required to finish the game.  An exit is added from
           Mezame shrine directly to the Draygon 2 fight (and the normal entrance
           is removed).  Draygon 2 spawns automatically with no Bow of Truth.`}),D.OrbsNotRequired=et.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."}),D.NoThunderSwordWarp=et.flag("Rt",{name:"No Sword of Thunder warp",text:`Normally when acquiring the thunder sword, the player is instantly
           warped to a random town.  This flag disables the warp.  If set as
           "R!t", then the warp will always go to Shyron, like in vanilla.`,modes:"!"}),D.VanillaDolphin=et.flag("Rd",{name:"Vanilla Dolphin interactions",text:`By default, the randomizer changes a number of dolphin and boat
           interactions: (1) healing the dolphin and having the Shell Flute
           is no longer required before the fisherman spawns: instead, he
           will spawn as soon as you have the item he wants; (2) talking to
           Kensu in the beach cabin is no longer required for the Shell Flute
           to work: instead, the Shell Flute will always work, and Kensu will
           spawn after the Fog Lamp is turned in and will give a key item
           check.  This flag restores the vanilla interaction where healing
           and shell flute are required, and Kensu no longer drops an item.`});var _e=class extends de{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description=`
      By default, the randomizer disables all known glitches (except ghetto
      flight).  These flags selectively re-enable certain glitches.  Most of
      these flags have two modes: normally enabling a glitch will add it as
      possibly required by logic, but clicking a second time will add a '!'
      and enable the glitch outside of logic (e.g. "G!c").`}},B=_e;B.GhettoFlight=_e.flag("Gf",{name:"Ghetto flight",text:`Ghetto flight allows using Dolphin and Rabbit Boots to fly up the
           waterfalls in the Angry Sea (without calming the whirlpools).
           This is done by swimming up to a diagonal beach and jumping
           in a different direction immediately before disembarking.`}),B.StatueGlitch=_e.flag("Gs",{name:"Statue glitch",text:`Statue glitch allows getting behind statues that block certain
           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,
           as well as the statues in the Waterfall Cave.  It is done by
           approaching the statue from the top right and holding down and
           left on the controller while mashing B.`,modes:"!"}),B.MtSabreRequirementSkip=_e.flag("Gn",{name:"Mt Sabre requirements skip",text:`Entering Mt Sabre North normally requires (1) having Teleport,
           and (2) talking to the rabbit in Leaf after the abduction (via
           Telepathy).  Both of these requirements can be skipped: first by
           flying over the river in Cordel plain rather than crossing the
           bridge, and then by threading the needle between the hitboxes in
           Mt Sabre North.`,modes:"!"}),B.StatueGauntletSkip=_e.flag("Gg",{name:"Statue gauntlet skip",text:`The shooting statues in front of Goa and Stxy normally require
           Barrier to pass safely.  With this flag, Flight can also be used
           by flying around the edge of the statue.`,modes:"!"}),B.SwordChargeGlitch=_e.flag("Gc",{name:"Sword charge glitch",text:`Sword charge glitch allows charging one sword to the level of
           another sword by equipping the higher-level sword, re-entering
           the menu, changing to the lower-level sword without exiting the
           menu, creating a hard save, resetting, and then continuing.`,hard:!0,modes:"!"}),B.TriggerSkip=_e.flag("Gt",{name:"Trigger skip",text:`A wide variety of triggers and exit squares can be skipped by
           using an invalid item every frame while walking.  This allows
           bypassing both Mt Sabre North entrance triggers, the Evil Spirit
           Island entrance trigger, triggers for guards to move, slopes,
           damage tiles, and seamless map transitions.`,hard:!0,modes:"!"}),B.RageSkip=_e.flag("Gr",{name:"Rage skip",text:`Rage can be skipped by damage-boosting diagonally into the Lime
           Tree Lake screen.  This provides access to the area beyond the
           lake if flight or bridges are available.  For simplicity, the
           logic only assumes this is possible if there's a flyer.`,hard:!0,modes:"!"});var Gt=class extends de{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description=`
      These flags don't directly affect gameplay or shuffling, but they do
      affect the experience significantly enough that there are three modes
      for each: "off", "optional" (no exclamation point), and "required"
      (exclamation point).  The first two are equivalent for seed generation
      purposes, so that you can play the same seed with either setting.
      Setting it to "!" will change the seed.`}},Te=Gt;Te.RandomizeMusic=Gt.flag("Am",{name:"Randomize background music",modes:"!",optional:As}),Te.NoMusic=Gt.flag("As",{name:"No background music",optional:jt}),Te.RandomizeMapColors=Gt.flag("Ac",{name:"Randomize map colors",modes:"!",optional:As});var At=class extends de{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}},Y=At;Y.RandomizeWeaknesses=At.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."}),Y.OopsAllMimics=At.flag("Mg",{name:"Replace all chests with mimics",text:`Every chest is now a mimic, and killing the mimic will drop
           the real item chest. Careful when killing the mimic, if it
           drops the chest out of reach you'll need to reset the room!`,hard:!0}),Y.TowerRobots=At.flag("Mt",{name:"Shuffle tower robots",text:`Tower robots will be shuffled into the normal pool.  At some
           point, normal monsters may be shuffled into the tower as well.`,hard:!0});var Ne=class extends de{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description=`
      The following options make parts of the game easier.`}},$=Ne;$.NoShuffleMimics=Ne.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."}),$.PreserveUniqueChecks=Ne.flag("Eu",{name:"Keep unique items and consumables separate",text:`Normally all items and mimics are shuffled into a single pool and
           distributed from there.  If this flag is set, unique items
           (specifically, anything that cannot be sold) will only be found in
           either (a) checks that held unique items in vanilla, or (b) boss
           drops.  Chests containing consumables in vanilla may be safely
           ignored, but chests containing unique items in vanilla may still
           end up with non-unique items because of bosses like Vampire 2 that
           drop consumables.  If mimics are shuffled, they will only be in
           consumable locations.`}),$.DecreaseEnemyDamage=Ne.flag("Ed",{name:"Decrease enemy damage",text:`Enemy attack power will be significantly decreased in the early game
           (by a factor of 3).  The gap will narrow in the mid-game and eventually
           phase out at scaling level 40.`}),$.GuaranteeStartingSword=Ne.flag("Es",{name:"Guarantee starting sword",text:`The Leaf elder is guaranteed to give a sword.  It will not be
           required to deal with any enemies before finding the first sword.`}),$.GuaranteeRefresh=Ne.flag("Er",{name:"Guarantee refresh",text:`Guarantees the Refresh spell will be available before fighting
           Tetrarchs.`}),$.ExperienceScalesFaster=Ne.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]}),$.NoCommunityJokes=Ne.flag("Ec",{name:"No community jokes",text:`Skip community jokes, such as funny/misspelled item, monster, or
           character names.  This will make it easier to look up information
           in guides/FAQs if necessary.`});var mt=class extends de{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description=`
      Removes various guarantees from the logic.`}},Z=mt;Z.BattleMagic=mt.flag("Nw",{name:"Battle magic not guaranteed",text:`Normally, the logic will guarantee that level 3 sword charges are
           available before fighting the tetrarchs (with the exception of Karmine,
           who only requires level 2).  This disables that check.`,hard:!0}),Z.MatchingSword=mt.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:`Enables "tink strats", where wrong-element swords will still do a
           single damage per hit.  Player may be required to fight monsters
           (including bosses) with tinks.`,hard:!0}),Z.Barrier=mt.flag("Nb",{name:"Barrier not guaranteed",text:`Normally, the logic will guarantee Barrier (or else refresh and shield
           ring) before entering Stxy, the Fortress, or fighting Karmine.  This
           disables that check.`,hard:!0}),Z.GasMask=mt.flag("Ng",{name:"Gas mask not guaranteed",text:`The logic will not guarantee gas mask before needing to enter the swamp,
           nor will leather boots (or hazmat suit) be guaranteed to cross long
           stretches of spikes.  Gas mask is still guaranteed to kill the insect.`,hard:!0});var Ue=class extends de{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}},j=Ue;j.NoBuffMedicalHerb=Ue.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:`Medical Herb is not buffed to heal 80 damage, which is helpful to make
           up for cases where Refresh is unavailable early.  Fruit of Power is not
           buffed to restore 56 MP.`,hard:!0}),j.MaxScalingInTower=Ue.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0}),j.ExperienceScalesSlower=Ue.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0}),j.ChargeShotsOnly=Ue.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0}),j.Blackout=Ue.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0}),j.Permadeath=Ue.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});var je=class extends de{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description=`
      Options to restore vanilla behavior changed by default.`}},U=je;U.Dyna=je.flag("Vd",{name:"Don't buff Dyna",text:`By default, we makes the Dyna fight a bit more of a challenge.
           Side pods will fire significantly more.  The safe spot has been
           removed.  The revenge beams pass through barrier.  Side pods can
           now be killed.  This flag prevents that change.`}),U.BonusItems=je.flag("Vb",{name:"Don't buff bonus items",text:`Leather Boots are changed to Speed Boots, which increase player walking
           speed (this allows climbing up the slope to access the Tornado Bracelet
           chest, which is taken into consideration by the logic).  Deo's pendant
           restores MP while moving.  Rabbit boots enable sword charging up to
           level 2 while walking (level 3 still requires being stationary, so as
           to prevent wasting tons of magic).`}),U.Maps=je.flag("Vm",{name:"Vanilla maps",text:`Normally the randomizer adds a new "East Cave" to Valley of Wind,
           borrowed from the GBC version of the game.  This cave contains two
           chests (one considered a key item) on the upper floor and exits to
           two random areas (chosen between Lime Tree Valley, Cordel Plain,
           Goa Valley, or Desert 2; the quicksand is removed from the entrances
           to Pyramid and Crypt), one unblocked on the lower floor, and one
           down the stairs and behind a rock wall from the upper floor.  This
           flag prevents adding that cave.  If set as "V!m" then a direct path
           will instead be added between Valley of Wind and Lime Tree Valley
           (as in earlier versions of the randomizer).`,modes:"!"}),U.Shops=je.flag("Vs",{name:"Vanilla shops",text:`By default, we disable shop glitch, shuffle shop contents, and tie
           the prices to the scaling level (item shops and inns increase by a
           factor of 2 every 10 scaling levels, armor shops decrease by a
           factor of 2 every 12 scaling levels).  This flag prevents all of
           these changes, restoring shops to be completely vanilla.`}),U.WildWarp=je.flag("Vw",{name:"Vanilla wild warp",text:`By default, Wild Warp is nerfed to only return to Mezame Shrine.
           This flag restores it to work like normal.  Note that this will put
           all wild warp locations in logic unless the flag is set as (V!w).`,modes:"!"}),U.Hud=je.flag("Vh",{name:"Vanilla HUD",text:`By default, the blue status bar (HUD) at the bottom of the screen
           is reorganized a bit, including displaying enemies' names and HP.
           This can be set either as Vh (which will optionally disable the
           changes, and will produce the same seed as not setting Vh) or as
           V!h (which requires all players to disable it to get the same
            seed).`,modes:"!",optional:As});var Pt=class extends de{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description=`
      The following quality-of-life flags turn <i>off</i> improvements that
      are normally on by default.  They are optional and will not affect the
      seed generation.  They may be toggled freely in race mode.`}},Ke=Pt;Ke.NoAutoEquip=Pt.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:`Prevents adding a quality-of-life improvement to automatically equip
           the corresponding orb/bracelet whenever changing swords.`,optional:jt}),Ke.NoControllerShortcuts=Pt.flag("Qc",{name:"Disable controller shortcuts",text:`By default, we disable second controller input and instead enable
           some new shortcuts on controller 1: Start+A+B for wild warp, and
           Select+B to quickly change swords.  To support this, the action of
           the start and select buttons is changed slightly.  This flag
           disables this change and retains normal behavior.`,optional:jt}),Ke.AudibleWallCues=Pt.flag("Qw",{name:"Audible wall cues",text:`Provide an audible cue when failing to break a non-iron wall.
           The intended way to determine which sword is required for normal
           cave walls is by looking at the color.  This causes the level 3
           sword sound of the required element to play when the wall fails
           to break.  Note that fortress walls (iron in vanilla) do not give
           this hint, since there is no visual cue for them, either.`,optional:jt});var pt=class extends de{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description=`
      These options are helpful for exploring or debugging.  Note that,
      while they do not directly affect any randomization, they
      <i>do</i> factor into the seed to prevent cheating, and they
      will remove the option to generate a seed for racing.`}},ne=pt;ne.SpoilerLog=pt.flag("Ds",{name:"Generate a spoiler log",text:`Note: <b>this will change the placement of items</b> compared to a
           seed generated without this flag turned on.`}),ne.TrainerMode=pt.flag("Dt",{name:"Trainer mode",text:`Installs a trainer for practicing certain parts of the game.
           At the start of the game, the player will have all swords, basic
           armors and shields, all worn items and magics, a selection of
           consumables, bow of truth, maximum cash, all warp points activated,
           and the Shyron massacre will have been triggered.  Wild warp is
           reconfigured to provide easy access to all bosses.  Additionally,
           the following button combinations are recognized:<ul>
             <li>Start+Up: increase player level
             <li>Start+Down: increase scaling level
             <li>Start+Left: get all balls
             <li>Start+Right: get all bracelets
             <li>Start+B+Down: get a full set of consumable items
             <li>Start+B+Left: get all advanced armors
             <li>Start+B+Right: get all advanced shields
           </ul>`}),ne.NeverDie=pt.flag("Di",{name:"Player never dies"}),ne.NoShuffle=pt.flag("Dn",{name:"Do not shuffle items",text:`Items will not be shuffled. WARNING: This disables the logic and
           is very likely to result in an unwinnable seed`});var tt=class{constructor(t="@Casual"){if(typeof t!="string"){this.flags=new Map;for(let[i,n]of t)this.set(i.flag,n);return}if(t.startsWith("@")){let i=We.get(t.substring(1));if(!i)throw new vs(`Unknown preset: ${t}`);this.flags=new Map(i.flags);return}this.flags=new Map,t=t.replace(/[^A-Za-z0-9!?]/g,"");let e=/([A-Z])([a-z0-9!?]+)/g,s;for(;s=e.exec(t);){let[,i,n]=s,o=/([!?]|^)([a-z0-9]+)/g;for(;s=o.exec(n);){let[,a,l]=s;for(let c of l)this.set(i+c,a||!0)}}}filterOptional(){return new tt(new Map([...this.flags].map(([t,e])=>[t,t.opts.optional?t.opts.optional(e):e])))}filterRandom(t){function e(s,i){return i!=="?"?i:t.pick([!0,!1,...s.opts.modes||""])}return new tt(new Map([...this.flags].map(([s,i])=>[s,e(s,i)])))}toString(){let t=new _(()=>new _(()=>[]));for(let[s,i]of this.flags){if(s.flag.length!==2)throw new Error(`Bad flag ${s.flag}`);if(!i)continue;let n=t.get(s.flag[0]),o=i===!0?"":i;n.get(o).push(s.flag[1])}let e=[];for(let[s,i]of t.sortedEntries()){let n=s;for(let[o,a]of i.sortedEntries())n+=o+a.sort().join("");e.push(n)}return e.join(" ")}toggle(t){let e=we.flags.get(t);if(!e)return console.error(`Bad flag: ${t}`),!1;let s=this.flags.get(e)||!1,i=[!1,!0,...e.opts.modes||"","?",!1],n=i.indexOf(s);if(n<0)throw new Error(`Bad current mode ${s}`);let o=i[n+1];return this.flags.set(e,o),o}set(t,e){let s=we.flags.get(t);if(!s){console.error(`Bad flag: ${t}`);return}if(!e)this.flags.delete(s);else if(e===!0||e==="?"||s.opts.modes?.includes(e))this.flags.set(s,e);else{console.error(`Bad flag mode: ${t[0]}${e}${t.substring(1)}`);return}for(let i of s.opts.excludes||[])this.flags.delete(we.flags.get(i))}check(t,...e){let s=t instanceof we?t:we.flags.get(t);return e.length||e.push(!0),e.includes(s&&this.flags.get(s)||!1)}get(t){let e=t instanceof we?t:we.flags.get(t);return e&&this.flags.get(e)||!1}alwaysMimics(){return this.check(Y.OopsAllMimics)}preserveUniqueChecks(){return this.check($.PreserveUniqueChecks)}shuffleMimics(){return this.check($.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(U.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(U.BonusItems,!1)}slowDownTornado(){return this.check(U.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(U.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(U.BonusItems,!1)||this.check(j.ChargeShotsOnly)}shuffleSpritePalettes(){return this.check(R.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(U.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(Y.TowerRobots)}shuffleMonsterElements(){return this.check(Y.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(j.NoBuffMedicalHerb,!1)}decreaseEnemyDamage(){return this.check($.DecreaseEnemyDamage)}trainer(){return this.check(ne.TrainerMode)}neverDie(){return this.check(ne.NeverDie)}noShuffle(){return this.check(ne.NoShuffle)}chargeShotsOnly(){return this.check(j.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(U.Maps,"!")}addEastCave(){return this.check(U.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(D.VanillaDolphin,!1)}storyMode(){return this.check(D.StoryMode)}noBowMode(){return this.check(D.NoBowMode)}requireHealedDolphinToRide(){return this.check(D.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(D.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(D.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(D.OrbsNotRequired)}shuffleGoaFloors(){return this.check(R.ShuffleGoaFloors)}shuffleHouses(){return this.check(R.ShuffleHouses)}shuffleAreas(){return this.check(R.ShuffleAreas)}mayShuffleAreas(){return!this.check(R.ShuffleAreas,!1)}randomizeMaps(){return this.check(R.RandomizeMaps)}randomizeTrades(){return this.check(R.RandomizeTrades)}unidentifiedItems(){return this.check(R.UnidentifiedKeyItems)}randomizeWalls(){return this.check(R.RandomizeWallElements)}guaranteeSword(){return this.check($.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(Z.BattleMagic,!1)}guaranteeMatchingSword(){return this.check(Z.MatchingSword,!1)}guaranteeGasMask(){return this.check(Z.GasMask,!1)}guaranteeBarrier(){return this.check(Z.Barrier,!1)}guaranteeRefresh(){return this.check($.GuaranteeRefresh)}communityJokes(){return this.check($.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(B.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(B.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(B.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(U.Shops,!1)}disableStatueGlitch(){return this.check(B.StatueGlitch,!1)}disableRageSkip(){return this.check(B.RageSkip,!1)}disableTriggerGlitch(){return this.check(B.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(B.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(B.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(B.GhettoFlight)}assumeTeleportSkip(){return this.check(B.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(B.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(B.StatueGlitch)}assumeTriggerGlitch(){return this.check(B.TriggerSkip)}assumeFlightStatueSkip(){return this.check(B.StatueGauntletSkip)}assumeWildWarp(){return this.check(U.WildWarp,!0)||this.check(R.RandomizeWildWarp)}assumeRageSkip(){return this.check(B.RageSkip)}nerfWildWarp(){return this.check(U.WildWarp,!1)&&this.check(R.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(R.RandomizeWildWarp,!0)}blackoutMode(){return this.check(j.Blackout)}hardcoreMode(){return this.check(j.Permadeath)}buffDyna(){return!this.check(U.Dyna)}maxScalingInTower(){return this.check(j.MaxScalingInTower)}expScalingFactor(){return this.check(j.ExperienceScalesSlower)?.25:this.check($.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(t){return t==="early"||this.check(Ke.NoAutoEquip,!1)}controllerShortcuts(t){return t==="early"||this.check(Ke.NoControllerShortcuts,!1)}randomizeMusic(t){return this.check(Te.RandomizeMusic,t==="early"?"!":!0)}shuffleTilePalettes(t){return this.check(Te.RandomizeMapColors,t==="early"?"!":!0)}noMusic(t){return t==="late"&&this.check(Te.NoMusic)}audibleWallCues(t){return t==="late"&&this.check(Ke.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(U.Hud,!1)}hasStatTracking(){return!0}validate(){if(this.shuffleAreas()&&this.preserveUniqueChecks())throw new vs("Wa and Eu are incompatible")}};var Kr=4656613057391769e-25,Ni=2147483563-1,Bi=40014,Vr=40692,Kt=53668,Di=52774,_i=12211,Xr=3791,Vt=32,Yr=1+Math.floor(Ni/Vt),Zr=12e-8,Jr=1-Zr,st=class{constructor(t=Math.floor(Math.random()*4294967296)){this.idum=0;this.idum2=0;this.iy=0;this.iv=[];this.z1=null;this.seed(t)}static newSeed(){return Math.floor(Math.random()*4294967296)}seed(t){this.idum=Math.max(1,Math.floor(t)),this.idum2=this.idum,this.iy=0,this.iv=new Array(Vt).fill(0);for(let e=Vt+7;e>=0;e--){let s=Math.floor(this.idum/Kt);this.idum=Bi*(this.idum-s*Kt)-s*_i,this.idum<0&&(this.idum+=2147483563),e<Vt&&(this.iv[e]=this.idum)}this.iy=this.iv[0]}next(){let t=Math.floor(this.idum/Kt);this.idum=Bi*(this.idum-t*Kt)-t*_i,this.idum<0&&(this.idum+=2147483563),t=Math.floor(this.idum2/Di),this.idum2=Vr*(this.idum2-t*Di)-t*Xr,this.idum2<0&&(this.idum2+=2147483399);let e=Math.floor(this.iy/Yr);return this.iy=this.iv[e]-this.idum2,this.iv[e]=this.idum,this.iy<1&&(this.iy+=Ni),Math.min(Kr*this.iy,Jr)}nextInt(t){return Math.floor(this.next()*t)}nextNormal(t=0,e=1,s=-1/0,i=1/0){for(;;){let n=this.z1;if(n==null){let o=Math.sqrt(-2*Math.log(this.next())),a=en*this.next();n=o*Math.cos(a),this.z1=o*Math.sin(a)}else this.z1=null;if(n=t+n*e,n>=s&&n<=i)return n}}shuffle(t){for(let e=t.length;e;){let s=this.nextInt(e--);[t[e],t[s]]=[t[s],t[e]]}return t}*ishuffle(t){let e=[];if(!Array.isArray(t))if(Qr(t)){let s=t[Symbol.iterator]();for(let i=0;i<t.size;i++){let n=i+this.nextInt(t.size-i);for(;e.length<=n;)e.push(s.next().value);yield e[n],e[n]=e[i]}return}else t=[...t];if(!Array.isArray(t))throw new Error("impossible");for(let s=0;s<t.length;s++){let i=s+this.nextInt(t.length-s);yield i in e?e[i]:t[i],e[i]=s in e?e[s]:t[s]}}pick(t){if(!t.length)throw new Error("empty array");return t[this.nextInt(t.length)]}pickWeighted(t){if(!t.length)throw new Error("empty array");let e=0;for(let[i]of t)e+=i;let s=this.next()*e;for(let[i,n]of t){if(s<i)return n;s-=i}throw new Error("bad weights")}pickAndRemove(...t){let e=0;for(let i of t)e+=i.length;if(!e)throw new Error("empty arrays");let s=this.nextInt(e);for(let i of t){if(s<i.length)return i.splice(s,1)[0];s-=i.length}throw new Error("impossible")}bitGenerator(){let t=0,e=0;return()=>{t||(t=32,e=this.nextInt(4294967296)),t--;let s=!(e&1);return e>>>=1,s}}};function Qr(r){return"size"in r}var en=2*Math.PI;var Me=class{constructor(t,e){this.height=t;this.width=e;this._coords=void 0;this.data=new Array((t<<1|1)*(e<<1|1)),this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;let t=[];for(let e=0;e<this.height;e++)for(let s=0;s<this.width;s++)t.push(e<<12|s<<4);return this._coords=t}index(t){return((t&248)>>3)+this.row*(t>>>11)}index2(t,e){return(this.row<<1)*t+2*e}yx(t){let e=t%this.row;return[(t-e)/this.row/2,e/2]}coord(t){let e=t%this.row;return(t-e)/this.row<<11|e<<3}get(t){return this.data[this.index(t)]}set(t,e){this.data[this.index(t)]=e}get2(t,e){return this.data[this.index2(t,e)]}set2(t,e,s){this.data[this.index2(t,e)]=s}plus(t,e,s){return t+(this.row<<1)*e+2*s}x(t){return t%this.row/2}y(t){return Math.floor(t/this.row)/2}border(t,e){let s,i;return t&1?(i=e<<12|2048,s=t&2?this.width<<4:0):(i=t&2?this.height<<12:0,s=e<<4|8),i|s}randomBorder(t,e){let s,i;if(e!=null)e&1?(i=t.nextInt(this.height)<<12|2048,s=e&2?this.width<<4:0):(i=e&2?this.height<<12:0,s=t.nextInt(this.width)<<4|8);else{let n=this.width+this.height,o=t.nextInt(n<<1)-n,a=!1;o<0&&(o=~o,a=!0),o<this.width?(s=o<<4|8,i=a?this.height<<12:0):(i=o-this.width<<12|2048,s=a?this.width<<4:0)}return i|s}oppositeBorder(t){return t&8?t^this.height<<12:t^this.width<<4}furthestBorder(t){return(this.height<<12|this.width<<4)-t}edgeCoordination(t,e){let s=0;if((t&2056)!==2056)throw new Error(`Bad tile: ${V(t)}`);for(let i of[8,-8,2048,-2048]){let n=this.get(t+i);(e?n===e:n)&&s++}return s}isBorder(t){if(t&8){if(t&2048)return!1;let e=t>>>12;return!e||e===this.height}else if(t&2048){let e=t>>>4&15;return!e||e===this.width}return!1}partition(t){let e=new ge;for(let s=0;s<this.data.length;s+=this.row)for(let i=0;i<this.row;i++){let n=s+i,o=this.coord(n);if(!(t?.get(o)??this.data[n]))continue;e.find(o);let l=o-2048;s&&(t?.get(l)??this.data[n-this.row])&&e.union([o,l]);let c=o-8;i&&(t?.get(c)??this.data[n-1])&&e.union([o,c])}return e.map()}show(){let t=[];for(let e=0;e<this.data.length;e+=this.row){let s="";for(let i=0;i<this.row;i++)s+=this.data[e+i]||" ";t.push(s)}return t.join(`
`)}static writeGrid2d(t,e,s){let i=t.index(e);for(let n=0;n<s.length;n++){let o=s[n];for(let a=0;a<o.length;a++){let l=o[a];t.data[i+n*t.row+a]=l!==" "?l:""}}}};function Wi(r){return r>>4&15|r>>8&240}function Ve(r,t=1){return r-t*8}function ke(r,t=1){return r+t*8}function ae(r,t=1){return r-t*2048}function Q(r,t=1){return r+t*2048}var[]=[V],T={ok:!0,value:void 0},Xt=class{constructor(t,e){this.rom=t;this.random=e;this.shuffles=[]}add(...t){this.shuffles.push(...t)}shuffleAll(){for(let t of this.shuffles)t.shuffle(this.random);for(let t of this.shuffles)t.meta&&t.finish();for(let t of this.rom.locations)t.meta.shufflePits(this.random)}toString(){return[...this.shuffles].sort((t,e)=>(t.badness||0)-(e.badness||0)).join(`
`)}},Yt=class{constructor(t,e){this.maxAttempts=250;this.attempt=0;this.meta=void 0;this.grid=new Me(1,1);this.fixed=new Set;this.w=0;this.h=0;this.size=0;this.count=0;this.exitMap=[];this.loc=t,this.orig=t.meta,this.params=e??this.survey(this.orig)}toString(){return`${this.constructor.name}(${this.loc}): ${this.attempt}/${this.maxAttempts}`}get badness(){return this.attempt/this.maxAttempts}reset(){this.meta=void 0;let t=this.pickHeight(),e=this.pickWidth(),s=this.pickSize(),i=new Me(t,e);i.data.fill(""),Object.assign(this,{h:t,w:e,size:s,grid:i,fixed:new Set,count:0,exitMap:[]})}shuffle(t){if(!(!this.loc.used||this.meta||this.attempt>this.maxAttempts)){for(Object.assign(this,{random:t});++this.attempt<=this.maxAttempts;){this.reset();let e=this.build();if(e.ok)return;console.log(`Shuffle failed ${this.loc}: ${e.fail}`)}console.error(`Completely failed to map shuffle ${this.loc}`)}}finish(){!this.meta||this.meta===this.loc.meta||this.finishInternal()}finishInternal(){if(!this.meta)throw new Error("impossible");this.meta.transferFlags(this.loc.meta,this.random);let t=[];for(let[e,s,i]of this.exitMap)for(let[n,o,a]of t)if(e(n,o)){t.push([s,i,a]);break}this.meta.transferExits(this.loc.meta,this.random);for(let[e,s,i]of t){let n=this.meta.rom.locations[i[0]>>>8].meta,o=i[0]&255,a=i[1];this.meta.attach(e,n,o,s,a)}this.meta.transferSpawns(this.loc.meta,this.random),this.meta.transferPits(this.loc.meta),this.loc.meta=this.meta}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(this.random.nextInt(5)<2?1:0)}insertTile(t,e){let s=this.posToGrid(t);for(let i=0;i<3;i++)for(let n=0;n<3;n++){let o=s+i*2048+n*8;if(this.fixed.has(o))return!1;let a=this.grid.get(o);if(a&&a!==e[i*3+n])return!1}for(let i=0;i<3;i++)for(let n=0;n<3;n++){let o=s+i*2048+n*8;this.grid.set(o,e[i*3+n])}return!0}posToGrid(t,e=0){let s=t>>>4,i=t&15;return(s<<12|i<<4)+e}insertPattern(t,{top:e=0,bottom:s=0,left:i=0,right:n=0}={}){let o=t.length-1>>>1,a=t[0].length-1>>>1,l=e+s,c=i+n;if(this.h<o+l)return{ok:!1,fail:"too short"};if(this.w<a+c)return{ok:!1,fail:"too narrow"};let d=this.random.nextInt(this.h-o-1-l)+e,f=this.random.nextInt(this.w-a-1-l)+i,u=d+1<<12|f+1<<4;Me.writeGrid2d(this.grid,u,t);for(let h=12288;h<=20480;h+=2048)for(let p=48;p<=64;p+=8)this.fixed.add(u+(h|p));return{ok:!0,value:void 0}}extract(t,e,{h:s=3,w:i=3,replace:n=void 0}={}){let o=t.index(e),a="",l=o+s*t.row,{row:c}=t;for(let d=o;d<l;d+=c)for(let f=d;f<d+i;f++){if(n){let u=n.get(t.coord(f));if(u!=null){a+=u||" ";continue}}a+=t.data[f]||" "}return a}canSet(t,e){return this.canSetAll(new Map([[t,e]]))}canSetAll(t){let e=new Set;for(let s of t.keys()){if(this.fixed.has(s))return!1;let i=s&-2057,n=i>>>12,o=i>>>4&15;o<this.w&&n<this.h&&e.add(i),!(s&8)&&n<this.h&&o&&e.add(i-16),!(s&2048)&&o<this.w&&n&&e.add(i-4096),!(s&2056)&&o&&n&&e.add(i-4112)}for(let s of e){let i=this.extract(this.grid,s,{replace:t});if(!this.orig.tileset.getMetascreensFromTileString(i).length)return!1}return!0}addAllFixed(){for(let t=0;t<this.grid.data.length;t++)this.grid.data[t]&&this.fixed.add(this.grid.coord(t))}};var[]=[V],v=class extends Yt{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0;this.initialFillType="c";this.upEdgeType="c";this._requirePitDestination=!1;this.rivers=0;this.wides=0;this.walls=0;this.bridges=0}reset(){super.reset(),this.rivers=0,this.wides=0,this.walls=0,this.bridges=0}requirePitDestination(){return this._requirePitDestination=!0,this}survey(e){let s={meta:e,id:e.id,tileset:e.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,statue:0,under:0,wall:0,wide:0}};if(e.id>=0)for(let i of e.rom.locations[e.id].spawns)i.isMonster()&&i.monsterId===143&&s.features.statue++;for(let i of e.allPos()){let n=e.get(i);(!n.isEmpty()||n.data.exits?.length)&&s.size++;for(let o of n.data.exits??[]){let{type:a}=o;if(a==="edge:top"){i>>>4===0&&s.edges[0]++;continue}else if(a==="edge:left"){(i&15)===0&&s.edges[1]++;continue}else if(a==="edge:bottom"){i>>>4===e.height-1&&s.edges[2]++;continue}else if(a==="edge:right"){(i&15)===e.width-1&&s.edges[3]++;continue}else{if(a==="crypt")continue;if(!a.startsWith("seamless")){if(o.dir&1)throw new Error(`Bad exit direction: ${o.dir}`);s.stairs[o.dir>>>1]++;continue}}}n.hasFeature("arena")&&s.features.arena++,n.hasFeature("bridge")&&s.features.bridge++,n.hasFeature("overpass")&&s.features.over++,n.hasFeature("pit")&&s.features.pit++,n.hasFeature("ramp")&&s.features.ramp++,n.hasFeature("spikes")&&s.features.spike++,n.hasFeature("underpass")&&s.features.under++,n.hasFeature("wall")&&s.features.wall++,n.hasFeature("river")&&s.features.river++,n.hasFeature("wide")&&s.features.wide++}return s.size<2&&(e.width>1||e.height>1)&&(s.size=2),s}build(){this.init();let e;if(e=this.fillGrid(),!e.ok||(e=this.preinfer(),!e.ok))return e;let s=this.inferScreens();return s.ok?(e=this.refineMetascreens(s.value),!e.ok||(e=this.checkMetascreens(s.value),!e.ok)?e:this._requirePitDestination&&!this.requireEligiblePitDestination(s.value)?{ok:!1,fail:"no eligible pit destination"}:(this.meta=s.value,T)):s}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.addEarlyFeatures(),!e.ok)||(e=this.refine(),!e.ok)?e:this.refineEdges()?(this.removeSpurs(),this.removeTightLoops(),e=this.addLateFeatures(),!e.ok||(e=this.addStairs(...this.params.stairs??[]),!e.ok)?e:T):{ok:!1,fail:"refineEdges"}}init(){}initialFill(){return this.fillCave(this.initialFillType),T}fillCave(e){for(let s=.5;s<this.h;s++)for(let i=.5;i<this.w;i++)s>1&&this.grid.set2(s-.5,i,e),i>1&&this.grid.set2(s,i-.5,e),this.grid.set2(s,i,e);this.count=this.h*this.w}addEdges(){if(!this.params.edges)return T;for(let e=0;e<4;e++){let s=this.params.edges[e]||0;if(!s)continue;let i=te(e&1?this.h:this.w,n=>this.grid.border(e,n));for(let n of this.random.ishuffle(i))if(!this.grid.get(n)&&(e&1?e===1?this.addLeftEdge(n)&&s--:this.addRightEdge(n)&&s--:e===0?this.addUpEdge(n)&&s--:this.addDownEdge(n)&&s--,!s))break;if(s)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}
missing ${s} ${e}`}}return T}addUpEdge(e){let s=e+2048,i=s-8,o=i-8-8,a=s+8,c=a+8+8;if(this.grid.isBorder(i)){if(this.grid.get(i))return!1}else if(this.grid.get(e-16)||this.grid.isBorder(o)&&this.grid.get(o))return!1;if(this.grid.isBorder(a)){if(this.grid.get(a))return!1}else if(this.grid.get(e+16)||this.grid.isBorder(c)&&this.grid.get(c))return!1;return this.fixed.add(e),this.grid.set(e,this.upEdgeType),this.grid.set(i,""),this.grid.set(a,""),!0}addDownEdge(e){let s=e-2048,i=s-8,n=s+8;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"n"),this.grid.set(i,""),this.grid.set(n,""),!0)}addLeftEdge(e){let s=e+8,i=s-2048,n=s+2048;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addRightEdge(e){let s=e-8,i=s-2048,n=s+2048;return!this.grid.get(s)||this.grid.isBorder(i)&&this.grid.get(i)||this.grid.isBorder(n)&&this.grid.get(n)?!1:(this.fixed.add(e),this.grid.set(e,"c"),!0)}addEarlyFeatures(){return this.addSpikes(this.params.features?.spike??0)?this.addOverpasses(this.params.features?.over??0)?T:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:`add spikes
${this.grid.show()}`}}addLateFeatures(){return this.addArenas(this.params.features?.arena??0)?this.addUnderpasses(this.params.features?.under??0)?this.addPits(this.params.features?.pit??0)?this.addRamps(this.params.features?.ramp??0)?T:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addPits"}:{ok:!1,fail:"addUnderpasses"}:{ok:!1,fail:`addArenas
${this.grid.show()}`}}addArenas(e){if(!e)return!0;let s=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let n=i|2056;if(!this.isEligibleArena(n))continue;let o=this.extract(this.grid,i),a=o.substring(0,4)+"a"+o.substring(5);if(!this.orig.tileset.getMetascreensFromTileString(a).length){console.log(`no tile ${a}`);continue}if(this.fixed.add(n),s.set(n,"a"),e--,!e)return!0}return!1}isEligibleArena(e){let s=this.grid,i=e-8,n=i-8,o=e+8,a=o+8;return!(s.get(e)!=="c"&&s.get(e)!=="w"||s.get(i)||s.get(o)||!s.isBorder(i)&&s.get(n)||!s.isBorder(o)&&s.get(a))}addUnderpasses(e){return this.addStraightScreenLate(e,"b",2048)}addOverpasses(e){let s=0;for(;e;){let i=this.random.nextInt(this.h-2)+1,n=this.random.nextInt(this.w-2)+1,o=i<<12|n<<4|2056;if(this.grid.get(o)!=="c"){if(++s>10)throw new Error("Bad attempts");continue}this.grid.set(o,"b"),this.fixed.add(o),this.grid.set(o-8,""),this.grid.set(o+8,""),e--}return!0}addPits(e){return this.addStraightScreenLate(e,"p")}addRamps(e){return this.addStraightScreenLate(e,"/",8)}addStraightScreenLate(e,s,i){if(!e)return!0;for(let n of this.random.ishuffle(this.grid.screens())){let o=n|2056;if(this.grid.get(o)!=="c")continue;if(i){let d=o-i,f=o+i;if(this.grid.get(d)||this.grid.get(f))continue}let a=this.extract(this.grid,n),l=a.substring(0,4)+s+a.substring(5);if(!!this.orig.tileset.getMetascreensFromTileString(l).length&&(this.fixed.add(o),this.grid.set(o,s),e--,!e))return!0}return!1}addSpikes(e){if(!e)return!0;let s=0;for(;e>0;){if(++s>20)return!1;let i=Math.min(e,Math.floor(this.h*.6),this.maxSpikes);for(;i<e-1&&i>this.minSpikes;)this.random.next()<.2&&i--;let n=i>2&&this.w>3?this.random.nextInt(this.w-2)+1:this.random.nextInt(this.w);i>e-this.minSpikes&&(i>=this.h-2?i=this.h-2:i=e);let a=this.random.nextInt(this.h-i-2)+1<<12|n<<4|2056,l=a+(i-1<<12);for(let f=a-4096;i&&f<=l+4096;f+=2048)this.grid.get(f)!=="c"&&(i=0);if(!i)continue;let c=[a-8,a+8,l-8,l+8],d=this.tryClear(c);if(!!d.length){for(let f of d)this.grid.set(f,"");this.fixed.add(a-2048),this.fixed.add(a-4096),this.fixed.add(l+2048),this.fixed.add(l+4096);for(let f=a;f<=l;f+=2048)this.fixed.add(f),this.grid.set(f,"s");e-=i,s=0}}return e===0}canRemove(e){return e===this.initialFillType}tryClear(e){let s=new Map;for(let c of e){if(this.fixed.has(c))return[];s.set(c,"")}let i=this.grid.partition(s),[n]=i.values();if(n.size===i.size)return[...e];let o=new Set,a=new Set(i.values());for(let c of this.fixed)o.add(i.get(c));if(o.size>this.maxPartitions)return[];let l=[...e];for(let c of a)o.has(c)||l.push(...c);return l}refine(){let e=new Set;for(let i=0;i<this.grid.data.length;i++)this.grid.data[i]&&e.add(this.grid.coord(i));let s=0;for(;this.count>this.size;){if(s++>50)throw new Error("refine failed: attempts");let i=0;for(let n of this.random.ishuffle([...e])){if(this.grid.isBorder(n)||!this.canRemove(this.grid.get(n))||this.fixed.has(n))continue;if(i>3)break;let o=this.grid.partition(this.removalMap(n)),[a]=o.values();if(a.size===o.size&&o.size>1)i++,e.delete(n),(n&2056)===2056&&this.count--,this.grid.set(n,"");else{let l;for(let d of o.values())(!l||d.size>l.size)&&(l=d);if(![...this.fixed].every(d=>l.has(d)))continue;let c=[...l].filter(d=>(d&2056)==2056).length;if(c<this.size)continue;i++,e=l,this.count=c,this.grid.set(n,"");for(let[d,f]of o)f!==l&&this.grid.set(d,"")}}if(!i)return this.looseRefine?T:{ok:!1,fail:`refine ${this.count} > ${this.size}
${this.grid.show()}`}}return T}removalMap(e){return new Map([[e,""]])}refineEdges(){let e=[];for(let o=0;o<this.grid.data.length;o++){if(!this.grid.data[o])continue;let a=this.grid.coord(o);this.grid.isBorder(a)||this.fixed.has(a)||(a^a>>8)&8&&e.push(a)}this.random.shuffle(e);let s=this.grid.partition(new Map),i=s.size,n=new Set(s.values()).size;for(let o of e){let a=this.grid.partition(new Map([[o,""]])),[l]=a.values();(l.size===a.size||new Set(a.values()).size===n)&&a.size===i-1&&(i--,this.grid.set(o,""))}return!0}removeSpurs(){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++){let i=e<<12|2056|s<<4;if(this.grid.get(i))continue;let n=i-2048,o=i+2048,a=i-8,l=i+8;(this.grid.get(n)||this.grid.get(o))&&(this.grid.get(a)||this.grid.get(l))&&(this.random.nextInt(2)?(this.grid.set(n,""),this.grid.set(o,"")):(this.grid.set(a,""),this.grid.set(l,"")))}}removeTightLoops(){for(let e=0;e<this.h-1;e++){let s=e<<12|2048;for(let i=0;i<this.w-1;i++){let n=s|i<<4|8;this.isTightLoop(n)&&this.breakTightLoop(n)}}}isTightLoop(e){for(let s=0;s<6144;s+=2048)for(let i=0;i<24;i+=8){let n=s|i;if(n!==2056&&this.grid.get(e+n)!=="c")return!1}return!0}breakTightLoop(e){let s=this.random.nextInt(65536),i=s&1?s&4096|8:s&16|2048;this.grid.set(e+i,"")}addStairs(e=0,s=0){let i=[e,s];if(!i[0]&&!i[1])return T;for(let n of this.random.ishuffle(this.grid.screens()))if(!!this.tryAddStair(n,i)&&!i[0]&&!i[1])return T;return{ok:!1,fail:"stairs"}}addEarlyStair(e,s){let i=[],n=e-8,o=e+8,a=e-2048,l=e+2048,c=[e-8,e+8];if(s==="<"){if(c.push(l),i.push([a,""]),this.grid.get(n)==="c"&&this.grid.get(o)==="c"&&this.random.nextInt(3))return i.push([l,""],[e,"<"]),i}else s===">"&&(c.push(a),i.push([l,""]));if(c=c.filter(f=>this.grid.get(f)==="c"),!c.length)return[];let d=this.random.nextInt(c.length);for(let f=0;f<c.length;f++)f!==d&&i.push([c[f],""]);return i.push([e,s]),i}tryAddStair(e,s){if(this.fixed.has(e|2056))return!1;let i=this.extract(this.grid,e),n=s[0]&&s[1],o=s[0]+s[1],a=this.random.nextInt(o)<s[0],l=[a?0:1];n&&l.push(a?1:0);for(let c of l){let d="<>"[c],f=i.substring(0,4)+d+i.substring(5);if(this.orig.tileset.getMetascreensFromTileString(f).length)return this.grid.set(e|2056,d),s[c]--,!0}return!1}tryConnect(e,s,i,n=1){for(;n-- >0;){let o=new Map,a=e;if((e&s&2056)!==2056)throw new Error(`bad start ${V(e)} or end ${V(s)}`);for(o.set(a,i);a!==s;){let l=[];for(let h of[8,-8,2048,-2048]){let p=a+h,m=a+2*h;this.fixed.has(m)||(o.get(m)??this.grid.get(m))||this.grid.isBorder(p)||l.push(h)}if(!l.length)break;let c=(s>>12)-(a>>12),d=(s&240)-(a&240),f=new Set(l);c<0&&f.delete(2048),c>0&&f.delete(-2048),d<0&&f.delete(8),d>0&&f.delete(-8),l.push(...f,...f);let u=this.random.pick(l);o.set(a+u,i),o.set(a=a+2*u,i)}if(a===s){for(let[l,c]of o)this.grid.set(l,c),(l&2056)===2056&&this.count++;return!0}}return!1}tryAddLoop(e,s=1){let i=new ge;for(let l=0;l<this.grid.data.length;l++){let c=this.grid.coord(l);this.grid.get(c)||this.grid.isBorder(c)||(this.grid.get(ke(c))||i.union([c,ke(c)]),this.grid.get(Q(c))||i.union([c,Q(c)]))}let n=new _(()=>[]);for(let l of this.grid.screens()){let c=l+2056;if(!!this.grid.get(c))for(let d of[8,-8,2048,-2048]){let f=c+d;if(this.grid.isBorder(f)||this.grid.get(f))continue;let u=c+2*d;if(this.grid.get(u))continue;let h=new Map([[f,e]]),p=this.extract(this.grid,l,{replace:h});this.orig.tileset.getMetascreensFromTileString(p).length&&n.get(i.find(u)).push([f,u])}}let o=new Map;for(let l of n.values())if(!(l.length<2))for(let[c]of l)o.set(c,l);let a=[...o.values()];if(!a.length)return!1;for(;s-- >0;){let l=this.random.pick(a),[[c,d],[f,u]]=this.random.ishuffle(l);if(this.grid.set(c,e),this.grid.set(f,e),this.tryConnect(d,u,e,5))return!0;this.grid.set(c,""),this.grid.set(f,"")}return!1}tryExtrude(e,s,i=1){for(;i--;)for(let n of this.random.ishuffle(this.grid.screens())){let o=n+2056;if(!this.grid.get(o))continue;let a=this.extract(this.grid,n);for(let l of this.random.ishuffle([0,1,2,3])){let c=o+xt[l],d=o+2*xt[l];if(this.grid.get(c)||this.grid.isBorder(c)||this.grid.get(d))continue;let f=Bs[l],u=a.substring(0,f)+e+a.substring(f+1);if(this.orig.tileset.getMetascreensFromTileString(u).length){this.grid.set(c,e),this.grid.set(d,e);let h=this.tryContinueExtrude(e,s,d);if(h)return h;this.grid.set(d,""),this.grid.set(c,"")}}}return 0}tryContinueExtrude(e,s,i){let n=this.extract(this.grid,i-2056),o=this.orig.tileset.getMetascreensFromTileString(n).length>0;if(s===1)return o?1:0;if(o&&!this.random.nextInt(s))return 1;for(let a of this.random.ishuffle([0,1,2,3])){let l=i+xt[a],c=i+2*xt[a];if(this.grid.get(l)||this.grid.isBorder(l)||this.grid.get(c))continue;let d=Bs[a],f=n.substring(0,d)+e+n.substring(d+1);if(this.orig.tileset.getMetascreensFromTileString(f).length){this.grid.set(l,e),this.grid.set(c,e);let u=this.tryContinueExtrude(e,s-1,c);if(u)return u+1;this.grid.set(c,""),this.grid.set(l,"")}if(o)break}return o?1:0}tryAdd(e={}){let s=this.orig.tileset,{attempts:i=1,char:n="c",start:o,loop:a=!1}=e;for(let l=0;l<i;l++){let c=o!=null?[o&61680]:this.random.ishuffle(this.grid.screens());for(let d of c){let f=d+2056;if(!this.grid.get(f))continue;let u=this.extract(this.grid,d);for(let h of this.random.ishuffle([0,1,2,3])){let p=f+xt[h],m=f+2*xt[h];if(this.fixed.has(p)||this.fixed.has(m))continue;let b=this.grid.get(p),S=this.grid.get(m);if(b&&(S||b!==n)||this.grid.isBorder(p))continue;if(!a){let x=this.extract(this.grid,m-2056,{replace:new Map([[p,""]])});if(/\S/.test(x))continue}let g=Bs[h],y=u.substring(0,g)+n+u.substring(g+1);if(s.getMetascreensFromTileString(y).length){this.count++,this.grid.set(p,n),this.grid.set(m,n);let x=this.extract(this.grid,m-2056);if(s.getMetascreensFromTileString(x).length)return 1;this.grid.set(m,S),this.grid.set(p,b),this.count--}}}}return 0}preinfer(){let e;return this.params.features?.spike&&(e=this.preinferSpikes(),!e.ok)?e:T}preinferSpikes(){return T}inferScreens(){let e=[];for(let n of this.grid.screens()){let o=this.extract(this.grid,n),a=this.orig.tileset.getMetascreensFromTileString(o).filter(c=>!c.data.mod);if(!a.length){if(this.grid.show().length>1e5)debugger;return{ok:!1,fail:`infer screen ${V(n)}: [${o}]
${this.grid.show()}`}}let l=this.random.pick(a);e.push(l),l.hasFeature("wall")&&this.walls++,l.hasFeature("bridge")&&this.bridges++}let s=!0,i=new be(this.params.id,this.orig.tileset,this.h,this.w);for(let n=0;n<this.h;n++)for(let o=0;o<this.w;o++){let a=e[n*this.w+o];if(i.set(n<<4|o,a),a.isEmpty()||(s=!1),n){let l=i.get(n-1<<4|o);if(this.orig.tileset.isBannedVertical(l,a))return{ok:!1,fail:`bad vertical neighbor at ${n}${o}: ${l.name} ${a.name}`}}if(o){let l=i.get(n<<4|o-1);if(this.orig.tileset.isBannedHorizontal(l,a))return{ok:!1,fail:`bad horizontal neighbor at ${n}${o}: ${l.name} ${a.name}`}}}return s?{ok:!1,fail:"all screens empty"}:{ok:!0,value:i}}refineMetascreens(e){let s=this.params.features?.bridge||0,i=this.params.features?.wall||0;for(let n of this.random.ishuffle(e.allPos())){let o=(n<<8|n<<4)&61680,a=this.extract(this.grid,o),l=e.get(n);if(!(this.bridges<=s&&l.hasFeature("bridge"))){if(this.addBlocks&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"block"))){l.hasFeature("bridge")&&this.bridges--;continue}if(l.hasFeature("bridge")&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"bridge"))){this.bridges--;continue}if(this.walls<i&&!l.hasFeature("wall")&&this.tryMeta(e,n,this.orig.tileset.withMod(a,"wall"))){this.walls++;continue}}}return this.bridges!==s?{ok:!1,fail:`refineMeta bridges want ${s} got ${this.bridges}
${e.show()}`}:this.walls!==i?{ok:!1,fail:`refineMeta walls want ${i} got ${this.walls}
${e.show()}`}:T}tryMeta(e,s,i){for(let n of i)if(!!this.checkMeta(e,new Map([[s,n]])))return e.set(s,n),!0;return!1}checkMeta(e,s){let i=s?{with:s}:{},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}requireEligiblePitDestination(e){let s=!1,i=!1;for(let n of e.allPos()){let o=e.get(n);if(o.hasFeature("river")||o.hasFeature("empty"))continue;let a=(o.data.edges||"").split("").map(l=>l===" "?"":l);if(a[0]&&a[2]&&(s=!0),(a[1]&&a[3]||o.hasFeature("spikes"))&&(i=!0),s&&i)return!0}return!1}checkMetascreens(e){if(!this.params.features?.statue)return T;let s=0;for(let i of e.allPos()){let n=e.get(i);s+=n.data.statues?.length||0}return s<this.params.features.statue?{ok:!1,fail:"insufficient statue screens"}:T}},it=class extends v{constructor(){super(...arguments);this.initialFillType="w";this.upEdgeType="n"}setUpEdgeType(e){return this.upEdgeType=e,this}isEligibleArena(e){return!(e&61440)&&super.isEligibleArena(e)}addEdges(){let e=this.grid,s=super.addEdges();if(!s.ok)return s;let i=this.params.features?.arena;if(!i)return T;let n=[];for(let o=0;o<this.w;o++){let a=o<<4|2056;e.get(a-2048)&&n.push(a)}if(n.length<i)return{ok:!1,fail:`not enough edges
${e.show()}`};for(let o of this.random.ishuffle(n)){if(!i)break;let a=o-8,l=a-8,c=l-8,d=l-2048,f=l+2048,u=o+8,h=u+8,p=h+8,m=h-2048,b=h+2048;!e.isBorder(a)&&(e.isBorder(c)&&e.get(c)||e.isBorder(d)&&e.get(d)||e.isBorder(f)&&e.get(f))||!e.isBorder(u)&&(e.isBorder(p)&&e.get(p)||e.isBorder(m)&&e.get(m)||e.isBorder(b)&&e.get(b))||(this.fixed.add(o),e.set(o,"a"),e.set(a,""),e.set(l,""),e.set(u,""),e.set(h,""),this.grid.set(o,"a"),i--)}return T}addArenas(){return!0}},Zt=class extends v{refineMetascreens(t){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++)this.grid.get(e<<12|s<<4|2056)==="a"&&t.set(e<<4|s,t.rom.metascreens.cryptArena_statues);return super.refineMetascreens(t)}isEligibleArena(t){return!this.grid.get(t-2048)&&super.isEligibleArena(t)}},Bs=[1,3,7,5],xt=[-2048,-8,2048,8];function Jt(r,t,e=!1){let s=new _s(r,t,e),i=new Ds(t,s,e);return[s,i]}var Ds=class extends v{constructor(e,s,i){super(e);this.location=e;this.under=s;this.reverse=i;this.downStairs=[]}init(){this.downStairs=[]}build(){return this.under.attempt<this.attempt&&(this.under.meta=void 0,this.under.shuffle(this.random),!this.under.meta)?{ok:!1,fail:"dependent failed"}:super.build()}finishInternal(){if(!this.meta||!this.under.meta)throw new Error("impossible");this.under.finish(),super.finishInternal();for(let[e,s]of se.zip(this.under.upStairs,this.downStairs))this.meta.attach(s,this.under.meta,e)}addEarlyFeatures(){let e=super.addEarlyFeatures();if(!e.ok)return e;let s=16,i=0,n=16,o=0,a=1;for(let l of[...this.under.underBridges,-1,...this.under.upStairs]){if(l===-1){a=0;continue}let c=l>>>4,d=l&15;s=Math.min(d,s),i=Math.max(d,i),n=Math.min(c-a,n),o=Math.max(c+a,o)}e:for(let l=0;l<10;l++){let c=[],d=this.random.nextInt(this.w-(i-s))+s,u=this.random.nextInt(this.h-(o-n))+n-n<<4+(d-s);for(let h of this.under.underBridges){let p=h+u,m=p>>>4,b=p&15,S=m<<12|b<<4|2056;if(this.grid.get(S)!=="c")continue e;c.push([S,"b"]),c.push([S-8,""]),c.push([S+8,""])}for(let h of this.under.upStairsEffective){let p=h+u,m=p>>>4,b=p&15,S=m<<12|b<<4|2056;if(this.grid.get(S)!=="c")continue e;c.push([S,this.reverse?"<":">"]),c.push([S+(this.reverse?-2048:2048),""]);let g=this.addEarlyStair(S,this.reverse?"<":">");if(!g.length)continue e;c.push(...g)}for(let[h,p]of c)p&&this.fixed.add(h),(p==="<"||p===">")&&this.downStairs.push(Wi(h)),this.grid.set(h,p);return T}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(e=0,s=0){return this.reverse?super.addStairs(e-this.under.upStairs.length,s):super.addStairs(e,s-this.under.upStairs.length)}addOverpasses(){return!0}},_s=class extends v{constructor(e,s,i){super(e);this.loc=e;this.overpass=s;this.reverse=i;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}init(){this.underBridges=[],this.upStairs=[],this.upStairsEffective=[]}build(){let e=super.build();if(!e.ok)return e;if(!this.meta)throw new Error("impossible");let s=this.reverse?"stair:down":"stair:up";for(let n of this.meta.allPos()){let o=this.meta.get(n);if(o.hasFeature("underpass")&&this.underBridges.push(n),o.hasFeature(s)){let a=0;for(let l of o.data.exits)l.type==="stair:up"&&l.entrance<32768&&(a=-16),l.type==="stair:down"&&l.entrance>32768&&(a=16);this.upStairsEffective.push(n+a),this.upStairs.push(n)}}if(!this.underBridges.length)throw new Error(`Expected bridge in ${this.loc}
${this.meta.show()}`);if(!this.upStairs.length)throw new Error(`Expected stair in ${this.loc}
${this.meta.show()}`);let i=0;for(let[,n,[o]]of this.orig.exits())n===s&&o>>>8===this.overpass.id&&i++;return this.upStairs=this.random.shuffle(this.upStairs).slice(0,i),T}};var rt=class extends v{constructor(){super(...arguments);this.maxAttempts=400}refineEdges(){return!0}preinfer(){let e=[];for(let i=0;i<this.h;i++)for(let n=0;n<this.w;n++){let o=i<<12|n<<4|2056;this.grid.get(o)&&e.push(o)}let s=e.filter(i=>this.tryClear([i]).length===1);if(!s.length)return{ok:!1,fail:"all critical?"};for(let i=0;i<s.length;i++)for(let n=0;n<i;n++)if(this.tryClear([s[i],s[n]]).length>2)return super.preinfer();return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}},Qt=class extends rt{removeTightLoops(){}};var Oe=class{constructor(t,e,s){this.h=t;this.w=e;this.valid=s;this.fixed=new Set;this.size=0;this.data=new Uint8Array(t*e)}fill(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let s=t*this.w+e;t>0&&(this.data[s]|=1),e>0&&(this.data[s]|=2),t<this.h-1&&(this.data[s]|=4),e<this.w-1&&(this.data[s]|=8)}}isBorder(t,e){let s=t%this.w,i=(t-s)/this.w;return this.isBorder2(i,s,e)}isBorder2(t,e,s){if(s===0)return!t;if(s===1)return!e;if(s===2)return t>=this.h-1;if(s===3)return e>=this.w-1;throw new Error("bad direction")}delete2(t,e,s=t*this.w+e){if(this.fixed.has(s))return!1;let i=new Map;i.set(s,0);for(let n=0;n<4;n++){if(this.isBorder2(t,e,n))continue;let o=s+this.delta(n),a=this.data[o],l=a&~(1<<(n^2));if(a!==l){if(this.fixed.has(o))return!1;i.set(o,l)}}return this.try(i)}delete(t){let e=t%this.w,s=(t-e)/this.w;return this.delete2(s,e,t)}deleteEdge2(t,e,s,i=t*this.w+e){if(this.fixed.has(i))return!1;if(this.isBorder2(t,e,s))return this.data[i]&=~(1<<s),!0;let n=new Map,o=i+this.delta(s);return this.fixed.has(o)?!1:(n.set(i,this.data[i]&~(1<<s)),n.set(o,this.data[o]&~(1<<(s^2))),this.try(n))}deleteEdge(t,e){let s=t%this.w,i=(t-s)/this.w;return this.deleteEdge2(i,s,e,t)}refine(t,e){let s=0,i=new Set;for(let n=0;n<this.data.length;n++)this.data[n]&&s++,this.fixed.has(n)||i.add(n);for(;s>e;){let n=!1;for(let o of t.ishuffle(i)){if(s<=e)break;if(!this.data[o]){s--;continue}this.delete(o)&&(n=!0,s--)}if(!n)return!1}return!0}validate(){for(let t=0;t<this.h;t++)for(let e=0;e<this.w;e++){let s=t*this.w+e,i=this.data[s];if(t&&!(this.data[s-this.w]&4)!=!(i&1))throw new Error(`invalid above ${t}${e}`);if(e&&!(this.data[s-1]&8)!=!(i&2))throw new Error(`invalid left of ${t}${e}`)}}addEdge(t,e,s){let i=t*this.w+e;this.data[i]|=1<<s,this.isBorder2(t,e,s)||(this.data[i+this.delta(s)]|=1<<(s^2))}consolidate(t,e){let s=new Is;for(let n=0;n<this.data.length;n++)!this.fixed.has(n)&&this.data[n]&&s.add(this.data[n]);let i=1e3;for(;s.unique()>e&&--i;){let n=[...s].sort((c,d)=>d[1]-c[1]),o=n[e][1],a=new Set(n.filter(c=>c[1]<=o).map(c=>c[0])),l=this.findEligibleConsolidates(a);if(!l.length)return[];for(let[c,d]of t.pick(l))this.data[c]&&s.delete(this.data[c]),d&&s.add(d),this.data[c]=d}return i?[...s].map(n=>n[0]):[]}consolidateFixed(t,e){let s=new Is;for(let n=0;n<this.data.length;n++){let o=this.data[n];!this.fixed.has(n)&&e.has(o)&&s.add(o)}let i=1e3;for(;s.unique()&&--i;){let n=this.findEligibleConsolidates(e);if(!n.length)return!1;for(let[o,a]of t.pick(n)){let l=this.data[o];e.has(l)&&s.delete(l),e.has(a)&&s.add(a),this.data[o]=a}}return!!i}findEligibleConsolidates(t){let e=[],s=[];for(let i=0;i<this.data.length;i++){if(this.fixed.has(i))continue;let n=this.data[i];if(!!t.has(n))for(let o=0;o<4;o++){if(this.isBorder(i,o))continue;let a=this.delta(o);if(this.fixed.has(i+a))continue;let l=1<<o;if(t.has(n^l))continue;let c=1<<(o^2),d=this.data[i+a],f=new Map([[i,n^l],[i+a,d^c]]);if(!!this.check(f)&&(e.push(f),!t.has(d^c)&&t.has(d))){s.push(f);break}}}return s.length?s:e}try(t){if(!this.check(t))return!1;for(let[e,s]of t)this.data[e]=s;return!0}check(t){let e=new ge;for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++){let n=s*this.w+i,o=t?.get(n)??this.data[n];o&&e.union([n]),s>0&&o&1&&e.union([n,n-this.w]),i>0&&o&2&&e.union([n,n-1]),s<this.h-1&&o&4&&e.union([n,n+this.w]),i<this.w-1&&o&8&&e.union([n,n+1])}return e.roots().length===1}addPath(t,e){let s,i;if(!this.size)s=t.nextInt(this.h),i=t.nextInt(this.w);else{let c=[];for(let f=0;f<this.data.length;f++)this.data[f]&&this.data[f]!==15&&c.push(f);if(!c.length)return!1;let d=t.pick(c);i=d%this.w,s=(d-i)/this.w}let n=new Map,o=s*this.w+i,a=0,l=!0;for(;;){let c=!1,d=n.get(o)??this.data[o],f=!1;for(let u of t.ishuffle([0,1,2,3])){let h=1<<u;if(d&h)continue;let p=d|h;if(this.valid&&!this.valid.has(p))continue;let m=s+tn[u],b=i+sn[u];if(m<0||b<0||m>=this.h||b>=this.w)continue;let S=m*this.w+b,g=n.get(S)??this.data[S],y=g|1<<(u^2);if(g){if(g===y||this.valid&&!this.valid.has(y))continue;c=!0}l=!this.valid||this.valid.has(y),n.set(o,p),n.set(S,y),i=b,s=m,o=S,f=!0;break}if(!f||c||this.data[o]||(this.size++||this.size++,l&&e&&this.size>=e)||l&&t.nextInt(15)<a++)break}if(!n.size||!l)return!1;for(let[c,d]of n)this.data[c]=d;return!0}toGrid(t){let e=new Me(this.h,this.w);for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++){let n=s*this.w+i,o=this.data[n];if(!o)continue;let a=s<<12|i<<4|2056;e.set(a,t);for(let l=0;l<4;l++){if(!(o&1<<l))continue;let c=l&1?8:2048;e.set(l&2?a+c:a-c,t)}}return e}delta(t){return(t&2?1:-1)*(t&1?1:this.w)}show(){let t=[];for(let e=0;e<this.h;e++){let s="";for(let i=0;i<this.w;i++)s+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250C\u251C\u252C\u253C"[this.data[e*this.w+i]];t.push(s)}return t.join(`
`)}},es=class{constructor(t,e,s){this.grid=t;this._i=e*t.w+s}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(t){let e=this.grid.delta(t),s=this._i+e,i=1<<t,n=1<<(t^2);this.grid.data[this._i]|=i,this.grid.data[this._i=s]|=n}directedPath(t,e,s){for(;;){let i=this.y,n=this.x,o=[];if(e<i&&o.push(0),s<n&&o.push(1),e>i&&o.push(2),s>n&&o.push(3),!o.length)return;this.go(t.pick(o))}}},tn=[-1,0,1,0],sn=[0,-1,0,1];var Lt=class extends v{constructor(){super(...arguments);this.maxAttempts=250}initialFill(){let e;return e=this.initialFillEarly(),!e.ok||(this.initialFillLate(),e=this.connectEarlyToLate(),!e.ok)?e:(this.count=[...this.grid.screens()].filter(s=>this.grid.get(s+2056)).length,T)}initialFillEarly(){let e=new Oe(this.h,this.w,this.getValidEarlyScreens()),s=0,i=this.targetEarly();for(;s++<20&&e.size<i;)e.addPath(this.random,i)&&(s=0);return this.grid.data=e.toGrid(this.early).data,this.addAllFixed(),T}initialFillLate(){for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++){let i=e<<12|s<<4|2056;this.grid.get(i)||this.grid.set(i,"c")}for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++)for(let i of[8,2048]){let n=e<<12|s<<4|2056,o=n+i,a=n+2*i;!this.grid.isBorder(o)&&!this.grid.get(o)&&this.grid.get(n)==="c"&&this.grid.get(a)==="c"&&this.grid.set(o,"c")}}connectEarlyToLate(){for(let e of this.random.ishuffle(this.grid.screens()))for(let s of[8,2048]){let i=e|2056,n=i+s,o=i+2*s;if(this.grid.isBorder(n)||this.grid.get(n))continue;this.grid.set(n,"c");let a=this.extract(this.grid,i-2056),l=this.extract(this.grid,o-2056);(!this.orig.tileset.getMetascreensFromTileString(a).length||!this.orig.tileset.getMetascreensFromTileString(l).length)&&this.grid.set(n,"")}return T}pruneDisconnected(){let e=new Set(this.grid.partition().values()),s=0;for(let i of e)if([...i].some(o=>this.grid.get(o)===this.early))s+=[...i].filter(o=>(o&2056)===2056).length;else for(let o of i){if(this.fixed.has(o))return{ok:!1,fail:`fixed tile ${V(o)} disconnected`};this.grid.set(o,"")}return s<this.params.size?(console.error(this.grid.show()),{ok:!1,fail:"too much disconnected"}):T}getValidEarlyScreens(){if(!this.validEarlyScreens){let e=new Set;for(let s of this.orig.tileset){let i=s.edgeIndex(this.early);i!=null&&e.add(i)}this.validEarlyScreens=e}return this.validEarlyScreens}addEarlyFeatures(){if(!this.addArenas(this.params.features?.arena??0))return{ok:!1,fail:"addArenas"};let e;return e=this.pruneDisconnected(),e.ok?super.addEarlyFeatures():e}},ts=class extends Lt{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){let e=this.params.features?.wide;return e!=null?e+2+this.random.nextInt(3):0}initialFillEarly(){let e=new Oe(this.h,this.w);e.fill();let s=te(e.data.length).slice(e.w),i=this.random.pick(s);if(!e.deleteEdge(i,1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(i,3))return{ok:!1,fail:"initial stair"};e.fixed.add(i);let n=new Set(s);n.delete(i);let o=[];for(let d of this.random.ishuffle(n)){let f=function(b){return e.delete(b)?(e.fixed.add(b),!0):!1},u=this.params.features?.arena??0;if(o.length>=u)break;if(d>e.data.length-2*e.w||e.fixed.has(d))continue;let h=!e.isBorder(d,1),p=!e.isBorder(d,3);if(h&&e.fixed.has(d-1)||p&&e.fixed.has(d+1)||e.fixed.has(d-e.w)||e.fixed.has(d+e.w)||!(e.data[d]&4))continue;if(!f(d-e.w))return{ok:!1,fail:"initial arena"};if(h&&!f(d-1))return{ok:!1,fail:"initial arena"};if(p&&!f(d+1))return{ok:!1,fail:"initial arena"};let m=d+e.w;if((e.data[m]&5)!==5)return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(m,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(m+e.w,2),e.fixed.add(m),o.push(d),e.fixed.add(d)}if(!e.refine(this.random,this.targetEarly()))return{ok:!1,fail:"refine"};let a=new Set;for(let d=1;d<16;d++)this.getValidEarlyScreens().has(d)||a.add(d);if(!e.consolidateFixed(this.random,a))return{ok:!1,fail:"consolidate"};this.grid.data=e.toGrid("w").data;let l=(d,f)=>{let u=d%e.w,p=(d-u)/e.w<<12|u<<4|2056;this.grid.set(p,f);for(let m of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])this.fixed.add(p+m)};l(i,">");for(let d of o)l(d,"a");let c=3;for(let d of this.grid.screens())this.grid.get(d+2056)&&c++;return this.size=c,T}addStairs(e,s){return super.addStairs(e,s?s-1:0)}addArenas(){return!0}connectEarlyToLate(){for(let e=0;e<this.h;e++){let s=e<<12|2056;for(let i=0;i<this.w;i++){let n=s|i<<4;this.grid.get(n)==="a"&&this.grid.set(n-2048,"c")}}return T}preinfer(){let e=new Map;for(let n=0;n<this.grid.data.length;n++)this.grid.data[n]==="w"&&e.set(this.grid.coord(n),"");let s=this.grid.partition(e),i=new Set;for(let[n,o]of s)this.grid.get(n)==="<"&&i.add(o);return i.size<2?{ok:!1,fail:"stairs bunched"}:T}refineMetascreens(e){for(let s of e.allPos())e.get(s).hasFeature("arena")&&e.set(s,e.rom.metascreens.fortressArena_through);return T}refineEdges(){return!0}};var ze=class extends Lt{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){return this.params.features?.river??0}preinfer(){if([...this.orig.exits()].length<2)return T;let e=new Map;for(let n=0;n<this.grid.data.length;n++)this.grid.data[n]==="r"&&e.set(this.grid.coord(n),"");let s=this.grid.partition(e),i=[];for(let n=0;n<this.grid.data.length;n++)(this.grid.data[n]==="<"||this.grid.data[n]===">"||this.grid.data[n]&&this.grid.isBorder(this.grid.coord(n)))&&i.push(s.get(this.grid.coord(n)));return new Set(i).size<i.length?{ok:!1,fail:`river didn't matter
${this.grid.show()}`}:super.preinfer()}addLateFeatures(){return T}addArenas(e){if(!e)return!0;let s=this.grid;for(let i of this.random.ishuffle(this.grid.screens())){let n=i|2056,o=n-8,a=o-8,l=n+8,c=l+8,d=n-2048,f=n+2048;if(s.get(n)!=="c"||s.get(d)!=="c"||s.get(f)!=="c")continue;let u=s.isBorder(o)?"":this.extract(s,a-2056),h=s.isBorder(l)?"":this.extract(s,c-2056);if(!/[^ c]/.test(u+h)&&(s.isBorder(o)||(s.set(o,""),s.set(a,""),s.set(a-8,""),s.set(a-2048,""),s.set(a+2048,"")),s.isBorder(l)||(s.set(l,""),s.set(c,""),s.set(c+8,""),s.set(c-2048,""),s.set(c+2048,"")),this.fixed.add(n),this.fixed.add(d),this.fixed.add(f),s.set(n,"a"),e--,!e))return this.pruneDisconnected(),!0}return!1}},ss=class extends ze{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(){let e=new Oe(this.h,this.w,this.getValidEarlyScreens()),s=2+this.random.nextInt(this.w-4),i=2+this.random.nextInt(this.w-4),n=new es(e,this.h-1,i);return n.go(0),n.directedPath(this.random,1,s),n.go(0),this.grid.data=e.toGrid("r").data,this.addAllFixed(),T}addEdges(){let e=-1,s=this.h-1<<12|2056;for(let o=0;o<this.w;o++)this.grid.get(s|o<<4)==="r"&&(e=o);if(e<0)throw new Error("no river on bottom edge");let i=s|this.random.nextInt(e)<<4,n=s|e+1+this.random.nextInt(this.w-1-e)<<4;return this.grid.set(i,">"),this.grid.set(i-8,""),this.grid.set(i+8,""),this.grid.set(n,">"),this.grid.set(n-8,""),this.grid.set(n+8,""),this.fixed.add(i),this.fixed.add(n),T}addStairs(){return T}checkMeta(e,s){let i=s?{flight:!0,with:s}:{flight:!0},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}},is=class extends v{constructor(){super(...arguments);this.addBlocks=!1}pickWidth(){return super.pickWidth()+this.random.nextInt(2)}initialFill(){let e=new _(()=>[]);for(let d of this.orig.tileset){if(!d.hasFeature("spikes")||!d.data.edges)continue;let f=0;for(let u=0;u<4;u++)d.data.edges[u]==="s"&&(f|=1<<u);e.get(f).push(...d.gridTiles())}let s=1+this.random.nextInt(this.w-2),i=1+this.random.nextInt(this.h-2),n=i<<4|s,o=this.posToGrid(n,2056),a=i<this.h/2?2:0;this.insertTile(n,this.random.pick(e.get(1<<a)));for(let d=4;d>=0;d--){n+=rn[a],o=o+Ns[a];let f=a^2,u=[];for(let[p,m]of e){if(!(p&1<<f))continue;let b=p&~(1<<f);if(!(d?!b:b))for(let S of m)u.push(p)}let h;for(let p of this.random.ishuffle(u))if(!this.grid.isBorder(o+Ns[p])&&this.insertTile(n,this.random.pick(e.get(p)))){h=31-Math.clz32(p&~(1<<f));break}if(h==null)return{ok:!1,fail:"spikes"};a=h}let l=[];for(let d=3;d<this.h-3;d++)for(let f=1;f<this.w-1;f++)l.push(d<<12|f<<4|2056);let c=!1;for(let d of this.random.ishuffle(l))if(!this.grid.get(d)){for(let f of Ns){if(this.grid.get(d+f)!=="c")continue;this.grid.set(d,"r");let u=2056&~Math.abs(f);this.grid.set(d+u,"r"),this.grid.set(d-u,"r");let h=this.random.pick([-u,u]);this.grid.set(d+2*h,"r"),this.grid.set(d+3*h,"r"),this.grid.set(d+2*h-f,"c"),c=!0;break}if(c)break}if(!c)return{ok:!1,fail:"nucleate river"};for(let d=5+this.random.nextInt(3);d>0;d--)if(!this.tryAdd({char:"c"}))return{ok:!1,fail:"fill cave"};for(let d=0;d<this.grid.data.length;d++)if(this.grid.data[d]&&this.grid.isBorder(this.grid.coord(d)))return{ok:!1,fail:"border"};return T}checkMeta(e,s){let i=s?{flight:!0,with:s}:{flight:!0},n=e.traverse(i);return new Set(n.values()).size===this.maxPartitions}refine(){return T}refineEdges(){return!0}addSpikes(e){return!0}refineMetascreens(e){let s=super.refineMetascreens(e);if(!s.ok)return s;function i(a){return[...new Set(a.values())].filter(c=>{for(let d of c)if(e.exitType(d)?.startsWith("stair"))return!0;return!1}).length}let n=i(e.traverse()),o=i(e.traverse({flight:!0}));return n===o?{ok:!1,fail:"flight not required"}:T}},Ns=[-2048,-8,2048,8],rn=[-16,-1,16,1],rs=class extends ze{constructor(){super(...arguments);this.addBlocks=!1}fillGrid(){let e=[],s=0;for(let l of this.random.ishuffle(te(this.w-2,c=>c+1))){if(e.length===1&&(l-e[0])**2<=1)continue;let c=this.h-1<<12|l<<4|2056;if(this.grid.set(c,"c"),this.grid.set(ae(c),"c"),this.grid.set(Q(c),"n"),this.fixed.add(c),this.fixed.add(ae(c)),this.fixed.add(Q(c)),e.push(l),s++,e.length===2)break}if(e.length<2)return{ok:!1,fail:"initial edges"};let i=this.w,n=this.random.nextInt(Math.abs(e[0]-e[1])-1)+Math.min(e[0],e[1])+1;for(let l=1;l<2*this.w;l++)l!==2*n+1&&(this.grid.set(this.h-2<<12|l<<3|2048,"r"),this.fixed.add(this.h-1<<12|l<<3|2048));let o=this.params.features.river;for(;i<o;){let l=this.tryAdd({char:"r"});if(!l)return{ok:!1,fail:`failed to extrude river
${this.grid.show()}`};i+=l,s+=l}let a=this.params.size;for(;s<a;){let l=this.tryAdd();if(!l)return{ok:!1,fail:"failed to extrude cave"};s+=l}return this.addStairs(...this.params.stairs??[])}checkMeta(){return!0}refineMetascreens(e){let s=super.refineMetascreens(e);if(!s.ok)return s;function i(l){let c=0;for(let d of new Set(l.values()))for(let f of d)if(e.exitType(f)==="edge:bottom"){c+=d.size;break}return c}let n=i(e.traverse({noFlagged:!0})),o=i(e.traverse());if(n===o)return{ok:!1,fail:"bridge didn't matter"};let a=i(e.traverse({flight:!0}));return o===a?{ok:!1,fail:"flight not required"}:T}},ns=class extends ze{constructor(){super(...arguments);this.pattern=["               "," rrrrrrrrrrrrr "," r           r "," r rrrrrrrrr r "," r r       r r "," r r rrrrr r r "," r r r   r r r "," r r r   r r r "," r r r   r r r "," r r r < r r r "," r r r c r r r "," r r rrrrr r r "," r r       r r "," r rrrrrrrrr r "," r           r "," rrrrrrrrrrrrr ","               "]}initialFill(){return this.insertPattern(this.pattern)}addEdges(){let e;for(let n=0;n<this.grid.data.length;n++)if(this.grid.data[n]==="r"){e=this.grid.coord(n)-2056;break}if(e==null)throw new Error("no corner");let s=[];for(let n=0;n<this.pattern.length;n++)for(let o=1;o<this.pattern[n].length-1;o++)!((o^n)&1)||this.pattern[n][o]===" "&&s.push(e+(n<<11|o<<3));let i=this.random.shuffle([..."ccrrrrrrrr"]);for(let n of this.random.ishuffle(s)){let o=i[i.length-1];if(!(o==="c"&&[...this.extract(this.grid,n-2056)].filter(a=>a==="r").length<4)&&(this.canSet(n,o)&&this.grid.set(n,i.pop()),!i.length))break}for(let n=0;n<6;n++)this.tryAdd({char:"c"});return T}refine(){let e=[...this.params.stairs??[]];if(e[0]--,e[0]||e[1]){let n=this.addStairs(...e);if(!n.ok)return n}let s=0;for(let n of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,n).replace(/ /g,"")==="c"&&(e[0]&&!this.grid.get(n+8)&&(this.grid.set(n+2056,"<"),e[0]--),this.fixed.add(n+2056),++s>=2))break;let i=this.grid.partition();return new Set(i.values()).size>1?{ok:!1,fail:"orphans"}:T}fillGrid(){let e;return e=this.initialFill(),!e.ok||(e=this.addEdges(),!e.ok)||(e=this.refine(),!e.ok)?e:T}checkMeta(e,s){let i=e.traverse(s?{with:s}:{}),n=[];for(let o of new Set(i.values())){let a=0;for(let l of new Set([...o]))e.exitType(l)&&a++;n.push(a)}return n.filter(o=>o>0).length===1}refineMetascreens(e){if(!this.checkMeta(e))return{ok:!1,fail:"initial checkMeta"};let s=super.refineMetascreens(e);if(!s.ok)return s;function i(a){let l=0;for(let c of new Set(a.values()))for(let d of c)if(e.exitType(d)){l+=c.size;break}return l}let n=i(e.traverse()),o=i(e.traverse({flight:!0}));return n===o?{ok:!1,fail:"flight not required"}:T}};var os=class extends v{build(){let{h:t,w:e}=this,s=this.orig.rom,i=new Oe(t,e);i.fill();let n=t*e<28?0:this.random.nextInt(t-1),o=this.random.nextInt(e),a=new Set;function l(w,k){i.delete2(w,k),a.add(w*i.w+k)}function c(w){return!w.startsWith("edge")}a.add(n*i.w+o),o&&l(n,o-1),o<i.w-1&&l(n,o+1),n&&(l(n-1,o),o&&l(n-1,o-1),o<i.w-1&&l(n-1,o+1));for(let w of a)i.fixed.add(w);let d=new Set;for(let w=0;w<4;w++){let k=w&1?t:e,M=this.random.shuffle(te(k)),N=w&2?k:0,J=this.params.edges?.[w]??0;for(;J&&M.length;){let ie=w&1?M.pop():N,re=w&1?N:M.pop(),q=ie*i.w+re;!i.data[q]||i.fixed.has(q)||(i.addEdge(ie,re,w),d.add(ie<<4|re),J--)}if(J)return{ok:!1,fail:`could not add all edges: ${w} ${J}
${i.toGrid("c").show()}
${i.data}`}}let f=0,u=i.h*i.w*(this.random.next()*.15+.4);for(let w of this.random.ishuffle(te(i.data.length<<2))){let k=w>>>2,M=w&3;if(!i.isBorder(k,M)&&i.deleteEdge(k,M)&&++f>=u)break}let h=new Set,p=new Set,m=[],b=[],S;for(let w of this.orig.tileset){if(w.hasFeature("arena")){S=w;continue}else if(w.hasFeature("empty")){m[0]=w;continue}let k=w.edgeIndex("s");if(k==null)throw new Error("bad edges");let M=w.data.exits?.some(N=>c(N.type));(M?b:m)[k]=w,(w.sid<0?p:h).add(w.sid)}if(!S)throw new Error("never found arena");let g=i.consolidate(this.random,h.size),y=new Set(g.map(w=>m[w].sid));if(!y.size)return{ok:!1,fail:"consolidate failed"};let x=[...p].filter(w=>y.has(w)),I=[...h].filter(w=>!y.has(w));if(x.length>I.length)throw new Error("out of space");if(x.length){let w=-1;for(;s.metascreens.getById(w).length;)w--;let k=w;for(let M=0;M<x.length;M++)s.metascreens.renumber(I[M],w),s.metascreens.renumber(x[M],I[M]),w=x[M];s.metascreens.renumber(k,x[x.length-1])}let E=new be(this.orig.id,this.orig.tileset,t,e);for(let w=0;w<i.h;w++)for(let k=0;k<i.w;k++){let M=w===n&&k===o;E.set(w<<4|k,M?S:m[i.data[w*i.w+k]])}let F=[...this.orig.exits()].filter(w=>c(w[1])).length;for(let w of this.random.ishuffle(E.allPos())){if(!F)break;if(d.has(w))continue;let k=w&15,M=w>>>4,N=b[i.data[M*i.w+k]];!N||(E.set(w,N),F--)}return F?{ok:!1,fail:"could not place all doors"}:T}};function Oi(r){let{swamp:t}=r.metatilesets,e=r.metascreens,s=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(let[i,n,o]of s)t.getTile(i).copyFrom(n).setAlternative(o);e.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]),e.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]),e.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]),e.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]),e.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]),e.registerFix(15,0)}var as=class extends v{initialFill(){let e=this.size+3,s=this.random.nextInt(this.w)<<4|this.h-1<<12|2056;this.grid.isBorder(Ve(s))||this.fixed.add(Ve(s,2)),this.grid.isBorder(ke(s))||this.fixed.add(ke(s,2)),this.grid.set(s,">"),this.fixed.add(s),this.grid.set(ae(s),"w"),this.fixed.add(ae(s)),this.fixed.add(Ve(s)),this.fixed.add(ke(s));let i=this.random.nextInt(this.w)<<4|2056,n=Q(i,2);if(this.grid.set(i,"<"),this.fixed.add(i),this.grid.set(Q(i),"w"),this.fixed.add(Q(i)),this.grid.set(n,"w"),this.fixed.add(n),this.grid.set(Q(n),"w"),this.fixed.add(Q(n)),this.fixed.add(Ve(n)),this.fixed.add(ke(n)),!this.tryConnect(ae(s,2),Q(n,2),"w",10))return{ok:!1,fail:"initial connect"};for(;this.count<e;)if(!this.tryAddLoop("w",10))return{ok:!1,fail:"add loops"};return T}refine(){return T}refineEdges(){return!0}addArenas(){return!0}addStairs(){return T}refineMetascreens(e){console.log(e.show());for(let i=0;i<e.height;i++)for(let n=0;n<e.width;n++){let o=i<<4|n,a=e.get(o),l=a.edgeIndex("w");if(a.hasFeature("arena"))this.arena=o+16<<8|1;else if(l===5){if(o<16||!e.get(o-16).hasFeature("arena")){e.set(o,e.rom.metascreens.goaWideHallNS_stairs);let c=(o<<8|o<<4)&61680|2056;this.grid.set(c,"H")}}else l===1&&(this.stair=o<<8|2)}if(this.reachable=void 0,!this.checkMeta(e))return{ok:!1,fail:"initial meta check"};console.log(e.show());let s=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(let i=0;i<e.width;i++)for(let n=0;n<e.height;n++){let o=n<<12|i<<4|2056,a=0;for(;n+a<e.height&&this.grid.get(o+a*4096)==="H";)a++;if(!a)continue;let l=[new Map,new Map];for(let d=0;d<a;d++)l[d&1].set(n+d<<4|i,s);let c=!1;for(let d of this.random.ishuffle(l)){if(!d.size){c=!0;continue}if(!!this.checkMeta(e,d)){for(let[f,u]of d)e.set(f,u),this.grid.set(o+4096*((f>>4)-n),"=");c=!0;break}}if(!c)return{ok:!1,fail:"could not rectify hallway"};n+=a}return super.refineMetascreens(e)}checkMeta(e,s){let i=s?{with:s}:{},n=e.traverse(i),o=n.get(this.stair);return o!==n.get(this.arena)?(console.log(`stair not connected to arena
${e.show()}`),!1):this.reachable==null?o&&o.size<n.size*.95?(console.log("too small"),!1):(this.reachable=o?.size,!0):o?.size>this.reachable*.95}};function zi(r,t){let{metatilesets:{cave:e,fortress:s,iceCave:i,labyrinth:n,pyramid:o}}=r;r.metascreens.registerFix(14,1);{for(let l of[n,o])l.getTile(43).copyFrom(25).replaceIn(...l),l.getTile(186).copyFrom(27).replaceIn(...l);for(let l of[s,n,o,e])l.getTile(25).copyFrom(23).replaceIn(...l),l.getTile(27).copyFrom(24).replaceIn(...l);for(let l of[i,e,o])l.getTile(23).copyFrom(197),l.getTile(24).copyFrom(197);n.getTile(23).copyFrom(198).setAlternative(197),n.getTile(24).copyFrom(196).setAlternative(197)}let a=new _(()=>[]);for(let l of r.metatilesets.labyrinth)a.get(l.sid).push(l);for(let[l,c]of a){let d=r.screens[l],f=c.map(p=>p.data.tilesets.labyrinth?.removeWall),[u,...h]=new Set(f.filter(p=>p!=null));if(u!=null){if(d.set2d(u,[[197,197],[208,197]]),h.length)throw new Error("bad remove");for(let p=0;p<f.length;p++)f[p]==null&&(c[p].data.tilesets.labyrinth.addWall=[u])}if(!(c.length<2)){if(c.length>2){let p=t.pick(c.filter(m=>m.data.tilesets.labyrinth?.addWall));c.splice(c.indexOf(p),1),p.remove()}for(let p of c){let m=p.data.tilesets.labyrinth?.addWall;if(m!=null){p.data.mod="block";for(let b of m)d.set2d(b,[[23,23],[24,24]])}else p.flag="always"}}}}var ls=class{constructor(t){this.location=t}shuffle(t){if(this.meta)throw new Error("impossible");let e=this.location.meta;on(e,t),t.nextInt(2)&&an(this.location.rom);let s=[...e.exits()].filter(a=>a[1]==="stair:up"),i=[...e.exits()].filter(a=>a[1]==="stair:down");t.shuffle(s),t.shuffle(i);for(let a of[...e.exits()])if(a[2][0]>>>8!==this.location.id){let l=(a[1]==="stair:up"?s:i).pop();e.setExit(l[0],l[1],a[2])}if(s.length!==i.length)throw new Error("length mismatch");let n=t.shuffle([...i]);for(let a=0;a<i.length;a++)i[a]===n[a]&&(t.shuffle(n),a=-1);let o=this.location.id<<8;for(let a=0;a<s.length;a++)e.setExitOneWay(s[a][0],s[a][1],[o|i[a][0],i[a][1]]),e.setExitOneWay(n[a][0],n[a][1],[o|s[a][0],s[a][1]]);this.meta=e}finish(){}};function on(r,t){let e=t.nextInt(2)+6,s=t.nextInt(3)+2;if(e===7&&s===3)return;let{branchNWSE:i,branchNWE:n,branchWSE:o,branchNWE_upStair:a,deadEndW:l,deadEndE:c}=r.rom.metascreens,d=e<<4|s,f=o;e===7&&s===1&&(f=c),e===7&&s===5&&(f=l),r.set2d(99,[[i],[i],[i]]),r.set2d(d-16,[[n],[a],[f]]),r.moveExit(115,d)}function an(r){let t=r.locations.Pyramid_Draygon.meta,e=r.locations.Pyramid_Main.meta,{metascreens:{hallSE:s,deadEndW_downStair:i,wideHallNE:n,wideHallNW:o,fortressArena_through:a,deadEndS_stairs:l}}=r;t.width=2,t.set2d(0,[[null,l],[null,a],[n,o]]),t.moveExit(32,1),e.set2d(3,[[s,i]]),e.moveExit(3,4),e.attach(4,t,1)}function $i(r,t,e){let s=new Ws(r),i=new Os(t,s),n=new zs(e,i);return[s,i,n]}var Ws=class extends v{constructor(){super(...arguments);this.patterns=[["     "," >cc ","   c ","   b ","   c "],["     "," cc> "," c   "," b   "," c   "],["   c ","   b ","   c "," >cc ","     "],[" c   "," b   "," c   "," cc> ","     "]]}initialFill(){let e=this.random.pick(this.patterns);this.count=3;let s=this.insertPattern(e,{top:1,bottom:1});if(!s.ok)return s;this.addAllFixed();for(let i=0;i<this.grid.data.length;i++){if(this.grid.data[i]!==">")continue;let n=this.grid.coord(i);this.stair=n>>>8&240|n>>>4&15}return T}addEdges(){let e=10;for(;this.count<this.size&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"addEdges"}}addEarlyFeatures(){let e=!1;for(let s of this.random.ishuffle(this.grid.screens()))if(this.extract(this.grid,s)===" c  c  c "){this.grid.set(s+2056,"b"),e=!0;break}return e?super.addStairs(0,2):{ok:!1,fail:"could not add bridge"}}refine(){return T}addLateFeatures(){return T}addStairs(){return T}},Os=class extends v{constructor(e,s){super(e);this.location=e;this.upper=s;this.maxAttempts=200}build(){return this.upper.attempt<this.attempt&&(this.upper.meta=void 0,this.upper.shuffle(this.random),!this.upper.meta)?{ok:!1,fail:"dependent failed"}:super.build()}initialFill(){let e=[],s=!0,i=this.upper.meta,n=this.upper.stair;if(i.get(n).isEmpty()||(n+=16,s=!1),n==null)throw new Error("no stair found");for(let x of i.allPos())i.get(x).hasFeature("overpass")&&e.push(x);this.random.shuffle(e);let o=n>>>4,a=n&15,l=a,c=o;for(let x of e){let I=x>>>4,E=x&15;o=Math.min(o,I),a=Math.min(a,E),l=Math.max(l,E),c=Math.max(c,I)}let d=c-o+1,f=l-a+1,u=o<<4|a,h=1+this.random.nextInt(this.w-f-2),m=(this.random.nextInt(this.h-d-(s?1:0))<<4|h)-u,b=(n&15)-a<f/2;n+=m;for(let x=0;x<e.length;x++)e[x]+=m;let S=s?"    <  c ":b?"    <c   ":"   c<    ";if(!this.insertTile(e[0],"   cbc   ")||!this.insertTile(e[1],"   cbc   "))throw new Error("Could not insert bridge tile");if(!this.insertTile(n,S)){let x=[-1,1,16,-16,15,17,-15,-17],I=!1;for(let E of this.random.ishuffle(x))if(this.insertTile(n+E,S)){n+=E,I=!0;break}if(!I)throw new Error("Could not insert stair")}this.stair=n,this.addAllFixed(),this.count=3;let g=b?1:-1,y=s?16:g;return!e.includes(n+g)&&!this.tryConnect(this.posToGrid(n+y,2056),this.posToGrid(e[0]-g,2056),"c",10)?{ok:!1,fail:"could not connect stair to bridge"}:this.tryConnect(this.posToGrid(e[0]+g,2056),this.posToGrid(e[1]+g,2056),"c",10)?T:{ok:!1,fail:"could not connect bridges"}}addEdges(){let e=100;for(;this.count<this.size-4&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"could not populate"}}refine(){return T}refineEdges(){return!0}addUnderpasses(){return!0}addArenas(){for(let e of this.random.ishuffle(this.grid.screens())){if(!(e&61440))continue;let s=e+2056;if(!(this.fixed.has(s)||this.grid.get(s))&&!(this.grid.get(Ve(s,2))||this.grid.get(ke(s,2)))&&this.grid.get(Q(s,2))==="c"&&!!this.canSetAll(new Map([[Q(s),"c"],[s,"a"],[ae(s),"c"],[ae(s,2),"c"]])))return this.grid.set(Q(s),"c"),this.grid.set(s,"a"),this.grid.set(ae(s),"c"),this.fixed.add(s),this.fixed.add(ae(s,2)),!0}return!1}addStairs(e=0,s=0){return super.addStairs(e-1,s)}finishInternal(){if(!this.meta)throw new Error("impossible");this.upper.finish(),super.finishInternal();let e=this.upper.meta,s=this.upper.stair,i=this.stair;s!=null&&i!=null&&this.meta.attach(i,e,s,"stair:up","stair:down")}},zs=class extends v{constructor(e,s){super(e);this.main=s}build(){return this.main.attempt<this.attempt&&(this.main.meta=void 0,this.main.shuffle(this.random),!this.main.meta)?{ok:!1,fail:"dependent failed"}:super.build()}findArena(e){for(let s of e.allPos())if(e.get(s).hasFeature("arena"))return s;throw new Error("never found arena")}initialFill(){let e=this.main.meta,s=this.findArena(e),i=this.posToGrid(s,2056);return this.grid.set(i,"a"),this.grid.set(ae(i),"c"),this.grid.set(Q(i),"c"),this.fixed.add(i),this.fixed.add(Q(i)),this.fixed.add(Q(i,2)),T}addEdges(){let e=10,s=2+this.random.nextInt(2);for(;this.count<s&&e;)this.tryAdd()||e--;return e?T:{ok:!1,fail:"addEdges"}}refine(){return T}addLateFeatures(){return T}inferScreens(){let e=super.inferScreens();if(!e.ok)return e;let s=e.value,i=this.findArena(s),n=this.main.meta;return s.set(i+15,this.orig.tileset.unreachableVariant(n.get(i+15))),s.set(i+16,this.orig.tileset.unreachableVariant(n.get(i+16))),s.set(i+17,this.orig.tileset.unreachableVariant(n.get(i+17))),e}finishInternal(){if(!this.meta)throw new Error("impossible");this.main.finish();let e=this.main.meta,s=this.findArena(this.meta);super.finishInternal(),e.setExit(s,"seamless:up",[this.meta.id<<8|s,"seamless:down"]),this.meta.freeFlags=new Set(e.freeFlags)}reportFailure(){throw new Error("Completely failed to shuffle Karmine Kensu map")}},$s=class extends v{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(){if(this.grid.height!==5||this.grid.width!==8)throw new Error("bad size");return Me.writeGrid2d(this.grid,0,$s.PATTERN),this.count=36,T}addSpikes(){let e=this.random.nextInt(4);for(let n=1;n<10;n++)for(let o=0;o<4;o++){let a=2*o+5+n*17;if(o===e)this.grid.data[a]="c";else{let l=this.grid.coord(a);this.fixed.add(l),n===5&&(this.fixed.add(l+8),this.fixed.add(l+16),this.fixed.add(l-8),this.fixed.add(l-16))}}let s=0;for(let n of this.random.ishuffle(this.grid.screens())){if(s===3)break;let o=n|2056,a=ae(o),l=ae(o,2),c=Q(o),d=Q(o,2),f=Ve(o),u=ke(o);if(this.grid.get(o)!=="c"||this.grid.get(a)==="s"||this.grid.get(l)==="s"||this.grid.get(c)==="s"||this.grid.get(d)==="s")continue;let h=[],p=[];for(let m of[c,f,u])this.grid.get(m)==="c"&&(this.grid.get(2*m-o)==="s"?p.push(m):h.push(m));if(!(p.length>1)&&!(!h.length&&!p.length)){for(;h.length+p.length>1&&!(h.length+p.length===2&&!h.includes(c)&&!p.includes(c));){let[m]=h.splice(this.random.nextInt(h.length),1);this.grid.set(m,"")}this.grid.set(a,""),this.fixed.add(o),this.grid.set(o,"<"),s++}}return new Set(this.grid.partition().values()).size===1}addStairs(){return T}},Bt=$s;Bt.PATTERN=["                 ","   ccccccccccc   ","   c c c c c c   "," ccc s s s s ccc "," c c s s s s c c "," ccccscscscscccc "," c c s s s s c c "," ccc s s s s ccc ","   c c c c c c   ","   ccccccccccc   ","                 "];function qi(r,t,e){let s=r.locations;ln(r,e);let i=new Xt(r,e);i.add(),i.shuffles.length||i.add(new v(s.EastCave1),new v(s.EastCave2),new v(s.EastCave3),...Jt(s.SealedCave1,s.SealedCave2),new v(s.SealedCave3),new v(s.SealedCave4),new v(s.SealedCave5),new v(s.SealedCave6),new v(s.SealedCave7),new v(s.SealedCave8),new v(s.WindmillCave),new v(s.ZebuCave),new os(s.Swamp),new v(s.MtSabreWest_Cave1),new v(s.MtSabreWest_Cave2),new v(s.MtSabreWest_Cave3),new v(s.MtSabreWest_Cave4),new v(s.MtSabreWest_Cave5),new v(s.MtSabreWest_Cave6),new rt(s.MtSabreWest_Cave7),new v(s.MtSabreNorth_Cave1),new v(s.MtSabreNorth_Cave2),new v(s.MtSabreNorth_Cave3),new v(s.MtSabreNorth_Cave4),new v(s.MtSabreNorth_Cave5),new v(s.MtSabreNorth_Cave6),new v(s.MtSabreNorth_Cave7),new v(s.MtSabreNorth_Cave8),new v(s.MtSabreNorth_Cave9),new v(s.MtSabreNorth_LeftCell2),new v(s.MtSabreNorth_SummitCave),new v(s.KirisaPlantCave1),new v(s.KirisaPlantCave2),new v(s.KirisaPlantCave3),new v(s.FogLampCave1),new v(s.FogLampCave2),new v(s.FogLampCave3),new Qt(s.FogLampCaveDeadEnd),...Jt(s.FogLampCave5,s.FogLampCave4,!0),...Jt(s.FogLampCave7,s.FogLampCave6),new rt(s.WaterfallCave1),new v(s.WaterfallCave2),new it(s.WaterfallCave3),new ss(s.WaterfallCave4),new ze(s.EvilSpiritIsland2).requirePitDestination(),new rt(s.EvilSpiritIsland3),new ze(s.EvilSpiritIsland4),new ts(s.SaberaPalace1).requirePitDestination(),new v(s.SaberaPalace2),new v(s.SaberaPalace2_West),new v(s.JoelSecretPassage),new v(s.MtHydra_Cave1),new v(s.MtHydra_Cave2),new v(s.MtHydra_Cave3),new v(s.MtHydra_Cave4),new v(s.MtHydra_Cave5),new v(s.MtHydra_Cave6),new it(s.MtHydra_Cave7),new v(s.MtHydra_Cave8),new v(s.MtHydra_Cave9),new v(s.MtHydra_Cave10),new it(s.Styx1).setUpEdgeType("c"),new rs(s.Styx2).requirePitDestination(),new v(s.Styx3),new ns(s.OasisCaveMain),new v(s.DesertCave1),new v(s.DesertCave2),new v(s.Pyramid_Branch),new ls(s.Pyramid_Main),new Zt(s.Crypt_Entrance),new it(s.Crypt_Hall1).setUpEdgeType("c"),new v(s.Crypt_DeadEndLeft),new v(s.Crypt_DeadEndRight),new v(s.Crypt_Branch),new v(s.Crypt_Hall2),new as(s.GoaFortress_Kelbesque),new ze(s.GoaFortress_Sabera),new v(s.GoaFortress_Mado1).requirePitDestination(),new v(s.GoaFortress_Mado2),new v(s.GoaFortress_Mado3),new v(s.GoaFortress_Karmine1),new v(s.GoaFortress_Karmine2),new v(s.GoaFortress_Karmine4),new Bt(s.GoaFortress_Karmine6),...$i(s.GoaFortress_Karmine3,s.GoaFortress_Karmine5,s.GoaFortress_Kensu),new is(s.OasisCave_Entrance)),i.shuffleAll(),console.log(String(i))}function ln(r,t=new st(1)){Gi(r),Oi(r),zi(r,t)}var gt=typeof __VERSION__=="object"?__VERSION__:{},qs=gt.STATUS||"unstable",Hi=gt.VERSION||"HEAD",Kl=gt.LABEL||"HEAD",Ui=gt.HASH||"HEAD",Vl=gt.DATE||new Date,Xl=gt.PREV||"";var Hs=class{constructor(t,e,s,i){this.filename=t,this.chrdata=Array.from(new Uint8Array(e)),this.palette=s,this.rendered=Array.from(new Uint8Array(i.data))}};async function Jl(r){let t=document.createElement("canvas");t.width=112,t.height=100;let e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.fillStyle="#155fd9",e.fillRect(0,0,t.width,t.height);let s=new ImageData(new Uint8ClampedArray(r.rendered),128,128),i=await createImageBitmap(s,{resizeQuality:"pixelated"});return e.drawImage(i,0,0,16,24,24,2,16*4,24*4),t.toDataURL("image/png")}async function cn(r,t){let e=r.byteLength/16,s=8,i=0,n=document.createElement("canvas");n.width=128,n.height=128;let a=n.getContext("2d").createImageData(128,128),l=new Uint8ClampedArray(r);for(let c=0;c<e;++c){let d=c*16,f=c%16*8,u=Math.floor(c/16)*8;for(let h=0;h<s;++h){let p=l[d+h],m=l[d+h+8];for(let b=0;b<s;++b){let S=7-b,g=p>>S&1,y=(m>>S&1)<<1,x=(g|y)+i*4,I=mn[t[x]],E=(f+b)*4+(u+h)*4*128;a.data[0+E]=I[0],a.data[1+E]=I[1],a.data[2+E]=I[2],a.data[3+E]=x==0?0:255}}}return a}var cs=class{constructor(t,e,s,i){this.name=t,this.converter=e,this.nssdata=s,this.description=i}static async init(t,e,s,i){let n=await s;return new cs(t,e,n,i)}static applyPatch(t,e,s){if(!cs.isCustom(t))return;let i=s?262144:0;for(let[n,o]of nt.getChr(t.converter))for(let a of o)for(let l=0;l<16;++l)e[a+l+i]=t.nssdata.chrdata[n*16+l];for(let[n,o]of nt.getPalette(t.converter))for(let a of o)switch(n){case"color0":e[a]=t.nssdata.palette[0];break;case"color1":e[a]=t.nssdata.palette[1];break;case"color2":e[a]=t.nssdata.palette[2];break;case"color3":e[a]=t.nssdata.palette[3];break;case"metasprite":e[a+i]=0;break}}},Xe=cs;Xe.isCustom=t=>t.name!="Simea";var ds=class{constructor(){this.mapping=new Map;this.mapping.set("simea",new Map([["Simea",Xe.init("Simea","simea",ji("Simea.nss"),"The original main character of Crystalis")],["Mesia",Xe.init("Mesia","simea",ji("Mesia.nss"),"Secondary protagonist Mesia takes the spotlight! Artwork by jroweboy")]]))}static get(t){return this.instance||(this.instance=new ds),this.instance.mapping.get(t)}},nt=class{constructor(){this.chrMapping=new Map;this.paletteMapping=new Map;this.simeaChrMapping=this.generateSimeaMapping(),this.simeaPaletteMapping=this.generateSimeaPalette(),this.chrMapping.set("simea",this.simeaChrMapping),this.paletteMapping.set("simea",this.simeaPaletteMapping)}static getChr(t){return this.instance||(this.instance=new nt),this.instance.chrMapping.get(t)}static getPalette(t){return this.instance||(this.instance=new nt),this.instance.paletteMapping.get(t)}generateSimeaPalette(){let t=new Map,e=27888+16;return t.set("color0",[e+0]),t.set("color1",[e+1]),t.set("color2",[e+2]),t.set("color3",[e+3]),t.set("metasprite",[245844+16]),t}generateSimeaMapping(){let t=new Map;t.set(0,[C(8,0,26)]),t.set(1,[C(8,0,27)]),t.set(16,[C(8,0,0)]),t.set(17,[C(8,0,1)]),t.set(32,[C(8,0,32)]),t.set(33,[C(8,0,33)]),t.set(2,[C(8,0,28)]),t.set(3,[C(8,0,29)]),t.set(18,[C(8,0,2)]),t.set(19,[C(8,0,3)]),t.set(20,[C(8,0,4)]),t.set(21,[C(8,0,5)]),t.set(34,[C(8,0,34)]),t.set(35,[C(8,0,35)]),t.set(36,[C(8,0,36)]),t.set(37,[C(8,0,37)]),t.set(6,[C(8,0,30)]),t.set(7,[C(8,0,31)]),t.set(22,[C(8,0,6)]),t.set(23,[C(8,0,7)]),t.set(38,[C(8,0,38)]),t.set(39,[C(8,0,39)]),t.set(64,[C(8,0,20)]),t.set(65,[C(8,0,21)]),t.set(80,[C(8,0,52)]),t.set(81,[C(8,0,53)]),t.set(50,[C(8,0,60)]),t.set(51,[C(8,0,61)]),t.set(66,[C(8,0,24)]),t.set(67,[C(8,0,25)]),t.set(82,[C(8,0,56)]),t.set(68,[C(8,0,22)]),t.set(69,[C(8,0,23)]),t.set(84,[C(8,0,54)]),t.set(112,[C(8,0,14)]),t.set(113,[C(8,0,15)]),t.set(128,[C(8,0,46)]),t.set(129,[C(8,0,47)]),t.set(114,[C(8,0,18)]),t.set(115,[C(8,0,19)]),t.set(130,[C(8,0,48)]),t.set(131,[C(8,0,51)]),t.set(116,[C(8,0,16)]),t.set(117,[C(8,0,17)]),t.set(133,[C(8,0,49)]),t.set(160,[C(8,0,8)]),t.set(161,[C(8,0,9)]),t.set(176,[C(8,0,40)]),t.set(146,[C(8,0,58)]),t.set(147,[C(8,0,59)]),t.set(162,[C(8,0,12)]),t.set(163,[C(8,0,13)]),t.set(178,[C(8,0,44)]),t.set(179,[C(8,0,45)]),t.set(164,[C(8,0,10)]),t.set(165,[C(8,0,11)]),t.set(181,[C(8,0,43)]);let e=new Map(t);for(let[s,i]of e){let n=s+gi,o=i.map(a=>a+bi);t.set(n,o)}return t.set(192,[C(11,1,0)]),t.set(193,[C(11,1,1)]),t.set(208,[C(11,1,2)]),t.set(209,[C(11,1,3)]),t.set(224,[C(11,1,4)]),t.set(225,[C(11,1,5)]),t.set(194,[C(11,1,36)]),t.set(195,[C(11,1,37)]),t.set(210,[C(11,1,6)]),t.set(211,[C(11,1,7)]),t.set(226,[C(11,1,38)]),t.set(227,[C(11,1,39)]),t.set(196,[C(11,1,32)]),t.set(197,[C(11,1,33)]),t.set(212,[C(11,1,34)]),t.set(213,[C(11,1,35)]),t.set(214,[C(11,1,20)]),t.set(215,[C(11,1,21)]),t.set(230,[C(11,1,22)]),t.set(231,[C(11,1,23)]),t.set(54,[C(11,1,12)]),t.set(55,[C(11,1,13)]),t.set(70,[C(11,1,50)]),t.set(71,[C(11,1,51)]),t.set(86,[C(11,1,46)]),t.set(87,[C(11,1,47)]),t.set(102,[C(11,1,18)]),t.set(103,[C(11,1,19)]),t.set(118,[C(11,1,8)]),t.set(119,[C(11,1,9)]),t.set(134,[C(11,1,40)]),t.set(135,[C(11,1,41)]),t.set(150,[C(11,1,44)]),t.set(151,[C(11,1,45)]),t.set(166,[C(11,1,10)]),t.set(167,[C(11,1,11)]),t.set(182,[C(11,1,42)]),t.set(183,[C(11,1,43)]),t.set(240,oe(16)),t.set(241,oe(17)),t.set(242,oe(18)),t.set(243,oe(19)),t.set(244,oe(20)),t.set(245,oe(21)),t.set(246,oe(22)),t.set(247,oe(23)),t.set(248,[C(8,1,237)]),t.set(249,oe(25)),t.set(250,oe(26)),t.set(252,oe(48)),t.set(253,oe(49)),t.set(254,oe(50)),t.set(255,oe(51)),t}};async function ji(r){let t=vi()[r],e=r.replace(/^.*[\\\/]/,"");return un(e,t)}function Ki(r){let t="",e="",s=0;for(;s<r.length;)if(r[s]==="["){++s;let i=r.indexOf("]",s),n=parseInt(r.slice(s,i),16)-1;t+=e.repeat(n),s=i+1}else e=r.slice(s,s+2),t+=e,s+=2;return t}function Vi(r,t){return r.match(new RegExp(".{1,"+t+"}","g"))||[]}function fn(r){let t=Vi(r,2).map(e=>parseInt(e,16));return new Uint8Array(t)}function hn(r){return r.map(t=>parseInt(t,16))}async function un(r,t){let e=new Map(t.split(`
`).filter(a=>a.includes("=")).map(a=>a.split("=")).map(a=>[a[0],a[1]])),s=e.get("Palette")||"",i=hn(Vi(Ki(s).slice(0,32),2)),n=fn(Ki(e.get("CHRMain")||"")),o=await cn(new Uint8ClampedArray(n),i);return new Hs(r,n,i,o)}var mn=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]];function Ks(r,t,e){return new Us(t,e).smudge(r)}var Xi;(t=>{function r(e,s=Mt.P02){return i=>Promise.resolve(Ks(i,s,e))}t.forKnownPrg=r})(Xi||(Xi={}));function*pn(r){let t=0;for(;t<r.length;){let e=r.indexOf(`
`,t)+1||r.length;yield r.substring(t,e),t=e}}var Us=class{constructor(t,e){this.cpu=t;this.prg=e}smudge(t){let e="";for(let s of pn(t))e+=this.smudgeLine(s);return e}smudgeLine(t){let e=/^([^;]*?)<@([0-9a-f]+)(?: (.*?))?@>(.*\n?)$/i.exec(t);if(e){let[,i,n,o,a]=e,l=parseInt(n,16),c=xn(this.cpu,this.prg,l,o);return i+c+a}let s="";for(;;){let i=/^([^;]*?)\[@([0-9a-f]+)(:[0-9]+|:[wdb])?@\](.*\n?)/i.exec(t);if(!i){s+=t;break}let[,n,o,a,l]=i;t=l,s+=n;let c=parseInt(o,16);s+=gn(this.prg,c,a)}return s}};function xn(r,t,e,s){let i=s,[n,o]=r.disasm(t[e])||["brk","imp"],a=r.argLen(o);return i||(a>0&&(i=t[e+1]),a>1&&(i=i|t[e+2]<<8)),n+(a?" "+r.format(o,i):"")}function gn(r,t,e){let s=r[t];if(e===":w")return s|=r[t+1]<<8,`($${Yi(s,4)})`;if(/:\d+/.test(e)){let i=parseInt(e.substring(1)),n='"';for(let o=0;o<i;o++){let a=String.fromCharCode(r[t+o]);'"\\'.includes(a)&&(a="\\"+a),n+=a}return n+='"',n}else return e===":d"?String(s):e===":b"?`%${s.toString(2).padStart(8,"0")}`:`$${Yi(s,2)}`}var js=class{constructor(t){this.plain=t}fix(t,e,s){}format(t,e){return this.plain}},ot=class extends js{constructor(e){super("");this.fix=e}static set(e){return new ot(s=>s.set(e))}},bt=ot;bt.push=new ot(e=>e.push()),bt.alt=new ot(e=>e.alt()),bt.pop=new ot(e=>e.pop()),bt.merge=new ot(e=>e.merge());function Yi(r,t=2){return r.toString(16).padStart(t,"0")}var pe={of:(...r)=>{let t=0n;for(let e of r)t|=1n<<BigInt(e);return t},from:r=>{let t=0n;for(let e of r)t|=1n<<BigInt(e);return t},containsAll:(r,t)=>!(t&~r),with:(r,t)=>r|1n<<BigInt(t),without:(r,t)=>r&~(1n<<BigInt(t)),has:(r,t)=>!!(r&1n<<BigInt(t)),bits:r=>{let t=[],e=0;for(;r;){let s=Number(r&0xffffffffn),i=32;for(;s;){let n=Math.clz32(s)+1;i-=n,s<<=n,n===32&&(s=0),t.push(e|i)}r>>=32n,e+=32}return t},clone:r=>r,empty:r=>!r,difference:(r,t)=>r&~t};var fs=class{constructor(t){this.worlds=t;this.lastFailure="";let e=new Set,s=new Set,i=new Map,n=new Map;for(let f=0;f<t.length;f++){let u=t[f],h=f<<24;for(let[p,m]of u.requirements){e.add(h|p);for(let b of m)for(let S of b)s.add(h|S)}for(let[p,m]of u.items)n.set(h|p,m);for(let[p,m]of u.slots)i.set(h|p,m)}this.itemInfos=new Map(n),this.slotInfos=new Map(i),this.progression=new Set(s);for(let f of n.keys())s.add(f);let o=new Set,a=new Set,l=new Set;for(let f of s)(e.has(f)?o:l).add(f);for(let f of e)s.has(f)||a.add(f);this.common=o.size,this.slots=new Rs([...o,...a]),this.items=new Rs([...o,...l]);let c=[],d=[];for(let f=0;f<t.length;f++){let u=f<<24;for(let[h,p]of t[f].requirements){let m=this.slots.index(u|h);if(m==null)throw new Error(`Provided a non-slot? ${V(h)}`);for(let b of p){let S=[...b].map(g=>this.items.index(u|g)??Re());(c[m]||(c[m]=[])).push(pe.from(S));for(let g of S)(d[g]||(d[g]=new Set)).add(m)}}}for(let f=0;f<this.slots.length;f++)if(!c[f]||!c[f].length){let u=this.slots.get(f)??NaN,h=this.checkName(u);console.error(`Nothing provided $${V(u)}: ${h} (index ${f})`)}this.graph=new Es(c),this.unlocks=new Es(d.map($t))}async shuffle(t,e,s=200,i,n){i&&i.addTasks(Math.floor(s/10));for(let o=0;o<s;o++){this.lastFailure="",i&&o%10===9&&(i.addCompleted(1),await new Promise(requestAnimationFrame));let a=new Ts;this.prefill(a,e);let l=this.compressFill(a),c=this.itemPool(l.values(),e),d=pe.from(new Set(c)),f=Math.floor(o/5);if(!this.fillInternal(l,c,d,e,t,f))continue;let u=n?[]:void 0,h=this.traverse(m=>l.get(m),pe.of(),u);if(h.size!==this.slots.length){let m=y=>`${String(y).padStart(3)} ${this.slots.get(y).toString(16).padStart(3,"0")} ${this.checkName(this.slots.get(y))}`,b=y=>`${String(y).padStart(3)} ${this.items.get(y).toString(16).padStart(3,"0")} ${this.checkName(this.items.get(y))}`,S=new Set([...this.slots].map(y=>y[0]));for(let y of h)S.delete(y);let g=new Map;for(let y of S)g.set(m(y),this.graph.get(y).map(x=>`
    `+pe.bits(x).map(b).join(" & ")).join(""));console.error(`Initial fill never reached slots:
  ${[...g.keys()].sort().map(y=>y+g.get(y)).join(`
  `)}`),this.lastFailure="unreachable slots?";continue}this.expandFill(l,a);let p=this.fillNonProgression(a,t,e);if(p!=null){if(i&&i.addCompleted(Math.floor((s-o)/100)),n){for(let[m,b]of a){let S=this.checkName(m).replace(/^[0-9a-f]{3} /,"");n.addSlot(m,S,b)}if(u)for(let[m,...b]of u)(m<this.common||l.has(m))&&n.addCheck(this.slots.get(m),b.map(S=>this.items.get(S)))}return p}}throw new Error(`Shuffle failed: ${this.lastFailure||"unknown error"}`)}fillInternal(t,e,s,i,n,o){let a=new Set(t.keys());for(let l=e.pop();l!=null;l=e.pop()){if(!pe.has(s,l))continue;let c=this.itemInfoFromIndex(l);s=pe.without(s,l);let d=this.expandReachable(this.traverse(h=>t.get(h),s),n);i.shuffle(d);let f=!1,u=new Set(t.keys());for(let h of d){if(u.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!(!p||!this.fits(p,c,n))){t.set(h,l),f=!0;break}}if(!f){if(u.clear(),o-- >0){for(let h of d){if(u.has(h)||!t.has(h)||a.has(h))continue;u.add(h);let p=this.slotInfoFromIndex(h);if(!p||!this.fits(p,c,n))continue;let m=t.replace(h,l)??Re();s=pe.with(s,m),e.push(m),i.shuffle(e),f=!0;break}if(f)continue}return this.lastFailure=`could not place ${this.checkName(this.items.get(l))}, ${e.filter(h=>pe.has(s,h)).length} remaining`,!1}}return!0}expandReachable(t,e){let s=[];for(let i of t){let n=this.slotInfoFromIndex(i);n?.broken||!n||e.preserveUniqueChecks()&&!n.unique||Zi(s,i,n.weight||1)}return s}itemPool(t,e){let s=new Set(t),i=[];for(let[n,o]of this.itemInfos){let a=this.items.index(n);a!=null&&(!this.progression.has(n)||s.has(a)||Zi(i,a,o.weight||1))}return e.shuffle(i)}fits(t,e,s){if(s.preserveUniqueChecks()&&e.unique&&!t.unique)return!1;let i=e.preventLoss||t.preventLoss;return!(t.lossy&&e.losable&&i)}fillNonProgression(t,e,s){let i=[[],[],[]],n=[[],[]];for(let[c,d]of this.itemInfos){if(t.hasValue(c))continue;let f=2;d.losable&&d.preventLoss&&(f=1),e.preserveUniqueChecks()&&d.unique&&(f=0),i[f].push(c)}for(let[c,d]of this.slotInfos){if(t.has(c))continue;let f=d.lossy&&d.preventLoss?0:1;n[f].push(c)}for(let c of[...i,...n])s.shuffle(c);let o=c=>this.checkName(c),a=se.count(se.concat(...n)),l=se.count(se.concat(...i));if(l>a)throw console.log(`Slots ${a}:
  ${[...se.concat(...n)].map(o).join(`
  `)}`),console.log(`Items ${l}:
  ${[...se.concat(...i)].map(o).join(`
  `)}`),new Error("Too many items");for(let c of se.concat(...i)){let d=!1;for(let f of[...n]){if(d)break;for(let u=0;u<f.length;u++)if(this.fits(this.slotInfos.get(f[u]),this.itemInfos.get(c),e)){t.set(f[u],c),d=!0,f.splice(u,1);break}}if(!d)return console.log(`Slots:
  ${[...se.concat(...n)].map(o).join(`
  `)}`),console.error(`REROLL: Could not place item ${o(c)}`),this.lastFailure=`could not place non-progression ${o(c)}`,null}return new Map(t)}traverse(t,e,s){e=pe.clone(e);let i=new Set,n=new Set;for(let o=0;o<this.slots.length;o++){if(this.graph.get(o)==null){console.dir(this);let a=this.slots.get(o);throw new Error(`Unreachable slot ${a?.toString(16)}`)}n.add(o)}for(let o of n){if(n.delete(o),i.has(o))continue;let a=this.graph.get(o);if(a==null)throw new Error(`Not in graph: ${o}`);for(let l=0,c=a.length;l<c;l++){if(!pe.containsAll(e,a[l]))continue;s&&s.push([o,...pe.bits(a[l])]),i.add(o);let d=[];o<this.common&&d.push(o);let f=t(o);f!=null&&d.push(f);for(let u of d){e=pe.with(e,u);for(let h of this.unlocks.get(u)||[]){if(this.graph.get(h)==null)throw console.dir(this),new Error(`Adding bad node ${h} from unlock ${u}`);n.add(h)}}break}}return i}expandFill(t,e){for(let[s,i]of t){let n=this.slots.get(s),o=this.items.get(i);if(n==null||o==null)throw new Error("missing");e.replace(n,o)}}compressFill(t){let e=new Ts;for(let[s,i]of t){let n=this.slots.index(s),o=this.items.index(i);if(n==null||o==null)throw new Error(`Bad slot/item: ${s} ${n} ${i} ${o}`);e.set(n,o)}return e}checkName(t){return this.worlds[t>>>24].checkName(t&16777215)}prefill(t,e){for(let s=0;s<this.worlds.length;s++){let i=s<<24,n=this.worlds[s].prefill(e);for(let[o,a]of n)t.set(i|o,i|a)}}itemInfoFromIndex(t){let e=this.items.get(t);if(e==null)throw new Error(`Bad item: ${t}`);return this.itemInfoFromId(e)}itemInfoFromId(t){let e=this.itemInfos.get(t);if(e==null)throw new Error(`Missing info: ${V(t)}`);return e}slotInfoFromIndex(t){let e=this.slots.get(t);if(e==null)throw new Error(`Bad slot: ${t}`);return this.slotInfoFromId(e)}slotInfoFromId(t){let e=this.slotInfos.get(t);if(e!=null)return e}};function Zi(r,t,e){for(let s=0;s<e;s++)r.push(t)}var hs=class{constructor(t,e,s,i=1){this.rom=t;this._width=s,this._height=e,this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.element.appendChild(this.canvas),this.canvas.width=s,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")||Re(),this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.palettes=new Uint32Array(1024),this.layers=te(i,()=>new Uint32Array(s*e)),this.data=this.layers[0];for(let n=0;n<256;n++)for(let o=0;o<4;o++){let a=bn[t.palettes[n].color(o)];this.palettes[n<<2|o]=a|4278190080}}useLayer(t){this.data=this.layers[t]||Re(`Bad layer: ${t}`)}resizeWidth(t,e){let s=new Uint32Array(e*this._height),i=Math.min(e,this._width);for(let n=0;n<this._height;n++)s.subarray(n*e,n+e+i).set(t.subarray(n*this._width,n*this._width+i));return s}resizeHeight(t,e){let s=new Uint32Array(this._width*e),i=this._width*Math.min(e,this._height);return s.subarray(0,i).set(t.subarray(0,i)),s}get width(){return this._width}set width(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeWidth(this.layers[e],t);this._width=t,this.canvas.width=t}get height(){return this._height}set height(t){for(let e=0;e<this.layers.length;e++)this.layers[e]=this.resizeHeight(this.layers[e],t);this._height=t,this.canvas.height=t}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(t){this.data.fill(t)}clear(t){let e=t!=null?this.palettes[t<<2]:0;this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.layers[0].fill(e);for(let s=1;s<this.layers.length;s++)this.layers[s].fill(0)}toDataUrl(t=!1){return this.canvas.toDataURL("image/png")}render(){let t=this.canvas,e=this.ctx;for(let s=0;s<this.layers.length;s++){s&&(t=document.createElement("canvas"),t.width=this.canvas.width,t.height=this.canvas.height,e=t.getContext("2d")||Re());let i=new Uint8Array(this.layers[s].buffer),n=e.getImageData(0,0,this._width,this._height);n.data.set(i),e.putImageData(n,0,0),s&&this.ctx.drawImage(t,0,0)}}rect(t,e,s,i,n){let o=Math.max(0,t),a=Math.max(0,e),l=Math.min(this._height,t+s),c=Math.min(this._width,e+i);for(t=o;t<l;t++)for(e=a;e<c;e++)this.data[t*this._width+e]=n}tile(t,e,s,i){if(e<0||t<0||e+8>=this._width||t+8>=this._height)return;let n=this.rom.patterns.get(s).flip(i<<6);for(let o=0;o<8;o++){let a=n.pixels[8|o]<<1,l=n.pixels[o];for(let c=7;c>=0;c--){let d=a&2|l&1;a>>>=1,l>>>=1,d&&(this.data[(t+o)*this._width+e+c]=this.palettes[i&1020|d])}}this._minX=Math.min(this._minX,e),this._maxX=Math.max(this._maxX,e+8),this._minY=Math.min(this._minY,t),this._maxY=Math.max(this._maxY,t+8)}metatile(t,e,s,i,n=0){let o=this.rom.locations[i],a=[...o.tilePatterns];o.animation&&(a[1]=this.rom.tileAnimations[o.animation].pages[n&7]);let l=[...o.tilePalettes,127],c=this.rom.tilesets[o.tileset],d=l[c.attrs[s]];for(let f=0;f<2;f++)for(let u=0;u<2;u++){let h=c.tiles[f<<1|u][s],p=a[h&128?1:0]<<6|h&127,m=e+(u<<3),b=t+(f<<3);this.tile(b,m,p,d<<2)}}metasprite(t,e,s,i,n=0,o=0){let a=this.rom.locations[i],l=this.rom.metasprites[s],c=[64,66,...a.spritePatterns],d=[0,1,...a.spritePalettes],f=!1;if(l.mirrored!=null&&(l=this.rom.metasprites[l.mirrored],f=!0),!l||!l.used)return;let u=o&l.frameMask;for(let[h,p,m,b]of l.sprites[u]){if(h==128)break;h=Ji(h),p=Ji(p),b=b+n&255;let S=c[b>>6],g=d[m&3]+176&255,y=S<<6|b&63;f&&(h=-8-h,m^=64),this.tile(t+p,e+h,y,g<<2|m>>6)}}text(t,e,s,i=18){for(let n=0;n<s.length;n++)this.tile(t,e+8*n,s.charCodeAt(n)|3840,i<<2)}},bn=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];function Ji(r){return r<128?r:r-256}function W(r){return r}(e=>{function r({id:s},{x:i,y:n}){let o=i>>>8,a=i>>>4&15,l=n>>>8,c=n>>>4&15;return s<<16|l<<12|o<<8|c<<4|a}e.from=r;function t(s,i,n){let o=s;if(i){let a=(o&240)+(i<<4);for(;a>=240;){if((o&61440)>=61440)return-1;a-=240,o+=4096}for(;a<0;){if(!(o&61440))return-1;a+=240,o-=4096}o=o&-241|a}if(n){let a=(o&15)+n;for(;a>=16;){if((o&3840)>=1792)return-1;a-=16,o+=256}for(;a<0;){if(!(o&3840))return-1;a+=16,o-=256}o=o&-16|a}return o}e.add=t})(W||(W={}));var Qi=Symbol("[LocationMap data]"),Ye=class extends hs{constructor(e,s=0){super(e,1,1,4);this.rom=e;this.flags=new Set;this._maxWidth=1/0;let i=e.locations[s];this.width=(i.used?i.width:1)*256,this.height=(i.used?i.height:1)*240,this.location=i;let n=o=>{let a=o.offsetX,l=o.offsetY,c=o.target;for(;c&&c!==this.element;)c=c.parentElement;if(!c)return;let d=a>>8,f=Math.floor(l/240),u=a-256*d>>4,h=l-240*f>>4,m=this.location.id<<16|f<<12|d<<8|h<<4|u;Ye.setData(o,{tile:m,target:this})};this.element.addEventListener("mousemove",n),this.element.addEventListener("mousedown",n),this.element.addEventListener("mouseup",n),this.element.addEventListener("click",n),this.redraw()}static getData(e){return e[Qi]}static setData(e,s){e[Qi]=s}get id(){return this.location.id}set id(e){this.location=this.rom.locations[e],this.height=(this.location.used?this.location.height:1)*240,this.width=(this.location.used?this.location.width:1)*256,this.ensureWidth(),this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=e,this.ensureWidth()}ensureWidth(){if(this.width<=this._maxWidth){this.element.style.transform="",this.element.style.width="",this.element.style.height="";return}let e=this._maxWidth/this.width,s=(1-e)*50;this.element.style.transform=`translate(-${s}%,-${s}%) scale(${e})`,this.element.style.width=`${this.width*e}px`,this.element.style.height=`${this.height*e}px`}clearOverlay(){this.useLayer(1),this.fill(0),this.useLayer(3),this.fill(0),this.render()}overlayShade(e){this.useLayer(3),this.fill(e)}overlayArea(e,s,i){for(let n of e){if(n>>>16!==this.location.id)continue;let o=n>>>12&15,a=n>>>8&15,l=n>>>4&15,c=n&15,d=240*o+16*l,f=256*a+16*c;i!=null&&(this.useLayer(3),this.rect(d-1,f-1,18,18,0)),this.useLayer(1),e.has(W.add(n,-1,0))||this.rect(d-1,f-1,2,18,s),e.has(W.add(n,0,-1))||this.rect(d-1,f-1,18,2,s),e.has(W.add(n,1,0))||this.rect(d+15,f-1,2,18,s),e.has(W.add(n,0,1))||this.rect(d-1,f+15,18,2,s)}}redraw(){this.useLayer(0),this.clear(this.location.tilePalettes[0]);for(let e=0;e<this.location.height;e++)for(let s=0;s<this.location.width;s++){let i=this.location.screens[e][s];this.drawScreen(this.rom.screens[i],e,s)}this.useLayer(2);for(let e of this.location.spawns){let s=0,{x:i,y:n}=e;n-=e.yt&240;let o,a=0;if(e.isNpc()){let l=this.rom.npcs[e.id];if(!l||!l.data)continue;i+=8,n+=12,o=(a>>5)+2&3|l.data[3]}else if(e.isChest())o=170;else if(e.isMonster()){let l=this.rom.objects[e.monsterId];if(!l)continue;o=l.metasprite,l.action==41?o=a&32?107:104:[42,94].includes(l.action)&&(o=(a>>5)+2&3|l.data[31])}e.patternBank&&(s+=64),o!=null&&this.metasprite(n,i,o,this.location.id,s)}this.render()}drawScreen(e,s,i){let n=s*240,o=i*256,a=this.rom.tilesets[this.location.tileset],l,c=!1;for(let d of this.location.flags)if(d.xs===i&&d.ys===s){l=d.flag,this.rom.flags[l]?.logic.assumeTrue&&(c=!0);break}for(let d=0;d<240;d+=16)for(let f=0;f<16;f++){let u=e.tiles[d|f];u<32&&(this.flags.has(l)||c)&&(u=a.alternates[u]),this.metatile(n+d,o+f*16,u,this.location.id,0)}}};var G;(d=>{function r(...f){return[[].concat(...f.map(([u])=>u))]}d.and=r;function t(...f){let u=[];for(let h of f){if(h===d.OPEN)return d.OPEN;h!==d.CLOSED&&u.push(...s(h))}return u.length?u:d.CLOSED}d.or=t;function e(f,u){if(f===d.OPEN)return s(u);if(u===d.OPEN)return s(f);if(f===d.CLOSED||u===d.CLOSED)return d.CLOSED;let h=new c;for(let p of f)for(let m of u)h.addList([...p,...m]);return s(h)}d.meet=e;function s(f){return f instanceof c?[...se.map(f,u=>[...u])]:f}d.freeze=s;function i(f){return f instanceof c?f.label():f.map(u=>u.join("&")).join("|")}d.label=i;function n(f){let u=f[Symbol.iterator](),{value:h,done:p}=u.next();if(p||!u.next().done)return!1;let m=h[Symbol.iterator]();return Boolean(m.next().done)}d.isOpen=n;function o(f){let u=f[Symbol.iterator]();return Boolean(u.next().done)}d.isClosed=o,d.OPEN=[[]],d.CLOSED=[];class c{constructor(u){this.self=u;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(u,h){for(let p of h)if(Array.isArray(p))throw new Error;if(h.has(this.self)||this.map.has(u))return!1;for(let[p,m]of this.map){if(er(h,m))return!1;er(m,h)&&this.map.delete(p)}return this.map.set(u,h),!0}addRoute(u){return this.addInternal(u[us],u.deps)}addAll(u){for(let h of u)this.addList(h)}addList(u){let h=[...new Set(u)].sort(),p=new Set(h);this.addInternal(h.join("&"),p)}restrict(u){let h=[...this.map.values()];this.map.clear();for(let p of h)for(let m of u)this.addList([...p,...m])}label(){return[this.map.keys()].join("|")}}d.Builder=c})(G||(G={}));function er(r,t){if(r.size<t.size)return!1;for(let e of t)if(!r.has(e))return!1;return!0}var us=Symbol("depsLabel"),Fe=class{constructor(t,e){this.target=t;let s=[...new Set(e)].sort();this.deps=new Set(s),this[us]=s.join("&"),this.label=`${this.target}:${this[us]}`}};us;var ms=class{constructor(t){this.rom=t;this.tiles=new _(t=>wn(this.rom,t));this.bosses=new _(t=>new Xs(t));this.statues=new Map;this.flags=new _(t=>new _(e=>new _(s=>new Js(t,e,s))));this.meets=new _(t=>new _(e=>new Qs(t,e)));this._seamless=new _(t=>new Vs(t))}tile(t){return t&4?void 0:this.tiles.get(t)}boss(t,e){return e?this.rage||(this.rage=new Zs(t,this.rom.flags.RageSkip.id)):this.bosses.get(t)}statue(t){let e=G.label(t),s=this.statues.get(e);return s||this.statues.set(e,s=new Ys(t)),s}flag(t,e,s){return t||(t=yn),this.flags.get(t).get(e).get(s)}meet(t,e){return this.meets.get(t).get(e)}seamless(t){return this._seamless.get(t)}label(t,e){return t.label?t.label(e):"Terrain"}},O;(f=>{f.FLY=2,f.BLOCKED=4,f.SLOPE=32,f.PAIN=128,f.BITS=166,f.SWAMP=256,f.BARRIER=512,f.SLOPE8=1024,f.SLOPE9=2048,f.DOLPHIN=4096;function d(u,h){return u.label?.(h)??"Terrain"}f.label=d})(O||(O={}));var Vs=class{constructor(t){this._delegate=t;this.enter=t.enter,this.exit=t.exit}label(t){return`Seamless(${O.label(this._delegate,t)})`}},at=class{constructor(t,e=G.OPEN){this.enter=t;this.exit=[[15,e]]}get kind(){return"Simple"}label(t){let e=[];return G.isOpen(this.enter)||e.push(`enter = ${ye(this.enter,t)}`),G.isOpen(this.exit[0][1])||e.push(`exit = ${ye(this.exit[0][1],t)}`),`${this.kind}(${e.join(", ")})`}},ps=class{constructor(t,e,s=4){this.enter=t;this.exit=e?[[15&~s,e],[s,G.OPEN]]:[[15,G.OPEN]]}get kind(){return"South"}label(t){if(this.exit.length===1)return at.prototype.label.call(this,t);let e=[];return G.isOpen(this.enter)||e.push(`enter = ${ye(this.enter,t)}`),G.isOpen(this.exit[0][1])||e.push(`other = ${ye(this.exit[0][1],t)}`),G.isOpen(this.exit[1][1])||e.push(`south = ${ye(this.exit[1][1],t)}`),`${this.kind}(${e.join(", ")})`}};function wn(r,t){let e=G.OPEN,s,i=4;return t&O.DOLPHIN&&t&O.FLY?(t&O.SLOPE&&(s=r.flags.ClimbWaterfall.r),e=[[r.flags.CurrentlyRidingDolphin.c],[r.flags.Flight.c]]):(t&O.SLOPE9?s=r.flags.ClimbSlope9.r:t&O.SLOPE8?s=r.flags.ClimbSlope8.r:t&O.SLOPE&&(s=r.flags.ClimbSlope10.r),t&O.FLY&&(e=r.flags.Flight.r)),t&O.SWAMP&&(e=e.map(n=>[r.flags.TravelSwamp.c,...n])),t&O.PAIN&&(e=e.map(n=>[r.flags.CrossPain.c,...n])),t&O.BARRIER&&(e=e.map(n=>[r.flags.ShootingStatue.c,...n]),s=r.flags.ShootingStatueSouth.r,i=1),new ps(e,s,i)}var Xs=class extends at{constructor(e){super(G.OPEN,[[e]]);this._flag=e}get kind(){return"Boss"}},Ys=class extends ps{constructor(e){super(G.OPEN,e);this._req=e}get kind(){return"Statue"}},Zs=class{constructor(t,e){this._rageFlag=t;this._rageSkipFlag=e;this.enter=G.OPEN;this.exit=[[11,[[t],[e]]],[4,G.OPEN]]}label(){return"Rage"}},Js=class extends at{constructor(t,e,s){if(t.exit.length!==1||s.exit.length!==1)throw console.error(t,s),new Error("bad flag");let i=[[e]],n=e>=0?G.meet(s.enter,i):s.enter,o=e>=0?G.meet(s.exit[0][1],i):s.exit[0][1];super(G.or(t.enter,n),G.or(t.exit[0][1],o))}get kind(){return"Flag"}},yn=new at(G.CLOSED,G.CLOSED);function tr(r){let t=[];for(let e=0;e<r.exit.length;e++)for(let s=0;s<4;s++)r.exit[e][0]&1<<s&&(t[s]=e);for(let e=0;e<4;e++)if(t[e]==null)throw new Error(`Bad terrain: ${r.exit.map(s=>s[0]).join(",")}`);return t}var Qs=class{constructor(t,e){this.left=t;this.right=e;let s=tr(t),i=tr(e),n=new Set,o=[];for(let a=0;a<4;a++)n.add(s[a]<<2|i[a]);for(let a of n){let[l,c]=t.exit[a>>2],[d,f]=e.exit[a&3];o.push([l&d,G.meet(c,f)])}this.enter=G.meet(t.enter,e.enter),this.exit=o}get kind(){return"Terrain"}label(t){if(this.exit.length===1)return at.prototype.label.call(this,t);let e=[];G.isOpen(this.enter)||e.push(`enter = ${ye(this.enter,t)}`);for(let[s,i]of this.exit){let n=[s&1?"N":"",s&2?"W":"",s&4?"S":"",s&8?"E":""].join("");e.push(`exit${n} = ${ye(i,t)}`)}return`${this.kind}(${e.join(", ")})`}};function ye(r,t){let e=[...r],s=e.map(i=>se.isEmpty(i)?"open":[...i].map(n=>t.flags[n]?.debug).join(" & ")).join(") | (");return e.length>1?`(${s})`:e.length?s:"never"}O.debugLabel=ye;typeof window=="object"&&(window.debugLabel=ye);var xs=class{constructor(t,e){this.rom=t;this.world=e;this.element=document.createElement("div"),this.element.addEventListener("click",s=>this.click(s)),this.element.addEventListener("mousemove",s=>this.move(s)),this.renderArea(0)}click(t){let e=Ye.getData(t);if(!e)return;let s=this.world.tiles.get(e.tile);if(s!=null){if(s.area===this.area){let i=s.exit!=null?this.world.tiles.get(s.exit):null;i&&i.area!==this.area&&(s=i)}s.area&&s.area!==this.area&&this.renderArea(s.area.id)}}move(t){let e=Ye.getData(t);if(!e)return;let s=this.world.tiles.get(e.tile);if(s==null)return;let i=s.exit!=null&&!this.area.tiles.has(s.exit);e.target.element.style.cursor=i?"pointer":"default"}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(t){this.clear();let e=document.createElement("select");e.appendChild(document.createElement("option")),e.children[0].textContent="Select location";for(let i of this.rom.locations){if(!i.used)continue;let n=this.world.locations[i.id]?.areas[Symbol.iterator]().next().value;if(n==null)continue;let o=document.createElement("option");o.textContent=`${V(i.id)} ${i.name}`,o.value=String(n.id),e.appendChild(o)}e.addEventListener("change",()=>{this.renderArea(Number(e.value))}),this.element.appendChild(e),this.area=this.world.areas[t];let s=document.createElement("pre");s.textContent=`Area ${t}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${O.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([i,n])=>`${i.debug}: ${ye(n,this.rom)}`))].join(`
  `)}
Routes:
  ${ye(this.area.routes,this.rom).split(" | ").join(`
  `).replace(/[()]/g,"")}`,this.element.appendChild(s);for(let i of this.area.locations){let n=this.rom.locations[i],o=document.createElement("h2");o.textContent=n.name,this.element.appendChild(o),this.element.appendChild(this.makeLocation(this.area,n))}}makeLocation(t,e){let s=new Ye(this.rom,e.id);s.maxWidth=574,s.overlayShade(1426063360);for(let i of this.world.locations[e.id].areas)i!==t&&s.overlayArea(i.tiles,4294901760);return s.overlayArea(t.tiles,4278255615,0),s.render(),s.element}};var Dt;(o=>{function r(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw new Error(`Bad direction: ${a}`)}o.name=r;function t(){return[0,1,2,3]}o.all=t,o.North=0,o.West=1,o.South=2,o.East=3})(Dt||(Dt={}));var ve;(i=>{function r(n,o){return{*[Symbol.iterator](){let{x:a,y:l}=o;a+=8;for(let c of[-16,0]){let d=a+c;for(let f of[-16,0]){let u=l+f;yield W.from(n,{x:d,y:u})}}}}}i.trigger=r;function t(n,...o){let a=new Set,l=[...n];for(let[c,d]of o)for(let f of l)a.add(W.add(f,c,d));return a}i.adjust=t;function e(n){let o=[];for(let a=0;a<240;a++)o.push(n&-256|a);return o}i.screen=e;function s(n,...o){let a=new Set,l=[...n];for(let c of o)for(let d of l)a.add(d&65535|c.id<<16);return a}i.atLocation=s})(ve||(ve={}));function lt(r){return r}(e=>{e.from=(s,i)=>typeof s=="number"||!i?Number(s)>>>8:s.id<<8|i.y>>>8<<4|i.x>>>8;function t(s){return s>>>8}e.fromTile=t})(lt||(lt={}));function ce(r){return r}(e=>{function r(s,i){return s*(1<<24)+i}e.of=r;function t(s){return[Math.floor(s/(1<<24)),s%(1<<24)]}e.split=t})(ce||(ce={}));var[]=[V],gs=class{constructor(t,e,s=!1){this.rom=t;this.flagset=e;this.tracker=s;this.terrainFactory=new ms(this.rom);this.terrains=new Map;this.checks=new _(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new _(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new ge;this.neighbors=new _(()=>0);this.routes=new _(()=>new G.Builder);this.routeEdges=new _(()=>new Tt);this.requirementMap=new _(t=>new G.Builder(t));this.limeTreeEntranceLocation=-1;this.chestRequirement=G.OPEN;if(e.alwaysMimics()){let n=[t.flags.SwordOfWind,t.flags.SwordOfFire,t.flags.SwordOfWater,t.flags.SwordOfThunder].filter((o,a)=>t.objects.mimic.elements&1<<a);this.chestRequirement=Ge(...n)}for(let i of t.items)for(let n of i.itemUseData)n.kind==="expect"?this.itemUses.get(n.want).push([i,n]):n.kind==="location"&&this.itemUses.get(~n.want).push([i,n]);this.aliases=new Map([[t.flags.ChangeAkahana,t.flags.Change],[t.flags.ChangeSoldier,t.flags.Change],[t.flags.ChangeStom,t.flags.Change],[t.flags.ChangeWoman,t.flags.Change],[t.flags.ParalyzedKensuInDanceHall,t.flags.Paralysis],[t.flags.ParalyzedKensuInTavern,t.flags.Paralysis]]),e.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(let i of t.locations)this.processLocation(i);this.addExtraChecks(),this.unionNeighbors(),this.recordExits(),this.buildNeighbors(),this.addAllRoutes(),this.consolidateChecks(),this.buildRequirementMap()}addExtraChecks(){let{locations:{Leaf_ToolShop:t,MezameShrine:e,Oak:s,Shyron_ToolShop:i},flags:{AbleToRideDolphin:n,BallOfFire:o,BallOfThunder:a,BallOfWater:l,BallOfWind:c,Barrier:d,BlizzardBracelet:f,BowOfMoon:u,BowOfSun:h,BreakStone:p,BreakIce:m,BreakIron:b,BrokenStatue:S,BuyHealing:g,BuyWarp:y,ClimbWaterfall:x,ClimbSlope8:I,ClimbSlope9:E,ClimbSlope10:F,CrossPain:w,CurrentlyRidingDolphin:k,Flight:M,FlameBracelet:N,FormBridge:J,GasMask:ie,GlowingLamp:re,InjuredDolphin:q,LeadingChild:fe,LeatherBoots:L,Money:A,OpenedCrypt:Ae,RabbitBoots:Pe,Refresh:H,RepairedStatue:he,RescuedChild:ue,ShellFlute:$e,ShieldRing:ct,ShootingStatue:ee,ShootingStatueSouth:Le,StormBracelet:Je,Sword:Cs,SwordOfFire:ft,SwordOfThunder:St,SwordOfWater:Ct,SwordOfWind:qe,TornadoBracelet:P,TravelSwamp:_t,TriggerSkip:Be,UsedBowOfMoon:kt,UsedBowOfSun:K,WildWarp:xe},items:{MedicalHerb:ht,WarpBoots:Nt}}=this.rom,X=this.entrance(e),zr=this.entrance(s);this.addCheck([X],Ze(u,h),[Ae.id]),this.addCheck([X],u.r,[kt.id]),this.addCheck([X],h.r,[K.id]),this.addCheck([X],Ze(n,$e),[k.id]),this.addCheck([zr],Ze(fe),[ue.id]),this.addItemCheck([X],Ze(re,S),he.id,{lossy:!0,unique:!0});for(let Ee of this.rom.shops){if(Ee.location===t.id||Ee.location===i.id||!Ee.used||Ee.type!==1)continue;let Wt=[Ee.location<<16|136];for(let Ot of Ee.contents)Ot===ht.id?this.addCheck(Wt,A.r,[g.id]):Ot===Nt.id&&this.addCheck(Wt,A.r,[y.id])}let vt=qe.r,It=ft.r,Et=Ct.r,Rt=St.r;if(!this.flagset.orbsOptional()){let Ee=Ge(c,P),Wt=Ge(o,N),Ot=Ge(l,f),qr=Ge(a,Je);if(vt=G.meet(vt,Ee),It=G.meet(It,Wt),Et=G.meet(Et,Ot),Rt=G.meet(Rt,qr),this.flagset.assumeSwordChargeGlitch()){let zt=function(pi){return Hr.map(ks=>ks[0]===pi.c?ks:[pi.c,...ks])},Hr=G.or(vt,It,Et,Rt);vt=zt(qe),It=zt(ft),Et=zt(Ct),Rt=zt(St)}}this.addCheck([X],vt,[p.id]),this.addCheck([X],It,[m.id]),this.addCheck([X],Et,[J.id]),this.addCheck([X],Rt,[b.id]),this.addCheck([X],Ge(qe,ft,Ct,St),[Cs.id]),this.addCheck([X],M.r,[x.id,F.id]),this.addCheck([X],Ge(M,Pe),[I.id]),this.addCheck([X],Ge(M,Pe),[E.id]),this.addCheck([X],d.r,[ee.id,Le.id]),this.addCheck([X],ie.r,[_t.id]);let $r=this.flagset.changeGasMaskToHazmatSuit()?ie:L;if(this.addCheck([X],Ge(M,Pe,$r),[w.id]),this.flagset.leatherBootsGiveSpeed()&&this.addCheck([X],L.r,[I.id]),this.flagset.assumeGhettoFlight()&&this.addCheck([X],Ze(k,Pe),[x.id]),this.flagset.fogLampNotRequired()){let Ee=this.flagset.requireHealedDolphinToRide();this.addCheck([X],Ee?q.r:[[]],[n.id])}this.flagset.guaranteeBarrier()||this.addCheck([X],[[A.c,g.c],[A.c,ct.c],[A.c,H.c]],[ee.id,Le.id]),this.flagset.assumeFlightStatueSkip()&&this.addCheck([X],[[A.c,M.c]],[ee.id]),this.flagset.guaranteeGasMask()||this.addCheck([X],[[A.c,g.c],[A.c,H.c]],[_t.id,w.id]),this.flagset.assumeWildWarp()&&this.addCheck([X],G.OPEN,[xe.id]),this.flagset.assumeTriggerGlitch()&&(this.addCheck([X],G.OPEN,[Be.id]),this.addCheck([X],Be.r,[w.id,I.id,E.id]))}addExtraRoutes(){let{flags:{BuyWarp:t,SwordOfThunder:e,Teleport:s,WildWarp:i},locations:{MezameShrine:n}}=this.rom;if(this.addRoute(new Fe(this.entrance(n),[])),this.flagset.teleportOnThunderSword()){let o=this.rom.townWarp.thunderSwordWarp;this.addRoute(new Fe(this.entrance(o[0],o[1]&31),[e.c,t.c])),this.addRoute(new Fe(this.entrance(o[0],o[1]&31),[e.c,s.c]))}if(this.flagset.assumeWildWarp())for(let o of this.rom.wildWarp.locations){if(o===this.rom.locations.UndergroundChannel.id)continue;let a=this.entrance(o),l=this.terrains.get(a)??Re("bad entrance");for(let c of l.enter)this.addRoute(new Fe(a,[i.c,...c]))}}consolidateChecks(){for(let[t,e]of this.checks){let s=this.tiles.find(t);if(t!==s){for(let i of e)this.checks.get(s).add(i);this.checks.delete(t)}}}buildRequirementMap(){for(let[e,s]of this.checks)for(let{checks:i,requirement:n}of s)for(let o of i){let a=this.requirementMap.get(o);for(let l of n)for(let c of this.routes.get(e)||[])a.addList([...l,...c])}if(!sr)return;let t=[];for(let[e,s]of this.requirementMap){let i=n=>this.rom.flags[n].name;for(let n of s)t.push(`${i(e)}: ${[...n].map(i).join(" & ")}
`)}t.sort((e,s)=>e<s?-1:e>s?1:0),console.log(t.join(""))}getLocationList(t="Crystalis"){let e=sr?s=>s.debug:s=>s.name;return{worldName:t,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:s=>e(this.rom.flags[s]),prefill:s=>{let{Crystalis:i,MesiaInTower:n,LeafElder:o}=this.rom.flags,a=new Map([[n.id,i.id]]);return this.flagset.guaranteeSword()&&a.set(o.id,512|s.nextInt(4)),a}}}processLocation(t){!t.used||(this.processLocationTiles(t),this.processLocationSpawns(t),this.processLocationItemUses(t))}unionNeighbors(){for(let[t,e]of this.terrains){let s=W.add(t,0,1);this.terrains.get(s)===e&&this.tiles.union([t,s]);let i=W.add(t,1,0);this.terrains.get(i)===e&&this.tiles.union([t,i])}}addAllRoutes(){this.addExtraRoutes();for(let[t,e]of this.neighbors){let[s,i]=ce.split(t),n=this.terrains.get(s),o=this.terrains.get(i);if(!n||!o)throw new Error(`missing terrain ${V(n?s:i)}`);for(let[a,l]of n.exit)if(!!(a&e))for(let c of l)for(let d of o.enter)this.addRoute(new Fe(i,[...c,...d]),s)}if(typeof document=="object"){let t=document.getElementById("debug");t&&t.appendChild(new xs(this.rom,this.getWorldData()).element)}}getWorldData(){let t=0,e=new _(()=>({})),s=te(256,()=>({areas:new Set,tiles:new Set})),i=[];for(let n of this.tiles.sets()){let o=this.tiles.find(se.first(n)),a=this.terrains.get(o);if(!a)continue;let l=this.routes.has(o)?G.freeze(this.routes.get(o)):[];if(!l.length)continue;let c={checks:[],id:t++,locations:new Set,routes:l,terrain:a,tiles:new Set};i.push(c);for(let d of n){let f=d>>>16;c.locations.add(f),c.tiles.add(d),s[f].areas.add(c),s[f].tiles.add(d),e.get(d).area=c}}for(let[n,o]of this.exits)e.has(n)&&(e.get(n).exit=o);for(let[n,o]of this.checks){let a=e.get(n).area;if(!!a)for(let{checks:l,requirement:c}of o)for(let d of l){let f=this.rom.flags[d]||Re();a.checks.push([f,c])}}return{tiles:e,areas:i,locations:s}}addRoute(t,e){if(e!=null){this.routeEdges.get(e).add(t);for(let a of this.routes.get(e))this.addRoute(new Fe(t.target,[...a,...t.deps]));return}let s=new Tt,i=new Tt,n=t;s.add(n);let o=s[Symbol.iterator]();for(;;){let{value:a,done:l}=o.next();if(l)return;i.add(a),s.delete(a);let c=new Tt,d=a.target;if(this.routes.get(d).addRoute(a))for(let u of this.routeEdges.get(d))c.add(new Fe(u.target,[...a.deps,...u.deps]));for(let u of c)i.has(u)||(s.delete(u),s.add(u))}}recordExits(){for(let[t,e]of this.exits)this.exitSet.add(ce.of(this.tiles.find(t),this.tiles.find(e)));for(let t of this.exitSet){let[e,s]=ce.split(t);if(this.terrains.get(e)!==this.terrains.get(s))continue;let i=ce.of(s,e);this.exitSet.has(i)&&(this.tiles.union([e,s]),this.exitSet.delete(t),this.exitSet.delete(i))}}buildNeighbors(){for(let[t,e]of this.terrains){if(!e)continue;let s=W.add(t,1,0),i=this.terrains.get(s);i&&i!==e&&this.handleAdjacentNeighbors(t,s,Dt.North);let n=W.add(t,0,1),o=this.terrains.get(n);o&&o!==e&&this.handleAdjacentNeighbors(t,n,Dt.West)}for(let t of this.exitSet){let[e,s]=ce.split(t);if(!this.terrains.has(e)||!this.terrains.has(s))continue;let i=ce.of(this.tiles.find(e),this.tiles.find(s));this.neighbors.set(i,this.neighbors.get(i)|1)}}handleAdjacentNeighbors(t,e,s){let i=this.tiles.find(t),n=this.tiles.find(e);if(!this.seamlessExits.has(e)){let o=ce.of(n,i);this.neighbors.set(o,this.neighbors.get(o)|1<<s)}if(!this.seamlessExits.has(t)){let o=s^2,a=ce.of(i,n);this.neighbors.set(a,this.neighbors.get(a)|1<<o)}}processLocationTiles(t){let e=new Map,s=new Set,i=(t.id&248)===88;for(let c of t.spawns)if(c.isWall())e.set(lt.from(t,c),c.id&3);else if(c.isMonster()&&c.id===63){let d=lt.from(t,c)<<8|c.yt<<4;for(let f=4;f<=11;f++)for(let u=-3;u<=3;u++)s.add(W.add(d,u,f))}let n=this.rom.tilesets[t.tileset],o=this.rom.tileEffects[t.tileEffects-179],a=c=>{let d=t.screens[(c&61440)>>>12][(c&3840)>>>8];return o.effects[this.rom.screens[d].tiles[c&255]]},l=(c,d,f)=>{if(c&=O.BITS,t.id===26&&(c|=O.SWAMP),(t.id===96||t.id===104)&&(c|=O.DOLPHIN),t.id===100&&(d&61680)<4144&&(c|=O.DOLPHIN),f&&(c|=O.BARRIER),!(c&O.DOLPHIN)&&c&O.SLOPE){let u=d,h=0;for(;a(u)&O.SLOPE;)u=W.add(u,1,0),h++;h<6?c&=~O.SLOPE:h<9?c|=O.SLOPE8:h<10&&(c|=O.SLOPE9)}if(c&O.PAIN){for(let u of[[0,1],[1,0],[0,-1],[-1,0]])if(!(a(W.add(d,...u))&(O.PAIN|O.FLY))){c&=~O.PAIN;break}}return this.terrainFactory.tile(c)};for(let c=0,d=t.height;c<d;c++){let f=t.screens[c],u=t.id<<8|c<<4;for(let h=0,p=t.width;h<p;h++){let m=this.rom.screens[f[h]],b=u|h,S=b&255,g=e.get(b),y=i?this.rom.flags.AlwaysTrue.id:g!=null?this.wallCapability(g):t.flags.find(E=>E.screen===S)?.flag,x=t.pits.find(E=>E.fromScreen===b);x&&this.exits.set(b<<8|136,x.toScreen<<8|136);let I=this.rom.flags[y]?.logic??{};for(let E=0;E<240;E++){let F=b<<8|E,w=m.tiles[E];I.assumeTrue&&w<32&&(w=n.alternates[w]);let k=t.isShop()?0:o.effects[w],M=s.has(F),N=l(k,F,M);if(w<32&&n.alternates[w]!==w&&y!=null&&!I.assumeTrue&&!I.assumeFalse){let J=l(o.effects[n.alternates[w]],F,M);J&&(N=this.terrainFactory.flag(N,I.track?y:-1,J))}N&&this.terrains.set(F,N)}}}for(let c of t.exits){let{dest:d,entrance:f}=c,u=W.from(t,c),h;if(c.isSeamless()){h=u&65535|d<<16;let p=W.from(t,c);this.seamlessExits.add(p);let m=this.terrains.get(p);m&&this.terrains.set(p,this.terrainFactory.seamless(m))}else h=this.entrance(this.rom.locations[d],f&31);this.exits.set(u,h),d===this.rom.locations.LimeTreeLake.id&&this.rom.locations.LimeTreeLake.entrances[f].y>160&&(this.limeTreeEntranceLocation=t.id)}}processLocationSpawns(t){for(let e of t.spawns)e.isTrigger()?this.processTrigger(t,e):e.isNpc()?this.processNpc(t,e):e.isBoss()?this.processBoss(t,e):e.isChest()?this.processChest(t,e):e.isMonster()?this.processMonster(t,e):e.type===3&&e.id===224&&this.processKeyUse(ve.screen(W.from(t,e)),this.rom.flags.UsedWindmillKey.r)}processTrigger(t,e){let s=this.rom.trigger(e.id);if(!s)throw new Error(`Missing trigger ${e.id.toString(16)}`);let i=this.filterRequirements(s.conditions),n=this.filterAntiRequirements(s.conditions),o=W.from(t,e),a=ve.trigger(t,e),l=[];for(let c of s.flags){let d=this.flag(c);d?.logic.track&&l.push(d.id)}switch(l.length&&this.addCheck(a,i,l),s.message.action){case 25:s.id===134&&!this.flagset.assumeRabbitSkip()?a=ve.adjust(a,[0,-1],[0,1]):s.id===186&&!this.flagset.assumeTeleportSkip()&&!this.flagset.disableTeleportSkip()&&(a=ve.atLocation(a,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)),this.flagset.assumeTriggerGlitch()&&(n=G.or(n,this.rom.flags.TriggerSkip.r)),this.addTerrain(a,this.terrainFactory.statue(n));break;case 29:this.addBossCheck(a,this.rom.bosses.Mado1,i);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(a,i,s.id);break;case 24:{let c=this.flagset.chargeShotsOnly()?G.meet(i,Ze(this.rom.flags.WarpBoots)):i;this.addItemCheck(a,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break}case 30:this.addItemCheck(a,i,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(o,t,i);break;case 27:t===this.rom.locations.Portoa_PalaceEntrance&&(a=ve.adjust(a,[-2,0]),n=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(a,t,n);break}for(let[c,d]of this.itemUses.get(e.type<<8|e.id))this.processItemUse([W.from(t,e)],G.OPEN,c,d)}processNpc(t,e){let s=this.rom.npcs[e.id];if(!s||!s.used)throw new Error(`Unknown npc: ${V(e.id)}`);let i=s.spawnConditions.get(t.id)||[],n=this.filterRequirements(i),o=W.from(t,e),a=[this.terrains.has(o)?o:this.walkableNeighbor(o)??o];for(let[d,f]of this.itemUses.get(e.type<<8|e.id))this.processItemUse(a,n,d,f);if(s===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(a,this.rom.bosses.Sabera1,n),s.data[2]&4&&!this.flagset.assumeStatueGlitch()){let d;d=this.filterAntiRequirements(i),s===this.rom.npcs.Rage?(a=ve.adjust(a,[2,-1],[2,0],[2,1],[2,2]),a=ve.adjust(a,[0,-6],[0,-2],[0,2],[0,6])):s===this.rom.npcs.PortoaThroneRoomBackDoorGuard?d=G.or(this.rom.flags.MesiaRecording.r,Ze(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):s===this.rom.npcs.SoldierGuard&&(d=void 0),d&&this.addTerrain(a,this.terrainFactory.statue(d))}if(s===this.rom.npcs.FortuneTeller&&(a=ve.adjust(a,[0,0],[2,0])),G.isClosed(n))return;let[[...l]]=n;for(let d of s.globalDialogs){let f=this.flag(~d.condition),u=this.flag(d.condition);if(f?.logic.assumeFalse||u?.logic.assumeTrue)return;f?.logic.track&&l.push(f.id)}let c=s.localDialogs.get(t.id)??s.localDialogs.get(-1)??[];for(let d of c){let f=[...l],u=this.flag(d.condition),h=this.flag(~d.condition);if(u?.logic.track&&f.push(u.id),!u?.logic.assumeFalse&&!h?.logic.assumeTrue&&this.processDialog(a,s,f,d),u?.logic.assumeTrue||h?.logic.assumeFalse)break;h?.logic.track&&l.push(h.id)}}processDialog(t,e,s,i){this.addCheckFromFlags(t,[s],i.flags);let n={lossy:!0,unique:!0};switch(i.message.action){case 8:this.processKeyUse(t,[s]);break;case 20:this.addItemCheck(t,[s],this.rom.flags.SlimedKensu.id,n);break;case 16:this.addItemCheck(t,[s],this.rom.flags.AsinaInBackRoom.id,n);break;case 17:this.addItemCheck(t,[s],256|e.data[1],n);break;case 3:case 10:this.addItemCheck(t,[s],256|e.data[0],n);break;case 9:let o=e.data[1];o!==255&&this.addItemCheck(t,[s],256|o,n);break;case 25:this.addItemCheck(t,[s],this.rom.flags.AkahanaFluteOfLimeTradein.id,n);break;case 26:this.addItemCheck(t,[s],this.rom.flags.Rage.id,n);break;case 27:break}}processLocationItemUses(t){for(let[e,s]of this.itemUses.get(~t.id))this.processItemUse([this.entrance(t)],G.OPEN,e,s)}handleMovingGuard(t,e,s){if(this.flagset.assumeStatueGlitch())return;let i=[];for(let n of e.spawns.slice(0,2))if(n.isNpc()&&this.rom.npcs[n.id].isParalyzable()){i.push([this.rom.flags.Paralysis.c]);break}this.flagset.assumeTriggerGlitch()&&i.push([this.rom.flags.TriggerSkip.c]),this.addTerrain(t,this.terrainFactory.statue([...s,...i].map($t)))}handleBoat(t,e,s){let i=this.walkableNeighbor(t);if(i==null)throw new Error("Could not find walkable neighbor.");let n=t>>8&240|t>>4&15,o=t>>4&240|t&15,a;for(let u of e.exits)u.yt===n&&u.xt<o&&(a=u);if(!a)throw new Error("Could not find boat exit");let l=this.rom.locations[a.dest];if(!l)throw new Error("Bad destination");let c=l.entrances[a.entrance],d=W.from(l,c),f=d;for(;;){f=W.add(f,0,-1);let u=this.walkableNeighbor(f);if(u!=null){let h={enter:G.freeze(s),exit:[[15,G.OPEN]]};this.addTerrain([i],h),this.exits.set(i,u),this.exitSet.add(ce.of(i,u)),this.exits.set(d,u),this.exitSet.add(ce.of(d,u)),this.terrains.set(d,this.terrainFactory.tile(0));return}}}addItemGrantChecks(t,e,s){let i=this.itemGrant(s),n=256|i;if(i==null)throw new Error(`missing item grant for ${s.toString(16)}`);let o=s>=128;this.addItemCheck(t,e,n,{lossy:!0,unique:!0,preventLoss:o})}addTerrain(t,e){for(let s of t){let i=this.terrains.get(s);i!=null&&this.terrains.set(s,this.terrainFactory.meet(i,e))}}addCheck(t,e,s){if(G.isClosed(e))return;let i={requirement:G.freeze(e),checks:s};for(let n of t)!this.terrains.has(n)||this.checks.get(n).add(i)}addItemCheck(t,e,s,i){this.addCheck(t,e,[s]),this.slots.set(s,i);let n=this.rom.itemGets[this.rom.slots[s&255]],o=this.rom.items[n.itemId],a=o?.unique,l=n.isLosable(),c=a||o===this.rom.items.OpelStatue,d=1;o===this.rom.items.SwordOfWind&&(d=5),o===this.rom.items.SwordOfFire&&(d=5),o===this.rom.items.SwordOfWater&&(d=10),o===this.rom.items.SwordOfThunder&&(d=15),o===this.rom.items.Flight&&(d=15),this.items.set(512|n.id,{unique:a,losable:l,preventLoss:c,weight:d})}addCheckFromFlags(t,e,s){let i=[];for(let n of s){let o=this.flag(n);o?.logic.track&&i.push(o.id)}i.length&&this.addCheck(t,e,i)}walkableNeighbor(t){if(this.isWalkable(t))return t;for(let e of[-1,1]){let s=W.add(t,e,0),i=W.add(t,0,e);if(this.isWalkable(s))return s;if(this.isWalkable(i))return i}}isWalkable(t){return!(this.getEffects(t)&O.BITS)}ensurePassable(t){return this.isWalkable(t)?t:this.walkableNeighbor(t)??t}getEffects(t){let e=this.rom.locations[t>>>16],s=this.rom.tileEffects[e.tileEffects-179].effects,i=e.screens[(t&61440)>>>12][(t&3840)>>>8];return s[this.rom.screens[i].tiles[t&255]]}processBoss(t,e){let{bosses:s}=this.rom,{Rage:i,StatueOfSun:n,StatueOfMoon:o}=s,a=e.id===201,l=e.id===202,c=e.id===195,d=c?i:a?o:l?n:s.fromLocation(t.id),f=W.from(t,e);if(!d||!d.flag)throw new Error(`Bad boss at ${t.name}`);let u=f&-256,h=this.terrainFactory.boss(d.flag.id,c),p=te(240,m=>u|m);this.addTerrain(p,h),!a&&!l&&this.addBossCheck(p,d)}addBossCheck(t,e,s=G.OPEN){if(e.flag==null)throw new Error(`Expected a flag: ${e}`);let i=G.meet(s,this.bossRequirements(e));if(e===this.rom.bosses.Draygon2)this.addCheck(t,i,[e.flag.id]);else{let n=e===this.rom.bosses.Insect;this.addItemCheck(t,i,e.flag.id,{lossy:!1,unique:!0,broken:n})}}processChest(t,e){if(this.rom.slots[e.id]>=112)return;let s=256|e.id,i=this.rom.slots[e.id];if(i>=112)return;let n=this.rom.items[i],o=this.flagset.preserveUniqueChecks()?!!n?.unique:!0;this.addItemCheck([W.from(t,e)],this.chestRequirement,s,{lossy:!1,unique:o})}processMonster(t,e){let s=this.rom.objects[e.monsterId];if(!(s instanceof He))return;let{Money:i,RageSkip:n,Sword:o,SwordOfWind:a,SwordOfFire:l,SwordOfWater:c,SwordOfThunder:d}=this.rom.flags;if(t.id===this.limeTreeEntranceLocation&&s.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(t)],G.OPEN,[n.id]),!s.goldDrop)return;let f=[W.from(t,e)];if(!this.flagset.guaranteeMatchingSword()){this.addCheck(f,o.r,[i.id]);return}let u=[a,l,c,d].filter((h,p)=>s.elements&1<<p);this.addCheck(f,Ge(...u),[i.id])}processItemUse(t,e,s,i){t=new Set([...t].map(a=>this.walkableNeighbor(a)??a));let n=[[512|s.id]];s.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&n[0].push(this.rom.flags.Change.c),s===this.rom.items.MedicalHerb&&(n[0][0]=this.rom.flags.BuyHealing.c);let o=G.meet(e,n);switch(this.addCheckFromFlags(t,o,i.flags),i.message.action){case 16:this.processKeyUse(t,o);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(t,o,s.id);break;case 2:this.addItemCheck(t,o,256|this.rom.npcs[i.want&255].data[1],{lossy:!0,unique:!0});break}}processKeyUse(t,e){let[s,...i]=new Set([...t].map(a=>lt.from(a)));if(s==null||i.length)throw new Error("Expected one screen");let o=this.rom.locations[s>>>8].flags.find(a=>a.screen===(s&255));if(o==null)throw new Error("Expected flag on screen");this.addCheck(t,e,[o.flag])}bossRequirements(t){if(t===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];let e=t.object,s=new G.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())s.addAll(this.rom.flags.Sword.r);else{let n=this.flagset.guaranteeSwordMagic()?t.swordLevel:1,o=this.rom.objects[e];for(let a=0;a<4;a++)o.isVulnerable(a)&&s.addAll(this.swordRequirement(a,n))}let i=[];if(t.npc!=null&&t.location!=null){let n=t.npc.spawns(this.rom.locations[t.location]);i.push(...this.filterRequirements(n)[0])}return t===this.rom.bosses.Insect?i.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):t===this.rom.bosses.Draygon2&&i.push(this.rom.flags.BowOfTruth.c),this.flagset.guaranteeRefresh()&&i.push(this.rom.flags.Refresh.c),s.restrict([i]),G.freeze(s)}swordRequirement(t,e){let s=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][t];if(e===1)return s.r;let i=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][t];return e===3?Ze(s,...i):i.map(n=>[s.c,n.c])}itemGrant(t){for(let[e,s]of this.rom.itemGets.actionGrants)if(e===t)return s;throw new Error(`Could not find item grant ${t.toString(16)}`)}filterRequirements(t){let e=[];for(let s of t)if(s<0){if(this.flag(~s)?.logic?.assumeTrue)return G.CLOSED}else{let i=this.flag(s);if(i?.logic.assumeFalse)return G.CLOSED;i?.logic.track&&e.push(i.id)}return[e]}filterAntiRequirements(t){let e=[];for(let s of t)if(s>=0){if(this.flag(~s)?.logic?.assumeFalse)return G.OPEN}else{let i=this.flag(~s);if(i?.logic.assumeTrue)return G.OPEN;i?.logic.track&&e.push([i.id])}return e}flag(t){let e=t,s=this.rom.flags[e];return this.aliases.get(s)??s}entrance(t,e=0){return typeof t=="number"&&(t=this.rom.locations[t]),this.tiles.find(W.from(t,t.entrances[e]))}wallCapability(t){switch(t){case 0:return this.rom.flags.BreakStone.id;case 1:return this.rom.flags.BreakIce.id;case 2:return this.rom.flags.FormBridge.id;case 3:return this.rom.flags.BreakIron.id;default:throw new Error(`bad wall type: ${t}`)}}};function Ze(...r){return[r.map(t=>t.id)]}function Ge(...r){return r.map(t=>[t.id])}var sr=!1;function rr(r){if(!r.compressedMapData){r.compressedMapData=!0;for(let t=0;t<3;t++)r.metascreens.renumber(256|t,320|t),delete r.screens[256|t]}}function nr(r){if(!r.compressedMapData)throw new Error("Must compress first");let{grass:t,town:e,cave:s,dolphinCave:i,pyramid:n,river:o,sea:a,lime:l,mountain:c,shrine:d,desert:f,mountainRiver:u,swamp:h,house:p,fortress:m,labyrinth:b,iceCave:S,tower:g}=r.metatilesets;r.moveScreens([h],4),r.moveScreens([p],4),r.moveScreens([e],4),r.moveScreens([l],4),r.moveScreens([d],4),r.moveScreens([g],4),r.moveScreens([c,u],4),r.moveScreens([s,n,m,b,S],5);let[]=[a,i,t,o,f]}var[]=[qt];function or(r,t){let o=r.objects[159],a=r.objects[127],l=r.objects[141];l.used=!0,l.name="Crumbling Horizontal Platform",l.sfx=o.sfx,o.data.forEach((f,u)=>l.data[u]=f),l.data[3]=a.data[3];let c=new Set([127-80,141-80]),d=new Set([126-80,159-80]);for(let f of r.locations){if(!f.pits.length)continue;let u=t.nextInt(3)<1;for(let h of f.spawns)!h.isMonster()||(d.has(h.id)&&(h.id=(u?159:126)-80),c.has(h.id)&&(h.id=(u?141:127)-80))}}var[]=[V];function Ie(r,t,...e){let s=t,i=0,n;for(;(n=e[i++])!=null;)if(typeof n=="number")r[s++]=n;else if(typeof n=="string")for(let o of n)r[s++]=o.charCodeAt(0);else throw new Error("bad data")}function ar(r){r[107924]=255,r[118213]=168,r[106870]=255,r[108620]=255,r[120899]=160,r[122987]&=7,r[122991]&=7,r[122995]&=7,r[122999]&=7,r[123003]&=7,r[123012]&=7,r[123035]&=7,r[123065]&=7,r[123141]=47,r[123511]=0,r[123750]=64,r[123761]=0,r[123783]=0,r[123793]=0,Ie(r,106856,51,51),Ie(r,107662,51,51),r[105393]=112,r[105397]=113,r[105079]=114,r[105963]=115,r[106565]=116,r[106721]=117,r[106725]=118,r[106729]=119,r[108037]=120,r[107457]=121,r[107461]=122,r[107465]=123,Ie(r,123063,192,0),Ie(r,123690,192,0),Ie(r,123696,192,0),Ie(r,123702,192,0),Ie(r,123104,192,0),Ie(r,123110,192,0),r[116739]=0,Ie(r,116749,162,179),r[109190]=254,Ie(r,513749,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(let t of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])r[t]|=1;Ie(r,157038,"Simea",16,0,"     ",16,0)}function lr(r,t){Xn(r),En(r),vn(r),In(r),Rn(r,t),oo(r),ao(r),ro(r),Mn(r),Fn(r),Ln(r),Tn(r),qn(r),Bn(r),eo(r,t),Jn(r),t.requireHealedDolphinToRide()&&Nn(r),t.saharaRabbitsRequireTelepathy()&&Wn(r),$n(r,t),Dn(r,t),_n(r),t.teleportOnThunderSword()?(On(r),r.townWarp.thunderSwordWarp=[r.locations.Shyron.id,65]):zn(r),An(r),t.fogLampNotRequired()&&Pn(r,t),Yn(r),Zn(r),Hn(r),Un(r,t),t.disableRabbitSkip()&&jn(r),t.disableFlightStatueSkip()&&Kn(r),Qn(r,t),Gn(r),t.chargeShotsOnly()&&to(r),t.orbsOptional()&&so(r),t.noBowMode()&&io(r),Vn(r),t.hardcoreMode()&&lo(r),t.shouldUpdateHud()&&(kn(r),r.writeMonsterNames=!0),t.shouldColorSwordElements()&&Cn(r),t.hasStatTracking()&&Sn(r),co(r),no(r)}function Sn(r){for(let x=0;x<4;x++)r.patterns.set(5376,41+x,Se.BLANK_TILES[x]);if(r.prg[143082]===40)return;r.prg[143082]=40;let s=143364,i=144132,n=128-1;for(let x=s;x<i;x++)r.prg[x]>=41&&r.prg[x]<=45&&(r.prg[x]+=n);let o=42,a=160;for(let x=s;x<i;x+=192)r.prg[x+a]=o;let l=new Map([[66,a]]),c=142469,d=142546;for(let x=c;x<d;x++)l.has(r.prg[x])&&(r.prg[x]=l.get(r.prg[x]));for(let x=s;x<i;x+=192)for(let I=123;I<=127;I++)r.prg[x+I]==o+n&&(r.prg[x+I]=o);let f=3,u=2,h=144376,p=144440;for(let x=h;x<p;x++){let I=r.prg[x];for(let E=0;E<8;E+=2){let F=f<<E,w=u<<E;(I&F)==F&&(I=I&(255^3<<E)|w)}r.prg[x]=I}let m=144440,b=4*f,S=[15,48,15,17];for(let x=0;x<S.length;x++)r.prg[m+b+x]=S[x];r.prg[m+u*4+3]=8;let g=145114,y=145222;for(let x=g;x<y;x+=4)r.prg[x]+=128}function Cn(r){function t(e,s){for(let i=0;i<=10;i++){if(i===8)continue;let n=r.patterns.get(i|e),o=[...n.pixels];for(let a=0;a<n.pixels.length;a++)n.pixels[a]=o[a^8],a>>>3===s&&(n.pixels[a]|=o[a])}}t(4240),t(4304),t(4368),t(4432),t(4496)}function kn(r){r.patterns.set(3584,0,Se.HUD_LF),r.patterns.set(3584,1,Se.HUD_PW),r.patterns.set(3584,2,Se.HUD_EY),r.patterns.set(3584,3,Se.HUD_LV),r.patterns.set(3584,4,Se.HUD_DL),r.patterns.set(3584,5,Se.HUD_MP),r.patterns.set(3584,6,Se.HUD_EX),r.patterns.set(3584,26,Se.HUD_CLOSE_LEFT),r.patterns.set(3584,27,Se.HUD_CLOSE_RIGHT)}function vn(r){r.items.GlowingLamp.itemUseData[0].message.action=11}function In(r){let t=r.nextFreeTrigger("mezame");t.used=!0,t.conditions=[~r.flags.AlwaysTrue.id],t.message=Ft.of({action:4}),t.flags=[r.flags.AlwaysTrue.id],r.locations.MezameShrine.spawns.push(z.of({tile:136,type:2,id:t.id}))}function En(r){let t=new Set([129,139,144,153,166,167,168,169,170,171,172,r.allocatedTriggers.get("zombie warp")]);for(let e of r.locations)!e.used||(e.spawns=e.spawns.filter(s=>!s.isTrigger()||!t.has(s.id)))}function Rn(r,t){if(r.objects[16].atk=3,r.objects[17].atk=6,r.objects[18].atk=8,r.objects[24].atk=3,r.objects[19].atk=5,r.objects[25].atk=5,r.objects[23].atk=7,r.objects[26].atk=7,r.objects[20].atk=3,r.objects[21].atk=6,r.objects[22].atk=8,r.objects[28].atk=3,r.objects[29].atk=3,r.objects[30].atk=5,r.objects[27].atk=7,r.objects[31].atk=7,t.slowDownTornado()){let e=r.objects[18];e.speed=7,e.data[12]=96}}function Tn(r){let t=r.trigger(160);t.used=!0,t.conditions=[],t.flags=[],t.message=Ft.of({part:0,index:0,action:21}),r.objects[94].data[13]=254,r.items.InsectFlute.itemUseData[0].flags=[r.flags.UsedInsectFlute.id]}function Mn(r){r.items.OpelStatue.selectedItemValue=0}function Fn(r){for(let t of[96,100,101,102,103,104,105,106,107,108,109,111])for(let e of[0,1,2])r.patterns.set(t<<6,e,r.patterns.get(94<<6,e).pixels);r.objects[12].metasprite=169}function Gn(r){for(let t in[4,5,8,9])r.tileEffects[188-179].effects[t]=24,r.tileEffects[181-179].effects[t]=24}function An(r){let{tiles:t}=r.screens[161];t[40]=159,t[55]=35,t[56]=35,t[57]=33,t[71]=141,t[72]=143,t[86]=153,t[87]=154,t[88]=140}function Pn(r,t){let{flags:{AlwaysTrue:e,InjuredDolphin:s,FogLamp:i,KensuInCabin:n,ReturnedFogLamp:o},items:{ShellFlute:a},locations:{BoatHouse:l,Portoa_FishermanHouse:c},npcs:d}=r,f=t.requireHealedDolphinToRide();a.itemUseData[0].want=f?s.id:e.id,d.KensuInCabin.data[0]=103,d.KensuInCabin.localDialogs.get(-1)[0].message.action=10,d.KensuInCabin.localDialogs.get(-1)[0].flags=[],d.KensuInCabin.spawnConditions.set(l.id,[o.id,~n.id]),d.Fisherman.spawnConditions.set(c.id,[i.id]),r.itemGets[100].flags=[],r.itemGets[103].copyFrom(r.itemGets[100])}function Ln(r){for(let t of r.locations)for(let e of t.spawns)e.isChest()&&(e.timed=!1)}function Bn(r){let t=r.locations;t.GoaFortress_Kelbesque.spawns[0].x-=16,t.GoaFortress_Zebu.spawns.splice(1,1),t.GoaFortress_Tornel.spawns.splice(2,1),t.GoaFortress_Asina.spawns.splice(2,1),t.GoaFortress_Kensu.spawns.splice(3,1),t.GoaFortress_Kensu.spawns.splice(1,1)}function Dn(r,t){let{items:{AlarmFlute:e},flags:{TalkedToZebuStudent:s,ZebuStudent:i},locations:{MezameShrine:n,Leaf_StudentHouse:o,WaterfallCave4:a,ZebuCave:l},npcs:{WindmillGuard:c,Zebu:d}}=r;if(r.itemGets[49].inventoryRowStart=32,e.unique=!0,e.basePrice=0,t.zebuStudentGivesItem())c.data[1]=49;else{c.data[1]=255;let h=c.dialog(o)[0];h.condition=~s.id,h.flags.push(s.id),ei(d.spawns(l),i.id,s.id),n.spawns.push(z.of({screen:0,tile:155,type:2,id:49})),n.spawns.push(z.of({screen:0,tile:149,type:2,id:73})),i.unsafeRename("Mezame Right Chest"),r.flags[329].unsafeRename("Mezame Left Chest"),r.itemGets[73].itemId=r.items.MedicalHerb.id}let f=[[33,.72],[31,.9]],u=0;for(let h of r.shops)if(h.type===1)for(let p=0,m=h.contents.length;p<m;p++){if(h.contents[p]!==49)continue;let[b,S]=f[u++%f.length];h.contents[p]=b,r.shopDataTablesAddress&&(h.prices[p]=Math.round(h.prices[p]*S))}r.itemGets[91].itemId=29,a.spawn(25).id=16}function _n(r){let{flags:{Karmine:t,Mado1:e},npcs:{Brokahana:s}}=r,i=xi(s.localDialogs.get(-1))[0];if(i.condition!==~t.id)throw new Error(`Bad brokahana condition: ${i.condition}`);i.condition=~e.id}function Nn(r){let{flags:{InjuredDolphin:t,ShellFlute:e},npcs:{Fisherman:s,FishermanDaughter:i}}=r;s.spawnConditions.set(214,[e.id,t.id]);let n=i.localDialogs.get(-1);n.unshift(n[0].clone()),n[0].condition=~t.id,n[1].condition=~e.id}function Wn(r){let{flags:{Telepathy:t},npcs:{Deo:e,SaharaBunny:s}}=r;s.globalDialogs.push(Gs.of(~t.id,[26,18])),e.globalDialogs.push(Gs.of(~t.id,[26,19]))}function On(r){let{flags:{WarpShyron:t}}=r;r.itemGets[3].flags.push(t.id)}function zn(r){r.itemGets[3].acquisitionAction.action=22}function $n(r,t){if(t.leatherBootsGiveSpeed()){let e=r.items[47];if(e.menuName="Speed Boots",e.messageName="Speed Boots",t.changeGasMaskToHazmatSuit()){let s=r.items[41];s.menuName="Hazmat Suit",s.messageName="Hazmat Suit"}}for(let e=5;e<12;e+=2)r.items[e].menuName=r.items[e].menuName.replace("Ball","Orb"),r.items[e].messageName=r.items[e].messageName.replace("Ball","Orb")}function qn(r){let{flags:{BallOfWind:t,TornadoBracelet:e},npcs:{Tornel:s}}=r,i=s.localDialogs.get(33),n=[i[0],i[2],i[2].clone(),i[1]];n[1].condition=~e.id,n[2].condition=~t.id,n[3].condition=-1,s.localDialogs.set(33,n)}function Hn(r){let{CordelPlainEast:t,KirisaMeadow:e,UndergroundChannel:s}=r.locations;for(let i of[t,e,s])for(let n of i.spawns)n.isChest()&&(n.data[2]|=32)}function Un(r,t){let{CordelPlainEast:e,CordelPlainWest:s}=r.locations;for(let i of e.spawns)(i.isChest()||t.disableTeleportSkip()&&i.isTrigger())&&s.spawns.push(i.clone())}function jn(r){for(let t of r.locations.MtSabreNorth_Main.spawns)t.isTrigger()&&t.id===134&&t.x===1856&&(t.x+=16,t.y+=16)}function Kn(r){let t=r.hitboxes[r.objects.guardianStatueMissile.hitbox],e=r.hitboxes[6];r.objects.guardianStatueMissile.hitbox=e.id,e.x0=t.x0-6,e.w=t.w+12,e.y0=t.y0-2,e.h=t.h+4}function Vn(r){r.messages.parts[32][15].text+=`
Item: [:ITEM:]`}function Xn(r){let{flags:{WarpZombie:t},locations:{ZombieTown:e}}=r;r.flags.insertZombieWarpFlag();let s=r.messages.parts[33][0];s.text=[" {1a:Leaf}      {16:Brynmaer} {1d:Oak} ","{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} ","{19:Joel}      Zombie   {20:Swan} ","{23:Shyron}    {18:Goa}      {21:Sahara}"].join(`
`);let i=r.nextFreeTrigger("zombie warp");i.used=!0,i.conditions=[],i.message=Ft.of({}),i.flags=[t.id];for(let n of e.spawns)n.isTrigger()&&n.id===138&&(n.id=i.id);if(r.townWarp.locations.splice(7,0,e.id),r.townWarp.locations.pop()!==255)throw new Error("unexpected")}function Yn(r){let{flags:{CurrentlyRidingDolphin:t},locations:{AngrySea:e,EvilSpiritIsland1:s}}=r;r.trigger(138).conditions=[~t.id],r.messages.parts[29][16].text=`This cave ceiling is too
low to fly in.`,dr(e.spawns,i=>i.isTrigger()&&i.id===138),s.spawns.push(z.of({x:88,y:160,type:2,id:138}))}function Zn(r){let t=r.nextFreeTrigger("channel item");t.used=!0,t.conditions=[r.flags.CurrentlyRidingDolphin.id,~r.flags.UndergroundChannelUnderwaterChest.id];let e=r.messages.alloc();e.text="Dolphin: {:HERO:}, I just found a [3b:Love Pendant] under the water!",t.message=Ft.of({part:e.part,index:e.id,action:15});let s=r.locations.UndergroundChannel.spawns.find(i=>i.isChest());s.data[2]=2,s.yt++,s.id=t.id,r.itemGets.actionGrants.set(t.id,59)}function Jn(r){let e=r.npcs[13].localDialogs.get(53)[0];e.message.action=23}function Qn(r,t){let e=r.locations.LimeTreeLake,s=r.screens[r.metascreens.limeTreeLake.sid];if(t.disableRageSkip()){s.set2d(32,s.get2d(0,143)),s.set2d(42,s.get2d(58,1)),s.set2d(16,s.get2d(32,4)),s.set2d(26,s.get2d(42,5)),s.set2d(27,s.get2d(0,16));for(let n of e.spawns)n.tile+=32;let i=r.metascreens.limeTreeLake.findExitByType("cave");i.entrance+=8192,i.exits=i.exits.map(n=>n+32)}else s.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,null,null,null,null,null,121,122,118,118]])}function eo(r,t){let{locations:{BoatHouse:e,Brynmaer:s,Crypt_Draygon2:i,Joel_Shed:n,Leaf_ElderHouse:o,MtSabreNorth_SummitCave:a,MtSabreWest_Upper:l,PortoaPalace_ThroneRoom:c,Portoa_PalaceEntrance:d,Portoa_AsinaRoom:f,Portoa_FortuneTeller:u,Shyron_Temple:h,StomHouse:p,Swan_DanceHall:m,Swan_Tavern:b,WindmillCave:S,WaterfallCave4:g,WaterfallValleyNorth:y,ZebuCave:x,ZombieTown_HouseBasement:I},items:{GlowingLamp:E,KeyToPrison:F,LovePendant:w,StatueOfOnyx:k},npcs:{Akahana:M,AkahanaInBrynmaer:N,Asina:J,AztecaInShyron:ie,Clark:re,Draygon:q,FortuneTeller:fe,Kensu:L,KensuInCabin:A,KensuInSwan:Ae,LeafElder:Pe,LeafRabbit:H,OakChild:he,OakElder:ue,OakMother:$e,PortoaPalaceFrontGuard:ct,PortoaQueen:ee,PortoaThroneRoomBackDoorGuard:Le,Rage:Je,Stom:Cs,StonedAkahana:ft,Tornel:St,WindmillGuard:Ct,Zebu:qe},flags:P}=r;L.localDialogs.delete(b.id),Ae.link(L.id),Ae.used=!0,Ae.data=[...L.data],L.data[0]=E.id,m.spawns.find(K=>K.isNpc()&&K.id===L.id).id=Ae.id,w.itemUseData[0].want=256|Ae.id,ft.linkDialog(M.id),N.used=!0,N.link(M.id),N.data=[...M.data],s.spawns.find(K=>K.isNpc()&&K.id===M.id).id=N.id,k.itemUseData[0].want=256|N.id,Pe.dialog(o).splice(0,0,...Pe.dialog(o).splice(2,1)),H.dialog()[2].condition=P.RescuedLeafElder.id,H.dialog()[2].flags.push(P.TalkedToLeafRabbit.id),H.dialog()[3].flags.push(P.TalkedToLeafRabbit.id),Ct.spawns(S)[1]=~P.WindmillGuardAlarmFluteTradein.id,wt(M.spawns(g),~P.BehindWhirlpool.id),wt(ft.spawns(g),~P.BehindWhirlpool.id);function _t(K){K.reverse();for(let xe=0;xe<K.length;xe++){let ht=K[xe+1];K[xe].condition=ht?~ht.condition:-1}}for(let K=0;K<4;K++){let xe=ue.dialog()[K];xe.condition!==r.flags.OakElder.id&&(xe.message.action=3)}(()=>{let[K,xe,ht,Nt]=$e.dialog();Nt.condition=~P.RescuedChild.id,xe.condition=-1,$e.dialog().splice(0,4,Nt,ht,K,xe)})();for(let K of[32,33,34,124,125])_t(r.npcs[K].dialog());he.dialog().unshift(...he.dialog().splice(1,1)),Le.spawnConditions.set(c.id,[~P.QueenNotInThroneRoom.id,~P.MesiaRecording.id]),ct.dialog()[1].condition=P.MesiaRecording.id,ee.dialog()[3].condition=P.SwordOfWater.id,ee.dialog()[3].message.action=3,ee.dialog()[4].flags.push(P.PortoaQueenGoingAway.id),ee.spawns(c)[1]=~P.MesiaRecording.id,ee.spawns(f)[0]=P.MesiaRecording.id,ee.dialog()[1].condition=P.MesiaRecording.id,fe.spawns(u)[1]=~P.MesiaRecording.id,re.spawnConditions.set(I.id,[~P.Clark.id]),re.spawnConditions.set(n.id,[P.Clark.id]),qe.localDialogs.set(x.id,[De.of(~P.TalkedToZebuInCave.id,[0,26],[P.TalkedToZebuInCave.id]),De.of(P.LeafVillagersRescued.id,[0,29]),De.of(P.LeafAbduction.id,[0,28]),De.of(P.ZebuAtWindmill.id,[0,29]),De.of(P.UsedWindmillKey.id,[0,27,3]),De.of(-1,[0,29])]),wt(qe.spawns(x),~P.BehindWhirlpool.id),St.spawnConditions.delete(l.id),Cs.spawnConditions.delete(p.id),wt(J.spawns(f),~P.CalmedAngrySea.id);let Be=r.npcs[52];Be.spawnConditions.set(c.id,[P.MesiaRecording.id,~P.PortoaQueen.id]),Be.localDialogs.set(d.id,Be.localDialogs.get(-1)),Be.data[0]=r.items.FluteOfLime.id;let kt=r.messages.alloc();kt.text="The queen left this for you.",Be.localDialogs.set(c.id,[De.of(~P.PortoaQueen.id,[kt.part,kt.id,3]),De.of(-1,[10,14])]),c.spawns.push(z.of({yt:3,xt:12,type:1,patternBank:1,id:Be.id})),ee.localDialogs.set(f.id,ee.dialog().splice(0,2)),ee.localDialogs.set(c.id,ee.dialog()),ee.localDialogs.delete(-1),A.spawnConditions.set(e.id,[~P.AbleToRideDolphin.id,P.ReturnedFogLamp.id]),A.dialog()[0].message.action=2,ie.spawns(h).push(~P.ShyronMassacre.id),r.trigger(130).conditions.push(~P.ShyronMassacre.id),r.bossKills.kensuLighthouse.data2[0]=0,Je.dialog()[0].condition=P.SwordOfWater.id,q.spawnConditions.set(i.id,[~P.Draygon2.id]),qe.dialog(h).unshift(...qe.dialog(h).splice(1,1)),r.trigger(128).conditions=[~P.ShyronMassacre.id,P.TalkedToZebuInShyron.id,P.SwordOfThunder.id],r.trigger(129).conditions=[],t.barrierRequiresCalmSea()&&r.trigger(132).conditions.push(P.CalmedAngrySea.id),r.trigger(140).conditions.push(P.TalkedToZebuInCave.id),r.trigger(141).used=!1;for(let K of a.spawns)K.isTrigger()&&K.id===141&&(K.id=178);dr(y.spawns,K=>K.isTrigger()&&K.id===141),r.trigger(178).conditions.push(P.Kelbesque1.id),r.trigger(178).flags.push(~P.LeafVillagersCurrentlyAbducted.id,~P.LeafElderCurrentlyAbducted.id,P.LeafVillagersRescued.id),r.trigger(140).conditions.push(~P.Kelbesque1.id),r.trigger(134).conditions.push(~P.Kelbesque1.id),wt(F.itemUseData[0].flags,~P.LeafVillagersCurrentlyAbducted.id),wt(F.itemUseData[0].flags,P.LeafVillagersRescued.id),ei(r.trigger(187).conditions,~P.Rage.id,~P.MesiaRecording.id)}function to(r){for(let t of[8,9,39])r.objects[t].collisionPlane=0}function so(r){for(let t of[16,20,24,29])r.objects[t].terrainSusceptibility&=-5,r.objects[t].level=2}function io(r){let{flags:{UsedBowOfTruth:t},locations:{Crypt_Draygon2:e,MezameShrine:s}}=r,i;for(let n of s.spawns)n.isTrigger()&&n.tile===136&&(i=r.trigger(n.id));if(!i)throw new Error("Could not find start trigger");i.flags.push(t.id),r.tileEffects[185-179].effects[88]=0,s.meta.setExit(0,"door",[e.meta.id<<8|16,"edge:bottom"])}function ro(r){r.objects[51].elements=15}function no(r){if(!r.patterns.get(5312,21).pixels.every(d=>d===0))return;let e=66<<6,s=[[28,21],[29,22],[30,23],[31,24],[58,25],[59,26],[60,27],[61,28],[62,29],[63,30]];s.forEach(d=>{r.patterns.set(5312,d[1],r.patterns.get(e,d[0]).pixels)});let i=108<<6;[[3,28],[4,29],[5,30],[6,31],[51,58],[52,59],[53,60],[54,61],[55,62]].forEach(d=>{let f=r.patterns.get(i,d[0]).pixels;for(let u=0;u<5;++u)r.patterns.set(e+(u<<6),d[1],f)});let o=128,a=170;r.metasprites[a].sprites.forEach(d=>{d.forEach(f=>{f[0]!=o&&(f[3]=f[3]-131+64+28)})});let l=144;for(let d=0;d<r.metasprites[l].sprites.length;d++)for(let f=0;f<r.metasprites[l].sprites[d].length;f++){let u=r.metasprites[l].sprites[d][f];u[0]!=o&&(console.log(`setting sprite tile ${(u[3]-179+58).toString(16)}`),r.metasprites[l].sprites[d][f][3]=u[3]-179+58)}let c=203;r.metasprites[c].sprites.forEach(d=>{for(let f=0;f<d.length;f++){let u=d[f],h=s[f][0],p=s[f][1];u[0]!=o&&(u[3]=u[3]-64-h+64+p)}})}function oo(r){r.tileEffects[181-179].effects[116]=6,r.tileEffects[182-179].effects[70]=6}function ao(r){for(let t of r.objects)t instanceof He&&(t.isProjectile()||t.isBoss()||t.isFlyer()||t!==r.objects.mimic&&(t.terrainSusceptibility|=3))}function ei(r,t,e){for(let s=0;s<r.length;s++)if(r[s]===t){r[s]=e;return}throw new Error(`Could not find ${t} in ${r.join(",")}`)}function lo(r){for(let t of r.locations)t.checkpoint=t.saveable=!1}function co(r){ei(r.wildWarp.locations,100,105)}function wt(r,t){let e=r.indexOf(t);if(e<0)throw new Error(`Could not find element ${t} in ${r}`);r.splice(e,1)}function dr(r,t){let e=r.findIndex(t);if(e<0)throw new Error(`Could not find element in ${r}`);r.splice(e,1)}function cr(r,t,e){if(!t.randomizeTrades())return;let{items:{StatueOfOnyx:s,FogLamp:i,LovePendant:n,KirisaPlant:o,IvoryStatue:a},locations:{Swan_DanceHall:l,PortoaPalace_ThroneRoom:c},npcs:{KensuInSwan:d}}=r,f=new Map,u=[[s,0,"Akahana"],[i,0,"Fisherman"],[n,0,"Kensu"],[o,0,"Aryllis"],[a,0,"Slimed Kensu"]],h=u.map(([b,S,g])=>{if(b.trades.indexOf(S)<0||S>=b.itemUseData.length)throw new Error(`not a trade: ${b} ${S}`);return[b.itemUseData[S],b.id,g]});e.shuffle(h);for(let[b,S]of u){let[g,y,x]=h.pop();b.itemUseData[S]=g,r.spoiler&&r.spoiler.addTrade(b.id,b.messageName,x),g.want===356&&t.fogLampNotRequired()&&([...r.npcs[100].spawnConditions.values()][0][0]=512|b.id),f.set(y,b.id)}r.itemGets.actionGrants=new Map([...r.itemGets.actionGrants].map(([b,S])=>[f.get(b)??b,S]));let p=r.items[e.nextInt(4)];r.npcs[195].localDialogs.get(-1)[0].condition=512|p.id,r.spoiler&&r.spoiler.addTrade(p.id,p.messageName,"Rage"),r.npcs.PortoaQueen.dialog(c)[1].condition=512|p.id;let m=r.items[e.nextInt(4)*2+6];for(let b of r.npcs[95].localDialogs.values())for(let S=2;S<b.length;S++)if(b[S].message.action===3){b[S-2].condition=~(512|m.id-1),b[S-1].condition=~(512|m.id),r.spoiler&&r.spoiler.addTrade(m.id,m.messageName,"Tornel");break}d.dialog(l)[0].message.mid="13:00"}function fr(r){let t=new Map;for(let e of r.items)for(let s of e.trades)t.set(e.itemUseData[s].want&255,e.id);return t}function ur(r){let{flags:{AkahanaStatueOfOnyxTradein:t,AsinaInBackRoom:e,BehindWhirlpool:s,KensuInSwan:i,MtSabreNorthSummit:n,MtSabreWestTornel:o,PortoaQueen:a,Rage:l,RepairedStatue:c,SlimedKensu:d,StomFightReward:f,UndergroundChannelUnderwaterChest:u,ZebuAtWindmill:h},npcs:{AkahanaInBrynmaer:p,Aryllis:m,Fisherman:b,PortoaQueen:S},locations:{PortoaPalace_ThroneRoom:g}}=r;A("03:06",",","");let y=fr(r);function x(H){let he=y.get(H.id);if(!he)throw new Error(`No trade-in for ${H.name}`);return r.items[he]}h.item.isMagic()||fe("00:1b"),A("00:1b","[41:Refresh]",L(h.item));let I=x(p);A("02:01","an unusual statue",hr(I)),A("02:02","a statue",`the ${bs(I)}`),A("02:02","[29:Gas Mask]",L(t)),f.item.isMagic()||fe("03:01"),A("03:01","[43:Telepathy]",L(f));let E=uo(r);A("03:01","[06:Tornado Bracelet]",L(E)),A("05:0a","[06:Tornado Bracelet]",L(E)),A("05:0a","[44:Teleport]",L(o));let F=x(b);A("09:01","[35:Fog Lamp]",L(F)),A("09:04","[35:Fog Lamp]",L(F)),A("09:05","[35:Fog Lamp]",L(F)),A("09:06","lamp",bs(F));let w=S.dialog(g)[1].condition;A("0a:0c","[28:Flute of Lime]",L(a)),A("0a:0d","[02:Sword of Water]",L(w)),e.item.isMagic()||fe("0b:01"),A("0b:01","[45:Recover]",L(e)),s.item.isMagic()||(fe("0b:01"),fe("1d:12")),A("0b:01","[46:Barrier]",L(s)),A("1d:12","[46:Barrier]",L(s));let k=Ae(79,78,77,76,71,70,69,68,75,74,73,72);k?A("0d:00","[35:Fog Lamp]",L(k)):A("0d:00","that a [35:Fog Lamp] was","there was treasure");let M=r.npcs.Rage.dialog()[0].condition;A("0e:03","[02:Sword of Water]",L(M)),A("0e:03","[09:Ball of Water]",L(l)),A("10:0c","that's","is"),A("10:0c",/, is in the\+lighthouse/,"");let N=x(m);A("12:05","[3c:Kirisa Plant]",L(N)),A("12:10","the plant",`the ${bs(N)}`),A("12:10","[3c:Kirisa Plant]",L(N));let J=`Our illustrious chief seeks ${hr(N)}.`;A("12:09",/[^]*/,J),A("12:0a",/[^]*/,J);let ie=x(r.npcs.KensuInSwan);A("13:02","[3b:Love Pendant]",L(ie)),A("13:00","pendant",bs(ie)),i.item.isMagic()||fe("13:02"),A("13:02","[47:Change]",L(i));let re=x(r.npcs.SlimedKensu);A("18:06","[3d:Ivory Statue]",L(re)),A("18:07","[3d:Ivory Statue]",L(re)),A("18:06","It's in a room","{0b:Karmine} is"),d.item.isMagic()||A("18:07","teach","give"),A("18:07","[48:Flight]",L(d)),n.item.isMagic()||fe("1c:10"),A("1c:10","[42:Paralysis]",L(n)),A("20:06","Statue of Gold",L(c));let q=r.allocatedTriggers.get("channel item");q!=null&&A(r.trigger(q).message.mid,"[3b:Love Pendant]",L(u));{let H=r.messages.alloc();r.trigger(134).message.mid=H.mid,H.text="{:HERO:}, there's nothing to see here! Return to Zebu at once!",r.messages.parts[28][15].text="{:HERO:}, you cannot climb this yet! Seek out [44:Teleport] at once!"}function fe(H){A(H,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function L(H){return typeof H=="number"?H=r.items[r.itemGets[H&255].itemId]:H instanceof Mi||(H=H.item),`[${V(H.id)}:${H.messageName}]`}function A(H,he,ue){let[$e,ct]=H.split(":").map(Le=>parseInt(Le,16)),ee=r.messages.parts[$e][ct];ee.text=ee.text.replace(he,ue)}function Ae(...H){let he=[ue=>fo.has(ue),ue=>ho.has(ue),ue=>Pe(ue).unique];for(let ue of he)for(let $e of H){let ee=[...r.locations[$e].spawns].reverse();for(let Le of ee){if(!Le.isChest())continue;let Je=r.slots[Le.id];if(Je<=72&&ue(Je))return r.items[Je]}}}function Pe(H){let he=r.itemGets[H];return r.items[he.itemId]}}var fo=new Set([62,63,64]),ho=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function uo(r){let{Tornel:t}=r.npcs;for(let e of t.localDialogs.values())for(let s=2;s<e.length;s++){let i=~e[s].condition;if(i>516&&i<=524&&!(i&1))return r.items[i&255]}return r.items.TornadoBracelet}function hr(r){let t=r.rom.items;switch(r){case t.StatueOfOnyx:return"an unusual statue";case t.FluteOfLime:return"a rare instrument";case t.FogLamp:return"a brilliant lamp";case t.LovePendant:return"a beautiful charm";case t.KirisaPlant:return"a fragrant plant";case t.IvoryStatue:return"an exotic statue"}return Fs(),"a valuable item"}function bs(r){let t=r.rom.items;switch(r){case t.StatueOfOnyx:return"statue";case t.FluteOfLime:return"instrument";case t.FogLamp:return"lamp";case t.LovePendant:return"pendant";case t.KirisaPlant:return"plant";case t.IvoryStatue:return"statue"}return Fs(),"item"}function pr(r){let{locations:{Portoa:t,PortoaPalace_ThroneRoom:e,Portoa_PalaceEntrance:s,UndergroundChannel:i,WaterfallCave2:n,WaterfallCave3:o}}=r;ti(s,"edge:bottom",183,t),ti(e,"door",146,i),ti(n,"stair:up",191,o),po(r)}function ti(r,t,e,s){let[i,...n]=[...r.meta.exits()].filter(([,b])=>b===t);if(!i)throw new Error(`Could not find ${t} in ${r}`);if(n.length)throw new Error(`Ambiguous ${t} in ${r}`);let[o,a]=i[2],l=o>>>8;if(l===s.id)return;let c=o&255,d=r.rom.locations[l],u=d.meta.get(c).data.exits.find(b=>b.type===a);if(!u)throw new Error(`Bad entrance in ${d}`);let h=((u.entrance&61440)>>>8|(u.entrance&240)>>>4)+mo[u.dir];d.spawns.length>17&&d.spawns.pop();let p=s.spawns.findIndex(b=>b.isTrigger()&&b.id===e),m=p>=0?s.spawns.splice(p,1)[0]:z.of({type:2,id:e});m.xt=(c&15)<<4|h&15,m.yt=c&240|h>>>4,d.spawns.push(m)}var mo=[16,0,0,0];function po(r){let{locations:{MtSabreNorth_Main:t,ValleyOfWind:e}}=r;for(let s of mr(e,17)){let i=r.locations[s>>>8],n=s&255;ws(i,n,r.flags.OpenedSealedCave)}for(let s of mr(t,4)){let i=r.locations[s>>>8];if(i.data.fixed||i.spawns.length>15)continue;let n=s&255;ws(i,n,r.flags.OpenedPrison);let o=i.meta.get(n).findExitByType("cave").entrance,a=z.of({screen:n,coord:o,type:2,id:173});if(i.spawns.push(a),i.spawns.length>15)continue;let l=z.of({screen:n,coord:o-4112,type:4,id:44});i.spawns.splice(1,0,l)}}function mr(r,t){let e=new Set([r,r.id<<8|t]),s=new Set;for(let n of r.meta.exits())n[0]===t&&(n[1]==="cave"||n[1]==="gate")&&s.add(n[2]);let i=[];for(let n of s){if(e.has(n[0]))continue;let o=r.rom.locations[n[0]>>>8],a=n[0]&255;if(!o.meta.customFlags.has(a)){if(n[1]==="cave"||n[1]==="gate"){let l=o.meta.get(a);l.flag==="custom:true"?i.push(n[0]):console.error(`No flag for ${l.name}`);continue}if(!e.has(o)){e.add(o);for(let l of o.meta.exits())l[1]==="cave"||l[1]==="gate"||s.add(l[2])}}}return console.log(`From ${r}: ${i.map(n=>n.toString(16))}`),i}function ws(r,t,e,s){e?r.meta.customFlags.set(t,e):r.meta.customFlags.delete(t),!s&&(r===r.rom.locations.CordelPlainEast?ws(r.rom.locations.CordelPlainWest,t,e,!0):r===r.rom.locations.CordelPlainWest&&ws(r.rom.locations.CordelPlainEast,t,e,!0))}function xr(r){xo(r)}function xo(r){let{locations:{AngrySea:t},npcs:{Dolphin:e},metascreens:{beachCabinEntrance:s,beachCave:i,beachExitN:n,boatChannel:o}}=r;e.spawnScripts=[];let a=new Set(te(16,l=>l));for(let l=0;l<t.entrances.length;l++){let c=t.entrances[l],d=t.meta.get(c.screen),f;if(d===o){if(t.meta.get(c.screen-1)!==s)throw new Error(`Bad boatChannel entrance ${c}`);c=Qe.of({screen:c.screen-1,tile:0}),d=s}d===s?f={entrance:Qe.of({screen:c.screen-17,coord:47336}),movement:5}:d===i?f={entrance:Qe.of({screen:c.screen,coord:59400}),movement:8}:d===n&&(f={entrance:Qe.of({screen:c.screen,coord:55544}),movement:9}),f&&(a.delete(l),e.spawnScripts[l]=f)}[e.channelSpawn,e.evilSpiritIslandSpawn]=a,e.spawnScripts[e.channelSpawn]={entrance:Qe.of({x:424,y:120}),movement:6},e.spawnScripts[e.evilSpiritIslandSpawn]={entrance:Qe.of({x:424,y:120}),movement:7}}function br(r){let t=new Set;for(let e of r.locations)for(let s of e.pits??[])t.add(s.dest<<8|s.toScreen);for(let e of t){let s=r.locations[e>>8],i=e&255,n=s.exits.filter(d=>d.screen===i),o=s.entrances.filter(d=>d.screen===i),a=new Map(n.map(d=>[d.tile,d])),l=new ge;for(let d of a.keys())for(let f of gr)a.has(d+f)&&l.union([d,d+f]);let c=l.map();for(let d of o)for(let f of gr){let u=c.get(d.tile+f);for(let h of u??[]){let p=a.get(h),m=Ri.of({screen:e&255,tile:h+f,dest:p.dest,entrance:p.entrance});s.exits.push(m)}}}}var gr=[1,-1,16,-16];function wr(r,t){let e=[...r.townWarp.locations].filter(l=>l!==255),s=t.nextInt(e.length),i=e[s],n=64;(i===r.locations.Shyron.id||i===r.locations.Shyron_Temple.id)&&(n=65),r.townWarp.thunderSwordWarp=[i,n];let o=768-e.length+s,a=r.itemGets[3].flags;for(let l=0;l<a.length;l++)if(a[l]===765){a[l]=o;return}a.push(o)}function yr(r,t,e){let s=new Set(te(256,o=>o).filter(o=>o in r.objects));for(let[o]of dt)s.delete(o);for(let[o,a]of dt)for(let l of s)r.objects[o].base===r.objects[l].base&&(dt.set(l,a),s.delete(o));for(let o of[200,249,250])r.objects[o].attackType=o>240?254:255,r.objects[o].statusEffect=0;r.objects[125].elements|=8;let i=new Set([87,94,104,125,136,151,155,158]),n=new Set([80,83,95,105]);for(let[o,{sdef:a,swrd:l,hits:c,satk:d,dgld:f,sexp:u}]of dt){let h=r.objects[o].data,p=i.has(o)?1:0;if(h[2]|=128,h[6]=c,h[7]=d,h[8]=a|l<<4,h[16]=h[16]&15|f<<4,h[17]=u,(p?t.shuffleBossElements():t.shuffleMonsterElements())&&!n.has(o)){let m=[...r.objects[o].elements.toString(2).padStart(4,"0")];e.shuffle(m),r.objects[o].elements=Number.parseInt(m.join(""),2)}}if(t.shuffleMonsterElements()){let o=e.nextInt(4);for(let a of n)r.objects[a].elements=1<<o}}var dt=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([r,t,e,s=0,i=0,n=0,o=0,a=0,l=0])=>[r,{id:r,type:t,name:e,sdef:s,swrd:i,hits:n,satk:o,dgld:a,sexp:l}]));function go(r){console.log("flip sabera entrance");let t=r[0];t.set2d(113,[[t.rom.metascreens.deadEndE_upStair],[t.rom.metascreens.caveEmpty]]),t.moveExits([129,"stair:down",113,"stair:up"]),r[1]=113,r[2]="stair:up"}function bo(r,t){console.log("flip karmine entrance");let e=r[0],s=e.rom.metascreens;e.set2d(32,[[s.caveEmpty,s.hallNS],[s.deadEndE_upStair,s.hallNW]]),e.replaceMonsters(t),e.moveExits([48,"stair:down",48,"stair:up"]),r[2]="stair:up"}function wo(r){console.log("flip karmine exit");let t=r[0],e=t.rom.metascreens;t.set2d(1,[[e.deadEndS_stairs,e.caveEmpty]]),t.moveExits([2,"stair:down",1,"stair:up"]),r[1]=1,r[2]="stair:up"}function si(r){console.log("flip generic exit");let t=r[0],e=t.rom.metascreens;t.width<2&&(t.width=2),t.set2d(0,[[e.hallSE,e.deadEndW_downStair]]),t.moveExits([0,"stair:up",1,"stair:down"]),r[1]=1,r[2]="stair:down"}function ii(r,t){r[3](r,t),r[3]=void 0}function Sr(r,t){let e=r.locations,s=[0,1,2,3];t.shuffle(s);let i=[[e.GoaFortress_Kelbesque.meta,131,"stair:down"],[e.GoaFortress_Sabera.meta,129,"stair:down",go],[e.GoaFortress_Mado1.meta,114,"stair:down"],[e.GoaFortress_Karmine1.meta,48,"stair:down",bo]],n=[[e.GoaFortress_Zebu.meta,0,"stair:up",si],[e.GoaFortress_Tornel.meta,0,"stair:up",si],[e.GoaFortress_Asina.meta,0,"stair:up",si],[e.GoaFortress_Kensu.meta,2,"stair:down",wo]],o=[[e.GoaFortress_Entrance.meta,0,"edge:top"]],a=[],l=!0,c=o[0];for(let d of s){let f=l||i[d][3]||o[o.length-1][3],u=f?t.pick([!1,!0]):!0;console.log(`FLOOR ${d}: up ${l} flexible ${!!f} reverse ${u}`);let h=u?n[d]:i[d];console.log(`push b ${r.locations[h[0].id].name}`),a.push(h),l!==(h[2]==="stair:down")&&(h[3]?ii(h,t):ii(c,t)),o.push(c=u?i[d]:n[d]),console.log(`push a ${r.locations[c[0].id].name}`),l=c[2]==="stair:up"}l&&ii(c,t),a.push([e.GoaFortress_Exit.meta,1,"stair:up"]);for(let d=0;d<o.length;d++)o[d][0].attach(o[d][1],a[d][0],a[d][1],o[d][2],a[d][2])}var yo=6,So=33,ri=new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]),Co=new Set(["inn","armor","tool","pawn"]),Cr=new Set([...Co,"house","tavern"]);function kr(r,t,e){let{locations:{Crypt_Hall1:s,Goa:i,GoaFortress_Exit:n,Shyron:o},metascreens:{squareTownNE_house:a,fortressTownEntrance:l,mountainPathE_gate:c}}=r,d=new Set([i.id,o.id]),f=new Set([a.data.id,l.data.id,c.data.id]);if(t.shuffleAreas())for(let y of[i,n,o,s])y.data.houseType="palace";let u=new _(()=>[]),h=new _(()=>[]),p=new _(()=>new Set);for(let y of r.locations){if(!y.used||y.data.houseType==null)continue;let x;for(let[I,E,F]of y.meta.exits()){let w=(I&240)<<4|y.meta.get(I).findExitByType(E).entrance>>>8;(!x||w>x[3])&&(x=[I,E,F,w])}for(let[I,E,F]of[x]){let w={type:y.data.houseType,inside:[y.id<<8|I,E],outside:F},k=F[0];h.get(k).push(w),u.get(y.data.houseType).push(w);let M=r.locations[k>>>8].screens[k>>>4&15][k&15];p.get(M).add(k)}}let m=new Map,b=new Map;for(let[y,x]of e.ishuffle(p))x.size>=2||f.has(y)?b.set(y,x):m.set(y,x);let S=new Set,g=u.get("inn");for(let[,y]of[...b,...m]){let x=new Map,I=!0;for(let E of y){for(let F of h.get(E)){let w=I&&Cr.has(F.type)?[...Cr].map(L=>u.get(L)):[u.get(x.get(F.outside[1])??F.type)];w=w.filter(L=>L.length),F.type==="palace"&&d.has(F.outside[0]>>>8)&&(w=w.map(L=>L.filter(A=>!d.has(A.inside[0]>>>8))));let k=[...y].every(L=>!S.has(L>>>8));!k&&w.length>1?w=w.filter(L=>L!==g):k&&w.some(L=>L===g)&&(w=[g]);let M=e.pickAndRemove(...w);if(M.type==="inn")for(let L of y)S.add(L>>>8);if(x.set(F.outside[1],M.type),r.spoiler&&r.spoiler.addHouse(M.inside[0]>>>8,F.outside[0]>>>8),be.connect(r,F.outside,M.inside),!I||ri.get(F.type)===ri.get(M.type))continue;let N=r.locations[F.outside[0]>>>8];if(N.meta.tileset!==r.metatilesets.town)continue;let J=be.findExitTiles(r,F.outside);if(J.length>1)continue;let ie=J[0]-32;(J[0]&240)<32&&(ie-=3856);let re=ie>>8,q=ie&255,fe=ri.get(M.type)??(N.meta.get(re).data.tallHouses?.includes(q)?So:yo);r.screens[N.screens[re>>4][re&15]].tiles[q]=fe}I=!1}}}function vr(r,t,e){let s=[],i=[];for(let n of r.locations)for(let o of n.spawns)if(o.isChest()){let a=r.slots[o.id];if(a>=112&&i.push(o.id),t.preserveUniqueChecks()){let l=r.itemGets[a];if(r.items[l?.itemId]?.unique)continue}if(o.isInvisible())continue;s.push(o.id)}e.shuffle(s),r.slots.setMimicCount(i.length),[...se.zip(i,s,(n,o)=>r.slots.swap(n,o))]}function Ir(r,t){for(let e of r.locations)(e.id&248)!==88&&e.meta.replaceMonsters(t)}var ys=class{constructor(t){this.rom=t;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;let e=new _(()=>[]);for(let s of t.locations)if(!!s.used)for(let i=0;i<s.spawns.length;i++){let n=s.spawns[i];!n.used||(n.isMonster()?e.get(n.monsterId).push([s,i,n]):(n.isNpc()||n.isBoss())&&e.get(~n.id).push([s,i,n]))}for(let[s,i]of e)if(s<0){let n=t.npcs[~s],o=[n.data[3]];if(!t.metasprites[o[0]])throw new Error(`bad NPC: ${~s}`);n.data[2]===208&&o.push(192);let l=n.data[2]<128?n.data[2]&112:0,c=this.computeConstraint(o,i,!0,l);~s===95&&(c=c.ignorePalette()),this.npcConstraints.set(~s,c)}else{let n=me.ALL,o=this.rom.objects[s];for(let a of ni(t,o)){let c=t.objectActions[a.action]?.data.metasprites||(()=>[a.metasprite]),d=this.computeConstraint(c(a),i,a.id===s,a.data[1]),f=n.meet(d);if(!f)throw new Error(`Bad meet for ${s} with ${a.id}`);if(f&&(n=f),a.data[4]&2){let u=this.computeConstraint([a.data[20]],i,!1,a.data[1]),h=n.meet(u);if(!h)throw new Error(`Bad meet for ${s} bonus ${a.id}`);n=h}}this.monsterConstraints.set(o.id,n),o.constraint=n}}getMonsterConstraint(t,e){let s=this.monsterConstraints.get(e)||me.NONE;return(t&88)===88||!this.rom.objects[e].goldDrop?s:s.meet(me.COIN)||me.NONE}getNpcConstraint(t,e){let s=this.npcConstraints.get(e)||me.NONE;return t===30&&e===96?s.meet(me.STOM_FIGHT):t===160&&e===201?s.meet(me.GUARDIAN_STATUE):s}shufflePalettes(t){let e=[...this.allSpritePalettes];for(let[s,i]of this.monsterConstraints)this.monsterConstraints.set(s,i.shufflePalette(t,e));for(let[s,i]of this.npcConstraints)this.npcConstraints.set(s,i.shufflePalette(t,e))}configure(t,e){if(!e.used)return;let s=e.isMonster()?this.monsterConstraints.get(e.monsterId):e.isNpc()?this.npcConstraints.get(e.id):void 0;if(!!s){if(s.shift===3||s.float.length>=2)throw new Error("don't know what to do with two floats");if(!s.float.length)e.patternBank=Number(s.shift===2);else if(s.float[0].has(t.spritePatterns[0]))e.patternBank=0;else if(s.float[0].has(t.spritePatterns[1]))e.patternBank=1;else if(e.isMonster())throw new Error("no matching pattern bank")}}computeConstraint(t,e,s,i=0){let n=new Set,o=new Set;for(let c of t.map(d=>this.rom.metasprites[d])){for(let d of c.palettes())o.add(d);for(let d of c.patternBanks(i))n.add(d)}s=s&&n.size==1&&[...n][0]===2;let a=new Map;for(let[c,,d]of e)a.set(d.patternBank&&s?~c.id:c.id,d);let l;for(let[c,d]of a){let f=this.rom.locations[c<0?~c:c];for(let h of o)h>1&&this.allSpritePalettes.add(f.spritePalettes[h-2]);let u=me.fromSpawn(o,n,f,d,s);l=l?l.join(u):u,!s&&d.patternBank&&(l=l.shifted())}if(!l)throw new Error("Expected child to appear");return l}};function*ni(r,t){yield t;let e=t.spawnedReplacement();e&&(yield*ni(r,e));let s=t.spawnedChild();s&&(yield*ni(r,s)),t.id===80&&(yield r.objects.largeBlueSlime),t.id===83&&(yield r.objects.largeRedSlime)}function Rr(r,t,e){let s=new ys(r);t.shuffleSpritePalettes()&&s.shufflePalettes(e);let i=new ai(t,{});for(let n of r.locations)n.used&&i.populate(n);i.shuffle(e,s)}var ai=class{constructor(t,e){this.flags=t;this.report=e;this.monsters=[];this.used=[];this.locations=[]}populate(t){let{maxFlyers:e=0,nonFlyers:s={},skip:i=!1,tower:n=!1,fixedSlots:o={},...a}=Er[t.id]||{};for(let u of Object.keys(a))throw new Error(`Unexpected property '${u}' in MONSTER_ADJUSTMENTS[${t.id}]`);let l=i===!0||!this.flags.shuffleTowerMonsters()&&n||!t.spritePatterns||!t.spritePalettes,c=[],d=[],f=12;for(let u of l?[]:t.spawns){if(++f,!u.used||!u.isMonster())continue;let h=u.monsterId;if(!dt.has(h)||dt.get(h).type!=="m")continue;let p=t.rom.objects[h];if(!(p instanceof He))continue;let m=u.patternBank,b=t.spritePatterns[m],S=p.palettes(!0),g=S.includes(2)?t.spritePalettes[0]:void 0,y=S.includes(3)?t.spritePalettes[1]:void 0;c.push({id:h,pat:b,pal2:g,pal3:y,patBank:m}),(this.report[`start-${h.toString(16)}`]=this.report[`start-${h.toString(16)}`]||[]).push("$"+t.id.toString(16)),d.push(f)}(!c.length||i)&&(d=[]),this.locations.push({location:t,slots:d}),this.monsters.push(...c)}shuffle(t,e){let s=e.rom;for(this.report["pre-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["pre-shuffle monsters"]=this.monsters.map(i=>i.id),t.shuffle(this.locations),t.shuffle(this.monsters),this.report["post-shuffle locations"]=this.locations.map(i=>i.location.id),this.report["post-shuffle monsters"]=this.monsters.map(i=>i.id);this.locations.length;){let{location:i,slots:n}=this.locations.pop(),o=this.report["$"+i.id.toString(16).padStart(2,"0")]=[],{maxFlyers:a=0,nonFlyers:l={},tower:c=!1}=Er[i.id]||{};if(c)continue;let d=a,f=me.forLocation(i.id);i.bossId()!=null;for(let m of i.spawns)if(!(m.isChest()&&!m.isInvisible()))if(m.isNpc()||m.isBoss()){let b=e.getNpcConstraint(i.id,m.id);f=f.meet(b,!0),m.isNpc()&&(m.id===107||m.id===104)&&(f=f.meet(me.KENSU_CHEST,!0))}else if(m.isMonster()&&!(s.objects[m.monsterId]instanceof He)){let b=e.getMonsterConstraint(i.id,m.monsterId);f=f.meet(b,!0)}else m.isShootingWall(i)&&(f=f.meet(me.SHOOTING_WALL,!0));o.push(`Initial pass: ${f.fixed.map(m=>m.size<1/0?"["+[...m].join(", ")+"]":"all")}`);let u=new Map,h=m=>{let b=s.objects[m.id];if(b.monsterClass){let k=u.get(b.monsterClass);if(k!=null&&k!==m.id)return!1}let S=oi.has(m.id),g=ko.has(m.id);if(S){if(!d)return!1;--d}let y=e.getMonsterConstraint(i.id,m.id),x=f.tryMeet(y);if(!x&&f.pal2.size<1/0&&f.pal3.size<1/0&&this.flags.shuffleSpritePalettes()&&(x=f.tryMeet(y,!0)),!x)return!1;let I;if(p){let k=s.objects[m.id];if(!(k instanceof He))throw new Error(`non-monster: ${k}`);if(I=p(k),I==null)return!1}o.push(`  Adding ${m.id.toString(16)}: ${x}`),f=x,b.monsterClass&&u.set(b.monsterClass,m.id);let E=0;if(S||g){for(let k=0;k<n.length;k++)if(n[k]in l){E=k;break}}else for(let k=0;k<n.length;k++)if(!(n[k]in l)){E=k;break}(this.report[`mon-${m.id.toString(16)}`]=this.report[`mon-${m.id.toString(16)}`]||[]).push("$"+i.id.toString(16));let F=n[E],w=i.spawns[F-13];return S?(w.data[0]=253,w.data[1]=255):p?(w.screen=I>>>8,w.tile=I&255):F in l&&(w.y+=l[F][0]*16,w.x+=l[F][1]*16),w.monsterId=m.id,o.push(`    slot ${F.toString(16)}: ${w}`),n.splice(E,1),!0},p=i.monstersMoved||n.length&&this.flags.randomizeMaps()?i.monsterPlacer(t):null;if(d&&n.length)for(let m=0;m<Math.min(40,this.monsters.length);m++)oi.has(this.monsters[m].id)&&h(this.monsters[m])&&this.monsters.splice(m,1);for(let m=0;m<this.monsters.length&&n.length;m++)if(h(this.monsters[m])){let[b]=this.monsters.splice(m,1);oi.has(b.id)||this.used.push(b),m--}for(let m=0;m<this.used.length&&n.length;m++)h(this.used[m])&&(this.used.push(...this.used.splice(m,1)),m--);if(f.fix(i,t),n.length){console.error(`Failed to fill location ${i.id.toString(16)} ${i.name}: ${n.length} remaining`);for(let m of n){let b=i.spawns[m-13];b.x=b.y=0,b.id=176,b.data[0]=254}}for(let m of i.spawns)e.configure(i,m)}}},oi=new Set([89,92,110,111,129,138,163,196]),ko=new Set([85,93,124,188,193]),Er={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};function di(r,t,e){new li(r,t,e).shuffle()}var li=class{constructor(t,e,s){this.rom=t;this.flags=e;this.random=s}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){let t=new _(()=>[]);for(let s of this.rom.locations)!s.tilePalettes.some(i=>i!==154)||t.get(s.colorGroup).push(s);let e=[new Map,new Map];for(let s of t.values())for(let i of s)for(let n=0;n<2;n++)for(let o=0;o<2;o++){let a=e[n].get(i.tilePatterns[o]);a||e[n].set(i.tilePatterns[o],a=new Set),a.add(i.tilePalettes[n])}for(let s of t.values()){let i=s[0],n=[new Set,new Set];for(let l=0;l<2;l++)n[l]=new Set([...e[l].get(i.tilePatterns[0]),...e[l].get(i.tilePatterns[1])]);let o=this.random.pick([...n[0]]),a=this.random.pick([...n[1]]);for(let l of s)l.tilePalettes[0]=o,l.tilePalettes[1]=a}}};function yt(r,t){t.eastCave?vo(r,t.eastCave):t.classicLimeTreeToLeaf&&Io(r),Eo(r),Ro(r),Fo(r),Go(r),To(r)}(t=>{function r(e,s){let i={};if(e.addEastCave()){i.eastCave={};let n=["cordel","lime","goa","desert"],o=s.nextInt(4);[i.eastCave.exit1]=n.splice(o,1),i.eastCave.exit2=s.pick(n)}else e.connectLimeTreeToLeaf()&&(i.classicLimeTreeToLeaf=!0);return i}t.generateOptions=r})(yt||(yt={}));function vo(r,t){let{locations:{EastCave1:e,EastCave2:s,EastCave3:i,SealedCave1:n,ValleyOfWind:o},metascreens:{boundaryE_cave:a,branchNSE:l,branchNWE:c,branchNWSE:d,branchNWS:f,branchWSE:u,caveEmpty:h,deadEndE:p,deadEndE_downStair:m,deadEndE_upStair:b,deadEndN_stairs:S,deadEndS:g,deadEndS_stairs:y,deadEndW:x,deadEndW_downStair:I,hallNE:E,hallNS:F,hallNW:w,hallSE:k,hallWS:M,hallWE:N,hallNS_entrance:J,hallNS_ramp:ie,hallNS_wall:re}}=r;r.locations.allocate(e),r.locations.allocate(s),t.exit2&&r.locations.allocate(i);for(let q of[e,s,i])q.bgm=q.originalBgm=23,q.entrances=[],q.exits=[],q.pits=[],q.spawns=[],q.flags=[],q.width=q.height=1,q.screens=[[128]],q.tilePalettes=[26,27,5],q.originalTilePalettes=[26,27,5],q.tileset=136,q.tileEffects=181,q.tilePatterns=[20,2],q.spritePatterns=[...n.spritePatterns],q.spritePalettes=[...n.spritePalettes];e.meta=new be(e.id,r.metatilesets.cave,5,5),e.meta.set2d(0,[[p,M,h,k,x],[h,F,k,w,h],[k,d,f,h,h],[F,ie,E,N,M],[J,E,x,b,w]]),s.meta=new be(s.id,r.metatilesets.cave,5,5),s.meta.set2d(0,[[p,M,g,h,g],[h,F,F,h,F],[h,l,c,u,w],[h,ie,h,E,M],[p,w,h,h,S]]),o.meta.set2d(51,[[a]]),r.tileEffects[0].effects[192]=0,e.meta.attach(67,s.meta,68),e.meta.attach(64,o.meta,51),t.exit1&&(e.meta.set2d(4,[[I]]),Tr(e,4,t.exit1)),t.exit2&&(i.meta=new be(i.id,r.metatilesets.cave,3,1),i.meta.set2d(0,[[y],[re],[J]]),i.spawns.push(z.from([24,7,35,0])),i.flags.push(Ti.of({screen:16,flag:r.flags.alloc(512)})),s.meta.set2d(64,[[m]]),s.meta.attach(64,i.meta,0),Tr(i,32,t.exit2)),e.spawns.push(z.of({screen:33,tile:135,timed:!0,id:2}),z.of({screen:18,tile:136,timed:!1,id:2}),z.of({screen:19,tile:137,timed:!0,id:2}),z.of({screen:50,tile:104,timed:!1,id:2}),z.of({screen:65,tile:136,timed:!0,id:2}),z.of({screen:51,tile:152,timed:!0,id:2}),z.of({screen:3,tile:136,timed:!0,id:2})),s.spawns.push(z.of({screen:1,tile:136,timed:!0,id:2}),z.of({screen:17,tile:72,timed:!1,id:2}),z.of({screen:18,tile:119,timed:!0,id:2}),z.of({screen:20,tile:40,timed:!1,id:2}),z.of({screen:35,tile:133,timed:!0,id:2}),z.of({screen:49,tile:136,timed:!0,id:2}),z.of({screen:51,tile:138,timed:!1,id:2}),z.of({screen:52,tile:152,timed:!0,id:2}),z.of({screen:65,tile:130,timed:!0,id:2}),z.of({y:272,x:1144,type:2,id:89}),z.of({y:112,x:264,type:2,id:124})),r.slots.swap(49,89)}function Tr(r,t,e){let{locations:{CordelPlainEast:s,CordelPlainWest:i,Desert2:n,GoaValley:o,LimeTreeValley:a},metascreens:{bendNE:l,bendSE:c,boundaryN_trees:d,boundaryW_cave:f,cornerNE:u,cornerNW:h,cornerSE:p,cornerSE_cave:m,cornerSW:b}}=r.rom,S,g;switch(e){case"lime":S=a,g=16,S.resizeScreens(0,1,0,0),S.meta.spliceColumns(0,1,2,[[h,d],[f,c],[b,p]]);break;case"cordel":let y=[[f,c],[b,p]];S=s,g=85,S.meta.set2d(85,y),i.meta.set2d(85,y);break;case"goa":S=o,g=17,S.meta.set2d(1,[[h,u],[f,l]]);break;case"desert":S=n,g=83,S.meta.set2d(83,[[m]]);break}r.meta.attach(t,S.meta,g)}function Io(r){let{locations:{ValleyOfWind:t,LimeTreeValley:e},metascreens:{exitE:s,exitW_southwest:i,overworldEmpty_alt:n}}=r;t.meta.set2d(84,[[s]]),e.meta.set2d(16,[[i],[n]]),t.meta.attach(84,e.meta,16)}function Eo(r){let{TowerEntrance:t,Crypt_Teleporter:e}=r.locations;e.meta.attach(0,t.meta,0,"teleporter","teleporter")}function Ro(r){let{flags:{OpenedSwanGate:t},locations:{SwanGate:e},npcs:{SoldierGuard:s}}=r;e.spawns.push(z.of({xt:10,yt:2,type:1,id:45}),z.of({xt:11,yt:2,type:1,id:45})),s.localDialogs.get(e.id)[0].flags.push(t.id)}function To(r){Mo(r.locations.SaberaPalace2_West,r.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}function Mo(r,t,...e){r.rom.locations.allocate(r,t),r.bgm=t.bgm,r.entrances=[],r.exits=[],r.pits=[],r.spawns=[],r.flags=[],r.width=r.height=1,r.screens=[[128]],r.tilePalettes=ut(t.tilePalettes),r.originalTilePalettes=ut(t.originalTilePalettes),r.tileset=t.tileset,r.tileEffects=t.tileEffects,r.tilePatterns=ut(t.tilePatterns),r.spritePatterns=ut(t.spritePatterns),r.spritePalettes=ut(t.spritePalettes);let i=0,n=0;for(let a of e)i=Math.max(i,(a>>>4)+1),n=Math.max(n,(a&15)+1);r.meta=new be(r.id,t.meta.tileset,i,n);for(let a of e)r.meta.set(a,t.meta.get(a)),t.meta.set(a,t.meta.tileset.empty);let o=new Set(e);r.flags=t.flags.filter(a=>o.has(a.screen)),t.flags=t.flags.filter(a=>!o.has(a.screen)),r.spawns=t.spawns.filter(a=>o.has(a.screen)),t.spawns=t.spawns.filter(a=>!o.has(a.screen)),t.meta.moveExitsAndPitsTo(r.meta)}function Fo(r){let t=r.locations.GoaFortress_Kensu.meta;for(let[e,s]of t.exits())e<16||s.startsWith("seamless")||t.deleteExit(e,s)}function Go(r){r.locations.ZebuCave.spawns.find(t=>t.isTrigger()).yt+=3}var Ao=["!Random Key","!Curious Key","!Bronze Key","!Silver Key","!Golden Key","!Ancient Key","!Small Key","!Shiny Key","!Mysterious Key","!Magic Key","!Backdoor Key","!Skeleton Key","Piano Key","Encryption Key","Private Key","Public Key","Key Card","Any Key","Space Bar","Return Key","Imaginary Key","Giant Key","Out of Key","Key of C","Key of G","Key of B Flat","Key of F Sharp","Lockpick","Transponder Key","Sharp Key","Flat Key","Locke and Key","Major Key","Minor Key","Cookie","Turkey","Monkey","Ctrl Key","Escape Key","Car Key","Clock Key","Florida Key","Key Lime Pie","Keystone","Answer Key"],Po=["!Random Flute","!Wooden Flute","!Metal Flute","!Piccolo","Horn of Plenty","!Ocarina","Fairy Ocarina","Ocarina of Time","!Pan Pipes","!Bugle","!Bagpipes","Kazoo","Lute","Harp","Guitar","Electric Guitar","!Tin Whistle","Magic Whistle","Dog Whistle","!Recorder","!Accordion","!Harmonica","Sousaphone","Trumpet","French Horn","Trombone","Euphonium","Tuba","Clarinet","Saxophone","Oboe","Bassoon","Violin","Viola","Cello","Theramin","Synthesizer","Moog Synth","Piano","Harpsichord","Pipe Organ","Note Block","Snare Drum","Xylophone","Marimba","Tambourine","Tornelsbane","Flute of Power"],Lo=["!Random Lamp","!Bronze Lamp","!Silver Lamp","!Gold Lamp","!Oil Lamp","!Magic Lamp","Genie Lamp","Dull Lamp","Desk Lamp","Shimmering Lamp","Broken Lamp","Brass Lantern","Overhead Lamp","Pedestal Lamp","Incubation Lamp","Fluorescent Lamp","Ultraviolet Lamp","Heat Lamp","Recessed Lighting","Laser Pointer","Spotlight","Flashlight","Search Light","Batsignal","Candelabra","Chandelier","Birthday Candle","Tallow Candle","Wax Candle","Tanning Bed","CRT"],Bo=["!Random Statue","!Rusty Statue","!Forbidden Statue","Golden Idol","!Strange Statue","!Glass Statue","!Copper Statue","!White Statue","Invisible Statue","Burt Figurine","Draygon Figurine","Karmine Figurine","Mado Figurine","Sabera Figurine","Kelbesque Figurine","Flail Guy Trophy","Metroid Amiibo","Model of Dyna","Jeff Peters Statue","M. Toki Statue","Statue of Liberty","Colossus of Rhodes","Mattrick Figurine","Dragondarch Statue","Overswarm Statue","Trueblue83 Statue","TheAxeMan Idol","Acmlm Figurine","CodeGorilla Trophy"],Do=["!Random Bow","Crossbow","Autocrossbow","Long Bow","Compound Bow","Silver Arrows","Wooden Bow","Violin Bow","Tae Bo","Botox","Bo Derek","Bo Diddley","Bo Dallas","Rainbow","Hair Bow","Bow Tie","!Bow of Earth","!Bow of Stars","!Bow of Wind","!Bow of Fire","!Bow of Water","!Bow of Thunder","!Bow of Light","!Bow of Darkness","Bow of Lies","Bow of Life","Bow of Death","Bow of Freedom","JBowe","KLINGSBO","LILLABO","SVALBO","Buriza-Do Kyanon","Windforce","Eaglehorn"];function Mr(r,t,e){if(!t.unidentifiedItems())return;let s=(...c)=>c.map(d=>r.items[d]),i=s(50,51,52),n=s(39,40,49,54),o=s(53,57),a=s(37,56,58,61),l=s(62,63,64);for(let[c,[...d]]of[[i,Ao],[n,Po],[o,Lo],[a,Bo],[l,Do]]){let f=(t.communityJokes()?d:d.filter(h=>h.startsWith("!"))).map(h=>h.replace(/^!/,""));e.shuffle(f);let u=e.shuffle([0,1,2,3]);for(let h of c){let p=f.pop();r.spoiler&&r.spoiler.addUnidentifiedItem(h.id,h.messageName,p),h.menuName=h.messageName=p,h.palette=u.pop()}}}var _o=new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",["Anti-Slime Pill","Maiden's Kiss"]]]),No=new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]),Wo=new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Roflcopter","Roflcopter","Roflcopter"]],["DYNA",["GLaDOS","HAL-9000","Multivac"]]]);function Fr(r,t,e){!t.communityJokes()||(Oo(r,t,e),$o(r,e),qo(r,e))}function Oo(r,t,e){if(t.unidentifiedItems()||"sphereAnalysis"in globalThis)return;let s=e.next()<.05?r.items:[r.items[e.nextInt(72)]];for(let i of s){if(!i)continue;let n=_o.get(i.messageName)||[],o=Math.floor(e.nextInt(3*n.length+1)/3);o<n.length?i.messageName=i.menuName=n[o]:i.messageName===i.menuName&&(i.messageName=i.menuName=ci(i.messageName,e))}}function ci(r,t){let e=r.split(""),s=t.nextInt(e.length-1);return e[s]===" "||e[s+1]===" "?r:(e[s].toUpperCase()===e[s]?e.splice(s+1,1):[e[s],e[s+1]]=[e[s+1],e[s]],e.join(""))}function Gr(r,t){for(let e of r.messages.parts)for(let s of e)s.text=t(s.text);r.messages.personNames=r.messages.personNames.map(t),zo(r,t)}function Ar(r,t){return e=>e.includes(r)?e.split(r).join(t):e}function zo(r,t){for(let e of r.objects)e.displayName&&(e.displayName=t(e.displayName))}function $o(r,t){let e=r.messages.parts[0][24];e.text="Rachel: "+e.text.replace("is the village of","village is");let s=[...No].flatMap(([a,l])=>["",...l,...l].map(c=>[a,c])),[i,n]=t.pick(s),o=n||ci(i,t);o!==i&&Gr(r,Ar(i,o))}function qo(r,t){for(let e=0;e<10;e++){let[s,i]=t.pick([...Wo]),o=t.pick(["",...i,...i,...i])||ci(s,t);o!==s&&Gr(r,Ar(s,o))}}function Pr(r){let{locations:t}=r,{CordelPlainEast:e,CordelPlainWest:s,WaterfallValleyNorth:i,WaterfallValleySouth:n,MezameShrine:o,MtSabreWest_Cave1:a}=t;e.meta.reconcileExits(s.meta);for(let l of i.meta.allPos()){let c=i.meta.get(l),d=n.meta.get(l);c.isEmpty()&&!d.isEmpty()?i.meta.set(l,d):d.isEmpty()&&!c.isEmpty()&&n.meta.set(l,c)}for(let l of t)!l.used||(l.exits=[],l.entrances=[],l.meta.writeEntrance0());o.meta.getExit(0,"door")||o.meta.attach(0,o.meta,0,"door","door");for(let l of t)!l.used||l!==a&&(l.meta.write(),l===s&&a.used&&a.meta.write())}var Ss=class{constructor(t){this.rom=t;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.houses=[];this.flags=""}addCheck(t,e){this.route.push(new fi(this,t,e))}addSlot(t,e,s){this.slots[t&255]=new hi(this.rom,t&255,e,s&255)}addMaze(t,e,s){this.mazes.push({id:t,name:e,maze:s})}addTrade(t,e,s){this.trades.push({itemId:t,item:e,npc:s})}addUnidentifiedItem(t,e,s){this.unidentifiedItems.push({itemId:t,oldName:e,newName:s})}addWall(t,e,s){this.walls.push({location:t,oldElement:e,newElement:s})}addWildWarp(t,e){this.wildWarps.push({id:t,name:e})}addHouse(t,e){this.houses.push({houseId:t,townId:e,house:this.rom.locations[t].name,town:this.rom.locations[e].name})}formatCondition(t){return this.rom.flags[t]?.name}formatConditionList(t){let e=[];for(let s of t){let i=this.rom.flags[s];i?.logic.track&&e.push(i.name)}return e.join(", ")}},fi=class{constructor(t,e,s){this.spoiler=t;this.condition=e;this.deps=s}toString(){let t=0;return(this.condition&-128)===256&&(t=512|this.spoiler.rom.slots[this.condition&255]),`${this.spoiler.formatCondition(this.condition)}${t?` (${this.spoiler.formatCondition(t)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}},hi=class{constructor(t,e,s,i){this.slot=e;this.slotName=s;this.item=i;this.itemName=Lr(t,i),this.originalItem=Lr(t,e)}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};function Lr(r,t){return t>=112?"Mimic":r.items[r.itemGets[t].itemId].messageName}var Br=new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]),ui=new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);function Ho(r,[t,e,[s,i]]){let n=Br.get(e)||ui.get(Br.get(i)),o=!1,a=r.id.toString(16),l=(r.id<<8|t).toString(16)+" "+e,c=r.rom.locations[s>>>8],d=s&255,f=s.toString(16)+" "+i,u=c.id.toString(16),h={loc:c,pos:d,type:i,area:u,key:f,reverse:null,origRev:null,get conn(){return ui.get(n)},set conn(m){n=ui.get(m)},get shuffle(){return o},set shuffle(m){if(m&&!n)throw new Error("shuffle without conn");o=m}},p={loc:r,pos:t,type:e,key:l,reverse:h,area:a,origRev:h,get conn(){return n},set conn(m){n=m},get shuffle(){return o},set shuffle(m){if(m&&!n)throw new Error("shuffle without conn");o=m}};return h.reverse=h.origRev=p,p}function Dr(r,t){return typeof t=="string"?r.type===t:typeof t=="number"?r.pos===t:t instanceof qt?r.reverse.loc===t:t.every(e=>Dr(r,e))}function _r(r,t,e){if(!t.shuffleAreas())return;let{locations:s}=r,i=new Map,n=new _(()=>[]);for(let g of r.locations)for(let y of g.meta.exits()){if(g===s.CordelPlainEast&&(y[0]&15)<5||g===s.CordelPlainWest&&(y[0]&15)>4||g.isTower())continue;let x=Ho(g,y);if(x.loc!==s.Portoa_FortuneTeller&&x.reverse.loc!==s.Portoa_FortuneTeller&&!i.has(x.key)){if(i.has(x.reverse.key))throw new Error(`Inconsistent exits: ${x.key} | ${x.reverse.key}`);i.set(x.key,x),i.set(x.reverse.key,x.reverse),n.get(x.loc).push(x),n.get(x.reverse.loc).push(x.reverse)}}function o(g,...y){let x=[];for(let I of n.get(g))for(let E of y)if(Dr(I,E)){x.push(I);break}return x}for(let g of o(s.ValleyOfWind,"door","windmill"))g.area="windmill";for(let g of o(s.AngrySea,100))g.area="lighthouse";o(s.Portoa_FishermanIsland,"edge:right")[0].oneWay=!0;function a(g,...y){for(let x of o(g,...y))x.shuffle=!0}function l(...g){let y=new Set(g);for(let x of g)for(let I of n.get(x))y.has(I.reverse.loc)||(I.shuffle=!0)}if(l(s.Leaf_OutsideStart),a(s.ValleyOfWind,"cave","door","edge:bottom","edge:top","edge:left","edge:right"),l(s.WindmillCave),l(s.EastCave1,s.EastCave2,s.EastCave3),l(s.ZebuCave,s.MtSabreWest_Cave1),l(s.CordelPlainWest,s.CordelPlainEast),l(s.WaterfallValleyNorth,s.WaterfallValleySouth),l(s.KirisaMeadow),l(s.LimeTreeLake),a(s.Portoa_FishermanIsland,"edge:right"),a(s.PortoaPalace_ThroneRoom,"door"),a(s.Joel,"edge:bottom"),l(s.JoelSecretPassage),a(s.EvilSpiritIsland1,"stair:up"),a(s.ZombieTown,"cave"),a(s.AngrySea,"edge:top"),l(s.SwanGate),a(s.GoaValley,"edge:left"),l(s.Desert1),l(s.GoaFortressBasement),l(s.DesertCave1),l(s.SaharaOutsideCave),l(s.DesertCave2),a(s.Desert2,"stair:down"),!t.shuffleHouses()){let g=[[s.ZombieTown,"fortress"],[s.MtHydra,"gate"],[s.Desert2,"fortress"],[s.Goa,"edge:top"],[s.Portoa,"fortress"],[s.Shyron,"fortress"],[s.GoaValley,"fortress"],[s.OasisCave_Entrance,"stair:up"],[s.MtHydra_OutsideShyron,"gate"],[s.Crypt_Entrance,"crypt"]];for(let[y,x]of g){let[I]=o(y,x);I.conn="F",I.shuffle=!0}}{let[g]=o(s.Oak,"edge:bottom");g.conn="X",g.shuffle=!0}let c=new ge;for(let g of i.values())g.shuffle||c.union([g.area,g.reverse.area]);let d=new _(()=>[]);for(let g of i.values())!g.shuffle||d.get(g.area=c.find(g.area)).push(g);let f=n.get(s.MezameShrine)[0].area;function u(){let g=new Set,y=new Map,x=[];for(let E of[f,...d.keys()]){if(g.has(E))continue;let F=new Set([E]),w=[];for(let k of F){g.add(k);for(let M of d.get(k))y.set(M,x.length),w.push(M),!(M.oneWay||g.has(M.reverse.area))&&F.add(M.reverse.area)}x.push(w)}let I=0;for(let E=1;E<x.length;E++)x[E].length<x[I].length&&(I=E);return[x.length,y,x[I]]}let h=new _(()=>[]);for(let g of i.values())!g.shuffle||!g.conn||h.get(g.conn).push(g);for(let g of"NWCF"){let y=h.get(g),x=e.shuffle([...y]).map(I=>I.reverse);for(let I=0;I<x.length;I++){let E=y[I],F=x[I];[E.reverse,F.reverse]=[F,E]}}let p=0,[m,b,S]=u();for(;p-- >0||m>1;){let g=e.pick(S),y=h.get(g.conn);if(m>1){let F=b.get(g);y=y.filter(w=>b.get(w)!==F)}let x=e.pick(y),I=g.reverse,E=x.reverse;g.reverse=E,E.reverse=g,x.reverse=I,I.reverse=x,[m,b,S]=u()}for(let g of i.values()){if(g.reverse!==g.origRev){let y=function(x){return`${x.loc.name} ${x.type}(${x.pos.toString(16)})`};console.log(`${y(g)}  =>  ${y(g.reverse)}  (was ${y(g.origRev)})`)}g.loc.meta.attach(g.pos,g.reverse.loc.meta,g.reverse.pos,g.type,g.reverse.type)}}function Nr(r){for(let t of r.locations){let e=new Set;for(let s of t.spawns)if(!!s.isTrigger()&&e.has(s.coord))throw new Error(`Overlapping triggers on ${t} at ${s.coord.toString(16)}`)}}var mi=!0,Wr=Ai("asm");function eh(r){return r?/^[0-9a-f]{1,8}$/i.test(r)?Number.parseInt(r,16):Ut(r):st.newSeed()}var{}={watchArray:Ei};function Uo(r,t){let e={_ALLOW_TELEPORT_OUT_OF_BOSS:r.hardcoreMode()&&r.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUDIBLE_WALLS:r.audibleWallCues(t),_AUTO_EQUIP_BRACELET:r.autoEquipBracelet(t),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:r.buffDeosPendant(),_BUFF_DYNA:r.buffDyna(),_CHARGE_SHOT_ONLY:r.chargeShotsOnly(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:r.controllerShortcuts(t),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:r.disableShopGlitch(),_DISABLE_STATUE_GLITCH:r.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:r.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:r.disableTriggerGlitch(),_DISABLE_WARP_BOOTS_REUSE:r.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_EXPAND_PRG:mi,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_BLIZZARD_SPAWN:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_SWORD_MANA_CHECK:!0,_FIX_VAMPIRE:!0,_HAZMAT_SUIT:r.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:r.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:r.maxScalingInTower(),_MONEY_AT_START:r.shuffleHouses()||r.shuffleAreas(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:r.neverDie(),_NORMALIZE_SHOP_PRICES:r.shuffleShops(),_OOPS_ALL_MIMICS:r.alwaysMimics(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,_RABBIT_BOOTS_CHARGE_WHILE_WALKING:r.rabbitBootsChargeWhileWalking(),_RANDOM_FLYER_SPAWNS:!0,_REQUIRE_HEALED_DOLPHIN_TO_RIDE:r.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:r.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_STATS_TRACKING:r.hasStatTracking(),_TELEPORT_ON_THUNDER_SWORD:r.teleportOnThunderSword(),_TINK_MODE:!r.guaranteeMatchingSword(),_TRAINER:r.trainer(),_TWELFTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:r.unidentifiedItems(),_ENEMY_HP:r.shouldUpdateHud(),_UPDATE_HUD:r.shouldUpdateHud(),_WARP_FLAGS_TABLE:!0,_ZEBU_STUDENT_GIVES_ITEM:r.zebuStudentGivesItem()};return Object.keys(e).filter(s=>e[s]).map(s=>`.define ${s} ${e[s]}
`).join("")}function jo(r,t){for(let e of t)Xe.applyPatch(e,r,mi)}async function th(r,t,e,s,i,n){let o=16+(r[6]&4?512:0)+(r[4]<<14)+(r[5]<<13);if(r.length>o&&(r=r.slice(0,o)),mi&&r.length<524288){if(r.length<524288){let p=new Uint8Array(r.length+262144);p.subarray(0,262160).set(r.subarray(0,262160)),p.subarray(524304).set(r.subarray(262160)),p[4]<<=1,r=p}let h=r.subarray(16);h.subarray(507904,524288).set(h.subarray(245760,262144))}let a=r.slice(16);if(ar(r.subarray(16)),typeof t!="number")throw new Error("Bad seed");let l=Ut(t.toString(16).padStart(8,"0")+String(e.filterOptional()))>>>0,c=new st(l),d=s||[],f=[],u=e.mayShuffleAreas()?12:5;for(let h=0;h<u;h++)try{return await Ko(r,e,t,c,i,n,d,a)}catch(p){if(p.name==="UsageError")throw p;f.push(p),console.error(`Attempt ${h+1} failed: ${p.stack}`)}throw new Error(`Shuffle failed: ${f.map(h=>h.stack).join(`

`)}`)}async function Ko(r,t,e,s,i,n,o,a){let l=String(t),c=t.filterRandom(s);c.validate();let d=new Pi(r),f=String(c);d.flags.defrag(),rr(d),nr(d),typeof window=="object"&&(window.rom=d),d.spoiler=new Ss(d),i&&(i.spoiler=d.spoiler),f!==l&&(d.spoiler.flags=f),lr(d,c),Fi(d),yt(d,yt.generateOptions(c,s)),d.scalingLevels=48,c.shuffleShops()&&Xo(d,c,s),c.shuffleGoaFloors()&&Sr(d,s),Yo(d),Zo(d,c,s),or(d,s),c.nerfWildWarp()&&d.wildWarp.locations.fill(0),c.randomizeWildWarp()&&Qo(d,c,s),c.randomizeThunderTeleport()&&wr(d,s),yr(d,c,s),Mr(d,c,s),Fr(d,c,s),cr(d,c,s),c.shuffleHouses()&&kr(d,c,s),c.shuffleAreas()&&_r(d,c,s),pr(d),c.randomizeMaps()&&qi(d,c,s),Pr(d),Ir(d,s),c.shuffleMimics()&&vr(d,c,s),c.shuffleMonsters()&&Rr(d,c,s);let u=new gs(d,c),h=new fs([u.getLocationList()]);if(!c.noShuffle()){let g=await h.shuffle(c,s,void 0,n,d.spoiler);if(g){for(let[y,x]of g)d.slots[y&255]=x&255;d.slots.setCheckCount(g.size)}else throw new Error("Shuffle failed")}c.shuffleShops()&&na(d,c.bargainHunting()?s:void 0),c.buffMedicalHerb()&&(d.items.MedicalHerb.value=80,d.items.FruitOfPower.value=56),c.storyMode()&&sa(d),c.blackoutMode()&&ta(d),Vo(d,c,s),ur(d),xr(d),Nr(d),c.buffDyna()&&ea(d,c),c.trainer()&&(d.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]),c.randomizeMusic("early")&&Or(d,c,s),c.shuffleTilePalettes("early")&&di(d,c,s),ra(d,c),s.shuffle(d.randomNumbers.values);async function p(g){let y=Uo(c,g),x=new yi(Mt.P02,{overwriteMode:"forbid"}),I=new Ci;I.enter(wi.concat(new Ms(y,"flags.s"),...ki().map(({filename:k,contents:M})=>new Ms(Ks(M,Mt.P02,a),k,{lineContinuations:!0}))));let E=new Si(I,x);x.tokens(E);let F=Ii(),w=[];for(let k of F.labels)x.definedSymbol(k.name)||((w.length!==k.segments.length||w.some((M,N)=>M!==k.segments[N]))&&x.segment(...w=k.segments),x.org(k.org),x.label(k.name));for(let k of F.refs){let M=k.offset+(k.offset>=245760?262144:0);if(!x.isWritten(M))if((w.length!==k.segments.length||w.some((N,J)=>N!==k.segments[J]))&&x.segment(...w=k.segments),x.org(k.org),k.bytes===1)x.byte(k.expr);else if(k.bytes===2)x.word(k.expr);else throw new Error(`bad bytes: ${k.bytes}`)}return x.module()}d.messages.compress();let m=r.slice(16);d.modules.set(Wr,await p("early")),d.writeData(m),d.modules.set(Wr,await p("late"));let b=o?.some(g=>Xe.isCustom(g))||!1,S=ia(r,e,l,m,b);return c.randomizeMusic("late")&&Or(d,c,s),c.noMusic("late")&&Jo(d),c.shuffleTilePalettes("late")&&di(d,c,s),br(d),d.writeData(),jo(r,o),[r,S]}function Vo(r,t,e){let{}={rom:r,flags:t,random:e};r.messages.parts[2][2].text=`
{01:Akahana} is handed a statue.#
Thanks for finding that.
I was totally gonna sell
it for tons of cash.#
Here, have this lame
[29:Gas Mask] or something.`,r.messages.parts[0][14].text="It's dangerous to go alone! Take this.",r.messages.parts[0][14].fixText()}function Xo(r,t,e){let s={[0]:{contents:[],shops:[]},[1]:{contents:[],shops:[]}};for(let i of r.shops){if(!i.used||i.location===255)continue;let n=s[i.type];n&&(n.contents.push(...i.contents.filter(o=>o!==255)),n.shops.push(i),i.contents=[])}for(let i of Object.values(s)){let n=null,o=[...i.contents];for(e.shuffle(o);o.length;){(!n||!n.length)&&(n&&o.shift(),n=[...i.shops,...i.shops,...i.shops,...i.shops],e.shuffle(n));let a=o[0],l=n[0];l.contents.length<4&&!l.contents.includes(a)&&(l.contents.push(a),o.shift()),n.shift()}}for(let i of Object.values(s))for(let n of i.shops){for(;n.contents.length<4;)n.contents.push(255);n.contents.sort((o,a)=>o-a)}}function Yo(r){for(let t of r.locations)if(!!t.used){for(let e of t.spawns)if(e.isWall()){let s=e.id&15;e.id=s|s<<4;let i=e.isShootingWall(t);e.data[2]=i?51:35}}}function Zo(r,t,e){if(!t.randomizeWalls())return;let s=[[5,56],[17],[106],[20]];function i(o){return o.data[2]&32?o.id>>>4&3:o.id&3}let n=new _(()=>[]);for(let o of r.locations)n.get(o.data.area).push(o);for(let o of n.values()){let a=e.nextInt(4),l=e.pick(s[a]),c=!1;for(let d of o)for(let f of d.spawns)if(f.isWall()){let u=i(f);if(u===2)continue;if(u===3){let h=e.nextInt(4);r.spoiler&&r.spoiler.addWall(d.name,u,h),f.data[2]|=32,f.id=48|h}else!c&&r.spoiler&&(r.spoiler.addWall(d.name,u,a),c=!0),f.data[2]|=32,f.id=u<<4|a,d.tilePalettes[2]=l}}}function Jo(r){for(let t of[...r.locations,...r.bosses.musics])t.bgm=0}function Or(r,t,e){let s=new _(()=>[]),i=new Set;for(let a of r.locations){if(a.id===95||a.id===0||!a.used)continue;let l=a.musicGroup;i.add(a.bgm),s.get(l).push(a)}for(let a of r.bosses.musics)s.set(a,[a]),i.add(a.bgm);let n=[...i],o=new Set;for(let a of s.values()){let l=e.pick(n);for(let c of a)c.bgm=l,o.add(c)}}function Qo(r,t,e){let s=[];for(let i of r.locations)i&&i.used&&i.id&&!i.isShop()&&i!==r.locations.EvilSpiritIsland1&&i!==r.locations.UndergroundChannel&&(i.id&248)!==88&&i!==r.locations.Crypt_Draygon2&&i!==r.locations.Crypt_Teleporter&&i!==r.locations.MesiaShrine&&i!==r.locations.LimeTreeLake&&s.push(i);e.shuffle(s),r.wildWarp.locations=[];for(let i of[...s.slice(0,15).sort((n,o)=>n.id-o.id)])r.wildWarp.locations.push(i.id),r.spoiler&&r.spoiler.addWildWarp(i.id,i.name);r.wildWarp.locations.push(0)}function ea(r,t){r.objects[184].collisionPlane=1,r.objects[184].immobile=!0,r.objects[185].collisionPlane=1,r.objects[185].immobile=!0,r.objects[51].collisionPlane=2,r.adHocSpawns[40].slotRangeLower=28,r.adHocSpawns[41].slotRangeUpper=28,r.adHocSpawns[42].slotRangeUpper=28}function ta(r){let t=new Set([r.metatilesets.cave.tilesetId,r.metatilesets.fortress.tilesetId,r.metatilesets.iceCave.tilesetId,r.metatilesets.labyrinth.tilesetId,r.metatilesets.pyramid.tilesetId]);for(let e of r.locations)t.has(e.tileset)&&e.tilePalettes.fill(154)}var sa=r=>{let t=[r.flags.Kelbesque1.id,r.flags.Sabera1.id,r.flags.Mado1.id,r.flags.Kelbesque2.id,r.flags.Sabera2.id,r.flags.Mado2.id,r.flags.Karmine.id,r.flags.Draygon1.id,r.flags.SwordOfWind.id,r.flags.SwordOfFire.id,r.flags.SwordOfWater.id,r.flags.SwordOfThunder.id];r.npcs[203].spawnConditions.get(166).push(...t)};function ia(r,t,e,s,i){let n=Ut(s),o=n.toString(16).padStart(8,"0").toUpperCase(),a=qs==="unstable"?Ui.substring(0,7).padStart(7,"0").toUpperCase()+"     ":Hi.substring(0,12).padEnd(12," "),l=t.toString(16).padStart(8,"0").toUpperCase(),c=(u,...h)=>{u+=16;for(let p of h)if(typeof p=="string")for(let m of p)r[u++]=m.charCodeAt(0);else if(typeof p=="number")r[u++]=p;else throw new Error(`Bad value: ${p}`)},d=(u,h)=>{let p=[];for(let m=0;m<u.length||m<h.length;m++)p.push(u[m]||" "),p.push(h[m]||" ");return p.join("")};c(161743,d("  VERSION     SEED      ",`  ${a}${l}`));let f;if(e.length>46){if(e.length>92)throw new Error("Flag string way too long!");f=e.substring(46,92).padEnd(46," "),e=e.substring(0,46)}return e=e.padEnd(46," "),c(161791,d(e.substring(0,23),e.substring(23))),f&&c(161839,d(f.substring(0,23),f.substring(23))),i&&c(161923,126),c(161925,d(o.substring(0,4),o.substring(4))),c(153366,"RANDOMIZER"),qs==="unstable"&&c(153404,"BETA"),n}function ra(r,t){t.decreaseEnemyDamage()&&r.scaling.setPhpFormula(e=>16+6*e),r.scaling.setExpScalingFactor(t.expScalingFactor()),t.disableShopGlitch()?r.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1e3]:r.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800],r.items.CarapaceShield.defense=r.items.TannedHide.defense=3,r.items.PlatinumShield.defense=r.items.BronzeArmor.defense=9,r.items.MirroredShield.defense=r.items.PlatinumArmor.defense=13,r.items.PsychoArmor.defense=r.items.PsychoShield.defense=20,r.items.CeramicSuit.defense=r.items.BattleShield.defense=32,r.items.CarapaceShield.defense=r.items.TannedHide.defense=2,r.items.PlatinumShield.defense=r.items.BronzeArmor.defense=10,r.items.MirroredShield.defense=r.items.PlatinumArmor.defense=14,r.items.BattleArmor.defense=24}var na=(r,t)=>{for(let s of r.shops)if(s.type!==3)for(let i=0,n=s.prices.length;i<n;i++)s.contents[i]<128?s.prices[i]=t?t.nextNormal(1,.3,.5,1.5):1:s.type!==2?s.prices[i]=0:s.prices[i]=t?t.nextNormal(1,.5,.375,1.625):1;let e=te(48,s=>s);r.shops.rescale=!0,r.shops.toolShopScaling=e.map(s=>Math.round(8*2**(s/10))),r.shops.armorShopScaling=e.map(s=>Math.round(8*2**((47-s)/12)));for(let s=13;s<39;s++)r.items[s].basePrice=oa[s]},oa={13:4,14:16,15:50,16:325,17:1e3,18:2e3,19:4e3,21:6,22:20,23:75,24:250,25:1e3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300},[]=[V];export{Ut as a,le as b,de as c,tt as d,ln as e,qs as f,Hi as g,Kl as h,Ui as i,Vl as j,Xl as k,Jl as l,Xe as m,ds as n,un as o,eh as p,th as q};
