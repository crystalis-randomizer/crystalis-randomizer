function flipSaberaEntrance(exit) {
    console.log(`flip sabera entrance`);
    const loc = exit[0];
    loc.set2d(0x71, [[loc.rom.metascreens.deadEndE_upStair],
        [loc.rom.metascreens.caveEmpty]]);
    loc.moveExits([0x81, 'stair:down', 0x71, 'stair:up']);
    exit[1] = 0x71;
    exit[2] = 'stair:up';
}
function flipKarmineEntrance(exit, random) {
    console.log(`flip karmine entrance`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    loc.set2d(0x20, [[ms.caveEmpty, ms.hallNS],
        [ms.deadEndE_upStair, ms.hallNW]]);
    loc.replaceMonsters(random);
    loc.moveExits([0x30, 'stair:down', 0x30, 'stair:up']);
    exit[2] = 'stair:up';
}
function flipKarmineExit(exit) {
    console.log(`flip karmine exit`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    loc.set2d(0x01, [[ms.deadEndS_stairs, ms.caveEmpty]]);
    loc.moveExits([0x02, 'stair:down', 0x01, 'stair:up']);
    exit[1] = 0x01;
    exit[2] = 'stair:up';
}
function flipExit(exit) {
    console.log(`flip generic exit`);
    const loc = exit[0];
    const ms = loc.rom.metascreens;
    if (loc.width < 2)
        loc.width = 2;
    loc.set2d(0x00, [[ms.hallSE, ms.deadEndW_downStair]]);
    loc.moveExits([0x00, 'stair:up', 0x01, 'stair:down']);
    exit[1] = 0x01;
    exit[2] = 'stair:down';
}
function flip(e, random) {
    e[3](e, random);
    e[3] = undefined;
}
export function shuffleGoa(rom, random) {
    const $ = rom.locations;
    const floors = [0, 1, 2, 3];
    random.shuffle(floors);
    const entrances = [
        [$.GoaFortress_Kelbesque.meta, 0x83, 'stair:down'],
        [$.GoaFortress_Sabera.meta, 0x81, 'stair:down', flipSaberaEntrance],
        [$.GoaFortress_Mado1.meta, 0x72, 'stair:down'],
        [$.GoaFortress_Karmine1.meta, 0x30, 'stair:down', flipKarmineEntrance],
    ];
    const exits = [
        [$.GoaFortress_Zebu.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Tornel.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Asina.meta, 0x00, 'stair:up', flipExit],
        [$.GoaFortress_Kensu.meta, 0x02, 'stair:down', flipKarmineExit],
    ];
    const a = [[$.GoaFortress_Entrance.meta, 0x00, 'edge:top']];
    const b = [];
    let up = true;
    let lastA = a[0];
    for (const f of floors) {
        const flexible = up || entrances[f][3] || a[a.length - 1][3];
        const reverse = flexible ? random.pick([false, true]) : true;
        console.log(`FLOOR ${f}: up ${up} flexible ${!!flexible} reverse ${reverse}`);
        const lastB = reverse ? exits[f] : entrances[f];
        console.log(`push b ${rom.locations[lastB[0].id].name}`);
        b.push(lastB);
        if (up !== (lastB[2] === 'stair:down')) {
            if (lastB[3]) {
                flip(lastB, random);
            }
            else {
                flip(lastA, random);
            }
        }
        a.push(lastA = reverse ? entrances[f] : exits[f]);
        console.log(`push a ${rom.locations[lastA[0].id].name}`);
        up = lastA[2] === 'stair:up';
    }
    if (up)
        flip(lastA, random);
    b.push([$.GoaFortress_Exit.meta, 0x01, 'stair:up']);
    for (let i = 0; i < a.length; i++) {
        a[i][0].attach(a[i][1], b[i][0], b[i][1], a[i][2], b[i][2]);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWdvYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVnb2EudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBY0EsU0FBUyxrQkFBa0IsQ0FBQyxJQUFVO0lBQ3BDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNwQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDO1FBQ3RDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDZixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVUsRUFBRSxNQUFjO0lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7SUFDL0IsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUN6QixDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lB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QUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFFakMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDN0Q7QUE0RUgsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNodWZmbGUgZmxvb3JzIG9mIEdvYSBmb3J0cmVzcyBhbW9uZ3N0IGVhY2ggb3RoZXIuXG4vLyBPbmUga2V5IGRpZmZpY3VsdHkgaXMgdGhlIGRpcmVjdGlvbiBvZiB0aGUgZG9vcnMuXG4vLyBUaGUgZG9vciBhdCB0aGUgdG9wIG9mIGthcm1pbmUgcG9pbnRzIGRvd24sIHdoZXJlYXMgYWxsIG90aGVycyBhcmUgdXAuXG4vLyBXZSBuZWVkIGEgd2F5IHRvIGNoYW5nZSB0aGUgZGlyZWN0aW9uIG9mIGVhY2guXG5cbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge01ldGFsb2NhdGlvbiwgUG9zfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcbmltcG9ydCB7Q29ubmVjdGlvblR5cGV9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuZGF0YS5qcyc7XG5cbnR5cGUgRXhpdCA9IFtNZXRhbG9jYXRpb24sIFBvcywgQ29ubmVjdGlvblR5cGVdO1xudHlwZSBFeGl0MiA9IFtNZXRhbG9jYXRpb24sIFBvcywgQ29ubmVjdGlvblR5cGUsXG4gICAgICAgICAgICAgICgoZTogRXhpdCwgcjogUmFuZG9tKSA9PiB2b2lkKT9dO1xuXG5mdW5jdGlvbiBmbGlwU2FiZXJhRW50cmFuY2UoZXhpdDogRXhpdCkge1xuICBjb25zb2xlLmxvZyhgZmxpcCBzYWJlcmEgZW50cmFuY2VgKTtcbiAgY29uc3QgbG9jID0gZXhpdFswXTtcbiAgbG9jLnNldDJkKDB4NzEsIFtbbG9jLnJvbS5tZXRhc2NyZWVucy5kZWFkRW5kRV91cFN0YWlyXSxcbiAgICAgICAgICAgICAgICAgICBbbG9jLnJvbS5tZXRhc2NyZWVucy5jYXZlRW1wdHldXSk7XG4gIGxvYy5tb3ZlRXhpdHMoWzB4ODEsICdzdGFpcjpkb3duJywgMHg3MSwgJ3N0YWlyOnVwJ10pO1xuICBleGl0WzFdID0gMHg3MTtcbiAgZXhpdFsyXSA9ICdzdGFpcjp1cCc7XG59XG5cbmZ1bmN0aW9uIGZsaXBLYXJtaW5lRW50cmFuY2UoZXhpdDogRXhpdCwgcmFuZG9tOiBSYW5kb20pIHtcbiAgY29uc29sZS5sb2coYGZsaXAga2FybWluZSBlbnRyYW5jZWApO1xuICBjb25zdCBsb2MgPSBleGl0WzBdO1xuICBjb25zdCBtcyA9IGxvYy5yb20ubWV0YXNjcmVlbnM7XG4gIGxvYy5zZXQyZCgweDIwLCBbW21zLmNhdmVFbXB0eSwgbXMuaGFsbE5TXSxcbiAgICAgICAgICAgICAgICAgICBbbXMuZGVhZEVuZEVfdXBTdGFpciwgbXMuaGFsbE5XXV0pO1xuICBsb2MucmVwbGFjZU1vbnN0ZXJzKHJhbmRvbSk7XG4gIGxvYy5tb3ZlRXhpdHMoWzB4MzAsICdzdGFpcjpkb3duJywgMHgzMCwgJ3N0YWlyOnVwJ10pO1xuICBleGl0WzJdID0gJ3N0YWlyOnVwJztcbn1cblxuZnVuY3Rpb24gZmxpcEthcm1pbmVFeGl0KGV4aXQ6IEV4aXQpIHtcbiAgY29uc29sZS5sb2coYGZsaXAga2FybWluZSBleGl0YCk7XG4gIGNvbnN0IGxvYyA9IGV4aXRbMF07XG4gIGNvbnN0IG1zID0gbG9jLnJvbS5tZXRhc2NyZWVucztcbiAgbG9jLnNldDJkKDB4MDEsIFtbbXMuZGVhZEVuZFNfc3RhaXJzLCBtcy5jYXZlRW1wdHldXSk7XG4gIGxvYy5tb3ZlRXhpdHMoWzB4MDIsICdzdGFpcjpkb3duJywgMHgwMSwgJ3N0YWlyOnVwJ10pO1xuICBleGl0WzFdID0gMHgwMTtcbiAgZXhpdFsyXSA9ICdzdGFpcjp1cCc7XG59XG5cbmZ1bmN0aW9uIGZsaXBFeGl0KGV4aXQ6IEV4aXQpIHtcbiAgY29uc29sZS5sb2coYGZsaXAgZ2VuZXJpYyBleGl0YCk7XG4gIGNvbnN0IGxvYyA9IGV4aXRbMF07XG4gIGNvbnN0IG1zID0gbG9jLnJvbS5tZXRhc2NyZWVucztcbiAgaWYgKGxvYy53aWR0aCA8IDIpIGxvYy53aWR0aCA9IDI7IC8vIHNob3VsZCBhbHJlZHkgYmUgZmlsbGVkIHcvIGVtcHR5XG4gIGxvYy5zZXQyZCgweDAwLCBbW21zLmhhbGxTRSwgbXMuZGVhZEVuZFdfZG93blN0YWlyXV0pO1xuICBsb2MubW92ZUV4aXRzKFsweDAwLCAnc3RhaXI6dXAnLCAweDAxLCAnc3RhaXI6ZG93biddKTtcbiAgZXhpdFsxXSA9IDB4MDE7XG4gIGV4aXRbMl0gPSAnc3RhaXI6ZG93bic7XG59XG5cbmZ1bmN0aW9uIGZsaXAoZTogRXhpdDIsIHJhbmRvbTogUmFuZG9tKSB7XG4gIGVbM10hKGUgYXMgRXhpdCwgcmFuZG9tKTtcbiAgZVszXSA9IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNodWZmbGVHb2Eocm9tOiBSb20sIHJhbmRvbTogUmFuZG9tKSB7XG4gIGNvbnN0ICQgPSByb20ubG9jYXRpb25zO1xuICBjb25zdCBmbG9vcnMgPSBbMCwgMSwgMiwgM107XG4gIHJhbmRvbS5zaHVmZmxlKGZsb29ycyk7XG5cbiAgY29uc3QgZW50cmFuY2VzOiBFeGl0MltdID0gW1xuICAgIFskLkdvYUZvcnRyZXNzX0tlbGJlc3F1ZS5tZXRhISwgMHg4MywgJ3N0YWlyOmRvd24nXSxcbiAgICBbJC5Hb2FGb3J0cmVzc19TYWJlcmEubWV0YSEsIDB4ODEsICdzdGFpcjpkb3duJywgZmxpcFNhYmVyYUVudHJhbmNlXSxcbiAgICBbJC5Hb2FGb3J0cmVzc19NYWRvMS5tZXRhISwgMHg3MiwgJ3N0YWlyOmRvd24nXSxcbiAgICBbJC5Hb2FGb3J0cmVzc19LYXJtaW5lMS5tZXRhISwgMHgzMCwgJ3N0YWlyOmRvd24nLCBmbGlwS2FybWluZUVudHJhbmNlXSxcbiAgXTtcbiAgY29uc3QgZXhpdHM6IEV4aXQyW10gPSBbXG4gICAgWyQuR29hRm9ydHJlc3NfWmVidS5tZXRhISwgMHgwMCwgJ3N0YWlyOnVwJywgZmxpcEV4aXRdLFxuICAgIFskLkdvYUZvcnRyZXNzX1Rvcm5lbC5tZXRhISwgMHgwMCwgJ3N0YWlyOnVwJywgZmxpcEV4aXRdLFxuICAgIFskLkdvYUZvcnRyZXNzX0FzaW5hLm1ldGEhLCAweDAwLCAnc3RhaXI6dXAnLCBmbGlwRXhpdF0sXG4gICAgWyQuR29hRm9ydHJlc3NfS2Vuc3UubWV0YSEsIDB4MDIsICdzdGFpcjpkb3duJywgZmxpcEthcm1pbmVFeGl0XSxcbiAgXTtcblxuICAvLyBQbGFuOiBwaWVjZSBpdCB0b2dldGhlci4uLlxuICAvLyAgLSBwcm9iYWJseSBqdXN0IHJlYXJyYW5nZSB0aGUgYXJyYXlzLCB0aGVuIGRvIGFsbCB0aGUgbXV0YXRpb25zIGxhdGVyPz8/P1xuICBjb25zdCBhOiBFeGl0MltdID0gW1skLkdvYUZvcnRyZXNzX0VudHJhbmNlLm1ldGEhLCAweDAwLCAnZWRnZTp0b3AnXV07XG4gIGNvbnN0IGI6IEV4aXQyW10gPSBbXTtcbiAgbGV0IHVwID0gdHJ1ZTtcbiAgbGV0IGxhc3RBOiBFeGl0MiA9IGFbMF07XG5cbiAgZm9yIChjb25zdCBmIG9mIGZsb29ycykge1xuICAgIGNvbnN0IGZsZXhpYmxlID0gdXAgfHwgZW50cmFuY2VzW2ZdWzNdIHx8IGFbYS5sZW5ndGggLSAxXVszXTtcbiAgICBjb25zdCByZXZlcnNlID0gZmxleGlibGUgPyByYW5kb20ucGljayhbZmFsc2UsIHRydWVdKSA6IHRydWU7XG4gICAgY29uc29sZS5sb2coYEZMT09SICR7Zn06IHVwICR7dXB9IGZsZXhpYmxlICR7ISFmbGV4aWJsZX0gcmV2ZXJzZSAke3JldmVyc2V9YCk7XG4gICAgY29uc3QgbGFzdEI6IEV4aXQyID0gcmV2ZXJzZSA/IGV4aXRzW2ZdIDogZW50cmFuY2VzW2ZdO1xuICAgIGNvbnNvbGUubG9nKGBwdXNoIGIgJHtyb20ubG9jYXRpb25zW2xhc3RCWzBdLmlkXS5uYW1lfWApO1xuICAgIGIucHVzaChsYXN0Qik7XG4gICAgaWYgKHVwICE9PSAobGFzdEJbMl0gPT09ICdzdGFpcjpkb3duJykpIHtcbiAgICAgIGlmIChsYXN0QlszXSkge1xuICAgICAgICBmbGlwKGxhc3RCLCByYW5kb20pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmxpcChsYXN0QSwgcmFuZG9tKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYS5wdXNoKGxhc3RBID0gcmV2ZXJzZSA/IGVudHJhbmNlc1tmXSA6IGV4aXRzW2ZdKTtcbiAgICBjb25zb2xlLmxvZyhgcHVzaCBhICR7cm9tLmxvY2F0aW9uc1tsYXN0QVswXS5pZF0ubmFtZX1gKTtcbiAgICB1cCA9IGxhc3RBWzJdID09PSAnc3RhaXI6dXAnO1xuICB9XG4gIGlmICh1cCkgZmxpcChsYXN0QSwgcmFuZG9tKTsgLy8gTk9URTogYWxsIGVudHJhbmNlcyBjYW4gYmUgZG93biwgb25seSBzb21lIHVwXG4gIGIucHVzaChbJC5Hb2FGb3J0cmVzc19FeGl0Lm1ldGEhLCAweDAxLCAnc3RhaXI6dXAnXSk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gVE9ETyAtIHNpbXBsaWZ5IHRvIHJlbW92ZSBzcGVjaWZpYyB0eXBlXG4gICAgYVtpXVswXS5hdHRhY2goYVtpXVsxXSwgYltpXVswXSwgYltpXVsxXSwgYVtpXVsyXSwgYltpXVsyXSk7XG4gIH1cblxuICAvLyBsZXQgbGFzdCA9IFtleGl0c1swXVswXSwgZXhpdHNbMF1bMV0sICdzdGFpcjp1cCddO1xuICAvLyBmb3IgKGxldCBpID0gMTsgaSA8PSA0OyBpKyspIHtcbiAgLy8gICBjb25zdCBmbG9vciA9IGZsb29yc1tpXTtcbiAgLy8gICAvLyBFYWNoIGZsb29yIG1heSBiZSByZXZlcnNlZC4gIEV4Y2VwdGlvbjogaWYgd2UncmUgY29taW5nIHRocm91Z2ggYSBkb3duXG4gIC8vICAgLy8gc3RhaXIgaW50byBrZWxieSBvciBtYWRvJ3MgYXJlYSB0aGVuIHdlIE1VU1QgYmUgcmV2ZXJzZWQgc2luY2UgdGhlc2VcbiAgLy8gICAvLyBtYXBzIGFyZSBub3QgY29tcGF0aWJsZSB3aXRoIGFuIHVwIHN0YWlyIGF0IHRoZSBzdGFydC5cbiAgLy8gICBjb25zdCByZXZlcnNlID1cbiAgLy8gICAgICAgbGFzdCA9PT0gJ3N0YWlyOnVwJyB8fCAoZmxvb3IgJiAxKSA/IHJhbmRvbS5waWNrKFtmYWxzZSwgdHJ1ZV0pIDogdHJ1ZTtcbiAgLy8gICBjb25zdCBlbnRyYW5jZSA9IChyZXZlcnNlID8gZXhpdHMgOiBlbnRyYW5jZXMpW2Zsb29yXTtcbiAgLy8gICBjb25zdCBleGl0ID0gKHJldmVyc2UgPyBlbnRyYW5jZXMgOiBleGl0cylbZmxvb3JdO1xuICAvLyAgIGlmIChlbnRyYW5jZVsyXSA9PT0gbGFzdCkge1xuICAvLyAgICAgZmxpcChlbnRyYW5jZSk7XG4gIC8vICAgfVxuICAvLyAgIGlmIChpID09PSA0KSB7IC8vIGV4aXQgbXVzdCBiZSBkb3duXG4gIC8vICAgICBpZiAoZXhpdFsyXSAhPT0gJ3N0YWlyOmRvd24nKSBmbGlwKGV4aXQpO1xuICAvLyAgIH0gZWxzZSB7IC8vIGV4aXQgc2hvdWxkIGJlIHVwIGlmIHBvc3NpYmxlLCBidXQgbm90IHJlcXVpcmVkLlxuICAvLyAgICAgaWYgKGV4aXRbMl0gIT09ICdzdGFpcjp1cCcgJiZcbiAgLy8gICAgICAgICBleGl0WzBdICE9PSAkLkdvYUZvcnRyZXNzX0tlbGJlc3F1ZS5tZXRhICYmXG4gIC8vICAgICAgICAgZXhpdFswXSAhPT0gJC5Hb2FGb3J0cmVzc19NYWRvMS5tZXRhKSB7XG4gIC8vICAgICAgIGZsaXAoZXhpdCk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIGNvbnN0IHByZXYgPSBleGl0c1tmbG9vcnNbaSAtIDFdXTtcbiAgLy8gICBwcmV2WzBdLmF0dGFjaChwcmV2WzFdLCBwcmV2WzJdKVxuICAvLyAgIGxhc3QgPSBleGl0WzJdO1xuICAvLyB9XG5cblxuICAvLyAvLyBVcGRhdGUgdGhlIGV4aXQgcG9zaXRpb24gb2YgS2Vuc3UgYW5kIGV4aXRzW2Zsb290c1s0XV0gaWYgbm90IHNhbWVcbiAgLy8gY29uc3QgbGFzdCA9IGZsb29yc1szXTtcbiAgLy8gaWYgKGxhc3QgIT09IDQpIHtcbiAgLy8gICBmbGlwS2FybWluZUV4aXQoKTtcbiAgLy8gICBmbGlwTm9uS2FybWluZUV4aXQobGFzdCk7XG4gIC8vIH1cblxuICAvLyAvLyBOb3cgZ28gdGhyb3VnaCBlYWNoIGFuZCBkbyB0aGUgbGlua3MuXG4gIC8vIC8vIGV4aXRzWzBdIDogZW50cmFuY2VzW2Zsb29yc1swXV1cbiAgLy8gLy8gZXhpdHNbZmxvb3JzWzBdXSA6IGVudHJhbmNlc1tmbG9vcnNbMV1dXG4gIC8vIC8vIC4uLlxuICAvLyAvLyBleGl0c1tmbG9vcnNbM11dIDogZW50cmFuY2VzWzBdXG5cbiAgLy8gZnVuY3Rpb24gY29ubmVjdChmcm9tOiBMb2NhdGlvbiwgZXhpdDogbnVtYmVyLFxuICAvLyAgICAgICAgICAgICAgICAgIHRvOiBMb2NhdGlvbiwgZW50cmFuY2U6IG51bWJlcikge1xuICAvLyAgIC8vIGZpbmQgYWxsIGV4aXRzIGluICdmcm9tJyB0aGF0IG1hcCB0byB0aGUgc2FtZSBlbnRyYW5jZVxuICAvLyAgIGNvbnN0IHdhbnQgPSBmcm9tLmV4aXRzW2V4aXRdO1xuICAvLyAgIGNvbnN0IGZvdW5kID0gW107XG4gIC8vICAgZm9yIChjb25zdCBlIG9mIGZyb20uZXhpdHMpIHtcbiAgLy8gICAgIGlmIChlLmRlc3QgPT09IHdhbnQuZGVzdCAmJiBlLmVudHJhbmNlID09PSB3YW50LmVudHJhbmNlKSBmb3VuZC5wdXNoKGUpO1xuICAvLyAgIH1cbiAgLy8gICBmb3IgKGNvbnN0IGUgb2YgZm91bmQpIHtcbiAgLy8gICAgIGUuZGVzdCA9IHRvLmlkO1xuICAvLyAgICAgZS5lbnRyYW5jZSA9IGVudHJhbmNlO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8vIGZvciAobGV0IGkgPSAwOyBpIDw9IDQ7IGkrKykge1xuICAvLyAgIGNvbnN0IGxvd2VyID0gaSA9PT0gMCA/IDAgOiBmbG9vcnNbaSAtIDFdO1xuICAvLyAgIGNvbnN0IHVwcGVyID0gaSA9PT0gNCA/IDAgOiBmbG9vcnNbaV07XG4gIC8vICAgY29uc3QgW2xvd2VyTG9jLCBsb3dlckluLCBsb3dlck91dF0gPSBleGl0c1tsb3dlcl07XG4gIC8vICAgY29uc3QgW3VwcGVyTG9jLCB1cHBlckluLCB1cHBlck91dF0gPSBlbnRyYW5jZXNbdXBwZXJdO1xuICAvLyAgIGNvbm5lY3QodXBwZXJMb2MsIHVwcGVyT3V0LCBsb3dlckxvYywgbG93ZXJJbik7XG4gIC8vICAgY29ubmVjdChsb3dlckxvYywgbG93ZXJPdXQsIHVwcGVyTG9jLCB1cHBlckluKTtcbiAgLy8gfVxuXG4gIC8vIC8vIEZpeCB0aGUgcGFsZXR0ZXMgYW5kIG11c2ljLlxuICAvLyBmb3IgKGNvbnN0IFtsXSBvZiBleGl0cykge1xuICAvLyAgIGlmICh0eXBlb2YgbC5kYXRhLm11c2ljID09PSAnbnVtYmVyJykge1xuICAvLyAgICAgbC5iZ20gPSBsLm5laWdoYm9yRm9yRW50cmFuY2UobC5kYXRhLm11c2ljIGFzIG51bWJlcikuYmdtO1xuICAvLyAgIH1cbiAgLy8gICBpZiAodHlwZW9mIGwuZGF0YS5wYWxldHRlID09PSAnbnVtYmVyJykge1xuICAvLyAgICAgY29uc3QgbiA9IGwubmVpZ2hib3JGb3JFbnRyYW5jZShsLmRhdGEucGFsZXR0ZSBhcyBudW1iZXIpLnRpbGVQYWxldHRlcztcbiAgLy8gICAgIGwudGlsZVBhbGV0dGVzID0gW25bMF0sIG5bMV0sIG5bMl1dO1xuICAvLyAgIH1cbiAgLy8gfVxufVxuIl19