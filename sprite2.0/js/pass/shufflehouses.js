import { Metalocation } from '../rom/metalocation.js';
import { DefaultMap } from '../util.js';
const HOUSE_ICON = 0x06;
const TALL_HOUSE_ICON = 0x21;
const icons = new Map([
    ['pawn', 0x36],
    ['inn', 0x37],
    ['armor', 0x38],
    ['tool', 0x39],
    ['tavern', 0x3b],
]);
const shops = new Set(['inn', 'armor', 'tool', 'pawn']);
const compat = new Set([...shops, 'house', 'tavern']);
export function shuffleHouses(rom, flags, random) {
    var _a, _b, _c;
    const { locations: { Crypt_Hall1, Goa, GoaFortress_Exit, Shyron }, metascreens: { squareTownNE_house, fortressTownEntrance, mountainPathE_gate }, } = rom;
    const palaceTowns = new Set([Goa.id, Shyron.id]);
    const firstPassOutsides = new Set([
        squareTownNE_house.data.id,
        fortressTownEntrance.data.id,
        mountainPathE_gate.data.id,
    ]);
    if (flags.shuffleAreas()) {
        for (const loc of [Goa, GoaFortress_Exit, Shyron, Crypt_Hall1]) {
            loc.data.houseType = 'palace';
        }
    }
    const byType = new DefaultMap(() => []);
    const byLocPos = new DefaultMap(() => []);
    const screens = new DefaultMap(() => new Set());
    for (const location of rom.locations) {
        if (!location.used)
            continue;
        if (location.data.houseType == null)
            continue;
        let bottomExit;
        for (const [pos, type, spec] of location.meta.exits()) {
            const coord = (pos & 0xf0) << 4 |
                (location.meta.get(pos).findExitByType(type).entrance >>> 8);
            if (!bottomExit || coord > bottomExit[3]) {
                bottomExit = [pos, type, spec, coord];
            }
        }
        for (const [pos, type, spec] of [bottomExit]) {
            const house = {
                type: location.data.houseType,
                inside: [location.id << 8 | pos, type],
                outside: spec,
            };
            let locpos = spec[0];
            byLocPos.get(locpos).push(house);
            byType.get(location.data.houseType).push(house);
            const screen = rom.locations[locpos >>> 8]
                .screens[(locpos >>> 4) & 0xf][locpos & 0xf];
            screens.get(screen).add(locpos);
        }
    }
    const secondPass = new Map();
    const firstPass = new Map();
    for (const [scr, locposs] of random.ishuffle(screens)) {
        if (locposs.size >= 2 || firstPassOutsides.has(scr)) {
            firstPass.set(scr, locposs);
        }
        else {
            secondPass.set(scr, locposs);
        }
    }
    const hasInn = new Set();
    const inns = byType.get('inn');
    for (const [, locposs] of [...firstPass, ...secondPass]) {
        const map = new Map();
        let first = true;
        for (const locpos of locposs) {
            for (const house of byLocPos.get(locpos)) {
                let eligible = first && compat.has(house.type) ?
                    [...compat].map(t => byType.get(t)) :
                    [byType.get((_a = map.get(house.outside[1])) !== null && _a !== void 0 ? _a : house.type)];
                eligible = eligible.filter(x => x.length);
                if (house.type === 'palace' && palaceTowns.has(house.outside[0] >>> 8)) {
                    eligible = eligible.map(x => x.filter(h => !palaceTowns.has(h.inside[0] >>> 8)));
                }
                const allowInn = [...locposs].every(lp => !hasInn.has(lp >>> 8));
                if (!allowInn && eligible.length > 1) {
                    eligible = eligible.filter(x => x !== inns);
                }
                else if (allowInn && eligible.some(x => x === inns)) {
                    eligible = [inns];
                }
                const replacement = random.pickAndRemove(...eligible);
                if (replacement.type === 'inn') {
                    for (const lp of locposs) {
                        hasInn.add(lp >>> 8);
                    }
                }
                map.set(house.outside[1], replacement.type);
                if (rom.spoiler) {
                    rom.spoiler.addHouse(replacement.inside[0] >>> 8, house.outside[0] >>> 8);
                }
                Metalocation.connect(rom, house.outside, replacement.inside);
                if (!first)
                    continue;
                if (icons.get(house.type) === icons.get(replacement.type))
                    continue;
                const outside = rom.locations[house.outside[0] >>> 8];
                if (outside.meta.tileset !== rom.metatilesets.town)
                    continue;
                const exits = Metalocation.findExitTiles(rom, house.outside);
                if (exits.length > 1)
                    continue;
                let coord = exits[0] - 0x20;
                if ((exits[0] & 0xf0) < 0x20)
                    coord -= 0x0f10;
                const pos = coord >> 8;
                const tile = coord & 0xff;
                const icon = (_b = icons.get(replacement.type)) !== null && _b !== void 0 ? _b : (((_c = outside.meta.get(pos).data.tallHouses) === null || _c === void 0 ? void 0 : _c.includes(tile)) ?
                    TALL_HOUSE_ICON : HOUSE_ICON);
                rom.screens[outside.screens[pos >> 4][pos & 0xf]].tiles[tile] = icon;
            }
            first = false;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWhvdXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVob3VzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBOEJBLE9BQU8sRUFBWSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUloRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBUXhDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQztBQUN4QixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQW9CO0lBQ3ZDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQztJQUNiLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztJQUNmLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBWSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDbkUsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQVksQ0FBQyxHQUFHLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUVqRSxNQUFNLFVBQVUsYUFBYSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYzs7SUFDcEUsTUFBTSxFQUNKLFNBQVMsRUFBRSxFQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFDLEVBQ3ZELFdBQVcsRUFBRSxFQUFDLGtCQUFrQixFQUNsQixvQkFBb0IsRUFDcEIsa0JBQWtCLEVBQUMsR0FDbEMsR0FBRyxHQUFHLENBQUM7SUFDUixNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFD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LENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzdELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDO29CQUFFLFNBQVM7Z0JBQy9CLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSTtvQkFBRSxLQUFLLElBQUksTUFBTSxDQUFDO2dCQUM5QyxNQUFNLEdBQUcsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDO2dCQUN2QixNQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDO2dCQUMxQixNQUFNLElBQUksU0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsbUNBQ3RDLENBQUMsT0FBQSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSwwQ0FBRSxRQUFRLENBQUMsSUFBSSxHQUFFLENBQUM7b0JBQ3ZELGVBQWUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ2pDLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQzthQUN0RTtZQUNELEtBQUssR0FBRyxLQUFLLENBQUM7U0FDZjtLQUNGO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNodWZmbGUgaG91c2Uvc2hvcC9zaGVkL3BhbGFjZSBlbnRyYW5jZXMuXG4vLyBUaGlzIGlzIHRyaWNreSBmb3IgYSBudW1iZXIgb2YgcmVhc29ucy4gIFdlIG5lZWQgdG8gcGF5IGF0dGVudGlvbiB0b1xuLy8ga2VlcCB0aGUgcmlnaHQgaWNvbiBhYm92ZSBlYWNoIGRvb3IsIHdoaWNoIGlzIGV4dHJhIHRyaWNreSBmb3IgdGhlXG4vLyAodmFuaWxsYSkgNSBzY3JlZW5zIHRoYXQgc2hhcmUgdHdvIHRvd25zLiAgVGhpcyBjYW4gYmUgbWl0aWdhdGVkIGJ5XG4vLyBleHBhbmRpbmcgdGhlIHNjcmVlbiBzcGFjZSBpbnRvIHRoZSBleHRyYSBST00gYXJlYSwgYnV0IGl0J3MgbmljZSB0b1xuLy8gc3RpbGwgd29yayB3aXRob3V0IHRoYXQuXG5cbi8vIE5PVEU6IEl0J3MgcG9zc2libGUgdGhhdCB3ZSBzaHVmZmxlIGFsbCB0aGUgc3BoZXJlLTAgY2hlY2tzIGF3YXkgZnJvbVxuLy8gTGVhZi4gIElmIHRoZXJlJ3Mgbm8gZXh0cmEgcGFzc2FnZSB0aGVuIHdlIG1heSBlbmQgdXAgd2l0aCBhbiBpbXBvc3NpYmxlXG4vLyBzaHVmZmxlLiAgSW4gdGhhdCBjYXNlLCB3ZSBuZWVkIHRvIGZpbmQgYSB3YXkgdG8gcmVncm91cC4gIEZvciBub3csIHRoZVxuLy8gZWFzaWVzdCBvcHRpb24gbWF5IGJlIHRvIGxlYXZlIHRob3NlIHR3byBob3VzZXMgb3V0IG9mIHRoZSBzaHVmZmxlLi4uXG5cblxuLy8gTk9URTogdGhlcmUncyBhIGJ1ZyB3aGVuIGVudHJhbmNlcyBhcmUgb3V0IG9mIG9yZGVyXG4vLyAgIC0gd2FycCB0byB0b3ducyBjb21lcyBvdXQgb2YgZG9vclxuLy8gICAtIGJvYXQgYnJva2VuIGlmIG5vdCBlbnRyYW5jZSAwIChlLmcuIGxpZ2h0aG91c2Ugb3IgYm9hdCBob3VzZSlcbi8vIC0+IG1pZ2h0IGJlIG5pY2UgdG8gZml4IGJvYXQsIGJ1dCBnZW5lcmFsbHkgd2UndmUgaGFkIGFsbCBzb3J0cyBvZlxuLy8gICAgaXNzdWVzIGZyb20gZW50cmFuY2UgcmVvcmRlcmluZyAtIHdlIHNob3VsZCB0cnkgdG8gZml4IGl0IHNvXG4vLyAgICB0aGF0IHRoZSBlbnRyYW5jZSB0eXBlcyBhcmUgcHJlc2VydmVkIGFzIG11Y2ggYXMgcG9zc2libGVcbi8vICAgIChpLmUuIGVkZ2UvZGlyZWN0aW9uIHZzIGRvb3IsIGV0Yylcbi8vICAgLSBjYW4gd2UgZGVmZXIgdGhlIGRlY2lzaW9uIG9mIHdoaWNoIGVudHJhbmNlIG51bWJlciB0byB1c2Vcbi8vICAgICB1bnRpbCBhIGxpdHRsZSBsYXRlciwgYW5kIGp1c3QgaW5kaXJlY3QgaXQgZm9yIGEgd2hpbGU/XG4vLyAgIC0gaWYgbWF6ZSBzaHVmZmxlIGlzIG9uLCBpdCBjb3VsZCBiZSBoYXJkIHRvIGZpZ3VyZSBvdXQgd2hpY2hcbi8vICAgICBpcyB3aGljaD8gZXhjZXB0IHdlIGRvIGtub3cgdGhlIGV4aXQgdHlwZXMgYW5kIHRoZSBudW1iZXJcbi8vICAgICBiZWZvcmUgd2UgYXNzaWduIGFueXRoaW5nLi4uIHNvIG1ha2UgYSBtYXBwaW5nIGFuZCB0aGVuIGZpbGxcbi8vICAgICBpbiBhbnkgZ2Fwcy5cblxuXG5pbXBvcnQgeyBSYW5kb20gfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHsgUm9tIH0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7IEV4aXRTcGVjLCBNZXRhbG9jYXRpb24gfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcbmltcG9ydCB7IEhvdXNlVHlwZSB9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBDb25uZWN0aW9uVHlwZSB9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuZGF0YS5qcyc7XG5pbXBvcnQgeyBGbGFnU2V0IH0gZnJvbSAnLi4vZmxhZ3NldC5qcyc7XG5pbXBvcnQgeyBEZWZhdWx0TWFwIH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbmludGVyZmFjZSBIb3VzZSB7XG4gIHR5cGU6IEhvdXNlVHlwZTtcbiAgaW5zaWRlOiBFeGl0U3BlYztcbiAgb3V0c2lkZTogRXhpdFNwZWM7XG59XG5cbmNvbnN0IEhPVVNFX0lDT04gPSAweDA2O1xuY29uc3QgVEFMTF9IT1VTRV9JQ09OID0gMHgyMTtcbmNvbnN0IGljb25zID0gbmV3IE1hcDxIb3VzZVR5cGUsIG51bWJlcj4oW1xuICBbJ3Bhd24nLCAweDM2XSxcbiAgWydpbm4nLCAweDM3XSxcbiAgWydhcm1vcicsIDB4MzhdLFxuICBbJ3Rvb2wnLCAweDM5XSxcbiAgWyd0YXZlcm4nLCAweDNiXSxcbl0pO1xuXG5jb25zdCBzaG9wcyA9IG5ldyBTZXQ8SG91c2VUeXBlPihbJ2lubicsICdhcm1vcicsICd0b29sJywgJ3Bhd24nXSk7XG5jb25zdCBjb21wYXQgPSBuZXcgU2V0PEhvdXNlVHlwZT4oWy4uLnNob3BzLCAnaG91c2UnLCAndGF2ZXJuJ10pO1xuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZUhvdXNlcyhyb206IFJvbSwgZmxhZ3M6IEZsYWdTZXQsIHJhbmRvbTogUmFuZG9tKSB7XG4gIGNvbnN0IHtcbiAgICBsb2NhdGlvbnM6IHtDcnlwdF9IYWxsMSwgR29hLCBHb2FGb3J0cmVzc19FeGl0LCBTaHlyb259LFxuICAgIG1ldGFzY3JlZW5zOiB7c3F1YXJlVG93bk5FX2hvdXNlLFxuICAgICAgICAgICAgICAgICAgZm9ydHJlc3NUb3duRW50cmFuY2UsXG4gICAgICAgICAgICAgICAgICBtb3VudGFpblBhdGhFX2dhdGV9LFxuICB9ID0gcm9tO1xuICBjb25zdCBwYWxhY2VUb3ducyA9IG5ldyBTZXQoW0dvYS5pZCwgU2h5cm9uLmlkXSk7XG4gIGNvbnN0IGZpcnN0UGFzc091dHNpZGVzID0gbmV3IFNldChbXG4gICAgLy8gTk9URTogc3R1ZGVudC9icm9rYWhhbmEgc2hvdWxkIGJlIGluIGZpcnN0IHBhc3MuXG4gICAgc3F1YXJlVG93bk5FX2hvdXNlLmRhdGEuaWQsXG4gICAgZm9ydHJlc3NUb3duRW50cmFuY2UuZGF0YS5pZCxcbiAgICBtb3VudGFpblBhdGhFX2dhdGUuZGF0YS5pZCxcbiAgXSk7XG5cbiAgaWYgKGZsYWdzLnNodWZmbGVBcmVhcygpKSB7XG4gICAgLy8gU2V0IGEgZmV3IGFkZGl0aW9uYWwgbG9jYXRpb25zIGFzIHBhbGFjZXNcbiAgICBmb3IgKGNvbnN0IGxvYyBvZiBbR29hLCBHb2FGb3J0cmVzc19FeGl0LCBTaHlyb24sIENyeXB0X0hhbGwxXSkge1xuICAgICAgbG9jLmRhdGEuaG91c2VUeXBlID0gJ3BhbGFjZSc7XG4gICAgfVxuICB9XG5cbiAgLy8gRmlyc3Qgb3JkZXIgb2YgYnVzaW5lc3M6IGNvbGxlY3QgYWxsIHRoZSBjb25uZWN0aW9ucy5cbiAgY29uc3QgYnlUeXBlID0gbmV3IERlZmF1bHRNYXA8SG91c2VUeXBlLCBIb3VzZVtdPigoKSA9PiBbXSk7XG4gIGNvbnN0IGJ5TG9jUG9zID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBIb3VzZVtdPigoKSA9PiBbXSk7IC8vIGtleTogTG9jUG9zXG4gIGNvbnN0IHNjcmVlbnMgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigoKSA9PiBuZXcgU2V0KCkpOyAvLyBTY3JJZCAtPiBMb2NQb3NcbiAgZm9yIChjb25zdCBsb2NhdGlvbiBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgaWYgKCFsb2NhdGlvbi51c2VkKSBjb250aW51ZTtcbiAgICBpZiAobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUgPT0gbnVsbCkgY29udGludWU7XG4gICAgLy8gUHJldmVudCBpbXBvc3NpYmxlIHNodWZmbGVzIGJ5IGVuc3VyaW5nIGl0ZW1zIGluIHNwaGVyZS0wXG4gICAgLy8gTm90ZTogaWYgd2UgaGF2ZSB0aGUgR0JDIGNhdmUsIHdlIGNvdWxkIHBvdGVudGlhbGx5IGxldCB0aGVzZVxuICAgIC8vIGhvdXNlcyBmbG9hdCwgc2luY2Ugd2UncmUgZ3VhcmFudGVlZCB0d28gZXh0cmEgY2hlY2tzICh0aG91Z2hcbiAgICAvLyBtaW1pY3MgYXJlIHNodWZmbGVkIGVhcmx5IG5vdywgc28gdGhhdCBjb3VsZCBzdGlsbCBjYXVzZSBhIHByb2JsZW0pLlxuICAgIC8vaWYgKGxvY2F0aW9uID09PSBMZWFmX0VsZGVySG91c2UgfHwgbG9jYXRpb24gPT09IExlYWZfU3R1ZGVudEhvdXNlKSBjb250aW51ZTtcbiAgICAvLyBUaGVyZSdzIHNvbWV0aGluZyBnbGl0Y2h5IGFib3V0IHRoaXMgb25lIC0gd2hlbiB3ZSBlbWVyZ2UsXG4gICAgLy8gdGhlIHNjcmVlbiBzY3JvbGxzIGFuZCBsb2Nrcy5cbiAgICAvL2lmIChsb2NhdGlvbiA9PT0gQm9hdEhvdXNlKSBjb250aW51ZTtcblxuICAgIC8vIEZvciBub24tc2hvcHMsIGZpbmQgdGhlIGJvdHRvbSBlZGdlXG4gICAgbGV0IGJvdHRvbUV4aXQhOiBbbnVtYmVyLCBDb25uZWN0aW9uVHlwZSwgRXhpdFNwZWMsIG51bWJlcl07XG4gICAgZm9yIChjb25zdCBbcG9zLCB0eXBlLCBzcGVjXSBvZiBsb2NhdGlvbi5tZXRhLmV4aXRzKCkpIHtcbiAgICAgIC8vIEZpbmQgYWJzb2x1dGUgWSBjb29yZGluYXRlIG9mIGFjdHVhbCBleGl0XG4gICAgICBjb25zdCBjb29yZCA9XG4gICAgICAgICAgKHBvcyAmIDB4ZjApIDw8IDQgfFxuICAgICAgICAgIChsb2NhdGlvbi5tZXRhLmdldChwb3MpLmZpbmRFeGl0QnlUeXBlKHR5cGUpLmVudHJhbmNlID4+PiA4KTtcbiAgICAgIGlmICghYm90dG9tRXhpdCB8fCBjb29yZCA+IGJvdHRvbUV4aXRbM10pIHtcbiAgICAgICAgYm90dG9tRXhpdCA9IFtwb3MsIHR5cGUsIHNwZWMsIGNvb3JkXTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBbcG9zLCB0eXBlLCBzcGVjXSBvZiBbYm90dG9tRXhpdF0pIHtcbiAgICAgIC8vIGlmICh0eXBlID09PSAnZWRnZTpib3R0b20nIHx8IHNob3BzLmhhcyhsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSkgfHxcbiAgICAgIC8vICAgIChsb2NhdGlvbi5tZXRhLnRpbGVzZXQgPT09IHJvbS5tZXRhdGlsZXNldHMuZm9ydHJlc3MgJiZcbiAgICAgIC8vICAgICB0eXBlID09PSAnc3RhaXI6ZG93bicpIHx8XG4gICAgICAvLyAgICAobG9jYXRpb24gPT09IEdvYUZvcnRyZXNzX0V4aXQgJiZcbiAgICAgIC8vICAgICB0eXBlID09PSAnc3RhaXI6ZG93bicgJiZcbiAgICAgIC8vICAgICBwb3MgPT09IDB4MzEpKSB7XG4gICAgICAgIGNvbnN0IGhvdXNlOiBIb3VzZSA9IHtcbiAgICAgICAgICB0eXBlOiBsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSxcbiAgICAgICAgICBpbnNpZGU6IFtsb2NhdGlvbi5pZCA8PCA4IHwgcG9zLCB0eXBlXSxcbiAgICAgICAgICBvdXRzaWRlOiBzcGVjLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgbG9jcG9zID0gc3BlY1swXTtcbiAgICAgICAgLy8gQ2hlY2sgb3V0c2lkZSBzcGVjIGZvciBzaHlyb24uLi5cbiAgICAgICAgLy8gaWYgKGxvY2F0aW9uID09PSBTaHlyb24gJiZcbiAgICAgICAgLy8gICAgIChsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSA9PT0gJ2FybW9yJyB8fFxuICAgICAgICAvLyAgICAgIGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlID09PSAndG9vbCcpKSB7XG4gICAgICAgIC8vICAgbG9jcG9zIC09IDB4MTA7IC8vIGljb24gaXMgYWN0dWFsbHkgb24gcHJldmlvdXMgc2NyZWVuXG4gICAgICAgIC8vIH1cbiAgICAgICAgYnlMb2NQb3MuZ2V0KGxvY3BvcykucHVzaChob3VzZSk7XG4gICAgICAgIGJ5VHlwZS5nZXQobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUpLnB1c2goaG91c2UpO1xuICAgICAgICBjb25zdCBzY3JlZW4gPVxuICAgICAgICAgICAgcm9tLmxvY2F0aW9uc1tsb2Nwb3MgPj4+IDhdXG4gICAgICAgICAgICAgICAgLnNjcmVlbnNbKGxvY3BvcyA+Pj4gNCkgJiAweGZdW2xvY3BvcyAmIDB4Zl07XG4gICAgICAgIHNjcmVlbnMuZ2V0KHNjcmVlbikuYWRkKGxvY3Bvcyk7XG4gICAgICAvLyB9XG4gICAgfVxuICB9XG5cbiAgLy8gVHdvIHBhc3NlczogMS4gb25seSBoYW5kbGUgb3ZlcmxvYWRlZCBzY3JlZW5zOyAyLiBhbGwgdGhlIHJlc3QuXG4gIGNvbnN0IHNlY29uZFBhc3MgPSBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCk7XG4gIGNvbnN0IGZpcnN0UGFzcyA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgZm9yIChjb25zdCBbc2NyLCBsb2Nwb3NzXSBvZiByYW5kb20uaXNodWZmbGUoc2NyZWVucykpIHtcbiAgICBpZiAobG9jcG9zcy5zaXplID49IDIgfHwgZmlyc3RQYXNzT3V0c2lkZXMuaGFzKHNjcikpIHtcbiAgICAgIGZpcnN0UGFzcy5zZXQoc2NyLCBsb2Nwb3NzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2Vjb25kUGFzcy5zZXQoc2NyLCBsb2Nwb3NzKTtcbiAgICB9XG4gIH1cbiAgY29uc3QgaGFzSW5uID0gbmV3IFNldDxudW1iZXI+KCk7XG4gIGNvbnN0IGlubnMgPSBieVR5cGUuZ2V0KCdpbm4nKTtcbiAgZm9yIChjb25zdCBbLCBsb2Nwb3NzXSBvZiBbLi4uZmlyc3RQYXNzLCAuLi5zZWNvbmRQYXNzXSkge1xuICAgIC8vY29uc29sZS5sb2coYHNodWZmbGluZyBzY3JlZW4gJHtzY3IudG9TdHJpbmcoMTYpfTogJHtbLi4ubG9jcG9zc10ubWFwKGw9PmwudG9TdHJpbmcoMTYpKS5qb2luKCcsJyl9YCk7XG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxDb25uZWN0aW9uVHlwZSwgSG91c2VUeXBlPigpO1xuICAgIGxldCBmaXJzdCA9IHRydWU7XG4gICAgZm9yIChjb25zdCBsb2Nwb3Mgb2YgbG9jcG9zcykge1xuICAgICAgZm9yIChjb25zdCBob3VzZSBvZiBieUxvY1Bvcy5nZXQobG9jcG9zKSkge1xuICAgICAgICBsZXQgZWxpZ2libGUgPSBmaXJzdCAmJiBjb21wYXQuaGFzKGhvdXNlLnR5cGUpID9cbiAgICAgICAgICBbLi4uY29tcGF0XS5tYXAodCA9PiBieVR5cGUuZ2V0KHQpKSA6XG4gICAgICAgICAgW2J5VHlwZS5nZXQobWFwLmdldChob3VzZS5vdXRzaWRlWzFdKSA/PyBob3VzZS50eXBlKV07XG4gICAgICAgIGVsaWdpYmxlID0gZWxpZ2libGUuZmlsdGVyKHggPT4geC5sZW5ndGgpO1xuICAgICAgICAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgY29ubmVjdCB0aGUgXCJwYWxhY2UgdG93bnNcIiAoZ29hIGFuZCBzaHlyb24pIGluXG4gICAgICAgIC8vIGEgY2xvc2VkIGxvb3AsIGVpdGhlciB0byBpdHNlbGYgKGdvYSdzIGVudHJhbmNlIGlzIGluc2lkZSBpdHNlbGYpXG4gICAgICAgIC8vIG9yIGluIGEgZmlndXJlLWVpdGhlciAoZ29hIHRvcCA9PiBzaHlyb24sIGFuZCBzaHlyb24gdGVtcGxlID0+IGdvYSkuXG4gICAgICAgIGlmIChob3VzZS50eXBlID09PSAncGFsYWNlJyAmJiBwYWxhY2VUb3ducy5oYXMoaG91c2Uub3V0c2lkZVswXSA+Pj4gOCkpIHtcbiAgICAgICAgICBlbGlnaWJsZSA9IGVsaWdpYmxlLm1hcCh4ID0+IHguZmlsdGVyKFxuICAgICAgICAgICAgICBoID0+ICFwYWxhY2VUb3ducy5oYXMoaC5pbnNpZGVbMF0gPj4+IDgpKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gQXZvaWQgbW9yZSB0aGFuIG9uZSBpbm4gcGVyIHRvd24sIHNpbmNlIHRoYXQncyBsYW1lLlxuICAgICAgICAvLyBBbHNvLCBwbGFjZSBpbm5zIGZpcnN0IHNvIGFzIHRvIG1vc3QgZXZlbmx5IGRpc3RyaWJ1dGUgdGhlbS5cbiAgICAgICAgY29uc3QgYWxsb3dJbm4gPSBbLi4ubG9jcG9zc10uZXZlcnkobHAgPT4gIWhhc0lubi5oYXMobHAgPj4+IDgpKTtcbiAgICAgICAgaWYgKCFhbGxvd0lubiAmJiBlbGlnaWJsZS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgZWxpZ2libGUgPSBlbGlnaWJsZS5maWx0ZXIoeCA9PiB4ICE9PSBpbm5zKTtcbiAgICAgICAgfSBlbHNlIGlmIChhbGxvd0lubiAmJiBlbGlnaWJsZS5zb21lKHggPT4geCA9PT0gaW5ucykpIHtcbiAgICAgICAgICBlbGlnaWJsZSA9IFtpbm5zXTtcbiAgICAgICAgfVxuICAgICAgICAvLyBOT1RFOiBpZiBzdHVkZW50IGlzIHN0YXlpbmcgcHV0IHRoZW4gZG9uJ3Qgc2h1ZmZsZSBicm9rYWhhbmEgdG8gYSBub24taG91c2VcbiAgICAgICAgLy8gVE9ETyAtIGJldHRlciBjb25kaXRpb24sIHBhcnRpY3VsYXJseSBpZiB3ZSBfZG9fIHNodWZmbGUgc3R1ZGVudCBvciBpZiB3ZSBzcGxpdCBzY3JlZW5zXG4gICAgICAgIC8vIGlmICgoaG91c2Uub3V0c2lkZVswXSA+Pj4gOCkgPT09IEdvYV9Ib3VzZS5pZCAmJiBieVR5cGUuZ2V0KCdob3VzZScpLmxlbmd0aCkge1xuICAgICAgICAvLyAgIGVsaWdpYmxlID0gW2J5VHlwZS5nZXQoJ2hvdXNlJyldO1xuICAgICAgICAvLyB9XG4gICAgICAgIC8vIEFsc28gcHJldmVudCBtdWx0aXBsZSBpbm5zIGluIHRoZSBzYW1lIHRvd24/XG4gICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmFuZG9tLnBpY2tBbmRSZW1vdmUoLi4uZWxpZ2libGUpO1xuICAgICAgICBpZiAocmVwbGFjZW1lbnQudHlwZSA9PT0gJ2lubicpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGxwIG9mIGxvY3Bvc3MpIHtcbiAgICAgICAgICAgIGhhc0lubi5hZGQobHAgPj4+IDgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBtYXAuc2V0KGhvdXNlLm91dHNpZGVbMV0sIHJlcGxhY2VtZW50LnR5cGUpO1xuICAgICAgICBpZiAocm9tLnNwb2lsZXIpIHtcbiAgICAgICAgICByb20uc3BvaWxlci5hZGRIb3VzZShyZXBsYWNlbWVudC5pbnNpZGVbMF0gPj4+IDgsIGhvdXNlLm91dHNpZGVbMF0gPj4+IDgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIE1ha2UgdGhlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9jb25zb2xlLmxvZyhgY29ubmVjdCAke3JvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXT4+PjhdLm5hbWV9ICR7aG91c2Uub3V0c2lkZVswXS50b1N0cmluZygxNil9ICR7aG91c2Uub3V0c2lkZVsxXX0gLS0gJHtyb20ubG9jYXRpb25zW3JlcGxhY2VtZW50Lmluc2lkZVswXT4+PjhdLm5hbWV9ICR7cmVwbGFjZW1lbnQuaW5zaWRlWzBdLnRvU3RyaW5nKDE2KX0gJHtyZXBsYWNlbWVudC5pbnNpZGVbMV19YCk7XG4gICAgICAgIE1ldGFsb2NhdGlvbi5jb25uZWN0KHJvbSwgaG91c2Uub3V0c2lkZSwgcmVwbGFjZW1lbnQuaW5zaWRlKTtcbiAgICAgICAgLy8gUmVwbGFjZSB0aGUgaWNvbiAoaWYgYXBwbGljYWJsZSlcbiAgICAgICAgaWYgKCFmaXJzdCkgY29udGludWU7XG4gICAgICAgIGlmIChpY29ucy5nZXQoaG91c2UudHlwZSkgPT09IGljb25zLmdldChyZXBsYWNlbWVudC50eXBlKSkgY29udGludWU7XG4gICAgICAgIGNvbnN0IG91dHNpZGUgPSByb20ubG9jYXRpb25zW2hvdXNlLm91dHNpZGVbMF0gPj4+IDhdO1xuICAgICAgICBpZiAob3V0c2lkZS5tZXRhLnRpbGVzZXQgIT09IHJvbS5tZXRhdGlsZXNldHMudG93bikgY29udGludWU7XG4gICAgICAgIGNvbnN0IGV4aXRzID0gTWV0YWxvY2F0aW9uLmZpbmRFeGl0VGlsZXMocm9tLCBob3VzZS5vdXRzaWRlKTtcbiAgICAgICAgaWYgKGV4aXRzLmxlbmd0aCA+IDEpIGNvbnRpbnVlO1xuICAgICAgICBsZXQgY29vcmQgPSBleGl0c1swXSAtIDB4MjA7XG4gICAgICAgIGlmICgoZXhpdHNbMF0gJiAweGYwKSA8IDB4MjApIGNvb3JkIC09IDB4MGYxMDsgLy8gZnVubnkgdmVydGljYWwgbWF0aFxuICAgICAgICBjb25zdCBwb3MgPSBjb29yZCA+PiA4O1xuICAgICAgICBjb25zdCB0aWxlID0gY29vcmQgJiAweGZmO1xuICAgICAgICBjb25zdCBpY29uID0gaWNvbnMuZ2V0KHJlcGxhY2VtZW50LnR5cGUpID8/XG4gICAgICAgICAgKG91dHNpZGUubWV0YS5nZXQocG9zKS5kYXRhLnRhbGxIb3VzZXM/LmluY2x1ZGVzKHRpbGUpID9cbiAgICAgICAgICAgVEFMTF9IT1VTRV9JQ09OIDogSE9VU0VfSUNPTik7XG4gICAgICAgIHJvbS5zY3JlZW5zW291dHNpZGUuc2NyZWVuc1twb3MgPj4gNF1bcG9zICYgMHhmXV0udGlsZXNbdGlsZV0gPSBpY29uO1xuICAgICAgfVxuICAgICAgZmlyc3QgPSBmYWxzZTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==