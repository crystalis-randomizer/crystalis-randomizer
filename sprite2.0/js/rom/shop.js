import { Entity, EntityArray } from './entity.js';
import { readLittleEndian, seq, tuple } from './util.js';
export class Shops extends EntityArray {
    constructor(rom) {
        super(44);
        this.rom = rom;
        this.innBasePrice = 20;
        this.toolShopScaling = new Array(48).fill(0);
        this.armorShopScaling = new Array(48).fill(0);
        for (let i = 0; i < 44; i++) {
            this[i] = new Shop(rom, i);
        }
        if (rom.shopDataTablesAddress != null) {
            const address = rom.shopDataTablesAddress +
                21 * rom.shopCount +
                2 * rom.scalingLevels;
            this.basePrices = seq(0x49, id => id >= 0xd && id < 0x27 ?
                readLittleEndian(rom.prg, address + 2 * (id - 0xd)) :
                0);
        }
        else {
            this.basePrices =
                seq(0x49, id => readLittleEndian(rom.prg, VANILLA_PAWN_PRICE_TABLE + 2 * id) * 2);
        }
    }
    armorShops() {
        return seq(11, i => this[4 * i]);
    }
    toolShops() {
        return seq(11, i => this[4 * i + 1]);
    }
    inns() {
        return seq(11, i => this[4 * i + 2]);
    }
    pawnShops() {
        return seq(11, i => this[4 * i + 3]);
    }
    write() {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const a = this.rom.assembler();
        if (this.rescale) {
            function exportLabel(label) {
                a.export(label);
                a.label(label);
            }
            a.segment("10", "fe", "ff");
            a.reloc('ShopData');
            exportLabel('ShopData');
            exportLabel('ArmorShopIdTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_a = shop.contents[i]) !== null && _a !== void 0 ? _a : 0xff);
                }
            }
            exportLabel('ToolShopIdTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_b = shop.contents[i]) !== null && _b !== void 0 ? _b : 0xff);
                }
            }
            exportLabel('ArmorShopPriceTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round(((_c = shop.prices[i]) !== null && _c !== void 0 ? _c : 0) * 32));
                }
            }
            exportLabel('ToolShopPriceTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round(((_d = shop.prices[i]) !== null && _d !== void 0 ? _d : 0) * 32));
                }
            }
            exportLabel('InnPrices');
            for (const shop of this.inns()) {
                a.byte(Math.round(((_e = shop.prices[0]) !== null && _e !== void 0 ? _e : 0) * 32));
            }
            exportLabel('ShopLocations');
            for (const shop of this) {
                a.byte(shop.location);
            }
            exportLabel('ToolShopScaling');
            a.byte(...this.toolShopScaling);
            exportLabel('ArmorShopScaling');
            a.byte(...this.armorShopScaling);
            exportLabel('BasePrices');
            a.word(...this.basePrices.slice(0x0d, 0x27).map(x => x !== null && x !== void 0 ? x : 0));
            exportLabel('InnBasePrice');
            a.word(this.innBasePrice);
        }
        else {
            a.segment('10', 'fe', 'ff');
            a.org(0x9da4, 'ShopData');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_f = shop.contents[i]) !== null && _f !== void 0 ? _f : 0xff);
                }
            }
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_g = shop.prices[i]) !== null && _g !== void 0 ? _g : 0);
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_h = shop.contents[i]) !== null && _h !== void 0 ? _h : 0xff);
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_j = shop.prices[i]) !== null && _j !== void 0 ? _j : 0);
                }
            }
        }
        return [a.module()];
    }
}
export var ShopType;
(function (ShopType) {
    ShopType[ShopType["ARMOR"] = 0] = "ARMOR";
    ShopType[ShopType["TOOL"] = 1] = "TOOL";
    ShopType[ShopType["INN"] = 2] = "INN";
    ShopType[ShopType["PAWN"] = 3] = "PAWN";
})(ShopType || (ShopType = {}));
const SHOP_TYPES = [ShopType.ARMOR, ShopType.TOOL, ShopType.INN, ShopType.PAWN];
const CONTENTS_ADDRESSES = [
    (base, count) => base ? base : VANILLA_ARMOR_SHOP_ITEMS,
    (base, count) => base ? base + 4 * count : VANILLA_TOOL_SHOP_ITEMS,
    (base, count) => 0,
    (base, count) => 0,
];
const CONTENTS_COUNTS = [4, 4, 0, 0];
const PRICES_ADDRESSES = [
    (base, count) => base ? base + 8 * count : VANILLA_ARMOR_SHOP_PRICES,
    (base, count) => base ? base + 12 * count : VANILLA_TOOL_SHOP_PRICES,
    (base, count) => base ? base + 16 * count : VANILLA_INN_PRICES,
    (base, count) => 0,
];
const PRICES_COUNTS = [4, 4, 1, 0];
export class Shop extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.type = SHOP_TYPES[id & 3];
        this.index = id >>> 2;
        if (rom.shopDataTablesAddress) {
            const base = rom.shopDataTablesAddress;
            const count = rom.shopCount;
            const locationTable = base + 17 * count;
            this.location = rom.prg[locationTable + id];
        }
        else {
            let shopLocation = 0xff;
            for (let i = 0; i < 33 && shopLocation === 0xff; i++) {
                if (rom.prg[VANILLA_SHOP_INDICES + i] !== this.index)
                    continue;
                const location = rom.prg[VANILLA_SHOP_LOCATIONS + i];
                for (const spawn of rom.locations[location].spawns) {
                    if (spawn.type !== 4)
                        continue;
                    const obj = rom.objects[spawn.id];
                    if (obj.data[25] === 0x20 + this.type) {
                        shopLocation = location;
                        break;
                    }
                }
            }
            this.location = shopLocation;
        }
        const readPrice = rom.shopDataTablesAddress ?
            i => rom.prg[this.pricesAddress + i] / 32 :
            i => readLittleEndian(rom.prg, this.pricesAddress + 2 * i);
        this.contents = tuple(rom.prg, this.contentsAddress, CONTENTS_COUNTS[this.type]);
        this.prices = seq(PRICES_COUNTS[this.type], readPrice);
        this.used = this.location !== 0xff;
    }
    get contentsAddress() {
        const base = CONTENTS_ADDRESSES[this.type](this.rom.shopDataTablesAddress, this.rom.shopCount);
        return base + 4 * this.index;
    }
    get pricesAddress() {
        const shopTable = this.rom.shopDataTablesAddress;
        const base = PRICES_ADDRESSES[this.type](shopTable, this.rom.shopCount);
        return base + (shopTable ? 1 : 2) * PRICES_COUNTS[this.type] * this.index;
    }
    updateShopkeeper() {
        throw new Error('not implemented');
    }
}
const VANILLA_SHOP_LOCATIONS = 0x21f54;
const VANILLA_SHOP_INDICES = 0x21f75;
const VANILLA_ARMOR_SHOP_ITEMS = 0x21da4;
const VANILLA_ARMOR_SHOP_PRICES = 0x21dd0;
const VANILLA_TOOL_SHOP_ITEMS = 0x21e28;
const VANILLA_TOOL_SHOP_PRICES = 0x21e54;
const VANILLA_INN_PRICES = 0x21eac;
const VANILLA_PAWN_PRICE_TABLE = 0x21ec2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vc2hvcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUd2RCxNQUFNLE9BQU8sS0FBTSxTQUFRLFdBQWlCO0lBUTFDLFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRFMsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUw3QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixvQkFBZSxHQUFhLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxxQkFBZ0IsR0FBYSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFLakQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzVCO1FBRUQsSUFBSSxHQUFHLENBQUMscUJBQXFCLElBQUksSUFBSSxFQUFFO1lBQ3JDLE1BQU0sT0FBTyxHQUNULEdBQUcsQ0FBQyxxQkFBcUI7Z0JBQ3pCLEVBQUUsR0FBRyxHQUFHLENBQUMsU0FBUztnQkFDbEIsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUM7WUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxD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QUFDLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQzVFLENBQUM7SUFNRCxnQkFBZ0I7UUFPZCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDckMsQ0FBQztDQUNGO0FBRUQsTUFBTSxzQkFBc0IsR0FBRyxPQUFPLENBQUM7QUFDdkMsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUM7QUFDckMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUM7QUFDekMsTUFBTSx5QkFBeUIsR0FBRyxPQUFPLENBQUM7QUFDMUMsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUM7QUFDeEMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUM7QUFDekMsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUM7QUFDbkMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50aXR5LCBFbnRpdHlBcnJheX0gZnJvbSAnLi9lbnRpdHkuanMnO1xuaW1wb3J0IHtyZWFkTGl0dGxlRW5kaWFuLCBzZXEsIHR1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuXG5cbmV4cG9ydCBjbGFzcyBTaG9wcyBleHRlbmRzIEVudGl0eUFycmF5PFNob3A+IHtcblxuICByZXNjYWxlPzogYm9vbGVhbjtcbiAgaW5uQmFzZVByaWNlID0gMjA7XG4gIHRvb2xTaG9wU2NhbGluZzogbnVtYmVyW10gPSBuZXcgQXJyYXkoNDgpLmZpbGwoMCk7XG4gIGFybW9yU2hvcFNjYWxpbmc6IG51bWJlcltdID0gbmV3IEFycmF5KDQ4KS5maWxsKDApO1xuICBiYXNlUHJpY2VzOiBudW1iZXJbXTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuICAgIHN1cGVyKDQ0KTsgLy8gNCAqIHJvbS5zaG9wQ291bnQpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDQ7IGkrKykge1xuICAgICAgdGhpc1tpXSA9IG5ldyBTaG9wKHJvbSwgaSk7XG4gICAgfVxuXG4gICAgaWYgKHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MgIT0gbnVsbCkge1xuICAgICAgY29uc3QgYWRkcmVzcyA9XG4gICAgICAgICAgcm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcyArXG4gICAgICAgICAgMjEgKiByb20uc2hvcENvdW50ICtcbiAgICAgICAgICAyICogcm9tLnNjYWxpbmdMZXZlbHM7XG4gICAgICB0aGlzLmJhc2VQcmljZXMgPSBzZXEoMHg0OSwgaWQgPT4gaWQgPj0gMHhkICYmIGlkIDwgMHgyNyA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyArIDIgKiAoaWQgLSAweGQpKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYmFzZVByaWNlcyA9XG4gICAgICAgICAgc2VxKDB4NDksXG4gICAgICAgICAgICAgIGlkID0+IHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWQU5JTExBX1BBV05fUFJJQ0VfVEFCTEUgKyAyICogaWQpICogMik7XG4gICAgfVxuICAgIFxuICB9XG5cbiAgYXJtb3JTaG9wcygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaV0pO1xuICB9XG5cbiAgdG9vbFNob3BzKCk6IFNob3BbXSB7XG4gICAgcmV0dXJuIHNlcSgxMSwgaSA9PiB0aGlzWzQgKiBpICsgMV0pO1xuICB9XG5cbiAgaW5ucygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaSArIDJdKTtcbiAgfVxuXG4gIHBhd25TaG9wcygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaSArIDNdKTtcbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBjb25zdCBhID0gdGhpcy5yb20uYXNzZW1ibGVyKCk7XG4gICAgaWYgKHRoaXMucmVzY2FsZSkge1xuICAgICAgZnVuY3Rpb24gZXhwb3J0TGFiZWwobGFiZWw6IHN0cmluZykge1xuICAgICAgICBhLmV4cG9ydChsYWJlbCk7XG4gICAgICAgIGEubGFiZWwobGFiZWwpO1xuICAgICAgfVxuICAgICAgYS5zZWdtZW50KFwiMTBcIiwgXCJmZVwiLCBcImZmXCIpO1xuICAgICAgYS5yZWxvYygnU2hvcERhdGEnKTsgLy8gVE9ETyAtIGJyZWFrIHRoaXMgdXAgYSBiaXQ/XG4gICAgICAvLyBOT1RFOiBUaGlzIHN0cnVjdHVyZSBpcyBoYXJkLWNvZGVkIGluIFJvbU9wdGlvbiwgd2l0aCB0d28gcGFyYW1ldGVyczpcbiAgICAgIC8vICAxLiBTSE9QX0NPVU5UICgxMSlcbiAgICAgIC8vICAyLiBTQ0FMSU5HX0xFVkVMUyAoNDgpXG4gICAgICAvLyAgMy4gUGF3biBwcmljZXM6IDUyIGJ5dGVzICAgOyAwID0gJDBkLCA1MCA9ICQyNiwgNTEgPSBcIiQyN1wiIChpbm4pXG4gICAgICBleHBvcnRMYWJlbCgnU2hvcERhdGEnKTtcbiAgICAgIGV4cG9ydExhYmVsKCdBcm1vclNob3BJZFRhYmxlJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy5hcm1vclNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoc2hvcC5jb250ZW50c1tpXSA/PyAweGZmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ1Rvb2xTaG9wSWRUYWJsZScpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoc2hvcC5jb250ZW50c1tpXSA/PyAweGZmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ0FybW9yU2hvcFByaWNlVGFibGUnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLmFybW9yU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEuYnl0ZShNYXRoLnJvdW5kKChzaG9wLnByaWNlc1tpXSA/PyAwKSAqIDMyKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdUb29sU2hvcFByaWNlVGFibGUnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLnRvb2xTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKE1hdGgucm91bmQoKHNob3AucHJpY2VzW2ldID8/IDApICogMzIpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ0lublByaWNlcycpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuaW5ucygpKSB7XG4gICAgICAgIGEuYnl0ZShNYXRoLnJvdW5kKChzaG9wLnByaWNlc1swXSA/PyAwKSAqIDMyKSk7XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnU2hvcExvY2F0aW9ucycpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMpIHtcbiAgICAgICAgYS5ieXRlKHNob3AubG9jYXRpb24pO1xuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ1Rvb2xTaG9wU2NhbGluZycpO1xuICAgICAgYS5ieXRlKC4uLnRoaXMudG9vbFNob3BTY2FsaW5nKTtcbiAgICAgIGV4cG9ydExhYmVsKCdBcm1vclNob3BTY2FsaW5nJyk7XG4gICAgICBhLmJ5dGUoLi4udGhpcy5hcm1vclNob3BTY2FsaW5nKTtcbiAgICAgIGV4cG9ydExhYmVsKCdCYXNlUHJpY2VzJyk7XG4gICAgICBhLndvcmQoLi4udGhpcy5iYXNlUHJpY2VzLnNsaWNlKDB4MGQsIDB4MjcpLm1hcCh4ID0+IHggPz8gMCkpO1xuICAgICAgZXhwb3J0TGFiZWwoJ0lubkJhc2VQcmljZScpO1xuICAgICAgYS53b3JkKHRoaXMuaW5uQmFzZVByaWNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVE9ETyAtIGNhbiB3ZSBldmVuIHdyaXRlIG5vbi1kZWZyYWdnZWQgc2hvcHM/XG4gICAgICBhLnNlZ21lbnQoJzEwJywgJ2ZlJywgJ2ZmJyk7XG4gICAgICBhLm9yZygweDlkYTQsICdTaG9wRGF0YScpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuYXJtb3JTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKHNob3AuY29udGVudHNbaV0gPz8gMHhmZik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLmFybW9yU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEud29yZChzaG9wLnByaWNlc1tpXSA/PyAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoc2hvcC5jb250ZW50c1tpXSA/PyAweGZmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLndvcmQoc2hvcC5wcmljZXNbaV0gPz8gMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxufVxuXG5cbi8vIFNob3BzIGFyZSBzdHJpcGVkOiB0b29sLCBhcm1vciwgaW5uLCBwYXduXG4vLyBTbyB0aGUgdG9vbCBzaG9wcyBoYXZlIElEIDAsIDQsIDgsIC4uLiwgNDA7IGV0Y1xuZXhwb3J0IGVudW0gU2hvcFR5cGUge1xuICBBUk1PUiA9IDAsXG4gIFRPT0wgPSAxLFxuICBJTk4gPSAyLFxuICBQQVdOID0gMyxcbn1cblxuY29uc3QgU0hPUF9UWVBFUyA9IFtTaG9wVHlwZS5BUk1PUiwgU2hvcFR5cGUuVE9PTCwgU2hvcFR5cGUuSU5OLCBTaG9wVHlwZS5QQVdOXTtcblxuY29uc3QgQ09OVEVOVFNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlIDogVkFOSUxMQV9BUk1PUl9TSE9QX0lURU1TLFxuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgNCAqIGNvdW50IDogVkFOSUxMQV9UT09MX1NIT1BfSVRFTVMsXG4gIChiYXNlLCBjb3VudCkgPT4gMCxcbiAgKGJhc2UsIGNvdW50KSA9PiAwLFxuXTtcblxuY29uc3QgQ09OVEVOVFNfQ09VTlRTID0gWzQsIDQsIDAsIDBdO1xuXG5jb25zdCBQUklDRVNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgOCAqIGNvdW50IDogVkFOSUxMQV9BUk1PUl9TSE9QX1BSSUNFUyxcbiAgKGJhc2UsIGNvdW50KSA9PiBiYXNlID8gYmFzZSArIDEyICogY291bnQgOiBWQU5JTExBX1RPT0xfU0hPUF9QUklDRVMsXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgKyAxNiAqIGNvdW50IDogVkFOSUxMQV9JTk5fUFJJQ0VTLFxuICAoYmFzZSwgY291bnQpID0+IDAsXG5dO1xuXG5jb25zdCBQUklDRVNfQ09VTlRTID0gWzQsIDQsIDEsIDBdO1xuXG5leHBvcnQgY2xhc3MgU2hvcCBleHRlbmRzIEVudGl0eSB7XG5cbiAgcmVhZG9ubHkgdXNlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgbG9jYXRpb246IG51bWJlcjtcbiAgcmVhZG9ubHkgaW5kZXg6IG51bWJlcjtcbiAgcmVhZG9ubHkgdHlwZTogU2hvcFR5cGU7XG5cbiAgLy8gTGlzdCBvZiB1cCB0byA0IGl0ZW0gSURzIGJlaW5nIHNvbGQgYXQgdGhpcyBzaG9wLlxuICBjb250ZW50czogbnVtYmVyW107XG5cbiAgLy8gTWVhbmluZyBkZXBlbmRzIG9uIHdoZXRoZXIgc2hvcHMgYXJlIG5vcm1hbGl6ZWQuICBJZiBzbyB0aGVuIHRoaXMgaXNcbiAgLy8gdGhlIGFkanVzdG1lbnQgZnJvbSB0aGUgYmFzZSBwcmljZSwgYXMgYSBmcmFjdGlvbi4gIElmIG5vdCB0aGVuIHRoaXNcbiAgLy8gaXMganVzdCB0aGUgMTYtYml0IHByaWNlLlxuICBwcmljZXM6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG5cbiAgICB0aGlzLnR5cGUgPSBTSE9QX1RZUEVTW2lkICYgM107XG4gICAgdGhpcy5pbmRleCA9IGlkID4+PiAyO1xuXG4gICAgaWYgKHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MpIHtcbiAgICAgIC8vIE5vcm1hbGl6ZWQgcHJpY2VzIC0gY29uc3RydWN0IHRoZSB0YWJsZSBsb2NhdGlvbnNcbiAgICAgIGNvbnN0IGJhc2UgPSByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAgICAgY29uc3QgY291bnQgPSByb20uc2hvcENvdW50O1xuICAgICAgY29uc3QgbG9jYXRpb25UYWJsZSA9IGJhc2UgKyAxNyAqIGNvdW50O1xuICAgICAgdGhpcy5sb2NhdGlvbiA9IHJvbS5wcmdbbG9jYXRpb25UYWJsZSArIGlkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFuaWxsYSBzaG9wczogbmVlZCB0byBkbyBhIG1vcmUgaW52b2x2ZWQgc2VhcmNoIGZvciBzaG9wIGxvY2F0aW9uLlxuICAgICAgbGV0IHNob3BMb2NhdGlvbiA9IDB4ZmY7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMzICYmIHNob3BMb2NhdGlvbiA9PT0gMHhmZjsgaSsrKSB7XG4gICAgICAgIGlmIChyb20ucHJnW1ZBTklMTEFfU0hPUF9JTkRJQ0VTICsgaV0gIT09IHRoaXMuaW5kZXgpIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbS5wcmdbVkFOSUxMQV9TSE9QX0xPQ0FUSU9OUyArIGldO1xuICAgICAgICBmb3IgKGNvbnN0IHNwYXduIG9mIHJvbS5sb2NhdGlvbnNbbG9jYXRpb25dLnNwYXducykge1xuICAgICAgICAgIGlmIChzcGF3bi50eXBlICE9PSA0KSBjb250aW51ZTtcbiAgICAgICAgICBjb25zdCBvYmogPSByb20ub2JqZWN0c1tzcGF3bi5pZF07XG4gICAgICAgICAgaWYgKG9iai5kYXRhWzI1XSA9PT0gMHgyMCArIHRoaXMudHlwZSkge1xuICAgICAgICAgICAgc2hvcExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYXRpb24gPSBzaG9wTG9jYXRpb247XG4gICAgfVxuXG4gICAgY29uc3QgcmVhZFByaWNlOiAoaTogbnVtYmVyKSA9PiBudW1iZXIgPVxuICAgICAgICByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzID9cbiAgICAgICAgICAgIGkgPT4gcm9tLnByZ1t0aGlzLnByaWNlc0FkZHJlc3MgKyBpXSAvIDMyIDpcbiAgICAgICAgICAgIGkgPT4gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCB0aGlzLnByaWNlc0FkZHJlc3MgKyAyICogaSk7XG4gICAgdGhpcy5jb250ZW50cyA9IHR1cGxlKHJvbS5wcmcsIHRoaXMuY29udGVudHNBZGRyZXNzLCBDT05URU5UU19DT1VOVFNbdGhpcy50eXBlXSk7XG4gICAgdGhpcy5wcmljZXMgPSBzZXEoUFJJQ0VTX0NPVU5UU1t0aGlzLnR5cGVdLCByZWFkUHJpY2UpO1xuICAgIHRoaXMudXNlZCA9IHRoaXMubG9jYXRpb24gIT09IDB4ZmY7XG5cbiAgICAvLyBUT0RPIC0gY2hlY2tpbmcgZm9yIHNob3BzIGlzIHJlYWxseSB0cmlja3kgZm9yIHNvbWUgcmVhc29uLi4uXG4gICAgLy90aGlzLnJvbS5sb2NhdGlvbnNbdGhpcy5sb2NhdGlvbl0uc2V0SXNTaG9wKHRydWUpO1xuICB9XG5cbiAgLy8gcHJpdmF0ZSBpc05vcm1hbGl6ZWQoKTogYm9vbGVhbiB7XG4gIC8vICAgcmV0dXJuICEhdGhpcy5yb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAvLyB9XG5cbiAgZ2V0IGNvbnRlbnRzQWRkcmVzcygpOiBudW1iZXIge1xuICAgIGNvbnN0IGJhc2UgPSBDT05URU5UU19BRERSRVNTRVNbdGhpcy50eXBlXSh0aGlzLnJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9tLnNob3BDb3VudCk7XG4gICAgcmV0dXJuIGJhc2UgKyA0ICogdGhpcy5pbmRleDtcbiAgfVxuXG4gIGdldCBwcmljZXNBZGRyZXNzKCk6IG51bWJlciB7XG4gICAgY29uc3Qgc2hvcFRhYmxlID0gdGhpcy5yb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAgIGNvbnN0IGJhc2UgPSBQUklDRVNfQUREUkVTU0VTW3RoaXMudHlwZV0oc2hvcFRhYmxlLCB0aGlzLnJvbS5zaG9wQ291bnQpO1xuICAgIHJldHVybiBiYXNlICsgKHNob3BUYWJsZSA/IDEgOiAyKSAqIFBSSUNFU19DT1VOVFNbdGhpcy50eXBlXSAqIHRoaXMuaW5kZXg7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgc3Bhd25zIGZvciB0aGUgZ2l2ZW4gbG9jYXRpb24gdG8gaW5jbHVkZSBhbiBhcHByb3ByaWF0ZVxuICAgKiBzaG9wa2VlcGVyLiAgU2hvdWxkIGJlIGNhbGxlZCBhZnRlciBjaGFuZ2luZyBsb2NhdGlvbnMuXG4gICAqL1xuICB1cGRhdGVTaG9wa2VlcGVyKCk6IHZvaWQge1xuICAgIC8vIGhvdyB0byBkZXRlcm1pbmUgc2hvcCB0eXBlP1xuICAgIC8vICAgLT4gbG9vayBhdCBsb2NhdGlvbidzIHNwYXduIGRhdGEgLT4gb2JqZWN0IHR5cGUgNCwgaWQgPT4gZGF0YSAkNjIwXG4gICAgLy8gICAgICAyMyA9IHBhd24sIDIxID0gdG9vbHMsIDIyID0gaW5uLCAyMCA9IGFybW9yXG4gICAgLy8gICByZXVzZSB0aGUgZ2VuZXJpYyBvYmplY3RzIDQwLi40MywgcmVwdXJwb3NlIHRoZSBzcGVjaWFsIG9uZXMuXG4gICAgLy8gICB3ZSBjYW4gYWxzbyBtYWtlIG5ldyBvbmVzIGFzIG5lZWRlZCB1c2luZyB0aGUgdW51c2VkIG9iamVjdCBzbG90c1xuICAgIC8vIHdlIGNvdWxkIGFsdGVybmF0aXZlbHkgbWFrZSBsb2NhdGlvbiBhbmQvb3IgdHlwZSBhIGdldHRlci9zZXR0ZXIgcGFpclxuICAgIHRocm93IG5ldyBFcnJvcignbm90IGltcGxlbWVudGVkJyk7XG4gIH1cbn1cblxuY29uc3QgVkFOSUxMQV9TSE9QX0xPQ0FUSU9OUyA9IDB4MjFmNTQ7XG5jb25zdCBWQU5JTExBX1NIT1BfSU5ESUNFUyA9IDB4MjFmNzU7XG5jb25zdCBWQU5JTExBX0FSTU9SX1NIT1BfSVRFTVMgPSAweDIxZGE0O1xuY29uc3QgVkFOSUxMQV9BUk1PUl9TSE9QX1BSSUNFUyA9IDB4MjFkZDA7XG5jb25zdCBWQU5JTExBX1RPT0xfU0hPUF9JVEVNUyA9IDB4MjFlMjg7XG5jb25zdCBWQU5JTExBX1RPT0xfU0hPUF9QUklDRVMgPSAweDIxZTU0O1xuY29uc3QgVkFOSUxMQV9JTk5fUFJJQ0VTID0gMHgyMWVhYztcbmNvbnN0IFZBTklMTEFfUEFXTl9QUklDRV9UQUJMRSA9IDB4MjFlYzI7XG4iXX0=