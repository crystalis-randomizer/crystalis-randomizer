import { CaveShuffle } from './cave.js';
import { OK } from './maze.js';
import { E, N, S, W } from './grid.js';
import { ScreenFix } from '../rom/screenfix.js';
import { DefaultMap } from '../util.js';
export class LabyrinthShuffle extends CaveShuffle {
    initialFill() {
        const target = this.size + 3;
        const stair = (this.random.nextInt(this.w) << 4 |
            (this.h - 1) << 12 | 0x808);
        if (!this.grid.isBorder(W(stair)))
            this.fixed.add(W(stair, 2));
        if (!this.grid.isBorder(E(stair)))
            this.fixed.add(E(stair, 2));
        this.grid.set(stair, '>');
        this.fixed.add(stair);
        this.grid.set(N(stair), 'w');
        this.fixed.add(N(stair));
        this.fixed.add(W(stair));
        this.fixed.add(E(stair));
        const arena = (this.random.nextInt(this.w) << 4 | 0x808);
        const down = S(arena, 2);
        this.grid.set(arena, '<');
        this.fixed.add(arena);
        this.grid.set(S(arena), 'w');
        this.fixed.add(S(arena));
        this.grid.set(down, 'w');
        this.fixed.add(down);
        this.grid.set(S(down), 'w');
        this.fixed.add(S(down));
        this.fixed.add(W(down));
        this.fixed.add(E(down));
        if (!this.tryConnect(N(stair, 2), S(down, 2), 'w', 10)) {
            return { ok: false, fail: `initial connect` };
        }
        while (this.count < target) {
            if (!this.tryAddLoop('w', 10))
                return { ok: false, fail: `add loops` };
        }
        return OK;
    }
    refine() { return OK; }
    refineEdges() { return true; }
    addArenas() { return true; }
    addStairs() { return OK; }
    refineMetascreens(meta) {
        console.log(meta.show());
        for (let y = 0; y < meta.height; y++) {
            for (let x = 0; x < meta.width; x++) {
                const pos = y << 4 | x;
                const scr = meta.get(pos);
                const edge = scr.edgeIndex('w');
                if (scr.hasFeature('arena')) {
                    this.arena = pos + 0x10 << 8 | 1;
                }
                else if (edge === 5) {
                    if (pos < 16 || !meta.get(pos - 16).hasFeature('arena')) {
                        meta.set(pos, meta.rom.metascreens.goaWideHallNS_stairs);
                        const c = ((pos << 8 | pos << 4) & 0xf0f0 | 0x808);
                        this.grid.set(c, 'H');
                    }
                }
                else if (edge === 1) {
                    this.stair = pos << 8 | 2;
                }
            }
        }
        this.reachable = undefined;
        if (!this.checkMeta(meta))
            return { ok: false, fail: `initial meta check` };
        console.log(meta.show());
        const deadEnd = this.orig.rom.metascreens.goaWideHallNS_deadEnd;
        for (let x = 0; x < meta.width; x++) {
            for (let y = 0; y < meta.height; y++) {
                const c = (y << 12 | x << 4 | 0x808);
                let len = 0;
                while (y + len < meta.height &&
                    this.grid.get(c + len * 0x1000) === 'H') {
                    len++;
                }
                if (!len)
                    continue;
                const opts = [new Map(), new Map()];
                for (let i = 0; i < len; i++) {
                    opts[i & 1].set((y + i) << 4 | x, deadEnd);
                }
                let found = false;
                for (const opt of this.random.ishuffle(opts)) {
                    if (!opt.size) {
                        found = true;
                        continue;
                    }
                    if (!this.checkMeta(meta, opt))
                        continue;
                    for (const [pos, s] of opt) {
                        meta.set(pos, s);
                        this.grid.set(c + 0x1000 * ((pos >> 4) - y), '=');
                    }
                    found = true;
                    break;
                }
                if (!found)
                    return { ok: false, fail: `could not rectify hallway` };
                y += len;
            }
        }
        return super.refineMetascreens(meta);
    }
    checkMeta(meta, repl) {
        const opts = repl ? { with: repl } : {};
        const parts = meta.traverse(opts);
        const part = parts.get(this.stair);
        if (part !== parts.get(this.arena)) {
            console.log(`stair not connected to arena\n${meta.show()}`);
            return false;
        }
        if (this.reachable == null) {
            if (part && part.size < parts.size * 0.95) {
                console.log(`too small`);
                return false;
            }
            this.reachable = part === null || part === void 0 ? void 0 : part.size;
            return true;
        }
        else {
            if ((part === null || part === void 0 ? void 0 : part.size) > this.reachable * 0.95) {
                return true;
            }
            return false;
        }
    }
}
export function fixLabyrinthScreens(rom, random) {
    var _a;
    const { metatilesets: { cave, fortress, iceCave, labyrinth, pyramid } } = rom;
    rom.metascreens.registerFix(ScreenFix.LabyrinthParapets, 1);
    {
        for (const ts of [labyrinth, pyramid]) {
            ts.getTile(0x2b).copyFrom(0x19).replaceIn(...ts);
            ts.getTile(0xba).copyFrom(0x1b).replaceIn(...ts);
        }
        for (const ts of [fortress, labyrinth, pyramid, cave]) {
            ts.getTile(0x19).copyFrom(0x17).replaceIn(...ts);
            ts.getTile(0x1b).copyFrom(0x18).replaceIn(...ts);
        }
        for (const ts of [iceCave, cave, pyramid]) {
            ts.getTile(0x17).copyFrom(0xc5);
            ts.getTile(0x18).copyFrom(0xc5);
        }
        labyrinth.getTile(0x17).copyFrom(0xc6).setAlternative(0xc5);
        labyrinth.getTile(0x18).copyFrom(0xc4).setAlternative(0xc5);
    }
    const bySid = new DefaultMap(() => []);
    for (const s of rom.metatilesets.labyrinth) {
        bySid.get(s.sid).push(s);
    }
    for (const [sid, screens] of bySid) {
        const screen = rom.screens[sid];
        const remove = screens.map(s => { var _a; return (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.removeWall; });
        const [removed, ...rest] = new Set(remove.filter(w => w != null));
        if (removed != null) {
            screen.set2d(removed, [[0xc5, 0xc5], [0xd0, 0xc5]]);
            if (rest.length)
                throw new Error(`bad remove`);
            for (let i = 0; i < remove.length; i++) {
                if (remove[i] == null) {
                    screens[i].data.tilesets.labyrinth.addWall = [removed];
                }
            }
        }
        if (screens.length < 2)
            continue;
        if (screens.length > 2) {
            const deleted = random.pick(screens.filter(s => { var _a; return (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.addWall; }));
            screens.splice(screens.indexOf(deleted), 1);
            deleted.remove();
        }
        for (const s of screens) {
            const add = (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.addWall;
            if (add != null) {
                s.data.mod = 'block';
                for (const w of add)
                    screen.set2d(w, [[0x17, 0x17], [0x18, 0x18]]);
            }
            else {
                s.flag = 'always';
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvZ29hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDeEMsT0FBTyxFQUFVLEVBQUUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd2QyxPQUFPLEVBQWEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2xELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBTXhDLE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxXQUFXO0lBTy9DLFdBQVc7UUFDVCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUM3QixNQUFNLEtBQUssR0FDUCxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ2hDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFjLENBQUM7UUFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9ELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFekIsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBYyxDQUFDO1FBQ3RFLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENB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RSxRQUFRLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUMsRUFBQyxHQUFHLEdBQUcsQ0FBQztJQUMxRSxHQUFHLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFNUQ7UUFPRSxLQUFLLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ3JDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ2xEO1FBR0QsS0FBSyxNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ3JELEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ2xEO1FBR0QsS0FBSyxNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLEVBQUU7WUFDekMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7UUFHRCxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUks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LEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3BFO2lCQUFNO2dCQUNMLENBQUMsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO2FBQ25CO1NBQ0Y7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXZlU2h1ZmZsZSB9IGZyb20gJy4vY2F2ZS5qcyc7XG5pbXBvcnQgeyBSZXN1bHQsIE9LIH0gZnJvbSAnLi9tYXplLmpzJztcbmltcG9ydCB7IFJvbSB9IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQgeyBSYW5kb20gfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHsgR3JpZENvb3JkLCBFLCBOLCBTLCBXIH0gZnJvbSAnLi9ncmlkLmpzJztcbmltcG9ydCB7IFNjcmVlbkZpeCB9IGZyb20gJy4uL3JvbS9zY3JlZW5maXguanMnO1xuaW1wb3J0IHsgRGVmYXVsdE1hcCB9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHsgTWV0YXNjcmVlbiB9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7IE1ldGFsb2NhdGlvbiwgUG9zIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5cbi8vIFRPRE8gLSBuZWVkcyBtb3JlIGxvb3BzLi4uXG5cbmV4cG9ydCBjbGFzcyBMYWJ5cmludGhTaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuXG4gIC8vIG1ldGEudHJhdmVyc2UgcG9zaXRpb25zIGZvciBpbXBvcnRhbnQgZmVhdHVyZXMuXG4gIHN0YWlyITogbnVtYmVyO1xuICBhcmVuYSE6IG51bWJlcjtcbiAgcmVhY2hhYmxlPzogbnVtYmVyO1xuXG4gIGluaXRpYWxGaWxsKCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5zaXplICsgMzsgLy8gKyB0aGlzLnJhbmRvbS5uZXh0SW50KDQpO1xuICAgIGNvbnN0IHN0YWlyID1cbiAgICAgICAgKHRoaXMucmFuZG9tLm5leHRJbnQodGhpcy53KSA8PCA0IHxcbiAgICAgICAgICh0aGlzLmggLSAxKSA8PCAxMiB8IDB4ODA4KSBhcyBHcmlkQ29vcmQ7XG4gICAgaWYgKCF0aGlzLmdyaWQuaXNCb3JkZXIoVyhzdGFpcikpKSB0aGlzLmZpeGVkLmFkZChXKHN0YWlyLCAyKSk7XG4gICAgaWYgKCF0aGlzLmdyaWQuaXNCb3JkZXIoRShzdGFpcikpKSB0aGlzLmZpeGVkLmFkZChFKHN0YWlyLCAyKSk7XG4gICAgdGhpcy5ncmlkLnNldChzdGFpciwgJz4nKTtcbiAgICB0aGlzLmZpeGVkLmFkZChzdGFpcik7XG4gICAgdGhpcy5ncmlkLnNldChOKHN0YWlyKSwgJ3cnKTtcbiAgICB0aGlzLmZpeGVkLmFkZChOKHN0YWlyKSk7XG4gICAgdGhpcy5maXhlZC5hZGQoVyhzdGFpcikpO1xuICAgIHRoaXMuZml4ZWQuYWRkKEUoc3RhaXIpKTtcblxuICAgIGNvbnN0IGFyZW5hID0gKHRoaXMucmFuZG9tLm5leHRJbnQodGhpcy53KSA8PCA0IHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICBjb25zdCBkb3duID0gUyhhcmVuYSwgMik7XG4gICAgdGhpcy5ncmlkLnNldChhcmVuYSwgJzwnKTtcbiAgICB0aGlzLmZpeGVkLmFkZChhcmVuYSk7XG4gICAgdGhpcy5ncmlkLnNldChTKGFyZW5hKSwgJ3cnKTtcbiAgICB0aGlzLmZpeGVkLmFkZChTKGFyZW5hKSk7XG4gICAgdGhpcy5ncmlkLnNldChkb3duLCAndycpO1xuICAgIHRoaXMuZml4ZWQuYWRkKGRvd24pO1xuICAgIHRoaXMuZ3JpZC5zZXQoUyhkb3duKSwgJ3cnKTtcbiAgICB0aGlzLmZpeGVkLmFkZChTKGRvd24pKTtcbiAgICB0aGlzLmZpeGVkLmFkZChXKGRvd24pKTtcbiAgICB0aGlzLmZpeGVkLmFkZChFKGRvd24pKTtcblxuICAgIC8vIFRPRE8gLSBjYW4gc3RhaXIgYmUgbm90IG9uIGJvdHRvbT8gIGFyZW5hIG5vdCBvbiB0b3A/XG5cbiAgICBpZiAoIXRoaXMudHJ5Q29ubmVjdChOKHN0YWlyLCAyKSwgUyhkb3duLCAyKSwgJ3cnLCAxMCkpIHtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBjb25uZWN0YH07XG4gICAgfVxuICAgIHdoaWxlICh0aGlzLmNvdW50IDwgdGFyZ2V0KSB7XG4gICAgICBpZiAoIXRoaXMudHJ5QWRkTG9vcCgndycsIDEwKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBhZGQgbG9vcHNgfTtcbiAgICB9XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgcmVmaW5lKCkgeyByZXR1cm4gT0s7IH1cbiAgcmVmaW5lRWRnZXMoKSB7IHJldHVybiB0cnVlOyB9XG4gIGFkZEFyZW5hcygpIHsgcmV0dXJuIHRydWU7IH1cbiAgYWRkU3RhaXJzKCkgeyByZXR1cm4gT0s7IH1cblxuICByZWZpbmVNZXRhc2NyZWVucyhtZXRhOiBNZXRhbG9jYXRpb24pOiBSZXN1bHQ8dm9pZD4ge1xuY29uc29sZS5sb2cobWV0YS5zaG93KCkpO1xuICAgIC8vIDEuIHJlcGxhY2UgYWxsIHRoZSAobm9uLWZpeGVkKSB3aWRlSGFsbE5TIHdpdGggZWl0aGVyIHN0YWlycyBvciBwYWlyc1xuICAgIC8vICAgIG9mIGRlYWQgZW5kcyAtIG5vIHNhbWUgdmVydGljYWwgbmVpZ2hib3JzXG4gICAgLy8gMi4gc3RhcnQgYWRkaW5nIGJsb2Nrc1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgbWV0YS5oZWlnaHQ7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBtZXRhLndpZHRoOyB4KyspIHtcbiAgICAgICAgY29uc3QgcG9zID0geSA8PCA0IHwgeDtcbiAgICAgICAgY29uc3Qgc2NyID0gbWV0YS5nZXQocG9zKTtcbiAgICAgICAgY29uc3QgZWRnZSA9IHNjci5lZGdlSW5kZXgoJ3cnKTtcbiAgICAgICAgaWYgKHNjci5oYXNGZWF0dXJlKCdhcmVuYScpKSB7XG4gICAgICAgICAgdGhpcy5hcmVuYSA9IHBvcyArIDB4MTAgPDwgOCB8IDE7XG4gICAgICAgIH0gZWxzZSBpZiAoZWRnZSA9PT0gNSkge1xuICAgICAgICAgIGlmIChwb3MgPCAxNiB8fCAhbWV0YS5nZXQocG9zIC0gMTYpLmhhc0ZlYXR1cmUoJ2FyZW5hJykpIHtcbiAgICAgICAgICAgIG1ldGEuc2V0KHBvcywgbWV0YS5yb20ubWV0YXNjcmVlbnMuZ29hV2lkZUhhbGxOU19zdGFpcnMpO1xuICAgICAgICAgICAgY29uc3QgYyA9ICgocG9zIDw8IDggfCBwb3MgPDwgNCkgJiAweGYwZjAgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICAgICAgdGhpcy5ncmlkLnNldChjLCAnSCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChlZGdlID09PSAxKSB7XG4gICAgICAgICAgdGhpcy5zdGFpciA9IHBvcyA8PCA4IHwgMjtcbiAgICAgICAgLy8gfSBlbHNlIGlmIChzY3IuaGFzRmVhdHVyZSgnYXJlbmEnKSkge1xuICAgICAgICAvLyAgIG1ldGEuc2V0KHBvcywgbWV0YS5yb20ubWV0YXNjcmVlbnMuZ29hV2lkZUhhbGxOU19zdGFpcnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIE1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIGFjY2Vzc2libGVcbiAgICB0aGlzLnJlYWNoYWJsZSA9IHVuZGVmaW5lZDtcbiAgICBpZiAoIXRoaXMuY2hlY2tNZXRhKG1ldGEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgbWV0YSBjaGVja2B9O1xuY29uc29sZS5sb2cobWV0YS5zaG93KCkpO1xuICAgIC8vIE5vdyB0aGF0IGEgYmFzZWxpbmUgaGFzIGJlZW4gZXN0YWJsaXNoZWQsIHRyeSBhZGRpbmcgdmFyaW91cyBibG9ja3MsXG4gICAgLy8gaW5jbHVkaW5nIGRlYWQtZW5kcyBvdXQgb2Ygc3RhaXIgaGFsbHdheXMgLSAuLi5cblxuICAgIGNvbnN0IGRlYWRFbmQgPSB0aGlzLm9yaWcucm9tLm1ldGFzY3JlZW5zLmdvYVdpZGVIYWxsTlNfZGVhZEVuZDtcbiAgICBmb3IgKGxldCB4ID0gMDsgeCA8IG1ldGEud2lkdGg7IHgrKykge1xuICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBtZXRhLmhlaWdodDsgeSsrKSB7XG4gICAgICAgIC8vIGNvbnN0IGMgPSAoKHBvcyA8PCA4IHwgcG9zIDw8IDQpICYgMHhmMGYwKSBhcyBHcmlkQ29vcmQ7XG4gICAgICAgIC8vYCBsZXQgdGlsZSA9IHRoaXMuZXh0cmFjdCh0aGlzLmdyaWQsIGMpO1xuICAgICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICBsZXQgbGVuID0gMDtcbiAgICAgICAgd2hpbGUgKHkgKyBsZW4gPCBtZXRhLmhlaWdodCAmJlxuICAgICAgICAgICAgICAgdGhpcy5ncmlkLmdldChjICsgbGVuICogMHgxMDAwIGFzIEdyaWRDb29yZCkgPT09ICdIJykge1xuICAgICAgICAgIGxlbisrO1xuICAgICAgICB9XG4gICAgICAgIC8vIGFsdGVybmF0ZSBkZWFkIGVuZHMgYW5kIHN0YWlyc1xuICAgICAgICBpZiAoIWxlbikgY29udGludWU7XG4gICAgICAgIGNvbnN0IG9wdHM6IEFycmF5PE1hcDxQb3MsIE1ldGFzY3JlZW4+PiA9IFtuZXcgTWFwKCksIG5ldyBNYXAoKV07XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICBvcHRzW2kgJiAxXS5zZXQoKHkgKyBpKSA8PCA0IHwgeCwgZGVhZEVuZCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICAgIGZvciAoY29uc3Qgb3B0IG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKG9wdHMpKSB7XG4gICAgICAgICAgaWYgKCFvcHQuc2l6ZSkge1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghdGhpcy5jaGVja01ldGEobWV0YSwgb3B0KSkgY29udGludWU7XG4gICAgICAgICAgZm9yIChjb25zdCBbcG9zLCBzXSBvZiBvcHQpIHtcbiAgICAgICAgICAgIG1ldGEuc2V0KHBvcywgcyk7XG4gICAgICAgICAgICB0aGlzLmdyaWQuc2V0KGMgKyAweDEwMDAgKiAoKHBvcyA+PiA0KSAtIHkpIGFzIEdyaWRDb29yZCwgJz0nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmICghZm91bmQpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IHJlY3RpZnkgaGFsbHdheWB9O1xuICAgICAgICB5ICs9IGxlbjtcblxuLy8gICAgICAgICBpZiAodGhpcy5ncmlkLmdldChjKSA9PT0gJ0gnKSB7XG4vLyAgICAgICAgICAgLy8gdHJ5IHRvIHNldCB0byBhIGRlYWQgZW5kLlxuLy8gICAgICAgICBpZiAodGhpcy50cnlNZXRhKG1ldGEsIHBvcywgW2RlYWRFbmRdKSkge1xuLy8gICAgICAgICAgIHRoaXMuZ3JpZC5zZXQoYywgJz0nKTtcbi8vICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyaWQuZ2V0KGMgLSAweDEwMDAgYXMgR3JpZENvb3JkKSA9PT0gJ0gnKSB7XG4vLyAvL2RlYnVnZ2VyO1xuLy8gICAgICAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IGJyZWFrIHVwIHN0YWlyIGhhbGxzYH07XG4vLyAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGNvbnN0IGJsb2NrZWQgPSB0aGlzLm9yaWcudGlsZXNldC53aXRoTW9kKHRpbGUsICdibG9jaycpO1xuICAgICAgLy8gaWYgKGJsb2NrZWQubGVuZ3RoICYmXG4gICAgICAvLyAgICAgdGhpcy50cnlNZXRhKG1ldGEsIHBvcywgdGhpcy5yYW5kb20uc2h1ZmZsZShibG9ja2VkKSkpIHtcbiAgICAgIC8vICAgY29udGludWU7XG4gICAgICAvLyB9XG4gICAgfVxuXG4gICAgLy8gVE9ETyAtIGNvbnZlcnQgYWRqYWNlbnQgc3RhaXJzIHRvIGRlYWQgZW5kc1xuICAgIHJldHVybiBzdXBlci5yZWZpbmVNZXRhc2NyZWVucyhtZXRhKTtcbiAgfVxuXG4gIGNoZWNrTWV0YShtZXRhOiBNZXRhbG9jYXRpb24sIHJlcGw/OiBNYXA8UG9zLCBNZXRhc2NyZWVuPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9wdHMgPSByZXBsID8ge3dpdGg6IHJlcGx9IDoge307XG4gICAgY29uc3QgcGFydHMgPSBtZXRhLnRyYXZlcnNlKG9wdHMpO1xuICAgIGNvbnN0IHBhcnQgPSBwYXJ0cy5nZXQodGhpcy5zdGFpcik7XG4gICAgaWYgKHBhcnQgIT09IHBhcnRzLmdldCh0aGlzLmFyZW5hKSkge1xuICAgICAgY29uc29sZS5sb2coYHN0YWlyIG5vdCBjb25uZWN0ZWQgdG8gYXJlbmFcXG4ke21ldGEuc2hvdygpfWApO1xuICAgICAgLy9kZWJ1Z2dlcjtcbiAgICAgIHJldHVybiBmYWxzZTsgLy97b2s6IGZhbHNlLCBmYWlsOiAnc3RhaXIgbm90IGNvbm5lY3RlZCB0byBhcmVuYSd9O1xuICAgIH1cbiAgICBpZiAodGhpcy5yZWFjaGFibGUgPT0gbnVsbCkge1xuICAgICAgaWYgKHBhcnQgJiYgcGFydC5zaXplIDwgcGFydHMuc2l6ZSAqIDAuOTUpIHtcbiAgICAgICAgY29uc29sZS5sb2coYHRvbyBzbWFsbGApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aGlzLnJlYWNoYWJsZSA9IHBhcnQ/LnNpemU7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBhcnQ/LnNpemUhID4gdGhpcy5yZWFjaGFibGUgKiAwLjk1KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlOy8vIHtvazogZmFsc2UsIGZhaWw6IGByZWZpbmVNZXRhOiBjdXQgb2ZmIHRvbyBtdWNoYH07XG4gICAgfSAgICBcbiAgfVxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhMYWJ5cmludGhTY3JlZW5zKHJvbTogUm9tLCByYW5kb206IFJhbmRvbSkge1xuICAvLyBUaGVyZSBhcmUgZm91ciB0aWxlc2V0cyB0aGF0IGFsbCBzaGFyZSBsb3RzIG9mIHNjcmVlbnMsIHNvIGl0J3MgdG91Z2hcbiAgLy8gdG8gZmluZCBhbiBlbGlnaWJsZSBhbHRlcm5hdGFibGUgdGlsZS4gIEl0IHR1cm5zIG91dCB0aGF0IDE5IGFuZCAxYiBhcmVcbiAgLy8gbm90IHVzZWQgaW4gYW55IG9mIHRoZSByZWxldmFudCBzY3JlZW5zIChhbGwgYnV0IG5vcm1hbCBjYXZlKSBmb3JcbiAgLy8gYWx0ZXJuYXRpbmcsIHNvIHdlIGZyZWUgdXAgdGhvc2UgdGlsZXMgYnkgbW92aW5nIHRoZW0gaW50byB2YXJpb3VzXG4gIC8vIGZyZWUgdGlsZXMgKDJiIGFuZCBiYSBpbiBweXJhbWlkIGFuZCBmb3J0cmVzcywgMTcgYW5kIDE4IGluIGljZSBjYXZlXG4gIC8vIHNpbmNlIHRoaXMgb25lIGlzIHVzZWQgZm9yIHN3aXRjaGluZyB3LyA1NCBhbmQgNTgpLlxuXG4gIC8vIFBMQU46XG4gIC8vIHRpbGVzZXQgYTQsOGM6IG1vdmUgMTksMWIgLT4gMmIsYmFcbiAgLy8gdGlsZXNldCBhODogICAgbW92ZSAxOSwxYiAtPiAxNywxOFxuICAvLyB0aWxlc2V0IDg4OiAgICBtb3ZlIGM1IC0+IDE5LDFiXG4gIC8vICAgICAxNywxOCB1c2VkIGluIDg4LCB3aGljaCBzaGFyZXMgYSBsb3Qgd2l0aCBhOCwgYnV0XG4gIC8vICAgICBubyA4OCBtYXBzIGhhdmUgYW55IDE5LDFiIHNvIHRoZXknbGwgbmV2ZXIgc2VlIGNvbmZsaWN0aW5nIDE3LDE4XG4gIC8vIGNoYW5nZSB0aGUgODggdXNlcnMgb2YgZTEsZTIgKGh5ZHJhKSB0byB0aWxlc2V0IGE4IHdpdGggcGF0MT0yYSB0byBhdm9pZFxuICAvLyBjb25mbGljdD8gIHRoZSBjb3N0IGlzIG9uZSB3YWxsIHRoYXQgZG9lc24ndCBmaXQgaW4gcXVpdGUgYXMgd2VsbC5cbiAgLy8gVGhpcyBmcmVlcyB1cCAxOSwxYiB0byBhYnNvcmIgYzYvYzQgd2l0aCBhbHRzIG9mIGM1XG4gIC8vIFBST0JMRU06XG4gIC8vIEljZSBjYXZlIG1vdmVzIGl0cyBmbGFnZ2FibGUgMTkvMWIgdG8gMTcvMTggdG8gZnJlZSB1cCBzcGFjZSBmb3IgdGhlXG4gIC8vIHJlbW92YWJsZSB3YWxsLCBidXQgMTcvMTggaXMgdXNlZCBpbiByaXZlciBjYXZlIGZvciB2ZXJ0aWNhbCBicmlkZ2UuXG4gIC8vIFRoaXMgaXMgdGhlIG9ubHkgc2l0dWF0aW9uIHdoZXJlIDE3LzE4IGFuZCAxOS8xYiBjb25mbGljdC4gIFNvIHdlXG4gIC8vIGluZGlyZWN0IGFuIGV4dHJhIHRpbWUsIGNvcHkgMTcvMTggaW50byAxOS8xYiBvbiB0aWxlc2V0cyA4OCw4YyxhNFxuICAvLyBhbmQgdGhlbiB3ZSBjYW4gcHV0IHRoZSBuZXcgd2FsbCB0aWxlcyBpbiAxNy8xOCBldmVyeXdoZXJlLlxuICBjb25zdCB7bWV0YXRpbGVzZXRzOiB7Y2F2ZSwgZm9ydHJlc3MsIGljZUNhdmUsIGxhYnlyaW50aCwgcHlyYW1pZH19ID0gcm9tO1xuICByb20ubWV0YXNjcmVlbnMucmVnaXN0ZXJGaXgoU2NyZWVuRml4LkxhYnlyaW50aFBhcmFwZXRzLCAxKTtcbiAgLy8gRml4IHRoZSB0aWxlc1xuICB7XG4gICAgLy8gRmlyc3QgcGF0Y2ggYSBmZXcgbm9uZXNlbnNlIGFsdGVybmF0ZXMgdG8gZ2V0IGFyb3VuZCBvdXIgc2FmZXR5IGNoZWNrXG4gICAgLy8gZm9yIChjb25zdCB0cyBvZiBbcHlyYW1pZCwgbGFieXJpbnRoLCBpY2VDYXZlXSkge1xuICAgIC8vICAgdHMudGlsZXNldC5hbHRlcm5hdGVzWzB4MTldID0gMHgxOTtcbiAgICAvLyAgIHRzLnRpbGVzZXQuYWx0ZXJuYXRlc1sweDFiXSA9IDB4MWI7XG4gICAgLy8gfVxuICAgIC8vIEZyZWUgdXAgMTkgYW5kIDFiIGluIHRoZSB0aWxlc2V0cyB0aGF0IG5lZWQgaXQuXG4gICAgZm9yIChjb25zdCB0cyBvZiBbbGFieXJpbnRoLCBweXJhbWlkXSkge1xuICAgICAgdHMuZ2V0VGlsZSgweDJiKS5jb3B5RnJvbSgweDE5KS5yZXBsYWNlSW4oLi4udHMpO1xuICAgICAgdHMuZ2V0VGlsZSgweGJhKS5jb3B5RnJvbSgweDFiKS5yZXBsYWNlSW4oLi4udHMpO1xuICAgIH1cblxuICAgIC8vIEZyZWUgdXAgMTcvMTggYnkgY29weWluZyB0byAxOS8xYiB0aGF0IHdlIGp1c3QgZnJlZWQuXG4gICAgZm9yIChjb25zdCB0cyBvZiBbZm9ydHJlc3MsIGxhYnlyaW50aCwgcHlyYW1pZCwgY2F2ZV0pIHtcbiAgICAgIHRzLmdldFRpbGUoMHgxOSkuY29weUZyb20oMHgxNykucmVwbGFjZUluKC4uLnRzKTtcbiAgICAgIHRzLmdldFRpbGUoMHgxYikuY29weUZyb20oMHgxOCkucmVwbGFjZUluKC4uLnRzKTtcbiAgICB9XG5cbiAgICAvLyBGaWxsIGluIGM1J3MgZ3JhcGhpY3MgZm9yIG9yZGluYXJ5IGNhdmVzIHRvIGNsZWFuIHVwIGdyYXBoaWNhbCBnbGl0Y2hlc1xuICAgIGZvciAoY29uc3QgdHMgb2YgW2ljZUNhdmUsIGNhdmUsIHB5cmFtaWRdKSB7XG4gICAgICB0cy5nZXRUaWxlKDB4MTcpLmNvcHlGcm9tKDB4YzUpO1xuICAgICAgdHMuZ2V0VGlsZSgweDE4KS5jb3B5RnJvbSgweGM1KTtcbiAgICB9XG5cbiAgICAvLyBOb3cgdGhhdCBzcGFjZSBoYXMgYmVlbiBhbGxvY2F0ZWQsIGZpbGwgaXQuXG4gICAgbGFieXJpbnRoLmdldFRpbGUoMHgxNykuY29weUZyb20oMHhjNikuc2V0QWx0ZXJuYXRpdmUoMHhjNSk7XG4gICAgbGFieXJpbnRoLmdldFRpbGUoMHgxOCkuY29weUZyb20oMHhjNCkuc2V0QWx0ZXJuYXRpdmUoMHhjNSk7XG4gIH1cbiAgLy8gRml4IHRoZSBzY3JlZW5zXG4gIGNvbnN0IGJ5U2lkID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBNZXRhc2NyZWVuW10+KCgpID0+IFtdKTtcbiAgZm9yIChjb25zdCBzIG9mIHJvbS5tZXRhdGlsZXNldHMubGFieXJpbnRoKSB7XG4gICAgYnlTaWQuZ2V0KHMuc2lkKS5wdXNoKHMpO1xuICB9XG4gIGZvciAoY29uc3QgW3NpZCwgc2NyZWVuc10gb2YgYnlTaWQpIHtcbiAgICAvLyBGaXJzdCBzZWUgaWYgdGhlIGRlZmF1bHQgc2NyZWVuIGhhcyBhIHdhbGwgdGhhdCBtYXkgYmUgcmVtb3ZlZFxuICAgIGNvbnN0IHNjcmVlbiA9IHJvbS5zY3JlZW5zW3NpZF07XG4gICAgY29uc3QgcmVtb3ZlID0gc2NyZWVucy5tYXAocyA9PiBzLmRhdGEudGlsZXNldHMubGFieXJpbnRoPy5yZW1vdmVXYWxsKTtcbiAgICBjb25zdCBbcmVtb3ZlZCwgLi4ucmVzdF0gPSBuZXcgU2V0KHJlbW92ZS5maWx0ZXIodyA9PiB3ICE9IG51bGwpKTtcbiAgICBpZiAocmVtb3ZlZCAhPSBudWxsKSB7XG4gICAgICBzY3JlZW4uc2V0MmQocmVtb3ZlZCwgW1sweGM1LCAweGM1XSwgWzB4ZDAsIDB4YzVdXSk7XG4gICAgICBpZiAocmVzdC5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihgYmFkIHJlbW92ZWApO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZW1vdmUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHJlbW92ZVtpXSA9PSBudWxsKSB7XG4gICAgICAgICAgc2NyZWVuc1tpXS5kYXRhLnRpbGVzZXRzLmxhYnlyaW50aCEuYWRkV2FsbCA9IFtyZW1vdmVkXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc2NyZWVucy5sZW5ndGggPCAyKSBjb250aW51ZTtcbiAgICAvLyBOb3cgaWYgdGhlcmUncyB0d28gd2l0aCBhZGRzLCBwaWNrIG9uZSB0byBkZWxldGUuXG4gICAgaWYgKHNjcmVlbnMubGVuZ3RoID4gMikge1xuICAgICAgY29uc3QgZGVsZXRlZCA9XG4gICAgICAgICAgcmFuZG9tLnBpY2soc2NyZWVucy5maWx0ZXIocyA9PiBzLmRhdGEudGlsZXNldHMubGFieXJpbnRoPy5hZGRXYWxsKSk7XG4gICAgICBzY3JlZW5zLnNwbGljZShzY3JlZW5zLmluZGV4T2YoZGVsZXRlZCksIDEpO1xuICAgICAgZGVsZXRlZC5yZW1vdmUoKTtcbiAgICB9XG4gICAgLy8gRmlndXJlIG91dCB3aGljaCBzY3JlZW4gbmVlZHMgdG8gZ2V0IGEgd2FsbCBhZGRlZC5cbiAgICBmb3IgKGNvbnN0IHMgb2Ygc2NyZWVucykge1xuICAgICAgY29uc3QgYWRkID0gcy5kYXRhLnRpbGVzZXRzLmxhYnlyaW50aD8uYWRkV2FsbDtcbiAgICAgIGlmIChhZGQgIT0gbnVsbCkge1xuICAgICAgICBzLmRhdGEubW9kID0gJ2Jsb2NrJztcbiAgICAgICAgZm9yIChjb25zdCB3IG9mIGFkZCkgc2NyZWVuLnNldDJkKHcsIFtbMHgxNywgMHgxN10sIFsweDE4LCAweDE4XV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcy5mbGFnID0gJ2Fsd2F5cyc7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=