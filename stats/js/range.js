export class Range {
    constructor(lower, upper) {
        this.lower = lower;
        this.upper = upper;
        if (lower >= upper)
            throw new Error(`Bad range: [${lower}, ${upper})`);
    }
    has(x) {
        return this.lower <= x && x < this.upper;
    }
    span(that) {
        return new Range(Math.min(this.lower, that.lower), Math.max(this.upper, that.upper));
    }
    intersects(that) {
        return this.lower >= that.upper || this.upper >= that.lower;
    }
    intersect(that) {
        const lower = Math.max(this.lower, that.lower);
        const upper = Math.min(this.upper, that.upper);
        return lower < upper ? new Range(lower, upper) : undefined;
    }
    toString() {
        return `[${this.lower}, ${this.upper})`;
    }
}
export class RangeSet {
    constructor(ranges = []) {
        const rs = [];
        for (const range of ranges) {
            add(rs, range);
        }
        this.ranges = rs;
    }
    empty() {
        return !this.ranges.length;
    }
    has(x) {
        const r = find(this.ranges, x);
        return r >= 0 && x < this.ranges[r].upper;
    }
    plus(range) {
        const out = new RangeSet();
        add(out.ranges, range);
        return out;
    }
    minus(range) {
        const out = new RangeSet();
        remove(out.ranges, range);
        return out;
    }
    toString() {
        return this.ranges.join(' ');
    }
    meet(that) {
        const out = [];
        let i = 0;
        let j = 0;
        while (i < this.ranges.length && j < that.ranges.length) {
            if (this.ranges[i].upper <= that.ranges[j].lower) {
                i++;
            }
            else if (that.ranges[j].upper <= this.ranges[i].lower) {
                j++;
            }
            else {
                out.push(this.ranges[i], that.ranges[j]);
                const a = this.ranges[i].upper;
                const b = that.ranges[j].upper;
                if (a <= b)
                    i++;
                if (b <= a)
                    j++;
            }
        }
        const s = new RangeSet();
        s.ranges = out;
        return s;
    }
}
function add(ranges, range) {
    let start = find(ranges, range.lower);
    let end = find(ranges, range.upper);
    if (start < 0) {
        start = ~start;
    }
    else {
        range = range.span(ranges[start]);
    }
    if (end < 0) {
        end = ~end;
    }
    else {
        range = range.span(ranges[end]);
        end++;
    }
    ranges.splice(start, end - start, range);
}
function remove(ranges, range) {
    let start = find(ranges, range.lower);
    let end = find(ranges, range.upper);
    if (start >= 0 && ranges[start].lower === range.lower) {
        start = ~start;
    }
    if (end >= 0 && ranges[end].upper === range.upper) {
        end = ~(end + 1);
    }
    if (start === end) {
        if (start < 0)
            return;
        ranges.splice(start, 0, ranges[start]);
        end++;
    }
    if (start < 0) {
        start = ~start;
    }
    else {
        ranges[start] = new Range(ranges[start].lower, range.lower);
        start++;
    }
    if (end < 0) {
        end = ~end;
    }
    else {
        ranges[end] = new Range(range.upper, ranges[end].upper);
    }
    ;
    ranges.splice(start, end - start);
}
function find(ranges, x) {
    let a = 0;
    let b = ranges.length - 1;
    if (b < 0)
        return ~0;
    if (x > ranges[b].upper)
        return ~ranges.length;
    if (x >= ranges[b].lower)
        return b;
    if (x < ranges[a].lower)
        return ~0;
    if (x <= ranges[a].upper)
        return a;
    while (a < b - 1) {
        const m = Math.floor((a + b) / 2);
        if (x < ranges[m].lower) {
            b = m;
        }
        else if (x > ranges[m].upper) {
            a = m;
        }
        else {
            return m;
        }
    }
    return ~b;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvanMvcmFuZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxPQUFPLEtBQUs7SUFDaEIsWUFBcUIsS0FBYSxFQUFXLEtBQWE7UUFBckMsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFXLFVBQUssR0FBTCxLQUFLLENBQVE7UUFDeEQsSUFBSSxLQUFLLElBQUksS0FBSztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsZUFBZSxLQUFLLEtBQUssS0FBSyxHQUFHLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQsR0FBRyxDQUFDLENBQVM7UUFDWCxPQUFPLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQzNDLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBVztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDdkYsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQztJQUM5RCxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVc7UUFDbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FB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QUMsR0FBRyxDQUFDLENBQUM7SUFDVixJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDO1FBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNyQixJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSztRQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQy9DLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1FBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7UUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ25DLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1FBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNoQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDdkIsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNQO2FBQU0sSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUM5QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ1A7YUFBTTtZQUNMLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7S0FDRjtJQUNELE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDWixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIFJhbmdlIHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbG93ZXI6IG51bWJlciwgcmVhZG9ubHkgdXBwZXI6IG51bWJlcikge1xuICAgIGlmIChsb3dlciA+PSB1cHBlcikgdGhyb3cgbmV3IEVycm9yKGBCYWQgcmFuZ2U6IFske2xvd2VyfSwgJHt1cHBlcn0pYCk7XG4gIH1cblxuICBoYXMoeDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubG93ZXIgPD0geCAmJiB4IDwgdGhpcy51cHBlcjtcbiAgfVxuXG4gIHNwYW4odGhhdDogUmFuZ2UpOiBSYW5nZSB7XG4gICAgcmV0dXJuIG5ldyBSYW5nZShNYXRoLm1pbih0aGlzLmxvd2VyLCB0aGF0Lmxvd2VyKSwgTWF0aC5tYXgodGhpcy51cHBlciwgdGhhdC51cHBlcikpO1xuICB9XG5cbiAgaW50ZXJzZWN0cyh0aGF0OiBSYW5nZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmxvd2VyID49IHRoYXQudXBwZXIgfHwgdGhpcy51cHBlciA+PSB0aGF0Lmxvd2VyO1xuICB9XG5cbiAgaW50ZXJzZWN0KHRoYXQ6IFJhbmdlKTogUmFuZ2UgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGxvd2VyID0gTWF0aC5tYXgodGhpcy5sb3dlciwgdGhhdC5sb3dlcik7XG4gICAgY29uc3QgdXBwZXIgPSBNYXRoLm1pbih0aGlzLnVwcGVyLCB0aGF0LnVwcGVyKTtcbiAgICByZXR1cm4gbG93ZXIgPCB1cHBlciA/IG5ldyBSYW5nZShsb3dlciwgdXBwZXIpIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFske3RoaXMubG93ZXJ9LCAke3RoaXMudXBwZXJ9KWA7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJhbmdlU2V0IHtcbiAgcmVhZG9ubHkgcmFuZ2VzOiByZWFkb25seSBSYW5nZVtdO1xuXG4gIGNvbnN0cnVjdG9yKHJhbmdlczogSXRlcmFibGU8UmFuZ2U+ID0gW10pIHtcbiAgICBjb25zdCByczogUmFuZ2VbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgcmFuZ2Ugb2YgcmFuZ2VzKSB7XG4gICAgICBhZGQocnMsIHJhbmdlKTtcbiAgICB9XG4gICAgdGhpcy5yYW5nZXMgPSBycztcbiAgfVxuXG4gIGVtcHR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5yYW5nZXMubGVuZ3RoO1xuICB9XG5cbiAgaGFzKHg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHIgPSBmaW5kKHRoaXMucmFuZ2VzLCB4KTtcbiAgICByZXR1cm4gciA+PSAwICYmIHggPCB0aGlzLnJhbmdlc1tyXS51cHBlcjtcbiAgfVxuXG4gIHBsdXMocmFuZ2U6IFJhbmdlKTogUmFuZ2VTZXQge1xuICAgIGNvbnN0IG91dCA9IG5ldyBSYW5nZVNldCgpO1xuICAgIGFkZChvdXQucmFuZ2VzIGFzIFJhbmdlW10sIHJhbmdlKTtcbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgbWludXMocmFuZ2U6IFJhbmdlKTogUmFuZ2VTZXQge1xuICAgIGNvbnN0IG91dCA9IG5ldyBSYW5nZVNldCgpO1xuICAgIHJlbW92ZShvdXQucmFuZ2VzIGFzIFJhbmdlW10sIHJhbmdlKTtcbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yYW5nZXMuam9pbignICcpO1xuICB9XG5cbiAgbWVldCh0aGF0OiBSYW5nZVNldCk6IFJhbmdlU2V0IHtcbiAgICBjb25zdCBvdXQgPSBbXTtcbiAgICBsZXQgaSA9IDA7XG4gICAgbGV0IGogPSAwO1xuICAgIHdoaWxlIChpIDwgdGhpcy5yYW5nZXMubGVuZ3RoICYmIGogPCB0aGF0LnJhbmdlcy5sZW5ndGgpIHtcbiAgICAgIGlmICh0aGlzLnJhbmdlc1tpXS51cHBlciA8PSB0aGF0LnJhbmdlc1tqXS5sb3dlcikge1xuICAgICAgICBpKys7XG4gICAgICB9IGVsc2UgaWYgKHRoYXQucmFuZ2VzW2pdLnVwcGVyIDw9IHRoaXMucmFuZ2VzW2ldLmxvd2VyKSB7XG4gICAgICAgIGorKztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dC5wdXNoKHRoaXMucmFuZ2VzW2ldLCB0aGF0LnJhbmdlc1tqXSk7XG4gICAgICAgIGNvbnN0IGEgPSB0aGlzLnJhbmdlc1tpXS51cHBlcjtcbiAgICAgICAgY29uc3QgYiA9IHRoYXQucmFuZ2VzW2pdLnVwcGVyO1xuICAgICAgICBpZiAoYSA8PSBiKSBpKys7XG4gICAgICAgIGlmIChiIDw9IGEpIGorKztcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcyA9IG5ldyBSYW5nZVNldCgpO1xuICAgIChzIGFzIGFueSkucmFuZ2VzID0gb3V0O1xuICAgIHJldHVybiBzO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFkZChyYW5nZXM6IFJhbmdlW10sIHJhbmdlOiBSYW5nZSkge1xuICBsZXQgc3RhcnQgPSBmaW5kKHJhbmdlcywgcmFuZ2UubG93ZXIpO1xuICBsZXQgZW5kID0gZmluZChyYW5nZXMsIHJhbmdlLnVwcGVyKTtcbiAgaWYgKHN0YXJ0IDwgMCkge1xuICAgIHN0YXJ0ID0gfnN0YXJ0O1xuICB9IGVsc2Uge1xuICAgIHJhbmdlID0gcmFuZ2Uuc3BhbihyYW5nZXNbc3RhcnRdKTtcbiAgfVxuICBpZiAoZW5kIDwgMCkge1xuICAgIGVuZCA9IH5lbmQ7XG4gIH0gZWxzZSB7XG4gICAgcmFuZ2UgPSByYW5nZS5zcGFuKHJhbmdlc1tlbmRdKTtcbiAgICBlbmQrKztcbiAgfVxuICByYW5nZXMuc3BsaWNlKHN0YXJ0LCBlbmQgLSBzdGFydCwgcmFuZ2UpO1xufVxuXG5mdW5jdGlvbiByZW1vdmUocmFuZ2VzOiBSYW5nZVtdLCByYW5nZTogUmFuZ2UpIHtcbiAgbGV0IHN0YXJ0ID0gZmluZChyYW5nZXMsIHJhbmdlLmxvd2VyKTtcbiAgbGV0IGVuZCA9IGZpbmQocmFuZ2VzLCByYW5nZS51cHBlcik7XG4gIGlmIChzdGFydCA+PSAwICYmIHJhbmdlc1tzdGFydF0ubG93ZXIgPT09IHJhbmdlLmxvd2VyKSB7XG4gICAgc3RhcnQgPSB+c3RhcnQ7XG4gIH1cbiAgaWYgKGVuZCA+PSAwICYmIHJhbmdlc1tlbmRdLnVwcGVyID09PSByYW5nZS51cHBlcikge1xuICAgIGVuZCA9IH4oZW5kICsgMSk7XG4gIH1cbiAgaWYgKHN0YXJ0ID09PSBlbmQpIHtcbiAgICBpZiAoc3RhcnQgPCAwKSByZXR1cm47XG4gICAgcmFuZ2VzLnNwbGljZShzdGFydCwgMCwgcmFuZ2VzW3N0YXJ0XSk7XG4gICAgZW5kKys7XG4gIH1cbiAgaWYgKHN0YXJ0IDwgMCkge1xuICAgIHN0YXJ0ID0gfnN0YXJ0O1xuICB9IGVsc2Uge1xuICAgIHJhbmdlc1tzdGFydF0gPSBuZXcgUmFuZ2UocmFuZ2VzW3N0YXJ0XS5sb3dlciwgcmFuZ2UubG93ZXIpO1xuICAgIHN0YXJ0Kys7XG4gIH1cbiAgaWYgKGVuZCA8IDApIHtcbiAgICBlbmQgPSB+ZW5kXG4gIH0gZWxzZSB7XG4gICAgcmFuZ2VzW2VuZF0gPSBuZXcgUmFuZ2UocmFuZ2UudXBwZXIsIHJhbmdlc1tlbmRdLnVwcGVyKTtcbiAgfTtcbiAgcmFuZ2VzLnNwbGljZShzdGFydCwgZW5kIC0gc3RhcnQpO1xufVxuXG4vLyBOT1RFOiByZXR1cm5lZCByYW5nZSBtYXkgbm90IGFjdHVhbGx5IGNvbnRhaW4geCAoaWYgaXQncyB0aGUgdXBwZXIgYm91bmQpLlxuZnVuY3Rpb24gZmluZChyYW5nZXM6IHJlYWRvbmx5IFJhbmdlW10sIHg6IG51bWJlcik6IG51bWJlciB7XG4gIGxldCBhID0gMDtcbiAgbGV0IGIgPSByYW5nZXMubGVuZ3RoIC0gMTtcbiAgaWYgKGIgPCAwKSByZXR1cm4gfjA7XG4gIGlmICh4ID4gcmFuZ2VzW2JdLnVwcGVyKSByZXR1cm4gfnJhbmdlcy5sZW5ndGg7XG4gIGlmICh4ID49IHJhbmdlc1tiXS5sb3dlcikgcmV0dXJuIGI7XG4gIGlmICh4IDwgcmFuZ2VzW2FdLmxvd2VyKSByZXR1cm4gfjA7XG4gIGlmICh4IDw9IHJhbmdlc1thXS51cHBlcikgcmV0dXJuIGE7XG4gIHdoaWxlIChhIDwgYiAtIDEpIHtcbiAgICBjb25zdCBtID0gTWF0aC5mbG9vcigoYSArIGIpIC8gMik7XG4gICAgaWYgKHggPCByYW5nZXNbbV0ubG93ZXIpIHtcbiAgICAgIGIgPSBtO1xuICAgIH0gZWxzZSBpZiAoeCA+IHJhbmdlc1ttXS51cHBlcikge1xuICAgICAgYSA9IG07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBtO1xuICAgIH1cbiAgfVxuICByZXR1cm4gfmI7XG59XG4iXX0=