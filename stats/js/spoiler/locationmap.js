import { Canvas } from './canvas.js';
import { TileId } from '../logic/tileid.js';
const DATA = Symbol('[LocationMap data]');
export class LocationMap extends Canvas {
    constructor(rom, id = 0) {
        super(rom, 1, 1, 4);
        this.rom = rom;
        this.flags = new Set();
        this._maxWidth = Infinity;
        const location = rom.locations[id];
        this.width = (location.used ? location.width : 1) * 256;
        this.height = (location.used ? location.height : 1) * 240;
        this.location = location;
        const mouseListener = (e) => {
            let x = e.offsetX;
            let y = e.offsetY;
            let t = e.target;
            while (t && t !== this.element) {
                t = t.parentElement;
            }
            if (!t)
                return;
            const xs = x >> 8;
            const ys = Math.floor(y / 240);
            const xt = (x - 256 * xs) >> 4;
            const yt = (y - 240 * ys) >> 4;
            const locid = this.location.id;
            const tile = (locid << 16 | ys << 12 | xs << 8 | yt << 4 | xt);
            LocationMap.setData(e, { tile, target: this });
        };
        this.element.addEventListener('mousemove', mouseListener);
        this.element.addEventListener('mousedown', mouseListener);
        this.element.addEventListener('mouseup', mouseListener);
        this.element.addEventListener('click', mouseListener);
        this.redraw();
    }
    static getData(e) {
        return e[DATA];
    }
    static setData(e, data) {
        e[DATA] = data;
    }
    get id() { return this.location.id; }
    set id(id) {
        this.location = this.rom.locations[id];
        this.height = (this.location.used ? this.location.height : 1) * 240;
        this.width = (this.location.used ? this.location.width : 1) * 256;
        this.ensureWidth();
        this.redraw();
    }
    get maxWidth() { return this._maxWidth; }
    set maxWidth(width) {
        this._maxWidth = width;
        this.ensureWidth();
    }
    ensureWidth() {
        if (this.width <= this._maxWidth) {
            this.element.style.transform = '';
            this.element.style.width = '';
            this.element.style.height = '';
            return;
        }
        const s = this._maxWidth / this.width;
        const t = (1 - s) * 50;
        this.element.style.transform = `translate(-${t}%,-${t}%) scale(${s})`;
        this.element.style.width = `${(this.width * s)}px`;
        this.element.style.height = `${(this.height * s)}px`;
    }
    clearOverlay() {
        this.useLayer(1);
        this.fill(0);
        this.useLayer(3);
        this.fill(0);
        this.render();
    }
    overlayShade(color) {
        this.useLayer(3);
        this.fill(color);
    }
    overlayArea(area, borderColor, fillColor) {
        for (const tile of area) {
            if (tile >>> 16 !== this.location.id)
                continue;
            const ys = (tile >>> 12) & 15;
            const xs = (tile >>> 8) & 15;
            const yt = (tile >>> 4) & 15;
            const xt = tile & 15;
            const y0 = 240 * ys + 16 * yt;
            const x0 = 256 * xs + 16 * xt;
            if (fillColor != null) {
                this.useLayer(3);
                this.rect(y0 - 1, x0 - 1, 18, 18, 0);
            }
            this.useLayer(1);
            if (!area.has(TileId.add(tile, -1, 0))) {
                this.rect(y0 - 1, x0 - 1, 2, 18, borderColor);
            }
            if (!area.has(TileId.add(tile, 0, -1))) {
                this.rect(y0 - 1, x0 - 1, 18, 2, borderColor);
            }
            if (!area.has(TileId.add(tile, 1, 0))) {
                this.rect(y0 + 15, x0 - 1, 2, 18, borderColor);
            }
            if (!area.has(TileId.add(tile, 0, 1))) {
                this.rect(y0 - 1, x0 + 15, 18, 2, borderColor);
            }
        }
    }
    redraw() {
        this.useLayer(0);
        this.clear(this.location.tilePalettes[0]);
        for (let y = 0; y < this.location.height; y++) {
            for (let x = 0; x < this.location.width; x++) {
                const screenId = this.location.screens[y][x];
                this.drawScreen(this.rom.screens[screenId], y, x);
            }
        }
        this.useLayer(2);
        for (const spawn of this.location.spawns) {
            let offset = 0;
            let { x, y } = spawn;
            y -= spawn.yt & 0xf0;
            let metaspriteId;
            const frame = 0;
            if (spawn.isNpc()) {
                const npcData = this.rom.npcs[spawn.id];
                if (!npcData || !npcData.data)
                    continue;
                x += 8;
                y += 12;
                metaspriteId = (((frame >> 5) + 2) & 3) | npcData.data[3];
            }
            else if (spawn.isChest()) {
                metaspriteId = 0xaa;
            }
            else if (spawn.isMonster()) {
                const objData = this.rom.objects[spawn.monsterId];
                if (!objData)
                    continue;
                metaspriteId = objData.metasprite;
                if (objData.action == 0x29) {
                    metaspriteId = frame & 32 ? 0x6b : 0x68;
                }
                else if ([0x2a, 0x5e].includes(objData.action)) {
                    metaspriteId = (((frame >> 5) + 2) & 3) | objData.data[31];
                }
            }
            if (spawn.patternBank)
                offset += 0x40;
            if (metaspriteId != null) {
                this.metasprite(y, x, metaspriteId, this.location.id, offset);
            }
        }
        this.render();
    }
    drawScreen(screen, ys, xs) {
        var _a;
        const y0 = ys * 240;
        const x0 = xs * 256;
        const tileset = this.rom.tilesets[this.location.tileset];
        let flag;
        let alwaysTrue = false;
        for (const f of this.location.flags) {
            if (f.xs === xs && f.ys === ys) {
                flag = f.flag;
                if ((_a = this.rom.flags[flag]) === null || _a === void 0 ? void 0 : _a.logic.assumeTrue)
                    alwaysTrue = true;
                break;
            }
        }
        for (let y = 0; y < 240; y += 16) {
            for (let x = 0; x < 16; x++) {
                let metatileId = screen.tiles[y | x];
                if (metatileId < 0x20 && (this.flags.has(flag) || alwaysTrue)) {
                    metatileId = tileset.alternates[metatileId];
                }
                this.metatile(y0 + y, x0 + x * 16, metatileId, this.location.id, 0);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb25tYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvc3BvaWxlci9sb2NhdGlvbm1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBSW5DLE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQVExQyxNQUFNLElBQUksR0FBa0IsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFLekQsTUFBTSxPQUFPLFdBQVksU0FBUSxNQUFNO0lBY3JDLFlBQXFCLEdBQVEsRUFBRSxFQUFFLEdBQUcsQ0FBQztRQU1uQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFORCxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBSDdCLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQzFCLGNBQVMsR0FBRyxRQUFRLENBQUM7UUFTbkIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3hELElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDMUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsTUFBTSxhQUFhLEdBQUcsQ0FBQyxDQUFhLEVBQUUsRUFBRTtZQUN0QyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQ2xCLElBQUksQ0FBQyxH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QUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2lCQUM3QztnQkFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3JFO1NBQ0Y7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBSZW5kZXJzIGEgc2luZ2xlIGxvY2F0aW9uLlxuXG5pbXBvcnQge0NhbnZhc30gZnJvbSAnLi9jYW52YXMuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtTY3JlZW59IGZyb20gJy4uL3JvbS9zY3JlZW4uanMnO1xuaW1wb3J0IHtUaWxlSWR9IGZyb20gJy4uL2xvZ2ljL3RpbGVpZC5qcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9jYXRpb25Nb3VzZURhdGEge1xuICB0YXJnZXQ6IExvY2F0aW9uTWFwO1xuICB0aWxlOiBUaWxlSWQ7XG4gIC8vIFRPRE8gLSBlbnRyYW5jZSwgZXhpdCwgbW9uc3RlcnMsIGV0Yy5cbn1cblxuY29uc3QgREFUQTogdW5pcXVlIHN5bWJvbCA9IFN5bWJvbCgnW0xvY2F0aW9uTWFwIGRhdGFdJyk7XG5pbnRlcmZhY2UgSGFzRGF0YSB7XG4gIFtEQVRBXTogTG9jYXRpb25Nb3VzZURhdGE7XG59XG5cbmV4cG9ydCBjbGFzcyBMb2NhdGlvbk1hcCBleHRlbmRzIENhbnZhcyB7XG5cbiAgc3RhdGljIGdldERhdGEoZTogdW5rbm93bik6IExvY2F0aW9uTW91c2VEYXRhfHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIChlIGFzIHVua25vd24gYXMgSGFzRGF0YSlbREFUQV07XG4gIH1cblxuICBzdGF0aWMgc2V0RGF0YShlOiB1bmtub3duLCBkYXRhOiBMb2NhdGlvbk1vdXNlRGF0YSkge1xuICAgIChlIGFzIHVua25vd24gYXMgSGFzRGF0YSlbREFUQV0gPSBkYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb247XG4gIGZsYWdzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gIF9tYXhXaWR0aCA9IEluZmluaXR5O1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tLCBpZCA9IDApIHtcbiAgICAvLyA0IGxheWVyczpcbiAgICAvLyAgIDEuIGJhY2tncm91bmQgdGlsZXNcbiAgICAvLyAgIDIuIGFyZWEgbGluZXNcbiAgICAvLyAgIDMuIHNwcml0ZXNcbiAgICAvLyAgIDQuIHNoYWRpbmdcbiAgICBzdXBlcihyb20sIDEsIDEsIDQpO1xuICAgIGNvbnN0IGxvY2F0aW9uID0gcm9tLmxvY2F0aW9uc1tpZF07XG4gICAgdGhpcy53aWR0aCA9IChsb2NhdGlvbi51c2VkID8gbG9jYXRpb24ud2lkdGggOiAxKSAqIDI1NjtcbiAgICB0aGlzLmhlaWdodCA9IChsb2NhdGlvbi51c2VkID8gbG9jYXRpb24uaGVpZ2h0IDogMSkgKiAyNDA7XG4gICAgdGhpcy5sb2NhdGlvbiA9IGxvY2F0aW9uO1xuICAgIGNvbnN0IG1vdXNlTGlzdGVuZXIgPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgbGV0IHggPSBlLm9mZnNldFg7XG4gICAgICBsZXQgeSA9IGUub2Zmc2V0WTtcbiAgICAgIGxldCB0ID0gZS50YXJnZXQgYXMgSFRNTEVsZW1lbnR8bnVsbDtcbiAgICAgIHdoaWxlICh0ICYmIHQgIT09IHRoaXMuZWxlbWVudCkge1xuICAgICAgICAvLyB4ICs9IHQub2Zmc2V0TGVmdDtcbiAgICAgICAgLy8geSArPSB0Lm9mZnNldFRvcDtcbiAgICAgICAgdCA9IHQucGFyZW50RWxlbWVudDtcbiAgICAgIH1cbiAgICAgIC8vIE5PVEU6IGhhdmUgdG8gcmVhcHBseSBzY2FsZS90cmFuc2xhdGU/IT9cbiAgICAgIGlmICghdCkgcmV0dXJuO1xuICAgICAgLy8geCAtPSB0Lm9mZnNldExlZnQ7XG4gICAgICAvLyB5IC09IHQub2Zmc2V0VG9wO1xuICAgICAgY29uc3QgeHMgPSB4ID4+IDg7XG4gICAgICBjb25zdCB5cyA9IE1hdGguZmxvb3IoeSAvIDI0MCk7XG4gICAgICBjb25zdCB4dCA9ICh4IC0gMjU2ICogeHMpID4+IDQ7XG4gICAgICBjb25zdCB5dCA9ICh5IC0gMjQwICogeXMpID4+IDQ7XG4gICAgICBjb25zdCBsb2NpZCA9IHRoaXMubG9jYXRpb24uaWQ7XG4gICAgICBjb25zdCB0aWxlID0gKGxvY2lkIDw8IDE2IHwgeXMgPDwgMTIgfCB4cyA8PCA4IHwgeXQgPDwgNCB8IHh0KSBhcyBUaWxlSWQ7XG4gICAgICBMb2NhdGlvbk1hcC5zZXREYXRhKGUsIHt0aWxlLCB0YXJnZXQ6IHRoaXN9KTtcbiAgICB9O1xuICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBtb3VzZUxpc3RlbmVyKTtcbiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VMaXN0ZW5lcik7XG4gICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUxpc3RlbmVyKTtcbiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBtb3VzZUxpc3RlbmVyKTtcbiAgICB0aGlzLnJlZHJhdygpO1xuICB9XG5cbiAgZ2V0IGlkKCkgeyByZXR1cm4gdGhpcy5sb2NhdGlvbi5pZDsgfVxuICBzZXQgaWQoaWQ6IG51bWJlcikge1xuICAgIHRoaXMubG9jYXRpb24gPSB0aGlzLnJvbS5sb2NhdGlvbnNbaWRdO1xuICAgIHRoaXMuaGVpZ2h0ID0gKHRoaXMubG9jYXRpb24udXNlZCA/IHRoaXMubG9jYXRpb24uaGVpZ2h0IDogMSkgKiAyNDA7XG4gICAgdGhpcy53aWR0aCA9ICh0aGlzLmxvY2F0aW9uLnVzZWQgPyB0aGlzLmxvY2F0aW9uLndpZHRoIDogMSkgKiAyNTY7XG4gICAgdGhpcy5lbnN1cmVXaWR0aCgpO1xuICAgIHRoaXMucmVkcmF3KCk7XG4gIH1cblxuICBnZXQgbWF4V2lkdGgoKSB7IHJldHVybiB0aGlzLl9tYXhXaWR0aDsgfVxuICBzZXQgbWF4V2lkdGgod2lkdGg6IG51bWJlcikge1xuICAgIHRoaXMuX21heFdpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5lbnN1cmVXaWR0aCgpO1xuICB9XG5cbiAgZW5zdXJlV2lkdGgoKSB7XG4gICAgaWYgKHRoaXMud2lkdGggPD0gdGhpcy5fbWF4V2lkdGgpIHtcbiAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSAnJztcbiAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS53aWR0aCA9ICcnO1xuICAgICAgdGhpcy5lbGVtZW50LnN0eWxlLmhlaWdodCA9ICcnO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzID0gdGhpcy5fbWF4V2lkdGggLyB0aGlzLndpZHRoO1xuICAgIGNvbnN0IHQgPSAoMSAtIHMpICogNTA7XG4gICAgdGhpcy5lbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLSR7dH0lLC0ke3R9JSkgc2NhbGUoJHtzfSlgO1xuICAgIHRoaXMuZWxlbWVudC5zdHlsZS53aWR0aCA9IGAkeyh0aGlzLndpZHRoICogcyl9cHhgO1xuICAgIHRoaXMuZWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHsodGhpcy5oZWlnaHQgKiBzKX1weGA7XG4gIH1cblxuICBjbGVhck92ZXJsYXkoKSB7XG4gICAgdGhpcy51c2VMYXllcigxKTtcbiAgICB0aGlzLmZpbGwoMCk7XG4gICAgdGhpcy51c2VMYXllcigzKTtcbiAgICB0aGlzLmZpbGwoMCk7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIG92ZXJsYXlTaGFkZShjb2xvcjogbnVtYmVyKSB7XG4gICAgdGhpcy51c2VMYXllcigzKTtcbiAgICB0aGlzLmZpbGwoY29sb3IpO1xuICB9XG5cbiAgb3ZlcmxheUFyZWEoYXJlYTogU2V0PFRpbGVJZD4sIGJvcmRlckNvbG9yOiBudW1iZXIsIGZpbGxDb2xvcj86IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgdGlsZSBvZiBhcmVhKSB7XG4gICAgICBpZiAodGlsZSA+Pj4gMTYgIT09IHRoaXMubG9jYXRpb24uaWQpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgeXMgPSAodGlsZSA+Pj4gMTIpICYgMTU7XG4gICAgICBjb25zdCB4cyA9ICh0aWxlID4+PiA4KSAmIDE1O1xuICAgICAgY29uc3QgeXQgPSAodGlsZSA+Pj4gNCkgJiAxNTtcbiAgICAgIGNvbnN0IHh0ID0gdGlsZSAmIDE1O1xuICAgICAgY29uc3QgeTAgPSAyNDAgKiB5cyArIDE2ICogeXQ7XG4gICAgICBjb25zdCB4MCA9IDI1NiAqIHhzICsgMTYgKiB4dDtcbiAgICAgIGlmIChmaWxsQ29sb3IgIT0gbnVsbCkge1xuICAgICAgICB0aGlzLnVzZUxheWVyKDMpO1xuICAgICAgICB0aGlzLnJlY3QoeTAgLSAxLCB4MCAtIDEsIDE4LCAxOCwgMCk7XG4gICAgICB9ICAgICAgXG4gICAgICB0aGlzLnVzZUxheWVyKDEpO1xuICAgICAgaWYgKCFhcmVhLmhhcyhUaWxlSWQuYWRkKHRpbGUsIC0xLCAwKSkpIHtcbiAgICAgICAgdGhpcy5yZWN0KHkwIC0gMSwgeDAgLSAxLCAyLCAxOCwgYm9yZGVyQ29sb3IpO1xuICAgICAgfVxuICAgICAgaWYgKCFhcmVhLmhhcyhUaWxlSWQuYWRkKHRpbGUsIDAsIC0xKSkpIHtcbiAgICAgICAgdGhpcy5yZWN0KHkwIC0gMSwgeDAgLSAxLCAxOCwgMiwgYm9yZGVyQ29sb3IpO1xuICAgICAgfVxuICAgICAgaWYgKCFhcmVhLmhhcyhUaWxlSWQuYWRkKHRpbGUsIDEsIDApKSkge1xuICAgICAgICB0aGlzLnJlY3QoeTAgKyAxNSwgeDAgLSAxLCAyLCAxOCwgYm9yZGVyQ29sb3IpO1xuICAgICAgfVxuICAgICAgaWYgKCFhcmVhLmhhcyhUaWxlSWQuYWRkKHRpbGUsIDAsIDEpKSkge1xuICAgICAgICB0aGlzLnJlY3QoeTAgLSAxLCB4MCArIDE1LCAxOCwgMiwgYm9yZGVyQ29sb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlZHJhdygpIHtcbiAgICB0aGlzLnVzZUxheWVyKDApO1xuICAgIHRoaXMuY2xlYXIodGhpcy5sb2NhdGlvbi50aWxlUGFsZXR0ZXNbMF0pO1xuICAgIC8vIERyYXcgdGhlIGJhY2tncm91bmRcbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMubG9jYXRpb24uaGVpZ2h0OyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5sb2NhdGlvbi53aWR0aDsgeCsrKSB7XG4gICAgICAgIGNvbnN0IHNjcmVlbklkID0gdGhpcy5sb2NhdGlvbi5zY3JlZW5zW3ldW3hdO1xuICAgICAgICB0aGlzLmRyYXdTY3JlZW4odGhpcy5yb20uc2NyZWVuc1tzY3JlZW5JZF0sIHksIHgpO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBUT0RPIC0gYWRkIG1vbnN0ZXJzL2NoZXN0c1xuICAgIHRoaXMudXNlTGF5ZXIoMik7XG4gICAgZm9yIChjb25zdCBzcGF3biBvZiB0aGlzLmxvY2F0aW9uLnNwYXducykge1xuICAgICAgbGV0IG9mZnNldCA9IDA7XG4gICAgICBsZXQge3gsIHl9ID0gc3Bhd247XG4gICAgICB5IC09IHNwYXduLnl0ICYgMHhmMDtcbiAgICAgIGxldCBtZXRhc3ByaXRlSWQ6IG51bWJlcnx1bmRlZmluZWQ7XG4gICAgICBjb25zdCBmcmFtZSA9IDA7XG4gICAgICBpZiAoc3Bhd24uaXNOcGMoKSkge1xuICAgICAgICBjb25zdCBucGNEYXRhID0gdGhpcy5yb20ubnBjc1tzcGF3bi5pZF07XG4gICAgICAgIGlmICghbnBjRGF0YSB8fCAhbnBjRGF0YS5kYXRhKSBjb250aW51ZTtcbiAgICAgICAgeCArPSA4O1xuICAgICAgICB5ICs9IDEyO1xuICAgICAgICBtZXRhc3ByaXRlSWQgPSAoKChmcmFtZSA+PiA1KSArIDIpICYgMykgfCBucGNEYXRhLmRhdGFbM107XG4gICAgICB9IGVsc2UgaWYgKHNwYXduLmlzQ2hlc3QoKSkge1xuICAgICAgICBtZXRhc3ByaXRlSWQgPSAweGFhO1xuICAgICAgICAvLyBUT0RPIC0gaWYgaXQncyBhIG1pbWljLCB1c2UgMHg5MCBpbnN0ZWFkP1xuICAgICAgICAvLyBUT0RPIC0gb3ZlcnJpZGUgcGF0dGVybiB0YWJsZSBmb3IgaW52aXNpYmxlIGNoZXN0cz9cbiAgICAgIH0gZWxzZSBpZiAoc3Bhd24uaXNNb25zdGVyKCkpIHtcbiAgICAgICAgY29uc3Qgb2JqRGF0YSA9IHRoaXMucm9tLm9iamVjdHNbc3Bhd24ubW9uc3RlcklkXTtcbiAgICAgICAgaWYgKCFvYmpEYXRhKSBjb250aW51ZTtcbiAgICAgICAgbWV0YXNwcml0ZUlkID0gb2JqRGF0YS5tZXRhc3ByaXRlO1xuICAgICAgICBpZiAob2JqRGF0YS5hY3Rpb24gPT0gMHgyOSkgeyAvLyBibG9iXG4gICAgICAgICAgbWV0YXNwcml0ZUlkID0gZnJhbWUgJiAzMiA/IDB4NmIgOiAweDY4O1xuICAgICAgICB9IGVsc2UgaWYgKFsweDJhLCAweDVlXS5pbmNsdWRlcyhvYmpEYXRhLmFjdGlvbikpIHtcbiAgICAgICAgICAvLyBkaXJlY3Rpb25hbCB3YWxrZXIgKHNvbGRpZXIsIGV0Yyk7IGFsc28gdG93ZXIgZGVmIG1lY2ggKDVlKVxuICAgICAgICAgIG1ldGFzcHJpdGVJZCA9ICgoKGZyYW1lID4+IDUpICsgMikgJiAzKSB8IG9iakRhdGEuZGF0YVszMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzcGF3bi5wYXR0ZXJuQmFuaykgb2Zmc2V0ICs9IDB4NDA7XG4gICAgICBpZiAobWV0YXNwcml0ZUlkICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5tZXRhc3ByaXRlKHksIHgsIG1ldGFzcHJpdGVJZCwgdGhpcy5sb2NhdGlvbi5pZCwgb2Zmc2V0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIGRyYXdTY3JlZW4oc2NyZWVuOiBTY3JlZW4sIHlzOiBudW1iZXIsIHhzOiBudW1iZXIpIHtcbiAgICBjb25zdCB5MCA9IHlzICogMjQwO1xuICAgIGNvbnN0IHgwID0geHMgKiAyNTY7XG4gICAgY29uc3QgdGlsZXNldCA9IHRoaXMucm9tLnRpbGVzZXRzW3RoaXMubG9jYXRpb24udGlsZXNldF07XG4gICAgbGV0IGZsYWc6IG51bWJlcnx1bmRlZmluZWQ7XG4gICAgbGV0IGFsd2F5c1RydWUgPSBmYWxzZTtcbiAgICBmb3IgKGNvbnN0IGYgb2YgdGhpcy5sb2NhdGlvbi5mbGFncykge1xuICAgICAgaWYgKGYueHMgPT09IHhzICYmIGYueXMgPT09IHlzKSB7XG4gICAgICAgIGZsYWcgPSBmLmZsYWc7XG4gICAgICAgIGlmICh0aGlzLnJvbS5mbGFnc1tmbGFnXT8ubG9naWMuYXNzdW1lVHJ1ZSkgYWx3YXlzVHJ1ZSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IDI0MDsgeSArPSAxNikge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCAxNjsgeCsrKSB7XG4gICAgICAgIGxldCBtZXRhdGlsZUlkID0gc2NyZWVuLnRpbGVzW3kgfCB4XTtcbiAgICAgICAgaWYgKG1ldGF0aWxlSWQgPCAweDIwICYmICh0aGlzLmZsYWdzLmhhcyhmbGFnISkgfHwgYWx3YXlzVHJ1ZSkpIHtcbiAgICAgICAgICBtZXRhdGlsZUlkID0gdGlsZXNldC5hbHRlcm5hdGVzW21ldGF0aWxlSWRdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubWV0YXRpbGUoeTAgKyB5LCB4MCArIHggKiAxNiwgbWV0YXRpbGVJZCwgdGhpcy5sb2NhdGlvbi5pZCwgMCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=