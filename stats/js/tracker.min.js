(function(){'use strict';var l=l||{};l.scope={};l.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};l.arrayIterator=function(a){return{next:l.arrayIteratorImpl(a)}};l.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):l.arrayIterator(a)};
l.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};l.global=l.getGlobal(this);l.ASSUME_ES5=!1;l.ASSUME_NO_NATIVE_MAP=!1;l.ASSUME_NO_NATIVE_SET=!1;l.SIMPLE_FROUND_POLYFILL=!1;
l.defineProperty=l.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};l.polyfill=function(a,b){if(b){var c=l.global;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&l.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};l.FORCE_POLYFILL_PROMISE=!1;l.SYMBOL_PREFIX="jscomp_symbol_";
l.initSymbol=function(){l.initSymbol=function(){};l.global.Symbol||(l.global.Symbol=l.Symbol)};l.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;l.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};l.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};l.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new l.SymbolClass(l.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
l.initSymbolIterator=function(){l.initSymbol();var a=l.global.Symbol.iterator;a||(a=l.global.Symbol.iterator=l.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&l.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return l.iteratorPrototype(l.arrayIteratorImpl(this))}});l.initSymbolIterator=function(){}};
l.initSymbolAsyncIterator=function(){l.initSymbol();var a=l.global.Symbol.asyncIterator;a||(a=l.global.Symbol.asyncIterator=l.global.Symbol("Symbol.asyncIterator"));l.initSymbolAsyncIterator=function(){}};l.iteratorPrototype=function(a){l.initSymbolIterator();a={next:a};a[l.global.Symbol.iterator]=function(){return this};return a};l.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
l.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:l.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;l.generator={};l.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};
l.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};l.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};l.generator.Context.prototype.stop_=function(){this.isRunning_=!1};
l.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};l.generator.Context.prototype.next_=function(a){this.yieldResult=a};l.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};l.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};
l.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};l.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};l.generator.Context.prototype.yieldAll=function(a,b){a=l.makeIterator(a);var c=a.next();l.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};
l.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};l.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};l.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};l.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};l.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
l.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};l.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
l.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};l.generator.Context.prototype.forIn=function(a){return new l.generator.Context.PropertyIterator(a)};
l.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};l.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};l.generator.Engine_=function(a){this.context_=new l.generator.Context;this.program_=a};
l.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};l.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(a){return{value:a,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
l.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
l.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);l.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
l.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
l.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};l.initSymbolIterator();this[Symbol.iterator]=function(){return this}};l.generator.createGenerator=function(a,b){b=new l.generator.Generator_(new l.generator.Engine_(b));l.setPrototypeOf&&l.setPrototypeOf(b,a.prototype);return b};
l.asyncExecutePromiseGenerator=function(a){function b(b){return a.next(b)}function c(b){return a.throw(b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};l.asyncExecutePromiseGeneratorFunction=function(a){return l.asyncExecutePromiseGenerator(a())};l.asyncExecutePromiseGeneratorProgram=function(a){return l.asyncExecutePromiseGenerator(new l.generator.Generator_(new l.generator.Engine_(a)))};
l.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};l.stringPadding=function(a,b){a=void 0!==a?String(a):" ";return 0<b&&a?a.repeat(Math.ceil(b/a.length)).substring(0,b):""};
l.polyfill("String.prototype.padStart",function(a){return a?a:function(a,c){var b=l.checkStringArgs(this,null,"padStart");return l.stringPadding(c,a-b.length)+b}},"es8","es3");l.iteratorFromArray=function(a,b){l.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
l.polyfill("Array.prototype.values",function(a){return a?a:function(){return l.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");l.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");l.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
l.polyfill("Object.entries",function(a){return a?a:function(a){var b=[],d;for(d in a)l.owns(a,d)&&b.push([d,a[d]]);return b}},"es8","es3");l.polyfill("globalThis",function(a){return a||l.global},"es_2020","es3");l.polyfill("Array.prototype.flatMap",function(a){return a?a:function(a,c){for(var b=[],e=0;e<this.length;e++){var f=a.call(c,this[e],e,this);Array.isArray(f)?b.push.apply(b,f):b.push(f)}return b}},"es9","es5");
l.polyfill("Object.values",function(a){return a?a:function(a){var b=[],d;for(d in a)l.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");class aa extends Error{}class ba extends Map{constructor(a,b){super(b);this.supplier=a}get(a){let b=super.get(a);null==b&&super.set(a,b=this.supplier(a));return b}sortedKeys(a){return[...this.keys()].sort(a)}sortedEntries(a){return this.sortedKeys(a).map(a=>[a,this.get(a)])}}var ca;
(function(a){a.concat=function*(...a){for(const b of a)yield*b};a.isEmpty=function(a){return!!a[Symbol.iterator]().next().done};a.map=function*(a,c){for(const b of a)yield c(b)};a.filter=function*(a,c){for(const b of a)c(b)&&(yield b)};a.flatMap=function*(a,c){for(const b of a)yield*c(b)};a.count=function(a){let b=0;for(const c of a)b++;return b};a.take=function*(a,c){for(const b of a){if(0>--c)break;yield b}};a.first=function(a,c){for(const b of a)return b;if(2>arguments.length)throw Error(`Empty iterable: ${a}`);
return c};a.zip=function(a,c,d=(a,b)=>[a,b]){return{*[Symbol.iterator](){const b=a[Symbol.iterator](),f=c[Symbol.iterator]();let g,h;for(;g=b.next(),h=f.next(),!g.done&&!h.done;)yield d(g.value,h.value)}}}})(ca||(ca={}));function da(a){return[...a]}class ea{constructor(){this.map=new Map}add(a){this.map.set(a.label,a)}has(a){return this.map.has(a.label)}delete(a){this.map.delete(a.label)}[Symbol.iterator](){return this.map.values()}}const fa=Symbol("Invalidated"),ha=Symbol("Size");
class ia{constructor(a,b,c){this.ownerMap=a;this.ownerKey=b;this.currentSet=c}getCurrentSet(){if(!this.currentSet||this.currentSet[fa])this.currentSet=this.ownerMap.get(this.ownerKey)||new Set;return this.currentSet}mutateSet(a){const b=this.getCurrentSet(),c=b.size;try{return a(b)}finally{this.ownerMap[ha]+=b.size-c,b.size||(this.ownerMap.delete(this.ownerKey),b[fa]=!0)}}add(a){this.mutateSet(b=>b.add(a));return this}has(a){return this.getCurrentSet().has(a)}clear(){this.mutateSet(a=>a.clear())}delete(a){return this.mutateSet(b=>
b.delete(a))}[Symbol.iterator](){return this.getCurrentSet()[Symbol.iterator]()}values(){return this.getCurrentSet().values()}keys(){return this.getCurrentSet().keys()}entries(){return this.getCurrentSet().entries()}forEach(a,b){this.getCurrentSet().forEach(a,b)}get size(){return this.getCurrentSet().size}get [Symbol.toStringTag](){return"Set"}}Reflect.setPrototypeOf(ia.prototype,Set.prototype);function ja(a){throw Error(`non-exhaustive check: ${a}`);}
class ka{constructor(a){this._map=new Map;if(a)for(const [b,c,d]of a)this.set(b,c,d)}*[Symbol.iterator](){for(const [a,b]of this._map)for(const [c,d]of b)yield[a,c,d]}set(a,b,c){let d=this._map.get(a);d||this._map.set(a,d=new Map);d.set(b,c)}get(a,b){var c;return null===(c=this._map.get(a))||void 0===c?void 0:c.get(b)}has(a,b){var c;return(null===(c=this._map.get(a))||void 0===c?void 0:c.has(b))||!1}delete(a,b){const c=this._map.get(a);c&&(c.delete(b),c.size||this._map.delete(a))}row(a){var b;return null!==
(b=this._map.get(a))&&void 0!==b?b:new Map}}var la;(function(a){a.NONE={get requested(){return!1},throwIfRequested(){},register(){return{unregister(){}}}};a.CANCELLED={get requested(){return!0},throwIfRequested(){throw Error("cancelled");},register(){return{unregister(){}}}}})(la||(la={}));function ma(a,b=1){return 0>a?`~${(~a).toString(16).padStart(b,"0")}`:a.toString(16).padStart(b,"0")};class na{constructor(a){this.table=a}op(a){const b=this.table[a];if(!b)throw Error(`Bad mnemonic: ${a}`);return b}argLen(a){switch(a){case "acc":case "imp":return 0;case "imm":case "rel":case "zpg":case "zpx":case "zpy":case "iny":return 1;case "abs":case "abx":case "aby":case "ind":case "inx":return 2}return ja(a)}}var oa;
(oa||(oa={})).P02=new na({adc:{abs:109,abx:125,aby:121,imm:105,iny:113,inx:97,zpg:101,zpx:117},and:{abs:45,abx:61,aby:57,imm:41,iny:49,inx:33,zpg:37,zpx:53},asl:{abs:14,abx:30,acc:10,imp:10,zpg:6,zpx:22},bcc:{rel:144},bcs:{rel:176},beq:{rel:240},bit:{abs:44,zpg:36},bmi:{rel:48},bne:{rel:208},bpl:{rel:16},brk:{imp:0},bvc:{rel:80},bvs:{rel:112},clc:{imp:24},cld:{imp:216},cli:{imp:88},clv:{imp:184},cmp:{abs:205,abx:221,aby:217,imm:201,iny:209,inx:193,zpg:197,zpx:213},cpx:{abs:236,imm:224,zpg:228},cpy:{abs:204,
imm:192,zpg:196},dec:{abs:206,abx:222,zpg:198,zpx:214},dex:{imp:202},dey:{imp:136},eor:{abs:77,abx:93,aby:89,imm:73,iny:81,inx:65,zpg:69,zpx:85},inc:{abs:238,abx:254,zpg:230,zpx:246},inx:{imp:232},iny:{imp:200},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{abs:173,abx:189,aby:185,imm:169,iny:177,inx:161,zpg:165,zpx:181},ldx:{abs:174,aby:190,imm:162,zpg:166,zpy:182},ldy:{abs:172,abx:188,imm:160,zpg:164,zpx:180},lsr:{abs:78,abx:94,acc:74,imp:74,zpg:70,zpx:86},nop:{imp:234},ora:{abs:13,abx:29,aby:25,imm:9,
iny:17,inx:1,zpg:5,zpx:21},pha:{imp:72},php:{imp:8},pla:{imp:104},plp:{imp:40},rol:{abs:46,abx:62,acc:42,imp:42,zpg:38,zpx:54},ror:{abs:110,abx:126,acc:106,imp:106,zpg:102,zpx:118},rti:{imp:64},rts:{imp:96},sbc:{abs:237,abx:253,aby:249,imm:233,iny:241,inx:225,zpg:229,zpx:245},sec:{imp:56},sed:{imp:248},sei:{imp:120},sta:{abs:141,abx:157,aby:153,iny:145,inx:129,zpg:133,zpx:149},stx:{abs:142,zpg:134,zpy:150},sty:{abs:140,zpg:132,zpx:148},tax:{imp:170},tay:{imp:168},tsx:{imp:186},txa:{imp:138},txs:{imp:154},
tya:{imp:152}});var pa;(function(a){class b{next(){for(;;){this.sink||(this.sink=this.pump());const {value:a,done:b}=this.sink.next();if(!b)return a;this.sink=void 0}}}a.Abstract=b;a.concat=function(...a){let b;return{next:()=>{for(;;){b||(b=a.shift());if(!b)break;const c=b.next();if(c)return c;b=void 0}}}}})(pa||(pa={}));var m;
(function(a){function b(a,b){return a&&b&&a.token===b.token&&"grp"!==a.token&&a.str===b.str&&a.num===b.num?!0:!1}function c(a){switch(a.token){case "num":return`NUM[$${a.num.toString(16)}]`;case "str":return`STR[$${a.str}]`;case "lb":return"[";case "rb":return"]";case "grp":return"{";case "lc":return"{";case "rc":return"}";case "lp":return"(";case "rp":return")";case "eol":return"EOL";case "eof":return"EOF";case "ident":return a.str;case "cs":case "op":return`${a.str.toUpperCase()}`;default:ja(a)}}
function d(a){a=a.source;if(!a)return"";const b=a.parent?d({source:a.parent}):"";return`\n  at ${a.file}:${a.line}:${a.column}${b}`}function e(a){return c(a)+d(a)}function f(a,b){return g("ident","identifier",a,b)}function g(a,b,c,d){if(!c){if(!d)throw Error(`Expected ${b}`);throw Error(`Expected ${b} after ${e(d)}`);}if(c.token!==a)throw Error(`Expected ${b}: ${e(c)}`);return c.str}function h(a,c,d){for(;d<a.length;d++)if(b(a[d],c))return d;return-1}function k(a){let b=0;for(const c of a)"grp"===
c.token?b+=2+k(c.inner):b++;return b}a.LB={token:"lb"};a.LC={token:"lc"};a.LP={token:"lp"};a.RB={token:"rb"};a.RC={token:"rc"};a.RP={token:"rp"};a.EOL={token:"eol"};a.EOF={token:"eof"};a.DEFINE={token:"cs",str:".define"};a.DOT_EOL={token:"cs",str:".eol"};a.ELSE={token:"cs",str:".else"};a.ELSEIF={token:"cs",str:".elseif"};a.ENDIF={token:"cs",str:".endif"};a.ENDMAC={token:"cs",str:".endmac"};a.ENDMACRO={token:"cs",str:".endmacro"};a.ENDREP={token:"cs",str:".endrep"};a.ENDREPEAT={token:"cs",str:".endrepeat"};
a.ENDPROC={token:"cs",str:".endproc"};a.ENDSCOPE={token:"cs",str:".endscope"};a.LOCAL={token:"cs",str:".local"};a.MACRO={token:"cs",str:".macro"};a.REPEAT={token:"cs",str:".repeat"};a.SET={token:"cs",str:".set"};a.SKIP={token:"cs",str:".skip"};a.BYTE={token:"cs",str:".byte"};a.WORD={token:"cs",str:".word"};a.COLON={token:"op",str:":"};a.COMMA={token:"op",str:","};a.STAR={token:"op",str:"*"};a.IMMEDIATE={token:"op",str:"#"};a.ASSIGN={token:"op",str:"="};a.match=function(a,b){return a.token!==b.token?
!1:"num"===a.token||"str"===a.token?!0:a.str!==b.str?!1:!0};a.eq=b;a.name=c;a.at=d;a.nameAt=e;a.expectEol=function(b,c="end of line"){if(b)throw Error(`Expected ${c}: ${a.nameAt(b)}`);};a.expect=function(a,d,f){if(!d){if(!f)throw Error(`Expected ${c(a)}`);throw Error(`Expected ${c(a)} after ${e(d)}`);}if(!b(a,d))throw Error(`Expected ${c(a)}: ${e(d)}`);};a.expectIdentifier=f;a.expectString=function(a,b){return g("str","constant string",a,b)};a.identsFromCList=function(c){if(!c.length)return[];const d=
[];for(let f=0;f<=c.length;f+=2){const g=c[f];if("ident"!==(null===g||void 0===g?void 0:g.token)){if(g)throw Error(`Expected identifier: ${e(g)}`);throw Error(`Expected identifier after ${e(c[c.length-1])}`);}if(f+1<c.length&&!b(c[f+1],a.COMMA))throw Error(`Expected comma: ${e(c[f+1])}`);d.push(g.str)}return d};a.findBalanced=function(a,b){const c=a[b++].token;if("lp"!==c&&"lb"!==c)throw Error("non-grouping token");const d="lp"===c?"rp":"rb";let e=1;for(;b<a.length;b++){const f=a[b].token;e+=Number(f===
c)-Number(f===d);if(!e)return b}return-1};a.parseArgList=function(c,e=0,f=c.length){let g=[];const h=[g];let k=0;for(;e<f;e++){const f=c[e];if(!k&&b(f,a.COMMA))h.push(g=[]);else if(g.push(f),b(f,a.LP)&&k++,b(f,a.RP)&&0>--k)throw Error(`Unbalanced paren${d(f)}`);}return h};a.parseAttrList=function(c,g){const h=new Map;let k,p=[];if(g>=c.length)return h;if(!b(c[g],a.COLON))throw Error(`Unexpected: ${e(c[g])}`);for(g+=1;g<c.length;g++){const e=c[g];if(b(e,a.COLON)){if(null==k)throw Error(`Missing key${d(e)}`);
h.set(k,p);k=void 0;p=[]}else null==k?k=f(e):p.push(e)}null!=k?h.set(k,p):f(void 0,c[c.length-1]);return h};a.findComma=function(b,c){c=h(b,a.COMMA,c);return 0>c?b.length:c};a.find=h;a.count=k;a.isRegister=function(a,b){return"ident"===a.token&&a.str.toLowerCase()===b};a.str=function(b){switch(b.token){case "cs":case "ident":case "str":case "op":return b.str}throw Error(`Non-string token: ${a.nameAt(b)}`);};a.strip=function(a){delete a.source;return a}})(m||(m={}));new Set(".blank .const .defined .left .match .mid .right .tcount .xmatch".split(" "));var qa;
(function(a){function b(a){return a.source?{source:{parent:a.source,file:"js",line:0,column:0}}:{}}function c(a,b){function c(a){return a.args?Object.assign({},a,{args:a.args.map(b=>d(b,a))}):a}function d(a,d){const e=a.source;a=b(a,c,d);e&&!a.source&&(a.source=e);return a}return d(a)}function d(a,b){b=void 0===b?0:b;const [c,d]=e(a,b);if(d<a.length)throw e(a,b),Error(`Garbage after expression: ${m.nameAt(a[d])}`);if(!c)throw Error("No expression?");return c}function e(a,b){function c(){const [a,[,
,b]]=e.pop(),c=f.splice(f.length-b,b);if(c.length!==b)throw Error("shunting parse failed?");f.push(ra({op:a,args:c}))}b=void 0===b?0:b;const e=[],f=[];for(var g=!0,h=b;h<a.length;h++){var k=a[h];if(g)if("cs"===k.token||"op"===k.token){var t=sa.get(k.str);if(t=ua.get(null!==t&&void 0!==t?t:k.str))e.push([k.str,t]);else if("cs"===k.token){g=k.str;if(!va.has(g))throw Error(`No such function: ${m.nameAt(k)}`);t=a[h+1];if("lp"!==(null===t||void 0===t?void 0:t.token))throw Error(`Bad funcall: ${m.nameAt(null!==
t&&void 0!==t?t:k)}`);k=m.findBalanced(a,h+1);if(0>k)throw Error(`Never closed: ${m.nameAt(t)}`);t=[];for(const b of m.parseArgList(a,h+2,k))t.push(d(b));h=k;f.push(ra({op:g,args:t}));g=!1}else if(m.eq(k,m.STAR))f.push({op:"sym",sym:"*"}),g=!1;else throw Error(`Unknown prefix operator: ${m.nameAt(k)}`);}else if("lp"===k.token){g=m.findBalanced(a,h);if(0>g)throw Error(`No close paren: ${m.nameAt(k)}`);h=d(a.slice(h+1,g));f.push(h);h=g;g=!1}else if("ident"===k.token)f.push({op:"sym",sym:k.str}),g=!1;
else if("num"===k.token)k=k.num,f.push({op:"num",num:k,meta:xa(k)}),g=!1;else throw Error(`Bad expression token: ${m.nameAt(k)}`);else{if(m.eq(k,m.COMMA))break;if("cs"===k.token||"op"===k.token){g=sa.get(k.str);g=ya.get(null!==g&&void 0!==g?g:k.str);if(!g)break;for(;e.length;){t=e[e.length-1];const a=za(t[1],g);if(0>a)break;if(0===a)throw Error(`Mixing ${t[0]} and ${k.str} needs explicit parens.${m.at(k)}`);c()}e.push([k.str,g]);g=!0}else break}}for(;e.length;)c();if(1!==f.length)throw Error("shunting parse failed?");
a[b].source&&(f[0].source=a[b].source);return[f[0],h]}function f(a){if(null!=a)return{op:"num",num:a,meta:xa(a)}}function g(a,b){const c=a.args[0];if(!q(c))return a;a=b(c.num);return{op:"num",num:a,meta:xa(a)}}function h(a,b){const [c,d]=a.args;if(!q(c)||!q(d))return a;a=b(c.num,d.num);return{op:"num",num:a,meta:xa(a)}}function k(a){var b,c,d,e,f,g;const [h,k]=a.args;if("num"!==h.op||"num"!==k.op)return a;const t={op:"num",num:h.num+k.num};if(h.meta||k.meta){if((null===(b=h.meta)||void 0===b?0:b.rel)&&
(null===(c=k.meta)||void 0===c?0:c.rel))return a;if(null===(d=h.meta)||void 0===d?0:d.rel)t.meta=h.meta;else if(null===(e=k.meta)||void 0===e?0:e.rel)t.meta=k.meta}null!==(f=t.meta)&&void 0!==f&&f.rel||null!=(null===(g=t.meta)||void 0===g?void 0:g.size)||((t.meta||(t.meta={})).size=xa(t.num).size);return t}function p(a){var b,c,d,e,f;const [g,h]=a.args;if("num"!==g.op||"num"!==h.op)return a;const k={op:"num",num:g.num-h.num};if(null===(b=h.meta)||void 0===b?0:b.rel)return(null===(c=g.meta)||void 0===
c?0:c.rel)&&g.meta.chunk===h.meta.chunk?k:a;if(null===(d=g.meta)||void 0===d?0:d.rel)k.meta=g.meta;null!==(e=k.meta)&&void 0!==e&&e.rel||null!=(null===(f=k.meta)||void 0===f?void 0:f.size)||((k.meta||(k.meta={})).size=xa(k.num).size);return k}function q(a){var b;return"num"===a.op&&!(null===(b=a.meta)||void 0===b?0:b.rel)}a.loByte=function(a){return Object.assign({},{op:"<",args:[a]},b(a))};a.hiByte=function(a){return Object.assign({},{op:">",args:[a]},b(a))};a.traverse=c;a.traversePost=function(a,
b){return c(a,(a,c)=>b(c(a)))};a.evaluate=function(a){var b,c,d,e;switch(a.op){case ".move":case "im":case "sym":return a;case "num":return(null===(b=a.meta)||void 0===b?0:b.rel)&&null!=a.meta.org?(b=Object.assign({},a.meta),b=(delete b.rel,b),{op:"num",num:a.num+b.org,meta:b}):a;case ".max":throw Error();case ".min":throw Error();}if(1===(null===(c=a.args)||void 0===c?void 0:c.length))switch(a.op){case "+":return a.args[0];case "-":return g(a,a=>-a);case "~":return g(a,a=>~a);case "!":return g(a,
a=>+!a);case "<":return g(a,a=>a&255);case ">":return g(a,a=>a>>8&255);case "^":return null!==(e=f(null===(d=a.args[0].meta)||void 0===d?void 0:d.bank))&&void 0!==e?e:a;default:throw Error(`Unknown unary operator: ${a.op}`);}switch(a.op){case "+":return k(a);case "-":return p(a);case "*":return h(a,(a,b)=>a*b);case "/":return h(a,(a,b)=>Math.floor(a/b));case ".mod":return h(a,(a,b)=>a%b);case "&":return h(a,(a,b)=>a&b);case "|":return h(a,(a,b)=>a|b);case "^":return h(a,(a,b)=>a^b);case "<<":return h(a,
(a,b)=>a<<b);case ">>":return h(a,(a,b)=>a>>>b);case "<":return h(a,(a,b)=>+(a<b));case "<=":return h(a,(a,b)=>+(a<=b));case ">":return h(a,(a,b)=>+(a>b));case ">=":return h(a,(a,b)=>+(a>=b));case "=":return h(a,(a,b)=>+(a==b));case "<>":return h(a,(a,b)=>+(a!=b));case "&&":return h(a,(a,b)=>a&&b);case "||":return h(a,(a,b)=>a||b);case ".xor":return h(a,(a,b)=>!a&&b||!b&&a||0);default:throw Error(`Unknown operator: ${a.op}`);}};a.identifier=function(a){if("sym"===a.op&&a.sym)return a.sym;throw Error(`Expected identifier but got op: ${a.op}`);
};a.parseOnly=d;a.parse=e})(qa||(qa={}));function za(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:a[1]!==b[1]?0:a[1]}
const ya=new Map([["*",[5,4,2]],["/",[5,4,2]],[".mod",[5,3,2]],["&",[5,2,2]],["^",[5,1,2]],["<<",[5,0,2]],[">>",[5,0,2]],["+",[4,2,2]],["-",[4,2,2]],["|",[4,1,2]],["<",[3,0,2]],["<=",[3,0,2]],[">",[3,0,2]],[">=",[3,0,2]],["=",[3,0,2]],["<>",[3,0,2]],["&&",[2,3,2]],[".xor",[2,2,2]],["||",[2,1,2]]]),ua=new Map([["+",[9,-1,1]],["-",[9,-1,1]],["~",[9,-1,1]],["<",[9,-1,1]],[">",[9,-1,1]],["^",[9,-1,1]],["!",[2,-1,1]]]),va=new Set([".byteat",".wordat",".max",".min"]),sa=new Map([[".bitand","&"],[".bitxor",
"^"],[".bitor","|"],[".shl","<<"],[".shr",">>"],[".and","&&"],[".or","||"],[".bitnot","~"],[".lobyte","<"],[".hibyte",">"],[".bankbyte","^"],[".not","!"]]),Aa=new Map([["^",(...a)=>1===a.length?1:Math.max(...a)],["<",()=>1],[">",()=>1],["!",()=>1],["<=",()=>1],[">=",()=>1],["<>",()=>1],["=",()=>1],["&",Math.max],["&&",Math.max],["|",Math.max],["||",Math.max],[".xor",Math.max],[".max",Math.max],[".min",Math.max]]);
function ra(a){var b=Aa.get(a.op);if(b=null===b||void 0===b?void 0:b(...a.args.map(a=>{var b;return Number(null===(b=a.meta)||void 0===b?void 0:b.size)})))(a.meta||(a.meta={})).size=b;return a}function xa(a){return{size:0<=a&&256>a?1:2}};var Ba;(function(a){a.merge=function(a,c){const b=Object.assign({},a,c);a=[...a.free||[],...c.free||[]];a.length&&(b.free=a);return b}})(Ba||(Ba={}));class Ca{constructor(a,b,c,d,e){this.line=a;this.column=b;this.prefix=c;this.remainder=d;this.match=e}}
class Da{constructor(a,b=0,c=0){this.content=a;this.line=b;this.column=c;this.prefix="";this.remainder=a}advance(a){const b=this.remainder.substring(0,a.length);if(a!==b)throw Error(`Non-rooted token: '${a}' vs '${b}'`);this.prefix+=a;this.remainder=this.remainder.substring(a.length);a=a.split(/(\r\n|\n|\r)/g);1<a.length&&(this.line+=a.length-1,this.column=0);this.column+=a[a.length-1].length}saveState(){return new Ca(this.line,this.column,this.prefix,this.remainder,this.lastMatch)}restoreState(a){this.line=
a.line;this.column=a.column;this.prefix=a.prefix;this.remainder=a.remainder;this.lastMatch=a.match}skip(a){a=a.exec(this.remainder);if(!a)return!1;this.advance(a[0]);return!0}space(){return this.skip(/^[ \t]+/)}newline(){return this.skip(/^(\r\n|\n|\r)/)}lookingAt(a){return"string"===typeof a?this.remainder.startsWith(a):a.test(this.remainder)}token(a){if("string"===typeof a){if(!this.remainder.startsWith(a))return!1;a=[a]}else a=a.exec(this.remainder);if(!a)return!1;a.line=this.line;a.column=this.column;
this.lastMatch=a;this.advance(a[0]);return!0}lookBehind(a){if("string"===typeof a)return this.prefix.endsWith(a);a=a.exec(this.prefix);if(!a)return!1;a.line=this.line;a.column=this.line;this.lastMatch=a;return!0}match(){return this.lastMatch}group(a=0){var b;return null===(b=this.lastMatch)||void 0===b?void 0:b[a]}eof(){return!this.remainder}};class Ea{constructor(a,b="input.s",c={}){this.file=b;this.opts=c;this.buffer=new Da(a)}next(){for(var a=this.token();m.eq(a,m.EOL);)a=this.token();var b=[[]];let c=0;for(;!m.eq(a,m.EOL)&&!m.eq(a,m.EOF);){if(m.eq(a,m.LC))b[c++].push(a),b.push([]);else if(m.eq(a,m.RC)){if(!c)throw Error(`Missing open curly: ${m.nameAt(a)}`);var d=b.pop();a=b[--c].pop().source;d={token:"grp",inner:d};a&&(d.source=a);b[c].push(d)}else b[c].push(a);a=this.token()}if(c)throw b=b[c-1].pop(),Error(`Missing close curly: ${m.nameAt(b)}`);
return b[0].length?b[0]:void 0}token(){for(;this.buffer.space()||this.buffer.token(/^;.*/)||this.opts.lineContinuations&&this.buffer.token(/^\\(\r\n|\n|\r)/););if(this.buffer.eof())return m.EOF;var a={file:this.file,line:this.buffer.line,column:this.buffer.column};try{const b=this.tokenInternal();this.opts.skipSourceAnnotations||(b.source=a);return b}catch(b){const {file:c,line:d,column:e}=a;a=(a=this.buffer.group())?` near '${a}'`:"";b.message+=`\n  at ${c}:${d}:${e}${a}`;throw b;}}tokenInternal(){if(this.buffer.newline())return{token:"eol"};
if(this.buffer.token(/^@+[a-z0-9_]*/i)||this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i))return this.strTok("ident");if(this.buffer.token(/^\.[a-z]+/i))return this.strTok("cs");if(this.buffer.token(/^:(\++|-+)/))return this.strTok("ident");if(this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/))return this.strTok("op");if(this.buffer.token("["))return{token:"lb"};if(this.buffer.token("{"))return{token:"lc"};if(this.buffer.token("("))return{token:"lp"};if(this.buffer.token("]"))return{token:"rb"};
if(this.buffer.token("}"))return{token:"rc"};if(this.buffer.token(")"))return{token:"rp"};if(this.buffer.token(/^["']/))return this.tokenizeStr();if(this.buffer.token(/^[$%]?[0-9a-z_]+/i))return this.tokenizeNum();throw Error("Syntax error");}tokenizeStr(){const a=this.buffer,b=a.match()[0];let c="";for(;!a.lookingAt(b);){if(a.eof())throw Error(`EOF while looking for ${b}`);a.token(/^\\u([0-9a-f]{4})/i)?c+=String.fromCodePoint(parseInt(a.group(1),16)):a.token(/^\\x([0-9a-f]{2})/i)?c+=String.fromCharCode(parseInt(a.group(1),
16)):a.token(/^\\(.)/)?c+=a.group(1):(a.token(/^./),c+=a.group(0))}a.token(b);return{token:"str",str:c}}strTok(a){return{token:a,str:this.buffer.group()}}tokenizeNum(a=this.buffer.group()){this.opts.numberSeparators&&(a=a.replace(/_/g,""));if("$"===a[0]){a=a.substring(1);if(!/^[0-9a-f]+$/i.test(a))throw Error(`Bad hex number: $${a}`);return{token:"num",num:Number.parseInt(a,16)}}if("%"===a[0]){a=a.substring(1);if(!/^[01]+$/.test(a))throw Error(`Bad binary number: %${a}`);return{token:"num",num:Number.parseInt(a,
2)}}if("0"===a[0]){if(!/^[0-7]+$/.test(a))throw Error(`Bad octal number: ${a}`);return{token:"num",num:Number.parseInt(a,8)}}if(!/^[0-9]+$/.test(a))throw Error(`Bad decimal number: ${a}`);return{token:"num",num:Number.parseInt(a,10)}}};class Fa{constructor(){this.symbols=new Map}pickScope(a){return[a,this]}resolve(a,b){const [c,d]=this.pickScope(a);let e=d.symbols.get(c);if(e)return c!==a&&(e.scoped=!0),e;if(b)return b={},d.symbols.set(c,b),c!==a&&(b.scoped=!0),b}}
class Ga extends Fa{constructor(a,b){super();this.parent=a;this.kind=b;this.children=new Map;this.anonymousChildren=[];this.global=a?a.global:this}pickScope(a){var b=this;a=a.split(/::/g);const c=a.pop();for(let c=0;c<a.length;c++){if(!c&&!a[c]){b=b.global;continue}let d=b.children.get(a[c]);for(;!c&&b.parent&&!d;)d=(b=b.parent).children.get(a[c]);if(!d)throw b=a.slice(0,c+1).join("::"),Error(`Could not resolve scope ${b}`);b=d}return[c,b]}}
class Ia extends Fa{clear(){for(var a of this.symbols){const [b,c]=a;if(!c.expr)throw a=c.ref?m.at(c.ref):"",Error(`Cheap local label never defined: ${b}${a}`);}this.symbols.clear()}}
class Ja{constructor(a,b){a=void 0===a?oa.P02:a;b=void 0===b?{}:b;this.cpu=a;this.opts=b;this.segments=["code"];this.segmentData=new Map;this.segmentStack=[];this.symbols=[];this.globals=new Map;this.currentScope=new Ga;this.cheapLocals=new Ia;this.anonymousForward=[];this.anonymousReverse=[];this.relativeForward=[];this.relativeReverse=[];this.chunks=[];this._org=this._name=this._chunk=void 0;this._segmentPrefix=""}get chunk(){this.ensureChunk();return this._chunk}ensureChunk(){this._chunk||(this._chunk=
{segments:this.segments,data:[]},null!=this._org&&(this._chunk.org=this._org),this._name&&(this._chunk.name=this._name),this.chunks.push(this._chunk))}definedSymbol(a){let b=this.currentScope;const c=!a.includes("::");do{const c=b.resolve(a,!1);if(c)return!!c.expr}while(c&&(b=b.parent));return!1}constantSymbol(a){a=this.currentScope.resolve(a,!1);return!(!a||!a.expr||0>a.id)}referencedSymbol(a){return null!=this.currentScope.resolve(a,!1)}evaluate(a){var b;a=this.resolve(a);if("num"===a.op&&(null===
(b=a.meta)||void 0===b||!b.rel))return a.num}pc(){var a;const b=this.chunk.data.length,c={rel:!0,chunk:this.chunks.length-1};null!=(null===(a=this._chunk)||void 0===a?void 0:a.org)&&(c.org=this._chunk.org);return qa.evaluate({op:"num",num:b,meta:c})}resolve(a){return qa.traverse(a,(a,c)=>{for(;"sym"===a.op&&a.sym;)a=this.resolveSymbol(a.sym);return qa.evaluate(c(a))})}resolveSymbol(a){if("*"===a)return this.pc();if(/^:\++$/.test(a)){a=a.length-2;var b=this.anonymousForward[a];if(null!=b)return{op:"sym",
num:b};this.anonymousForward[a]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^\++$/.test(a)){b=this.relativeForward[a.length-1];if(null!=b)return{op:"sym",num:b};this.relativeForward[a.length-1]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^:-+$/.test(a))return b=this.anonymousReverse.length-a.length+1,0>b&&this.fail(`Bad anonymous backref: ${a}`),this.anonymousReverse[b];if(/^-+$/.test(a))return b=this.relativeReverse[a.length-1],null==
b&&this.fail(`Bad relative backref: ${a}`),b;a=(a.startsWith("@")?this.cheapLocals:this.currentScope).resolve(a,!0);if(a.expr)return a.expr;null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));return{op:"sym",num:a.id}}chunkData(a){return{org:this.chunks[a].org}}closeScopes(){function a(b){for(var c of b.children.values())a(c);for(const c of b.anonymousChildren)a(c);for(const a of b.symbols){const [d,f]=a;if(!f.expr&&null!=f.id&&b.parent){if(f.scoped)throw Error(`Symbol '${d}' undefined`);
if(c=b.parent.symbols.get(d))if(null!=c.id)f.expr={op:"sym",num:c.id};else if(c.expr)f.expr=c.expr;else throw Error(`Impossible: ${d}`);else b.parent.symbols.set(d,f)}}}this.cheapLocals.clear();if(this.currentScope.parent)throw Error("Scope never closed");a(this.currentScope);for(const a of this.globals){const [b,d]=a;{const a=this.currentScope.symbols.get(b);if("export"===d){if(null===a||void 0===a||!a.expr)throw Error(`Symbol '${b}' undefined`);null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));
a.export=b}else if("import"===d){if(a){if(a.expr)throw Error(`Already defined: ${b}`);a.expr={op:"im",sym:b}}}else ja(d)}}for(const a of this.currentScope.symbols){const [b,d]=a;if(!d.expr)throw Error(`Symbol '${b}' undefined`);}}module(){this.closeScopes();const a=[];for(var b of this.chunks)a.push(Object.assign({},b,{data:Uint8Array.from(b.data)}));b=[];for(var c of this.symbols){if(null==c.expr)throw Error("Symbol undefined");const a={expr:c.expr};null!=c.export&&(a.export=c.export);b.push(a)}c=
[...this.segmentData.values()];return{chunks:a,symbols:b,segments:c}}line(a){this._source=a[0].source;3>a.length&&m.eq(a[a.length-1],m.COLON)?this.label(a[0]):m.eq(a[1],m.ASSIGN)?this.assign(m.str(a[0]),this.parseExpr(a,2)):m.eq(a[1],m.SET)?this.set(m.str(a[0]),this.parseExpr(a,2)):"cs"===a[0].token?this.directive(a):this.instruction(a)}tokens(a){let b;for(;b=a.next();)this.line(b)}tokensAsync(a){const b=this;return l.asyncExecutePromiseGeneratorFunction(function*(){let c;for(;c=yield a.nextAsync();)b.line(c)})}directive(a){switch(m.str(a[0])){case ".org":return this.org(this.parseConst(a));
case ".reloc":return this.parseNoArgs(a),this.reloc();case ".assert":return this.assert(this.parseExpr(a));case ".segment":return this.segment(...this.parseSegmentList(a));case ".byte":return this.byte(...this.parseDataList(a,!0));case ".res":return this.res(...this.parseResArgs(a));case ".word":return this.word(...this.parseDataList(a));case ".free":return this.free(this.parseConst(a),a[0]);case ".segmentprefix":return this.segmentPrefix(this.parseStr(a));case ".import":return this.import(...this.parseIdentifierList(a));
case ".export":return this.export(...this.parseIdentifierList(a));case ".scope":return this.scope(this.parseOptionalIdentifier(a));case ".endscope":return this.parseNoArgs(a),this.endScope();case ".proc":return this.proc(this.parseRequiredIdentifier(a));case ".endproc":return this.parseNoArgs(a),this.endProc();case ".pushseg":return this.pushSeg(...this.parseSegmentList(a));case ".popseg":return this.parseNoArgs(a),this.popSeg();case ".move":return this.move(...this.parseMoveArgs(a))}this.fail(`Unknown directive: ${m.nameAt(a[0])}`)}label(a){let b;
const c=this.pc();if("string"===typeof a)var d=a;else d=m.str(b=a),a.source&&(c.source=a.source);":"===d?(this.anonymousReverse.push(c),d=this.anonymousForward.shift(),null!=d&&(this.symbols[d].expr=c)):/^\++$/.test(d)?(a=this.relativeForward[d.length-1],delete this.relativeForward[d.length-1],null!=a&&(this.symbols[a].expr=c)):/^-+$/.test(d)?this.relativeReverse[d.length-1]=c:(d.startsWith("@")||(this.cheapLocals.clear(),this.chunk.name||this.chunk.data.length||(this.chunk.name=d)),this.assignSymbol(d,
!1,c,b))}assign(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!1,b)}set(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!0,b)}assignSymbol(a,b,c,d){"number"===typeof c&&(c={op:"num",num:c});const e=a.startsWith("@")?this.cheapLocals:this.currentScope;let f=e.resolve(a,!b);if(f&&b!==0>f.id)this.fail(`Cannot change mutability of ${a}`,
d);else if(b&&"num"!=c.op)this.fail("Mutable set requires constant",d);else if(!f){if(!b)throw Error("impossible");e.symbols.set(a,f={id:-1})}else if(!b&&f.expr)throw b=f.expr.source?`\nOriginally defined${m.at(f.expr)}`:"",a=d?m.nameAt(d):a+(this._source?m.at({source:this._source}):""),Error(`Redefining symbol ${a}${b}`);f.expr=c}instruction(...a){var b;let c;1===a.length&&Array.isArray(a[0])?(a=a[0],c=m.expectIdentifier(a[0]).toLowerCase(),a=this.parseArg(a)):"string"===typeof a[1]?(c=a[0],a=new Ea(a[1]),
a=this.parseArg(a.next(),0)):([c,a]=a,a||(a=["imp"]),c=c.toLowerCase());const d=this.cpu.op(c),e=a[0];if("add"===e||"a,x"===e||"a,y"===e){const f=a[1],g=(null===(b=f.meta)||void 0===b?void 0:b.size)||2;if("add"===e&&1===g&&"zpg"in d)return this.opcode(d.zpg,1,f);if("add"===e&&"abs"in d)return this.opcode(d.abs,2,f);if("add"===e&&"rel"in d)return this.relative(d.rel,1,f);if("a,x"===e&&1===g&&"zpx"in d)return this.opcode(d.zpx,1,f);if("a,x"===e&&"abx"in d)return this.opcode(d.abx,2,f);if("a,y"===e&&
1===g&&"zpy"in d)return this.opcode(d.zpy,1,f);if("a,y"===e&&"aby"in d)return this.opcode(d.aby,2,f);this.fail(`Bad address mode ${e} for ${c}`)}if(e in d)return b=this.cpu.argLen(e),"rel"===e?this.relative(d[e],b,a[1]):this.opcode(d[e],b,a[1]);this.fail(`Bad address mode ${e} for ${c}`)}parseArg(a,b){b=void 0===b?1:b;if(a.length===b)return["imp"];const c=a[b];var d=a[b+1];if(a.length===b+1){if(m.isRegister(c,"a"))return["acc"]}else if(m.eq(c,m.IMMEDIATE))return["imm",qa.parseOnly(a,b+1)];if(m.eq(c,
m.COLON)&&a.length===b+2&&"op"===d.token&&/^[-+]+$/.test(d.str))return["add",{op:"sym",sym:":"+d.str}];if(a.length===b+1&&"op"===c.token&&/^[-+]+$/.test(c.str))return["add",{op:"sym",sym:c.str}];if(m.eq(c,m.LP)||this.opts.allowBrackets&&m.eq(c,m.LB)){d=m.findBalanced(a,b);0>d&&this.fail(`Unbalanced ${m.name(c)}`,c);const e=m.parseArgList(a,b+1,d);e.length||this.fail("Bad argument",c);const f=qa.parseOnly(e[0]);if(1===e.length){if(m.eq(a[d+1],m.COMMA)&&m.isRegister(a[d+2],"y"))return m.expectEol(a[d+
3]),["iny",f];m.expectEol(a[d+1]);return["ind",f]}if(2===e.length&&1===e[1].length&&m.isRegister(e[1][0],"x"))return["inx",f];this.fail("Bad argument",c)}a=m.parseArgList(a,b);a.length||this.fail("Bad arg",c);b=qa.parseOnly(a[0]);if(1===a.length)return["add",b];if(2===a.length&&1===a[1].length){if(m.isRegister(a[1][0],"x"))return["a,x",b];if(m.isRegister(a[1][0],"y"))return["a,y",b]}this.fail("Bad arg",c)}relative(a,b,c){var d;const e=this.chunk.data.length+b+1,f={rel:!0,chunk:this.chunks.length-
1};if(null===(d=this._chunk)||void 0===d?0:d.org)f.org=this._chunk.org;d={op:"-",args:[c,{op:"num",num:e,meta:f}]};c.source&&(d.source=c.source);this.opcode(a,b,d)}opcode(a,b,c){b&&(c=this.resolve(c));const {chunk:d}=this;d.data.push(a);b&&this.append(c,b);d.name||(d.name="Code")}append(a,b){var c;const {chunk:d}=this;a=this.resolve(a);let e=a.num;"num"!==a.op||(null===(c=a.meta)||void 0===c?0:c.rel)?(c=d.data.length,(d.subs||(d.subs=[])).push({offset:c,size:b,expr:a}),this.writeNumber(d.data,b)):
this.writeNumber(d.data,b,e)}org(a,b){this._org=a;this._chunk=void 0;this._name=b}reloc(a){this._chunk=this._org=void 0;this._name=a}segment(...a){this.segments=a.map(a=>"string"===typeof a?a:a.name);for(const b of a)"object"===typeof b&&(a=this.segmentData.get(b.name)||{name:b.name},this.segmentData.set(b.name,Ba.merge(a,b)));this._name=this._chunk=void 0}assert(a){a=this.resolve(a);var b=this.evaluate(a);if(null!=b){if(!b){b="";const c=this.chunk;null!=c.org&&(b=` (PC=$${(c.org+c.data.length).toString(16)})`);
this.fail(`Assertion failed${b}`,a)}}else({chunk:b}=this),(b.asserts||(b.asserts=[])).push(a)}byte(...a){const {chunk:b}=this;for(const d of a)if("number"===typeof d)this.writeNumber(b.data,1,d);else if("string"===typeof d){a=b.data;var c=d;for(let b=0;b<c.length;b++)a.push(c.charCodeAt(b))}else this.append(d,1)}res(a,b){a&&this.byte(...Array(a).fill(null!==b&&void 0!==b?b:0))}word(...a){const {chunk:b}=this;for(const c of a)"number"===typeof c?this.writeNumber(b.data,2,c):this.append(c,2)}free(a,
b){null==this._org&&this.fail(".free in .reloc mode",b);var c=1<this.segments.length?this.segments.filter(a=>{a=this.segmentData.get(a);return!a||null==a.memory||null==a.size||a.memory>this._org||a.memory+a.size<=this._org?!1:!0}):this.segments;1!==c.length?this.fail(`.free with non-unique segment: ${this.segments}`,b):0>a&&this.fail(`.free with negative size: ${a}`,b);this._chunk&&(this._org+=this._chunk.data.length);this._chunk=void 0;b=c[0];(c=this.segmentData.get(b))||this.segmentData.set(b,c=
{name:b});(c.free||(c.free=[])).push([this._org,this._org+a]);this._org+=a}segmentPrefix(a){this._segmentPrefix=a}import(...a){for(const b of a)this.globals.set(b,"import")}export(...a){for(const b of a)this.globals.set(b,"export")}scope(a){this.enterScope(a,"scope")}proc(a){this.label(a);this.enterScope(a,"proc")}enterScope(a,b){const c=a?this.currentScope.children.get(a):void 0;if(c){if(this.opts.reentrantScopes){this.currentScope=c;return}this.fail(`Cannot re-enter scope ${a}`)}b=new Ga(this.currentScope,
b);a?this.currentScope.children.set(a,b):this.currentScope.anonymousChildren.push(b);this.currentScope=b}endScope(){this.exitScope("scope")}endProc(){this.exitScope("proc")}exitScope(a){this.currentScope.kind===a&&this.currentScope.parent||this.fail(`.end${a} without .${a}`);this.currentScope=this.currentScope.parent}pushSeg(...a){this.segmentStack.push([this.segments,this._chunk]);this.segment(...a)}popSeg(){this.segmentStack.length||this.fail(".popseg without .pushseg");[this.segments,this._chunk]=
this.segmentStack.pop()}move(a,b){this.append({op:".move",args:[b],meta:{size:a}},a)}parseConst(a,b){b=this.evaluate(qa.parseOnly(a,void 0===b?1:b));if(null!=b)return b;this.fail("Expression is not constant",a[1])}parseNoArgs(a){m.expectEol(a[1])}parseExpr(a,b){return qa.parseOnly(a,void 0===b?1:b)}parseStr(a,b){b=void 0===b?1:b;const c=m.expectString(a[b]);m.expectEol(a[b+1],"a single string");return c}parseSegmentList(a,b){b=void 0===b?1:b;a.length<b+1&&this.fail("Expected a segment list",a[b-1]);
return m.parseArgList(a,1).map(a=>{var b=this._segmentPrefix+m.expectString(a[0]);if(1===a.length)return b;m.eq(a[1],m.COLON)||this.fail(`Expected comma or colon: ${m.name(a[1])}`,a[1]);b={name:b};a=m.parseAttrList(a,1);for(const c of a){const [a,d]=c;switch(a){case "bank":b.bank=this.parseConst(d,0);break;case "size":b.size=this.parseConst(d,0);break;case "off":b.offset=this.parseConst(d,0);break;case "mem":b.memory=this.parseConst(d,0);break;default:this.fail(`Unknown segment attr: ${a}`)}}return b})}parseResArgs(a){a=
this.parseDataList(a);2<a.length&&this.fail("Expected at most 2 args",a[2]);a.length||this.fail("Expected at least 1 arg");const b=this.evaluate(a[0]);null==b&&this.fail("Expected constant count");const c=a[1]&&this.evaluate(a[1]);a[1]&&null==c&&this.fail("Expected constant value");return[b,c]}parseDataList(a,b){b=void 0===b?!1:b;2>a.length&&this.fail("Expected a data list",a[0]);const c=[];for(const d of m.parseArgList(a,1))b&&1===d.length&&"str"===d[0].token?c.push(d[0].str):c.push(this.resolve(qa.parseOnly(d)));
return c}parseIdentifierList(a){2>a.length&&this.fail("Expected identifier(s)",a[0]);const b=[];for(const c of m.parseArgList(a,1))1===c.length&&"ident"===c[0].token||this.fail(`Expected identifier: ${m.name(c[0])}`,c[0]),b.push(m.str(c[0]));return b}parseOptionalIdentifier(a){var b=a[1];if(b)return b=m.expectIdentifier(b),m.expectEol(a[2]),b}parseRequiredIdentifier(a){const b=m.expectIdentifier(a[1]);m.expectEol(a[2]);return b}parseMoveArgs(a){var b;a=m.parseArgList(a,1);2!==a.length&&this.fail("Expected constant number, then identifier");
const c=this.evaluate(qa.parseOnly(a[0]));null==c&&this.fail("Expected a constant number");const d=this.resolve(qa.parseOnly(a[1]));if("num"===d.op&&null!=(null===(b=d.meta)||void 0===b?void 0:b.chunk))return[c,d];this.fail("Expected a constant offset",a[1][0])}fail(a,b){var c;if(null===b||void 0===b?0:b.source)throw Error(a+m.at(b));if(!this._source&&(null===(c=this._chunk)||void 0===c?0:c.name))throw Error(a+`\n  in ${this._chunk.name}`);throw Error(a+m.at({source:this._source}));}writeNumber(a,
b,c){var d=b<<3;null!=c&&(c<-1<<d||c>=1<<d)&&this.fail(`Not a ${["byte","word","farword","dword"][b-1]}: $${c.toString(16)}`);for(d=0;d<b;d++)a.push(null!=c?c&255:255),null!=c&&(c>>=8)}};function Ka(a,b){if(!a)return-1;var c=b(0),d=b(a-1);if(0>c)return-1;if(0===c)return 0;if(0<d)return~a;if(0===d)return a-1;c=0;for(--a;1<a-c;){d=c+a>>1;const e=b(d);if(0<e)c=d;else if(0>e)a=d;else return d}return~a}function La(a,b,c){const d=b(c),e=Ka(a.length,c=>d<b(a[c])?-1:1);a.splice(~e,0,c)}
class Ma{constructor(){this._chunks=[];this._length=0}get length(){return this._length}_find(a){return Ka(this._chunks.length,b=>{const [c,d]=this._chunks[b];return a<c?-1:a>=c+d.length?1:0})}apply(a){if(a.length<this._length)throw Error("Target too small.");for(const [b,c]of this._chunks)for(let d=0;d<c.length;d++)a[b+d]=c[d]}chunks(){return this._chunks}get(a){let b=this._find(a);if(!(0>b)){var [c,d]=this._chunks[b];return d[a-c]}}set(a,...b){this.setInternal(a,b)}setInternal(a,b){var c;if(b.length){var d=
a+b.length;this._length=Math.max(this._length,d);var e=this._find(a),f=this._find(d);if(0<=e&&e===f){const [c,d]=this._chunks[e];for(f=0;f<b.length;f++)d[a+f-c]=b[f]}else{var g=this._chunks[~e-1];g&&g[0]+g[1].length===a&&(e=~e-1);(null===(c=this._chunks[~f])||void 0===c?void 0:c[0])===d&&(f=~f);if(0<=e){const [d,k]=this._chunks[e];f===e&&Array.isArray(b)?b.unshift(...k.slice(0,a-d)):(c=k,a-=d,g=c.length,b.length<g||!Array.isArray(b)?(c.splice(a,g-a,...b),b=c):b.unshift(...Na(c,a)));a=d}if(0<=f){const [a,
e]=this._chunks[f];d-=a;c=e;b.length<c.length||!Array.isArray(b)?(c.splice(0,d,...b),b=c):b.push(...Oa(c,d))}e=0>e?~e:e;d=0>f?~f:f;0<=f&&d++;Array.isArray(b)||(b=Array.from(b));this._chunks.splice(e,d-e,[a,b])}}}splice(a,b=1){const c=a+b;var d=this._find(a);b=this._find(c);var e=0<=d?this._chunks[d]:void 0;let f=0<=b?this._chunks[b]:void 0;e&&((a-=e[0])?e=[e[0],e===f?e[1].slice(0,a):Na(e[1],a)]:(e=void 0,d=~d));f&&(f=[c,Oa(f[1],c-f[0])],f[1].length||(f=void 0,b=~b));a=[];e&&a.push(e);f&&a.push(f);
d=0>d?~d:d;e=0>b?~b:b;0<=b&&e++;this._chunks.splice(d,e-d,...a)}slice(a,b){if(b<=a)return[];const c=this._find(a);if(0>c)throw Error(`Absent: ${a}`);const [d,e]=this._chunks[c];if(d+e.length<b)throw Error(`Absent: ${d+e.length}`);return e.slice(a-d,b-d)}}
class Qa extends Ma{set(a,...b){this.setInternal(a,b[0]instanceof Uint8Array?b[0]:Uint8Array.from(b))}search(a,b,c){return this.pattern(a).search(b,c)}pattern(a){function b(b){for(let c=b,e=0;c<d;++c,++e)if(a[c]!==a[e])return!1;return!0}function c(b){let c=0;for(let e=b,f=d-1;0<=e&&a[e]===a[f];--e,--f)++c;return c}if(!a.length)return{search:(a=0)=>a};const d=a.length,e=Array(256).fill(d);for(var f=0;f<a.length;f++)e[a[f]]=d-1-f;const g=[];f=d;for(let a=d;0<a;--a){b(a)&&(f=a);g[d-a]=f-a+d;for(let a=
0;a<d-1;++a){const b=c(a);g[b]=d-1-a+b}}return{search:(b=0,c=this._length)=>{if(!this._chunks.length||c<b)return-1;let f=this._find(b),h=0;for(0<=f?h=b-this._chunks[f][0]:f=~f;f<this._chunks.length;){const [k,p]=this._chunks[f++];b=Math.min(c-k,p.length);if(0>b)break;for(let c=d-1+h,f;c<b;){for(f=d-1;a[f]===p[c];--c,--f)if(0===f)return c+k;c+=Math.max(g[d-1-f],e[p[c]])}h=0}return-1}}}addOffset(a){const b=new Qa;for(const [c,d]of this._chunks)b._chunks.push([c+a,d]);return b}toIpsPatch(){var a=8;for(var [,
b]of this._chunks)a+=5+b.length;a=new Uint8Array(a);b=5;a[0]=80;a[1]=65;a[2]=84;a[3]=67;a[4]=72;for(const [c,d]of this._chunks){if(65535<d.length)throw Error("Oops!");a[b++]=c>>>16;a[b++]=c>>>8&255;a[b++]=c&255;a[b++]=d.length>>>8;a[b++]=d.length&255;a.subarray(b,b+d.length).set(d);b+=d.length}a[b]=69;a[b+1]=79;a[b+2]=70;return a}toIpsHexString(){const a=[...this.toIpsPatch()],b=[];for(let c=0;c<a.length;c+=16)b.push([c.toString(16).padStart(8,"0")+":",...a.slice(c,c+16).map(a=>a.toString(16).padStart(2,
"0"))].join(" "));return b.join("\n")}}function Na(a,b){const c=a.length;if(b<<1<c)return a.slice(0,b);a.splice(b,c-b);return a}function Oa(a,b){return b<<1<a.length?(a.splice(0,b),a):a.slice(b)}
class Ra{constructor(){this.data=[]}[Symbol.iterator](){return this.data[Symbol.iterator]()}_find(a){return Ka(this.data.length,b=>{b=this.data[b];return a<b[0]?-1:a>=b[1]?1:0})}has(a){return 0<=this._find(a)}add(a,b){var c,d,e=this._find(a);let f=this._find(b);(null===(c=this.data[~e-1])||void 0===c?void 0:c[1])===a&&(e=~e-1);(null===(d=this.data[~f])||void 0===d?void 0:d[0])===b&&(f=~f);a=[a,b];0<=e&&(a[0]=this.data[e][0]);0<=f&&(a[1]=this.data[f][1]);e=0>e?~e:e;b=0>f?~f:f;0<=f&&b++;this.data.splice(e,
b-e,a)}delete(a,b){var c=this._find(a);let d=this._find(b);var e=0<=c?this.data[c]:void 0;let f=0<=d?this.data[d]:void 0;e&&(e=[e[0],Math.min(e[1],a)],e[0]===e[1]&&(e=void 0,c=~c));f&&(f=[Math.max(f[0],b),f[1]],f[0]===f[1]&&(f=void 0,d=~d));a=[];e&&a.push(e);f&&a.push(f);c=0>c?~c:c;e=0>d?~d:d;0<=d&&e++;this.data.splice(c,e-c,...a)}tail(a){let b=this._find(a);0>b&&(b=~b);const c=this.data;return{[Symbol.iterator](){return this},next(){if(b>=c.length)return{value:void 0,done:!0};const d=c[b++];return{value:[Math.max(a,
d[0]),d[1]],done:!1}}}}};class Sa{constructor(){this._link=new Va}static link(...a){const b=new Sa;for(const c of a)b.read(c);return b.link()}read(a){this._link.readFile(a);return this}base(a,b){this._link.base(a,void 0===b?0:b);return this}link(){return this._link.link()}report(a){console.log(this._link.report(void 0===a?!1:a))}exports(){return this._exports?this._exports:this._exports=this._link.buildExports()}watch(...a){this._link.watches.push(...a)}}function Wa(a){throw Error(a);}
class Ya{constructor(a){var b,c,d,e,f;const g=this.name=a.name;this.bank=null!==(b=a.bank)&&void 0!==b?b:0;this.addressing=null!==(c=a.addressing)&&void 0!==c?c:2;this.size=null!==(d=a.size)&&void 0!==d?d:Wa(`Size must be specified: ${g}`);this.offset=null!==(e=a.offset)&&void 0!==e?e:Wa(`OFfset must be specified: ${g}`);this.memory=null!==(f=a.memory)&&void 0!==f?f:Wa(`OFfset must be specified: ${g}`)}get delta(){return this.offset-this.memory}}
class Za{constructor(a,b,c,d,e){this.linker=a;this.index=b;this.subs=new Set;this.selfSubs=new Set;this.deps=new Set;this.imports=new Set;this.follow=new Map;this.overlaps=!1;this.name=c.name;this.size=c.data.length;this.segments=c.segments;this._data=c.data;for(const a of c.subs||[])this.subs.add($a(a,d,e));this.asserts=(c.asserts||[]).map(a=>ab(a,d,e));c.org&&(this._org=c.org)}get org(){return this._org}get offset(){return this._offset}get segment(){return this._segment}get data(){var a;return null!==
(a=this._data)&&void 0!==a?a:Wa("no data")}initialPlacement(){if(null!=this._org){var a=[];for(const b of this.segments){const c=this.linker.segments.get(b);if(!c)throw Error(`Unknown segment: ${b}`);this._org>=c.memory&&this._org<c.memory+c.size&&a.push(c)}if(1!==a.length)throw Error(`Non-unique segment: [${a}]`);a=a[0];if(this._org>=a.memory+a.size)throw Error(`Chunk does not fit in segment ${a.name}`);this.place(this._org,a)}}place(a,b){var c;this._org=a;this._segment=b;a=this._offset=a+b.delta;
for(var d of this.linker.watches)if(d>=a&&d<a+this.size)debugger;La(this.linker.placed,a=>a[0],[a,this]);d=this.linker.data;b=null!==(c=this._data)&&void 0!==c?c:Wa("No data");this._data=void 0;if(this.subs.size){d.splice(a,b.length);c=new Qa;c.set(0,b);for(const a of this.subs)c.splice(a.offset,a.size);for(const b of c.chunks()){const [c,e]=b;d.set(a+c,...e)}}else d.set(a,b);for(const a of this.follow){const [b,c]=a;c.resolveSub(b,!1)}this.linker.free.delete(this.offset,this.offset+this.size)}resolveSubs(a){a=
void 0===a?!1:a;for(const b of this.selfSubs)this.resolveSub(b,a);for(const b of this.subs)this.resolveSub(b,a)}addDep(a,b){b===this.index&&this.subs.delete(a)&&this.selfSubs.add(a);this.linker.chunks[b].follow.set(a,this);this.deps.add(b)}resolveSub(a,b){var c,d;if(this.subs.has(a)||this.selfSubs.has(a)){a.expr=qa.traverse(a.expr,(c,d,e)=>{var f;if(b&&"^"===(null===e||void 0===e?void 0:e.op)&&1===e.args.length&&c.meta)return null==c.meta.bank&&this.addDep(a,c.meta.chunk),c;c=this.linker.resolveLink(qa.evaluate(d(c)));
b&&(null===(f=c.meta)||void 0===f?0:f.rel)&&this.addDep(a,c.meta.chunk);return c});var e=!1;if("num"===a.expr.op&&(null===(c=a.expr.meta)||void 0===c||!c.rel))this.writeValue(a.offset,a.expr.num,a.size),e=!0;else if(".move"===a.expr.op){if(1!==a.expr.args.length)throw Error("bad .move");c=a.expr.args[0];"num"===c.op&&null!=(null===(d=c.meta)||void 0===d?void 0:d.offset)&&(d=c.num+(c.meta.offset-(c.meta.rel?0:c.meta.org)),d=this.linker.orig.slice(d,d+a.size),this.writeBytes(a.offset,Uint8Array.from(d)),
e=!0)}e&&(this.subs.delete(a)||this.selfSubs.delete(a),this.subs.size||this.linker.unresolvedChunks.delete(this)&&this.linker.insertResolved(this))}}writeBytes(a,b){if(this._data)this._data.subarray(a,a+b.length).set(b);else if(null!=this._offset)this.linker.data.set(this._offset+a,b);else throw Error("Impossible");}writeValue(a,b,c){var d=c<<3;if(null!=b&&(b<-1<<d||b>=1<<d))throw Error(`Not a ${["byte","word","farword","dword"][c-1]}: $${b.toString(16)} at $${(this.org+a).toString(16)}`);d=new Uint8Array(c);
for(let a=0;a<c;a++)d[a]=b&255,b>>=8;this.writeBytes(a,d)}}function $a(a,b,c){a=Object.assign({},a);a.expr=ab(a.expr,b,c);return a}function ab(a,b,c){var d;a=Object.assign({},a);a.meta&&(a.meta=Object.assign({},a.meta));a.args&&(a.args=a.args.map(a=>ab(a,b,c)));null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(a.meta.chunk+=b);"sym"===a.op&&null!=a.num&&(a.num+=c);return a}function bb(a,b,c){a=Object.assign({},a);a.expr&&(a.expr=ab(a.expr,b,c));return a}
class Va{constructor(){this.data=new Qa;this.orig=new Qa;this.exports=new Map;this.chunks=[];this.symbols=[];this.free=new Ra;this.rawSegments=new Map;this.segments=new Map;this.resolvedChunks=[];this.unresolvedChunks=new Set;this.watches=[];this.placed=[];this.initialReport=""}insertResolved(a){La(this.resolvedChunks,a=>a.size,a)}base(a,b){b=void 0===b?0:b;this.data.set(b,a);this.orig.set(b,a)}readFile(a){const b=this.chunks.length,c=this.symbols.length;for(var d of a.segments||[])this.addRawSegment(d);
for(const e of a.chunks||[])d=new Za(this,this.chunks.length,e,b,c),this.chunks.push(d);for(const d of a.symbols||[])this.symbols.push(bb(d,b,c))}resolveLink(a){var b,c,d;if(".orig"===a.op&&1===(null===(b=a.args)||void 0===b?void 0:b.length)){var e=a.args[0];var f=null===(c=e.meta)||void 0===c?void 0:c.offset;if(null!=f&&(e=this.orig.get(f+e.num),null!=e))return{op:"num",num:e}}else"num"===a.op&&null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(c=a.meta,b=this.chunks[c.chunk],b.org!==c.org||
(null===(f=b.segment)||void 0===f?void 0:f.bank)!==c.bank||b.offset!==c.offset)&&(f={org:b.org,offset:b.offset,bank:null===(e=b.segment)||void 0===e?void 0:e.bank},a=qa.evaluate(Object.assign({},a,{meta:Object.assign({},c,f)})));return a}resolveExpr(a){var b;a=qa.traverse(a,(a,b)=>this.resolveLink(qa.evaluate(b(a))));if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=m.at(a);throw Error(`Unable to fully resolve expr${a}`);}link(){for(var a of this.rawSegments){const [c,d]=a;var b=
d[0];for(let a=1;a<d.length;a++)b=Ba.merge(b,d[a]);this.segments.set(c,new Ya(b))}for(var c of this.rawSegments){const [e,f]=c;a=this.segments.get(e);for(var d of f){b=d.free;for(const c of b||[]){const [b,d]=c;this.free.add(b+a.delta,d+a.delta);this.data.splice(b+a.delta,d-b)}}}for(const a of this.chunks)a.initialPlacement();for(c=0;c<this.symbols.length;c++){d=this.symbols[c];if(!d.expr)throw Error(`Symbol ${c} never resolved`);null!=d.export&&this.exports.set(d.export,c)}for(var e of this.symbols)e.expr=
this.resolveSymbols(e.expr);for(var f of this.chunks){for(const a of[...f.subs,...f.selfSubs])a.expr=this.resolveSymbols(a.expr);for(e=0;e<f.asserts.length;e++)f.asserts[e]=this.resolveSymbols(f.asserts[e])}for(const a of this.chunks)a.resolveSubs(!0);f=[...this.chunks];f.sort((a,b)=>b.size-a.size);for(var g of f)g.resolveSubs(),g.subs.size?this.unresolvedChunks.add(g):this.insertResolved(g);for(g=this.resolvedChunks.length+2*this.unresolvedChunks.size;g;){if(f=this.resolvedChunks.pop())this.placeChunk(f);
else{[f]=this.unresolvedChunks;for(var h of f.deps)f=this.chunks[h],null==f.org&&this.placeChunk(f)}f=this.resolvedChunks.length+2*this.unresolvedChunks.size;if(f===g)throw console.error(this.resolvedChunks,this.unresolvedChunks),Error("Not making progress");g=f}h=new Qa;for(var k of this.chunks){for(const a of k.asserts)if(!this.resolveExpr(a))throw k=m.at(a),Error(`Assertion failed${k}`);k.overlaps||h.set(k.offset,...this.data.slice(k.offset,k.offset+k.size))}return h}placeChunk(a){if(null==a.org){var b=
a.size;if(!a.subs.size&&!a.selfSubs.size){var c=this.data.pattern(a.data);for(var d of a.segments){var e=this.segments.get(d),f=e.offset;f=c.search(f,f+e.size);if(!(0>f)){a.place(f-e.delta,e);a.overlaps=!0;return}}}for(var g of a.segments){c=this.segments.get(g);f=c.offset;d=f+c.size;let h;e=Infinity;for(const a of this.free.tail(f)){const [c,g]=a;if(c>=d)break;f=Math.min(g,d)-c;!(f<b)&&f<e&&(h=c,e=f)}if(null!=h){a.place(h-c.delta,c);return}}console.log(`After filling:\n${this.report(!0)}`);g=a.name?
`${a.name} `:"";console.log(this.segments.get(a.segments[0]));throw Error(`Could not find space for ${b}-byte chunk ${g}in ${a.segments.join(", ")}`);}}resolveSymbols(a){return qa.traverse(a,(b,c)=>{for(;"im"===b.op||"sym"===b.op;)if("im"===b.op){b=b.sym;const d=this.exports.get(b);if(null==d)throw c=m.at(a),Error(`Symbol never exported ${b}${c}`);b=this.symbols[d].expr}else{if(null==b.num)throw Error("Symbol not global");b=this.symbols[b.num].expr}return qa.evaluate(c(b))})}addRawSegment(a){let b=
this.rawSegments.get(a.name);b||this.rawSegments.set(a.name,b=[]);b.push(a)}buildExports(){var a,b;const c=new Map;for(const d of this.symbols){if(!d.export)continue;const e=qa.traverse(d.expr,(a,b)=>this.resolveLink(qa.evaluate(b(a))));if("num"!==e.op)throw Error(`never resolved: ${d.export}`);const f=e.num,g={value:f};null!=(null===(a=e.meta)||void 0===a?void 0:a.offset)&&null!=e.meta.org&&(g.offset=e.meta.offset+f-e.meta.org);null!=(null===(b=e.meta)||void 0===b?void 0:b.bank)&&(g.bank=e.meta.bank);
c.set(d.export,g)}return c}report(a){a=void 0===a?!1:a;var b;let c="";for(var d of this.free){const [a,b]=d;c+=`Free: ${a.toString(16)}..${b.toString(16)}: ${b-a} bytes\n`}if(a)for(const e of this.placed){const [f,g]=e;a=null!==(b=g.name)&&void 0!==b?b:`Chunk ${g.index}`;d=g.offset+g.size;c+=`${f.toString(16).padStart(5,"0")} .. ${d.toString(16).padStart(5,"0")}: ${a} (${d-f} bytes)\n`}return c}};new WeakMap;function cb(a){throw Error(a);};const db="function"===typeof BigInt&&"bigint"===typeof BigInt(0);db&&BigInt(0);db&&BigInt(1);db&&BigInt(4294967295);db&&BigInt(32);const eb=()=>"",fb=a=>!0===a?!1:a;class mb{constructor(a,b){this.flag=a;this.opts=b;mb.flags.set(a,this)}static all(){return[...this.flags.values()]}}mb.flags=new Map;
class nb{constructor(a,b,c,d){this.name=b;this.description=c;this.flags=d.map(a=>a instanceof mb?[a,!0]:a);a.presets.set(b.toLowerCase().replace(/[^a-z]/g,""),this)}static all(){pb.instance||(pb.instance=new pb);return[...pb.instance.presets.values()]}get flagString(){null==this._flagString&&(this._flagString=String(new qb(`@${this.name}`)));return this._flagString}}
class pb{constructor(){this.presets=new Map;this.Casual=new nb(this,"Casual","\n      Basic flags for a relatively easy playthrough.  This is a good\n      place to start.",[n.PreserveUniqueChecks,n.NoShuffleMimics,n.DecreaseEnemyDamage,n.GuaranteeRefresh,n.GuaranteeStartingSword,n.ExperienceScalesFaster,n.NoCommunityJokes,r.NoThunderSwordWarp,rb.Shops,rb.Dyna,[rb.Maps,"!"],[rb.WildWarp,"!"],sb.SpoilerLog]);this.Classic=new nb(this,"Classic","\n      Provides a relatively quick playthough with a reasonable amount of\n      challenge.  Similar to older versions.",
[n.GuaranteeStartingSword,n.NoCommunityJokes,u.StatueGlitch,[r.NoThunderSwordWarp,"!"],[rb.Maps,"!"],sb.SpoilerLog]);this.Standard=new nb(this,"Standard","\n      Well-balanced, standard race flags.",[tb.RandomizeWeaknesses,r.StoryMode,sb.SpoilerLog]);this.NoBowMode=new nb(this,"No Bow Mode","\n      The tower is open from the start, as soon as you're ready for it.",[tb.RandomizeWeaknesses,tb.TowerRobots,ub.MaxScalingInTower,r.NoBowMode,sb.SpoilerLog]);this.Advanced=new nb(this,"Advanced","\n      A balanced randomization with quite a bit more difficulty.",
[u.GhettoFlight,u.MtSabreRequirementSkip,u.StatueGlitch,[u.SwordChargeGlitch,"!"],vb.Barrier,vb.BattleMagic,vb.GasMask,ub.MaxScalingInTower,tb.RandomizeWeaknesses,tb.TowerRobots,r.OrbsNotRequired,r.StoryMode,v.RandomizeMaps,v.ShuffleAreas,v.ShuffleHouses,v.RandomizeTrades,v.RandomizeWallElements,v.UnidentifiedKeyItems,sb.SpoilerLog]);this.WildWarp=new nb(this,"Wild Warp","\n      Significantly opens up the game right from the start with wild\n      warp in logic.",[n.GuaranteeRefresh,v.RandomizeWildWarp,
tb.RandomizeWeaknesses,tb.TowerRobots,r.OrbsNotRequired,r.StoryMode,sb.SpoilerLog]);this.Mystery=new nb(this,"Mystery","\n      Even the options are random.",[[v.ShuffleAreas,"?"],[v.ShuffleHouses,"?"],[v.RandomizeMaps,"?"],[v.RandomizeTrades,"?"],[v.UnidentifiedKeyItems,"?"],[v.RandomizeWallElements,"?"],[v.ShuffleGoaFloors,"?"],[v.RandomizeSpriteColors,"?"],[v.RandomizeWildWarp,"?"],[r.OrbsNotRequired,"?"],[r.NoBowMode,"?"],[r.StoryMode,"?"],[r.VanillaDolphin,"?"],[r.NoThunderSwordWarp,"?"],[u.RageSkip,
"?"],[u.TriggerSkip,"?"],[u.StatueGlitch,"?"],[u.GhettoFlight,"?"],[u.SwordChargeGlitch,"?"],[u.MtSabreRequirementSkip,"?"],[wb.RandomizeMusic,"?"],[wb.RandomizeMapColors,"?"],[tb.RandomizeWeaknesses,"?"],[tb.TowerRobots,"?"],[n.NoShuffleMimics,"?"],[n.PreserveUniqueChecks,"?"],[vb.Barrier,"?"],[vb.BattleMagic,"?"],[vb.GasMask,"?"],[rb.Dyna,"?"],[rb.BonusItems,"?"],[rb.Maps,"?"],sb.SpoilerLog]);this.Hardcore=new nb(this,"Hardcore","\n      Not for the faint of heart.  Good luck.",[vb.Barrier,vb.BattleMagic,
ub.ExperienceScalesSlower,ub.MaxScalingInTower,ub.Permadeath,r.OrbsNotRequired,r.StoryMode,v.RandomizeMaps,v.ShuffleAreas,v.ShuffleHouses,v.RandomizeTrades,v.RandomizeWallElements,v.UnidentifiedKeyItems]);this.FullStupid=new nb(this,"The Full Stupid","\n      Only a few noble fools have ever completed this.  Be sure to record this\n      because pics or it didn't happen.",[vb.Barrier,vb.BattleMagic,ub.Blackout,ub.ExperienceScalesSlower,ub.MaxScalingInTower,ub.Permadeath,tb.RandomizeWeaknesses,tb.TowerRobots,
r.OrbsNotRequired,r.StoryMode,v.RandomizeMaps,v.ShuffleAreas,v.ShuffleHouses,v.RandomizeTrades,v.RandomizeWallElements,v.ShuffleGoaFloors,v.UnidentifiedKeyItems]);this.Tournament2022Early=new nb(this,"Tournament 2022 Early Rounds","\n      Lots of potential complexity, but within reason.  Requires all swords and\n      bosses, as well as a few glitches, but guarantees a starting sword.",[n.GuaranteeStartingSword,u.StatueGlitch,u.StatueGauntletSkip,[tb.RandomizeWeaknesses,"?"],r.OrbsNotRequired,r.StoryMode,
[r.VanillaDolphin,"?"],[r.NoThunderSwordWarp,"?"],[v.RandomizeWallElements,"?"],[v.ShuffleGoaFloors,"?"],[v.RandomizeSpriteColors,"?"],[v.RandomizeTrades,"?"],[v.UnidentifiedKeyItems,"?"]]);this.Tournament2022Mid=new nb(this,"Tournament 2022 Mid Rounds","\n      Some additional challenges compared to the early rounds: some additional\n      mystery flags and glitches, as well as max difficulty scaling in the\n      tower.",[[n.GuaranteeStartingSword,"?"],[u.GhettoFlight,"?"],[u.StatueGlitch,"?"],
[u.MtSabreRequirementSkip,"?"],[u.StatueGauntletSkip,"?"],ub.MaxScalingInTower,[ub.NoBuffMedicalHerb,"?"],[tb.RandomizeWeaknesses,"?"],[tb.TowerRobots,"?"],[vb.Barrier,"?"],[vb.BattleMagic,"?"],r.StoryMode,[r.VanillaDolphin,"?"],[r.OrbsNotRequired,"?"],[r.NoThunderSwordWarp,"?"],[v.RandomizeWallElements,"?"],[v.ShuffleGoaFloors,"?"],[v.RandomizeSpriteColors,"?"],[v.RandomizeTrades,"?"],[v.UnidentifiedKeyItems,"?"]]);this.Tournament2022Finals=new nb(this,"Tournament 2022 Finals Round","\n      Many of the more difficult mystery flags from the mid rounds are now\n      always on, plus entrance shuffle.",
[[n.GuaranteeStartingSword,"?"],u.GhettoFlight,u.StatueGlitch,u.MtSabreRequirementSkip,u.StatueGauntletSkip,ub.NoBuffMedicalHerb,ub.MaxScalingInTower,[tb.RandomizeWeaknesses,"?"],[tb.TowerRobots,"?"],vb.Barrier,vb.BattleMagic,r.StoryMode,[r.VanillaDolphin,"?"],[r.OrbsNotRequired,"?"],[r.NoThunderSwordWarp,"?"],v.ShuffleHouses,[v.RandomizeWallElements,"?"],[v.ShuffleGoaFloors,"?"],[v.RandomizeSpriteColors,"?"],[v.RandomizeTrades,"?"],[v.UnidentifiedKeyItems,"?"]])}static get(a){this.instance||(this.instance=
new pb);return this.instance.presets.get(a.toLowerCase().replace(/[^a-z]/g,""))}}class zb{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(a,b){zb.sections.add(this.instance||(this.instance=new this));const c=new mb(a,b);if(!a.startsWith(this.instance.prefix))throw Error(`bad flag ${a} ${b}`);this.instance.flags.set(a,c);return c}}zb.sections=new Set;class v extends zb{constructor(){super(...arguments);this.prefix="W";this.name="World"}}
v.RandomizeMaps=v.flag("Wm",{name:"Randomize maps",text:"Individual maps are randomized.  For now this is only a subset of\n           possible maps.  A randomized map will have all the same features\n           (exits, chests, NPCs, etc) except things are moved around.",hard:!0});v.ShuffleAreas=v.flag("Wa",{name:"Shuffle areas",text:"Shuffles some or all area connections.",hard:!0});
v.ShuffleHouses=v.flag("Wh",{name:"Shuffle house entrances",text:"Shuffles all the house entrances, as well as a handful of other\n           things, like the palace/fortress-type entrances at the top of\n           several towns, and standalone houses.",hard:!0});
v.RandomizeTrades=v.flag("Wt",{name:"Randomize trade-in items",text:"Items expected by various NPCs will be shuffled: specifically,\n           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog\n           Lamp, and Flute of Lime (for Akahana).  Rage will expect a\n           random sword, and Tornel will expect a random bracelet.",hard:!0});
v.UnidentifiedKeyItems=v.flag("Wu",{name:"Unidentified key items",text:"Item names will be generic and effects will be shuffled.  This\n           includes keys, flutes, lamps, and statues.",hard:!0});v.RandomizeWallElements=v.flag("We",{name:"Randomize elements to break walls",text:'Walls will require a randomized element to break.  Normal rock and\n           ice walls will indicate the required element by the color (light\n           grey or yellow for wind, blue for fire, bright orange ("embers") for\n           water, or dark grey ("steel") for thunder.  The element to break\n           these walls is the same throughout an area.  Iron walls require a\n           one-off random element, with no visual cue, and two walls in the\n           same area may have different requirements.'});
v.ShuffleGoaFloors=v.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."});v.RandomizeSpriteColors=v.flag("Ws",{name:"Randomize sprite colors",text:"Monsters and NPCs will have different colors.  This is not an\n           optional flag because it affects what monsters can be grouped\n           together."});
v.RandomizeWildWarp=v.flag("Ww",{name:"Randomize wild warp",text:"Wild warp will go to Mezame Shrine and 15 other random locations.\n           These locations will be considered in-logic.",excludes:["Vw"]});class r extends zb{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}}r.StoryMode=r.flag("Rs",{name:"Story Mode",text:"Draygon 2 won't spawn unless you have all four swords and have\n           defeated all major bosses of the tetrarchy."});
r.NoBowMode=r.flag("Rb",{name:"No Bow mode",text:"No items are required to finish the game.  An exit is added from\n           Mezame shrine directly to the Draygon 2 fight (and the normal entrance\n           is removed).  Draygon 2 spawns automatically with no Bow of Truth."});r.OrbsNotRequired=r.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."});
r.NoThunderSwordWarp=r.flag("Rt",{name:"No Sword of Thunder warp",text:'Normally when acquiring the thunder sword, the player is instantly\n           warped to a random town.  This flag disables the warp.  If set as\n           "R!t", then the warp will always go to Shyron, like in vanilla.',modes:"!"});r.VanillaDolphin=r.flag("Rd",{name:"Vanilla Dolphin interactions",text:"By default, the randomizer changes a number of dolphin and boat\n           interactions: (1) healing the dolphin and having the Shell Flute\n           is no longer required before the fisherman spawns: instead, he\n           will spawn as soon as you have the item he wants; (2) talking to\n           Kensu in the beach cabin is no longer required for the Shell Flute\n           to work: instead, the Shell Flute will always work, and Kensu will\n           spawn after the Fog Lamp is turned in and will give a key item\n           check.  This flag restores the vanilla interaction where healing\n           and shell flute are required, and Kensu no longer drops an item."});
class u extends zb{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description="\n      By default, the randomizer disables all known glitches (except ghetto\n      flight).  These flags selectively re-enable certain glitches.  Most of\n      these flags have two modes: normally enabling a glitch will add it as\n      possibly required by logic, but clicking a second time will add a '!'\n      and enable the glitch outside of logic (e.g. \"G!c\")."}}
u.GhettoFlight=u.flag("Gf",{name:"Ghetto flight",text:"Ghetto flight allows using Dolphin and Rabbit Boots to fly up the\n           waterfalls in the Angry Sea (without calming the whirlpools).\n           This is done by swimming up to a diagonal beach and jumping\n           in a different direction immediately before disembarking."});
u.StatueGlitch=u.flag("Gs",{name:"Statue glitch",text:"Statue glitch allows getting behind statues that block certain\n           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,\n           as well as the statues in the Waterfall Cave.  It is done by\n           approaching the statue from the top right and holding down and\n           left on the controller while mashing B.",modes:"!"});
u.MtSabreRequirementSkip=u.flag("Gn",{name:"Mt Sabre requirements skip",text:"Entering Mt Sabre North normally requires (1) having Teleport,\n           and (2) talking to the rabbit in Leaf after the abduction (via\n           Telepathy).  Both of these requirements can be skipped: first by\n           flying over the river in Cordel plain rather than crossing the\n           bridge, and then by threading the needle between the hitboxes in\n           Mt Sabre North.",modes:"!"});
u.StatueGauntletSkip=u.flag("Gg",{name:"Statue gauntlet skip",text:"The shooting statues in front of Goa and Stxy normally require\n           Barrier to pass safely.  With this flag, Flight can also be used\n           by flying around the edge of the statue.",modes:"!"});
u.SwordChargeGlitch=u.flag("Gc",{name:"Sword charge glitch",text:"Sword charge glitch allows charging one sword to the level of\n           another sword by equipping the higher-level sword, re-entering\n           the menu, changing to the lower-level sword without exiting the\n           menu, creating a hard save, resetting, and then continuing.",hard:!0,modes:"!"});
u.TriggerSkip=u.flag("Gt",{name:"Trigger skip",text:"A wide variety of triggers and exit squares can be skipped by\n           using an invalid item every frame while walking.  This allows\n           bypassing both Mt Sabre North entrance triggers, the Evil Spirit\n           Island entrance trigger, triggers for guards to move, slopes,\n           damage tiles, and seamless map transitions.",hard:!0,modes:"!"});
u.RageSkip=u.flag("Gr",{name:"Rage skip",text:"Rage can be skipped by damage-boosting diagonally into the Lime\n           Tree Lake screen.  This provides access to the area beyond the\n           lake if flight or bridges are available.  For simplicity, the\n           logic only assumes this is possible if there's a flyer.",hard:!0,modes:"!"});
class wb extends zb{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description='\n      These flags don\'t directly affect gameplay or shuffling, but they do\n      affect the experience significantly enough that there are three modes\n      for each: "off", "optional" (no exclamation point), and "required"\n      (exclamation point).  The first two are equivalent for seed generation\n      purposes, so that you can play the same seed with either setting.\n      Setting it to "!" will change the seed.'}}
wb.RandomizeMusic=wb.flag("Am",{name:"Randomize background music",modes:"!",optional:fb});wb.NoMusic=wb.flag("As",{name:"No background music",optional:eb});wb.RandomizeMapColors=wb.flag("Ac",{name:"Randomize map colors",modes:"!",optional:fb});class tb extends zb{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}}tb.RandomizeWeaknesses=tb.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."});
tb.TowerRobots=tb.flag("Mt",{name:"Shuffle tower robots",text:"Tower robots will be shuffled into the normal pool.  At some\n           point, normal monsters may be shuffled into the tower as well.",hard:!0});class n extends zb{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description="\n      The following options make parts of the game easier."}}n.NoShuffleMimics=n.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."});
n.PreserveUniqueChecks=n.flag("Eu",{name:"Keep unique items and consumables separate",text:"Normally all items and mimics are shuffled into a single pool and\n           distributed from there.  If this flag is set, unique items\n           (specifically, anything that cannot be sold) will only be found in\n           either (a) checks that held unique items in vanilla, or (b) boss\n           drops.  Chests containing consumables in vanilla may be safely\n           ignored, but chests containing unique items in vanilla may still\n           end up with non-unique items because of bosses like Vampire 2 that\n           drop consumables.  If mimics are shuffled, they will only be in\n           consumable locations."});
n.DecreaseEnemyDamage=n.flag("Ed",{name:"Decrease enemy damage",text:"Enemy attack power will be significantly decreased in the early game\n           (by a factor of 3).  The gap will narrow in the mid-game and eventually\n           phase out at scaling level 40."});n.GuaranteeStartingSword=n.flag("Es",{name:"Guarantee starting sword",text:"The Leaf elder is guaranteed to give a sword.  It will not be\n           required to deal with any enemies before finding the first sword."});
n.GuaranteeRefresh=n.flag("Er",{name:"Guarantee refresh",text:"Guarantees the Refresh spell will be available before fighting\n           Tetrarchs."});n.ExperienceScalesFaster=n.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]});n.NoCommunityJokes=n.flag("Ec",{name:"No community jokes",text:"Skip community jokes, such as funny/misspelled item, monster, or\n           character names.  This will make it easier to look up information\n           in guides/FAQs if necessary."});
class vb extends zb{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description="\n      Removes various guarantees from the logic."}}vb.BattleMagic=vb.flag("Nw",{name:"Battle magic not guaranteed",text:"Normally, the logic will guarantee that level 3 sword charges are\n           available before fighting the tetrarchs (with the exception of Karmine,\n           who only requires level 2).  This disables that check.",hard:!0});
vb.MatchingSword=vb.flag("Ns",{name:'Matching sword not guaranteed ("Tink Mode")',text:'Enables "tink strats", where wrong-element swords will still do a\n           single damage per hit.  Player may be required to fight monsters\n           (including bosses) with tinks.',hard:!0});
vb.Barrier=vb.flag("Nb",{name:"Barrier not guaranteed",text:"Normally, the logic will guarantee Barrier (or else refresh and shield\n           ring) before entering Stxy, the Fortress, or fighting Karmine.  This\n           disables that check.",hard:!0});
vb.GasMask=vb.flag("Ng",{name:"Gas mask not guaranteed",text:"The logic will not guarantee gas mask before needing to enter the swamp,\n           nor will leather boots (or hazmat suit) be guaranteed to cross long\n           stretches of spikes.  Gas mask is still guaranteed to kill the insect.",hard:!0});class ub extends zb{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}}
ub.NoBuffMedicalHerb=ub.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:"Medical Herb is not buffed to heal 80 damage, which is helpful to make\n           up for cases where Refresh is unavailable early.  Fruit of Power is not\n           buffed to restore 56 MP.",hard:!0});ub.MaxScalingInTower=ub.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0});
ub.ExperienceScalesSlower=ub.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0});ub.ChargeShotsOnly=ub.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0});ub.Blackout=ub.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0});
ub.Permadeath=ub.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});class rb extends zb{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description="\n      Options to restore vanilla behavior changed by default."}}rb.Dyna=rb.flag("Vd",{name:"Don't buff Dyna",text:"By default, we makes the Dyna fight a bit more of a challenge.\n           Side pods will fire significantly more.  The safe spot has been\n           removed.  The revenge beams pass through barrier.  Side pods can\n           now be killed.  This flag prevents that change."});
rb.BonusItems=rb.flag("Vb",{name:"Don't buff bonus items",text:"Leather Boots are changed to Speed Boots, which increase player walking\n           speed (this allows climbing up the slope to access the Tornado Bracelet\n           chest, which is taken into consideration by the logic).  Deo's pendant\n           restores MP while moving.  Rabbit boots enable sword charging up to\n           level 2 while walking (level 3 still requires being stationary, so as\n           to prevent wasting tons of magic)."});
rb.Maps=rb.flag("Vm",{name:"Vanilla maps",text:'Normally the randomizer adds a new "East Cave" to Valley of Wind,\n           borrowed from the GBC version of the game.  This cave contains two\n           chests (one considered a key item) on the upper floor and exits to\n           two random areas (chosen between Lime Tree Valley, Cordel Plain,\n           Goa Valley, or Desert 2; the quicksand is removed from the entrances\n           to Pyramid and Crypt), one unblocked on the lower floor, and one\n           down the stairs and behind a rock wall from the upper floor.  This\n           flag prevents adding that cave.  If set as "V!m" then a direct path\n           will instead be added between Valley of Wind and Lime Tree Valley\n           (as in earlier versions of the randomizer).',
modes:"!"});rb.Shops=rb.flag("Vs",{name:"Vanilla shops",text:"By default, we disable shop glitch, shuffle shop contents, and tie\n           the prices to the scaling level (item shops and inns increase by a\n           factor of 2 every 10 scaling levels, armor shops decrease by a\n           factor of 2 every 12 scaling levels).  This flag prevents all of\n           these changes, restoring shops to be completely vanilla."});
rb.WildWarp=rb.flag("Vw",{name:"Vanilla wild warp",text:"By default, Wild Warp is nerfed to only return to Mezame Shrine.\n           This flag restores it to work like normal.  Note that this will put\n           all wild warp locations in logic unless the flag is set as (V!w).",modes:"!"});
rb.Hud=rb.flag("Vh",{name:"Vanilla HUD",text:"By default, the blue status bar (HUD) at the bottom of the screen\n           is reorganized a bit, including displaying enemies' names and HP.\n           This can be set either as Vh (which will optionally disable the\n           changes, and will produce the same seed as not setting Vh) or as\n           V!h (which requires all players to disable it to get the same\n            seed).",modes:"!",optional:fb});
class Bb extends zb{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description="\n      The following quality-of-life flags turn <i>off</i> improvements that\n      are normally on by default.  They are optional and will not affect the\n      seed generation.  They may be toggled freely in race mode."}}
Bb.NoAutoEquip=Bb.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:"Prevents adding a quality-of-life improvement to automatically equip\n           the corresponding orb/bracelet whenever changing swords.",optional:eb});
Bb.NoControllerShortcuts=Bb.flag("Qc",{name:"Disable controller shortcuts",text:"By default, we disable second controller input and instead enable\n           some new shortcuts on controller 1: Start+A+B for wild warp, and\n           Select+B to quickly change swords.  To support this, the action of\n           the start and select buttons is changed slightly.  This flag\n           disables this change and retains normal behavior.",optional:eb});
Bb.AudibleWallCues=Bb.flag("Qw",{name:"Audible wall cues",text:"Provide an audible cue when failing to break a non-iron wall.\n           The intended way to determine which sword is required for normal\n           cave walls is by looking at the color.  This causes the level 3\n           sword sound of the required element to play when the wall fails\n           to break.  Note that fortress walls (iron in vanilla) do not give\n           this hint, since there is no visual cue for them, either.",
optional:eb});class sb extends zb{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description="\n      These options are helpful for exploring or debugging.  Note that,\n      while they do not directly affect any randomization, they\n      <i>do</i> factor into the seed to prevent cheating, and they\n      will remove the option to generate a seed for racing."}}sb.SpoilerLog=sb.flag("Ds",{name:"Generate a spoiler log",text:"Note: <b>this will change the placement of items</b> compared to a\n           seed generated without this flag turned on."});
sb.TrainerMode=sb.flag("Dt",{name:"Trainer mode",text:"Installs a trainer for practicing certain parts of the game.\n           At the start of the game, the player will have all swords, basic\n           armors and shields, all worn items and magics, a selection of\n           consumables, bow of truth, maximum cash, all warp points activated,\n           and the Shyron massacre will have been triggered.  Wild warp is\n           reconfigured to provide easy access to all bosses.  Additionally,\n           the following button combinations are recognized:<ul>\n             <li>Start+Up: increase player level\n             <li>Start+Down: increase scaling level\n             <li>Start+Left: get all balls\n             <li>Start+Right: get all bracelets\n             <li>Start+B+Down: get a full set of consumable items\n             <li>Start+B+Left: get all advanced armors\n             <li>Start+B+Right: get all advanced shields\n           </ul>"});
sb.NeverDie=sb.flag("Di",{name:"Player never dies"});sb.NoShuffle=sb.flag("Dn",{name:"Do not shuffle items",text:"Items will not be shuffled. WARNING: This disables the logic and\n           is very likely to result in an unwinnable seed"});
class qb{constructor(a="@Casual"){if("string"!==typeof a){this.flags=new Map;for(const [b,c]of a)this.set(b.flag,c)}else if(a.startsWith("@")){var b=pb.get(a.substring(1));if(!b)throw new aa(`Unknown preset: ${a}`);this.flags=new Map(b.flags)}else{this.flags=new Map;a=a.replace(/[^A-Za-z0-9!?]/g,"");b=/([A-Z])([a-z0-9!?]+)/g;for(var c;c=b.exec(a);){const [,a,b]=c,f=/([!?]|^)([a-z0-9]+)/g;for(;c=f.exec(b);){const [,b,d]=c;for(const c of d)this.set(a+c,b||!0)}}}}filterOptional(){return new qb(new Map([...this.flags].map(([a,
b])=>[a,a.opts.optional?a.opts.optional(b):b])))}filterRandom(a){return new qb(new Map([...this.flags].map(([b,c])=>{c="?"!==c?c:a.pick([!0,!1,...b.opts.modes||""]);return[b,c]})))}toString(){var a=new ba(()=>new ba(()=>[]));for(const [b,d]of this.flags){if(2!==b.flag.length)throw Error(`Bad flag ${b.flag}`);d&&a.get(b.flag[0]).get(!0===d?"":d).push(b.flag[1])}const b=[];for(const [c,d]of a.sortedEntries()){a=c;for(const [b,c]of d.sortedEntries())a+=b+c.sort().join("");b.push(a)}return b.join(" ")}toggle(a){const b=
mb.flags.get(a);if(!b)return console.error(`Bad flag: ${a}`),!1;a=this.flags.get(b)||!1;const c=[!1,!0,...b.opts.modes||"","?",!1],d=c.indexOf(a);if(0>d)throw Error(`Bad current mode ${a}`);a=c[d+1];this.flags.set(b,a);return a}set(a,b){var c;const d=mb.flags.get(a);if(d){if(b)if(!0===b||"?"===b||(null===(c=d.opts.modes)||void 0===c?0:c.includes(b)))this.flags.set(d,b);else{console.error(`Bad flag mode: ${a[0]}${b}${a.substring(1)}`);return}else this.flags.delete(d);for(const a of d.opts.excludes||
[])this.flags.delete(mb.flags.get(a))}else console.error(`Bad flag: ${a}`)}check(a,...b){a=a instanceof mb?a:mb.flags.get(a);b.length||b.push(!0);return b.includes(a&&this.flags.get(a)||!1)}get(a){return(a=a instanceof mb?a:mb.flags.get(a))&&this.flags.get(a)||!1}preserveUniqueChecks(){return this.check(n.PreserveUniqueChecks)}shuffleMimics(){return this.check(n.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(rb.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(rb.BonusItems,!1)}slowDownTornado(){return this.check(rb.BonusItems,
!1)}leatherBootsGiveSpeed(){return this.check(rb.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(rb.BonusItems,!1)}shuffleSpritePalettes(){return this.check(v.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(rb.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(tb.TowerRobots)}shuffleMonsterElements(){return this.check(tb.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(ub.NoBuffMedicalHerb,
!1)}decreaseEnemyDamage(){return this.check(n.DecreaseEnemyDamage)}trainer(){return this.check(sb.TrainerMode)}neverDie(){return this.check(sb.NeverDie)}noShuffle(){return this.check(sb.NoShuffle)}chargeShotsOnly(){return this.check(ub.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(rb.Maps,"!")}addEastCave(){return this.check(rb.Maps,!1)}zebuStudentGivesItem(){return!this.shuffleAreas()&&!this.shuffleHouses()}fogLampNotRequired(){return this.check(r.VanillaDolphin,
!1)}storyMode(){return this.check(r.StoryMode)}noBowMode(){return this.check(r.NoBowMode)}requireHealedDolphinToRide(){return this.check(r.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(r.NoThunderSwordWarp,!1,"!")}randomizeThunderTeleport(){return this.check(r.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(r.OrbsNotRequired)}shuffleGoaFloors(){return this.check(v.ShuffleGoaFloors)}shuffleHouses(){return this.check(v.ShuffleHouses)}shuffleAreas(){return this.check(v.ShuffleAreas)}randomizeMaps(){return this.check(v.RandomizeMaps)}randomizeTrades(){return this.check(v.RandomizeTrades)}unidentifiedItems(){return this.check(v.UnidentifiedKeyItems)}randomizeWalls(){return this.check(v.RandomizeWallElements)}guaranteeSword(){return this.check(n.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(vb.BattleMagic,
!1)}guaranteeMatchingSword(){return this.check(vb.MatchingSword,!1)}guaranteeGasMask(){return this.check(vb.GasMask,!1)}guaranteeBarrier(){return this.check(vb.Barrier,!1)}guaranteeRefresh(){return this.check(n.GuaranteeRefresh)}communityJokes(){return this.check(n.NoCommunityJokes,!1)}disableSwordChargeGlitch(){return this.check(u.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(u.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(u.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(rb.Shops,
!1)}disableStatueGlitch(){return this.check(u.StatueGlitch,!1)}disableRageSkip(){return this.check(u.RageSkip,!1)}disableTriggerGlitch(){return this.check(u.TriggerSkip,!1)}disableFlightStatueSkip(){return this.check(u.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(u.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(u.GhettoFlight)}assumeTeleportSkip(){return this.check(u.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(u.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(u.StatueGlitch)}assumeTriggerGlitch(){return this.check(u.TriggerSkip)}assumeFlightStatueSkip(){return this.check(u.StatueGauntletSkip)}assumeWildWarp(){return this.check(rb.WildWarp,
!0)||this.check(v.RandomizeWildWarp)}assumeRageSkip(){return this.check(u.RageSkip)}nerfWildWarp(){return this.check(rb.WildWarp,!1)&&this.check(v.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(v.RandomizeWildWarp,!0)}blackoutMode(){return this.check(ub.Blackout)}hardcoreMode(){return this.check(ub.Permadeath)}buffDyna(){return!this.check(rb.Dyna)}maxScalingInTower(){return this.check(ub.MaxScalingInTower)}expScalingFactor(){return this.check(ub.ExperienceScalesSlower)?
.25:this.check(n.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(a){return"early"===a||this.check(Bb.NoAutoEquip,!1)}controllerShortcuts(a){return"early"===a||this.check(Bb.NoControllerShortcuts,!1)}randomizeMusic(a){return this.check(wb.RandomizeMusic,"early"===a?"!":!0)}shuffleTilePalettes(a){return this.check(wb.RandomizeMapColors,"early"===a?"!":!0)}noMusic(a){return"late"===a&&this.check(wb.NoMusic)}audibleWallCues(a){return"late"===a&&this.check(Bb.AudibleWallCues)}shouldColorSwordElements(){return!0}shouldUpdateHud(){return this.check(rb.Hud,
!1)}hasStatTracking(){return!0}};function Cb(a){return a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace(/Of/g,"of").replace(/_/g," - ")}function Db(a){return Cb(a).replace(/^./,a=>a.toUpperCase())}function w(a,b=a=>a){return Array(a).fill(0).map((a,d)=>b(d))}function Eb(a,b,c){return Array.from(a.slice(b,b+c))}function Fb(a){return 128>a?a:a-256}function Gb(a,b,c,d,e=Infinity,f){f||(f=a=>a);const g=[];for(;b+c<=e&&a[b]!==d;)g.push(f(a.slice(b,b+c))),b+=c;return g}function Hb(a,b,c=0){return(a[b]|a[b+1]<<8)+c}
function Ib(a,b,c){c||(c=a=>a);return w(Math.max(0,Math.floor(b.length/a)),d=>{var e=c;d*=a;d=b.slice(d,d+a);return e(d)})}function Mb(a){return 65793*(2050*a&139536|32800*a&558144)>>>16&255}function x(a){return null!=a?a.toString(16).padStart(2,"0"):String(a)}function Nb(a){const b=[];for(const c of a)for(const a of c)b.push(a);return b}function Ob(a,b){return a[b]<<8|a[b+1]}function Pb(a,b){return a[b+1]<<8|a[b]}
function Qb(a,b,c=0){const d=[];for(;a[b]!=c;)d.push(a[b++]);return String.fromCharCode(...d)}
class Rb{constructor(a,b,c=!1){this.last=a;this.clear=b;this.nonEmpty=c}read(a,b=0){const c=[];for(;;){const e=a[b++];var d=a[b++];d|=(e&3)<<8;d=e&this.clear?~d:d;-1!==d&&c.push(d);if(e&this.last)return c}}bytes(a){a=a.filter(a=>-1!==a);this.nonEmpty&&!a.length&&(a=[-1]);const b=[];for(let c=0;c<a.length;c++){let d=a[c];0>d&&(d=this.clear<<8|~d);c===a.length-1&&(d|=this.last<<8);b.push(d>>>8);b.push(d&255)}return b}write(a,b,c=0){b=this.bytes(b);for(let d=0;d<b.length;d++)a[d+c]=b[d]}}
const Sb=new Rb(64,128),Ub=new Rb(64,128,!0),Vb=new Rb(64,128,!0),Wb=new Rb(128,32,!0),Xb=new Rb(128,32);function Yb(){function a(...a){return{tag:b,args:a}}const b=Symbol();a.commit=(a,d)=>{for(const c of Object.getOwnPropertyNames(a)){const e=a[c];e.tag===b&&(a[c]=d(c,...e.args))}};return a}const Zb=Symbol("PROP_TAG"),$b=new WeakMap;
function dc(a){let b=$b.get(a);if(!b){b=class extends ec{};Object.defineProperties(b,{name:{value:a.name}});Object.assign(b,a);Reflect.setPrototypeOf(b.prototype,a.prototype);const c=new a,d={};for(const [a,b]of Object.entries(c))b&&b[Zb]&&(d[a]=b);Object.defineProperties(b.prototype,d);$b.set(a,b);$b.set(b,b)}return b}
class ec{constructor(a){this.data=a}static of(a){return Object.assign(new (dc(this))(Array(this.size).fill(0)),a)}static from(a,b=0){const c=dc(this);a=b||a.length!==this.size?Eb(a,b,this.size):a;return new c(a)}[Symbol.iterator](){return this.data[Symbol.iterator]()}hex(){return Array.from(this.data,x).join(" ")}clone(){return new this.constructor(this.data)}prop(...a){return{get(){let b=0;for(const [c,d=255,e=0]of a)b|=(this.data[c]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b},set(b){for(const [c,d=255,
e=0]of a)this.data[c]=this.data[c]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d},[Zb]:!0}}booleanProp(a,b){return{get(){return!!(this.data[a]&1<<b)},set(c){const d=1<<b;this.data[a]=c?this.data[a]|d:this.data[a]&~d},[Zb]:!0}}}class y{constructor(a,b,c){this.name=a;this.bank=b;this.org=c}get offset(){return(this.bank&31)<<13}}y.$04=new y("04",4,32768);y.$05=new y("05",5,40960);y.$0a=new y("0a",10,32768);y.$0b=new y("0b",11,40960);y.$0c=new y("0c",12,32768);y.$0d=new y("0d",13,40960);y.$0e=new y("0e",14,32768);
y.$0f=new y("0f",15,40960);y.$10=new y("10",16,32768);y.$14=new y("14",20,32768);y.$15=new y("15",21,40960);y.$16_a=new y("16:a",22,40960);y.$17=new y("17",23,40960);y.$18=new y("18",24,32768);y.$19=new y("19",25,40960);y.$1a=new y("1a",26,32768);y.$1b=new y("1b",27,40960);y.$fe=new y("fe",30,49152);y.$ff=new y("ff",31,57344);
class B{constructor(a,b){this.seg=a;this.delta=b}static of(a,b){return new B(a,b-a.org)}get offset(){return this.seg.offset+this.delta}get org(){return this.seg.org+this.delta}get segment(){return this.seg.name}plus(a,b){a=this.delta+a;if(8192<=a){if(!b)throw Error("Segment changed");if(this.seg.org&8192)throw Error("Bad segment cross");return new B(b,a&8191)}return new B(this.seg,a)}minus(a){if(a.seg!==this.seg)throw Error("Incompatible segments");return this.delta-a.delta}read(a){return a[this.offset]}readLittleEndian(a){const b=
this.offset;return a[b]|a[b+1]<<8}readAddress(a,...b){a=this.readLittleEndian(a);b.length||(b=[this.seg]);for(const c of b)if((a&57344)===(c.org&57344))return B.of(c,a);throw Error(`Could not find valid segment for ${x(a)}`);}loc(a,b){a.segment(this.segment);a.org(this.org,b)}}function fc(a,b,c,d){a.segment(b.name);a.org(c);a.free(d-c)}function gc(a,b,c){a.segment(...b.map(a=>a.name));a.reloc(c);a.label(c);a.export(c)};var hc;(function(a){a.name=function(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw Error(`Bad direction: ${a}`);};a.all=function(){return[0,1,2,3]};a.North=0;a.West=1;a.South=2;a.East=3})(hc||(hc={}));function ic(a){return a}(function(a){a.from=function({id:a},{x:c,y:d}){return a<<16|d>>>8<<12|c>>>8<<8|(d>>>4&15)<<4|c>>>4&15};a.add=function(a,c,d){if(c){for(c=(a&240)+(c<<4);240<=c;){if(61440<=(a&61440))return-1;c-=240;a+=4096}for(;0>c;){if(!(a&61440))return-1;c+=240;a-=4096}a=a&-241|c}if(d){for(d=(a&15)+d;16<=d;){if(1792<=(a&3840))return-1;d-=16;a+=256}for(;0>d;){if(!(a&3840))return-1;d+=16;a-=256}a=a&-16|d}return a}})(ic||(ic={}));var jc;
(function(a){a.trigger=function(a,c){return{*[Symbol.iterator](){let {x:b,y:e}=c;b+=8;for(const c of[-16,0]){const d=b+c;for(const b of[-16,0])yield ic.from(a,{x:d,y:e+b})}}}};a.adjust=function(a,...c){const b=new Set;a=[...a];for(const [d,f]of c)for(const c of a)b.add(ic.add(c,d,f));return b};a.screen=function(a){const b=[];for(let c=0;240>c;c++)b.push(a&-256|c);return b};a.atLocation=function(a,...c){const b=new Set;a=[...a];for(const d of c)for(const c of a)b.add(c&65535|d.id<<16);return b}})(jc||(jc=
{}));var C;
(function(a){function b(a){return a instanceof c?[...ca.map(a,a=>[...a])]:a}a.and=function(...a){return[[].concat(...a.map(([a])=>a))]};a.or=function(...c){const d=[];for(const e of c){if(e===a.OPEN)return a.OPEN;e!==a.CLOSED&&d.push(...b(e))}return d.length?d:a.CLOSED};a.meet=function(d,e){if(d===a.OPEN)return b(e);if(e===a.OPEN)return b(d);if(d===a.CLOSED||e===a.CLOSED)return a.CLOSED;const f=new c;for(const a of d)for(const b of e)f.addList([...a,...b]);return b(f)};a.freeze=b;a.label=function(a){return a instanceof c?
a.label():a.map(a=>a.join("&")).join("|")};a.isOpen=function(a){a=a[Symbol.iterator]();const {value:b,done:c}=a.next();return c||!a.next().done?!1:b[Symbol.iterator]().next().done};a.isClosed=function(a){return!!a[Symbol.iterator]().next().done};a.OPEN=[[]];a.CLOSED=[];class c{constructor(a){this.self=a;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(a,b){for(const a of b)if(Array.isArray(a))throw Error();if(b.has(this.self)||this.map.has(a))return!1;for(const [a,c]of this.map){if(kc(b,
c))return!1;kc(c,b)&&this.map.delete(a)}this.map.set(a,b);return!0}addRoute(a){return this.addInternal(a[lc],a.deps)}addAll(a){for(const b of a)this.addList(b)}addList(a){a=[...new Set(a)].sort();const b=new Set(a);this.addInternal(a.join("&"),b)}restrict(a){const b=[...this.map.values()];this.map.clear();for(const c of b)for(const b of a)this.addList([...c,...b])}label(){return[this.map.keys()].join("|")}}a.Builder=c})(C||(C={}));
function kc(a,b){if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0}const lc=Symbol("depsLabel");class mc{constructor(a,b){this.target=a;a=[...new Set(b)].sort();this.deps=new Set(a);this[lc]=a.join("&");this.label=`${this.target}:${this[lc]}`}};function nc(a){return a}(function(a){a.from=(a,c)=>"number"!==typeof a&&c?a.id<<8|c.y>>>8<<4|c.x>>>8:Number(a)>>>8;a.fromTile=function(a){return a>>>8}})(nc||(nc={}));class oc{constructor(a){this.rom=a;this.tiles=new ba(a=>zc(this.rom,a));this.bosses=new ba(a=>new Ac(a));this.statues=new Map;this.flags=new ba(a=>new ba(b=>new ba(c=>new Bc(a,b,c))));this.meets=new ba(a=>new ba(b=>new Cc(a,b)));this._seamless=new ba(a=>new Dc(a))}tile(a){return a&4?void 0:this.tiles.get(a)}boss(a,b){return b?this.rage||(this.rage=new Ec(a,this.rom.flags.RageSkip.id)):this.bosses.get(a)}statue(a){const b=C.label(a);let c=this.statues.get(b);c||this.statues.set(b,c=new Fc(a));return c}flag(a,
b,c){a||(a=Gc);return this.flags.get(a).get(b).get(c)}meet(a,b){return this.meets.get(a).get(b)}seamless(a){return this._seamless.get(a)}label(a,b){return a.label?a.label(b):"Terrain"}}var Hc;(function(a){a.FLY=2;a.BLOCKED=4;a.SLOPE=32;a.PAIN=128;a.BITS=166;a.SWAMP=256;a.BARRIER=512;a.SLOPE8=1024;a.SLOPE9=2048;a.DOLPHIN=4096;a.label=function(a,c){var b,e;return null!==(e=null===(b=a.label)||void 0===b?void 0:b.call(a,c))&&void 0!==e?e:"Terrain"}})(Hc||(Hc={}));
class Dc{constructor(a){this._delegate=a;this.enter=a.enter;this.exit=a.exit}label(a){return`Seamless(${Hc.label(this._delegate,a)})`}}class Ic{constructor(a,b=C.OPEN){this.enter=a;this.exit=[[15,b]]}get kind(){return"Simple"}label(a){const b=[];C.isOpen(this.enter)||b.push(`enter = ${Jc(this.enter,a)}`);C.isOpen(this.exit[0][1])||b.push(`exit = ${Jc(this.exit[0][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
class Kc{constructor(a,b,c=4){this.enter=a;this.exit=b?[[15&~c,b],[c,C.OPEN]]:[[15,C.OPEN]]}get kind(){return"South"}label(a){if(1===this.exit.length)return Ic.prototype.label.call(this,a);const b=[];C.isOpen(this.enter)||b.push(`enter = ${Jc(this.enter,a)}`);C.isOpen(this.exit[0][1])||b.push(`other = ${Jc(this.exit[0][1],a)}`);C.isOpen(this.exit[1][1])||b.push(`south = ${Jc(this.exit[1][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
function zc(a,b){let c=C.OPEN,d=void 0,e=4;b&Hc.DOLPHIN&&b&Hc.FLY?(b&Hc.SLOPE&&(d=a.flags.ClimbWaterfall.r),c=[[a.flags.CurrentlyRidingDolphin.c],[a.flags.Flight.c]]):(b&Hc.SLOPE9?d=a.flags.ClimbSlope9.r:b&Hc.SLOPE8?d=a.flags.ClimbSlope8.r:b&Hc.SLOPE&&(d=a.flags.ClimbSlope10.r),b&Hc.FLY&&(c=a.flags.Flight.r));b&Hc.SWAMP&&(c=c.map(b=>[a.flags.TravelSwamp.c,...b]));b&Hc.PAIN&&(c=c.map(b=>[a.flags.CrossPain.c,...b]));b&Hc.BARRIER&&(c=c.map(b=>[a.flags.ShootingStatue.c,...b]),d=a.flags.ShootingStatueSouth.r,
e=1);return new Kc(c,d,e)}class Ac extends Ic{constructor(a){super(C.OPEN,[[a]]);this._flag=a}get kind(){return"Boss"}}class Fc extends Kc{constructor(a){super(C.OPEN,a);this._req=a}get kind(){return"Statue"}}class Ec{constructor(a,b){this._rageFlag=a;this._rageSkipFlag=b;this.enter=C.OPEN;this.exit=[[11,[[a],[b]]],[4,C.OPEN]]}label(){return"Rage"}}
class Bc extends Ic{constructor(a,b,c){if(1!==a.exit.length||1!==c.exit.length)throw console.error(a,c),Error("bad flag");const d=[[b]],e=0<=b?C.meet(c.enter,d):c.enter;b=0<=b?C.meet(c.exit[0][1],d):c.exit[0][1];super(C.or(a.enter,e),C.or(a.exit[0][1],b))}get kind(){return"Flag"}}const Gc=new Ic(C.CLOSED,C.CLOSED);
function Lc(a){const b=[];for(var c=0;c<a.exit.length;c++)for(let d=0;4>d;d++)a.exit[c][0]&1<<d&&(b[d]=c);for(c=0;4>c;c++)if(null==b[c])throw Error(`Bad terrain: ${a.exit.map(a=>a[0]).join(",")}`);return b}
class Cc{constructor(a,b){this.left=a;this.right=b;const c=Lc(a),d=Lc(b),e=new Set,f=[];for(let a=0;4>a;a++)e.add(c[a]<<2|d[a]);for(const c of e){const [d,e]=a.exit[c>>2],[g,q]=b.exit[c&3];f.push([d&g,C.meet(e,q)])}this.enter=C.meet(a.enter,b.enter);this.exit=f}get kind(){return"Terrain"}label(a){if(1===this.exit.length)return Ic.prototype.label.call(this,a);const b=[];C.isOpen(this.enter)||b.push(`enter = ${Jc(this.enter,a)}`);for(const [c,d]of this.exit){const e=[c&1?"N":"",c&2?"W":"",c&4?"S":"",
c&8?"E":""].join("");b.push(`exit${e} = ${Jc(d,a)}`)}return`${this.kind}(${b.join(", ")})`}}function Jc(a,b){a=[...a];const c=a.map(a=>ca.isEmpty(a)?"open":[...a].map(a=>{var c;return null===(c=b.flags[a])||void 0===c?void 0:c.debug}).join(" & ")).join(") | (");return 1<a.length?`(${c})`:a.length?c:"never"}Hc.debugLabel=Jc;"object"===typeof window&&(window.debugLabel=Jc);function Mc(a){return a}(function(a){a.of=function(a,c){return 16777216*a+c};a.split=function(a){return[Math.floor(a/16777216),a%16777216]}})(Mc||(Mc={}));var Qc,Rc=Qc||(Qc={});Rc[Rc.WIND=0]="WIND";Rc[Rc.FIRE=1]="FIRE";Rc[Rc.WATER=2]="WATER";Rc[Rc.THUNDER=3]="THUNDER";class Sc{constructor(a,b,c,d=1){this.rom=a;this._width=c;this._height=b;this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.element.appendChild(this.canvas);this.canvas.width=c;this.canvas.height=b;this.ctx=this.canvas.getContext("2d")||cb();this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.palettes=new Uint32Array(1024);this.layers=w(d,()=>new Uint32Array(c*b));this.data=this.layers[0];for(d=0;256>d;d++)for(let b=0;4>b;b++){const c=Tc[a.palettes[d].color(b)];
this.palettes[d<<2|b]=c|4278190080}}useLayer(a){this.data=this.layers[a]||cb(`Bad layer: ${a}`)}resizeWidth(a,b){const c=new Uint32Array(b*this._height),d=Math.min(b,this._width);for(let e=0;e<this._height;e++)c.subarray(e*b,e+b+d).set(a.subarray(e*this._width,e*this._width+d));return c}resizeHeight(a,b){const c=new Uint32Array(this._width*b);b=this._width*Math.min(b,this._height);c.subarray(0,b).set(a.subarray(0,b));return c}get width(){return this._width}set width(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=
this.resizeWidth(this.layers[b],a);this._width=a;this.canvas.width=a}get height(){return this._height}set height(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=this.resizeHeight(this.layers[b],a);this._height=a;this.canvas.height=a}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(a){this.data.fill(a)}clear(a){a=null!=a?this.palettes[a<<2]:0;this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.layers[0].fill(a);
for(a=1;a<this.layers.length;a++)this.layers[a].fill(0)}toDataUrl(){return this.canvas.toDataURL("image/png")}render(){let a=this.canvas,b=this.ctx;for(let c=0;c<this.layers.length;c++){c&&(a=document.createElement("canvas"),a.width=this.canvas.width,a.height=this.canvas.height,b=a.getContext("2d")||cb());const d=new Uint8Array(this.layers[c].buffer),e=b.getImageData(0,0,this._width,this._height);e.data.set(d);b.putImageData(e,0,0);c&&this.ctx.drawImage(a,0,0)}}rect(a,b,c,d,e){const f=Math.max(0,
b);c=Math.min(this._height,a+c);d=Math.min(this._width,b+d);for(a=Math.max(0,a);a<c;a++)for(b=f;b<d;b++)this.data[a*this._width+b]=e}tile(a,b,c,d){if(!(0>b||0>a||b+8>=this._width||a+8>=this._height)){c=this.rom.patterns.get(c).flip(d<<6);for(let e=0;8>e;e++){let f=c.pixels[8|e]<<1,g=c.pixels[e];for(let c=7;0<=c;c--){const h=f&2|g&1;f>>>=1;g>>>=1;h&&(this.data[(a+e)*this._width+b+c]=this.palettes[d&1020|h])}}this._minX=Math.min(this._minX,b);this._maxX=Math.max(this._maxX,b+8);this._minY=Math.min(this._minY,
a);this._maxY=Math.max(this._maxY,a+8)}}metatile(a,b,c,d,e=0){var f=this.rom.locations[d];d=[...f.tilePatterns];f.animation&&(d[1]=this.rom.tileAnimations[f.animation].pages[e&7]);var g=[...f.tilePalettes,127];e=this.rom.tilesets[f.tileset];f=g[e.attrs[c]];for(g=0;2>g;g++)for(let h=0;2>h;h++){const k=e.tiles[g<<1|h][c];this.tile(a+(g<<3),b+(h<<3),d[k&128?1:0]<<6|k&127,f<<2)}}metasprite(a,b,c,d,e=0,f=0){d=this.rom.locations[d];var g=this.rom.metasprites[c];c=[64,66,...d.spritePatterns];d=[0,1,...d.spritePalettes];
let h=!1;null!=g.mirrored&&(g=this.rom.metasprites[g.mirrored],h=!0);if(g&&g.used){f&=g.frameMask;for(let [k,p,q,t]of g.sprites[f]){if(128==k)break;k=128>k?k:k-256;p=128>p?p:p-256;t=t+e&255;f=d[q&3]+176&255;g=c[t>>6]<<6|t&63;h&&(k=-8-k,q^=64);this.tile(a+p,b+k,g,f<<2|q>>6)}}}text(a,b,c,d=18){for(let e=0;e<c.length;e++)this.tile(a,b+8*e,c.charCodeAt(e)|3840,d<<2)}}
const Tc=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];const Uc=Symbol("[LocationMap data]");
class Vc extends Sc{constructor(a,b=0){super(a,1,1,4);this.rom=a;this.flags=new Set;this._maxWidth=Infinity;a=a.locations[b];this.width=256*(a.used?a.width:1);this.height=240*(a.used?a.height:1);this.location=a;a=a=>{let b=a.offsetX,c=a.offsetY;for(var f=a.target;f&&f!==this.element;)f=f.parentElement;if(f){f=b>>8;var g=Math.floor(c/240);Vc.setData(a,{tile:this.location.id<<16|g<<12|f<<8|c-240*g>>4<<4|b-256*f>>4,target:this})}};this.element.addEventListener("mousemove",a);this.element.addEventListener("mousedown",
a);this.element.addEventListener("mouseup",a);this.element.addEventListener("click",a);this.redraw()}static getData(a){return a[Uc]}static setData(a,b){a[Uc]=b}get id(){return this.location.id}set id(a){this.location=this.rom.locations[a];this.height=240*(this.location.used?this.location.height:1);this.width=256*(this.location.used?this.location.width:1);this.ensureWidth();this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(a){this._maxWidth=a;this.ensureWidth()}ensureWidth(){if(this.width<=
this._maxWidth)this.element.style.transform="",this.element.style.width="",this.element.style.height="";else{var a=this._maxWidth/this.width,b=50*(1-a);this.element.style.transform=`translate(-${b}%,-${b}%) scale(${a})`;this.element.style.width=`${this.width*a}px`;this.element.style.height=`${this.height*a}px`}}clearOverlay(){this.useLayer(1);this.fill(0);this.useLayer(3);this.fill(0);this.render()}overlayShade(a){this.useLayer(3);this.fill(a)}overlayArea(a,b,c){for(const d of a){if(d>>>16!==this.location.id)continue;
const e=240*(d>>>12&15)+16*(d>>>4&15),f=256*(d>>>8&15)+16*(d&15);null!=c&&(this.useLayer(3),this.rect(e-1,f-1,18,18,0));this.useLayer(1);a.has(ic.add(d,-1,0))||this.rect(e-1,f-1,2,18,b);a.has(ic.add(d,0,-1))||this.rect(e-1,f-1,18,2,b);a.has(ic.add(d,1,0))||this.rect(e+15,f-1,2,18,b);a.has(ic.add(d,0,1))||this.rect(e-1,f+15,18,2,b)}}redraw(){this.useLayer(0);this.clear(this.location.tilePalettes[0]);for(var a=0;a<this.location.height;a++)for(var b=0;b<this.location.width;b++)this.drawScreen(this.rom.screens[this.location.screens[a][b]],
a,b);this.useLayer(2);for(const c of this.location.spawns){a=0;let {x:d,y:e}=c;e-=c.yt&240;let f;if(c.isNpc()){b=this.rom.npcs[c.id];if(!b||!b.data)continue;d+=8;e+=12;f=2|b.data[3]}else if(c.isChest())f=170;else if(c.isMonster()){b=this.rom.objects[c.monsterId];if(!b)continue;f=b.metasprite;41==b.action?f=104:[42,94].includes(b.action)&&(f=2|b.data[31])}c.patternBank&&(a+=64);null!=f&&this.metasprite(e,d,f,this.location.id,a)}this.render()}drawScreen(a,b,c){var d;const e=240*b,f=256*c,g=this.rom.tilesets[this.location.tileset];
let h,k=!1;for(const a of this.location.flags)if(a.xs===c&&a.ys===b){h=a.flag;if(null===(d=this.rom.flags[h])||void 0===d?0:d.logic.assumeTrue)k=!0;break}for(b=0;240>b;b+=16)for(c=0;16>c;c++)d=a.tiles[b|c],32>d&&(this.flags.has(h)||k)&&(d=g.alternates[d]),this.metatile(e+b,f+16*c,d,this.location.id,0)}};class Wc{constructor(a,b){this.rom=a;this.world=b;this.element=document.createElement("div");this.element.addEventListener("click",a=>this.click(a));this.element.addEventListener("mousemove",a=>this.move(a));this.renderArea(0)}click(a){if(a=Vc.getData(a))if(a=this.world.tiles.get(a.tile),null!=a){if(a.area===this.area){const b=null!=a.exit?this.world.tiles.get(a.exit):null;b&&b.area!==this.area&&(a=b)}a.area&&a.area!==this.area&&this.renderArea(a.area.id)}}move(a){if(a=Vc.getData(a)){var b=this.world.tiles.get(a.tile);
null!=b&&(b=null!=b.exit&&!this.area.tiles.has(b.exit),a.target.element.style.cursor=b?"pointer":"default")}}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(a){var b;this.clear();const c=document.createElement("select");c.appendChild(document.createElement("option"));c.children[0].textContent="Select location";for(const a of this.rom.locations){if(!a.used)continue;const d=null===(b=this.world.locations[a.id])||void 0===b?void 0:b.areas[Symbol.iterator]().next().value;
if(null==d)continue;const f=document.createElement("option");f.textContent=`${x(a.id)} ${a.name}`;f.value=String(d.id);c.appendChild(f)}c.addEventListener("change",()=>{this.renderArea(Number(c.value))});this.element.appendChild(c);this.area=this.world.areas[a];b=document.createElement("pre");b.textContent=`Area ${a}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${Hc.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([a,b])=>`${a.debug}: ${Jc(b,this.rom)}`))].join("\n  ")}
Routes:
  ${Jc(this.area.routes,this.rom).split(" | ").join("\n  ").replace(/[()]/g,"")}`;this.element.appendChild(b);for(const c of this.area.locations)a=this.rom.locations[c],b=document.createElement("h2"),b.textContent=a.name,this.element.appendChild(b),this.element.appendChild(this.makeLocation(this.area,a))}makeLocation(a,b){const c=new Vc(this.rom,b.id);c.maxWidth=574;c.overlayShade(1426063360);for(const d of this.world.locations[b.id].areas)d!==a&&c.overlayArea(d.tiles,4294901760);c.overlayArea(a.tiles,
4278255615,0);c.render();return c.element}};class Xc{constructor(a,b){this.rom=a;this.id=b}write(){return[]}toString(){return`${this.constructor.name} $${x(this.id)}`}}class Yc extends Array{static get [Symbol.species](){return Array}};class Zc extends Yc{constructor(a){super(44);this.rom=a;this.innBasePrice=20;this.toolShopScaling=Array(48).fill(0);this.armorShopScaling=Array(48).fill(0);for(let b=0;44>b;b++)this[b]=new $c(a,b);if(null!=a.shopDataTablesAddress){const b=a.shopDataTablesAddress+21*a.shopCount+2*a.scalingLevels;this.basePrices=w(73,c=>13<=c&&39>c?Pb(a.prg,b+2*(c-13)):0)}else this.basePrices=w(73,b=>2*Pb(a.prg,138946+2*b))}armorShops(){return w(11,a=>this[4*a])}toolShops(){return w(11,a=>this[4*a+1])}inns(){return w(11,
a=>this[4*a+2])}pawnShops(){return w(11,a=>this[4*a+3])}write(){var a,b,c,d,e,f,g,h;const k=this.rom.assembler();if(this.rescale){var p=function(a){k.export(a);k.label(a)};k.segment("10","fe","ff");k.reloc("ShopData");p("ShopData");p("ArmorShopIdTable");for(const b of this.armorShops())for(var q=0;4>q;q++)k.byte(null!==(a=b.contents[q])&&void 0!==a?a:255);p("ToolShopIdTable");for(const a of this.toolShops())for(q=0;4>q;q++)k.byte(null!==(b=a.contents[q])&&void 0!==b?b:255);p("ArmorShopPriceTable");
for(const a of this.armorShops())for(q=0;4>q;q++)k.byte(Math.round(32*(null!==(c=a.prices[q])&&void 0!==c?c:0)));p("ToolShopPriceTable");for(const a of this.toolShops())for(c=0;4>c;c++)k.byte(Math.round(32*(null!==(d=a.prices[c])&&void 0!==d?d:0)));p("InnPrices");for(const a of this.inns())k.byte(Math.round(32*(null!==(e=a.prices[0])&&void 0!==e?e:0)));p("ShopLocations");for(const a of this)k.byte(a.location);p("ToolShopScaling");k.byte(...this.toolShopScaling);p("ArmorShopScaling");k.byte(...this.armorShopScaling);
p("BasePrices");k.word(...this.basePrices.slice(13,39).map(a=>null!==a&&void 0!==a?a:0));p("InnBasePrice");k.word(this.innBasePrice)}else{k.segment("10","fe","ff");k.org(40356,"ShopData");for(const a of this.armorShops())for(d=0;4>d;d++)k.byte(null!==(f=a.contents[d])&&void 0!==f?f:255);for(const a of this.armorShops())for(d=0;4>d;d++)k.word(null!==(g=a.prices[d])&&void 0!==g?g:0);for(const a of this.toolShops())for(d=0;4>d;d++)k.byte(null!==(h=a.contents[d])&&void 0!==h?h:255);for(q of this.toolShops())for(d=
0;4>d;d++)k.word(null!==(p=q.prices[d])&&void 0!==p?p:0)}return[k.module()]}}var ad,bd=ad||(ad={});bd[bd.ARMOR=0]="ARMOR";bd[bd.TOOL=1]="TOOL";bd[bd.INN=2]="INN";bd[bd.PAWN=3]="PAWN";const cd=[ad.ARMOR,ad.TOOL,ad.INN,ad.PAWN],dd=[a=>a?a:138660,(a,b)=>a?a+4*b:138792,()=>0,()=>0],ed=[4,4,0,0],fd=[(a,b)=>a?a+8*b:138704,(a,b)=>a?a+12*b:138836,(a,b)=>a?a+16*b:138924,()=>0],gd=[4,4,1,0];
class $c extends Xc{constructor(a,b){super(a,b);this.type=cd[b&3];this.index=b>>>2;if(a.shopDataTablesAddress)this.location=a.prg[a.shopDataTablesAddress+17*a.shopCount+b];else{b=255;for(let d=0;33>d&&255===b;d++){if(a.prg[139125+d]!==this.index)continue;const e=a.prg[139092+d];for(var c of a.locations[e].spawns)if(4===c.type&&a.objects[c.id].data[25]===32+this.type){b=e;break}}this.location=b}c=a.shopDataTablesAddress?b=>a.prg[this.pricesAddress+b]/32:b=>Pb(a.prg,this.pricesAddress+2*b);this.contents=
Eb(a.prg,this.contentsAddress,ed[this.type]);this.prices=w(gd[this.type],c);this.used=255!==this.location}get contentsAddress(){return dd[this.type](this.rom.shopDataTablesAddress,this.rom.shopCount)+4*this.index}get pricesAddress(){const a=this.rom.shopDataTablesAddress;return fd[this.type](a,this.rom.shopCount)+(a?1:2)*gd[this.type]*this.index}updateShopkeeper(){throw Error("not implemented");}};class hd{constructor(){this.data=new Map;this.sizes=new Map}find(a){if(a!==a)throw"nan";this.data.has(a)||(this.data.set(a,a),this.sizes.set(a,1));let b;for(;!Object.is(b=this.data.get(a),a);)this.data.set(a,a=this.data.get(b));return a}union(a){this.find(a[0]);for(let b=1;b<a.length;b++){if(a[b]!==a[b])throw"nan";this.unionInternal(a[0],a[b])}}unionInternal(a,b){a=this.find(a);b=this.find(b);if(a!==b){var c=this.sizes.get(a),d=this.sizes.get(b);c<d?(this.sizes.set(b,c+d),this.data.set(a,b)):(this.sizes.set(a,
c+d),this.data.set(b,a))}}sets(){const a=new Map;for(const b of this.data.keys()){const c=this.find(b);let d=a.get(c);d||a.set(c,d=new Set);d.add(b)}return[...a.values()]}map(){const a=new ba(()=>new Set);for(const b of this.data.keys()){let c=a.get(this.find(b));a.set(b,c);c.add(b)}return a}roots(){const a=new Set;for(const b of this.data.keys())a.add(this.find(b));return[...a]}};const id={next(){return{done:!0}}},md={get size(){return 0},has(){return!1},[Symbol.iterator](){return id}},E={get size(){return Infinity},has(){return!0},[Symbol.iterator](){throw Error("cannot iterate");}};class nd{constructor(a){this.bit=a}get size(){return 1}has(a){return a===this.bit}[Symbol.iterator](){return[this.bit][Symbol.iterator]()}}function od(a){return new nd(a)}var pd;
(function(a){a.intersect=function(a,c){if(a===E||!c.size)return c;if(c===E||!a.size)return a;const b=new Set;for(const d of a)c.has(d)&&b.add(d);return b.size?b:md};a.union=function(a,c){if(a===E||!c.size)return a;if(c===E||!a.size)return c;a=new Set(a);for(const b of c)a.add(b);return a};a.isSubset=function(a,c){if(c===E||!a.size)return!0;if(a.size>c.size)return!1;for(const b of a)if(!c.has(b))return!1;return!0};a.label=function(a){return a===E?"all":[...a].sort().join(" ")}})(pd||(pd={}));
class qd{constructor(a,b,c){this.fixed=a;this.float=b;this.shift=c}get pat0(){return this.fixed[0]}get pat1(){return this.fixed[1]}get pal2(){return this.fixed[2]}get pal3(){return this.fixed[3]}static get ALL(){return new qd([E,E,E,E],[],0)}static get NONE(){return new qd([md,md,md,md],[],0)}static get MIMIC(){return new qd([E,od(108),E,E],[],2)}static get TREASURE_CHEST(){return new qd([E,E,E,E],[rd],0)}static get BOSS(){return new qd([rd,E,E,E],[],0)}static get COIN(){return new qd([sd,E,E,E],
[],0)}static get STOM_FIGHT(){return new qd([E,new Set([77]),E,E],[],0)}static get GUARDIAN_STATUE(){return new qd([new Set([116]),new Set([98]),E,E],[],0)}static get SHOOTING_WALL(){return new qd([new Set([97]),E,E,E],[],0)}static get KENSU_CHEST(){return new qd([new Set([81]),E,E,E],[],0)}static forLocation(a){switch(a){case 3:return new qd([E,od(96),E,od(32)],[],0);case 96:case 100:case 104:return new qd([E,od(82),E,od(8)],[],0)}return qd.ALL}static fromSpawn(a,b,c,d,e){const [f,...g]=b;(e=e&&
2===f&&!g.length)&&d.patternBank&&(b=new Set([3]));const h=e||!b.has(2)?E:od(c.spritePatterns[0]);b=e||!b.has(3)?E:od(c.spritePatterns[1]);d=e?[od(c.spritePatterns[d.patternBank])]:[];e=a.has(2)?od(c.spritePalettes[0]):E;a=a.has(3)?od(c.spritePalettes[1]):E;return new qd([h,b,e,a],d,0)}ignorePalette(){return new qd([this.fixed[0],this.fixed[1],E,E],this.float,this.shift)}shufflePalette(a,b){const c=[...this.fixed];for(let d=2;4>d;d++){if(c[d]===E)continue;const e=Math.floor(5-Math.log2(a.nextInt(15)+
2)),f=c[d]=new Set;for(let c=0;c<e;c++)f.add(a.pick(b))}return new qd(c,this.float,this.shift)}shifted(){return new qd(this.fixed,this.float,this.shift|2)}join(a){const b=w(4,b=>pd.union(this.fixed[b],a.fixed[b]));if(this.float.length!==a.float.length)throw console.dir(this),console.dir(a),Error(`incompatible float: ${this.float} ${a.float}`);const c=w(this.float.length,b=>pd.union(this.float[b],a.float[b]));return new qd(b,c,this.shift|a.shift)}fix(a,b){var c=b?a=>b.nextInt(a):()=>0;const d=b?a=>
b.pick([...a]):a=>a[Symbol.iterator]().next().value,e=[...this.fixed];if(this.float.length){c=c(2);const a=1-c;c<this.float.length&&(e[0]=pd.intersect(e[0],this.float[c]));a<this.float.length&&(e[1]=pd.intersect(e[1],this.float[a]))}e[0]!==E&&(a.spritePatterns[0]=d([...e[0]]));e[1]!==E&&(a.spritePatterns[1]=d([...e[1]]));e[2]!==E&&(a.spritePalettes[0]=d([...e[2]]));e[3]!==E&&(a.spritePalettes[1]=d([...e[3]]))}meet(a,b=!1){a=this.tryMeet(a,b);if(!a)throw Error("Could not reconcile patterns");return a}tryMeet(a,
b=!1){const c=[];let d=this.shift|a.shift;for(var e=0;4>e;e++){var f=pd.intersect(this.fixed[e],a.fixed[e]);if(!f.size){if(!b||2>e)return;f=pd.union(this.fixed[e],a.fixed[e])}c.push(f)}e=new Map;b=[];for(var g of ca.concat(this.float,a.float)){if(g===E)throw Error("Unexpected unconstrained float");a=!1;for(var h of g)if(f=e.get(h),null!=f){for(var k of b[f])e.delete(k);b[f]=pd.intersect(b[f],g);for(const a of b[f])e.set(a,f);a=!0;break}if(a)break;for(const a of g)e.set(a,b.length);b.push(g);if(2<
b.length)return}for(g=0;g<b.length;g++)for(h=0;2>h;h++)if(!pd.intersect(b[g],c[h]).size){k=c[1-h]=pd.intersect(b[g],c[1-h]);d|=1<<1-h;if(!k.size)return;b.splice(g,1);g=-1;break}return new qd(c,b,d)}}const rd=new Set([94,95,96,97,100,101,102,103,104,105,106,108,109,110,111,112,116,117,118,119]),sd=new Set([94,95,96,97,99,100,101,102,103,104,105,106,107,108,109,110,111,112,116,117,118,119]);class td extends Xc{constructor(a,b,c=""){super(a.rom,b);this.constraint=qd.ALL;a[b]=this;this.used=!0;this.name="";a.rom.writeMonsterNames?(a=this.rom.prg,b=this.rom.prg[499712|b]|this.rom.prg[499968|b]<<8|458752,b=String.fromCharCode(...a.slice(b+1,b+1+a[b]))):b=c;this.displayName=b;this.base=Pb(this.rom.prg,this.pointer)+65536;this.sfx=this.rom.prg[this.base];this.data=[];b=this.base+1;a=0;for(c=0;32>c;c++)c&7||(a=this.rom.prg[b++]),this.data.push(a&128?this.rom.prg[b++]:0),a<<=1}get pointer(){return 109568+
(this.id<<1)}serialize(){const a=[this.sfx];for(let b=0;4>b;b++){const c=a.length;a.push(0);for(let d=0;8>d;d++)this.data[8*b+d]&&(a[c]|=128>>>d,a.push(this.data[8*b+d]))}return a}write(){var a=`Object_${this.id.toString(16).padStart(2,"0")}`;const b=this.rom.assembler();b.segment("0d");b.reloc(a);var c=b.pc();b.byte(...this.serialize());b.org(44032+(this.id<<1),`${a}_Ptr`);b.word(c);if(this===this.rom.objects.blueSlime){a=this.elements;for(c=0;a;)a>>=1,c++;b.segment("1a");b.org(37421);b.byte(c)}if(this.rom.writeMonsterNames){b.segment("3d");
let a;this.displayName&&(b.reloc(`${this.name}_Str`),a=b.pc(),b.byte(this.displayName.length),b.byte(...this.displayName));b.org(40960|this.id);b.byte(null!=a?qa.loByte(a):0);b.org(41216|this.id);b.byte(null!=a?qa.hiByte(a):0)}return[b.module()]}get(a){return this.data[a-768>>>5]}parents(){return[]}spawnedChild(){var a;if(null!==(a=this.rom.objectActions[this.action])&&void 0!==a&&a.data.hasChild&&(a=(a=this.rom.adHocSpawns[this.child])&&a.objectId,null!=a))return this.rom.objects[a]}spawnedReplacement(){if(this.replacement)return this.rom.objects[this.replacement]}locations(){return this.rom.locations.filter(a=>
a.used&&a.spawns.some(a=>a.isMonster()&&a.monsterId===this.id))}palettes(a=!1){var b,c;if(34===this.action)return[3];var d=this.data[0];42===this.action&&(d=this.data[31]|1);41===this.action&&(d=107);38===this.action&&(d=156);d=this.rom.metasprites[d];a=a&&this.child?this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]]:null;return[...new Set([...null!==(b=null===d||void 0===d?void 0:d.palettes())&&void 0!==b?b:[],...null!==(c=null===a||void 0===a?void 0:a.palettes())&&
void 0!==c?c:[]])]}isVulnerable(a){return!(this.elements&1<<a)}isShadow(){return 123===this.id||140===this.id}get metasprite(){return ud.get(this.data)}set metasprite(a){ud.set(this.data,a)}get speed(){return vd.get(this.data)}set speed(a){vd.set(this.data,a)}get collisionPlane(){return wd.get(this.data)}set collisionPlane(a){wd.set(this.data,a)}get hitbox(){return xd.get(this.data)}set hitbox(a){xd.set(this.data,a)}get hp(){return yd.get(this.data)}set hp(a){yd.set(this.data,a)}get atk(){return zd.get(this.data)}set atk(a){zd.set(this.data,
a)}get def(){return Ad.get(this.data)}set def(a){Ad.set(this.data,a)}get level(){return Bd.get(this.data)}set level(a){Bd.set(this.data,a)}get poison(){return!!Cd.get(this.data)}set poison(a){Cd.set(this.data,a?1:0)}get child(){return Dd.get(this.data)}set child(a){Dd.set(this.data,a)}get terrainSusceptibility(){return Ed.get(this.data)}set terrainSusceptibility(a){Ed.set(this.data,a)}get immobile(){return!!Fd.get(this.data)}set immobile(a){Fd.set(this.data,a?1:0)}get action(){return Gd.get(this.data)}set action(a){Gd.set(this.data,
a)}get replacement(){return Hd.get(this.data)}set replacement(a){Hd.set(this.data,a)}get goldDrop(){return Id.get(this.data)}set goldDrop(a){Id.set(this.data,a)}get elements(){return Jd.get(this.data)}set elements(a){Jd.set(this.data,a)}get expReward(){return Kd.get(this.data)}set expReward(a){Kd.set(this.data,a)}get attackType(){return Ld.get(this.data)}set attackType(a){Ld.set(this.data,a)}get statusEffect(){return Md.get(this.data)}set statusEffect(a){Md.set(this.data,a)}toString(){return super.toString()+
(this.name?" "+this.name:"")}}function Nd(...a){return new Od(...a)}class Od{constructor(...a){this.spec=a}get(a){let b=0;for(const [c,d=255,e=0]of this.spec)b|=(a[c-768>>>5]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b}set(a,b){for(const [c,d=255,e=0]of this.spec){const f=c-768>>>5;a[f]=a[f]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d}}}
const ud=Nd([768]),vd=Nd([832,15]),wd=Nd([928,240,4]),xd=Nd([1056,64,2],[928,15]),yd=Nd([960]),zd=Nd([992]),Ad=Nd([1024]),Bd=Nd([1056,31]),Cd=Nd([1056,128,7]),Dd=Nd([1088]),Ed=Nd([1120]),Fd=Nd([1184,128,7]),Gd=Nd([1184,127]),Hd=Nd([1216]),Id=Nd([1280,240,4]),Jd=Nd([1280,15]),Kd=Nd([1312]),Ld=Nd([1344]),Md=Nd([1376,15]);class F extends td{constructor(a,b){super(a,b.id,b.displayName);a=b.scaling;var c=((24>a?1+a/3:(a+12)/4)+this.level)/2;a:{var d=this.elements;d=void 0===d?0:d;var e=10>a?1:18>a?2:38>a?4:8;for(var f=e;f;f>>>=1)if(!(f&d)){d=f<<1;break a}d=e<<1}d=c+d;this.hits=(this.hp+1)/(d-this.def);this.sdef=this.def/d;c=Math.min(255,Math.max(16,32+16*c));d=this.atk;e=24>a?1+a/3:(a+12)/4;f=this.attackType?Pd(a,2,[6,6],[18,8],[25,12],[30,18],[37,24],[42,32]):Pd(a,2,[6,6],[18,10],[25,14],[30,18],[40,24],[46,32]);this.satk=
(d-(e+f))/c;this.extraDifficulty=b.difficulty||0;this.monsterClass=b.class;c=this.expReward;c=(128>c?c:(c&127)<<4)/Math.pow(2,a/5-1);a=Qd[this.goldDrop]/Math.pow(2,a/7-1);this.type=b.type||"monster";this.wealth=a&&a/(c+a)}isBoss(){return"boss"===this.type}isProjectile(){return"projectile"===this.type}isBird(){const a=this.rom.objectActions[this.action];return(null===a||void 0===a?void 0:a.data.bird)||!1}isFlyer(){const a=this.rom.objectActions[this.action];return(null===a||void 0===a?void 0:a.data.bird)||
(null===a||void 0===a?void 0:a.data.moth)||!1}placement(){var a,b;return null!==(b=null===(a=this.rom.objectActions[this.action])||void 0===a?void 0:a.data.placement)&&void 0!==b?b:"normal"}clearance(){var a;return(null===(a=this.rom.objectActions[this.action])||void 0===a?0:a.data.large)?6:3}totalDifficulty(){return this.toughness()+this.attack()+this.statusDifficulty()+this.immunities()+this.movement()}collectDifficulty(a,b){let c=a(this);var d=this.spawnedChild();d instanceof F&&(c=b(c,d.collectDifficulty(a,
b)));d=this.spawnedReplacement();d instanceof F&&(c=b(c,d.collectDifficulty(a,b)));return c}toughness(){return this.collectDifficulty(a=>Pd(a.hits,0,[2,1],[3,2],[5,3],[7,4],[10,5],[13,6]),Math.max)}attack(){return this.collectDifficulty(a=>a.attackType&&a.statusEffect?0:Pd(a.satk,0,[.04,1],[.08,2],[.13,3],[.18,4],[.25,5],[.33,6]),Math.max)}addStatusEffects(a){this.attackType&&this.statusEffect?a.add(this.statusEffect):!this.attackType&&this.poison&&a.add(0);var b=this.spawnedReplacement();b instanceof
F&&b.addStatusEffects(a);b=this.spawnedChild();b instanceof F&&b.addStatusEffects(a)}statusDifficulty(){const a=new Set;this.addStatusEffects(a);let b=0;for(const c of a)b+=Rd[c];return b}immunities(){let a=0,b=this.elements;for(;b;)b&1&&a++,b>>>=1;return a&&1<<a-1}movement(){return this.collectDifficulty(a=>{const b=this.rom.objectActions[a.action],c=a.spawnedChild();a=a.extraDifficulty;b&&(a+=b.data.movement||0,b.data.large&&a++,c&&!c.statusEffect&&(a+=b.data.projectile||0));167===this.metasprite&&
(a+=2);return a},(a,b)=>a+b)}totalReward(){return this.totalDifficulty()/4}normalizedGold(){if(!this.wealth)return 0;const a=this.totalDifficulty()*this.wealth*.6;return Math.max(1,Math.min(15,Math.round(a)))}normalizedExp(){if(1===this.wealth)return 0;const a=.488+this.totalDifficulty()*(1-this.wealth)*.256;return Math.max(1,Math.min(255,Math.round(32*a)))}toString(){return`Monster $${x(this.id)} ${this.name}`}}const Rd=[2,1,3,2,4],Qd=[0,1,2,4,8,16,30,50,100,200,400,50,100,200,400,500];
function Pd(a,b,...c){for(let b=c.length-1;0<=b;b--){const [d,f]=c[b];if(a>=d)return f}return b};class Sd{constructor(a,b,c=!1){this.rom=a;this.flagset=b;this.tracker=c;this.terrainFactory=new oc(this.rom);this.terrains=new Map;this.checks=new ba(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new ba(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new hd;this.neighbors=new ba(()=>0);this.routes=new ba(()=>new C.Builder);this.routeEdges=new ba(()=>new ea);this.requirementMap=new ba(a=>new C.Builder(a));this.limeTreeEntranceLocation=-1;for(const b of a.items)for(const a of b.itemUseData)"expect"===
a.kind?this.itemUses.get(a.want).push([b,a]):"location"===a.kind&&this.itemUses.get(~a.want).push([b,a]);this.aliases=new Map([[a.flags.ChangeAkahana,a.flags.Change],[a.flags.ChangeSoldier,a.flags.Change],[a.flags.ChangeStom,a.flags.Change],[a.flags.ChangeWoman,a.flags.Change],[a.flags.ParalyzedKensuInDanceHall,a.flags.Paralysis],[a.flags.ParalyzedKensuInTavern,a.flags.Paralysis]]);b.assumeTriggerGlitch()&&(this.seamlessExits.add=()=>this.seamlessExits);for(const b of a.locations)this.processLocation(b);
this.addExtraChecks();this.unionNeighbors();this.recordExits();this.buildNeighbors();this.addAllRoutes();this.consolidateChecks();this.buildRequirementMap()}addExtraChecks(){const {locations:{Leaf_ToolShop:a,MezameShrine:b,Oak:c,Shyron_ToolShop:d},flags:{AbleToRideDolphin:e,BallOfFire:f,BallOfThunder:g,BallOfWater:h,BallOfWind:k,Barrier:p,BlizzardBracelet:q,BowOfMoon:t,BowOfSun:A,BreakStone:D,BreakIce:z,BreakIron:I,BrokenStatue:X,BuyHealing:T,BuyWarp:R,ClimbWaterfall:U,ClimbSlope8:Xa,ClimbSlope9:wa,
ClimbSlope10:Tb,CrossPain:ob,CurrentlyRidingDolphin:gb,Flight:Ta,FlameBracelet:Jb,FormBridge:xb,GasMask:hb,GlowingLamp:ib,InjuredDolphin:ac,LeadingChild:pc,LeatherBoots:qc,Money:jb,OpenedCrypt:jd,RabbitBoots:kb,Refresh:rc,RepairedStatue:Kb,RescuedChild:Nc,ShellFlute:sc,ShieldRing:Oc,ShootingStatue:tc,ShootingStatueSouth:uc,StormBracelet:kd,Sword:Pa,SwordOfFire:vc,SwordOfThunder:wc,SwordOfWater:xc,SwordOfWind:bc,TornadoBracelet:ld,TravelSwamp:Pc,TriggerSkip:Lb,WildWarp:L},items:{MedicalHerb:Ua,WarpBoots:yb}}=
this.rom,ta=this.entrance(b);var lb=this.entrance(c);this.addCheck([ta],Td(t,A),[jd.id]);this.addCheck([ta],Td(e,sc),[gb.id]);this.addCheck([lb],Td(pc),[Nc.id]);this.addItemCheck([ta],Td(ib,X),Kb.id,{lossy:!0,unique:!0});for(var Ha of this.rom.shops)if(Ha.location!==a.id&&Ha.location!==d.id&&Ha.used&&Ha.type===ad.TOOL){lb=[ic(Ha.location<<16|136)];for(var Ab of Ha.contents)Ab===Ua.id?this.addCheck(lb,jb.r,[T.id]):Ab===yb.id&&this.addCheck(lb,jb.r,[R.id])}Ha=bc.r;Ab=vc.r;lb=xc.r;let yc=wc.r;if(!this.flagset.orbsOptional()){var cc=
Ud(k,ld);const a=Ud(f,Jb),b=Ud(h,q),c=Ud(g,kd);Ha=C.meet(Ha,cc);Ab=C.meet(Ab,a);lb=C.meet(lb,b);yc=C.meet(yc,c);if(this.flagset.assumeSwordChargeGlitch()){cc=function(b){return a.map(a=>a[0]===b.c?a:[b.c,...a])};const a=C.or(Ha,Ab,lb,yc);Ha=cc(bc);Ab=cc(vc);lb=cc(xc);yc=cc(wc)}}this.addCheck([ta],Ha,[D.id]);this.addCheck([ta],Ab,[z.id]);this.addCheck([ta],lb,[xb.id]);this.addCheck([ta],yc,[I.id]);this.addCheck([ta],Ud(bc,vc,xc,wc),[Pa.id]);this.addCheck([ta],Ta.r,[U.id,Tb.id]);this.addCheck([ta],
Ud(Ta,kb),[Xa.id]);this.addCheck([ta],Ud(Ta,kb),[wa.id]);this.addCheck([ta],p.r,[tc.id,uc.id]);this.addCheck([ta],hb.r,[Pc.id]);Ha=this.flagset.changeGasMaskToHazmatSuit()?hb:qc;this.addCheck([ta],Ud(Ta,kb,Ha),[ob.id]);this.flagset.leatherBootsGiveSpeed()&&this.addCheck([ta],qc.r,[Xa.id]);this.flagset.assumeGhettoFlight()&&this.addCheck([ta],Td(gb,kb),[U.id]);this.flagset.fogLampNotRequired()&&(Ha=this.flagset.requireHealedDolphinToRide(),this.addCheck([ta],Ha?ac.r:[[]],[e.id]));this.flagset.guaranteeBarrier()||
this.addCheck([ta],[[jb.c,T.c],[jb.c,Oc.c],[jb.c,rc.c]],[tc.id,uc.id]);this.flagset.assumeFlightStatueSkip()&&this.addCheck([ta],[[jb.c,Ta.c]],[tc.id]);this.flagset.guaranteeGasMask()||this.addCheck([ta],[[jb.c,T.c],[jb.c,rc.c]],[Pc.id,ob.id]);this.flagset.assumeWildWarp()&&this.addCheck([ta],C.OPEN,[L.id]);this.flagset.assumeTriggerGlitch()&&(this.addCheck([ta],C.OPEN,[Lb.id]),this.addCheck([ta],Lb.r,[ob.id,Xa.id,wa.id]))}addExtraRoutes(){var a;const {flags:{BuyWarp:b,SwordOfThunder:c,Teleport:d,
WildWarp:e},locations:{MezameShrine:f}}=this.rom;this.addRoute(new mc(this.entrance(f),[]));if(this.flagset.teleportOnThunderSword()){var g=this.rom.townWarp.thunderSwordWarp;this.addRoute(new mc(this.entrance(g[0],g[1]&31),[c.c,b.c]));this.addRoute(new mc(this.entrance(g[0],g[1]&31),[c.c,d.c]))}if(this.flagset.assumeWildWarp())for(const b of this.rom.wildWarp.locations){if(b===this.rom.locations.UndergroundChannel.id)continue;g=this.entrance(b);const c=null!==(a=this.terrains.get(g))&&void 0!==a?
a:cb("bad entrance");for(const a of c.enter)this.addRoute(new mc(g,[e.c,...a]))}}consolidateChecks(){for(const [a,b]of this.checks){const c=this.tiles.find(a);if(a!==c){for(const a of b)this.checks.get(c).add(a);this.checks.delete(a)}}}buildRequirementMap(){for(const [a,b]of this.checks)for(const {checks:c,requirement:d}of b)for(const b of c){const c=this.requirementMap.get(b);for(const b of d)for(const d of this.routes.get(a)||[])c.addList([...b,...d])}}getLocationList(a="Crystalis"){return{worldName:a,
requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:a=>this.rom.flags[a].name,prefill:a=>{const {Crystalis:b,MesiaInTower:d,LeafElder:e}=this.rom.flags,f=new Map([[d.id,b.id]]);this.flagset.guaranteeSword()&&f.set(e.id,512|a.nextInt(4));return f}}}processLocation(a){a.used&&(this.processLocationTiles(a),this.processLocationSpawns(a),this.processLocationItemUses(a))}unionNeighbors(){for(const [b,c]of this.terrains){var a=ic.add(b,0,1);this.terrains.get(a)===c&&this.tiles.union([b,
a]);a=ic.add(b,1,0);this.terrains.get(a)===c&&this.tiles.union([b,a])}}addAllRoutes(){this.addExtraRoutes();for(const [b,c]of this.neighbors){const [d,e]=Mc.split(b);var a=this.terrains.get(d);const f=this.terrains.get(e);if(!a||!f)throw Error(`missing terrain ${x(a?d:e)}`);for(const [b,h]of a.exit)if(b&c)for(const a of h)for(const b of f.enter)this.addRoute(new mc(e,[...a,...b]),d)}"object"===typeof document&&(a=document.getElementById("debug"))&&a.appendChild((new Wc(this.rom,this.getWorldData())).element)}getWorldData(){var a=
0;const b=new ba(()=>({})),c=w(256,()=>({areas:new Set,tiles:new Set})),d=[];for(var e of this.tiles.sets()){var f=this.tiles.find(ca.first(e)),g=this.terrains.get(f);if(g&&(f=this.routes.has(f)?C.freeze(this.routes.get(f)):[],f.length)){g={checks:[],id:a++,locations:new Set,routes:f,terrain:g,tiles:new Set};d.push(g);for(const a of e)f=a>>>16,g.locations.add(f),g.tiles.add(a),c[f].areas.add(g),c[f].tiles.add(a),b.get(a).area=g}}for(const [a,c]of this.exits)b.has(a)&&(b.get(a).exit=c);for(const [c,
d]of this.checks)if(a=b.get(c).area)for(const {checks:b,requirement:c}of d)for(const d of b)e=this.rom.flags[d]||cb(),a.checks.push([e,c]);return{tiles:b,areas:d,locations:c}}addRoute(a,b){if(null!=b){this.routeEdges.get(b).add(a);for(var c of this.routes.get(b))this.addRoute(new mc(a.target,[...c,...a.deps]))}else for(b=new ea,c=new ea,b.add(a),a=b[Symbol.iterator]();;){const {value:d,done:e}=a.next();if(e)break;c.add(d);b.delete(d);const f=new ea,g=d.target;if(this.routes.get(g).addRoute(d))for(const a of this.routeEdges.get(g))f.add(new mc(a.target,
[...d.deps,...a.deps]));for(const a of f)c.has(a)||(b.delete(a),b.add(a))}}recordExits(){for(const [a,b]of this.exits)this.exitSet.add(Mc.of(this.tiles.find(a),this.tiles.find(b)));for(const a of this.exitSet){const [b,c]=Mc.split(a);if(this.terrains.get(b)!==this.terrains.get(c))continue;const d=Mc.of(c,b);this.exitSet.has(d)&&(this.tiles.union([b,c]),this.exitSet.delete(a),this.exitSet.delete(d))}}buildNeighbors(){for(const [c,d]of this.terrains)if(d){var a=ic.add(c,1,0),b=this.terrains.get(a);
b&&b!==d&&this.handleAdjacentNeighbors(c,a,hc.North);a=ic.add(c,0,1);(b=this.terrains.get(a))&&b!==d&&this.handleAdjacentNeighbors(c,a,hc.West)}for(const b of this.exitSet){const [c,e]=Mc.split(b);this.terrains.has(c)&&this.terrains.has(e)&&(a=Mc.of(this.tiles.find(c),this.tiles.find(e)),this.neighbors.set(a,this.neighbors.get(a)|1))}}handleAdjacentNeighbors(a,b,c){var d=this.tiles.find(a);const e=this.tiles.find(b);this.seamlessExits.has(b)||(b=Mc.of(e,d),this.neighbors.set(b,this.neighbors.get(b)|
1<<c));this.seamlessExits.has(a)||(a=c^2,d=Mc.of(d,e),this.neighbors.set(d,this.neighbors.get(d)|1<<a))}processLocationTiles(a){var b,c,d,e=new Map;const f=new Set,g=88===(a.id&248);for(var h of a.spawns)if(h.isWall())e.set(nc.from(a,h),h.id&3);else if(h.isMonster()&&63===h.id){var k=ic(nc.from(a,h)<<8|h.yt<<4);for(var p=4;11>=p;p++)for(var q=-3;3>=q;q++)f.add(ic.add(k,q,p))}h=this.rom.tilesets[a.tileset];const t=this.rom.tileEffects[a.tileEffects-179],A=b=>t.effects[this.rom.screens[a.screens[(b&
61440)>>>12][(b&3840)>>>8]].tiles[b&255]];k=(b,c,d)=>{b&=Hc.BITS;26===a.id&&(b|=Hc.SWAMP);if(96===a.id||104===a.id)b|=Hc.DOLPHIN;100===a.id&&4144>(c&61680)&&(b|=Hc.DOLPHIN);d&&(b|=Hc.BARRIER);if(!(b&Hc.DOLPHIN)&&b&Hc.SLOPE){d=c;let a=0;for(;A(d)&Hc.SLOPE;)d=ic.add(d,1,0),a++;6>a?b&=~Hc.SLOPE:9>a?b|=Hc.SLOPE8:10>a&&(b|=Hc.SLOPE9)}if(b&Hc.PAIN)for(const a of[[0,1],[1,0],[0,-1],[-1,0]])if(!(A(ic.add(c,...a))&(Hc.PAIN|Hc.FLY))){b&=~Hc.PAIN;break}return this.terrainFactory.tile(b)};for(let A=0,R=a.height;A<
R;A++){p=a.screens[A];q=a.id<<8|A<<4;for(let A=0,T=a.width;A<T;A++){const T=this.rom.screens[p[A]],R=nc(q|A),U=R&255;var D=e.get(R);D=g?this.rom.flags.AlwaysTrue.id:null!=D?this.wallCapability(D):null===(b=a.flags.find(a=>a.screen===U))||void 0===b?void 0:b.flag;var z=a.pits.find(a=>a.fromScreen===R);z&&this.exits.set(ic(R<<8|136),ic(z.toScreen<<8|136));z=null!==(d=null===(c=this.rom.flags[D])||void 0===c?void 0:c.logic)&&void 0!==d?d:{};for(let b=0;240>b;b++){const c=ic(R<<8|b);var I=T.tiles[b];
z.assumeTrue&&32>I&&(I=h.alternates[I]);var X=a.isShop()?0:t.effects[I];const d=f.has(c);X=k(X,c,d);32>I&&h.alternates[I]!==I&&null!=D&&!z.assumeTrue&&!z.assumeFalse&&(I=k(t.effects[h.alternates[I]],c,d))&&(X=this.terrainFactory.flag(X,z.track?D:-1,I));X&&this.terrains.set(c,X)}}}for(const f of a.exits){const {dest:g,entrance:h}=f;b=ic.from(a,f);f.isSeamless()?(c=ic(b&65535|g<<16),d=ic.from(a,f),this.seamlessExits.add(d),(e=this.terrains.get(d))&&this.terrains.set(d,this.terrainFactory.seamless(e))):
c=this.entrance(this.rom.locations[g],h&31);this.exits.set(b,c);g===this.rom.locations.LimeTreeLake.id&&160<this.rom.locations.LimeTreeLake.entrances[h].y&&(this.limeTreeEntranceLocation=a.id)}}processLocationSpawns(a){for(const b of a.spawns)b.isTrigger()?this.processTrigger(a,b):b.isNpc()?this.processNpc(a,b):b.isBoss()?this.processBoss(a,b):b.isChest()?this.processChest(a,b):b.isMonster()?this.processMonster(a,b):3===b.type&&224===b.id&&this.processKeyUse(jc.screen(ic.from(a,b)),this.rom.flags.UsedWindmillKey.r)}processTrigger(a,
b){var c=this.rom.trigger(b.id);if(!c)throw Error(`Missing trigger ${b.id.toString(16)}`);const d=this.filterRequirements(c.conditions);let e=this.filterAntiRequirements(c.conditions);const f=ic.from(a,b);let g=jc.trigger(a,b);const h=[];for(const a of c.flags){const b=this.flag(a);(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}h.length&&this.addCheck(g,d,h);switch(c.message.action){case 25:134!==c.id||this.flagset.assumeRabbitSkip()?186!==c.id||this.flagset.assumeTeleportSkip()||this.flagset.disableTeleportSkip()||
(g=jc.atLocation(g,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)):g=jc.adjust(g,[0,-1],[0,1]);this.flagset.assumeTriggerGlitch()&&(e=C.or(e,this.rom.flags.TriggerSkip.r));this.addTerrain(g,this.terrainFactory.statue(e));break;case 29:this.addBossCheck(g,this.rom.bosses.Mado1,d);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(g,d,c.id);break;case 24:c=this.flagset.chargeShotsOnly()?C.meet(d,Td(this.rom.flags.WarpBoots)):d;this.addItemCheck(g,c,this.rom.flags.StomFightReward.id,
{lossy:!0,unique:!0});break;case 30:this.addItemCheck(g,d,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(f,a,d);break;case 27:a===this.rom.locations.Portoa_PalaceEntrance&&(g=jc.adjust(g,[-2,0]),e=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(g,a,e)}for(const [c,d]of this.itemUses.get(b.type<<8|b.id))this.processItemUse([ic.from(a,b)],C.OPEN,c,d)}processNpc(a,b){var c,d,e;const f=this.rom.npcs[b.id];if(!f||!f.used)throw Error(`Unknown npc: ${x(b.id)}`);
const g=f.spawnConditions.get(a.id)||[];var h=this.filterRequirements(g),k=ic.from(a,b);k=[this.terrains.has(k)?k:null!==(c=this.walkableNeighbor(k))&&void 0!==c?c:k];for(const [a,c]of this.itemUses.get(b.type<<8|b.id))this.processItemUse(k,h,a,c);f===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(k,this.rom.bosses.Sabera1,h);f.data[2]&4&&!this.flagset.assumeStatueGlitch()&&(b=this.filterAntiRequirements(g),f===this.rom.npcs.Rage?(k=jc.adjust(k,[2,-1],[2,0],[2,1],[2,2]),k=jc.adjust(k,[0,
-6],[0,-2],[0,2],[0,6])):f===this.rom.npcs.PortoaThroneRoomBackDoorGuard?b=C.or(this.rom.flags.MesiaRecording.r,Td(this.rom.flags.Paralysis,this.rom.flags.QueenNotInThroneRoom)):f===this.rom.npcs.SoldierGuard&&(b=void 0),b&&this.addTerrain(k,this.terrainFactory.statue(b)));f===this.rom.npcs.FortuneTeller&&(k=jc.adjust(k,[0,0],[2,0]));if(!C.isClosed(h)){[[...h]]=h;for(const a of f.globalDialogs){b=this.flag(~a.condition);c=this.flag(a.condition);if((null===b||void 0===b?0:b.logic.assumeFalse)||(null===
c||void 0===c?0:c.logic.assumeTrue))return;(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}a=null!==(e=null!==(d=f.localDialogs.get(a.id))&&void 0!==d?d:f.localDialogs.get(-1))&&void 0!==e?e:[];for(const b of a){d=[...h];e=this.flag(b.condition);a=this.flag(~b.condition);(null===e||void 0===e?0:e.logic.track)&&d.push(e.id);(null===e||void 0===e?0:e.logic.assumeFalse)||(null===a||void 0===a?0:a.logic.assumeTrue)||this.processDialog(k,f,d,b);if((null===e||void 0===e?0:e.logic.assumeTrue)||(null===
a||void 0===a?0:a.logic.assumeFalse))break;(null===a||void 0===a?0:a.logic.track)&&h.push(a.id)}}}processDialog(a,b,c,d){this.addCheckFromFlags(a,[c],d.flags);const e={lossy:!0,unique:!0};switch(d.message.action){case 8:this.processKeyUse(a,[c]);break;case 20:this.addItemCheck(a,[c],this.rom.flags.SlimedKensu.id,e);break;case 16:this.addItemCheck(a,[c],this.rom.flags.AsinaInBackRoom.id,e);break;case 17:this.addItemCheck(a,[c],256|b.data[1],e);break;case 3:case 10:this.addItemCheck(a,[c],256|b.data[0],
e);break;case 9:b=b.data[1];255!==b&&this.addItemCheck(a,[c],256|b,e);break;case 25:this.addItemCheck(a,[c],this.rom.flags.AkahanaFluteOfLimeTradein.id,e);break;case 26:this.addItemCheck(a,[c],this.rom.flags.Rage.id,e)}}processLocationItemUses(a){for(const [b,c]of this.itemUses.get(~a.id))this.processItemUse([this.entrance(a)],C.OPEN,b,c)}handleMovingGuard(a,b,c){if(!this.flagset.assumeStatueGlitch()){var d=[];for(const a of b.spawns.slice(0,2))if(a.isNpc()&&this.rom.npcs[a.id].isParalyzable()){d.push([this.rom.flags.Paralysis.c]);
break}this.flagset.assumeTriggerGlitch()&&d.push([this.rom.flags.TriggerSkip.c]);this.addTerrain(a,this.terrainFactory.statue([...c,...d].map(da)))}}handleBoat(a,b,c){const d=this.walkableNeighbor(a);if(null==d)throw Error("Could not find walkable neighbor.");var e=a>>8&240|a>>4&15;a=a>>4&240|a&15;var f;for(const c of b.exits)c.yt===e&&c.xt<a&&(f=c);if(!f)throw Error("Could not find boat exit");b=this.rom.locations[f.dest];if(!b)throw Error("Bad destination");for(e=f=ic.from(b,b.entrances[f.entrance]);;)if(e=
ic.add(e,0,-1),b=this.walkableNeighbor(e),null!=b){c={enter:C.freeze(c),exit:[[15,C.OPEN]]};this.addTerrain([d],c);this.exits.set(d,b);this.exitSet.add(Mc.of(d,b));this.exits.set(f,b);this.exitSet.add(Mc.of(f,b));this.terrains.set(f,this.terrainFactory.tile(0));break}}addItemGrantChecks(a,b,c){const d=this.itemGrant(c),e=256|d;if(null==d)throw Error(`missing item grant for ${c.toString(16)}`);this.addItemCheck(a,b,e,{lossy:!0,unique:!0,preventLoss:128<=c})}addTerrain(a,b){for(const c of a)a=this.terrains.get(c),
null!=a&&this.terrains.set(c,this.terrainFactory.meet(a,b))}addCheck(a,b,c){if(!C.isClosed(b)){b={requirement:C.freeze(b),checks:c};for(const c of a)this.terrains.has(c)&&this.checks.get(c).add(b)}}addItemCheck(a,b,c,d){this.addCheck(a,b,[c]);this.slots.set(c,d);a=this.rom.itemGets[this.rom.slots[c&255]];b=this.rom.items[a.itemId];c=null===b||void 0===b?void 0:b.unique;d=a.isLosable();const e=c||b===this.rom.items.OpelStatue;let f=1;b===this.rom.items.SwordOfWind&&(f=5);b===this.rom.items.SwordOfFire&&
(f=5);b===this.rom.items.SwordOfWater&&(f=10);b===this.rom.items.SwordOfThunder&&(f=15);b===this.rom.items.Flight&&(f=15);this.items.set(512|a.id,{unique:c,losable:d,preventLoss:e,weight:f})}addCheckFromFlags(a,b,c){const d=[];for(const a of c)c=this.flag(a),(null===c||void 0===c?0:c.logic.track)&&d.push(c.id);d.length&&this.addCheck(a,b,d)}walkableNeighbor(a){if(this.isWalkable(a))return a;for(let b of[-1,1]){const c=ic.add(a,b,0),d=ic.add(a,0,b);if(this.isWalkable(c))return c;if(this.isWalkable(d))return d}}isWalkable(a){return!(this.getEffects(a)&
Hc.BITS)}ensurePassable(a){var b;return this.isWalkable(a)?a:null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}getEffects(a){const b=this.rom.locations[a>>>16];return this.rom.tileEffects[b.tileEffects-179].effects[this.rom.screens[b.screens[(a&61440)>>>12][(a&3840)>>>8]].tiles[a&255]]}processBoss(a,b){if(201!==b.id&&202!==b.id){var c=195===b.id,d=c?this.rom.bosses.Rage:this.rom.bosses.fromLocation(a.id);b=ic.from(a,b);if(!d||!d.flag)throw Error(`Bad boss at ${a.name}`);var e=b&-256;a=this.terrainFactory.boss(d.flag.id,
c);c=w(240,a=>e|a);this.addTerrain(c,a);this.addBossCheck(c,d)}}addBossCheck(a,b,c=C.OPEN){if(null==b.flag)throw Error(`Expected a flag: ${b}`);c=C.meet(c,this.bossRequirements(b));b===this.rom.bosses.Draygon2?this.addCheck(a,c,[b.flag.id]):this.addItemCheck(a,c,b.flag.id,{lossy:!1,unique:!0})}processChest(a,b){if(!(112<=this.rom.slots[b.id])){var c=256|b.id,d=this.rom.slots[b.id];112<=d||(d=this.rom.items[d],d=this.flagset.preserveUniqueChecks()?!(null===d||void 0===d||!d.unique):!0,this.addItemCheck([ic.from(a,
b)],C.OPEN,c,{lossy:!1,unique:d}))}}processMonster(a,b){const c=this.rom.objects[b.monsterId];if(c instanceof F){var {Money:d,RageSkip:e,Sword:f,SwordOfWind:g,SwordOfFire:h,SwordOfWater:k,SwordOfThunder:p}=this.rom.flags;a.id===this.limeTreeEntranceLocation&&c.isBird()&&this.flagset.assumeRageSkip()&&this.addCheck([this.entrance(a)],C.OPEN,[e.id]);c.goldDrop&&(a=[ic.from(a,b)],this.flagset.guaranteeMatchingSword()?(b=[g,h,k,p].filter((a,b)=>c.elements&1<<b),this.addCheck(a,Ud(...b),[d.id])):this.addCheck(a,
f.r,[d.id]))}}processItemUse(a,b,c,d){a=new Set([...a].map(a=>{var b;return null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}));const e=[[512|c.id]];c.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&e[0].push(this.rom.flags.Change.c);c===this.rom.items.MedicalHerb&&(e[0][0]=this.rom.flags.BuyHealing.c);b=C.meet(b,e);this.addCheckFromFlags(a,b,d.flags);switch(d.message.action){case 16:this.processKeyUse(a,b);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(a,
b,c.id);break;case 2:this.addItemCheck(a,b,256|this.rom.npcs[d.want&255].data[1],{lossy:!0,unique:!0})}}processKeyUse(a,b){const [c,...d]=new Set([...a].map(a=>nc.from(a)));if(null==c||d.length)throw Error("Expected one screen");const e=this.rom.locations[c>>>8].flags.find(a=>a.screen===(c&255));if(null==e)throw Error("Expected flag on screen");this.addCheck(a,b,[e.flag])}bossRequirements(a){if(a===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];
var b=a.object;const c=new C.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())c.addAll(this.rom.flags.Sword.r);else{var d=this.flagset.guaranteeSwordMagic()?a.swordLevel:1;b=this.rom.objects[b];for(let a=0;4>a;a++)b.isVulnerable(a)&&c.addAll(this.swordRequirement(a,d))}d=[];null!=a.npc&&null!=a.location&&(b=a.npc.spawns(this.rom.locations[a.location]),d.push(...this.filterRequirements(b)[0]));a===this.rom.bosses.Insect?d.push(this.rom.flags.InsectFlute.c,
this.rom.flags.GasMask.c):a===this.rom.bosses.Draygon2&&d.push(this.rom.flags.BowOfTruth.c);this.flagset.guaranteeRefresh()&&d.push(this.rom.flags.Refresh.c);c.restrict([d]);return C.freeze(c)}swordRequirement(a,b){const c=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][a];if(1===b)return c.r;a=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,
this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][a];return 3===b?Td(c,...a):a.map(a=>[c.c,a.c])}itemGrant(a){for(const [b,c]of this.rom.itemGets.actionGrants)if(b===a)return c;throw Error(`Could not find item grant ${a.toString(16)}`);}filterRequirements(a){var b;const c=[];for(const d of a)if(0>d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeTrue)return C.CLOSED}else{a=this.flag(d);if(null===a||void 0===a?0:a.logic.assumeFalse)return C.CLOSED;
(null===a||void 0===a?0:a.logic.track)&&c.push(a.id)}return[c]}filterAntiRequirements(a){var b;const c=[];for(const d of a)if(0<=d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeFalse)return C.OPEN}else{a=this.flag(~d);if(null===a||void 0===a?0:a.logic.assumeTrue)return C.OPEN;(null===a||void 0===a?0:a.logic.track)&&c.push([a.id])}return c}flag(a){var b;a=this.rom.flags[a];return null!==(b=this.aliases.get(a))&&void 0!==b?b:a}entrance(a,b=0){"number"===typeof a&&
(a=this.rom.locations[a]);return this.tiles.find(ic.from(a,a.entrances[b]))}wallCapability(a){switch(a){case Qc.WIND:return this.rom.flags.BreakStone.id;case Qc.FIRE:return this.rom.flags.BreakIce.id;case Qc.WATER:return this.rom.flags.FormBridge.id;case Qc.THUNDER:return this.rom.flags.BreakIron.id;default:throw Error(`bad wall type: ${a}`);}}}function Td(...a){return[a.map(a=>a.id)]}function Ud(...a){return a.map(a=>[a.id])};class Vd extends ec{constructor(){super(...arguments);this.x=this.prop([0],[1,255,-8]);this.y=this.prop([2],[3,255,-8]);this.screen=this.prop([3,15,-4],[1,15]);this.tile=this.prop([2,240],[0,240,4]);this.coord=this.prop([2,255,-8],[0,255])}get used(){return 8>this.data[1]}toString(){return`Entrance ${this.hex()}: (${x(this.y)}, ${x(this.x)})`}}Vd.size=4;
class Wd extends ec{constructor(){super(...arguments);this.x=this.prop([0,255,-4]);this.xt=this.prop([0]);this.y=this.prop([1,255,-4]);this.yt=this.prop([1]);this.screen=this.prop([1,240],[0,240,4]);this.tile=this.prop([1,15,-4],[0,15]);this.coord=this.prop([1,15,-12],[0,15,-4]);this.dest=this.prop([2]);this.entrance=this.prop([3])}isSeamless(){return!!(this.entrance&32)}toString(){return`Exit ${this.hex()}: (${x(this.y)}, ${x(this.x)}) => ${this.dest}:${this.entrance}`}}Wd.size=4;
class Xd extends ec{constructor(){super(...arguments);this.x=this.prop([1,7,-8]);this.xs=this.prop([1,7]);this.y=this.prop([1,240,-4]);this.ys=this.prop([1,240,4]);this.screen=this.prop([1])}get flag(){return this.data[0]|512}set flag(a){if(512!==(a&-256))throw Error(`bad flag: ${x(a)}`);this.data[0]=a&255}toString(){return`Flag ${this.hex()}: ${x(this.screen)} @ ${x(this.flag)}`}}Xd.size=2;
class Yd extends ec{constructor(){super(...arguments);this.fromXs=this.prop([1,112,4]);this.toXs=this.prop([1,7]);this.fromYs=this.prop([3,240,4]);this.toYs=this.prop([3,15]);this.fromScreen=this.prop([3,240],[1,112,4]);this.toScreen=this.prop([3,15,-4],[1,7]);this.dest=this.prop([0])}toString(){return`Pit ${this.hex()}: (${x(this.fromXs)}, ${x(this.fromYs)}) => ${x(this.dest)}:(${x(this.toXs)}, ${x(this.toYs)})`}}Yd.size=4;
class Zd extends ec{constructor(){super(...arguments);this.y=this.prop([0,255,-4]);this.yt=this.prop([0]);this.x=this.prop([1,127,-4],[2,64,3]);this.xt=this.prop([1,127]);this.timed=this.booleanProp(1,7);this.screen=this.prop([0,240],[1,112,4]);this.tile=this.prop([0,15,-4],[1,15]);this.coord=this.prop([0,15,-12],[1,15,-4],[2,64,3]);this.type=this.prop([2,7]);this.id=this.prop([3]);this.patternBank=this.prop([2,128,7])}get used(){return 254!==this.data[0]}set used(a){this.data[0]=a?0:254}[Symbol.iterator](){return this.used?
super[Symbol.iterator]():[254,0,0,0][Symbol.iterator]()}get monsterId(){return this.id+80&255}set monsterId(a){this.id=a-80&255}isChest(){return 2===this.type&&128>this.id}isInvisible(){return this.isChest()&&!!(this.data[2]&32)}isTrigger(){return 2===this.type&&128<=this.id}isNpc(){return 1===this.type&&192>this.id}isBoss(){return 1===this.type&&192<=this.id}isMonster(){return 0===this.type}isGeneric(){return 4===this.type}isWall(){return!(3!==this.type||!(4>this.id||this.data[2]&32))}isShootingWall(a){return this.isWall()&&
!!(this.data[2]&32?this.data[2]&16:143===a.id||168===a.id)}wallType(){if(3!==this.type)return"";const a=this.data[2]&32?this.id>>>4:this.id;return 4<=a?"":2===a?"bridge":"wall"}wallElement(){return this.isWall()?this.id&3:-1}toString(){return`Spawn ${this.hex()}: (${x(this.x)}, ${x(this.y)}) ${this.timed?"timed":"fixed"} ${this.type}:${x(this.id)}`}}Zd.size=4;function $d(a,b){return a-b-((a>>>4)-(b>>>4))}
function ae(a,...b){for(const c of b){const d=c%15;b=(a>>4)+(c-d)/15;a=(a&15)+d;0>a?(b--,a=15+a):15<=a&&(b++,a-=15);a|=b<<4}return a};class be{constructor(a,b,c,d){this.id=a;this.tileset=b;this.customFlags=new Map;this.freeFlags=new Set;this._pos=void 0;this._exits=new ka;this._pits=new Map;this.rom=b.rom;this._height=c;this._width=d;this._screens=Array(c<<4).fill(b.empty)}static of(a,b){function c(a,b,c){for(const d of g.metascreens.getById(b,a.tileset))if(b=d.findEntranceType(c,1===a.height),null!=b)return b}var d,e,f;const {rom:g,width:h,height:k}=a;if(!b){const {fortress:c,labyrinth:d}=g.metatilesets;b=new Set;for(var p of g.metatilesets)a.tileset===
p.tileset.id&&b.add(p);b.delete(169===a.id?c:d);for(var q of new Set(ca.concat(...a.screens)))for(var t of b)if(t.getMetascreens(q).length||b.delete(t),!b.size)throw Error(`No tileset for ${x(q)} in ${a}`);if(1!==b.size)throw Error(`Non-unique tileset for ${a}: [${Array.from(b,a=>a.name).join(", ")}]`);b=[...b][0]}const A=a.reachableTiles(!0);p=new Set;for(var D of A.keys())p.add(D>>>8);for(var z of a.entrances)z.used&&p.add(z.screen);for(var I of a.exits)p.add(I.screen),I.isSeamless()&&(D=I.tile>>>
4,0===D?A.set(I.screen-16<<8|136,1):14===D&&A.set(I.screen<<8|136,1));I=Array(k<<4).fill(b.empty);for(let c=0;c<k;c++)for(let d=0;d<h;d++){D=c<<4|d;var X=b.getMetascreens(a.screens[c][d]);z=void 0;if(1===X.length)z=X[0];else if(X.length){q=a.flags.find(a=>a.screen===(c<<4|d));t=[];var T=[];for(var R of X)R.data.match?t.push(R):"always"===R.flag&&766===(null===q||void 0===q?void 0:q.flag)||!R.flag&&!R.data.wall&&!q?T.unshift(R):T.push(R);if(t.length){X=function(a,b){b=(d<<8)+b;a=(c<<8)+a;return A.has(a<<
4&61440|b&3840|a&240|b>>4&15)};for(var U of t)if(U.data.match(X,null!=q)){z=U;break}}z||(z=T[0])}else throw Error("impossible");if(!z)throw Error("impossible");I[D]=z}R=new ka;let Xa;for(const b of a.exits){if(255===b.dest)continue;U=b.screen;z=b.tile;!b.isSeamless()||b.yt&15||88===(a.id&88)||(U-=16,z|=240);if(!p.has(U))throw Error("impossible?");D=I[U];t=D.findExitType(z,1===k,!!(b.entrance&32));z=null===t||void 0===t?void 0:t.type;if(!z){if(ce.has(a.id<<16|U<<8|b.tile))continue;z=null===(d=D.data.exits)||
void 0===d?void 0:d.map(a=>a.type+": "+a.exits.map(x).join(", ")).join("\n  ");console.warn(`Unknown exit ${x(b.tile)}: ${D.name} in ${a} @ ${x(U)}:\n  ${z}`);continue}if(R.has(U,z))continue;q=g.locations[b.dest];if(z.startsWith("seamless")){D="seamless:down"===z;R.set(U,z,[q.id<<8|U+(0>t.exits[0]+(D?-16:16)?-16:0),D?"seamless:up":"seamless:down"]);continue}X=q.entrances[b.entrance&31];t=X.screen;T=X.coord;"door"===z&&0===(X.y&240)&&(t-=16,T+=65536);X=q.screens[t>>4][t&15];const f=c(q,X,T);if(f)R.set(U,
z,[q.id<<8|t,f]),a.entrances[0].screen===U&&(U=a.entrances[0].coord,D=D.findExitByType(z),1024>=Math.pow((D.entrance&255)-(U&255),2)+Math.pow((D.entrance>>>8)-(U>>>8),2)&&(Xa=z));else{U=[];for(const a of g.metascreens.getById(X,q.tileset))for(const b of null!==(e=a.data.exits)&&void 0!==e?e:[])b.type.startsWith("seamless")||U.push(`  ${a.name} ${b.type}: ${x(b.entrance)}`);console.warn(`Bad entrance ${x(T)}: raw ${x(X)} in ${q} @ ${x(t)}\n${U.join("\n")}`)}}d=new Map;for(var wa of a.pits)d.set(wa.fromScreen,
wa.dest<<8|wa.toScreen);wa=new be(a.id,b,k,h);wa._screens=I;wa._exits=R;wa._entrance0=Xa;wa._pits=d;for(const b of a.flags)a=wa._screens[b.screen],(null===(f=a.flag)||void 0===f?0:f.startsWith("custom"))?wa.customFlags.set(b.screen,g.flags[b.flag]):a.flag||wa.freeFlags.add(g.flags[b.flag]);return wa}getUid(a){return this._screens[a].uid}get(a){return this._screens[a]}get width(){return this._width}set width(a){this._width=a;this._pos=void 0}get height(){return this._height}set height(a){this._height>
a?this._screens.splice(a+2<<4,this._height-a<<4):this._height<a&&(this._screens.length=a+2<<4,this._screens.fill(this.tileset.empty,this.height+2<<4,this._screens.length));this._height=a;this._pos=void 0}allPos(){if(this._pos)return this._pos;const a=this._pos=[];for(let b=0;b<this._height;b++)for(let c=0;c<this._width;c++)a.push(b<<4|c);return a}set(a,b){this._screens[a]=null!==b&&void 0!==b?b:this.tileset.empty}inBounds(a){return(a&15)<this.width&&0<=a&&a>>>4<this.height}set2d(a,b){for(const c of b){b=
0;for(const d of c)d&&this.set(a+b,d),b++;a+=16}}validate(){for(var a of[0,1])for(var b=a?0:1;b<this.height;b++)for(var c=a;c<this.width;c++){var d=b<<4|c,e=this._screens[d],f=d-(a?1:16),g=this._screens[f];if(!e.isEmpty()&&!g.isEmpty()&&!e.checkNeighbor(g,a)){b=Error;a=[g.name,f,de[a],e.name,d];d="bad neighbor %s (%02x) %s %s (%02x)".split(/%/g);e=0;f=d[0];for(g=1;g<d.length;g++){if(!d[g]){f+="%"+d[++g];continue}c=/([-+]*)([0\D]?)(\d*)([dxs])/.exec(d[g]);if(!c){f+=a[e++]+d[g];continue}var h=parseInt(c[3])||
0;const b=c[2]||" ",p=a[e++];let q="x"===c[4]?Number(p).toString(16):String(p);"s"!==c[4]&&/\+/.test(c[1])&&0<=Number(p)&&(q="+"+q);q.length<h&&(h=b.repeat(h-q.length),q=/-/.test(c[1])?q+h:h+q);f+=q+d[g].substring(c[0].length)}a=f;throw b(a);}}return!0}spliceColumns(a,b,c,d){for(var e=0;e<this._screens.length;e+=16)this._screens.copyWithin(e+a+c,e+a+b,e+10),this._screens.splice(e+a,c,...d[e>>4]);c-=b;this.width+=c;this._pos=void 0;d=[];for(var f of this._exits){const [g,h]=f;e=g&15;e<a+b?e>=a&&this._exits.delete(g,
h):d.push([g,h,g+c,h])}this.moveExits(...d);f=this.rom.locations[this.id];d=a+b<<4;for(const a of f.spawns)a.xt<d||(a.xt-=c<<4);for(const d of f.flags)d.xs<a+b?d.xs>=a&&(d.screen=255):d.xs-=c;f.flags=f.flags.filter(a=>255!==a.screen)}setExit(a,b,c){const d=this.rom.locations[c[0]>>>8].meta;if(!d)throw Error("Cannot set two-way exit without meta");this.setExitOneWay(a,b,c);d.setExitOneWay(c[0]&255,c[1],[this.id<<8|a,b])}setExitOneWay(a,b,c){this._exits.set(a,b,c)}deleteExit(a,b){this._exits.delete(a,
b)}getExit(a,b){return this._exits.get(a,b)}exits(){return this._exits}exitCandidates(a){var b;const c=[];for(const d of this.tileset)(null===(b=d.data.exits)||void 0===b?0:b.some(b=>b.type===a))&&c.push(d);return c}show(){var a,b;const c=[];let d=[];for(var e=0;e<this.width;e++)d.push(e.toString(16));c.push("   "+d.join("  "));for(e=0;e<this.height;e++)for(let f=0;3>f;f++){d=[1===f?e.toString(16):" "," "];for(let c=0;c<this.width;c++){const g=this._screens[e<<4|c];d.push(null!==(b=null===(a=null===
g||void 0===g?void 0:g.data.icon)||void 0===a?void 0:a.full[f])&&void 0!==b?b:1===f?" ? ":"   ")}c.push(d.join(""))}return c.join("\n")}screenNames(){const a=[];for(let b=0;b<this.height;b++){let c=[];for(let a=0;a<this.width;a++){const d=this._screens[b<<4|a];c.push(null===d||void 0===d?void 0:d.name)}a.push(c.join(" "))}return a.join("\n")}traverse(a){a=void 0===a?{}:a;var b,c,d=new hd;const e=(a.flight?2:0)|(a.noFlagged?1:0);for(const f of this.allPos()){const g=null!==(c=null===(b=a.with)||void 0===
b?void 0:b.get(f))&&void 0!==c?c:this._screens[f];for(const a of g.connections[e])a.length&&d.union(a.map(a=>(f<<8)+a))}a=new Map;d=d.sets();for(b=0;b<d.length;b++){c=d[b];for(const b of c)a.set(b,c)}return a}exitType(a){var b;if(224===(a&240)){var c=a>>>8;a=null===(b=this.get(c).data.exits)||void 0===b?void 0:b[a&15].type;if(null===a||void 0===a||!a.startsWith("edge:")||!("edge:top"===a&&c>>>4||"edge:bottom"===a&&c>>>4===this.height-1||"edge:left"===a&&c&15||"edge:bottom"===a&&(c&15)===this.width-
1))return a}}poiTile(){throw Error("not implemented");}static connect(a,b,c){a.locations[b[0]>>>8].meta.attach(b[0]&255,a.locations[c[0]>>>8].meta,c[0]&255,b[1],c[1])}static findExitTiles(a,b){return a.locations[b[0]>>>8].meta._screens[b[0]&255].findExitByType(b[1]).exits.map(a=>a|(b[0]&255)<<8)}attach(a,b,c,d,e){d||(d=this.pickTypeFromExits(a));e||(e=b.pickTypeFromExits(c));const f=b.id<<8|c,g=this.id<<8|a,h=this._exits.get(a,d),k=b._exits.get(c,e);if(h&&k){const [a,b]=h,[c,A]=k;if(a===f&&b===e&&
c===g&&A===d)return}this._exits.set(a,d,[f,e]);b._exits.set(c,e,[g,d]);if(k&&h){const [b,c]=h,[d,e]=k;a=this.rom.locations[b>>8].meta;this.rom.locations[d>>8].meta._exits.set(d&255,e,h);a._exits.set(b&255,c,k)}else if(k||h){const [a,b]=k||h;a===g&&b===d||a===f&&b===e||this.rom.locations[a>>8].meta._exits.delete(a&255,b)}}pickTypeFromExits(a){const b=[...this._exits.row(a).keys()];if(!b.length)return this.pickTypeFromScreens(a);if(1<b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);
return b[0]}moveExits(...a){const b=[];for(const c of a){const [d,e,f,g]=c;{a=this._exits.get(d,e);const [c,k]=a;this.rom.locations[c>>8].meta._exits.set(c&255,k,[this.id<<8|f,g]);b.push([f,g,a]);this._exits.delete(d,e)}}for(const a of b){const [b,c,f]=a;this._exits.set(b,c,f)}}moveExit(a,b,c,d){c||(c=this.pickTypeFromExits(a));d||(d=this.pickTypeFromScreens(b));const e=this._exits.get(a,c),[f,g]=e;this.rom.locations[f>>8].meta._exits.set(f&255,g,[this.id<<8|b,d]);this._exits.set(b,d,e);this._exits.delete(a,
c)}moveExitsAndPitsTo(a){const b=new Set;for(const c of a.allPos())a.get(c).data.delete||b.add(c);for(const c of this._exits){const [d,e,[f,g]]=c;b.has(d)&&(this.rom.locations[f>>>8].meta._exits.set(f&255,g,[a.id<<8|d,e]),a._exits.set(d,e,[f,g]),this._exits.delete(d,e))}for(const c of this._pits){const [d,e]=c;b.has(d)&&(a._pits.set(d,e),this._pits.delete(d))}}pickTypeFromScreens(a){var b=this._screens[a].data.exits;b=(null!==b&&void 0!==b?b:[]).map(a=>a.type);if(1!==b.length)throw Error(`No single type for ${x(a)}: [${b.join(", ")}]`);
return b[0]}transferFlags(a,b){var c;this.freeFlags=new Set(a.freeFlags);const d=new ba(()=>[]);for(const b of a.customFlags){const [c,e]=b;d.get(a._screens[c]).push(e)}for(const a of d.values())b.shuffle(a);for(const e of this.allPos())if(a=this._screens[e],null===(c=a.flag)||void 0===c?0:c.startsWith("custom")){b=d.get(a).pop();if(!b)throw Error(`No flag for ${a.name} at ${this.rom.locations[this.id]} @${x(e)}`);this.customFlags.set(e,b)}}transferPits(a){this._pits=a._pits}shufflePits(){var a;if(this._pits.size){var b=
new Set;for(var c of this._pits){var [,d]=c;b.add(this.rom.locations[d>>>8].id)}this._pits.clear();c=new ba(()=>[]);for(var e of this.allPos())if(this.get(e).hasFeature("pit")){var f=[-1,this,Infinity];for(var g of this._exits){const [a,,[c]]=g;d=ee(e,a);b.has(c>>>8)&&d<f[2]&&(f=this.rom.locations[c>>>8].meta,f=[fe(e,c&255,a,f),f,d])}0<=f[0]&&c.get(f[1]).push([e,f[0]])}for(var h of b)b=c.get(this.rom.locations[h].meta),b.length||b.push([0,240]);for(const f of c){const [k,q]=f;h=[[],[]];b=new Map;
for(const a of k.allPos())e=k.get(a),e.hasFeature("river")||e.hasFeature("empty")||(g=(e.data.edges||"").split("").map(a=>" "===a?"":a),g[0]&&g[2]&&h[0].push(a),(g[1]&&g[3]||e.hasFeature("spikes"))&&h[1].push(a),e.hasFeature("spikes")&&b.set(a,[...g].filter(a=>"s"===a).length));g=[0,0];for(const f of q){const [t,p]=f;e=this.get(t).data.edges||"";c="c"===e[1]&&"c"===e[3]?1:0;e=[-1,Infinity,0];g=fe(p,g[0],g[1],k);for(const f of h[c])c=null!==(a=b.get(f))&&void 0!==a?a:0,c<e[2]||(d=ee(g,f),d<e[1]&&(e=
[f,d,c]));e=e[0];if(0>e)throw Error("no eligible dest");g=[e,g];this._pits.set(t,k.id<<8|e)}}}}transferExits(a,b){var c;const d=new ba(()=>[]),e=new ba(()=>new Set);for(var f of this.allPos()){var g=this._screens[f];for(var h of null!==(c=g.data.exits)&&void 0!==c?c:[])({type:g}=h),"edge:top"===g&&f>>>4||"edge:left"===g&&f&15||"edge:bottom"===g&&f>>>4<this.height-1||"edge:right"===g&&(f&15)<this.width-1||d.get(g).push(f)}for(var k of d.values())b.shuffle(k);for(const g of a._exits){const [p,t,A]=
g;if(!e.get(t).has(p)){f=d.get(t).pop();if(null==f)throw Error(`Could not transfer exit ${t} in ${this.rom.locations[this.id]}: no eligible screen\n${this.show()}`);h=this.rom.locations[A[0]>>>8].meta;b=A[0]&255;c=A[1];if(h===a){h=d.get(c).pop();if(null==h)throw Error("Impossible");this._exits.set(f,t,[this.id<<8|h,c]);this._exits.set(h,c,[this.id<<8|f,t]);e.get(c).add(b)}else{k=h._exits.get(b,c);if(!k)throw a=this.rom.locations[A[0]>>>8],console.log(h),Error(`No exit for ${a} at ${x(b)} ${c}\n${h.show()}\n${this.rom.locations[this.id]} at ${x(p)} ${t}\n${this.show()}`);
k[0]>>>8===this.id&&(k[0]&255)===p&&k[1]===t&&h._exits.set(b,c,[this.id<<8|f,t]);this._exits.set(f,t,A)}}}}transferSpawns(a,b){var c,d,e,f=new Map;const g=new Map,h=[],k=[],p=[],q=[];var t=[];for(var A of[this,a]){for(const a of A.allPos()){const b=A._screens[a],d=a&240,e=(a&15)<<4;if(b.hasFeature("pit")&&A===this)g.set(a,5===b.edgeIndex("c")?0:1);else if((null===(c=b.data.statues)||void 0===c?0:c.length)&&A===this)for(var D=0;D<b.data.statues.length;D++)h.push([a,b.data.statues[D]<<12|((a&15^a>>>
4^D)&1?80:160)]);if(A===this&&b.hasFeature("wall")){if(null==b.data.wall)throw Error("Missing wall prop");D=[d|b.data.wall>>4,e|b.data.wall&15];p.push(D);b.data.tilesets.lime&&p.push([D[0]-1,D[1]])}else if(A===this&&b.hasFeature("bridge")){if(null==b.data.wall)throw Error("Missing wall prop");q.push([d|b.data.wall>>4,e|b.data.wall&15])}if(b.hasFeature("arena"))if(A===this)t.push([d|8,e|8]);else{const [a,b]=t.pop();k.push([d|8,e|8,a,b,144,"arena"])}}A===this&&(b.shuffle(t),b.shuffle(h))}for(const b of[this,
a])for(const e of b._exits){const [g,h,p]=e;c=b._screens[g];a=null===(d=c.data.exits)||void 0===d?void 0:d.find(a=>a.type===h);if(!a)throw Error(`Invalid exit: ${c.name} ${h}`);c=g&15;t=g>>>4;A=a.exits[0]&15;a=a.exits[0]>>>4;if(b===this)f.set(p,[t<<4|a,c<<4|A]);else if(p[0]>>>8!==this.id){const [b,d]=f.get(p);k.push([t<<4|a,c<<4|A,b,d,25,"exit"])}}d=[[],[],[],[],[],[]];for(var z of this.allPos()){f=this._screens[z];for(var I of null!==(e=f.data.poi)&&void 0!==e?e:[]){const [a,b=112,c=120]=I;d[a].push([((z&
240)<<4)+b,((z&15)<<8)+c])}}for(const a of d)b.shuffle(a);e=[...ca.concat(...d)];z=this.rom.locations[this.id];for(const a of b.ishuffle(z.spawns)){if(a.isMonster()){b=ge.indexOf(a.monsterId);if(0<=b&&g.size){const [[c,d]]=g;g.delete(c);a.monsterId=ge[b&2|d];a.screen=c;a.tile=d?115:71}else if(143===a.monsterId&&h.length){const [b,c]=h.pop();a.screen=b;a.coord=c}continue}else if(a.isWall()){b=("bridge"===a.wallType()?q:p).pop();if(!b)throw Error(`Not enough ${a.wallType()} screens in new metalocation: ${z}\n${this.show()}`);
const [c,d]=b;a.yt=c;a.xt=d;continue}else if(a.isNpc()||a.isBoss()||a.isTrigger()||a.isGeneric()){b=[-1,-1,Infinity];for(const c of k){const [d,e,f,g,h,k]=c;"arena"!==k&&a.isBoss()||(I=Math.pow($d(a.yt,d),2)+Math.pow(a.xt-e,2),I<=h&&I<b[2]&&(b=[ae(a.yt,$d(f,d)),a.xt+g-e,I]))}if(Number.isFinite(b[2])){[a.yt,a.xt]=b;continue}}if(a.isTrigger()||a.isBoss())throw Error(`Could not place ${z} ${a.isBoss()?"Boss":"Trigger"} ${a.hex()}\n${this.show()}`);b=e.shift();if(!b)throw Error(`Ran out of POI for ${z}`);
const [c,d]=b;k.push([a.y>>>4,a.x>>>4,c>>>4,d>>>4,4,"???"]);a.y=c;a.x=d}}reconcileExits(a){const b=[],c=[];for(const d of[this,a])for(const e of d._exits){const [f,g,[h,k]]=e;{if(k.startsWith("seamless"))continue;const e=this.rom.locations[h>>>8].meta._exits.get(h&255,k);if(e){const [c,t]=e;if(c>>>8===d.id&&(c&255)===f&&t===g){b.push([d===this?a:this,f,g,[h,k]]);continue}}c.push([d,f,g])}}for(const a of c){const [b,c,d]=a;b._exits.delete(c,d)}for(const a of b){const [b,c,d,h]=a;b._exits.set(c,d,h)}}writeEntrance0(){if(this._entrance0)for(var a of this._exits){const [b,
c]=a;if(c===this._entrance0){a=this._screens[b].findExitByType(c);this.rom.locations[this.id].entrances[0]=Vd.of({screen:b,coord:a.entrance});break}}}write(){var a,b,c,d,e,f,g,h,k,p,q,t;const A=this.rom.locations[this.id],D=new Set;for(var z of this._exits){const [c,d,[e,f]]=z;{var I=this._screens[c],X=e>>8,T=e&255;const g=this.rom.locations[X],h=g.meta._screens[e&255],k=null===(a=I.data.exits)||void 0===a?void 0:a.find(a=>a.type===d);var R=null===(b=h.data.exits)||void 0===b?void 0:b.find(a=>a.type===
f);if(!k||!R)throw Error(`Missing ${k?"dest":"source"} exit:
  From: ${A} @ ${x(c)}:${d} ${I.name}
  To:   ${g} @ ${x(T)}:${f} ${h.name}`);I=32;R.type.startsWith("seamless")?D.add(c):(R=R.entrance,61439<R&&(T+=16,R-=65536),I=g.findOrAddEntrance(T,R));for(let a of k.exits)T=c,240===(a&240)&&(T+=16,a&=15),A.exits.push(Wd.of({screen:T,tile:a,dest:X,entrance:I}))}}A.width=this._width;A.height=this._height;A.screens=[];for(a=0;a<this._height;a++)for(b=[],A.screens.push(b),z=0;z<this._width;z++)b.push(this._screens[a<<4|z].sid);A.tileset=this.tileset.tilesetId;A.tileEffects=this.tileset.effects().id;
a=new hd;for(const g of this.allPos())D.has(g)||(b=this._screens[g],z=g+16,X=g+1,D.has(z)||" "===(null!==(d=null===(c=b.data.edges)||void 0===c?void 0:c[2])&&void 0!==d?d:" ")||a.union([g,z]),D.has(X)||" "===(null!==(f=null===(e=b.data.edges)||void 0===e?void 0:e[3])&&void 0!==f?f:" ")||a.union([g,X]),a.union([g]));d=a.map();c=new Set;for(var U of this._exits){[e]=U;for(const a of null!==(g=d.get(e))&&void 0!==g?g:[])c.add(a)}A.flags=[];g=[...this.freeFlags];for(const a of this.allPos()){U=this._screens[a];
let b;null!=U.data.wall&&c.has(a)?b=null!==(k=null===(h=g.pop())||void 0===h?void 0:h.id)&&void 0!==k?k:this.rom.flags.alloc(512):"always"===U.flag?b=this.rom.flags.AlwaysTrue.id:"calm"===U.flag?b=this.rom.flags.CalmedAngrySea.id:"custom:false"===U.flag?b=null===(p=this.customFlags.get(a))||void 0===p?void 0:p.id:"custom:true"===U.flag&&(b=null!==(t=null===(q=this.customFlags.get(a))||void 0===q?void 0:q.id)&&void 0!==t?t:this.rom.flags.AlwaysTrue.id);null!=b&&A.flags.push(Xd.of({screen:a,flag:b}))}A.pits=
[];for(const a of this._pits){const [b,c]=a;A.pits.push(Yd.of({fromScreen:b,toScreen:c&255,dest:c>>>8}))}}replaceMonsters(a){if(104!==this.id){var b=this.rom.locations[this.id];a=b.monsterPlacer(a);for(const c of b.spawns){if(!c.used)continue;if(!c.isMonster())continue;const d=b.rom.objects[c.monsterId];if(!(d instanceof F))continue;const e=a(d);null==e?(console.error(`no valid location for ${x(d.id)} ${d.name} in ${b}`),c.used=!1):d.isBird()?(c.y=4048,c.x=2032,c.timed=!0):(c.screen=e>>>8,c.tile=
e&255)}}}}const ce=new Set([65594,65595,1392800,1716320,4202496,4202544,4292816,6326207,10552102,10552105,11077158,11077161]),de=["above","left of","below","right of"];function ee(a,b){return Math.pow((a>>>4)-(b>>>4),2)+Math.pow((a&15)-(b&15),2)}function fe(a,b,c,d){return Math.max(0,Math.min(d.height-1,(a>>>4)+(b>>>4)-(c>>>4)))<<4|Math.max(0,Math.min(d.width-1,(a&15)+(b&15)-(c&15)))}const ge=[126,127,159,141];var G,H=G||(G={});H[H.Unknown=0]="Unknown";H[H.GrassLongGrass=1]="GrassLongGrass";H[H.GrassLongGrassRemapping=2]="GrassLongGrassRemapping";H[H.RiverShortGrass=3]="RiverShortGrass";H[H.SeaCaveEntrance=4]="SeaCaveEntrance";H[H.SeaRocks=5]="SeaRocks";H[H.SeaMarsh=6]="SeaMarsh";H[H.SeaTrees=7]="SeaTrees";H[H.DesertShortGrass=8]="DesertShortGrass";H[H.DesertLongGrass=9]="DesertLongGrass";H[H.DesertMarsh=10]="DesertMarsh";H[H.DesertRocks=11]="DesertRocks";H[H.DesertTrees=12]="DesertTrees";
H[H.DesertTownEntrance=13]="DesertTownEntrance";H[H.LabyrinthParapets=14]="LabyrinthParapets";H[H.SwampDoors=15]="SwampDoors";H[H.ExtraSpikes=16]="ExtraSpikes";H[H.CloseCaves=17]="CloseCaves";H[H.WideArenaExits=18]="WideArenaExits";let he=0;class ie{constructor(){this.name=`Area ${++he}`}}class je extends ie{constructor(){super(...arguments);this.type="overworld"}}class ke extends ie{constructor(){super(...arguments);this.type="town"}}class le extends ie{constructor(){super(...arguments);this.type="connector";this.exits=[2,2]}}class me extends ie{constructor(){super(...arguments);this.type="terminal";this.exits=[1,1]}}var J;
(function(a){a.Unused=new me;a.ValleyOfWind=new class extends je{constructor(){super(...arguments);this.exits=[3,6]}};a.CordelPlain=new class extends je{constructor(){super(...arguments);this.exits=[5,8]}};a.WaterfallValley=new class extends je{constructor(){super(...arguments);this.exits=[6,6]}};a.AngrySea=new class extends je{constructor(){super(...arguments);this.exits=[0,0]}};a.GoaValley=new class extends je{constructor(){super(...arguments);this.exits=[0,0]}};a.Desert1=new class extends je{constructor(){super(...arguments);
this.exits=[0,0]}};a.Desert2=new class extends je{constructor(){super(...arguments);this.exits=[0,0]}};a.Leaf=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Brynmaer=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Oak=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Amazones=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Nadare=new class extends ke{constructor(){super(...arguments);this.exits=
[0,0]}};a.Portoa=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Joel=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.ZombieTown=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Swan=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Shyron=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.Goa=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};
a.Sahara=new class extends ke{constructor(){super(...arguments);this.exits=[0,0]}};a.WindmillCave=new class extends le{};a.SealedCave=new class extends le{};a.ZebuCave=new class extends le{};a.MtSabreWest=new class extends le{};a.MtSabreNorth=new class extends le{};a.LimeTreeValley=new class extends le{};a.PortoaPalace=new class extends le{};a.FishermanHouse=new class extends le{};a.UndergroundChannel=new class extends le{};a.JoelPassage=new class extends le{};a.EvilSpiritIslandEntrance=new class extends le{};
a.EvilSpiritIsland=new class extends le{};a.KirisaPlantCave=new class extends le{};a.SwanGate=new class extends le{};a.MtHydra=new class extends le{};a.GoaFortress=new class extends le{};a.OasisEntrance=new class extends le{};a.OasisCave=new class extends le{};a.DesertCave1=new class extends le{};a.SaharaMeadow=new class extends le{};a.DesertCave2=new class extends le{};a.EastCave=new class extends le{};a.Swamp=new class extends le{};a.Mezame=new class extends me{};a.Windmill=new class extends me{};
a.StomHouse=new class extends me{};a.WaterfallCave=new class extends me{};a.KirisaMeadow=new class extends me{};a.FogLampCave=new class extends me{};a.LimeTreeLake=new class extends me{};a.Lighthouse=new class extends me{};a.SaberaFortress=new class extends me{};a.ShyronTemple=new class extends me{};a.Styx=new class extends me{};a.FortressBasement=new class extends me{};a.Pyramid=new class extends me{};a.Crypt=new me;a.Tower=new me})(J||(J={}));
for(const [a,b]of Object.entries(J))b.name=a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace("Of","of");const {$0a:ne,$0b:oe,$0c:pe,$0d:qe}=y,re={subArea:"cave",music:a=>`${a.name}-Cave`,palette:a=>`${a.name}-Cave`},K={subArea:"house",palette:()=>Symbol()},se={subArea:"house",palette:()=>Symbol(),music:a=>`${a.name}-FortuneTeller`},te={name:"mesia",music:a=>`${a.name}-Mesia`,palette:a=>"Tower"===a.name?a.name:`${a.name}-Mesia`},ue={name:"dyna",music:a=>`${a.name}-Dyna`,palette:a=>`${a.name}-Dyna`},ve={name:"goa 1",music:"goa 1",palette:"goa 1"},we={name:"goa 2",music:"goa 2",palette:"goa 2"},xe={name:"goa 3",
music:"goa 3",palette:"goa 3"},ye=Object.assign({},xe,{palette:"goa 3 upper"}),ze={name:"goa 4",music:"goa 4",palette:"goa 4"},Ae=Object.assign({},ze,{palette:"goa 4 lower"}),M=(()=>{function a(a,e){e=void 0===e?{}:e;e=Object.assign({},e);c=e.area=e.area||c;return b(a,e)}const b=Yb();let c;a.commit=a=>{b.commit(a,(b,c,d)=>{b=Cb(b);const e=d.area,f="function"===typeof d.music?d.music(e):null!=d.music?d.music:e.name,g="function"===typeof d.palette?d.palette(e):d.palette||e.name;b={area:e,name:b,music:f,
palette:g};null!=d.houseType&&(b.houseType=d.houseType);null!=d.subArea&&(b.subArea=d.subArea);null!=d.bossScreen&&(b.bossScreen=d.bossScreen);d=new Be(a.rom,c,b);0<=c&&(a[c]=d);return d})};return a})();
class Ce extends Array{constructor(a){super(256);this.rom=a;this.MezameShrine=M(0,{area:J.Mezame});this.Leaf_OutsideStart=M(1,{music:1});this.Leaf=M(2,{area:J.Leaf});this.ValleyOfWind=M(3,{area:J.ValleyOfWind});this.SealedCave1=M(4,{area:J.SealedCave});this.SealedCave2=M(5);this.SealedCave6=M(6);this.SealedCave4=M(7);this.SealedCave5=M(8);this.SealedCave3=M(9);this.SealedCave7=M(10,{bossScreen:145});this.SealedCave8=M(12);this.WindmillCave=M(14,{area:J.WindmillCave});this.Windmill=M(15,{area:J.Windmill,
music:0,houseType:"outside"});this.ZebuCave=M(16,{area:J.ZebuCave});this.MtSabreWest_Cave1=M(17,Object.assign({},{area:J.MtSabreWest},re));this.CordelPlainWest=M(20,{area:J.CordelPlain});this.CordelPlainEast=M(21);this.Brynmaer=M(24,{area:J.Brynmaer});this.OutsideStomHouse=M(25,{area:J.StomHouse,music:0});this.Swamp=M(26,{area:J.Swamp,bossScreen:124});this.Amazones=M(27,{area:J.Amazones,fixed:[13,14]});this.Oak=M(28,{area:J.Oak});this.StomHouse=M(30,{area:J.StomHouse,houseType:"outside"});this.MtSabreWest_Lower=
M(32,{area:J.MtSabreWest});this.MtSabreWest_Upper=M(33);this.MtSabreWest_Cave2=M(34,re);this.MtSabreWest_Cave3=M(35,re);this.MtSabreWest_Cave4=M(36,re);this.MtSabreWest_Cave5=M(37,re);this.MtSabreWest_Cave6=M(38,re);this.MtSabreWest_Cave7=M(39,re);this.MtSabreNorth_Main=M(40,{area:J.MtSabreNorth,bossScreen:181});this.MtSabreNorth_Middle=M(41);this.MtSabreNorth_Cave2=M(42,re);this.MtSabreNorth_Cave3=M(43,re);this.MtSabreNorth_Cave4=M(44,re);this.MtSabreNorth_Cave5=M(45,re);this.MtSabreNorth_Cave6=
M(46,re);this.MtSabreNorth_PrisonHall=M(47,re);this.MtSabreNorth_LeftCell=M(48,re);this.MtSabreNorth_LeftCell2=M(49,re);this.MtSabreNorth_RightCell=M(50,re);this.MtSabreNorth_Cave8=M(51,re);this.MtSabreNorth_Cave9=M(52,re);this.MtSabreNorth_SummitCave=M(53,re);this.MtSabreNorth_Cave1=M(56,re);this.MtSabreNorth_Cave7=M(57,re);this.Nadare_Inn=M(60,Object.assign({},{area:J.Nadare},K));this.Nadare_ToolShop=M(61,Object.assign({},K,{houseType:"tool"}));this.Nadare_BackRoom=M(62,Object.assign({},K,{houseType:"house"}));
this.WaterfallValleyNorth=M(64,{area:J.WaterfallValley});this.WaterfallValleySouth=M(65);this.LimeTreeValley=M(66,{area:J.LimeTreeValley,music:0});this.LimeTreeLake=M(67,{area:J.LimeTreeLake,music:0});this.KirisaPlantCave1=M(68,{area:J.KirisaPlantCave});this.KirisaPlantCave2=M(69);this.KirisaPlantCave3=M(70);this.KirisaMeadow=M(71,{area:J.KirisaMeadow});this.FogLampCave1=M(72,{area:J.FogLampCave});this.FogLampCave2=M(73);this.FogLampCave3=M(74);this.FogLampCaveDeadEnd=M(75);this.FogLampCave4=M(76);
this.FogLampCave5=M(77);this.FogLampCave6=M(78);this.FogLampCave7=M(79);this.Portoa=M(80,{area:J.Portoa});this.Portoa_FishermanIsland=M(81,{area:J.FishermanHouse,music:0});this.MesiaShrine=M(82,Object.assign({},{area:J.LimeTreeLake},te));this.WaterfallCave1=M(84,{area:J.WaterfallCave});this.WaterfallCave2=M(85);this.WaterfallCave3=M(86);this.WaterfallCave4=M(87);this.TowerEntrance=M(88,{area:J.Tower});this.Tower1=M(89);this.Tower2=M(90);this.Tower3=M(91);this.TowerOutsideMesia=M(92);this.TowerOutsideDyna=
M(93);this.TowerMesia=M(94,te);this.TowerDyna=M(95,ue);this.AngrySea=M(96,{area:J.AngrySea});this.BoatHouse=M(97,{houseType:"outside"});this.JoelLighthouse=M(98,{area:J.Lighthouse,music:0,houseType:"outside"});this.UndergroundChannel=M(100,{area:J.UndergroundChannel});this.ZombieTown=M(101,{area:J.ZombieTown});this.EvilSpiritIsland1=M(104,{area:J.EvilSpiritIslandEntrance,music:1});this.EvilSpiritIsland2=M(105,{area:J.EvilSpiritIsland});this.EvilSpiritIsland3=M(106);this.EvilSpiritIsland4=M(107);this.SaberaPalace1=
M(108,{area:J.SaberaFortress,bossScreen:253,houseType:"palace"});this.SaberaPalace2=M(109);this.SaberaPalace2_West=M(-1);this.SaberaPalace3=M(110,{bossScreen:253});this.JoelSecretPassage=M(112,{area:J.JoelPassage});this.Joel=M(113,{area:J.Joel});this.Swan=M(114,{area:J.Swan,music:1});this.SwanGate=M(115,{area:J.SwanGate,music:1});this.GoaValley=M(120,{area:J.GoaValley});this.MtHydra=M(124,{area:J.MtHydra});this.MtHydra_Cave1=M(125,re);this.MtHydra_OutsideShyron=M(126,{fixed:[13,14]});this.MtHydra_Cave2=
M(127,re);this.MtHydra_Cave3=M(128,re);this.MtHydra_Cave4=M(129,re);this.MtHydra_Cave5=M(130,re);this.MtHydra_Cave6=M(131,re);this.MtHydra_Cave7=M(132,re);this.MtHydra_Cave8=M(133,re);this.MtHydra_Cave9=M(134,re);this.MtHydra_Cave10=M(135,re);this.Styx1=M(136,{area:J.Styx,houseType:"palace"});this.Styx2=M(137);this.Styx2_East=M(-1);this.Styx3=M(138);this.Shyron=M(140,{area:J.Shyron});this.Goa=M(142,{area:J.Goa});this.GoaFortressBasement=M(143,{area:J.FortressBasement,music:0});this.Desert1=M(144,
{area:J.Desert1});this.OasisCaveMain=M(145,{area:J.OasisCave});this.DesertCave1=M(146,{area:J.DesertCave1,music:0});this.Sahara=M(147,{area:J.Sahara});this.SaharaOutsideCave=M(148,{music:0});this.DesertCave2=M(149,{area:J.DesertCave2,music:1});this.SaharaMeadow=M(150,{area:J.SaharaMeadow,music:0});this.Desert2=M(152,{area:J.Desert2});this.Pyramid_Entrance=M(156,{area:J.Pyramid,houseType:"palace"});this.Pyramid_Branch=M(157);this.Pyramid_Main=M(158);this.Pyramid_Draygon=M(159);this.Crypt_Entrance=
M(160,{area:J.Crypt});this.Crypt_Hall1=M(161);this.Crypt_Branch=M(162);this.Crypt_DeadEndLeft=M(163);this.Crypt_DeadEndRight=M(164);this.Crypt_Hall2=M(165);this.Crypt_Draygon2=M(166);this.Crypt_Teleporter=M(167,{music:"Crypt-Teleporter"});this.GoaFortress_Entrance=M(168,{area:J.GoaFortress,music:1,houseType:"palace"});this.GoaFortress_Kelbesque=M(169,Object.assign({},{bossScreen:115},ve));this.GoaFortress_Zebu=M(170,Object.assign({},ve,{palette:1}));this.GoaFortress_Sabera=M(171,we);this.GoaFortress_Tornel=
M(172,Object.assign({},{bossScreen:145},we,{palette:1}));this.GoaFortress_Mado1=M(173,xe);this.GoaFortress_Mado2=M(174,ye);this.GoaFortress_Mado3=M(175,ye);this.GoaFortress_Karmine1=M(176,ze);this.GoaFortress_Karmine2=M(177,ze);this.GoaFortress_Karmine3=M(178,ze);this.GoaFortress_Karmine4=M(179,ze);this.GoaFortress_Karmine5=M(180,ze);this.GoaFortress_Karmine6=M(181,Ae);this.GoaFortress_Karmine7=M(182,Object.assign({},{bossScreen:253},Ae));this.GoaFortress_Exit=M(183,{music:0});this.OasisCave_Entrance=
M(184,{area:J.OasisEntrance,music:2});this.GoaFortress_Asina=M(185,Object.assign({},{area:J.GoaFortress},ye,{bossScreen:145}));this.GoaFortress_Kensu=M(186,ze);this.Goa_House=M(187,Object.assign({},{area:J.Goa},K,{houseType:"house"}));this.Goa_Inn=M(188,Object.assign({},K,{houseType:"inn"}));this.Goa_ToolShop=M(190,Object.assign({},K,{houseType:"tool"}));this.Goa_Tavern=M(191,Object.assign({},K,{houseType:"tavern"}));this.Leaf_ElderHouse=M(192,Object.assign({},{area:J.Leaf},K,{houseType:"house"}));
this.Leaf_RabbitHut=M(193,Object.assign({},K,{houseType:"shed"}));this.Leaf_Inn=M(194,Object.assign({},K,{houseType:"inn"}));this.Leaf_ToolShop=M(195,Object.assign({},K,{houseType:"tool"}));this.Leaf_ArmorShop=M(196,Object.assign({},K,{houseType:"armor"}));this.Leaf_StudentHouse=M(197,Object.assign({},K,{houseType:"house"}));this.Brynmaer_Tavern=M(198,Object.assign({},{area:J.Brynmaer},K,{houseType:"tavern"}));this.Brynmaer_PawnShop=M(199,Object.assign({},K,{houseType:"pawn"}));this.Brynmaer_Inn=
M(200,Object.assign({},K,{houseType:"inn"}));this.Brynmaer_ArmorShop=M(201,Object.assign({},K,{houseType:"armor"}));this.Brynmaer_ItemShop=M(203,Object.assign({},K,{houseType:"tool"}));this.Oak_ElderHouse=M(205,Object.assign({},{area:J.Oak},K,{houseType:"house"}));this.Oak_MotherHouse=M(206,Object.assign({},K,{houseType:"house"}));this.Oak_ToolShop=M(207,Object.assign({},K,{houseType:"tool"}));this.Oak_Inn=M(208,Object.assign({},K,{houseType:"inn"}));this.Amazones_Inn=M(209,Object.assign({},{area:J.Amazones},
K,{houseType:"inn"}));this.Amazones_ItemShop=M(210,Object.assign({},K,{houseType:"tool"}));this.Amazones_ArmorShop=M(211,Object.assign({},K,{houseType:"armor"}));this.Amazones_Elder=M(212,Object.assign({},K,{houseType:"house",fixed:[13,14]}));this.Nadare=M(213,{area:J.Nadare});this.Portoa_FishermanHouse=M(214,Object.assign({},{area:J.FishermanHouse},K,{music:0,houseType:"outside"}));this.Portoa_PalaceEntrance=M(215,{area:J.PortoaPalace,houseType:"palace"});this.Portoa_FortuneTeller=M(216,Object.assign({},
{area:J.Portoa,fixed:[13,14]},se,{houseType:"house"}));this.Portoa_PawnShop=M(217,Object.assign({},K,{houseType:"pawn"}));this.Portoa_ArmorShop=M(218,Object.assign({},K,{houseType:"armor"}));this.Portoa_Inn=M(220,Object.assign({},K,{houseType:"inn"}));this.Portoa_ToolShop=M(221,Object.assign({},K,{houseType:"tool"}));this.PortoaPalace_Left=M(222,Object.assign({},{area:J.PortoaPalace},K,{houseType:"house"}));this.PortoaPalace_ThroneRoom=M(223,K);this.PortoaPalace_Right=M(224,Object.assign({},K,{houseType:"house"}));
this.Portoa_AsinaRoom=M(225,Object.assign({},{area:J.UndergroundChannel},K,{music:"asina"}));this.Amazones_ElderDownstairs=M(226,Object.assign({},{area:J.Amazones},K));this.Joel_ElderHouse=M(227,Object.assign({},{area:J.Joel},K,{houseType:"house"}));this.Joel_Shed=M(228,Object.assign({},K,{houseType:"shed"}));this.Joel_ToolShop=M(229,Object.assign({},K,{houseType:"tool"}));this.Joel_Inn=M(231,Object.assign({},K,{houseType:"inn"}));this.ZombieTown_House=M(232,Object.assign({},{area:J.ZombieTown},K,
{houseType:"house"}));this.ZombieTown_HouseBasement=M(233,K);this.Swan_ToolShop=M(235,Object.assign({},{area:J.Swan},K,{houseType:"tool"}));this.Swan_StomHut=M(236,Object.assign({},K,{houseType:"shed"}));this.Swan_Inn=M(237,Object.assign({},K,{houseType:"inn"}));this.Swan_ArmorShop=M(238,Object.assign({},K,{houseType:"armor"}));this.Swan_Tavern=M(239,Object.assign({},K,{houseType:"tavern"}));this.Swan_PawnShop=M(240,Object.assign({},K,{houseType:"pawn"}));this.Swan_DanceHall=M(241,Object.assign({},
K,{houseType:"house"}));this.Shyron_Temple=M(242,{area:J.ShyronTemple,bossScreen:112,houseType:"palace"});this.Shyron_TrainingHall=M(243,Object.assign({},{area:J.Shyron},K,{houseType:"house"}));this.Shyron_Hospital=M(244,Object.assign({},K,{houseType:"house"}));this.Shyron_ArmorShop=M(245,Object.assign({},K,{houseType:"armor"}));this.Shyron_ToolShop=M(246,Object.assign({},K,{houseType:"tool"}));this.Shyron_Inn=M(247,Object.assign({},K,{houseType:"inn"}));this.Sahara_Inn=M(248,Object.assign({},{area:J.Sahara},
K,{houseType:"inn"}));this.Sahara_ToolShop=M(249,Object.assign({},K,{houseType:"tool"}));this.Sahara_ElderHouse=M(250,Object.assign({},K,{houseType:"house"}));this.Sahara_PawnShop=M(251,Object.assign({},K,{houseType:"pawn"}));this.EastCave1=M(-1,{area:J.EastCave});this.EastCave2=M(-1);this.EastCave3=M(-1);this.FishermanBeach=M(-1,Object.assign({},{area:J.FishermanHouse},K));this.locsByScreen=new ba(()=>[]);M.commit(this);for(let b=0;256>b;b++)this[b]?this.indexScreens(this[b]):this[b]=new Be(a,b,
{area:J.Unused,name:"",music:"",palette:""})}indexScreens(a){for(const b of a.screens)for(const c of b)this.locsByScreen.get(c).push(a)}renumberScreen(a,b){var c=this.locsByScreen.get(a);this.locsByScreen.set(b,c);this.locsByScreen.delete(a);for(const d of c)for(const e of d.screens)for(c=0;c<e.length;c++)e[c]===a&&(e[c]=b)}allocate(a,b){for(const c of this)if(!(c.used||b&&c.id<b.id))return a.id=c.id,a.used=!0,this.indexScreens(a),this[c.id]=a;throw Error("No unused location");}write(){const a=this.rom.assembler();
fc(a,ne,34040,40960);fc(a,oe,40960,48640);fc(a,pe,37881,40960);fc(a,qe,40960,44032);fc(a,qe,44544,49152);for(const b of this)b.assemble(a);return[a.module()]}location(){}}
class Be extends Xc{constructor(a,b,c){super(a,b);this.data=c;this.monstersMoved=!1;this._meta=this._isShop=void 0;var d=0<=b?Pb(a.prg,this.mapDataPointer)+49152:0;if(this.used=49152<d&&!!this.name){var e=Pb(a.prg,d)+49152;c=Pb(a.prg,d+2)+49152;var f=Pb(a.prg,d+4)+49152,g=Pb(a.prg,d+6)+49152,h=Pb(a.prg,d+8)+49152,k=this.used&&e!==d+10,p=g-f;this.exits=(()=>{const b=[];let c=g;for(;!(a.prg[c]&128);)255!=a.prg[c+2]&&b.push(Wd.from(a.prg,c)),c+=4;255!==a.prg[c]&&(k=!!(a.prg[c]&64),p=(a.prg[c]&31)<<2);
return b})();d=k?Pb(a.prg,d+10)+49152:0;this.bgm=this.originalBgm=a.prg[e];this.layoutWidth=a.prg[e+1];this.layoutHeight=a.prg[e+2];this.animation=a.prg[e+3];var q=a.prg[e+4]?256:0;this.screens=w(this.height,b=>Eb(a.prg,e+5+b*this.width,this.width).map(a=>q|a));this.tilePalettes=Eb(a.prg,c,3);this.originalTilePalettes=Eb(this.tilePalettes,0,3);this.tileset=a.prg[c+3];this.tileEffects=a.prg[c+4];this.tilePatterns=Eb(a.prg,c+5,2);this.entrances=Ib(4,a.prg.slice(f,f+p),a=>Vd.from(a));this.flags=Gb(a.prg,
h,2,255,Infinity,a=>Xd.from(a));this.pits=d?Gb(a.prg,d,4,255,Infinity,a=>Yd.from(a)):[];c=Pb(a.prg,this.npcDataPointer)+65536;this.spritePalettes=(f=65536!==c)?Eb(a.prg,c+1,2):[0,0];this.spritePatterns=f?Eb(a.prg,c+3,2):[0,0];this.spawns=f?Gb(a.prg,c+5,4,255,Infinity,a=>Zd.from(a)):[];this.checkpoint=!!(a.prg[196352|b]&128);this.saveable=!!(a.prg[196352|b]&1)}else this.animation=this.layoutHeight=this.layoutWidth=this.bgm=this.originalBgm=0,this.screens=[[0]],this.tilePalettes=[36,1,38],this.originalTilePalettes=
[36,1,38],this.tileset=128,this.tileEffects=179,this.tilePatterns=[2,4],this.exits=[],this.entrances=[],this.flags=[],this.pits=[],this.spawns=[],this.spritePalettes=[0,0],this.spritePatterns=[0,0],this.checkpoint=this.saveable=!1}set meta(a){this._meta=a}get meta(){this.ensureMeta();return this._meta}ensureMeta(){this._meta||(this._meta=be.of(this))}set musicGroup(a){this._musicGroup=a}get musicGroup(){this.ensureMusicGroup();return this._musicGroup}ensureMusicGroup(){if(null==this._musicGroup){const a=
this.data.music;this._musicGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].musicGroup}}set colorGroup(a){this._colorGroup=a}get colorGroup(){this.ensureColorGroup();return this._colorGroup}ensureColorGroup(){if(null==this._colorGroup){const a=this.data.music;this._colorGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].colorGroup}}lazyInitialization(){this.ensureMeta();this.ensureMusicGroup();this.ensureColorGroup()}get name(){return this.data.name}get mapDataPointer(){if(0>
this.id)throw Error(`no mapdata pointer for ${this.name}`);return 82688+(this.id<<1)}get npcDataPointer(){if(0>this.id)throw Error(`no npcdata pointer for ${this.name}`);return 102913+(this.id<<1)}get hasSpawns(){return 0<this.spawns.length}mapPlane(){var a=new ba(()=>new Set);for(const b of this.screens)for(const c of b)a.get(c>>>8).add(c);if(1!==a.size)throw Error(`Non-unique screen page for ${this}: ${[...a.values()].map(a=>[...a].map(a=>{var b;const [c]=this.rom.metascreens.getById(a);return`${x(a)} ${null!==
(b=null===c||void 0===c?void 0:c.name)&&void 0!==b?b:"??"}`}).join(", ")).join(", ")}`);[a]=a.keys();return a}isShop(){null==this._isShop&&(this._isShop=0<=this.rom.shops.findIndex(a=>a.location===this.id),251===this.id&&(this._isShop=!0));return this._isShop}spawn(a){const b=this.spawns[a-13];if(!b)throw Error(`Expected spawn $${x(a)}`);return b}get width(){return this.layoutWidth+1}set width(a){this.layoutWidth=a-1}get height(){return this.layoutHeight+1}set height(a){this.layoutHeight=a-1}findOrAddEntrance(a,
b){for(let c=0;c<this.entrances.length;c++){const d=this.entrances[c];if(d.screen===a&&d.coord===b)return c}this.entrances.push(Vd.of({screen:a,coord:b}));return this.entrances.length-1}assemble(a){if(this.used){var b=this.id.toString(16).padStart(2,"0"),c=this.spawns.length?this.spritePalettes:[255,255],d=this.spawns.length?this.spritePatterns:[255,255],e=[];d=[0,...c,...d,...Nb(this.spawns),255];a.segment("0c","0d");a.reloc(`NpcData_${b}`);var f=a.pc();a.byte(...d);a.org(37377+(this.id<<1),`NpcData_${b}_Ptr`);
a.word(f);a.segment("17");a.org(48896|this.id);a.byte(+this.checkpoint<<7|+this.saveable);a.segment("0a","0b");d=[];for(var g of Nb(this.screens))d.push(g&255);g=this.rom.compressedMapData?[this.bgm,this.layoutHeight<<4|this.layoutWidth,this.mapPlane()<<2|this.animation,...d]:[this.bgm,this.layoutWidth,this.layoutHeight,this.animation,this.mapPlane()?128:0,...d];a.reloc(`MapData_${b}_Layout`);d=a.pc();a.byte(...g);e.push(d);a.reloc(`MapData_${b}_Graphics`);g=a.pc();a.byte(...this.tilePalettes,this.tileset,
this.tileEffects,...this.tilePatterns);e.push(g);if(1===this.height){for(var h of this.entrances)h.used&&191<h.y&&(h.y=191);for(var k of this.exits)12<k.yt&&(k.yt=12)}a.reloc(`MapData_${b}_Entrances`);h=a.pc();a.byte(...Nb(this.entrances));e.push(h);a.reloc(`MapData_${b}_Exits`);h=a.pc();a.byte(...Nb(this.exits),128|(this.pits.length?64:0)|this.entrances.length);e.push(h);a.reloc(`MapData_${b}_Flags`);h=a.pc();a.byte(...Nb(this.flags),255);e.push(h);h=Nb(this.pits);h.length&&(a.reloc(`MapData_${b}_Pits`),
k=a.pc(),a.byte(...h),e.push(k));a.reloc(`MapData_${b}`);h=a.pc();a.word(...e);a.org(33536+(this.id<<1),`MapData_${b}_Ptr`);a.word(h);b=this.bossId();if(null!=b&&95!==this.id){e=this.rom.bossKills[b].base;h=[,,,166===this.id?0:this.bgm,,...this.tilePalettes,,,,this.spritePalettes[0],,,,,,,,this.animation];a.segment("0f");for(k=0;k<h.length;k++)g=h[k],null!=g&&(a.org(e+k,`Boss_${b}_${k}`),a.byte(g));a.org(47041+5*b,`Boss_${b}_Post`);a.byte(c[1])}}}allScreens(){const a=new Set;for(const b of this.screens)for(const c of b)a.add(this.rom.screens[c]);
return a}bossId(){for(let a=0;14>a;a++)if(this.rom.prg[129373+a]===this.id)return a}hasDolphin(){return 96===this.id||100===this.id||104===this.id}isTower(){return 88===(this.id&248)}reachableTiles(a){a=void 0===a?!1:a;this.hasDolphin()&&(a=!0);const b=new Set(this.exits.map(a=>a.screen<<8|a.tile));var c=new hd;const d=this.rom.tilesets[this.tileset],e=this.rom.tileEffects[this.tileEffects-179];var f=new Set;for(let c=0;c<this.height;c++){const h=this.screens[c];for(let k=0;k<this.width;k++){const p=
this.rom.screens[h[k]],q=c<<4|k,D=this.flags.find(a=>a.screen===q);for(let c=0;240>c;c++){const h=q<<8|c;if(b.has(h))continue;let k=p.tiles[c];var g=e.effects[k];g=a?g&4:g&6;D&&g&&32>k&&d.alternates[k]!=k&&(k=d.alternates[k],g=e.effects[k],g=a?g&4:g&6);g||f.add(h)}}}for(let b of f)a=15===(b&15)?b+241:b+1,f.has(a)&&c.union([b,a]),a=224===(b&240)?b+3872:b+16,f.has(a)&&c.union([b,a]);f=c.map();c=new Set;for(var h of this.entrances)h.used&&c.add(f.get(h.screen<<8|h.tile)||new Set);h=new Map;for(const a of c)for(const b of a)h.set(b,
e.effects[this.rom.screens[this.screens[b>>>12][b>>>8&15]].tiles[b&255]]);return h}screenMover(){const a=new ba(()=>[]),b=ca.concat(this.spawns,this.exits,this.entrances);for(const c of b)a.get(c.screen).push(c);return(b,d)=>{for(const c of a.get(b))c.screen=d}}moveScreen(a,b){const c=ca.concat(this.spawns,this.exits,this.entrances);for(const d of c)d.screen===a&&(d.screen=b)}monsterPlacer(a){this.monstersMoved=!0;const b=this.data.bossScreen,c=this.reachableTiles(!1),d=new Map([...c.keys()].map(a=>
[a,0])),e=[],f=[],g=[],h=[],k=[],p=this.hasDolphin()?37:39;for(const a of d){const [k,q]=a;{const a=this.screens[k>>>12][k>>>8&15];if(a!==b){for(const a of De(k,this.width,this.height))d.has(a)||d.set(a,q+1);q||c.get(k)&p||e.push(k);26===this.id?240===this.rom.screens[a].tiles[k&255]&&h.push(k):2<=q&&4>=q&&h.push(k);3<=q&&7>=q&&f.push(k);12<=q&&g.push(k)}}}return b=>{const c=b.clearance();var d=b.placement();d=[..."normal"===d?e:"moth"===d?f:"bird"===d?g:"plant"===d?h:ja(d)];let p;a:for(;d.length;){var q=
a.nextInt(d.length),[I]=d.splice(q,1);q=(I&3840)>>>4|I&15;I=(I&61440)>>>8|(I&240)>>>4;for(const a of this.entrances){const {x:b,y:d,used:e}=a;if(e&&Math.pow(I-(d>>4),2)+Math.pow(q-(b>>4),2)<Math.pow(c+1,2))continue a}for(const a of this.exits){if(!a.isSeamless())continue;const {x:b,y:d}=a;if(Math.pow(I-(d>>4),2)+Math.pow(q-(b>>4),2)<Math.pow(c+8,2))continue a}for(const a of k){const [,b,d,e]=a;{const a=Math.pow(I-d,2)+Math.pow(q-b,2);if(!a)continue a;if(a<Math.pow(c+e,2)){if(!p||p[2]<a)p=[q,I,a];
continue a}}}p=[q,I,Infinity];break}if(p){const [a,d]=p;k.push([b,a,d,c]);return(d&240|(a&240)>>>4)<<8|(d&15)<<4|a&15}}}resizeScreens(a,b,c,d,e){e=void 0===e?0:e;const f=this.width+b+d;c=this.height+a+c;d=Array.from({length:c},(c,d)=>{d-=a;return Array.from({length:f},(a,c)=>{c-=b;return 0>d||0>c||d>=this.height||c>=this.width?e:this.screens[d][c]})});this.width=f;this.height=c;this.screens=d;for(const c of this.flags)c.xs+=b,c.ys+=a;for(const c of this.pits)c.fromXs+=b,c.fromYs+=a;for(const c of[...this.spawns,
...this.exits])c.xt+=16*b,c.yt+=16*a;for(const c of this.entrances)c.used&&(c.x+=256*b,c.y+=256*a)}writeScreens2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){let f=e[b];null!=f&&(0>f&&(f=~f,this.flags.push(Xd.of({screen:a+d<<4|c+b,flag:this.rom.flags.AlwaysTrue.id}))),this.screens[a+d][c+b]=f)}}}connect(a,b,c){var d=0>a?256:0,e=0>c?256:0;a=0>a?~a:a;c=0>c?~c:c;const f=a>>>4,g=a&15,h=c>>>4,k=c&15,p=b.screens[h][k],[q,t]=Ee[d|this.screens[f][g]],[A,D]=
Ee[e|p];d=this.entrances.length;e=b.entrances.length;this.entrances.push(Vd.of({y:f<<8|q>>>8,x:g<<8|q&255}));b.entrances.push(Vd.of({y:h<<8|A>>>8,x:k<<8|A&255}));for(const c of t)this.exits.push(Wd.of({screen:a,tile:c,dest:b.id,entrance:e}));for(const a of D)b.exits.push(Wd.of({screen:c,tile:a,dest:this.id,entrance:d}))}neighborForEntrance(a){const b=this.entrances[a];if(!b)throw Error(`no entrance ${x(this.id)}:${a}`);for(const a of this.exits){if(a.screen!==b.screen)continue;const c=Math.abs(a.y-
b.y);if(24>Math.abs(a.x-b.x)&&24>c)return this.rom.locations[a.dest]}throw Error(`no exit found near ${x(this.id)}:${a}`);}toString(){return`${super.toString()} ${this.name}`}}function De(a,b,c){const d=[],e=a&61680,f=a&3855;e<(c-1<<12|224)&&d.push(224===(a&240)?a+3872:a+16);e&&d.push(0===(a&240)?a-3872:a-16);f<(b-1<<8|15)&&d.push(15===(a&15)?a+241:a+1);f&&d.push(0===(a&15)?a-241:a-1);return d}
const Ee={21:[37024,[137,138]],25:[24720,[88,89]],150:[16432,[50,51]],151:[44848,[178,179]],152:[16592,[60,61]],153:[45008,[188,189]],154:[8064,[39,40]],158:[57216,[231,232]],193:[20640,[73,74]],194:[24752,[90,91]],410:[53376,[199,200]]};class Fe extends ec{constructor(){super(...arguments);this.action=this.prop([0,248,3]);this.part=this.prop([0,7,-3],[1,224,5]);this.index=this.prop([1,31])}toString(){const a=this.action?` (action ${x(this.action)})`:"";return`MessageId ${this.hex()}: (${x(this.part)}:${x(this.index)}${a}`}get mid(){return`${x(this.part)}:${x(this.index)}`}set mid(a){const b=a.split(":");if(2!==b.length)throw Error(`oops: ${a}`);this.part=Number.parseInt(b[0],16);this.index=Number.parseInt(b[1],16);if(isNaN(this.part)||
isNaN(this.index))throw Error(`oops: ${a}`);}nonzero(){return!(!this.part&&!this.index)}}Fe.size=2;const {$04:Ge,$05:He,$0e:Ie,$1b:Je,$fe:Ke}=y;
class Le extends Yc{constructor(a){super(205);this.rom=a;this.GoaSoldier=new N(this,11);this.LeafElder=new N(this,13);this.LeafElderDaughter=new N(this,17);this.LeafRabbit=new N(this,19);this.WindmillGuard=new N(this,20);this.SleepingWindmillGuard=new N(this,21);this.Akahana=new N(this,22);this.OakElder=new N(this,29);this.OakMother=new N(this,30);this.OakChild=new N(this,31);this.Aryllis=new N(this,35);this.AmazonesGuard=new N(this,37);this.AryllisRightAttendant=new N(this,38);this.AryllisLeftAttendant=
new N(this,39);this.Nadare=new N(this,40);this.SoldierGuard=new N(this,45);this.PortoaThroneRoomBackDoorGuard=new N(this,51);this.PortoaPalaceFrontGuard=new N(this,52);this.PortoaQueen=new Me(this,56);this.FortuneTeller=new N(this,57);this.WaterfallCaveAdventurers=new N(this,58);this.JoelElder=new N(this,61);this.Clark=new N(this,68);this.ShyronGuard=new N(this,78);this.Brokahana=new N(this,84);this.SaharaBunny=new N(this,89);this.Deo=new N(this,90);this.SaharaElder=new N(this,91);this.SaharaElderDaughter=
new N(this,92);this.Zebu=new N(this,94);this.Tornel=new N(this,95);this.Stom=new N(this,96);this.MesiaRecording=new N(this,97);this.Asina=new N(this,98);this.HurtDolphin=new N(this,99);this.Fisherman=new N(this,100);this.StartledVillagerOutsideCave=new N(this,101);this.KensuInCabin=new N(this,104);this.Dolphin=new Ne(this,105);this.SleepingKensu=new N(this,107);this.KensuDisguisedAsDancer=new N(this,108);this.KensuDisguisedAsSoldier=new N(this,109);this.AztecaInShyron=new N(this,110);this.DeadAkahana=
new N(this,112);this.DeadStomsGirlfriend=new N(this,113);this.DeadStom=new N(this,114);this.KensuInSwan=new N(this,116);this.SlimedKensu=new N(this,117);this.FishermanDaughter=new N(this,123);this.Kensu=new N(this,126);this.AkahanaInBrynmaer=new N(this,130);this.AztecaInPyramid=new N(this,131);this.SaberaDisguisedAsMesia=new N(this,132);this.StonedWaterfallCaveAdventurers=new N(this,133);this.StonedAkahana=new N(this,136);this.Mesia=new N(this,142);this.Vampire1=new N(this,192);this.Insect=new N(this,
193);this.Kelbesque1=new N(this,194);this.Rage=new N(this,195);this.Kelbesque2=new N(this,197);this.Sabera2=new N(this,198);this.Mado2=new N(this,199);this.Karmine=new N(this,200);this.StatueOfMoon=new N(this,201);this.StatueOfSun=new N(this,202);this.Draygon=new N(this,203);this.Vampire2=new N(this,204);for(var b in this){const a=this[b];this.hasOwnProperty(b)&&a instanceof N&&(this[a.id]=a,a.name=Cb(b))}for(b=0;205>b;b++)this[b]||(this[b]=new N(this,b));const c=Oe.readAddress(a.prg);this.movementScripts=
w(16,b=>{b=c.plus(2*b).readAddress(a.prg).offset;const d=[];for(;128>a.prg[b];)d.push(a.prg[b++]);return{steps:d,terminate:a.prg[b]}})}write(){const a=this.rom.assembler();for(var b of this)b&&b.used&&b.assemble(a);fc(a,Je,44804,44969);b=[];a.segment("1b","fe","ff");let c=0;for(var d of this.movementScripts){const e=(a.reloc(`MovementScript_${x(c++)}`),a.pc());a.byte(...d.steps,d.terminate);b.push(e)}d=(a.reloc("MovementScriptTable"),a.pc());a.word(...b);Oe.loc(a,"MovementScriptTablePtr");a.word(d);
Oe.plus(5).loc(a,"MovementScriptTablePlus1Ptr");a.word({op:"+",args:[d,{op:"num",num:1}]});return[a.module()]}}
class N extends Xc{constructor(a,b){super(a.rom,b);this.npcs=a;this.spawnConditions=new Map;this.localDialogs=new Map;a=a.rom;if(204<b)throw Error(`Unavailable: ${b}`);this._used=!Pe.has(b)&&(143>b||192<=b);(b=196>b?this.dialogPointer.readAddress(a.prg):null)&&35641===b.org&&(b=null);this.data=Eb(a.prg,this.dataBase.offset,4);for(var c=this.spawnPointer.readAddress(a.prg).offset,d;this.used&&255!==(d=a.prg[c++]);){const b=Xb.read(a.prg,c);c+=2*b.length;this.spawnConditions.set(d,b)}this.globalDialogs=
[];if(b){for(d=b.offset;;){const [b,c]=Qe.parse(a.prg,d);d+=4;b.condition&&this.globalDialogs.push(b);if(c)break}for(b=[];;){c=a.prg[d++];if(255===c)break;b.push([c,a.prg[d++]])}b.length||b.push([-1,0]);c=d;for(const [e,f]of b)for(b=[],this.localDialogs.set(e,b),d=c+f;;){const [c,e]=Re.parse(a.prg,d);d+=c.byteLength();b.push(c);if(e)break}}}get dataBase(){return B.of(this.id&128?He:Ge,33008|(this.id&252)<<6|(this.id&3)<<2)}get spawnPointer(){return B.of(Ie,34272+(this.id<<1))}get dialogPointer(){return B.of(Ie,
35165+(this.id<<1))}get used(){return this._used}set used(a){if(a&&136<this.id&&192>this.id&&142!==this.id)throw Error(`invalid: ${this.id}`);this._used=a}spawnConditionsBytes(){const a=[];for(const [b,c]of this.spawnConditions)a.push(b,...Xb.bytes(c));a.push(255);return a}dialog(a){a=a?a.id:-1;const b=this.localDialogs.get(a);if(b)return b;throw Error(`No local dialog for NPC ${x(this.id)} at ${x(a)}`);}spawns(a){const b=a.id;if(a=this.spawnConditions.get(a.id))return a;throw Error(`No spawn condition for NPC ${x(this.id)} at ${x(b)}`);
}hasDialog(){const a=!(!this.globalDialogs.length&&!this.localDialogs.size);if(142<this.id&&195!==this.id&&a)throw Error(`invalid: ${this.id}`);return a}*allDialogs(){yield*this.globalDialogs;for(const a of this.localDialogs.values())yield*a}dialogBytes(){function a(a){const b=[];for(let c=0;c<a.length;c++)b.push(...a[c].bytes(c===a.length-1));return b}if(!this.hasDialog())return[];const b=[];this.globalDialogs.length?b.push(...a(this.globalDialogs)):b.push(128,0,0,0);const c=[],d=new Map;for(const [e,
f]of this.localDialogs){const g=a(f),h=g.join(","),k=d.get(h);null!=k?b.push(e,k):(d.set(h,c.length),-1!==e&&b.push(e,c.length),c.push(...g))}c.length&&b.push(255,...c);return b}link(a){this.spawnConditions=this.rom.npcs[a].spawnConditions;this.linkDialog(a)}linkDialog(a){a=this.rom.npcs[a];this.globalDialogs=a.globalDialogs;this.localDialogs=a.localDialogs}localDialog(a,b){null==b&&(b=a,a=-1);const c=this.localDialogs.get(a);if(null==c||b>=c.length)throw Error(`No local dialog ${b} for location ${x(a)}`);
return c[b]}isParalyzable(){for(let a=217176;217196>a;a++)if(this.rom.prg[a]===this.id)return!1;return!0}assemble(a){if(this.used){var b=x(this.id);this.dataBase.loc(a,"PersonData_${id}");a.byte(...this.data);a.segment("0e","fe","ff");a.reloc(`SpawnCondition_${b}`);var c=a.pc();a.byte(...this.spawnConditionsBytes());this.spawnPointer.loc(a,`SpawnCondition_${b}_Pointer`);a.word(c);this.hasDialog()&&(a.segment("0e","fe","ff"),a.reloc(`Dialog_${b}`),c=a.pc(),a.byte(...this.dialogBytes()),this.dialogPointer.loc(a,
`Dialog_${b}_Pointer`),a.word(c))}}}class Qe{constructor(a,b){this.condition=a;this.message=b}static of(a,b){const [c,d,e=0]=b;return new Qe(a,Fe.of({part:c,index:d,action:e}))}static parse(a,b=0){const c=Ob(a,b);a=Fe.from(a,b+2);b=c&1023;const d=!!(c&32768);c&8192&&(b=~b);return[new Qe(b,a),d]}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);return[b>>>8,b&255,...this.message.data]}}
class Re{constructor(a,b,c,d){this.condition=a;this.message=b;this.update=c;this.flags=d}clone(){return Re.parse(this.bytes(!1))[0]}static parse(a,b=0){const c=Ob(a,b),d=Fe.from(a,b+2),e=a[b+4];let f=c&1023;const g=!!(c&32768);c&8192&&(f=~f);a=c&16384?Sb.read(a,b+5):[];return[new Re(f,d,e,a),g]}static of(a,b,c=[]){const [d,e,f=0]=b;return new Re(a,Fe.of({part:d,index:e,action:f}),0,c)}byteLength(){return 5+2*this.flags.length}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);this.flags.length&&
(b|=16384);return[b>>>8,b&255,...this.message.data,this.update,...Sb.bytes(this.flags)]}}const Pe=new Set([49,59,60,102,103,106,115,116,130,134,135,137,138,139,140,141,196]);class Me extends N{get expectedSword(){return this.localDialog(3).condition&255}set expectedSword(a){this.localDialog(3).condition=512|a}}
class Ne extends N{constructor(a,b){super(a,b);const c=a.rom.prg,d=Se.readAddress(c).offset;this.spawnScripts=w(9,a=>({entrance:Vd.from(c,d+5*a),movement:c[d+5*a+4]}));this.channelSpawn=Te(Ue.read(c)/5);this.evilSpiritIslandSpawn=Te(Ve.read(c)/5)}assemble(a){super.assemble(a);a.segment("fe");a.org(54952);a.free(45);a.segment("fe","ff");a.reloc("DolphinSpawnTable");const b=a.pc();for(;!this.spawnScripts[this.spawnScripts.length-1].entrance.used;)this.spawnScripts.pop();for(var c=0;c<this.rom.locations.AngrySea.entrances.length;c++){const b=
this.spawnScripts[c];b?a.byte(...b.entrance.data,b.movement):a.byte(255,15,255,15,15)}Ue.loc(a,"DolphinChannelSpawn");a.byte(5*this.channelSpawn);Ve.loc(a,"DolphinEvilSpiritIslandSpawn");a.byte(5*this.evilSpiritIslandSpawn);Se.loc(a,"DolphinSpawnTablePtr");a.word(b);for(c=0;4>c;c++)We.plus(5*c).loc(a,`DolphinSpawnTablePlus${c+1}Ptr`),a.word({op:"+",args:[b,{op:"num",num:c+1}]})}}var Xe,Ye=Xe||(Xe={});Ye.UP=0;Ye.RIGHT=2;Ye.DOWN=4;Ye.LEFT=6;Ye.DOLPHIN=255;Ye.DESPAWN=254;
const Ue=B.of(Ke,54884),Ve=B.of(Ke,54892),Se=B.of(Ke,54906),We=B.of(Ke,54926),Oe=B.of(Je,44627);function Te(a){if(a!==Math.floor(a))throw Error(`Expected integer: ${a}`);return a};class Ze extends Xc{constructor(a,b,c){super(a,b);this.pixels=c||Eb(a.chr,b<<4,16)}pixelAt(a,b){return(this.pixels[a|8]>>b&1)<<1|this.pixels[a]>>b&1}flipH(){return new Ze(this.rom,-1,this.pixels.map(Mb))}flipV(){return new Ze(this.rom,-1,w(16,a=>this.pixels[a&8|~a&7]))}flip(a){let b=this;a&$e.HORIZONTAL&&(b=b.flipH());a&$e.VERTICAL&&(b=b.flipV());return b}write(){const a=this.id<<4;this.rom.chr.subarray(a,a+16).set(this.pixels);return[]}}
class af{constructor(a){this._all=[];this._all=w(a.chr.length>>4,b=>new Ze(a,b))}get(a,b){return b?this._all[a|b]:this._all[a]}set(a,b,c){this._all[a|b].pixels=c}[Symbol.iterator](){return this._all[Symbol.iterator]()}}af.HUD_LF=bf("\n    |L     ..|\n    |L.    .#|\n    |L.  FF.#|\n    |L.  F..#|\n    |LLL FF.#|\n    | ...F..#|\n    |    F ..|\n    |    .   |\n  ",{" ":2,L:1,F:1,"#":1,".":3});
af.HUD_PW=bf("\n    |PPP     |\n    |P..P.   |\n    |PPP.    |\n    |P..     |\n    |P.w.w.w |\n    | .w.w.w |\n    |  .w.w. |\n    |   . .  |\n  ",{" ":2,P:1,w:1,".":3});af.HUD_EY=bf("\n    |EEE     |\n    |E...    |\n    |EEE Y.Y.|\n    |E...Y.Y.|\n    |EEE  Y. |\n    | ... Y. |\n    |     Y. |\n    |        |\n  ",{" ":2,E:1,Y:1,"#":1,".":3});
af.HUD_LV=bf("\n    |        |\n    |L       |\n    |L.      |\n    |L.  v.v.|\n    |L.  v.v.|\n    |LLL  v. |\n    | ... v. |\n    |     .  |\n  ",{" ":2,L:1,v:1,".":3});af.HUD_DL=bf("\n    |        |\n    |DD      |\n    |D.D.L   |\n    |D.D.L.  |\n    |D.D.L.  |\n    |DD. L.  |\n    | .  LLL |\n    |     ...|\n  ",{" ":2,D:1,L:1,".":3});
af.HUD_MP=bf("\n    |M.  M   |\n    |MM.MM.  |\n    |M.M.M.  |\n    |M. .PPP |\n    |M. .P..P|\n    |    PPP.|\n    |    P.. |\n    |    P.  |\n  ",{" ":2,M:1,P:1,".":3});af.HUD_EX=bf("\n    |EEE     |\n    |E...    |\n    |EEE     |\n    |E...    |\n    |EEE x.x.|\n    | ... x. |\n    |    x.x.|\n    |     . .|\n  ",{" ":2,E:1,x:1,".":3});
af.HUD_CLOSE_RIGHT=bf("\n    |________|\n    |____oooo|\n    |____o...|\n    |__ooo...|\n    |__o....o|\n    |__o....o|\n    |__o..oo |\n    |__o..o  |\n  ",{" ":0,".":1,_:2,o:3});af.HUD_CLOSE_LEFT=bf("\n    |________|\n    |oooo____|\n    |...o____|\n    |...ooo__|\n    |o....o__|\n    |o....o__|\n    | oo..o__|\n    |  o..o__|\n  ",{" ":0,".":1,_:2,o:3});af.BLANK_TILE_TEMPLATE="\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n    |        |\n  ";
af.BLANK_TILES=[bf(af.BLANK_TILE_TEMPLATE,{" ":0}),bf(af.BLANK_TILE_TEMPLATE,{" ":1}),bf(af.BLANK_TILE_TEMPLATE,{" ":2}),bf(af.BLANK_TILE_TEMPLATE,{" ":3})];function bf(a,b){a=a.trim().replace(/^[^|]*\||\|[^|]*$/mg,"").replace(/\n/g,"");if(64!==a.length)throw Error(`Bad CHR tile: ${a}`);const c=Array(16).fill(0);for(let e=0,f="";f=a.charAt(e);++e){var d=e>>>3;const a=d;d|=8;const h=~e&7,k=b[f]||0;k&1&&(c[a]|=1<<h);k&2&&(c[d]|=1<<h)}return c}var $e,cf=$e||($e={});cf[cf.HORIZONTAL=64]="HORIZONTAL";
cf[cf.VERTICAL=128]="VERTICAL";function df(a,b,...c){let d=0,e;for(;null!=(e=c[d++]);)if("number"===typeof e)a[b++]=e;else if("string"===typeof e)for(const c of e)a[b++]=c.charCodeAt(0);else throw Error("bad data");}
function ef(a){a[107924]=255;a[118213]=168;a[106870]=255;a[108620]=255;a[120899]=160;a[122987]&=7;a[122991]&=7;a[122995]&=7;a[122999]&=7;a[123003]&=7;a[123012]&=7;a[123035]&=7;a[123065]&=7;a[123141]=47;a[123511]=0;a[123750]=64;a[123761]=0;a[123783]=0;a[123793]=0;df(a,106856,51,51);df(a,107662,51,51);a[105393]=112;a[105397]=113;a[105079]=114;a[105963]=115;a[106565]=116;a[106721]=117;a[106725]=118;a[106729]=119;a[108037]=120;a[107457]=121;a[107461]=122;a[107465]=123;df(a,123063,192,0);df(a,123690,192,
0);df(a,123696,192,0);df(a,123702,192,0);df(a,123104,192,0);df(a,123110,192,0);a[116739]=0;df(a,116749,162,179);a[109190]=254;df(a,251605,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255);for(const b of[231255,231287,231291,231319,231323,231387,231391,231419,231423,231451,231455,231525,231557,231561,231589])a[b]|=1;df(a,157038,"Simea",16,0,"     ",16,0)}
function ff(a,b){{const {flags:{WarpZombie:b},locations:{ZombieTown:c}}=a;a.flags.insertZombieWarpFlag();a.messages.parts[33][0].text=" {1a:Leaf}      {16:Brynmaer} {1d:Oak} \n{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} \n{19:Joel}      Zombie   {20:Swan} \n{23:Shyron}    {18:Goa}      {21:Sahara}";const f=a.nextFreeTrigger("zombie warp");f.used=!0;f.conditions=[];f.message=Fe.of({});f.flags=[b.id];for(const a of c.spawns)a.isTrigger()&&138===a.id&&(a.id=f.id);a.townWarp.locations.splice(7,0,c.id);
if(255!==a.townWarp.locations.pop())throw Error("unexpected");}gf(a);a.items.GlowingLamp.itemUseData[0].message.action=11;{const b=a.nextFreeTrigger("mezame");b.used=!0;b.conditions=[~a.flags.AlwaysTrue.id];b.message=Fe.of({action:4});b.flags=[a.flags.AlwaysTrue.id];a.locations.MezameShrine.spawns.push(Zd.of({tile:136,type:2,id:b.id}))}a.objects[16].atk=3;a.objects[17].atk=6;a.objects[18].atk=8;a.objects[24].atk=3;a.objects[19].atk=5;a.objects[25].atk=5;a.objects[23].atk=7;a.objects[26].atk=7;a.objects[20].atk=
3;a.objects[21].atk=6;a.objects[22].atk=8;a.objects[28].atk=3;a.objects[29].atk=3;a.objects[30].atk=5;a.objects[27].atk=7;a.objects[31].atk=7;if(b.slowDownTornado()){const b=a.objects[18];b.speed=7;b.data[12]=96}a.tileEffects[2].effects[116]=6;a.tileEffects[3].effects[70]=6;for(const b of a.objects)b instanceof F&&!(b.isProjectile()||b.isBoss()||b.isFlyer())&&b!==a.objects.mimic&&(b.terrainSusceptibility|=3);a.objects[51].elements=15;a.items.OpelStatue.selectedItemValue=0;for(const b of[96,100,101,
102,103,104,105,106,107,108,109,111])for(const c of[0,1,2])a.patterns.set(b<<6,c,a.patterns.get(6016,c).pixels);a.objects[12].metasprite=169;for(const b of a.locations)for(const a of b.spawns)a.isChest()&&(a.timed=!1);{const b=a.trigger(160);b.used=!0;b.conditions=[];b.flags=[];b.message=Fe.of({part:0,index:0,action:21});a.objects[94].data[13]=254;a.items.InsectFlute.itemUseData[0].flags=[a.flags.UsedInsectFlute.id]}{const {flags:{BallOfWind:b,TornadoBracelet:c},npcs:{Tornel:f}}=a,g=f.localDialogs.get(33),
h=[g[0],g[2],g[2].clone(),g[1]];h[1].condition=~c.id;h[2].condition=~b.id;h[3].condition=-1;f.localDialogs.set(33,h)}{const b=a.locations;b.GoaFortress_Kelbesque.spawns[0].x-=16;b.GoaFortress_Zebu.spawns.splice(1,1);b.GoaFortress_Tornel.spawns.splice(2,1);b.GoaFortress_Asina.spawns.splice(2,1);b.GoaFortress_Kensu.spawns.splice(3,1);b.GoaFortress_Kensu.spawns.splice(1,1)}hf(a,b);a.npcs[13].localDialogs.get(53)[0].message.action=23;if(b.requireHealedDolphinToRide()){{const {flags:{InjuredDolphin:b,
ShellFlute:c},npcs:{Fisherman:f,FishermanDaughter:g}}=a;f.spawnConditions.set(214,[c.id,b.id]);const h=g.localDialogs.get(-1);h.unshift(h[0].clone());h[0].condition=~b.id;h[1].condition=~c.id}}if(b.saharaRabbitsRequireTelepathy()){{const {flags:{Telepathy:b},npcs:{Deo:c,SaharaBunny:f}}=a;f.globalDialogs.push(Qe.of(~b.id,[26,18]));c.globalDialogs.push(Qe.of(~b.id,[26,19]))}}if(b.leatherBootsGiveSpeed()){const c=a.items[47];c.menuName="Speed Boots";c.messageName="Speed Boots";if(b.changeGasMaskToHazmatSuit()){const b=
a.items[41];b.menuName="Hazmat Suit";b.messageName="Hazmat Suit"}}for(let b=5;12>b;b+=2)a.items[b].menuName=a.items[b].menuName.replace("Ball","Orb"),a.items[b].messageName=a.items[b].messageName.replace("Ball","Orb");{const {items:{AlarmFlute:c},flags:{TalkedToZebuStudent:e,ZebuStudent:f},locations:{MezameShrine:g,Leaf_StudentHouse:h,WaterfallCave4:k,ZebuCave:p},npcs:{WindmillGuard:q,Zebu:t}}=a;a.itemGets[49].inventoryRowStart=32;c.unique=!0;c.basePrice=0;if(b.zebuStudentGivesItem())q.data[1]=49;
else{q.data[1]=255;const b=q.dialog(h)[0];b.condition=~e.id;b.flags.push(e.id);jf(t.spawns(p),f.id,e.id);g.spawns.push(Zd.of({screen:0,tile:155,type:2,id:49}));g.spawns.push(Zd.of({screen:0,tile:149,type:2,id:73}));a.itemGets[73].itemId=a.items.MedicalHerb.id}const A=[[33,.72],[31,.9]];let D=0;for(const b of a.shops)if(b.type===ad.TOOL)for(let c=0,d=b.contents.length;c<d;c++){if(49!==b.contents[c])continue;const [d,e]=A[D++%A.length];b.contents[c]=d;a.shopDataTablesAddress&&(b.prices[c]=Math.round(b.prices[c]*
e))}a.itemGets[91].itemId=29;k.spawn(25).id=16}{const {flags:{Karmine:b,Mado1:e},npcs:{Brokahana:f}}=a;var c=f.localDialogs.get(-1);if(!c)throw Error(`asserted but falsy: ${c}`);const g=c[0];if(g.condition!==~b.id)throw Error(`Bad brokahana condition: ${g.condition}`);g.condition=~e.id}if(b.teleportOnThunderSword()){{const {flags:{WarpShyron:b}}=a;a.itemGets[3].flags.push(b.id)}a.townWarp.thunderSwordWarp=[a.locations.Shyron.id,65]}else a.itemGets[3].acquisitionAction.action=22;{const {tiles:b}=a.screens[161];
b[40]=159;b[55]=35;b[56]=35;b[57]=33;b[71]=141;b[72]=143;b[86]=153;b[87]=154;b[88]=140}if(b.fogLampNotRequired()){{const {flags:{AlwaysTrue:c,InjuredDolphin:e,FogLamp:f,KensuInCabin:g,ReturnedFogLamp:h},items:{ShellFlute:k},locations:{BoatHouse:p,Portoa_FishermanHouse:q},npcs:t}=a,A=b.requireHealedDolphinToRide();k.itemUseData[0].want=A?e.id:c.id;t.KensuInCabin.data[0]=103;t.KensuInCabin.localDialogs.get(-1)[0].message.action=10;t.KensuInCabin.localDialogs.get(-1)[0].flags=[];t.KensuInCabin.spawnConditions.set(p.id,
[h.id,~g.id]);t.Fisherman.spawnConditions.set(q.id,[f.id]);a.itemGets[100].flags=[];a.itemGets[103].copyFrom(a.itemGets[100])}}a.trigger(138).conditions=[~a.flags.CurrentlyRidingDolphin.id];a.messages.parts[29][16].text="The cave entrance appears\nto be underwater. You'll\nneed to swim.";{const {CordelPlainEast:b,KirisaMeadow:c,UndergroundChannel:f}=a.locations;for(const a of[b,c,f])for(const b of a.spawns)b.isChest()&&(b.data[2]|=32)}{const {CordelPlainEast:c,CordelPlainWest:e}=a.locations;for(const a of c.spawns)(a.isChest()||
b.disableTeleportSkip()&&a.isTrigger())&&e.spawns.push(a.clone())}if(b.disableRabbitSkip())for(const b of a.locations.MtSabreNorth_Main.spawns)b.isTrigger()&&134===b.id&&1856===b.x&&(b.x+=16,b.y+=16);if(b.disableFlightStatueSkip()){{const b=a.hitboxes[a.objects.guardianStatueMissile.hitbox],c=a.hitboxes[6];a.objects.guardianStatueMissile.hitbox=c.id;c.x0=b.x0-6;c.w=b.w+12;c.y0=b.y0-2;c.h=b.h+4}}kf(a,b);for(const b in[4,5,8,9])a.tileEffects[9].effects[b]=24,a.tileEffects[2].effects[b]=24;if(b.chargeShotsOnly()){for(const b of[8,
9,39])a.objects[b].collisionPlane=0;a.npcs.Brokahana.data[0]=a.items.FruitOfLime.id}if(b.orbsOptional())for(const b of[16,20,24,29])a.objects[b].terrainSusceptibility&=-5,a.objects[b].level=2;if(b.noBowMode()){{const {flags:{UsedBowOfTruth:b},locations:{Crypt_Draygon2:c,MezameShrine:f}}=a;let g;for(const b of f.spawns)b.isTrigger()&&136===b.tile&&(g=a.trigger(b.id));if(!g)throw Error("Could not find start trigger");g.flags.push(b.id);a.tileEffects[6].effects[88]=0;f.meta.setExit(0,"door",[c.meta.id<<
8|16,"edge:bottom"])}}a.messages.parts[32][15].text+="\nItem: [:ITEM:]";if(b.hardcoreMode())for(const b of a.locations)b.checkpoint=b.saveable=!1;b.shouldUpdateHud()&&(a.patterns.set(3584,0,af.HUD_LF),a.patterns.set(3584,1,af.HUD_PW),a.patterns.set(3584,2,af.HUD_EY),a.patterns.set(3584,3,af.HUD_LV),a.patterns.set(3584,4,af.HUD_DL),a.patterns.set(3584,5,af.HUD_MP),a.patterns.set(3584,6,af.HUD_EX),a.patterns.set(3584,26,af.HUD_CLOSE_LEFT),a.patterns.set(3584,27,af.HUD_CLOSE_RIGHT),a.writeMonsterNames=
!0);b.shouldColorSwordElements()&&lf(a);if(b.hasStatTracking()){{a.prg[143082]=40;for(let b=0;4>b;b++)a.patterns.set(5376,41+b,af.BLANK_TILES[b]);for(let b=143364;144132>b;b++)41<=a.prg[b]&&45>=a.prg[b]&&(a.prg[b]+=127);for(let b=143364;144132>b;b+=192)a.prg[b+160]=42;const b=new Map([[66,160]]);for(let c=142469;142546>c;c++)b.has(a.prg[c])&&(a.prg[c]=b.get(a.prg[c]));for(let b=143364;144132>b;b+=192)for(let c=123;127>=c;c++)169==a.prg[b+c]&&(a.prg[b+c]=42);for(let b=144376;144440>b;b++){let c=a.prg[b];
for(let a=0;8>a;a+=2){const b=3<<a,d=2<<a;(c&b)==b&&(c=c&(255^3<<a)|d)}a.prg[b]=c}const c=[15,48,15,17];for(let b=0;b<c.length;b++)a.prg[144452+b]=c[b];a.prg[144451]=8;for(let b=145114;145222>b;b+=4)a.prg[b]+=128}}}function lf(a){function b(b,d){for(let c=0;10>=c;c++){if(8===c)continue;const e=a.patterns.get(c|b),g=[...e.pixels];for(let a=0;a<e.pixels.length;a++)e.pixels[a]=g[a^8],a>>>3===d&&(e.pixels[a]|=g[a])}}b(4240);b(4304);b(4368);b(4432);b(4496)}
function gf(a){const b=new Set([129,139,144,153,166,167,168,169,170,171,172,a.allocatedTriggers.get("zombie warp")]);for(const c of a.locations)c.used&&(c.spawns=c.spawns.filter(a=>!a.isTrigger()||!b.has(a.id)))}
function kf(a,b){const c=a.locations.LimeTreeLake,d=a.screens[a.metascreens.limeTreeLake.sid];if(b.disableRageSkip()){d.set2d(32,d.get2d(0,143));d.set2d(42,d.get2d(58,1));d.set2d(16,d.get2d(32,4));d.set2d(26,d.get2d(42,5));d.set2d(27,d.get2d(0,16));for(const a of c.spawns)a.tile+=32;a=a.metascreens.limeTreeLake.findExitByType("cave");a.entrance+=8192;a.exits=a.exits.map(a=>a+32)}else d.set2d(144,[[118,118,118,118,119,120,null,null,null,null,121,122,118,118,118,118],[118,118,119,120,null,null,null,
null,null,null,null,null,121,122,118,118]])}
function hf(a,b){function c(a,b){const c=a.indexOf(b);if(0>c)throw Error(`Could not find element ${b} in ${a}`);a.splice(c,1)}function d(a){a.reverse();for(let b=0;b<a.length;b++){const c=a[b+1];a[b].condition=c?~c.condition:-1}}const {locations:{BoatHouse:e,Brynmaer:f,Crypt_Draygon2:g,Joel_Shed:h,Leaf_ElderHouse:k,MtSabreNorth_SummitCave:p,MtSabreWest_Upper:q,PortoaPalace_ThroneRoom:t,Portoa_PalaceEntrance:A,Portoa_AsinaRoom:D,Portoa_FortuneTeller:z,Shyron_Temple:I,StomHouse:X,Swan_DanceHall:T,Swan_Tavern:R,
WindmillCave:U,WaterfallCave4:Xa,WaterfallValleyNorth:wa,ZebuCave:Tb,ZombieTown_HouseBasement:ob},items:{GlowingLamp:gb,KeyToPrison:Ta,LovePendant:Jb,StatueOfOnyx:xb},npcs:{Akahana:hb,AkahanaInBrynmaer:ib,Asina:ac,AztecaInShyron:pc,Clark:qc,Draygon:jb,FortuneTeller:jd,Kensu:kb,KensuInCabin:rc,KensuInSwan:Kb,LeafElder:Nc,LeafRabbit:sc,OakChild:Oc,OakElder:tc,OakMother:uc,PortoaPalaceFrontGuard:kd,PortoaQueen:Pa,PortoaThroneRoomBackDoorGuard:vc,Rage:wc,Stom:xc,StonedAkahana:bc,Tornel:ld,WindmillGuard:Pc,
Zebu:Lb},flags:L}=a;kb.localDialogs.delete(R.id);Kb.link(kb.id);Kb.used=!0;Kb.data=[...kb.data];kb.data[0]=gb.id;T.spawns.find(a=>a.isNpc()&&a.id===kb.id).id=Kb.id;Jb.itemUseData[0].want=256|Kb.id;bc.linkDialog(hb.id);ib.used=!0;ib.link(hb.id);ib.data=[...hb.data];f.spawns.find(a=>a.isNpc()&&a.id===hb.id).id=ib.id;xb.itemUseData[0].want=256|ib.id;Nc.dialog(k).splice(0,0,...Nc.dialog(k).splice(2,1));sc.dialog()[2].condition=L.RescuedLeafElder.id;sc.dialog()[2].flags.push(L.TalkedToLeafRabbit.id);sc.dialog()[3].flags.push(L.TalkedToLeafRabbit.id);
Pc.spawns(U)[1]=~L.WindmillGuardAlarmFluteTradein.id;c(hb.spawns(Xa),~L.BehindWhirlpool.id);c(bc.spawns(Xa),~L.BehindWhirlpool.id);for(var Ua=0;4>Ua;Ua++){var yb=tc.dialog()[Ua];yb.condition!==a.flags.OakElder.id&&(yb.message.action=3)}(()=>{const [a,b,c,d]=uc.dialog();d.condition=~L.RescuedChild.id;b.condition=-1;uc.dialog().splice(0,4,d,c,a,b)})();for(const b of[32,33,34,124,125])d(a.npcs[b].dialog());Oc.dialog().unshift(...Oc.dialog().splice(1,1));vc.spawnConditions.set(t.id,[~L.QueenNotInThroneRoom.id,
~L.MesiaRecording.id]);kd.dialog()[1].condition=L.MesiaRecording.id;Pa.dialog()[3].condition=L.SwordOfWater.id;Pa.dialog()[3].message.action=3;Pa.dialog()[4].flags.push(L.PortoaQueenGoingAway.id);Pa.spawns(t)[1]=~L.MesiaRecording.id;Pa.spawns(D)[0]=L.MesiaRecording.id;Pa.dialog()[1].condition=L.MesiaRecording.id;jd.spawns(z)[1]=~L.MesiaRecording.id;qc.spawnConditions.set(ob.id,[~L.Clark.id]);qc.spawnConditions.set(h.id,[L.Clark.id]);Lb.localDialogs.set(Tb.id,[Re.of(~L.TalkedToZebuInCave.id,[0,26],
[L.TalkedToZebuInCave.id]),Re.of(L.LeafVillagersRescued.id,[0,29]),Re.of(L.LeafAbduction.id,[0,28]),Re.of(L.ZebuAtWindmill.id,[0,29]),Re.of(L.UsedWindmillKey.id,[0,27,3]),Re.of(-1,[0,29])]);c(Lb.spawns(Tb),~L.BehindWhirlpool.id);ld.spawnConditions.delete(q.id);xc.spawnConditions.delete(X.id);c(ac.spawns(D),~L.CalmedAngrySea.id);Ua=a.npcs[52];Ua.spawnConditions.set(t.id,[L.MesiaRecording.id,~L.PortoaQueen.id]);Ua.localDialogs.set(A.id,Ua.localDialogs.get(-1));Ua.data[0]=a.items.FluteOfLime.id;yb=a.messages.alloc();
yb.text="The queen left this for you.";Ua.localDialogs.set(t.id,[Re.of(~L.PortoaQueen.id,[yb.part,yb.id,3]),Re.of(-1,[10,14])]);t.spawns.push(Zd.of({yt:3,xt:12,type:1,patternBank:1,id:Ua.id}));Pa.localDialogs.set(D.id,Pa.dialog().splice(0,2));Pa.localDialogs.set(t.id,Pa.dialog());Pa.localDialogs.delete(-1);rc.spawnConditions.set(e.id,[~L.AbleToRideDolphin.id,L.ReturnedFogLamp.id]);rc.dialog()[0].message.action=2;pc.spawns(I).push(~L.ShyronMassacre.id);a.trigger(130).conditions.push(~L.ShyronMassacre.id);
wc.dialog()[0].condition=L.SwordOfWater.id;jb.spawnConditions.set(g.id,[~L.Draygon2.id]);Lb.dialog(I).unshift(...Lb.dialog(I).splice(1,1));a.trigger(128).conditions=[~L.ShyronMassacre.id,L.TalkedToZebuInShyron.id,L.SwordOfThunder.id];a.trigger(129).conditions=[];b.barrierRequiresCalmSea()&&a.trigger(132).conditions.push(L.CalmedAngrySea.id);a.trigger(140).conditions.push(L.TalkedToZebuInCave.id);a.trigger(141).used=!1;for(const a of p.spawns)a.isTrigger()&&141===a.id&&(a.id=178);(function(a,b){b=
a.findIndex(b);if(0>b)throw Error(`Could not find element in ${a}`);a.splice(b,1)})(wa.spawns,a=>a.isTrigger()&&141===a.id);a.trigger(178).conditions.push(L.Kelbesque1.id);a.trigger(178).flags.push(~L.LeafVillagersCurrentlyAbducted.id,~L.LeafElderCurrentlyAbducted.id,L.LeafVillagersRescued.id);a.trigger(140).conditions.push(~L.Kelbesque1.id);a.trigger(134).conditions.push(~L.Kelbesque1.id);c(Ta.itemUseData[0].flags,~L.LeafVillagersCurrentlyAbducted.id);jf(a.trigger(187).conditions,~L.Rage.id,~L.MesiaRecording.id)}
function jf(a,b,c){for(let d=0;d<a.length;d++)if(a[d]===b){a[d]=c;return}throw Error(`Could not find ${b} in ${a.join(",")}`);};const {$0e:mf,$0f:nf,$10:of,$1a:pf}=y,qf=B.of(mf,33689),rf=B.of(mf,39906),sf=B.of(of,36848),tf=B.of(of,36923),uf=B.of(of,36998),vf=B.of(pf,35776),wf=B.of(pf,35785),xf=[["Sword","\n\x0B\f"],[" of ","\\]"],["Bracelet","<=>["],["Shield","\r\u000e\u000f"],["Armor","{\u0011\u0012"],["Magic","#%("],["Power","\u0013\u0014\u0015"],["Item","\u0016\u0017^"]];
class O extends Xc{constructor(a,b,c={}){super(a.rom,b);this.items=a;const d=this.rom;a[b]=this;this.itemUseData=[];this.trades=c.trades||[];this.use=c.use||!1;this.weight=c.weight||1;this.valueAddr=null!=c.valueAddr?B.of(mf,c.valueAddr):void 0;null!=this.valueAddr&&(this.value=this.valueAddr.read(d.prg));if(this.use){this.itemUseJump=this.itemUseJumpPointer.readAddress(d.prg,mf,nf);b=a.itemUseJumps[this.itemUseJump.org];if(!b)throw Error(`Bad ItemUseJump: ${this.itemUseJump}`);a=this.itemUseDataPointer.readAddress(d.prg,
mf,nf);for(var e of b)b=yf.from(e,d.prg,a),this.itemUseData.push(b),a=a.plus(b.length)}this.itemDataValue=this.itemDataPointer.read(d.prg);this.selectedItemValue=this.selectedItemPointer.read(d.prg);e=this.menuNamePointer.readAddress(d.prg);this.menuName=xf.reduce((a,[b,c])=>a.replace(c,b),Qb(d.prg,e.offset,255))}get messageName(){return this.rom.messages.itemNames[this.id]}set messageName(a){this.rom.messages.itemNames[this.id]=a}get basePrice(){return this.rom.shops.basePrices[this.id]}set basePrice(a){this.rom.shops.basePrices[this.id]=
a}get itemUseJumpPointer(){return qf.plus(this.id<<1)}get itemUseDataPointer(){return rf.plus(this.id<<1)}get itemDataPointer(){return sf.plus(this.id)}get selectedItemPointer(){return tf.plus(this.id)}get menuNamePointer(){return uf.plus(this.id<<1)}itemUseMessages(){const a=new Map;for(const {message:b}of this.itemUseData)a.set(b.mid,b);return[...a.values()]}setName(a){this.messageName=this.menuName=a}get palette(){return this.itemDataValue&3}set palette(a){this.itemDataValue=this.itemDataValue&
-4|a&3}get unique(){return!!(this.itemDataValue&64)}set unique(a){this.itemDataValue=this.itemDataValue&-65|(a?64:0)}get worn(){return!!(this.itemDataValue&32)}set worn(a){this.itemDataValue=this.itemDataValue&-33|(a?32:0)}get solid(){return!!(this.itemDataValue&128)}set solid(a){this.itemDataValue=this.itemDataValue&-129|(a?128:0)}assemble(a){const b=x(this.id);this.itemDataPointer.loc(a,`ItemData_${b}`);a.byte(this.itemDataValue);this.selectedItemPointer.loc(a,`ItemSelectedValue_${b}`);a.byte(this.selectedItemValue);
var c=xf.reduce((a,[b,c])=>a.replace(b,c),this.menuName);a.segment(of);a.reloc(`ItemMenuName_${x(this.id)}`);const d=a.pc();a.byte(c,255);this.menuNamePointer.loc(a,`ItemMenuName_${b}`);a.word(d);if(this.itemUseJump){this.itemUseJumpPointer.loc(a,`ItemUseJump_${b}_Ptr`);a.word(this.itemUseJump.org);c=[];for(var e of this.itemUseData)c.push(...e.bytes());a.segment(mf.name,nf.name);a.reloc(`ItemUseData_${b}`);e=a.pc();a.byte(...c);this.itemUseDataPointer.loc(a,`ItemUseData_${b}_Ptr`);a.word(e)}this.valueAddr&&
(this.valueAddr.loc(a,`ItemValue_${b}`),a.byte(this.value));this.itemUseData.some(a=>a.tradeNpc()===this.rom.npcs.Aryllis.id)&&(a.segment("fe"),a.org(54453),a.byte(this.id-28))}isMagic(){return 65<=this.id&&72>=this.id}}
class yf{constructor(a,b,c,d){this.kind=a;this.want=b;this.message=c;this.flags=d}static from(a,b,c){({offset:c}=c);var d=0;if("expect"===a||"screen"===a)d=b[c+1]<<8|b[c],c+=2;else if("flag"===a){d=Wb.read(b,c);d.length||d.push(-1);if(1<d.length)throw Error(`Flag list too long: ${d}`);d=d[0];c+=2}else"location"===a?d=b[c++]:"empty"!==a&&ja(a);const e=Fe.from(b,c);b=Vb.read(b,c+2);return new yf(a,d,e,b)}bytes(){const a=[];if("expect"===this.kind||"screen"===this.kind)a.push(this.want&255,this.want>>>
8&255);else if("flag"===this.kind){const b=Wb.bytes([this.want]);if(2!==b.length)throw Error(`bad data: ${b}`);a.push(...b)}else"location"===this.kind?a.push(this.want):"empty"!==this.kind&&ja(this.kind);a.push(...this.message.data);a.push(...Vb.bytes(this.flags));return a}tradeNpc(){return"expect"!==this.kind||1!==this.want>>>8?null:this.want&255}get length(){return 2*(1+Math.max(1,this.flags.length))+("empty"===this.kind?0:"location"===this.kind?1:2)}}
class zf extends O{get defense(){return this.items.shieldDefense[this.id-12]}set defense(a){this.items.shieldDefense[this.id-12]=a}}class Af extends O{get defense(){return this.items.armorDefense[this.id-20]}set defense(a){this.items.armorDefense[this.id-20]=a}}
class Bf extends Yc{constructor(a){super(73);this.rom=a;this.itemUseJumps=Cf;this.SwordOfWind=new O(this,0);this.SwordOfFire=new O(this,1);this.SwordOfWater=new O(this,2);this.SwordOfThunder=new O(this,3);this.Crystalis=new O(this,4);this.BallOfWind=new O(this,5);this.TornadoBracelet=new O(this,6);this.BallOfFire=new O(this,7);this.FlameBracelet=new O(this,8);this.BallOfWater=new O(this,9);this.BlizzardBracelet=new O(this,10);this.BallOfThunder=new O(this,11);this.StormBracelet=new O(this,12);this.CarapaceShield=
new zf(this,13);this.BronzeShield=new zf(this,14);this.PlatinumShield=new zf(this,15);this.MirroredShield=new zf(this,16);this.CeramicShield=new zf(this,17);this.SacredShield=new zf(this,18);this.BattleShield=new zf(this,19);this.PsychoShield=new zf(this,20);this.TannedHide=new Af(this,21);this.LeatherArmor=new Af(this,22);this.BronzeArmor=new Af(this,23);this.PlatinumArmor=new Af(this,24);this.SoldierSuit=new Af(this,25);this.CeramicSuit=new Af(this,26);this.BattleArmor=new Af(this,27);this.PsychoArmor=
new Af(this,28);this.MedicalHerb=new O(this,29,{use:!0,trades:[0],valueAddr:34026});this.Antidote=new O(this,30,{use:!0});this.LysisPlant=new O(this,31,{use:!0});this.FruitOfLime=new O(this,32,{use:!0});this.FruitOfPower=new O(this,33,{use:!0,valueAddr:34060});this.MagicRing=new O(this,34,{use:!0});this.FruitOfRepun=new O(this,35,{use:!0});this.WarpBoots=new O(this,36,{use:!0});this.StatueOfOnyx=new O(this,37,{use:!0,trades:[0]});this.OpelStatue=new O(this,38,{use:!0});this.InsectFlute=new O(this,
39,{use:!0});this.FluteOfLime=new O(this,40,{use:!0,trades:[0,1,2,3]});this.GasMask=new O(this,41);this.PowerRing=new O(this,42);this.WarriorRing=new O(this,43);this.IronNecklace=new O(this,44);this.DeosPendant=new O(this,45);this.RabbitBoots=new O(this,46);this.LeatherBoots=new O(this,47);this.ShieldRing=new O(this,48);this.AlarmFlute=new O(this,49,{use:!0,trades:[0,1]});this.WindmillKey=new O(this,50,{use:!0});this.KeyToPrison=new O(this,51,{use:!0});this.KeyToStyx=new O(this,52,{use:!0});this.FogLamp=
new O(this,53,{use:!0,trades:[0]});this.ShellFlute=new O(this,54,{use:!0});this.EyeGlasses=new O(this,55,{use:!0});this.BrokenStatue=new O(this,56,{use:!0});this.GlowingLamp=new O(this,57,{use:!0});this.StatueOfGold=new O(this,58,{use:!0});this.LovePendant=new O(this,59,{use:!0,trades:[0]});this.KirisaPlant=new O(this,60,{use:!0,trades:[0]});this.IvoryStatue=new O(this,61,{use:!0,trades:[0]});this.BowOfMoon=new O(this,62,{use:!0});this.BowOfSun=new O(this,63,{use:!0});this.BowOfTruth=new O(this,64,
{use:!0});this.Refresh=new O(this,65);this.Paralysis=new O(this,66);this.Telepathy=new O(this,67);this.Teleport=new O(this,68);this.Recover=new O(this,69);this.Barrier=new O(this,70);this.Change=new O(this,71);this.Flight=new O(this,72);this.armorDefense=Eb(a.prg,vf.offset,9);this.shieldDefense=Eb(a.prg,wf.offset,9)}write(){const a=this.rom.assembler();vf.loc(a);a.byte(...this.armorDefense);wf.loc(a);a.byte(...this.shieldDefense);const b=Array(10).fill(0);for(const c of this)c.assemble(a),c.unique&&
(b[c.id>>>3]|=1<<(c.id&7));gc(a,[mf,nf],"KeyItemData");a.byte(...b);return[a.module()]}}const Cf={33849:["expect"],33858:["screen"],33872:["empty"],33873:["screen"],33887:["location"],33937:["expect"],33961:["expect","expect"],33971:["location"],34E3:["expect"],34011:[],34016:["expect","empty"],34055:["empty"],34077:["empty"],34084:["empty"],34095:["empty"],34106:["empty"],34122:["empty"],34148:["empty"],34149:["expect"],34155:["flag"],34181:["empty"],34206:["expect","expect","expect","expect"]};new Set([62,63,64]);new Set([0,1,2,3,65,66,67,68,69,70,71,72]);new Map([["Sword of Wind",["Sord of Wind","Sowrd of Wind","Sword of Wien"]],["Sword of Fire",["Sword of Frirer"]],["Sword of Water",["Horde of Otters"]],["Sword of Thunder",["Sorg of Chunker"]],["Flame Bracelet",["Fame Bracelet"]],["Storm Bracelet",["Stom Bracelet"]],["Sacred Shield",["Scared Shield"]],["Bow of Truth",["Bow of Strewth"]],["Statue of Onyx",["Statue of Onxy"]],["Ivory Statue",["Ivory Statute"]],["Fog Lamp",["Frog Lamp","Smog Lamp","Dog Lamp","Bog Lamp","Fog Lump"]],["Glowing Lamp",
["Glowing Lump"]],["Key to Stxy",["Key to Styx"]],["Insect Flute",["Bug Flute","Bug Whistle"]],["Flute of Lime",["Flute of Grime"]],["Iron Necklace",["I Ron Necklace"]],["Shield Ring",["Sho Ring"]],["Deo's Pendant",["Rabbit Necklace","Bunny Pendant"]],["Speed Boots",["Hermes Sandals"]],["Rabbit Boots",["Deo's Boots","Jumping Boots","Rabid Boots"]],["Alarm Flute",["Pocket Rooster","Alarm Clock"]],["Shell Flute",["Conch Shell","Dolphin Flute"]],["Eye Glasses",["3D Glasses","X-Ray Goggles"]],["Kirisa Plant",
["Kilika Plant"]],["Refresh",["Refresherize","Cure","Cura","Curaga"]],["Recover",["Recoverize","Esuna"]],["Paralysis",["Paralycize","Stop","Pew Pew"]],["Telepathy",["Telepathize","Clairvoyance","ESP","Head Talk"]],["Teleport",["Teleportate","Warp","Go"]],["Change",["Changeify","Transform","Disguise"]],["Barrier",["Barrierize","Protect","Wall","Shield"]],["Flight",["Flyify","Blight","Super Jump"]],["Fruit of Lime",["Fruit of Crime","Gold Needle","Soft"]],["Medical Herb",["Potion","Hi Potion"]],["Fruit of Repun",
["Anti-Slime Pill","Maiden's Kiss"]]]);new Map([["Aryllis",["Mimic Queen"]],["Akahana",["Steve","Jerkahana","Mashamahana"]],["Asina",["Athena","Jrowina"]],["Azteca",["Steve"]],["Clark",["Steve","Fred","Mattrick","Clarktrick"]],["Deo",["Steve"]],["Kelbesque",["Linebacker"]],["Kensu",["Steve","Jerksu"]],["Karmine",["Slimelord"]],["Nadare",["Steve"]],["Mado",["Steve"]],["Rage",["Steve"]],["Sabera",["Flamelord"]],["Stom",["Steve"]],["Tornel",["Steve"]],["Zebu",["Steve","Pervy Old Man"]]]);
new Map([["Poison Slime",["Mattrick Slime"]],["Mud Golem",["Bear"]],["Axe Wereboar",["The Axeman"]],["Pillbug",["Tomato"]],["Ice Golem",["Polar Bear"]],["Flail Guy",["Kfal's Dude"]],["Flail Knight",["Kfal's Knight"]],["Flying Plant",["Obnoxious Turnip"]],["Beholder",["Floating Eye"]],["Burt",["Bert","Bort","Sorceror"]],["Mummy",["Tornel Hugger"]],["Robot Sentry",["C-3PO","T-1000","Johnny 5"]],["Robot Enforcer",["ED-209","R2-D2","Agent Smith"]],["Robocopter",["Cylon Drone","Megatron","Vision"]],["DYNA",
["GLaDOS","HAL-9000","Multivac"]]]);new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],[91,"m",
"Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b","Kelbesque",
4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,"m","Kraken",
5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",4,8,10,30,,
110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],[153,"m",
"Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,,,],[188,
"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",,
,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",
,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,
"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([a,b,c,d=0,e=0,f=0,g=0,h=0,k=0])=>[a,{id:a,type:b,name:c,sdef:d,swrd:e,hits:f,satk:g,dgld:h,sexp:k}]));new Map([["stair:up","C"],["edge:top","N"],["edge:left","W"],["edge:right","E"],["cave","C"],["door","C"],["door2","C"],["door3","C"],["fortress","F"]]);new Map([["N","S"],["S","N"],["E","W"],["W","E"],["C","X"],["X","C"],["F","O"],["O","F"]]);new Map([["pawn",54],["inn",55],["armor",56],["tool",57],["tavern",59]]);const Df=new Set(["inn","armor","tool","pawn"]);new Set([...Df,"house","tavern"]);new Set([182]);new Set([89,92,110,111,129,138,163,196]);new Set([85,93,124,188,193]);function Ef(a,b){if(b.eastCave){{b=b.eastCave;const {locations:{EastCave1:d,EastCave2:e,EastCave3:f,SealedCave1:g,ValleyOfWind:h},metascreens:{boundaryE_cave:k,branchNSE:p,branchNWE:q,branchNWSE:t,branchNWS:A,branchWSE:D,caveEmpty:z,deadEndE:I,deadEndE_downStair:X,deadEndE_upStair:T,deadEndN_stairs:R,deadEndS:U,deadEndS_stairs:Xa,deadEndW:wa,deadEndW_downStair:Tb,hallNE:ob,hallNS:gb,hallNW:Ta,hallSE:Jb,hallWS:xb,hallWE:hb,hallNS_entrance:ib,hallNS_ramp:ac,hallNS_wall:pc}}=a;a.locations.allocate(d);
a.locations.allocate(e);b.exit2&&a.locations.allocate(f);for(var c of[d,e,f])c.bgm=c.originalBgm=23,c.entrances=[],c.exits=[],c.pits=[],c.spawns=[],c.flags=[],c.width=c.height=1,c.screens=[[128]],c.tilePalettes=[26,27,5],c.originalTilePalettes=[26,27,5],c.tileset=136,c.tileEffects=181,c.tilePatterns=[20,2],c.spritePatterns=[...g.spritePatterns],c.spritePalettes=[...g.spritePalettes];d.meta=new be(d.id,a.metatilesets.cave,5,5);d.meta.set2d(0,[[I,xb,z,Jb,wa],[z,gb,Jb,Ta,z],[Jb,t,A,z,z],[gb,ac,ob,hb,
xb],[ib,ob,wa,T,Ta]]);e.meta=new be(e.id,a.metatilesets.cave,5,5);e.meta.set2d(0,[[I,xb,U,z,U],[z,gb,gb,z,gb],[z,p,q,D,Ta],[z,ac,z,ob,xb],[I,Ta,z,z,R]]);h.meta.set2d(51,[[k]]);a.tileEffects[0].effects[192]=0;d.meta.attach(67,e.meta,68);d.meta.attach(64,h.meta,51);b.exit1&&(d.meta.set2d(4,[[Tb]]),Ff(d,4,b.exit1));b.exit2&&(f.meta=new be(f.id,a.metatilesets.cave,3,1),f.meta.set2d(0,[[Xa],[pc],[ib]]),f.spawns.push(Zd.from([24,7,35,0])),f.flags.push(Xd.of({screen:16,flag:a.flags.alloc(512)})),e.meta.set2d(64,
[[X]]),e.meta.attach(64,f.meta,0),Ff(f,32,b.exit2));d.spawns.push(Zd.of({screen:33,tile:135,timed:!0,id:2}),Zd.of({screen:18,tile:136,timed:!1,id:2}),Zd.of({screen:19,tile:137,timed:!0,id:2}),Zd.of({screen:50,tile:104,timed:!1,id:2}),Zd.of({screen:65,tile:136,timed:!0,id:2}),Zd.of({screen:51,tile:152,timed:!0,id:2}),Zd.of({screen:3,tile:136,timed:!0,id:2}));e.spawns.push(Zd.of({screen:1,tile:136,timed:!0,id:2}),Zd.of({screen:17,tile:72,timed:!1,id:2}),Zd.of({screen:18,tile:119,timed:!0,id:2}),Zd.of({screen:20,
tile:40,timed:!1,id:2}),Zd.of({screen:35,tile:133,timed:!0,id:2}),Zd.of({screen:49,tile:136,timed:!0,id:2}),Zd.of({screen:51,tile:138,timed:!1,id:2}),Zd.of({screen:52,tile:152,timed:!0,id:2}),Zd.of({screen:65,tile:130,timed:!0,id:2}),Zd.of({y:272,x:1144,type:2,id:89}),Zd.of({y:112,x:264,type:2,id:124}));a.slots.swap(49,89)}}else if(b.classicLimeTreeToLeaf){{const {locations:{ValleyOfWind:b,LimeTreeValley:c},metascreens:{exitE:f,exitW_southwest:g,overworldEmpty_alt:h}}=a;b.meta.set2d(84,[[f]]);c.meta.set2d(16,
[[g],[h]]);b.meta.attach(84,c.meta,16)}}{const {TowerEntrance:b,Crypt_Teleporter:c}=a.locations;c.meta.attach(0,b.meta,0,"teleporter","teleporter")}{const {flags:{OpenedSwanGate:b},locations:{SwanGate:c},npcs:{SoldierGuard:f}}=a;c.spawns.push(Zd.of({xt:10,yt:2,type:1,id:45}),Zd.of({xt:11,yt:2,type:1,id:45}));f.localDialogs.get(c.id)[0].flags.push(b.id)}c=a.locations.GoaFortress_Kensu.meta;for(const [a,b]of c.exits())16>a||b.startsWith("seamless")||c.deleteExit(a,b);Gf(a);Hf(a.locations.SaberaPalace2_West,
a.locations.SaberaPalace2,0,1,16,32,48,49,65,81,97)}(function(a){a.generateOptions=function(a,c){const b={};if(a.addEastCave()){b.eastCave={};a=["cordel","lime","goa","desert"];let d=c.nextInt(4);[b.eastCave.exit1]=a.splice(d,1);b.eastCave.exit2=c.pick(a)}else a.connectLimeTreeToLeaf()&&(b.classicLimeTreeToLeaf=!0);return b}})(Ef||(Ef={}));
function Ff(a,b,c){const {locations:{CordelPlainEast:d,CordelPlainWest:e,Desert2:f,GoaValley:g,LimeTreeValley:h},metascreens:{bendNE:k,bendSE:p,boundaryN_trees:q,boundaryW_cave:t,cornerNE:A,cornerNW:D,cornerSE:z,cornerSE_cave:I,cornerSW:X}}=a.rom;let T,R;switch(c){case "lime":T=h;R=16;T.resizeScreens(0,1,0,0);T.meta.spliceColumns(0,1,2,[[D,q],[t,p],[X,z]]);break;case "cordel":c=[[t,p],[X,z]];T=d;R=85;T.meta.set2d(85,c);e.meta.set2d(85,c);break;case "goa":T=g;R=17;T.meta.set2d(1,[[D,A],[t,k]]);break;
case "desert":T=f,R=83,T.meta.set2d(83,[[I]])}a.meta.attach(b,T.meta,R)}
function Hf(a,b,...c){a.rom.locations.allocate(a,b);a.bgm=b.bgm;a.entrances=[];a.exits=[];a.pits=[];a.spawns=[];a.flags=[];a.width=a.height=1;a.screens=[[128]];a.tilePalettes=[...b.tilePalettes];a.originalTilePalettes=[...b.originalTilePalettes];a.tileset=b.tileset;a.tileEffects=b.tileEffects;a.tilePatterns=[...b.tilePatterns];a.spritePatterns=[...b.spritePatterns];a.spritePalettes=[...b.spritePalettes];let d=0,e=0;for(const a of c)d=Math.max(d,(a>>>4)+1),e=Math.max(e,(a&15)+1);a.meta=new be(a.id,
b.meta.tileset,d,e);for(const d of c)a.meta.set(d,b.meta.get(d)),b.meta.set(d,b.meta.tileset.empty);const f=new Set(c);a.flags=b.flags.filter(a=>f.has(a.screen));b.flags=b.flags.filter(a=>!f.has(a.screen));a.spawns=b.spawns.filter(a=>f.has(a.screen));b.spawns=b.spawns.filter(a=>!f.has(a.screen));b.meta.moveExitsAndPitsTo(a.meta)}function Gf(a){a.locations.ZebuCave.spawns.find(a=>a.isTrigger()).yt+=3};class If extends Xc{constructor(a,b){super(a,b);this.data=Eb(a.prg,this.base,4)}get base(){return(this.id<<2)+171008}get slotRangeLower(){return this.data[0]}set slotRangeLower(a){this.data[0]=a}get slotRangeUpper(){return this.data[1]}set slotRangeUpper(a){this.data[1]=a}get objectId(){return this.data[2]}set objectId(a){this.data[2]=a}get count(){return this.data[3]}set count(a){this.data[3]=a}write(){const a=this.rom.assembler();a.segment("14");a.org(39936+(this.id<<2));a.byte(...this.data);return[a.module()]}}
;class Jf extends Xc{constructor(a,b){super(a,b);this.base=Pb(a.prg,this.pointer);this.data=a.prg.slice(this.base+81920,this.base+81941);this.palettes=this.data.subarray(5,13);this.patterns=this.data.subarray(13,19)}get pointer(){return 129387+2*this.id}get routine(){const a=Pb(this.data,0);return a&&a+81920}set routine(a){var b=this.data;a=a?a-81920:0;b[0]=a&255;b[1]=a>>>8}get restoreMusic(){return this.data[3]}set restoreMusic(a){this.data[3]=a}get itemDrop(){return this.data[4]}set itemDrop(a){this.data[4]=
a}get restoreAnimation(){return this.data[19]}set restoreAnimation(a){this.data[19]=a}get explode(){return!!this.data[20]}set explode(a){this.data[20]=a?1:0}write(){if(!this.base)return[];const a=this.rom.assembler();a.segment("0f");a.org(this.base);a.byte(this.data[0],this.data[1]);a.org(this.base+4);a.byte(this.data[4]);return[a.module()]}};const {$0f:Kf,$1b:Lf}=y;
class Mf{constructor(a){this.rom=a;this.Vampire1=new Nf(this,{flag:this.rom.flags.Vampire1,kill:0,npc:this.rom.npcs.Vampire1,shuffled:!0,sword:1});this.Insect=new Nf(this,{flag:this.rom.flags.GiantInsect,kill:1,npc:this.rom.npcs.Insect,sword:1});this.Kelbesque1=new Nf(this,{flag:this.rom.flags.Kelbesque1,kill:2,npc:this.rom.npcs.Kelbesque1,shuffled:!0});this.Rage=new Nf(this,{flag:this.rom.flags.Rage,kill:3,npc:this.rom.npcs.Rage});this.Sabera1=new Nf(this,{address:222574,flag:this.rom.flags.Sabera1,
kill:4,npc:this.rom.npcs.SaberaDisguisedAsMesia,shuffled:!0});this.Vampire2=new Nf(this,{flag:this.rom.flags.Vampire2,kill:12,npc:this.rom.npcs.Vampire2,shuffled:!0,sword:1});this.Mado1=new Nf(this,{address:251936,flag:this.rom.flags.Mado1,kill:5,shuffled:!0});this.Kelbesque2=new Nf(this,{flag:this.rom.flags.Kelbesque2,kill:6,npc:this.rom.npcs.Kelbesque2,shuffled:!0});this.Sabera2=new Nf(this,{flag:this.rom.flags.Sabera2,kill:7,npc:this.rom.npcs.Sabera2,shuffled:!0});this.Mado2=new Nf(this,{flag:this.rom.flags.Mado2,
kill:8,npc:this.rom.npcs.Mado2,shuffled:!0});this.Karmine=new Nf(this,{flag:this.rom.flags.Karmine,kill:9,npc:this.rom.npcs.Karmine,shuffled:!0,sword:2});this.Draygon1=new Nf(this,{flag:this.rom.flags.Draygon1,kill:10,npc:this.rom.npcs.Draygon,shuffled:!0,sword:2});this.StatueOfMoon=new Nf(this,{flag:this.rom.flags.UsedBowOfMoon,npc:this.rom.npcs.StatueOfMoon});this.StatueOfSun=new Nf(this,{flag:this.rom.flags.UsedBowOfSun,npc:this.rom.npcs.StatueOfSun});this.Draygon2=new Nf(this,{flag:this.rom.flags.Draygon2,
kill:11,npc:this.rom.npcs.Draygon});this.Dyna=new Nf(this,{kill:13,object:164});this.musics=[new Of(Kf,42168,[this.Vampire1,this.Vampire2]),new Of(Kf,42640,[this.Insect]),new Of(Kf,43419,[this.Kelbesque1,this.Kelbesque2]),new Of(Kf,44209,[this.Sabera1,this.Sabera2]),new Of(Kf,44559,[this.Mado1,this.Mado2]),new Of(Kf,44931,[this.Karmine]),new Of(Kf,45447,[this.Draygon1]),new Of(Kf,45841,[this.Draygon2]),new Of(Lf,48176,[this.Dyna])];this.all=[];for(const b in this)this.hasOwnProperty(b)&&(a=this[b],
a instanceof Nf&&(a.name=Cb(b),this.all.push(a)))}isBossFlag(a){return(this.flags||(this.flags=(()=>{const a=new Set;for(const b of this.all)null!=b.flag&&a.add(b.flag.id);return a})())).has(a)}fromLocation(a){return this.all.find(b=>b.location===a)}fromBossKill(a){return this.all.find(b=>b.kill===a)}fromObject(a){return this.all.find(b=>b.object===a)}[Symbol.iterator](){return this.all[Symbol.iterator]()}write(){const a=this.rom.assembler();for(const b of this.musics)b.addr.loc(a),a.byte(b.bgm);
return[a.module()]}}class Of{constructor(a,b,c){this.bosses=c;this.addr=B.of(a,b);this.bgm=this.addr.read(c[0].bosses.rom.prg)}}
class Nf{constructor(a,{flag:b,npc:c,kill:d,shuffled:e,address:f,sword:g=3,object:h}){this.bosses=a;({prg:a}=a.rom);this.flag=b;this.npc=c;this.object=f?a[f]:c?c.data[1]:null!==h&&void 0!==h?h:cb("address, npc, or object is required");this.swordLevel=g;this.shuffled=!!e;this.kill=d;null!=d&&(b=81920+Pb(a,129387+2*d),b=a[b+4],255!==b&&(this.drop=b),this.location=a[129373+d])}};class Pf{constructor(a){this.rom=a;this.values=Eb(a.prg,Qf.offset,16)}write(){const a=this.rom.assembler();Qf.loc(a);a.word(...this.values);return[a.module()]}}const Qf=B.of(y.$1a,35806);const Rf=Symbol(),Sf={assumeFalse:!0},Tf={assumeTrue:!0},Uf={track:!0},Vf={};
class Wf{constructor(a,b,c,d){var e;this.flags=a;this.name=b;this.id=c;this.fixed=d.fixed||!1;this.obsolete=d.obsolete;this.logic=null!==(e=d.logic)&&void 0!==e?e:Uf}get c(){return this.id}get r(){return[[this.id]]}get debug(){return this.id.toString(16).padStart(3,"0")+" "+this.name}get item(){if(256>this.id||383<this.id)throw Error(`not a slot: ${this.id}`);const a=this.flags.rom.items[this.flags.rom.itemGets[this.flags.rom.slots[this.id&255]].itemId];if(!a)throw Error("no item");return a}}
function P(a){"number"===typeof a&&(a=(a=>()=>a)(a));return{obsolete:a,[Rf]:!0}}function Xf(a,b){b=void 0===b?Vf:b;return{id:a,fixed:!0,[Rf]:!0,logic:b}}function Q(a){return Xf(a,Uf)}function Yf(a,b){b=void 0===b?Vf:b;return{id:a,[Rf]:!0,logic:b}}function S(a,b){b=void 0===b?Vf:b;return{name:a,[Rf]:!0,logic:b}}function Zf(a,b){b=void 0===b?Vf:b;return{name:a,[Rf]:!0,logic:b}}function $f(a){const b=ag.get(a)||1024;ag.set(a,b+1);return{id:b,[Rf]:!0,logic:Uf}}const ag=new WeakMap;
class bg{constructor(a){this.rom=a;this[0]=Xf(0,Sf);this[1]=Xf(1);this[2]=Xf(2);this[3]=Xf(3);this[4]=Xf(4);this[5]=Xf(5);this[6]=Xf(6);this[7]=Xf(7);this[8]=Xf(8);this[9]=Xf(9);this.UsedWindmillKey=Xf(10,Uf);this[11]=P(256);this[12]=Zf("Leaf villager");this.LeafVillagersRescued=Yf(13);this[14]=P(a=>{var b;return 133===(null===(b=a.trigger)||void 0===b?void 0:b.id)?323:579});this.WokeWindmillGuard=Yf(15,Uf);this.TurnedInKirisaPlant=Yf(16);this[17]=S("Welcomed to Amazones");this[18]=S("Treasure hunter dead");
this[19]=P(312);this[22]=S("Portoa queen Rage hint");this[23]=P(258);this.EnteredUndergroundChannel=Yf(24,Uf);this[25]=Zf("Portoa queen tired of talking");this[26]=S("Initial talk with Portoa queen");this.MesiaRecording=Yf(27,Uf);this[28]=P(272);this.TalkedToFortuneTeller=Yf(29,Uf);this.QueenRevealed=Yf(30,Uf);this[31]=P(265);this.QueenNotInThroneRoom=Yf(32,Uf);this.ReturnedFogLamp=Yf(33,Uf);this[34]=S("Sahara elder");this[35]=S("Sahara elder daughter");this[36]=P(317);this[37]=P(310);this[38]=P(765);
this.ShyronMassacre=Xf(39,Uf);this.ChangeWoman=Xf(40);this.ChangeAkahana=Xf(41);this.ChangeSoldier=Xf(42);this.ChangeStom=Xf(43);this[45]=S("Shyron sages");this[46]=P(301);this.UsedBowOfTruth=Xf(47);this[49]=S("Zombie town");this[50]=P(311);this[52]=S("Akahana in waterfall cave");this.CuredAkahana=Yf(53,Uf);this[54]=S("Akahana Shyron");this[55]=P(322);this.LeafAbduction=Yf(56,Uf);this[57]=P(321);this.TalkedToZebuInCave=Yf(58,Uf);this.TalkedToZebuInShyron=Yf(59,Uf);this[60]=P(315);this[61]=S("Asina in Shyron temple");
this.FoundKensuInDanceHall=Yf(62,Uf);this[63]=P(a=>{var b;return 186===(null===(b=a.trigger)||void 0===b?void 0:b.id)?580:324});this[64]=S("Tornel in Shyron temple");this[65]=P(263);this[68]=P(263);this.RescuedChild=Xf(69,Uf);this.UsedInsectFlute=Xf(70);this.RescuedLeafElder=Yf(71);this[72]=S("Treasure hunter embarked");this[73]=P(257);this[74]=S("Boat owner");this[75]=Zf("Shyron sick men");this[76]=Zf("Shyron training men 1");this[77]=Zf("Shyron training men 2");this[78]=P(262);this[79]=P(299);this.GivenStatueToAkahana=
Yf(80);this[81]=P(326);this.TalkedToDwarfMother=Yf(82,Uf);this.LeadingChild=Xf(83,Uf);this[85]=S("Zebu rescued");this[86]=S("Tornel rescued");this[87]=S("Asina rescued");this.MtSabreGuardsDespawned=Yf(91,Tf);this[94]=P(653);this[95]=P(515);this.TalkedToStomInSwan=Yf(97,Uf);this[98]=P(337);this[99]=P(327);this.CuredKensu=Yf(101,Uf);this[103]=P(267);this[104]=P(260);this.StonedPeopleCured=Yf(106,Uf);this[108]=P(284);this.CurrentlyRidingDolphin=Xf(-111,Uf);this.ParalyzedKensuInTavern=Xf(112);this.ParalyzedKensuInDanceHall=
Xf(113);this.FoundKensuInTavern=Yf(114,Uf);this[115]=S("Startled man in Leaf");this[117]=P(313);this[118]=S("Kensu in Goa");this[119]=P(264);this[120]=P(268);this[121]=P(320);this[122]=P(266);this[123]=P(265);this[125]=P(319);this[126]=S("Mt Sabre guards 1");this[127]=S("Mt Sabre guards 2");this.AlarmFluteUsedOnce=Xf(118);this.FluteOfLimeUsedOnce=Xf(119);this[130]=P(320);this[131]=S("Rescued Leaf elder");this.LeafVillagersCurrentlyAbducted=Yf(132);this.LeafElderCurrentlyAbducted=Yf(133);this[135]=
P(261);this[136]=P(306);this[137]=S("Dead Stom's girlfriend");this[138]=S("Dead Stom");this[139]=P(566);this[141]=P(311);this[143]=P(643);this[144]=S("Stoned people gone");this[146]=P(296);this[150]=Zf("Leaf elder daughter");this[151]=Zf("Leaf villager");this[152]=S("Nadare villager");this.AbleToRideDolphin=Yf(155,Uf);this.PortoaQueenGoingAway=Yf(156);this[160]=P(295);this[163]=Zf("Portoa queen/fortune teller");this.WokeKensuInLighthouse=Yf(164,Uf);this[165]=P(305);this[166]=S("Oak elder 1",Sf);this[167]=
Zf("Swan dancer");this[168]=S("Oak elder 2",Sf);this.TalkedToLeafRabbit=Yf(169,Uf);this[170]=P(285);this[171]=P(336);this[173]=P(338);this[174]=P(339);this[175]=P(340);this[176]=P(341);this[177]=P(342);this[178]=P(343);this[179]=P(344);this[180]=P(345);this[181]=P(346);this[182]=P(287);this[183]=P(348);this[184]=P(349);this[185]=P(286);this[186]=P(350);this[187]=P(351);this[188]=P(352);this[189]=P(288);this[190]=P(289);this[191]=P(354);this[192]=P(355);this[193]=P(356);this[194]=P(290);this[195]=
P(357);this[196]=P(358);this[197]=P(363);this[198]=P(364);this[199]=P(291);this[200]=P(292);this[201]=P(362);this[202]=P(317);this[203]=P(298);this[204]=P(284);this[205]=P(276);this[206]=P(293);this[207]=P(307);this[208]=P(296);this[209]=P(309);this[210]=P(361);this[211]=P(294);this[212]=P(347);this[213]=Zf("Portoa queen 1");this[214]=Zf("Portoa queen 2");this[215]=Zf("Portoa queen 3");this[216]=S("Kensu rescued");this[217]=Zf("Stoned pair");this[218]=S("Kensu gone from tavern");this[219]=Zf("In Sabera's trap");
this[220]=P(367);this[221]=P(368);this[222]=P(300);this[223]=P(283);this[224]=S("Dead Akahana");this[228]=P(316);this[229]=P(366);this[230]=P(365);this[231]=P(303);this[232]=S("Dead Shyron villager");this[233]=S("Dead Shyron guard");this[234]=S("Tower message 1");this[235]=S("Tower message 2");this[236]=S("Tower message 3");this[237]=S("Mesia");this.TalkedToZebuStudent=Yf(238,Uf);this[256]=P(302);this[257]=P(263);this[258]=P(264);this[259]=P(265);this[261]=P(294);this[262]=P(291);this[263]=P(274);
this[264]=P(317);this.UsedBowOfMoon=Yf(265);this.UsedBowOfSun=Yf(266);this[267]=P(284);this[268]=P(353);this.LeafElder=Q(-257);this.OakElder=Q(-258);this.WaterfallCaveSwordOfWaterChest=Q(-259);this.StxyLeftUpperSwordOfThunderChest=Q(-260);this.MesiaInTower=Q(260);this.SealedCaveBallOfWindChest=Q(-262);this.MtSabreWestTornadoBraceletChest=Q(-263);this.GiantInsect=Q(-264);this.Kelbesque1=Q(-265);this.Rage=Q(-266);this.AryllisBasementChest=Q(-267);this.Mado1=Q(-268);this.StormBraceletChest=Q(-269);this.WaterfallCaveRiverLeftChest=
Q(272);this.Mado2=Q(274);this.StxyRightMiddleChest=Q(276);this.BattleArmorChest=Q(283);this.Draygon1=Q(284);this.SealedCaveSmallRoomBackChest=Q(285);this.SealedCaveBigRoomNortheastChest=Q(286);this.FogLampCaveFrontChest=Q(287);this.MtHydraRightChest=Q(288);this.SaberaUpstairsLeftChest=Q(289);this.EvilSpiritIslandLowerChest=Q(290);this.Sabera2=Q(291);this.SealedCaveSmallRoomFrontChest=Q(292);this.CordelGrass=Q(293);this.Kelbesque2=Q(294);this.OakMother=Q(295);this.PortoaQueen=Q(296);this.AkahanaStatueOfOnyxTradein=
Q(297);this.OasisCaveFortressBasementChest=Q(298);this.Brokahana=Q(299);this.EvilSpiritIslandRiverLeftChest=Q(300);this.Deo=Q(301);this.Vampire1=Q(302);this.OasisCaveNorthwestChest=Q(303);this.AkahanaFluteOfLimeTradein=Q(304);this.ZebuStudent=Q(305);this.WindmillGuardAlarmFluteTradein=Q(306);this.MtSabreNorthBackOfPrisonChest=Q(307);this.ZebuInShyron=Q(308);this.FogLampCaveBackChest=Q(309);this.InjuredDolphin=Q(310);this.Clark=Q(311);this.Sabera1=Q(312);this.KensuInLighthouse=Q(313);this.RepairedStatue=
Q(314);this.UndergroundChannelUnderwaterChest=Q(315);this.KirisaMeadow=Q(316);this.Karmine=Q(317);this.Aryllis=Q(318);this.MtHydraSummitChest=Q(319);this.AztecaInPyramid=Q(320);this.ZebuAtWindmill=Q(321);this.MtSabreNorthSummit=Q(322);this.StomFightReward=Q(323);this.MtSabreWestTornel=Q(324);this.AsinaInBackRoom=Q(325);this.BehindWhirlpool=Q(326);this.KensuInSwan=Q(327);this.SlimedKensu=Q(328);this.MezameShrineLeftChest=Q(329);this.SealedCaveBigRoomSouthwestChest=Q(336);this.MtSabreWestRightChest=
Q(338);this.MtSabreNorthMiddleChest=Q(339);this.FortressMadoHellwayChest=Q(340);this.SaberaUpstairsRightChest=Q(341);this.MtHydraFarLeftChest=Q(342);this.StxyLeftLowerChest=Q(343);this.KarmineBasementLowerMiddleChest=Q(344);this.EastCaveNortheastChest=Q(345);this.OasisCaveEntranceAcrossRiverChest=Q(346);this.EvilSpiritIslandExitChest=Q(348);this.FortressSaberaMiddleChest=Q(349);this.MtSabreNorthUnderBridgeChest=Q(350);this.KirisaPlantCaveChest=Q(351);this.FortressMadoUpperNorthChest=Q(352);this.Vampire2=
Q(353);this.FortressSaberaNorthwestChest=Q(354);this.FortressMadoLowerCenterNorthChest=Q(355);this.OasisCaveNearEntranceChest=Q(356);this.MtHydraLeftRightChest=Q(357);this.FortressSaberaSoutheastChest=Q(358);this.KensuInCabin=Q(359);this.MtSabreWestNearKensuChest=Q(361);this.MtSabreWestLeftChest=Q(362);this.FortressMadoUpperBehindWallChest=Q(363);this.PyramidChest=Q(364);this.CryptRightChest=Q(365);this.KarmineBasementLowerLeftChest=Q(366);this.FortressMadoLowerSoutheastChest=Q(367);this.FogLampCaveMiddleNorthMimic=
Q(368);this.FogLampCaveMiddleSouthwestMimic=Q(369);this.WaterfallCaveFrontMimic=Q(370);this.EvilSpiritIslandRiverRightMimic=Q(371);this.MtHydraFinalCaveMimic=Q(372);this.StxyLeftNorthMimic=Q(373);this.StxyRightNorthMimic=Q(374);this.StxyRightSouthMimic=Q(375);this.CryptLeftPitMimic=Q(376);this.KarmineBasementUpperMiddleMimic=Q(377);this.KarmineBasementUpperRightMimic=Q(378);this.KarmineBasementLowerRightMimic=Q(379);this.EastCaveNorthwestMimic=Q(380);this.SwordOfWind=Q(512);this.SwordOfFire=Q(513);
this.SwordOfWater=Q(514);this.SwordOfThunder=Q(515);this.Crystalis=Q(516);this.BallOfWind=Q(517);this.TornadoBracelet=Q(518);this.BallOfFire=Q(519);this.FlameBracelet=Q(520);this.BallOfWater=Q(521);this.BlizzardBracelet=Q(522);this.BallOfThunder=Q(523);this.StormBracelet=Q(524);this.CarapaceShield=Q(525);this.BronzeShield=Q(526);this.PlatinumShield=Q(527);this.MirroredShield=Q(528);this.CeramicShield=Q(529);this.SacredShield=Q(530);this.BattleShield=Q(531);this.PsychoShield=Q(532);this.TannedHide=
Q(533);this.LeatherArmor=Q(534);this.BronzeArmor=Q(535);this.PlatinumArmor=Q(536);this.SoldierSuit=Q(537);this.CeramicSuit=Q(538);this.BattleArmor=Q(539);this.PsychoArmor=Q(540);this.MedicalHerb=Q(541);this.Antidote=Q(542);this.LysisPlant=Q(543);this.FruitOfLime=Q(544);this.FruitOfPower=Q(545);this.MagicRing=Q(546);this.FruitOfRepun=Q(547);this.WarpBoots=Q(548);this.StatueOfOnyx=Q(549);this.OpelStatue=Q(550);this.InsectFlute=Q(551);this.FluteOfLime=Q(552);this.GasMask=Q(553);this.PowerRing=Q(554);
this.WarriorRing=Q(555);this.IronNecklace=Q(556);this.DeosPendant=Q(557);this.RabbitBoots=Q(558);this.LeatherBoots=Q(559);this.ShieldRing=Q(560);this.AlarmFlute=Q(561);this.WindmillKey=Q(562);this.KeyToPrison=Q(563);this.KeyToStxy=Q(564);this.FogLamp=Q(565);this.ShellFlute=Q(566);this.EyeGlasses=Q(567);this.BrokenStatue=Q(568);this.GlowingLamp=Q(569);this.StatueOfGold=Q(570);this.LovePendant=Q(571);this.KirisaPlant=Q(572);this.IvoryStatue=Q(573);this.BowOfMoon=Q(574);this.BowOfSun=Q(575);this.BowOfTruth=
Q(576);this.Refresh=Q(577);this.Paralysis=Q(578);this.Telepathy=Q(579);this.Teleport=Q(580);this.Recover=Q(581);this.Barrier=Q(582);this.Change=Q(583);this.Flight=Q(584);this.CalmedAngrySea=Q(643);this.OpenedJoelShed=Q(647);this.Draygon2=Q(653);this.OpenedCrypt=Q(654);this.OpenedStxy=Q(688);this.OpenedSwanGate=Q(691);this.OpenedPrison=Q(728);this.OpenedSealedCave=Q(750);this.AlwaysTrue=Xf(752,Tf);this.WarpLeaf=Q(757);this.WarpBrynmaer=Q(758);this.WarpOak=Q(759);this.WarpNadare=Q(760);this.WarpPortoa=
Q(761);this.WarpAmazones=Q(762);this.WarpJoel=Q(763);this.WarpZombie=Q(-764);this.WarpSwan=Q(764);this.WarpShyron=Q(765);this.WarpGoa=Q(766);this.WarpSahara=Q(767);this.Sword=$f(this);this.Money=$f(this);this.BreakStone=$f(this);this.BreakIce=$f(this);this.FormBridge=$f(this);this.BreakIron=$f(this);this.TravelSwamp=$f(this);this.CrossPain=$f(this);this.ClimbWaterfall=$f(this);this.BuyHealing=$f(this);this.BuyWarp=$f(this);this.ShootingStatue=$f(this);this.ClimbSlope8=$f(this);this.ClimbSlope9=$f(this);
this.ClimbSlope10=$f(this);this.WildWarp=$f(this);this.TriggerSkip=$f(this);this.RageSkip=$f(this);this.ShootingStatueSouth=$f(this);this.unallocated=new Map;for(var b in this){if(!this.hasOwnProperty(b))continue;var c=this[b];if(!c[Rf])continue;var d=Number(b);const a="number"===typeof c.id?c.id:d;if(isNaN(a))throw Error(`Bad flag: ${b}`);d=c.name||(isNaN(d)?Cb(b):"Flag "+a.toString(16).padStart(3,"0"));c=new Wf(this,d,a,c);this[b]=c;0>c.id?this.unallocated.set(~c.id,c):this[c.id]||(this[c.id]=c)}for(b=
256;384>b;b++)c=`Check ${x(b&255)}`,this[b]?this[b].fixed||this.unallocated.has(b)||this.unallocated.set(b,new Wf(this,c,~b,{fixed:!0})):this[b]=new Wf(this,c,b,{fixed:!0});for(b=384;640>b;b++)this[b]||(this[b]=new Wf(this,(512>b?"Buffer ":"Item ")+x(b),b,{fixed:!0}));for(const b of a.locations)for(const a of b.flags)this[a.flag]||(this[a.flag]=cg(this,a.flag))}defrag(){function a(a){return()=>a}var b=new Map,c=new Set;for(var d=0;768>d;d++){const a=this[d],e=null===a||void 0===a?void 0:a.obsolete;
e?(b.set(d,b=>b.set?-1:e.call(a,b)),delete this[d]):a||c.add(d)}d=0;let e=767;for(;d<e;){if(this[d]||this.unallocated.has(d)){d++;continue}const c=this[e];c&&!c.fixed&&(b.set(e,a(d)),c.id=d,this[d]=c,delete this[e],d++);e--}this.remapFlags(b,c);for(const a of this.unallocated){const [b,c]=a;this[b]||(this.unallocated.delete(b),(this[b]=c).id=b)}b=[];for(c=0;768>c;c++)this[c]||b.push(c.toString(16).padStart(3,"0"))}insertZombieWarpFlag(){const a=new Map;if(this[756])throw Error("No space to insert warp flag");
const b=~this.WarpZombie.id;if(0>b)throw Error("Bad WarpZombie id");for(let c=756;c<b;c++)this[c]=this[c+1],this[c].id=c,a.set(c+1,()=>c);this.WarpZombie.id=b;this[b]=this.WarpZombie;this.remapFlags(a)}remap(a,b){this.remapFlags(new Map([[a,()=>b]]))}remapFlags(a,b){function c(c,d){for(let f=c.length-1;0<=f;f--){var e=c[f];0>e&&(e=~e);if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);null!=e&&(e=e(Object.assign({},d,{index:f})),0<=e?c[f]=0>c[f]?~e:e:c.splice(f,1))}}function d(c,d){var e=
0>c?~c:c;if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${x(e)}`);e=a.get(e);if(null==e)return c;d=e(d);if(0>d)throw Error("Bad flag delete");return 0>c?~d:d}for(var e of this.rom.locations)if(e.used)for(const a of e.flags)a.flag=d(a.flag,{location:e});for(const a of this.rom.npcs)if(a.used){for(const b of a.spawnConditions){const [d,e]=b;c(e,{npc:a,spawn:d})}for(const b of a.globalDialogs)b.condition=d(b.condition,{npc:a,dialog:!0});for(const b of a.localDialogs){[,e]=b;for(const b of e)b.condition=
d(b.condition,{npc:a,dialog:!0}),c(b.flags,{npc:a,dialog:!0,set:!0})}}for(const a of this.rom.triggers)a.used&&(c(a.conditions,{trigger:a}),c(a.flags,{trigger:a,set:!0}));for(const a of this.rom.itemGets)c(a.flags,{set:!0});for(const a of this.rom.items)for(const b of a.itemUseData)"flag"===b.kind&&(b.want=d(b.want,{})),c(b.flags,{set:!0})}alloc(a){if(512!==(void 0===a?0:a))throw Error("Cannot allocate outside 2xx");for(a=640;768>a;a++)if(!this[a])return this[a]=cg(this,a),a;throw Error("No free flags.");
}free(a){delete this[a]}}function cg(a,b){return new Wf(a,"Wall "+x(b&255),b,{fixed:!0})};class dg extends Xc{constructor(a,b){super(a,b);this.coordinates=Eb(a.prg,this.base,4)}get base(){return 218769+(this.id<<2)}get w(){return this.coordinates[1]}set w(a){this.coordinates[1]=a}get x0(){return Fb(this.coordinates[0])}set x0(a){this.coordinates[0]=0>a?a+256:a}get x1(){return this.x0+this.w}get h(){return this.coordinates[3]}set h(a){this.coordinates[3]=a}get y0(){return Fb(this.coordinates[2])}set y0(a){this.coordinates[2]=0>a?a+256:a}get y1(){return this.y0+this.h}write(){const a=this.rom.assembler();
a.segment("1a");a.org(38545+(this.id<<2));a.byte(...this.coordinates);return[a.module()]}};const {$0e:eg,$0f:fg,$14:gg,$fe:hg,$ff:ig}=y,jg=B.of(eg,39680),kg=B.of(eg,40294);
class lg extends Yc{constructor(a){super(113);this.rom=a;this.actionGrants=new Map;for(let b=0;113>b;b++)this[b]=new mg(a,b);this.actionGrants.set(37,41);this.actionGrants.set(57,58);this.actionGrants.set(59,71);this.actionGrants.set(60,62);this.actionGrants.set(132,70);this.actionGrants.set(178,66);this.actionGrants.set(180,65)}write(){const a=this.rom.assembler();for(const b of this)b.assemble(a);gc(a,[gg,hg,ig],"GrantItemTable");for(const [b,c]of this.actionGrants)a.byte(b,c);return[a.module()]}}
class mg extends Xc{constructor(a,b){super(a,b);this._itemId=this.itemPointer.read(a.prg);const c=this.tablePointer.readAddress(a.prg,eg,fg);let d=c.offset;this.inventoryRowStart=a.prg[d++];this.inventoryRowLength=a.prg[d++];this.acquisitionAction=Fe.from(a.prg,d);this.flags=Ub.read(a.prg,d+2);this.key=254===a.prg[d+2+2*this.flags.length+1];0!==b&&c.org===Pb(a.prg,122214)&&(this.key=!1,this.flags=[])}get itemPointer(){return kg.plus(this.id)}get tablePointer(){return jg.plus(this.id<<1)}get itemId(){return this._itemId}set itemId(a){if(73>
this.id)throw Error(`${this.id}`);this._itemId=a}isLosable(){return ng.has(this.inventoryRowStart)}copyFrom(a){this.inventoryRowStart=a.inventoryRowStart;this.inventoryRowLength=a.inventoryRowLength;this.acquisitionAction=a.acquisitionAction;this.flags=[...a.flags];this.key=a.key}assemble(a){this.itemPointer.loc(a);a.byte(this.itemId);const b=[this.inventoryRowStart,this.inventoryRowLength,...this.acquisitionAction.data,...Ub.bytes(this.flags),this.key?254:255];a.segment(eg.name,fg.name);a.reloc(`ItemGetData ${x(this.id)}`);
const c=a.pc();a.byte(...b);this.tablePointer.loc(a);a.word(c)}}const ng=new Set([4,8,16]);const {$14:og,$15:pg,$16_a:qg,$17:rg}=y,sg=new Map([[6,"{}"],[7,"[]"]]);
class tg{constructor(a,b,c,d,e){this.messages=a;this.part=b;this.id=c;this.bytes=[];this.hex="";a=a.rom.prg;b=[];for(c=d;d&&a[c];c++){const f=a[c];this.bytes.push(f);if(1===f){if(c!==d&&3!==a[c-1])throw Error(`Unexpected start message signal at ${c.toString(16)}`);}else if(2===f)b.push("\n ");else if(3===f)b.push(`${ug.CONTINUED}\n`);else if(4===f)b.push("{:HERO:}");else if(8===f)b.push("[:ITEM:]");else if(5<=f&&9>=f){const d=a[++c];this.bytes.push(d);if(9===f){b.push(" ".repeat(d));continue}const h=
sg.get(f);h&&(b.push(h[0]),b.push(d.toString(16).padStart(2,"0")),b.push(":"));b.push(e(d,f));h&&b.push(h[1]);vg[String.fromCharCode(a[c+1])]||b.push(" ")}else if(128<=f)b.push(e(f,0)),vg[String.fromCharCode(a[c+1])]||b.push(" ");else if(32<=f)b.push(String.fromCharCode(f));else throw Error(`Non-exhaustive switch: ${f} at ${c.toString(16)}`);}this.text=b.join("")}get mid(){return`${x(this.part)}:${x(this.id)}`}fixText(){function a(a,b=a.length){28<f+b&&c();" "===a?(d.push(...h," "),h=[]):/^[[{]:/.test(a)?
h.push({toString:()=>a,length:b}):h.push(a);f+=b;g=a.endsWith(" ")}function b(b){b=b.split(/\s+/);for(let c=0;c<b.length;c++)c&&(g||a(" "),g=!0),a(b[c])}function c(){f=1+h.reduce((a,b)=>a+b.length,0);2<++e?(d.push("#\n "),e=0):d.push("\n ");g=!0}if(!this.checkText()){var d=[],e=0,f=0,g=!1,h=[],k=new Map;for(var p=0;p<this.text.length;p++){var q=this.text[p],t=this.text[p+1];/[\s\n#]/.test(q)?(g||a(" "),g=!0):"{"===q?(":"===t?a("{:HERO:}",6):(q=this.text.indexOf(":",p),q=Number.parseInt(this.text.substring(p+
1,q),16),t=this.messages.extraWords[6][q],k.set(t,`{${q.toString(16)}:${t}}`),b(t)),p=this.text.indexOf("}",p)):"["===q?(":"===t?a("[:ITEM:]",Math.max(...this.messages.rom.items.map(a=>a.messageName.length))):(q=this.text.indexOf(":",p),q=Number.parseInt(this.text.substring(p+1,q),16),t=this.messages.rom.items[q].messageName,k.set(t,`[${q.toString(16)}:${t}]`),b(t)),p=this.text.indexOf("]",p)):a(q)}d.push(...h);p=d.join("");for(const [a,b]of k)p.includes(a)&&(p=p.split(a).join(b));this.text=p}}checkText(){let a=
0,b=0;const c=this.text.replace(/\s+$/mg,"");for(let e=0;e<c.length;e++){const f=c[e];var d=c[e+1];if("\n"===f){if(a++,b=0,3<a)return!1}else if("#"===f)"\n"===d&&e++,a=b=0;else if("{"===f||"["===f){if(":"===d){if(b="{"===f?b+6:b+Math.max(...this.messages.rom.items.map(a=>a.messageName.length)),28<b)return!1}else d=c.indexOf(":",e),d=Number.parseInt(c.substring(e+1,d),16),b+=("{"===f?this.messages.personNames[d]:this.messages.itemNames[d]).length;e=c.indexOf(wg[f],e)}else b++;if(28<b||14<b&&2<a&&c.includes("#",
e))return!1}return!0}}const vg={"\x00":!0," ":!0,"!":!0,"'":!0,",":!0,".":!0,":":!0,";":!0,"?":!0,_:!0,"\n":!0,"#":!0},xg=B.of(og,34564),yg=B.of(og,34442),zg=B.of(og,34517),Ag=B.of(og,34537),Bg=B.of(og,34697),Cg=B.of(og,34113),Dg=B.of(og,34380),Eg=B.of(og,34124),Fg={21:pg,22:qg,23:rg};
class ug{constructor(a){this.rom=a;this.partCount=34;this.commonWords=[];this.uncommonWords=[];this.personNames=[];this.itemNames=[];this.parts=[];const b=xg.readAddress(a.prg);var c=yg.readAddress(a.prg),d=zg.readAddress(a.prg),e=Ag.readAddress(a.prg),f=Cg.readAddress(a.prg);const g=Eg.readAddress(a.prg),h={5:c,6:d,7:e};this.extraWords={5:this.uncommonWords,6:this.personNames,7:this.itemNames};const k=(b,c,d)=>{let e=b[d];if(null!=e)return e;e=Qb(a.prg,c.plus(2*d).readAddress(a.prg).offset);return b[d]=
e};c=(a,c)=>c?k(this.extraWords[c],h[c],a):k(this.commonWords,b,a-128);for(d=0;73>d;d++)c(d,7);f=f.offset;this.banks=Eb(a.prg,f,this.partCount);for(d=this.partCount-1;0<=d;d--){e=g.plus(2*d).readAddress(a.prg);const b=f-e.offset>>>1;f=e.offset;const h=Fg[this.banks[d]],k=this.parts[d]=[];for(let f=0;f<b;f++){const b=e.plus(2*f).readAddress(a.prg,h);k[f]=new tg(this,d,f,b.offset,c)}}}*messages(a){for(const b of this.parts)if(a)for(const c of b)a.has(c.mid)&&(yield c);else yield*b}alloc(){const a=this.uses();
for(const b of this.parts)for(const c of b)if(!a.has(c.mid))return c;throw Error("could not find an unused message id");}uses(){function a(a,c){a="string"===typeof a?a:a.mid;const d=b.get(a)||new Set;d.add(c);b.set(a,d)}const b=new Map;for(var c of this.rom.triggers)c.message.nonzero()&&a(c.message,`Trigger $${x(c.id)}`);for(const b of this.rom.items)for(const c of b.itemUseMessages())c.nonzero()&&a(c,`Item $${x(b.id)}`);for(const b of this.rom.npcs){for(const c of b.globalDialogs)a(c.message,`NPC $${x(b.id)}`);
for(const [d,f]of b.localDialogs){c=0<=d?` @ $${x(d)}`:"";for(const d of f)a(d.message,`NPC $${x(b.id)}${c}`)}}for(const b of this.rom.telepathy.sages){for(const c of b.defaultMessages)a(c,`Telepathy ${b.sage}`);for(const c of b.messageGroups)for(const [,...d]of c.messages)for(const c of d)a(c,`Telepathy ${b.sage}`)}for(const b of Gg)a(b,"Hardcoded");return b}buildAbbreviationTable(a=this.uses()){const b=[];var c=new Map;const d=new Map;for(var e of this.messages(a)){e.fixText();a=e.mid;var f=c.get(e.text);
if(f=null!=f&&d.get(f))f.push(a);else{c.set(e.text,a);d.set(a,[]);f=e.text;var g=[];for(let c=0,d=f.length;c<=d;c++){var h=f[c],k=wg[h];if(vg[h]||k||c===d){var p=f[c+1];k&&(c=Math.max(c,f.indexOf(k,c)));if(g.length){k=" "!==h&&"'"!==h||!p||vg[p]?"":h;p=g.join("");var q=b.length;h=p.length+(" "===h?1:0);g=[];b.push({str:p,id:q,chain:k,bytes:h,used:0,suffixes:new Set,mid:a})}}else g.push(h)}}}c=new Map;for(e=b.length-1;0<=e;e--)for(a=b[e],f=a.bytes-2;0<=f;f--)for(g=a.str.substring(f),h=0,k=a,p=a.bytes-
f-1;;){(q=c.get(g))||c.set(g,q={chains:h,missing:f,saving:-g.length,str:g,words:new Set});q.words.add(e);q.saving+=p;for(let a=h;0<=a;a--)b[e+a].suffixes.add(q);if(!k.chain)break;g+=k.chain;k=b[e+ ++h];g+=k.str;p+=k.bytes}e=new Set;a=[];f=({saving:a},{saving:b})=>b-a;g=[...c.values()].sort(f);for(h=0;g.length&&1250>h;){e.has(g[0].str)&&(g.sort(f),e.clear());const {str:t,saving:A,missing:D,words:z,chains:I}=g.shift();if(0>=A)break;h+=t.length+3;k=a.length;p=new Set;for(const a of z){q=b[a];for(const a of[q.mid,
...d.get(q.mid)||[]])p.add(a)}a.push({bytes:128>k?[k+128]:[5,k-128],mids:p,str:t});for(const a of z)for(k=0;k<=I;k++){p=b[a+k];q=p.bytes-(k?0:D);for(const a of p.suffixes)a.saving-=q-p.used,e.add(a.str);p.used=q}if(128===a.length){for(const a of c.values())a.saving-=a.words.size;g.sort(f);e.clear()}}return a}compress(){var a=this.uses(),b=this.buildAbbreviationTable(a);const c=new Map;this.commonWords.splice(0,this.commonWords.length);this.uncommonWords.splice(0,this.uncommonWords.length);for(var d of b){1===
d.bytes.length?this.commonWords[d.bytes[0]&127]=d.str:this.extraWords[d.bytes[0]][d.bytes[1]]=d.str;for(var e of d.mids)(b=c.get(e))||c.set(e,b=[]),b.push(d)}for(var f of c.values())f.sort(({str:{length:a}},{str:{length:b}})=>b-a);for(const g of this.messages(a)){a=g.text;a=a.replace(/([\[{])([^\]}]*)[\]}](.|$)/g,(a,b,c,d)=>{if(d&&!vg[d])return a;" "===d&&(d="");if("["===b&&":ITEM:"===c)return`[8]${d}`;if("{"===b&&":HERO:"===c)return`[4]${d}`;c=/^([0-9a-f]+):/.exec(c);if(!c)throw Error(`Bad message text: ${a}`);
a=Number.parseInt(c[1],16);return`[${"{"===b?6:7}][${a}]${d}`});for(const {str:b,bytes:d}of c.get(g.mid)||[])a=a.replace(new RegExp(b+"( [ &0-9]|.|$)","g"),(a,b)=>{if(b&&!vg[b])return a;" "===b&&(b="");return d.map(a=>`[${a}]`).join("")+b});d=["[01]"];e=[];e.push(1);for(let c=0,g=a.length;c<g;c++)if(f=a[c],f===ug.CONTINUED)e.push(3,1),d.push("[03][01]"),"\n"===a[c+1]&&c++;else if("\n"===f)e.push(2)," "===a[c+1]&&c++,d.push("[02]");else if("["===f){f=a.indexOf("]",c);if(0>=f)throw Error(`bad text: ${a}`);
b=Number(a.substring(c+1,f));if(isNaN(b))throw Error(`bad text: ${a}`);e.push(b);d.push(`[${x(b)}]`);c=f}else if(" "===f&&" "===a[c+1]){for(f=c+2;" "===a[f];)f++;e.push(9,f-c);d.push(`[09][${x(f-c)}]`);c=f-1}else e.push(f.charCodeAt(0)),d.push(f);e.push(0);d.push("[0]");g.bytes=e;g.hex=d.join("")}}write(){function a(a,c,...d){a.loc(b);b.word(c);let e=0;for(const f of d)a.plus(f).loc(b),b.word({op:"+",args:[c,{op:"num",num:++e}]})}const b=this.rom.assembler();fc(b,og,32768,34048);fc(b,og,34080,34088);
fc(b,og,34182,34195);fc(b,og,35072,37888);fc(b,og,38533,38662);fc(b,og,40576,40960);fc(b,pg,40960,49152);fc(b,qg,40960,49152);fc(b,rg,40960,48128);var c=w(this.partCount,()=>[]);for(var d=0;d<this.partCount;d++){var e=c[d];const a=this.parts[d];b.segment(Fg[this.banks[d]].name);for(const c of a)b.reloc(`Message_${c.mid}`),e.push(b.pc()),b.byte(...c.bytes,0)}d=[];b.segment(og.name);b.reloc("MessagesTable");for(e=0;e<this.partCount;e++)d.push(b.pc()),b.word(...c[e]);c=b.pc();b.byte(...this.banks);b.reloc("MessageParts");
e=b.pc();b.word(...d);a(Cg,c);a(Dg,c);a(Eg,e,5);c=[["CommonWords",this.commonWords,[xg]],["UncommonWords",this.uncommonWords,[yg]],["PersonNames",this.personNames,[zg]],["ItemNames",this.itemNames,[Ag,Bg]]];for(const [e,g,h]of c){c=[];d=0;for(const a of g)a?(b.reloc(`${e}_${x(d++)}`),c.push(b.pc()),b.byte(a,0)):c.push(0);b.reloc(e);d=b.pc();b.word(...c);for(const b of h)a(b,d,5)}return[b.module()]}}ug.CONTINUED="#";const wg={"{":"}","[":"]"},Gg=new Set("20:1d 1b:0f 1b:10 1b:11 1b:12 1b:05 1b:06 1b:07 1f:00 13:00 0b:01 20:0c 20:0f 1c:11 0e:05 16:00 16:02 16:04 16:06 20:11 21:00 21:02 21:01 06:00 18:00 18:02 18:04 18:08 1b:03 1b:00 1b:00 1b:04 06:01 10:13 19:05 20:14 20:15 20:17 20:02 20:0d 20:19 20:1a 20:1b 03:01 03:02 10:10 10:11 10:12 0c:04 0c:05 03:03 20:0e 20:13".split(" "));const Hg={empty:1,pit:2,arena:4,spikes:8,wide:16,river:32,bridge:64,wall:128,ramp:256,overpass:512,underpass:1024,whirlpool:2048,deadend:4096,"stair:up":65536,"stair:down":131072,portoa1:117440512,portoa2:184549376,portoa3:218103808,lake:234881024,lighthouse:318767104,cabin:352321536,windmill:369098752,altar:419430400,pyramid:436207616,crypt:469762048,manual:1073741824,consolidate:2147483648};
function V(a){if(1!=a.length)throw Error("Bad icon input");a=a[0].split("\n");const b=a.slice(1).map(a=>a.replace(/^\s*\||\|\s*$/g,""));return{short:/\S/.test(a[0])?a[0][0]:b[1][1],full:[b[0],b[1],b[2]]}}function Ig(a,...b){a=a.split(/\s+/g);a[0]||a.shift();a[a.length-1]||a.pop();if(240!==a.length)throw Error(`Bad screen definition: ${a.length}`);const c=new Map(b);return Uint8Array.from(a,(a,b)=>{const d=c.get(a);return"number"===typeof d?d:d?d.screen.tiles[b]:parseInt(a,16)})}
function Jg(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:up",dir:2,entrance:(c<<12)+(14===c?10240:6144)|(d<<4)+8,exits:[a]}:{type:"stair:up",dir:0,entrance:c<<12|(d<<4)+(b<<3),exits:w(b,b=>a-16+b)}}
function Kg(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:down",dir:2,entrance:(c<<12)-2048|(d<<4)+8,exits:[a],allowedExits:[a+16,a-16]}:{type:"stair:down",dir:2,entrance:c<<12|3840|(d<<4)+(b<<3),exits:w(b,b=>a+16+b),allowedExits:[...w(b,b=>a+32+b),...w(b,b=>a+b)]}}function Lg(a,b){b=void 0===b?"cave":b;return Object.assign({},Jg(a+16),{type:b})}function W(a,b){b=void 0===b?"door":b;return Object.assign({},Jg(a,1),{type:b})}
function Y(a){var {left:b=7,width:c=2,top:d=2,manual:e=!1}=void 0===a?{}:a;return{type:"edge:top",manual:e,dir:0,entrance:d+1<<12|(b<<4)+(c<<3),exits:w(c,a=>d<<4|a+b)}}function Mg(a){var {left:b=7,width:c=2,shift:d=0,type:e="edge:bottom",manual:f=!1}=void 0===a?{}:a;return{type:e,manual:f,dir:2,entrance:57088|(b<<4)+(c<<3)+16*d,exits:w(c,a=>224|a+b)}}
function Ng(a){var {left:b=7,width:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:bottom",dir:2,entrance:44800|(b<<4)+(c<<3)+16*d,exits:w(c,a=>176|a+b)}}function Og(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:left",dir:1,entrance:(b<<12)+(16*d<<8)+(c<<11)|16,exits:w(c,a=>a+b<<4)}}function Pg(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:right",dir:3,entrance:(b<<12)+(16*d<<8)+(c<<11)|239,exits:w(c,a=>a+b<<4|15)}}
function Qg(a,b){return{type:"seamless:up",dir:0,get entrance(){throw Error("does not make sense");},exits:w(void 0===b?2:b,b=>a+b)}}function Rg(a,b){return{type:"seamless:down",dir:2,get entrance(){throw Error("does not make sense");},exits:w(void 0===b?2:b,b=>a+b)}};class Sg{constructor(a,b,c){var d,e,f,g,h;this.rom=a;this.uid=b;this.data=c;this._tilesets=new Set;this.used=!1;this.neighbors=[new ba(a=>this._checkNeighbor(a,0)),new ba(a=>this._checkNeighbor(a,1))];for(const a of Object.values(c.tilesets))a.requires||(this.used=!0);a=0;for(var k of null!==(d=c.feature)&&void 0!==d?d:[])d=Hg[k],null!=d&&(a|=d);for(var p of null!==(e=c.exits)&&void 0!==e?e:[])if("stair:down"===p.type||"stair:up"===p.type)a|=Hg[p.type];this._features=a;this._isEmpty=!!(a&Hg.empty);
this.flag=c.flag;this.connections=c=[[[]],[[]],[[]],[[]]];for(e=0;4>e;e++){p=k=0;d=c[e][0];for(const b of null!==(f=this.data.connect)&&void 0!==f?f:"")if(Tg[e].includes(b))c[e].push(d=[]);else if(!Ug.has(b)){if("p"===b)a=240|k++;else if("x"===b)a=224|p++;else{a=parseInt(b,16);if(!a)throw Error(`bad term: '${b}'`);a=(a&3)<<(a&4)|(a&8?a&4?256:4096:0)}d.push(a)}for(;k<(null===(g=this.data.poi)||void 0===g?void 0:g.length);)d.push(240|k++);for(;p<(null===(h=this.data.exits)||void 0===h?void 0:h.length);)d.push(224|
p++)}}get features(){return this._features}get manual(){return!!(this._features&Vg)}get counted(){return!!(this._features&Wg)}hasFeature(a){return!!(this._features&Hg[a])}hasFeatures(a){return(this._features&a)===a}withFeature(){throw Error();}isEmpty(){return this._isEmpty}hasStair(){return!!(this._features&(Hg["stair:up"]|Hg["stair:down"]))}withObstruction(){throw Error();}isCompatibleWithTileset(a){for(const b of this._tilesets)if(b.tilesetId===a)return!0;return!1}replace(a,b){const {tiles:c}=
this.screen;for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b);return this}remove(){for(const a of this.tilesets())a.deleteScreen(this)}tilesets(){const a=[];for(const b in this.data.tilesets)a.push(this.rom.metatilesets[b]);return a}setGridTile(...a){this.data.tile=a;for(const a of this.tilesets())a.invalidate()}gridTiles(){var a;let b=null!==(a=this.data.tile)&&void 0!==a?a:[];Array.isArray(b)||(b=[b]);return b.map(a=>a.replace(/\|/g,""))}get sid(){return this.data.id}set sid(a){this.sid!==a&&this.rom.metascreens.renumber(this.sid,
a,new Set(this.tilesets()))}get screen(){const {sid:a,rom:{screens:b}}=this;return 0>a?b.unallocated[~a]:b[a]}unsafeSetId(a){this.data.id=a;for(const a of this._tilesets)a.invalidate()}unsafeAddTileset(a){this._tilesets.add(a)}unsafeRemoveTileset(a){this._tilesets.delete(a)}edgeExits(){var a;let b=0;for(const c of null!==(a=this.data.exits)&&void 0!==a?a:[])a=Xg[c.type],null!=a&&(b|=1<<a);return b}edgeIndex(a){var b;let c=0;const d=null!==(b=this.data.edges)&&void 0!==b?b:"";for(b=0;4>b;b++)if(" "!==
d[b]){if(d[b]!==a)return;c|=1<<b}return c}findExitType(a,b,c){var d,e;for(const f of null!==(d=this.data.exits)&&void 0!==d?d:[])if(f.type.startsWith("seamless")===c&&(d=b&&"edge:bottom"===f.type&&192<=a?a+32:a,f.exits.includes(d)||(null!==(e=f.allowedExits)&&void 0!==e?e:[]).includes(d)))return f}findExitByType(a){const b=this.data.exits.find(b=>b.type===a);if(!b)throw Error(`no exit ${a}`);return b}findEntranceType(a,b){var c,d;for(const e of null!==(c=this.data.exits)&&void 0!==c?c:[]){if(e.type.startsWith("seamless"))continue;
c=b&&"edge:bottom"===e.type&&48896<=a?a+8192:a;const f=(c&240)>>4|(c&61440)>>8;if(e.entrance===c||e.exits.includes(f)||(null!==(d=e.allowedExits)&&void 0!==d?d:[]).includes(f))return e.type}}addCustomFlag(a){this.flag=a?"custom:true":"custom:false"}checkNeighbor(a,b){return(b&2?this:a).neighbors[b&1].get(b&2?a:this)}_checkNeighbor(a,b){const c=this.data.edges;a=a.data.edges;if(c&&a){const d=b^2;if("*"!==c[d]&&c[d]===a[b])return!0}return!1}toString(){return`${ma(this.sid)} ${this.name}`}}
const Xg={"edge:top":0,"edge:left":1,"edge:bottom":2,"edge:right":3},Tg=["|:","|:=-","|","|="],Ug=new Set(["|",":","-","="]),Yg=new Set("arena portoa1 portoa2 portoa3 lake overpass underpass lighthouse cabin windmill altar pyramid crypt".split(" ")),Zg=new Set("pit spikes bridge wall ramp whirlpool".split(" ")),Vg=[...Yg].map(a=>Hg[a]).reduce((a,b)=>a|b),Wg=[...Zg].map(a=>Hg[a]).reduce((a,b)=>a|b);class $g{constructor(a){this.rom=a;this.length=0;this.screensByFix=new ba(()=>[]);this.screensById=new ba(()=>[]);this.registeredFixes=new Set;this.overworldEmpty=this.metascreen({id:0,icon:V`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryW_trees=this.metascreen({id:1,icon:V`
      |\u2588\u258c |
      |\u2588\u258c^|
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaTrees]}},edges:"> >o"});this.boundaryW=this.metascreen({id:2,icon:V`
      |\u2588\u258c |
      |\u2588\u258c |
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"> >o"});this.boundaryE_rocks=this.metascreen({id:3,icon:V`
      |.\u2590\u2588|
      | \u2590\u2588|
      |.\u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:"<o< "});this.boundaryE=this.metascreen({id:4,icon:V`
      | \u2590\u2588|
      | \u2590\u2588|
      | \u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<o< "});this.longGrassS=this.metascreen({id:5,icon:V`
      |vv |
      | vv|
      |   |`,tile:"olo|ooo|   ",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]}},edges:"looo"});this.longGrassN=this.metascreen({id:6,icon:V`
      |   |
      | vv|
      |vv |`,tile:"   |ooo|olo",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]}},edges:"oolo"});this.boundaryS_rocks=this.metascreen({id:7,icon:V`
      | . |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:"o^ ^"});this.fortressTownEntrance=this.metascreen({id:8,icon:V`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |   |`,placement:"manual",tile:["   |oFo|ooo","oo |oFo|ooo"],tilesets:{grass:{}},edges:" vov",exits:[Object.assign({},Jg(166,3),{type:"fortress"})]});this.bendSE_longGrass=this.metascreen({id:9,icon:V`\u2597
      | v |
      |vv\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.exitW_cave=this.metascreen({id:10,icon:V`\u2229
      |\u2588\u2229\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:["   |o< |   ","   |x< |   "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:" n  ",exits:[Lg(72),Og({top:6})]});this.bendNE_grassRocks=this.metascreen({id:11,icon:V`\u259d
      |.\u2590\u2588|
      |  \u2580|
      |;;;|`,tile:"oo |ooo|ogo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass]},desert:{requires:[G.DesertShortGrass,G.DesertRocks]}},edges:"<osv"});this.cornerNW=this.metascreen({id:12,icon:V`\u259b
      |\u2588\u2588\u2588|
      |\u2588 \u2580|
      |\u2588\u258c |`,tile:"   | oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"  >v"});this.overworldEmpty_alt=this.metascreen({id:12,icon:V`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,placement:"manual",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty","manual"],edges:"    ",match:()=>!1,delete:!0});this.cornerNE=this.metascreen({id:13,icon:V`\u259c
      |\u2588\u2588\u2588|
      |\u2580\u2588\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:" v< "});this.cornerSW=this.metascreen({id:14,icon:V`\u2599
      |\u2588\u258c |
      |\u2588\u2588\u2584|
      |\u2588\u2588\u2588|`,tile:" oo| oo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">  ^"});this.cornerSE=this.metascreen({id:15,icon:V`\u259f
      | \u2590\u2588|
      |\u2584\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |oo |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  "});this.exitE=this.metascreen({id:16,icon:V`\u2576
      | \u2590\u2588|
      |   |
      | \u2590\u2588|`,tile:["oo |ooo|oo ","oo |oox|oo "],tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]}},edges:"<o<n",exits:[Pg({top:6})]});this.boundaryN_trees=this.metascreen({id:17,icon:V`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      | ^ |`,tile:"   |ooo|ooo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaTrees]}},edges:" vov"});this.bridgeToPortoa=this.metascreen({id:18,icon:V`\u2574
      |\u2550  |
      |\u255e\u2550\u2550|
      |\u2502  |`,placement:"manual",tile:"roo|1rr| oo",tilesets:{river:{}},feature:["portoa3"],edges:"2*>r",exits:[Og({top:1})]});this.slopeAbovePortoa=this.metascreen({id:19,icon:V`
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2580|
      |\u2502  |`,placement:"manual",tile:" \u2193 | oo|roo",tilesets:{river:{}},feature:["portoa2"],edges:"1*2v"});this.riverBendSE=this.metascreen({id:20,icon:V`
      |w  |
      | \u2554\u2550|
      | \u2551 |`,tile:"ooo|orr|oro",tilesets:{river:{}},edges:"oorr"});this.boundaryW_cave=this.metascreen({id:21,icon:V`
      |\u2588\u258c |
      |\u2588\u2229 |
      |\u2588\u258c |`,tile:" oo| <o| oo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"> >o",exits:[Lg(137)]});this.exitN=this.metascreen({id:22,icon:V`\u2575
      |\u2588 \u2588|
      |\u2580 \u2580|
      | ^ |`,tile:[" o |ooo|ooo"," x |ooo|ooo"],tilesets:{grass:{},river:{},desert:{}},edges:"nvov",exits:[Y()]});this.riverWE_woodenBridge=this.metascreen({id:23,icon:V`\u2550
      |   |
      |\u2550\u2551\u2550|
      |   |`,tile:"ooo|ror|ooo",tilesets:{river:{}},edges:"oror",exits:[Qg(119),Rg(135)]});this.riverBoundaryE_waterfall=this.metascreen({id:24,icon:V`\u2561
      | \u2590\u2588|
      |\u2550\u2550/|
      | \u2590\u2588|`,tile:"oo |rr |oo ",tilesets:{river:{}},edges:"<r< "});this.boundaryE_cave=this.metascreen({id:25,icon:V`
      | \u2590\u2588|
      |v\u2229\u2588|
      |v\u2590\u2588|`,tile:"oo |o< |oo ",tilesets:{river:{},grass:{requires:[G.GrassLongGrass]},desert:{requires:[G.DesertLongGrass]}},edges:"<o< ",exits:[Lg(88)]});this.exitW_southwest=this.metascreen({id:26,icon:V`\u2574
      |\u2588\u258c |
      |\u2580 \u2584|
      |\u2584\u2588\u2588|`,tile:" oo|Boo|   ",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks]},sea:{requires:[G.SeaRocks]}},edges:">* ^",exits:[Og({top:11})]});this.nadare=this.metascreen({id:27,tilesets:{house:{}},exits:[Ng(),W(35),W(37,"door2"),W(42,"door3")]});this.townExitW=this.metascreen({id:28,icon:V`\u2574
      |\u2588\u258c |
      |\u2580 ^|
      |\u2588\u258c |`,tile:" oo|8oo| oo",tilesets:{grass:{},river:{}},edges:">n>o",exits:[Og({top:8,height:3,shift:-.5})]});this.shortGrassS=this.metascreen({id:29,icon:V` |
      |;;;|
      | v |
      |   |`,tile:"ogo|ooo|ooo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass,G.GrassLongGrassRemapping]}},edges:"sooo"});this.townExitS=this.metascreen({id:30,icon:V`\u2577
      | ^ |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x "],tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks,G.DesertTownEntrance]}},edges:"o^n^",exits:[Mg()]});this.swanGate=this.metascreen({id:31,tilesets:{town:{}},exits:[Og({top:3}),Pg({top:9})],flag:"custom:false"});this.riverBranchNSE=this.metascreen({id:32,icon:V`
      | \u2551 |
      | \u2560\u2550|
      | \u2551 |`,tile:"oro|orr|oro",tilesets:{river:{}},edges:"rorr"});this.riverWE=this.metascreen({id:33,icon:V`
      |   |
      |\u2550\u2550\u2550|
      |   |`,tile:"ooo|rrr|ooo",tilesets:{river:{}},edges:"oror"});this.riverBoundaryS_waterfall=this.metascreen({id:34,icon:V`\u2568
      | \u2551 |
      |\u2584\u2551\u2584|
      |\u2588/\u2588|`,tile:"oro|oro|   ",tilesets:{river:{}},edges:"r^ ^"});this.shortGrassSE=this.metascreen({id:35,icon:V`
      |;;;|
      |;  |
      |; ^|`,tile:"ogo|goo|ooo",tilesets:{grass:{}},edges:"ssoo"});this.shortGrassNE=this.metascreen({id:36,icon:V` |
      |;  |
      |;v |
      |;;;|`,tile:"ooo|goo|ogo",tilesets:{grass:{}},edges:"osso"});this.stomHouseOutside=this.metascreen({id:37,icon:V`\u2229
      |\u2588\u2588\u2588|
      |\u258c\u2229\u2590|
      |\u2588 \u2588|`,placement:"manual",tile:["   | H | o ","   | H | x "],tilesets:{grass:{}},exits:[W(104),Mg({shift:.5})]});this.bendNW_trees=this.metascreen({id:38,icon:V`\u2598
      |\u2588\u258c |
      |\u2580 ^|
      | ^^|`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertRocks,G.DesertTrees]},sea:{requires:[G.SeaRocks,G.SeaTrees]}},edges:">voo"});this.shortGrassSW=this.metascreen({id:39,icon:V`
      |;;;|
      |  ;|
      |^ ;|`,tile:"ogo|oog|ooo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass]}},edges:"soos"});this.riverBranchNWS=this.metascreen({id:40,icon:V`
      | \u2551 |
      |\u2550\u2563 |
      | \u2551 |`,tile:"oro|rro|oro",tilesets:{river:{}},edges:"rrro"});this.shortGrassNW=this.metascreen({id:41,icon:V`
      |  ;|
      | v;|
      |;;;|`,tile:"ooo|oog|ogo",tilesets:{grass:{},river:{requires:[G.RiverShortGrass,G.GrassLongGrassRemapping]}},edges:"ooss"});this.valleyBridge=this.metascreen({id:42,icon:V` |
      |\u259b\u2551\u259c|
      | \u2551 |
      |\u2599\u2551\u259f|`,tile:[" o | o | o "," x | o | o "," o | o | x "],tilesets:{grass:{},river:{}},edges:"n n ",exits:[Qg(119),Rg(135),Y(),Mg()]});this.exitS_cave=this.metascreen({id:43,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588 \u2588|`,tile:["   | < | o ","   | < | x "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"  n ",exits:[Lg(103),Mg()]});this.outsideWindmill=this.metascreen({id:44,icon:V`\u2573
      |\u2588\u2588\u2573|
      |\u2588\u2229\u2588|
      |\u2588 \u2588|`,placement:"manual",tile:["   | W | o ","   | W | x "],tilesets:{grass:{}},flag:"custom:false",feature:["windmill"],edges:"  n ",exits:[Lg(99),Mg(),W(137,"windmill"),W(140)]});this.townExitW_cave=this.metascreen({id:45,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u2584\u2584\u2588|
      |\u2588\u2588\u2588|`,tile:"   |x< |   ",tilesets:{grass:{}},edges:" n  ",exits:[Lg(74),Og({top:5,height:3,shift:-.5})],flag:"custom:true"});this.riverNS=this.metascreen({id:46,icon:V`
      | \u2551 |
      | \u2551 |
      | \u2551 |`,tile:"oro|ooo|oro",tilesets:{river:{}},edges:"roro",mod:"bridge"});this.riverNS_bridge=this.metascreen({id:47,icon:V`
      | \u2551 |
      |w\u254fw|
      | \u2551 |`,placement:"mod",tile:"oro|oro|oro",tilesets:{river:{}},feature:["bridge"],edges:"roro",wall:119});this.riverBendWS=this.metascreen({id:48,icon:V`
      | w\u259c|
      |\u2550\u2557w|
      | \u2551 |`,tile:"oo |rro|oro",tilesets:{river:{}},edges:"<rrv"});this.boundaryN_waterfallCave=this.metascreen({id:49,icon:V`
      |\u259b/\u2588|
      |\u2598\u2551\u2580|
      | \u2551 |`,tile:"   |oro|oro",tilesets:{river:{}},edges:" vrv",exits:[{type:"cave",dir:0,entrance:28767,exits:[102,118]}]});this.open_trees=this.metascreen({id:50,icon:V`
      | ^ |
      |^ ^|
      | ^ |`,tile:"ooo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[G.DesertTrees,G.DesertRocks]}},edges:"oooo"});this.exitS=this.metascreen({id:51,icon:V`\u2577
      | w |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x |"],tilesets:{grass:{},river:{},desert:{requires:[G.DesertMarsh]},sea:{requires:[G.SeaMarsh]}},edges:"o^n^",exits:[Mg()]});this.bendNW=this.metascreen({id:52,icon:V`\u2598
      |\u2588\u258c |
      |\u2580\u2580 |
      |   |`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">voo"});this.bendNE=this.metascreen({id:53,icon:V`\u259d
      | \u2590\u2588|
      |  \u2580|
      |   |`,tile:"oo |ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<oov"});this.bendSE=this.metascreen({id:54,icon:V`\u2597
      |   |
      | \u2584\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.bendWS=this.metascreen({id:55,icon:V`\u2596
      |   |
      |\u2584\u2584 |
      |\u2588\u258c |`,tile:"ooo|ooo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^>o"});this.towerPlain_upStair=this.metascreen({id:56,icon:V`\u2534
      | \u250a |
      |\u2500\u2534\u2500|
      |   |`,tile:" t |ttt|   ",tilesets:{tower:{}},edges:"st t",exits:[Y({left:8}),Rg(8,2)]});this.towerRobotDoor_downStair=this.metascreen({id:57,icon:V`\u252c
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u250a |`,tile:"   |ttt| t ",tilesets:{tower:{}},edges:" tst",exits:[Qg(232,2),Rg(248,2)]});this.towerDynaDoor=this.metascreen({id:58,icon:V`\u2229
      | \u2229 |
      |\u2514\u252c\u2518|
      | \u250a |`,tile:"   | < | t ",tilesets:{tower:{}},edges:"  s ",exits:[Lg(103,"door")]});this.towerLongStairs=this.metascreen({id:59,icon:V`
      | \u250a |
      | \u250a |
      | \u250a |`,tile:" t | t | t ",tilesets:{tower:{}},edges:"s s ",exits:[Mg()]});this.towerMesiaRoom=this.metascreen({id:60,tilesets:{tower:{}},exits:[Ng()]});this.towerTeleporter=this.metascreen({id:61,tilesets:{tower:{}},exits:[Ng(),Lg(87,"teleporter")]});this.caveAbovePortoa=this.metascreen({id:62,icon:V`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |\u2588\u2193\u2588|`,placement:"manual",tile:"   | < | \u2193 ",tilesets:{river:{}},edges:"  1 ",feature:["portoa1"],exits:[Lg(102)]});this.cornerNE_flowers=this.metascreen({id:63,icon:V`\u259c
      |\u2588\u2588\u2588|
      |\u2580*\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{}},edges:" v< "});this.towerEdge=this.metascreen({id:64,icon:V` |
      |   |
      |\u2524 \u251c|
      |   |`,tile:"   |t t|   ",tilesets:{tower:{}},edges:" t t"});this.towerEdgeW=this.metascreen({id:64,icon:V` |
      |   |
      |\u2524  |
      |   |`,tile:"   |t  |   ",tilesets:{tower:{}},edges:" t  "});this.towerEdgeE=this.metascreen({id:64,icon:V` |
      |   |
      |  \u251c|
      |   |`,tile:"   |  t|   ",tilesets:{tower:{}},edges:"   t"});this.towerRobotDoor=this.metascreen({id:65,icon:V`\u2500
      | O |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ttt|   ",tilesets:{tower:{}},edges:" t t"});this.towerDoor=this.metascreen({id:66,icon:V`\u2229
      | \u2229 |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |t<t|   ",tilesets:{tower:{}},edges:" t t",exits:[Lg(88)]});this.house_bedroom=this.metascreen({id:67,tilesets:{house:{}},exits:[Ng()]});this.shed=this.metascreen({id:68,tilesets:{house:{}},exits:[Ng(),Lg(73)],flag:"custom:false"});this.tavern=this.metascreen({id:69,tilesets:{house:{}},exits:[Ng()]});this.house_twoBeds=this.metascreen({id:70,tilesets:{house:{}},exits:[Ng()]});this.throneRoom_amazones=this.metascreen({id:71,tilesets:{house:{}},exits:[Ng({width:3}),Kg(76,1)]});
this.house_ruinedUpstairs=this.metascreen({id:72,tilesets:{house:{}},exits:[Ng(),Kg(156,1)]});this.house_ruinedDownstairs=this.metascreen({id:73,tilesets:{house:{}},exits:[Jg(86,1)]});this.foyer=this.metascreen({id:74,tilesets:{house:{}},exits:[Ng({shift:.5}),W(40),W(83,"door2"),W(92,"door3")]});this.throneRoom_portoa=this.metascreen({id:75,tilesets:{house:{}},exits:[Ng(),W(43)]});this.fortuneTeller=this.metascreen({id:76,tilesets:{house:{}},exits:[Ng(),W(86),W(89,"door2")]});this.backRoom=this.metascreen({id:77,
tilesets:{house:{}},exits:[Ng()]});this.dojo=this.metascreen({id:78,tilesets:{house:{}},exits:[Ng({shift:-.5})]});this.windmillInside=this.metascreen({id:79,tilesets:{house:{}},exits:[Ng({left:9,width:1})]});this.horizontalTownMiddle=this.metascreen({id:80,tilesets:{town:{}},exits:[W(76),W(85,"door2")],tallHouses:[53]});this.brynmaerRight_exitE=this.metascreen({id:81,tilesets:{town:{type:"horizontal"}},exits:[Pg({top:8}),W(65)]});this.brynmaerLeft_deadEnd=this.metascreen({id:82,tilesets:{town:{type:"horizontal"}},
exits:[W(73),W(76,"door2")]});this.swanLeft_exitW=this.metascreen({id:83,tilesets:{town:{type:"horizontal"}},exits:[Og({top:9}),W(73),W(94,"door2")]});this.swanRight_exitS=this.metascreen({id:84,tilesets:{town:{type:"horizontal"}},exits:[Mg({left:3}),W(65),W(67,"door2"),W(87,"door3")]});this.horizontalTownLeft_exitN=this.metascreen({id:85,tilesets:{town:{type:"horizontal"}},exits:[Y({left:13}),W(70),W(75,"door2")]});this.amazonesRight_deadEnd=this.metascreen({id:86,tilesets:{town:{type:"horizontal"}},
exits:[W(64),W(88,"door2")]});this.saharaRight_exitE=this.metascreen({id:87,tilesets:{town:{type:"horizontal"}},exits:[Pg({top:7}),W(64),W(102,"door2")]});this.portoaNW=this.metascreen({id:88,tilesets:{town:{type:"square"}},exits:[Lg(71,"fortress"),Mg()]});this.portoaNE=this.metascreen({id:89,tilesets:{town:{type:"square"}},exits:[W(99),W(138,"door2"),Mg({left:3,width:4})]});this.portoaSW_exitW=this.metascreen({id:90,tilesets:{town:{type:"square"}},exits:[Og({top:9}),W(134),Y()]});this.portoaSE_exitE=
this.metascreen({id:91,tilesets:{town:{type:"square"}},exits:[Pg({top:9}),W(122),W(135,"door2")],tallHouses:[90]});this.dyna=this.metascreen({id:92,tilesets:{tower:{}},exits:[{type:"stair:down",manual:!0,dir:2,entrance:49024,exits:[]}]});this.portoaFisherman=this.metascreen({id:93,tilesets:{town:{type:"square"}},exits:[Pg({top:6}),Og({top:4,height:6,shift:.5}),W(104)]});this.verticalTownTop_fortress=this.metascreen({id:94,tilesets:{town:{type:"vertical"}},exits:[Lg(71,"fortress"),Mg()]});this.shyronMiddle=
this.metascreen({id:95,tilesets:{town:{type:"vertical"}},exits:[W(84),W(91,"door2"),Y()]});this.shyronBottom_exitS=this.metascreen({id:96,tilesets:{town:{type:"vertical"}},exits:[Mg({left:3}),W(4),W(6,"door2"),W(153,"door3")]});this.zombieTownMiddle=this.metascreen({id:97,tilesets:{town:{type:"vertical"}},exits:[W(153),Y()]});this.zombieTownBottom_caveExit=this.metascreen({id:98,tilesets:{town:{type:"vertical"}},exits:[Lg(146),W(35),W(77,"door2")]});this.leafNW_houseShed=this.metascreen({id:99,tilesets:{town:{type:"square"}},
exits:[W(140),W(149,"door2")]});this.squareTownNE_house=this.metascreen({id:100,tilesets:{town:{type:"square"}},exits:[Y({left:1}),W(183)]});this.leafSW_shops=this.metascreen({id:101,tilesets:{town:{type:"square"}},exits:[W(119),W(138,"door2")],tallHouses:[106]});this.leafSE_exitE=this.metascreen({id:102,tilesets:{town:{type:"square"}},exits:[Pg({top:3,height:3,shift:-.5}),W(132)]});this.goaNW_tavern=this.metascreen({id:103,tilesets:{town:{type:"square"}},exits:[W(186)]});this.squareTownSW_exitS=
this.metascreen({id:104,tilesets:{town:{type:"square"}},exits:[Mg({left:8}),W(132)]});this.goaSE_shop=this.metascreen({id:105,tilesets:{town:{type:"square"}},exits:[W(130)]});this.joelNE_shop=this.metascreen({id:106,tilesets:{town:{type:"square"}},exits:[W(167)]});this.joelSE_lake=this.metascreen({id:107,tilesets:{town:{type:"square"}}});this.oakNW=this.metascreen({id:108,tilesets:{town:{type:"square"}},exits:[W(231)]});this.oakNE=this.metascreen({id:109,tilesets:{town:{type:"square"}},exits:[W(96)]});
this.oakSW=this.metascreen({id:110,tilesets:{town:{type:"square"}},exits:[W(124)]});this.oakSE=this.metascreen({id:111,tilesets:{town:{type:"square"}},exits:[Mg({left:0,shift:.5}),W(151)]});this.temple=this.metascreen({id:112,tilesets:{house:{}},exits:[Ng()]});this.wideDeadEndN=this.metascreen({id:113,icon:V`
      | \u2503 |
      | > |
      |   |`,tile:" w | > |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",exits:[Kg(199)],statues:[4]});this.goaWideDeadEndN=this.metascreen({id:113,icon:V`
      |\u2575\u2503\u2575|
      | > |
      |   |`,tile:" w | > |   ",tilesets:{labyrinth:{}},edges:"w   ",connect:"1|2x|3",exits:[Kg(199)],statues:[4]});this.wideHallNS=this.metascreen({id:114,icon:V`
      | \u2503 |
      | \u2503 |
      | \u2503 |`,tile:" w | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2a",statues:[1,7,13]});this.goaWideHallNS=this.metascreen({id:114,icon:V`
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|`,tile:" w | w | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"19|2a|3b",statues:[1,7,13]});this.goaWideHallNS_blockedRight=this.metascreen({id:114,icon:V`
      |\u2502\u2503\u2502|
      |\u2502\u2503 |
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[157]}},edges:"w w ",connect:"19|2a|3|b"});this.goaWideHallNS_blockedLeft=this.metascreen({id:114,icon:V`
      |\u2502\u2503\u2502|
      | \u2503\u2502|
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[81]}},edges:"w w ",connect:"1|9|2a|3b"});this.goaWideArena=this.metascreen({id:115,icon:V`<
      |\u257b<\u257b|
      |\u2521\u2501\u2529|
      |\u2502\u257b\u2502|`,placement:"manual",tile:"   | < | w ",tilesets:{labyrinth:{}},feature:["arena"],edges:"w w ",connect:"9b|a",exits:[Jg(55)]});this.limeTreeLake=this.metascreen({id:116,tilesets:{lime:{}},exits:[Ng(),Lg(71)],feature:["bridge"],wall:103});this.swampNW=this.metascreen({id:117,icon:V`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss  ",connect:"26",exits:[Y({left:6,width:4}),Og({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampE=this.metascreen({id:118,icon:V`
      |   |
      | \u2576\u2500|
      |   |`,tile:"   | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"   s",connect:"e",exits:[],poi:[[0]]});this.swampE_door=this.metascreen({id:118,icon:V`\u2229
      | \u2229 |
      | \u2576\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"   s",connect:"e",exits:[Lg(92,"swamp")]});this.swampNWSE=this.metascreen({id:119,icon:V`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ssss",connect:"26ae",exits:[Y({left:6,width:4}),Og({top:7,height:4,shift:-.5}),Mg({left:6,width:4}),Pg({top:7,height:4,shift:-.5})]});this.swampNWS=this.metascreen({id:120,icon:V`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"sss ",connect:"26a",exits:[Y({left:6,width:4}),Og({top:7,height:4,shift:-.5}),Mg({left:6,width:4})]});this.swampNE=this.metascreen({id:121,icon:V`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s  s",connect:"2e",exits:[Y({left:6,width:4}),Pg({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampWSE=this.metascreen({id:122,icon:V`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" sss",connect:"6ae",exits:[Og({top:7,height:4,shift:-.5}),Mg({left:6,width:4}),Pg({top:7,height:4,shift:-.5})]});this.swampWSE_door=this.metascreen({id:122,icon:V`\u2229
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |c<c| c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" sss",connect:"6ae",exits:[Lg(86,"swamp")]});this.swampW=this.metascreen({id:123,icon:V`
      |   |
      |\u2500\u2574 |
      |   |`,tile:"   |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s  ",connect:"6",poi:[[0]]});this.swampW_door=this.metascreen({id:123,icon:V`\u2229
      | \u2229 |
      |\u2500\u2574 |
      |   |`,tile:"   |c< |   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s  ",connect:"6",exits:[Lg(84,"swamp")]});this.swampArena=this.metascreen({id:124,icon:V`
      |   |
      |\u2517\u252f\u251b|
      | \u2502 |`,tile:"   | a | c ",tilesets:{swamp:{}},feature:["arena"],edges:"  s ",connect:"a"});this.swampNWE=this.metascreen({id:125,icon:V`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss s",connect:"26e",exits:[Y({left:6,width:4}),Og({top:7,height:4}),Pg({top:7,height:4})]});this.swampWS=this.metascreen({id:126,icon:V`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],update:[[G.SwampDoors,(a,c,d)=>{d.metascreens.swampWS_door.flag="always";return!0}]],edges:" ss ",connect:"6a",exits:[Og({top:7,height:4}),Mg({left:6,width:4})],poi:[[2]]});this.swampWS_door=this.metascreen({id:126,icon:V`\u2229
      | \u2229 |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |c< | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" ss ",connect:"6a",exits:[Lg(87,"swamp")]});this.swampEmpty=this.metascreen({id:127,icon:V`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{swamp:{}},feature:["empty"],edges:"    ",connect:"",delete:!0});this.swampN=this.metascreen({id:-113,icon:V`
      | \u2502 |
      | \u2575 |
      |   |`,tile:" c | c |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s   ",connect:"2",poi:[[0]],definition:ah(Ig(".  .  .  .  cf f6 c7 ad c4 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b9 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b8 ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad b9 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad ad d2 e2 .  .  .  .\n         .  .  .  .  e3 f6 c3 c3 b8 b6 d2 .  .  .  .  .\n         .  .  .  .  .  e3 fd ad ad fc e2 .  .  .  .  .\n         .  .  .  .  .  .  ff fb fb fa .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200]))});this.swampS=this.metascreen({id:-114,icon:V`
      |   |
      | \u2577 |
      | \u2502 |`,tile:"   | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  s ",connect:"a",poi:[[0]],definition:ah(Ig(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 ca .  .  .  .  .  .\n         .  .  .  .  .  cd eb a0 a0 cb ca .  .  .  .  .\n         .  .  .  .  cf a0 f9 f5 f7 f8 cb cc .  .  .  .\n         .  .  .  .  cf a0 ed 08 09 a0 a0 cc .  .  .  .\n         .  .  .  .  cf db ee 0c 0b ef a0 cc .  .  .  .\n         .  .  .  .  cf d0 d1 03 03 d8 db cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad ad ae d2 cc .  .  .  .\n         .  .  .  .  cf d3 ad b9 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c5 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .",
[".",200]))});this.swampNS=this.metascreen({id:-115,icon:V`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s s ",connect:"2a",exits:[Y({left:6,width:4}),Mg({left:6,width:4})],definition:ah(Ig(".  .  .  .  cf d3 b6 b6 c6 b6 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c3 c7 b6 f6 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c7 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b6 c6 c5 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c6 c3 c7 d2 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 ad c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 c4 c5 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f5 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 c2 b8 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 c7 b6 d2 cc .  .  .  .",
[".",200]))});this.swampWE=this.metascreen({id:-116,icon:V`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s s",connect:"6e",exits:[Og({top:7,height:4,shift:-.5}),Pg({top:7,height:4,shift:-.5})],definition:ah(Ig(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9\n         a0 e4 e8 eb e4 a0 a0 a0 eb eb e8 f0 f1 a0 e4 a0\n         a0 e5 e9 f9 f5 f6 f6 f7 ec f9 f7 f8 f2 a0 e5 a0\n         a0 e6 f0 f1 e6 e0 08 09 ed de ea de f2 a0 e6 a0\n         db e7 db f3 e7 e1 0c 0b dd df e0 df f3 db e7 e0\n         d0 d1 da da d0 d1 03 03 d0 d1 d0 d1 da da da da\n         ad c4 ad ad ad ad ad ad ad ad ad ad ad ad ad ad\n         c2 c5 b8 c6 c4 c4 b9 c7 c4 c5 c5 c7 ad ad ad ad\n         ad ad ad ad c2 c3 c3 c3 c3 c3 c7 ad ad ad ad ad\n         fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200]))});this.swampWE_door=this.metascreen({id:-116,icon:V`\u2229
      | \u2229 |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s s",connect:"6e",exits:[Lg(86,"swamp")]});this.swampSE=this.metascreen({id:-117,icon:V`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  ss",connect:"ae",exits:[Pg({top:7,height:4,shift:-.5}),Mg({left:6,width:4})],poi:[[2]],definition:ah(Ig(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 c9 c9 c9 c9 c9 c9 c9\n         .  .  .  .  .  cd a0 a0 a0 e8 04 a0 e8 a0 a0 e4\n         .  .  .  .  cf f8 a0 f0 f1 f5 f5 f7 e9 f4 f7 e5\n         .  .  .  .  cf f6 f7 f8 f2 ea 06 aa e9 f0 f1 e6\n         .  .  .  .  cf a0 dd e0 f3 e0 07 0c ea db f3 e7\n         .  .  .  .  cf db d5 d0 d1 d1 03 03 d0 d1 da da\n         .  .  .  .  cf d5 af c4 c4 ad ad ad ad ad c4 ad\n         .  .  .  .  cf d3 b9 c3 c3 b8 ad ad ad c2 b7 b8\n         .  .  .  .  cf f6 c3 c3 c3 c3 b8 ad ad ad ad ad\n         .  .  .  .  cf f6 c7 ad c2 c3 c7 fc fb fb fb fb\n         .  .  .  .  cf d3 ad ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad b9 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad b9 c7 d2 cc .  .  .  . \n         .  .  .  .  cf d3 b6 b9 c3 b8 d2 cc .  .  .  .",
[".",200]))});this.swampSE_door=this.metascreen({id:-117,icon:V`\u2229
      | \u2229 |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | <c| c ",tilesets:{swamp:{requires:[G.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"  ss",connect:"ae",exits:[Lg(90,"swamp")]});this.swampNSE=this.metascreen({id:-118,icon:V`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s ss",connect:"2ae",exits:[Y({left:6,width:4}),Mg({left:6,width:4}),Pg({top:7,height:4,shift:-.5})],definition:ah(Ig(".  .  .  .  cf d3 c4 c3 c3 c3 f7 f8 ca .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f7 f7 a0 ca c9 c9\n         .  .  .  .  cf f6 c3 c3 b8 b6 d2 f7 f8 e8 e4 a0\n         .  .  .  .  cf f5 b7 c3 b7 b8 d2 f0 f1 e9 e5 de\n         .  .  .  .  cf d3 c2 b8 c2 b8 d8 db f2 ea e6 df\n         .  .  .  .  cf d3 ad ad ad ad ae d4 f3 dd e7 df\n         .  .  .  .  cf d3 ad ad ad ad ad ae d0 d1 d0 d1\n         .  .  .  .  cf d3 c2 c3 c3 b7 b8 ad ad ad ad ad\n         .  .  .  .  cf d3 ad ad c2 b7 b7 b7 b8 c4 ad ad\n         .  .  .  .  cf d3 ad ad b6 b9 b7 b7 b7 b7 b8 ad\n         .  .  .  .  cf d3 ad c4 c3 b7 b8 fc fb fb fb fb\n         .  .  .  .  cf d3 b6 ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c4 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b9 b7 b7 f6 cc .  .  .  .",
[".",200]))});this.caveEmpty=this.metascreen({id:128,icon:V`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{cave:{},fortress:{},labyrinth:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"    ",delete:!0});this.dolphinCave_empty=this.metascreen({id:128,icon:V`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{dolphinCave:{}},feature:["empty"],edges:"    ",delete:!0});this.open=this.metascreen({id:128,icon:V`
      |   |
      |   |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{},sea:{}},edges:"oooo"});this.hallNS=this.metascreen({id:129,icon:V`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",connect:"2a",poi:[[4]],exits:[Mg({left:6,width:4,manual:!0}),Y({left:6,width:4,manual:!0})]});this.hallNS_unreachable=this.metascreen({id:129,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE=this.metascreen({id:130,icon:V`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",poi:[[4]]});this.hallWE_unreachable=this.metascreen({id:130,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallSE=this.metascreen({id:131,icon:V`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"  cc",connect:"ae",poi:[[2]]});this.hallSE_unreachable=this.metascreen({id:131,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWS=this.metascreen({id:132,icon:V`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" cc ",connect:"6a",poi:[[2]]});this.hallWS_unreachable=this.metascreen({id:132,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNE=this.metascreen({id:133,icon:V`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c  c",connect:"2e",poi:[[2]],exits:[Y({left:6,width:4,manual:!0})]});this.hallNE_unreachable=this.metascreen({id:133,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNW=this.metascreen({id:134,icon:V`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc  ",connect:"26",poi:[[2]],exits:[Y({left:6,width:4,manual:!0})]});this.hallNW_unreachable=this.metascreen({id:134,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNSE=this.metascreen({id:135,icon:V`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c cc",connect:"2ae",poi:[[3]],exits:[Y({left:6,width:4,manual:!0})]});this.branchNSE_unreachable=this.metascreen({id:135,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWSE=this.metascreen({id:136,icon:V`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cccc",connect:"26ae",poi:[[3]],exits:[Y({left:6,width:4,manual:!0})]});this.branchNWSE_unreachable=this.metascreen({id:136,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWS=this.metascreen({id:137,icon:V`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"ccc ",connect:"26a",poi:[[3]],exits:[Y({left:6,width:4,manual:!0})]});this.branchNWS_unreachable=this.metascreen({id:137,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchWSE=this.metascreen({id:138,icon:V`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" ccc",connect:"6ae",poi:[[3]]});this.branchWSE_unreachable=this.metascreen({id:138,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE=this.metascreen({id:139,icon:V`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc c",connect:"26e",poi:[[3]],exits:[Y({left:6,width:4,manual:!0})]});this.branchNWE_unreachable=this.metascreen({id:139,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_ramp=this.metascreen({id:140,icon:V`
      | \u250b |
      | \u250b |
      | \u250b |`,tile:" c | / | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["ramp"],edges:"c c ",connect:"2a",exits:[Y({left:6,width:4,manual:!0})]});this.hallNS_ramp_unreachable=this.metascreen({id:140,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_overBridge=this.metascreen({id:141,icon:V`
      | \u257d |
      |\u2500\u2503\u2500|
      | \u257f |`,tile:" c | b | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["overpass"],edges:"cbcb",connect:"2a",exits:[Y({left:6,width:4,manual:!0})]});this.hallWE_underBridge=this.metascreen({id:142,icon:V`
      | \u257d |
      |\u2500\u2500\u2500|
      | \u257f |`,tile:"   |cbc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["underpass"],edges:"bcbc",connect:"6e"});this.hallNS_wall=this.metascreen({id:143,icon:V`
      | \u2502 |
      | \u2506 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",feature:["wall"],connect:"2=a",wall:135,mod:"wall",exits:[Y({left:6,width:4,manual:!0})]});this.hallNS_wall_unreachable=this.metascreen({id:143,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallWE_wall=this.metascreen({id:144,icon:V`
      |   |
      |\u2500\u2504\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},iceCave:{}},feature:["wall"],edges:" c c",connect:"6=e",wall:103,mod:"wall"});this.hallWE_wall_unreachable=this.metascreen({id:144,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arena=this.metascreen({id:145,icon:V`
      |\u250c\u2538\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,tile:[" n | a | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena"],edges:"c c ",connect:"2a",poi:[[1,96,120]],exits:[Y(),Mg({left:6,width:4,manual:!0}),Qg(230,4),Rg(246,4)],arena:1});this.hallNS_arena_unreachable=this.metascreen({id:145,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.hallNS_arenaWall=this.metascreen({id:146,icon:V`
      |\u250c\u2504\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,placement:"manual",tile:[" n | a | c "],tilesets:{cave:{},iceCave:{}},feature:["arena","wall"],edges:"n c ",connect:"2x=apx",wall:39,mod:"wall",poi:[[1,96,120]],exits:[Y({top:1}),Mg({left:6,width:4,manual:!0})],arena:1});this.branchNWE_wall=this.metascreen({id:148,icon:V`
      | \u2506 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wall"],edges:"cc c",connect:"2x=6e",exits:[Y({left:6,width:4})],mod:"wall",wall:55});this.branchNWE_wall_unreachable=this.metascreen({id:148,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.branchNWE_upStair=this.metascreen({id:149,icon:V`<
      | < |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",exits:[Jg(71)]});this.branchNWE_upStair_unreachable=this.metascreen({id:149,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.deadEndW_upStair=this.metascreen({id:150,icon:V`<
      | < |
      |\u2500\u2518 |
      |   |`,tile:"   |c< |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Jg(66)]});this.deadEndW_upStair_unreachable=this.metascreen({id:150,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndW_downStair=this.metascreen({id:151,icon:V`>
      |   |
      |\u2500\u2510 |
      | > |`,tile:"   |c> |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Kg(162)]});this.deadEndW_downStair_unreachable=this.metascreen({id:151,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,32),delete:!0});this.deadEndE_upStair=this.metascreen({id:152,icon:V`<
      | < |
      | \u2514\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Jg(76)]});this.deadEndE_upStair_unreachable=this.metascreen({id:152,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndE_downStair=this.metascreen({id:153,icon:V`>
      |   |
      | \u250c\u2500|
      | > |`,tile:"   | >c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Kg(172)]});this.deadEndE_downStair_unreachable=this.metascreen({id:153,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,208),delete:!0});this.deadEndNS_stairs=this.metascreen({id:154,icon:V`
      | > |
      |   |
      | < |`,placement:"manual",tile:" > |   | < ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2x|ax",exits:[Kg(23),Jg(215)],match:a=>a(264,120)&&a(-48,120)});this.deadEndNS_stairs_unreachable=this.metascreen({id:154,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(264,120)&&!a(-48,120),delete:!0});this.deadEndN_stairs=this.metascreen({id:154,icon:V`
      | > |
      |   |
      |   |`,tile:[" c | > |   "," > |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",exits:[Kg(23)],match:a=>!a(264,120)&&a(-48,120)});this.deadEndS_stairs=this.metascreen({id:154,icon:V`
      |   |
      |   |
      | < |`,tile:["   | < | c ","   |   | < "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",exits:[Jg(215)],match:a=>!a(-48,120)&&a(264,120)});this.deadEndNS=this.metascreen({id:155,icon:V`
      | \u2575 |
      |   |
      | \u2577 |`,placement:"manual",tile:" c |   | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c c ",connect:"2p|ap",poi:[[0,-48,120],[0,272,120]],match:a=>a(-48,120)&&a(272,120)});this.deadEndNS_unreachable=this.metascreen({id:155,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(-48,120)&&!a(272,120),delete:!0});this.deadEndN=this.metascreen({id:155,icon:V`
      | \u2575 |
      |   |
      |   |`,tile:[" c | c |   "," c |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"c   ",connect:"2",poi:[[0,-48,120]],match:a=>!a(272,120)&&a(-48,120)});this.deadEndS=this.metascreen({id:155,icon:V`
      |   |
      |   |
      | \u2577 |`,tile:["   | c | c ","   |   | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"  c ",connect:"a",poi:[[0,272,120]],match:a=>!a(-48,120)&&a(272,120)});this.deadEndWE=this.metascreen({id:156,icon:V`
      |   |
      |\u2574 \u2576|
      |   |`,placement:"manual",tile:"   |c c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c c",connect:"6p|ep",poi:[[0,112,-40],[0,112,264]],match:a=>a(112,-40)&&a(112,264)});this.deadEndWE_unreachable=this.metascreen({id:156,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(112,-40)&&!a(112,264),delete:!0});this.deadEndW=this.metascreen({id:156,icon:V`
      |   |
      |\u2574  |
      |   |`,tile:["   |cc |   ","   |c  |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:" c  ",connect:"6",poi:[[0,112,-40]],match:a=>!a(112,264)&&a(112,-40)});this.deadEndE=this.metascreen({id:156,icon:V`
      |   |
      |  \u2576|
      |   |`,tile:["   | cc|   ","   |  c|   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["deadend","empty"],edges:"   c",connect:"e",poi:[[0,112,264]],match:a=>!a(112,-40)&&a(112,264)});this.hallNS_entrance=this.metascreen({id:158,icon:V`\u257d
      | \u2502 |
      | \u2502 |
      | \u257d |`,tile:" c | c | n ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c n ",connect:"2a",exits:[Mg()]});this.hallNS_entrance_unreachable=this.metascreen({id:158,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.channelExitSE=this.metascreen({id:159,icon:V`
      |   |
      | \u2554\u2550|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:"  rr",exits:[Mg({left:5})]});this.channelBendWS=this.metascreen({id:160,icon:V`
      |\u2588  |
      |\u2550\u2557 |
      |\u2588\u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],edges:" rr "});this.channelHallNS=this.metascreen({id:161,icon:V`
      | \u2551 |
      | \u2560\u2508|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],wall:139,edges:"r r "});this.channelEntranceSE=this.metascreen({id:162,icon:V`
      |   |
      | \u2554\u2508|
      |\u2577\u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Mg({left:2})],wall:124,edges:"  rr"});this.channelCross=this.metascreen({id:163,icon:V`
      | \u2551 |
      |\u2550\u256c\u2550|
      |\u2577\u2551\u2577|`,tilesets:{dolphinCave:{}},feature:["river"],exits:[Mg({left:3}),Mg({left:11,type:"door"})],edges:"  rr"});this.channelDoor=this.metascreen({id:164,icon:V`\u2229
      | \u2229\u2588|
      |\u2508\u2550\u2550|
      |  \u2588|`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[W(56)],wall:115,edges:" r  "});this.mountainFloatingIsland=this.metascreen({id:165,icon:V`*
      |\u2550\u2557\u2588|
      |*\u2551 |
      |\u2550\u2563\u2588|`,placement:"manual",tile:"   | ap|   ",tilesets:{mountainRiver:{}},edges:"  wp",connect:"e"});this.mountainPathNE_stair=this.metascreen({id:166,icon:V`\u2514
      |\u2588\u250b\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" / | pp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"l  p",connect:"2e",exits:[Y()]});this.mountainBranchNWE=this.metascreen({id:167,icon:V`\u2534
      |\u2588 \u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" p |ppp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp p",connect:"26e"});this.mountainPathWE_iceBridge=this.metascreen({id:168,icon:V`\u256b
      |\u2588\u2551\u2588|
      | \u2506 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},feature:["bridge"],edges:"wpwp",connect:"6-e:2a",wall:135});this.mountainPathSE=this.metascreen({id:169,icon:V`\u250c
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588 \u2588|`,tile:"   | pp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:"  pp",connect:"ae",exits:[Pg({top:6,height:4}),Mg({left:6,width:4})]});this.mountainDeadEndW_caveEmpty=this.metascreen({id:170,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u2590 \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Lg(56)]});this.mountainPathNE=this.metascreen({id:171,icon:V`\u2514
      |\u2588 \u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" p | pp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"p  p",connect:"2e",exits:[Pg({top:6,height:4}),Y({left:6,width:4})]});this.mountainBranchWSE=this.metascreen({id:172,icon:V`\u252c
      |\u2588\u2588\u2588|
      |   |
      |\u2588 \u2588|`,tile:"   |ppp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:" ppp",connect:"6ae"});this.mountainPathW_cave=this.metascreen({id:173,icon:V`\u2229
      |\u2588\u2229\u2588|
      |  \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Lg(85)]});this.mountainPathE_slopeS=this.metascreen({id:174,icon:V`\u2553
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588\u2193\u2588|`,tile:"   | pp| \u2193 ",tilesets:{mountain:{}},edges:"  sp",connect:"ae"});this.mountainPathNW=this.metascreen({id:175,icon:V`\u2518
      |\u2588 \u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:" p |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp  ",connect:"26",exits:[Og({top:6,height:4}),Y({left:6,width:4})]});this.mountainCave_empty=this.metascreen({id:176,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588\u2588\u2588|`,tile:"   | < |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"    ",connect:"",exits:[Lg(88)]});this.mountainPathE_cave=this.metascreen({id:177,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"   p",connect:"e",exits:[Lg(87)]});this.mountainPathWE_slopeN=this.metascreen({id:178,icon:V`\u2568
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |ppp|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e"});this.mountainDeadEndW=this.metascreen({id:179,icon:V`\u2574
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:"   |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6"});this.mountainPathWE=this.metascreen({id:180,icon:V`\u2500
      |\u2588\u2588\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |ppp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p p",connect:"6e",exits:[Og({top:6,height:4}),Pg({top:6,height:4})]});this.mountainArena_gate=this.metascreen({id:181,icon:V`#
      |\u2588#\u2588|
      |\u258c \u2590|
      |\u2588\u250b\u2588|`,tile:"   | < | / ",tilesets:{mountain:{},mountainRiver:{}},feature:["arena"],edges:"  l ",connect:"a",exits:[Object.assign({},Jg(71,3),{type:"gate"})],flag:"custom:false"});this.mountainPathN_slopeS_cave=this.metascreen({id:182,icon:V`\u2229
      |\u2588\u250b\u2229|
      |\u258c \u2590|
      |\u2588\u2193\u2588|`,tile:" / | < | \u2193 ",tilesets:{mountain:{}},edges:"l s ",connect:"2a",exits:[Lg(90),Y()]});this.mountainPathWE_slopeNS=this.metascreen({id:183,icon:V`\u256b
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"26ae"});this.mountainPathWE_slopeN_cave=this.metascreen({id:184,icon:V`\u2229
      |\u2588\u2193\u2229|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |p<p|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e",exits:[Lg(92)]});this.mountainPathWS=this.metascreen({id:185,icon:V`\u2510
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588 \u2588|`,tile:"   |pp | p ",tilesets:{mountain:{},mountainRiver:{}},edges:" pp ",connect:"6a",exits:[Og({top:6,height:4}),Mg({left:6,width:4})]});this.mountainSlope=this.metascreen({id:186,icon:V`\u2193
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|`,tile:" \u2193 | \u2193 | \u2193 ",tilesets:{mountain:{}},edges:"s s ",connect:"2a"});this.mountainRiver=this.metascreen({id:186,icon:V`\u2551
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|`,tile:[" r | r | r "," r | r |   "],tilesets:{mountainRiver:{}},edges:"w w ",connect:"2:e"});this.mountainPathE_gate=this.metascreen({id:187,icon:V`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{}},edges:"   p",connect:"e",exits:[Lg(87,"gate")]});this.mountainPathWE_inn=this.metascreen({id:188,icon:V`\u2229
      |\u2588\u2229\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |p<p|   ",placement:"manual",tilesets:{mountain:{}},edges:" p p",connect:"6e",exits:[W(118)]});this.mountainPathWE_bridgeOverSlope=this.metascreen({id:189,icon:V`\u2550
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"6e",exits:[Qg(182,4)]});this.mountainPathWE_bridgeOverRiver=this.metascreen({id:189,icon:V`\u2550
      |\u2588\u2551\u2588|
      | \u2550 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},edges:"wpwp",connect:"6e|2|a"});this.mountainSlope_underBridge=this.metascreen({id:190,icon:V`\u2193
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |p\u2193p| \u2193 ",placement:"manual",tilesets:{mountain:{}},edges:"spsp",connect:"2a",exits:[Rg(198,4)]});this.mountainEmpty=this.metascreen({id:191,icon:V`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{mountain:{},mountainRiver:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryS=this.metascreen({id:192,icon:V`
      |   |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^ ^"});this.boundaryN_cave=this.metascreen({id:193,icon:V`
      |\u2588\u2588\u2588|
      |\u2580\u2229\u2580|
      |   |`,tile:"   |o<o|ooo",tilesets:{grass:{},sea:{},desert:{},river:{requires:[G.SeaCaveEntrance]}},edges:" vov",exits:[Lg(73)]});this.cornerSE_cave=this.metascreen({id:194,icon:V`
      | \u2590\u2588|
      |\u2584\u2229\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |o< |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  ",exits:[Lg(90)]});this.waterfall=this.metascreen({id:195,icon:V`
      |   |
      |\u2193\u2193\u2193|
      |   |`,tile:"ooo|\u2193\u2193\u2193|ooo",tilesets:{sea:{}},edges:"oooo"});this.whirlpoolBlocker=this.metascreen({id:196,icon:V`
      |   |
      |\u2588\u2573\u2588|
      |   |`,tile:"ooo|\u2193#\u2193|ooo",tilesets:{sea:{}},feature:["whirlpool"],flag:"calm",edges:"oooo"});this.beachExitN=this.metascreen({id:197,icon:V`
      |\u2588 \u2588|
      |\u2588\u2571\u2580|
      |\u2588\u258c |`,placement:"manual",tile:" x | bo| oo",tilesets:{sea:{}},edges:"n >v",exits:[Y({left:9})]});this.whirlpoolOpen=this.metascreen({id:198,icon:V`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{sea:{}},feature:["whirlpool"],edges:"oooo",flag:"calm"});this.quicksandOpen=this.metascreen({id:198,icon:V`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{}},feature:["whirlpool"],edges:"oooo"});this.lighthouseEntrance=this.metascreen({id:199,icon:V`
      |\u2597\u259f\u2588|
      |\u2590\u2229\u259b|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"oo |oLo|ooo",tilesets:{sea:{}},feature:["lighthouse"],edges:"<oov",exits:[Lg(42),W(117)]});this.beachCave=this.metascreen({id:200,icon:V`
      |\u2588\u2229\u2588|
      |\u2580\u2572\u2588|
      |   |`,placement:"manual",tile:"   |o<o|ooo",tilesets:{sea:{}},edges:" vov",exits:[Lg(40)]});this.beachCabinEntrance=this.metascreen({id:201,icon:V`
      | \u2229\u2588|
      | \u2572\u2580|
      |\u2588\u2584\u2584|`,placement:"manual",tile:"oo |oC8|   ",tilesets:{sea:{}},feature:["cabin"],edges:"<^ b",exits:[W(85),Pg({top:8,height:3})]});this.oceanShrine=this.metascreen({id:202,icon:V`
      |\u2597\u2584\u2596|
      |\u2590*\u258c|
      |\u259d \u2598|`,placement:"manual",tile:"ooo|oAo|ooo",tilesets:{sea:{}},feature:["altar"],edges:"oooo"});this.pyramidEntrance=this.metascreen({id:203,icon:V`
      | \u2584 |
      |\u259f\u2229\u2599|
      | \u2573 |`,placement:"manual",tile:"ooo|oPo|ooo",tilesets:{desert:{}},feature:["pyramid"],edges:"oooo",exits:[Lg(167,"fortress")]});this.cryptEntrance=this.metascreen({id:204,icon:V`
      | \u2573 |
      |\u2590>\u258c|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"ooo|oYo|ooo",tilesets:{desert:{}},feature:["crypt"],edges:"oooo",exits:[Kg(103)]});this.oasisLake=this.metascreen({id:205,icon:V`
      | ^ |
      |vOv|
      | vv|`,tile:"ooo|ooo|oro",placement:"manual",tilesets:{desert:{}},feature:["lake"],edges:"oo3o"});this.desertCaveEntrance=this.metascreen({id:206,icon:V`
      |\u2597\u2584\u2596|
      |\u259c\u2229\u259b|
      | \u2573 |`,tile:"ooo|o<o|ooo",tilesets:{desert:{},sea:{requires:[G.SeaCaveEntrance]}},edges:"oooo",exits:[Lg(167)]});this.oasisCave=this.metascreen({id:207,icon:V`
      | vv|
      |\u2584\u2229v|
      |\u2588\u258c |`,placement:"manual",tile:"oro|o<o| oo",tilesets:{desert:{}},edges:"3^>o",exits:[Jg(55)]});this.channelEndW_cave=this.metascreen({id:208,icon:V`
      |\u2588\u2588\u2229|
      |\u2550\u2550 |
      |\u2588\u2588\u2588|`,tile:"   |r< |   ",tilesets:{dolphinCave:{}},feature:["river"],exits:[Jg(87)]});this.boatChannel=this.metascreen({id:209,icon:V`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      |\u2584\u2584\u2584|`,tile:["   |888|   ","   |88x|   "],tilesets:{sea:{}},edges:" b b",exits:[Object.assign({},Pg({top:8,height:3}),{entrance:40168}),Og({top:8,height:3})]});this.channelWE=this.metascreen({id:210,icon:V`
      |\u2588\u2588\u2588|
      |\u2550\u2550\u2550|
      |\u2588\u2588\u2588|`,tile:"   |rrr|   ",tilesets:{dolphinCave:{}},feature:["river"]});this.riverCaveNWSE=this.metascreen({id:211,icon:V`
      |\u2518\u2551\u2514|
      |\u2550\u256c\u2550|
      |\u252c\u2507\u252c|`,tile:" r |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"rrrr",connect:"15p:3dp:79-bf",wall:182,poi:[[4,0,72],[4,0,152]]});this.riverCaveNS=this.metascreen({id:212,icon:V`
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3b",mod:"bridge"});this.riverCaveWE=this.metascreen({id:213,icon:V`
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" r r",connect:"5d:7f",mod:"bridge"});this.riverCaveNS_bridge=this.metascreen({id:214,icon:V`
      |\u2502\u2551\u2502|
      |\u251c\u2507\u2524|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r r ",connect:"19-3b",wall:135});this.riverCaveWE_bridge=this.metascreen({id:215,icon:V`
      |\u2500\u252c\u2500|
      |\u2550\u2505\u2550|
      |\u2500\u2534\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:" r r",connect:"5d-7f",wall:134});this.riverCaveSE=this.metascreen({id:216,icon:V`
      |\u250c\u2500\u2500|
      |\u2502\u2554\u2550|
      |\u2502\u2551\u250c|`,tile:"   | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"  rr",connect:"9d:bf"});this.riverCaveWS=this.metascreen({id:217,icon:V`
      |\u2500\u2500\u2510|
      |\u2550\u2557\u2502|
      |\u2510\u2551\u2502|`,tile:"   |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rr ",connect:"5b:79"});this.riverCaveNE=this.metascreen({id:218,icon:V`
      |\u2502\u2551\u2514|
      |\u2502\u255a\u2550|
      |\u2514\u2500\u2500|`,tile:" r | rr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r  r",connect:"1f:3d"});this.riverCaveNW=this.metascreen({id:219,icon:V`
      |\u2518\u2551\u2502|
      |\u2550\u255d\u2502|
      |\u2500\u2500\u2518|`,tile:" r |rr |   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr  ",connect:"15:37"});this.riverCaveWE_passageN=this.metascreen({id:220,icon:V`\u2567
      |\u2500\u2534\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:" c |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"cr r",connect:"25d:7f"});this.riverCaveWE_passageS=this.metascreen({id:221,icon:V`\u2564
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u252c\u2500|`,tile:"   |rrr| c ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rcr",connect:"5d:7af"});this.riverCaveNS_passageW=this.metascreen({id:222,icon:V`\u2562
      |\u2502\u2551\u2502|
      |\u2524\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r |cr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rcr ",connect:"169:3b"});this.riverCaveNS_passageE=this.metascreen({id:223,icon:V`\u255f
      |\u2502\u2551\u2502|
      |\u2502\u2551\u251c|
      |\u2502\u2551\u2502|`,tile:" r | rc| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rc",connect:"19:3be"});this.wideHallNE=this.metascreen({id:224,icon:V`
      | \u2503 |
      | \u2517\u2501|
      |   |`,tile:" w | ww|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w  w",connect:"2e"});this.goaWideHallNE=this.metascreen({id:224,icon:V`
      |\u2502\u2503\u2514|
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{}},edges:"w  w",connect:"1f|2e|3d"});this.goaWideHallNE_blockedLeft=this.metascreen({id:224,icon:V`
      |\u2502\u2503\u2514|
      | \u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97]}},edges:"w  w",connect:"1|f|2e|3d"});this.goaWideHallNE_blockedRight=this.metascreen({id:224,icon:V`
      |\u2502\u2503 |
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[13]}},edges:"w  w",connect:"1f|2e|3|d"});this.wideHallNW=this.metascreen({id:225,icon:V`
      | \u2503 |
      |\u2501\u251b |
      |   |`,tile:" w |ww |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww  ",connect:"26"});this.goaWideHallNW=this.metascreen({id:225,icon:V`
      |\u2518\u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],removeWall:109}},edges:"ww  ",connect:"15|26|37"});this.goaWideHallNW_blockedRight=this.metascreen({id:225,icon:V`
      |\u2518\u2503\u2502|
      |\u2501\u251b |
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{}},edges:"ww  ",connect:"15|26|3|7"});this.goaWideHallNW_blockedLeft=this.metascreen({id:225,icon:V`
      | \u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1],removeWall:109}},edges:"ww  ",connect:"1|5|26|37"});this.wideHallSE=this.metascreen({id:226,icon:V`
      |   |
      | \u250f\u2501|
      | \u2503 |`,tile:"   | ww| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  ww",connect:"ae"});this.goaWideHallSE=this.metascreen({id:226,icon:V`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{}},edges:"  ww",connect:"9d|ae|bf"});this.goaWideHallSE_blockedLeft=this.metascreen({id:226,icon:V`
      |\u250c\u2500\u2500|
      | \u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97]}},edges:"  ww",connect:"9|d|ae|bf"});this.goaWideHallSE_blockedRight=this.metascreen({id:226,icon:V`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503 |`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[221]}},edges:"  ww",connect:"9d|ae|b|f"});this.wideHallWS=this.metascreen({id:227,icon:V`
      |   |
      |\u2501\u2513 |
      | \u2503 |`,tile:"   |ww | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" ww ",connect:"6a"});this.goaWideHallWS=this.metascreen({id:227,icon:V`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],removeWall:157}},edges:" ww ",connect:"5b|6a|79"});this.goaWideHallWS_blockedRight=this.metascreen({id:227,icon:V`
      |\u2500\u2500\u2510|
      |\u2501\u2513 |
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{}},edges:" ww ",connect:"5|b|6a|79"});this.goaWideHallWS_blockedLeft=this.metascreen({id:227,icon:V`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      | \u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[209],removeWall:157}},edges:" ww ",connect:"5b|6a|7|9"});this.goaWideHallNS_stairs=this.metascreen({id:228,icon:V`
      |\u251c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2524|`,tile:" w | H | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"1239ab"});this.goaWideHallNS_stairsBlocked13=this.metascreen({id:228,icon:V`
      |\u2514\u2528\u2502|
      |\u2577\u2503\u2575|
      |\u2502\u2520\u2510|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[65,141]}},edges:"w w ",connect:"12ab|3|9"});this.goaWideHallNS_stairsBlocked24=this.metascreen({id:228,icon:V`
      |\u250c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2518|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,205]}},edges:"w w ",connect:"1|239a|b"});this.wideHallNS_deadEnds=this.metascreen({id:229,icon:V`
      | \u2579 |
      |   |
      | \u257b |`,tile:" w |   | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2|a",match:a=>a(272,120)&&a(-48,120)});this.wideHall_deadEndN=this.metascreen({id:229,icon:V`
      | \u2579 |
      |   |
      |   |`,tile:[" w |   |   "," w | w |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",match:a=>!a(272,120)&&a(-48,120)});this.wideHall_deadEndS=this.metascreen({id:229,icon:V`
      |   |
      |   |
      | \u257b |`,tile:["   |   | w ","   | w | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  w ",connect:"a",match:a=>a(272,120)&&!a(-48,120)});this.goaWideHallNS_deadEnd=this.metascreen({id:229,icon:V`
      |\u2502\u2579\u2502|
      |\u251c\u2500\u2524|
      |\u2502\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"139b|2|a"});this.goaWideHallNS_deadEndBlocked24=this.metascreen({id:229,icon:V`
      |\u2575\u2579\u2502|
      |\u250c\u2500\u2518|
      |\u2502\u257b\u2577|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[97,173]}},edges:"w w ",connect:"1|2|39|a|b"});this.goaWideHallNS_deadEndBlocked13=this.metascreen({id:229,icon:V`
      |\u2502\u2579\u2575|
      |\u2514\u2500\u2510|
      |\u2577\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[109,161]}},edges:"w w ",connect:"1b|2|3|9|a"});this.wideHallNWSE=this.metascreen({id:230,icon:V`
      | \u2503 |
      |\u2501\u254b\u2501|
      | \u2503 |`,tile:" w |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"wwww",connect:"26ae"});this.goaWideHallNWSE=this.metascreen({id:230,icon:V`
      |\u2518\u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{}},edges:"wwww",connect:"26ae|15|3d|79|bf"});this.goaWideHallNWSE_blocked13=this.metascreen({id:230,icon:V`
      |\u2518\u2503 |
      |\u2501\u254b\u2501|
      | \u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[13,209]}},edges:"wwww",connect:"26ae|15|3|d|7|9|bf"});this.goaWideHallNWSE_blocked24=this.metascreen({id:230,icon:V`
      | \u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503 |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,221]}},edges:"wwww",connect:"26ae|1|5|3d|79|b|f"});this.wideHallNWE=this.metascreen({id:231,icon:V`
      | \u2503 |
      |\u2501\u253b\u2501|
      |   |`,tile:" w |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww w",connect:"26e"});this.goaWideHallNWE=this.metascreen({id:231,icon:V`
      |\u2518\u2503\u2514|
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{}},edges:"ww w",connect:"26e|15|3d|7f"});this.goaWideHallNWE_blockedTop=this.metascreen({id:231,icon:V`
      | \u2503 |
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[1,13]}},edges:"ww w",connect:"26e|1|5|3|d|7f"});this.wideHallWSE=this.metascreen({id:232,icon:V`
      |   |
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" www",connect:"6ae"});this.goaWideHallWSE=this.metascreen({id:232,icon:V`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      |\u2510\u2503\u250c|`,tile:"   |www| w ",tilesets:{labyrinth:{}},edges:" www",connect:"6ae|5d|79|bf"});this.goaWideHallWSE_blockedBottom=this.metascreen({id:232,icon:V`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{labyrinth:{requires:[G.LabyrinthParapets],addWall:[209,221]}},edges:" www",connect:"6ae|5d|7|9|b|f"});this.wideHallNS_wallTop=this.metascreen({id:233,icon:V`
      | \u2506 |
      | \u2503 |
      | \u2503 |`,tile:" n | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide","wall"],edges:"c w",connect:"2a",exits:[Y({left:6,width:4})],wall:55,statues:[10]});this.goaWideHallNS_wallTop=this.metascreen({id:233,icon:V`
      | \u2506 |
      |\u2577\u2503\u2577|
      |\u2502\u2503\u2502|`,tile:" n | w | w ",tilesets:{labyrinth:{}},feature:["wall"],edges:"c w ",connect:"2ax|9|b",exits:[Y({left:6,width:4})],wall:55,statues:[10]});this.wideHallWE=this.metascreen({id:234,icon:V`
      |   |
      |\u2501\u2501\u2501|
      |   |`,tile:"   |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" w w",connect:"6e"});this.goaWideHallWE=this.metascreen({id:234,icon:V`
      |\u2500\u2500\u2500|
      |\u2501\u2501\u2501|
      |\u2500\u2500\u2500|`,tile:"   |www|   ",tilesets:{labyrinth:{}},edges:" w w",connect:"5d|6e|7f"});this.pitWE=this.metascreen({id:235,tile:"   |cpc|   ",icon:V`
      |   |
      |\u2500\u2573\u2500|
      |   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:" c c",connect:"6e",platform:{type:"horizontal",coord:28728}});this.pitNS=this.metascreen({id:236,icon:V`
      | \u2502 |
      | \u2573 |
      | \u2502 |`,tile:" c | p | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:"c c ",connect:"2a",platform:{type:"vertical",coord:16504}});this.pitNS_unreachable=this.metascreen({id:236,icon:V`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:a=>!a(128,128),delete:!0});this.spikesNS_hallS=this.metascreen({id:237,icon:V`
      | \u2591 |
      | \u2591 |
      | \u2502 |`,tile:" s | s | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s c ",connect:"2a"});this.spikesNS_hallN=this.metascreen({id:238,icon:V`
      | \u2502 |
      | \u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" c | s | s ",feature:["spikes"],edges:"c s ",connect:"2a"});this.spikesNS_hallWE=this.metascreen({id:239,icon:V`
      | \u2591 |
      |\u2500\u2591\u2500|
      | \u2591 |`,tile:" s |csc| s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"scsc",connect:"26ae"});this.spikesNS_hallW=this.metascreen({id:-225,icon:V`
      | \u2591 |
      |\u2500\u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s |cs | s ",feature:["spikes"],edges:"scs ",connect:"26a",definition:a=>Ig("L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R",
["L",a.metascreens.spikesNS_hallWE],["R",a.metascreens.spikesNS])});this.spikesNS_hallE=this.metascreen({id:-226,icon:V`
      | \u2591 |
      | \u2591\u2500|
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" s | sc| s ",feature:["spikes"],edges:"s sc",connect:"2ae",definition:a=>Ig("L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R\n         L L L L L L L L R R R R R R R R",
["L",a.metascreens.spikesNS],["R",a.metascreens.spikesNS_hallWE])});this.riverCave_deadEndsNS=this.metascreen({id:240,icon:V`
      | \u2568 |
      |   |
      | \u2565 |`,tile:" r |   | r ",placement:"manual",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r r ",connect:"1p:3p|9p:bp",poi:[[1,-48,72],[1,-48,152],[1,272,72],[1,272,152]]});this.riverCave_deadEndsN=this.metascreen({id:240,icon:V`
      | \u2568 |
      |   |
      |   |`,tile:[" r |   |   "," r | r |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"r   ",connect:"1p:3p",poi:[[1,-48,72],[1,-48,152]],match:a=>!a(264,72)&&!a(264,152),mod:"bridge"});this.riverCave_deadEndsS=this.metascreen({id:240,icon:V`
      |   |
      |   |
      | \u2565 |`,tile:["   |   | r ","   | r | r "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"  r ",connect:"9p:bp",poi:[[1,272,72],[1,272,152]],match:a=>!a(-48,72)&&!a(-48,152),mod:"bridge"});this.riverCave_deadEndsWE=this.metascreen({id:241,icon:V`
      |   |
      |\u2561 \u255e|
      |   |`,tile:"   |r r|   ",tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r r",connect:"5p:7p|dp:fp",poi:[[1,96,-40],[1,160,-40],[1,96,264],[1,160,264]]});this.riverCave_deadEndsW=this.metascreen({id:241,icon:V`
      |   |
      |\u2561  |
      |   |`,tile:["   |r  |   ","   |rr |   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:" r  ",connect:"5p:7p",poi:[[1,96,-40],[1,160,-40]],match:a=>!a(96,264)&&!a(160,264)});this.riverCave_deadEndsE=this.metascreen({id:241,icon:V`
      |   |
      |  \u255e|
      |   |`,tile:["   |  r|   ","   | rr|   "],tilesets:{cave:{},fortress:{}},feature:["deadend","empty","river"],edges:"   r",connect:"dp:fp",poi:[[1,96,264],[1,160,264]],match:a=>!a(96,-40)&&!a(160,-40)});this.riverCaveN_bridge=this.metascreen({id:242,icon:V`
      | \u2507 |
      | \u2568 |
      |   |`,tile:[" r | r |   "," r |   |   "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r   ",connect:"1-3",wall:23,match:a=>!a(208,72)&&!a(208,152)});this.riverCaveS_bridge=this.metascreen({id:242,icon:V`
      |   |
      | \u2565 |
      | \u2507 |`,tile:["   | r | r ","   |   | r "],tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"  r ",connect:"9-b",wall:198,match:a=>!a(16,72)&&!a(16,152)});this.riverCaveWSE=this.metascreen({id:243,icon:V`
      |\u2500\u2500\u2500|
      |\u2550\u2566\u2550|
      |\u2510\u2551\u250c|`,tile:"   |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rrr",connect:"5d:79:bf"});this.riverCaveNWE=this.metascreen({id:244,icon:V`
      |\u2518\u2551\u2514|
      |\u2550\u2569\u2550|
      |\u2500\u2500\u2500|`,tile:" r |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr r",connect:"15p:3dp:7f",poi:[[4,0,72],[4,0,152]]});this.riverCaveNWS=this.metascreen({id:-241,icon:V`
      |\u2518\u2551\u2502|
      |\u2550\u2563\u2502|
      |\u2510\u2551\u2502|`,tile:" r |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rrr ",connect:"15p:3b:79",poi:[[4,0,72]],definition:a=>Ig("A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         A A A A A A A A R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R\n         B B B B B B B B R R R R R R R R",
["A",a.metascreens.riverCaveNWE],["B",a.metascreens.riverCaveWSE],["R",a.metascreens.riverCaveNS])});this.riverCaveNSE=this.metascreen({id:-242,icon:V`
      |\u2502\u2551\u2514|
      |\u2502\u2560\u2550|
      |\u2502\u2551\u250c|`,tile:" r | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rr",connect:"19:3dp:bf",poi:[[4,0,152]],definition:a=>Ig("L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L A A A A A A A A\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B\n         L L L L L L L L B B B B B B B B",
["A",a.metascreens.riverCaveNWE],["B",a.metascreens.riverCaveWSE],["L",a.metascreens.riverCaveNS])});this.riverCaveNS_blockedRight=this.metascreen({id:245,icon:V`
      |\u2502\u2551\u2502|
      |\u2502\u2551 |
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3p:bp",poi:[[0,64,152],[0,192,152]],mod:"block"});this.riverCaveNS_blockedLeft=this.metascreen({id:246,icon:V`
      |\u2502\u2551\u2502|
      | \u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"1p:3b:9p",poi:[[0,48,72],[0,176,72]],mod:"block"});this.spikesNS=this.metascreen({id:247,icon:V`
      | \u2591 |
      | \u2591 |
      | \u2591 |`,tile:" s | s | s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s s ",connect:"2a"});this.cryptArena_statues=this.metascreen({id:248,icon:V`<
      |&<&|
      |\u2502 \u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | c ",tilesets:{pyramid:{}},feature:["arena"],edges:"  c ",connect:"a",exits:[Object.assign({},Jg(87),{type:"crypt"})],flag:"custom:false",arena:2});this.pyramidArena_draygon=this.metascreen({id:249,icon:V`
      |\u250c\u2500\u2510|
      |\u2502\u2573\u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | w ",tilesets:{pyramid:{}},feature:["arena","pit"],edges:"  w ",connect:"a",arena:3});this.cryptArena_draygon2=this.metascreen({id:250,icon:V`
      |\u250f\u2537\u2513|
      |\u2503&\u2503|
      |\u2517\u2533\u251b|`,tile:" x | a | w ",tilesets:{pyramid:{}},feature:["arena"],edges:"c w ",connect:"2a",exits:[Y({left:6,width:4})],flag:"custom:false",arena:4});this.cryptArena_entrance=this.metascreen({id:251,icon:V`
      | \u2503 |
      | \u2503 |
      | \u257f |`,tile:" w | w | x ",tilesets:{pyramid:{}},edges:"w n ",connect:"2a",exits:[Mg()]});this.cryptTeleporter=this.metascreen({id:252,tilesets:{pyramid:{},tower:{}},exits:[Mg({left:6,width:4}),Lg(87,"teleporter")]});this.fortressArena_through=this.metascreen({id:253,icon:V`\u257d
      |\u250c\u2534\u2510|
      |\u2502 \u2502|
      |\u2515\u2533\u2519|`,tile:[" c | a | w "," n | a | w "],tilesets:{fortress:{},pyramid:{}},feature:["arena"],edges:"n w ",connect:"2a",exits:[Y()],arena:5});this.fortressTrap=this.metascreen({id:254,icon:V`
      |\u2514\u2500\u2518|
      | \u2573 |
      |\u2576\u252c\u2574|`,tile:"   | x | n ",tilesets:{fortress:{},pyramid:{}},feature:["pit"],edges:"  n ",connect:"a",exits:[Mg()]});this.shrine=this.metascreen({id:255,tilesets:{shrine:{}},exits:[Mg({left:6,width:5}),W(104)]});this.inn=this.metascreen({id:256,tilesets:{house:{}},exits:[Object.assign({},W(134),{entrance:37992})]});this.toolShop=this.metascreen({id:257,tilesets:{house:{}},exits:[Object.assign({},W(134),{entrance:37992})]});this.armorShop=this.metascreen({id:258,tilesets:{house:{}},
exits:[Object.assign({},W(134),{entrance:37992})]});for(const b in this)a=this[b],a instanceof Sg&&(a.name=b)}metascreen(a){const b=new Sg(this.rom,this.length,a);this[this.length++]=b;this.screensById.get(b.sid).push(b);for(const c in a.tilesets){const d=c,e=a.tilesets[d];if(e.requires)for(const a of e.requires)this.screensByFix.get(a).push(b);else this.rom.metatilesets[d].addScreen(b)}return b}getById(a,b){a=this.screensById.has(a)?[...this.screensById.get(a)]:[];null!=b&&(a=a.filter(a=>a.isCompatibleWithTileset(b)));
return a}registerFix(a,b){for(const d of this.screensByFix.get(a)){var c=(d.data.update||[]).find(b=>b[0]===a);if(c){if(null==b)throw Error("Seed required for update");if(!c[1](d,b,this.rom))continue}for(const b in d.data.tilesets){c=b;const e=d.data.tilesets[c];if(!e.requires)continue;const g=e.requires.indexOf(a);0>g||(e.requires.splice(g,1),e.requires.length||this.rom.metatilesets[c].addScreen(d))}}this.registeredFixes.add(a)}isFixed(a){return this.registeredFixes.has(a)}renumber(a,b,c){if(a!==
b){var d=this.screensById.get(b);if(d.length)throw Error(`ID already used: ${ma(b)}: ${d.join(", ")}`);for(var e of this.getById(a))if(!c||e.tilesets().some(a=>c.has(a))){if(e.data.definition){var f=e.data.definition(this.rom);e.data.definition=void 0}e.unsafeSetId(b);d.push(e)}this.screensById.delete(a);e=this.rom.screens.getScreen(a);0<=a&&0>b&&(d[0].data.definition=ah(Uint8Array.from(e.tiles)));d=e.clone(b);this.rom.screens.setScreen(b,d);e.used=!1;0>a&&(this.rom.screens.deleteScreen(a),f&&0<=
b&&(d.tiles=Array.from(f)));this.rom.locations.renumberScreen(a,b)}}checkExitTypes(){var a;for(const b in this){const c=this[b],d=new Set;for(const e of(null===(a=null===c||void 0===c?void 0:c.data)||void 0===a?void 0:a.exits)||[])d.has(e.type)&&console.log(`duplicate: ${b} ${e.type}`),d.add(e.type)}}}function ah(a){return()=>a};class bh extends Xc{constructor(a,b){super(a,b);this.mirrored=null;this.pointer=230492+(this.id<<1);this.base=Pb(a.prg,this.pointer)+196608;this.used=229376<=this.base;if(255===a.prg[this.base]){const c=Pb(a.prg,this.base+1);for(let b=0;256>b;b++)if(Pb(a.prg,230492+(b<<1))===c){this.mirrored=b;break}if(null==this.mirrored)throw Error(`could not find mirrored sprite for ${x(b)}: ${x(c)}`);this.frames=this.frameMask=this.size=0;this.sprites=[]}else this.mirrored=null,this.size=a.prg[this.base],this.frameMask=
a.prg[this.base+1],this.frames=this.frameMask+1,this.sprites=w(this.frames,b=>{b=this.base+2+4*b*this.size;const c=[];for(let d=0;d<this.size&&128!==a.prg[b+4*d];d++)c.push(Eb(a.prg,b+4*d,4));return c})}patternBanks(a=0){if(!this.used)return[];let b=this;b.mirrored&&(b=this.rom.metasprites[b.mirrored]);const c=new Set;for(const d of b.sprites)for(const [b,,,f]of d){if(128===b)break;c.add(f+a>>>6&255)}return[...c]}palettes(){if(!this.used)return[];let a=this;a.mirrored&&(a=this.rom.metasprites[a.mirrored]);
const b=new Set;for(const c of a.sprites)for(const [a,,e]of c){if(128===a)break;b.add(e&3)}return[...b]}};class ch{constructor(a){this.rom=a;this._all=[];this.grass=this.tileset(128,{patterns:[0,12]});this.town=this.tileset(132,{});this.cave=this.tileset(136,{});this.dolphinCave=this.tileset(136,{});this.pyramid=this.tileset(140,{});this.river=this.tileset(144,{animated:[0,1],patterns:[20,0]});this.sea=this.tileset(148,{});this.lime=this.tileset(148,{});this.mountain=this.tileset(148,{});this.shrine=this.tileset(152,{});this.desert=this.tileset(156,{});this.mountainRiver=this.tileset(156,{});this.swamp=
this.tileset(160,{consolidated:!0});this.house=this.tileset(160,{});this.fortress=this.tileset(164,{});this.labyrinth=this.tileset(164,{});this.iceCave=this.tileset(168,{});this.tower=this.tileset(172,{});for(const b in this)a=this[b],a instanceof dh&&(a.name=b)}tileset(a,b){a=new dh(this.rom,a,b);this._all.push(a);return a}[Symbol.iterator](){return this._all[Symbol.iterator]()}}
class dh{constructor(a,b,c){this.rom=a;this.tilesetId=b;this.data=c;this._screens=new Set;this._cache=void 0}[Symbol.iterator](){return this._screens[Symbol.iterator]()}get cache(){this._cache||(this._cache=new eh(this));return this._cache}get tileset(){return this.rom.tilesets[this.tilesetId]}get empty(){const a=this.cache.empty;if(!a)throw Error(`No empty screen for ${this.name}`);return a}effects(){return this.tileset.effects()}getTile(a){return this.tileset.getTile(a)}addScreen(a){this._screens.add(a);
a.unsafeAddTileset(this);this.invalidate()}deleteScreen(a){this._screens.delete(a);a.unsafeRemoveTileset(this);this.invalidate()}getMetascreens(a){var b;return null!==(b=this.cache.fromId.get(a))&&void 0!==b?b:[]}getExits(a){return this.cache.exits.get(a)}getMetascreensFromTileString(a){return this.cache.tiles.has(a)?this.cache.tiles.get(a):[]}getScreensWithOnlyFeatures(...a){let b=0;for(const c of a)b|=Hg[c];a=[];for(const c of this)c.features&~b||a.push(c);return a}withMod(a,b){const c=[];for(const d of this.cache.tiles.get(a))d.data.mod===
b&&c.push(d);return c}unreachableVariant(a){for(const b of this)if(b.sid===a.sid&&b.isEmpty())return b;return a}isBannedVertical(a,b){return this.cache.bannedNeighbors[0].has(a.uid<<16|b.uid)}isBannedHorizontal(a,b){return this.cache.bannedNeighbors[1].has(a.uid<<16|b.uid)}invalidate(){this._cache=void 0}}var fh,gh=fh||(fh={});gh.N=0;gh.W=1;gh.S=2;gh.E=3;
class eh{constructor(a){var b,c;this.tileset=a;this.fromId=new ba(()=>[]);this.exits=new ba(()=>[]);this.tiles=new ba(()=>[]);this.bannedNeighbors=[new Set,new Set];let d=void 0;for(const f of a){0<=f.sid&&this.fromId.get(f.sid).push(f);d||"    "!==f.data.edges||"manual"===f.data.placement||!f.hasFeature("empty")||(null===(b=f.data.exits)||void 0===b?0:b.length)||(d=f);for(const a of null!==(c=f.data.exits)&&void 0!==c?c:[])this.exits.get(a.type).push(f);var e="string"===typeof f.data.tile?[f.data.tile]:
f.data.tile;for(const a of null!==e&&void 0!==e?e:[])this.tiles.get(a.replace(/\|/g,"")).push(f);(f.hasFeature("ramp")||f.hasFeature("overpass")||f.hasFeature("pit")||f.isEmpty())&&this.banDeadEndNeighbor(f);e=a.rom.metascreens;this.banDeadEndNeighbor(e.branchNWE_wall,1);this.banNeighbor(e.deadEndS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndN_stairs,2);this.banNeighbor(e.deadEndS_stairs,e.deadEndNS_stairs,2);this.banNeighbor(e.deadEndNS_stairs,e.deadEndNS_stairs,2)}this.empty=
null!==d&&void 0!==d?d:a.rom.metascreens.caveEmpty}banDeadEndNeighbor(a,b=15){var c,d;for(const e of this.tileset)if(e.hasFeature("deadend"))for(let f=0;4>f;f++)b&1<<f&&" "!==(null===(c=a.data.edges)||void 0===c?void 0:c[f])&&" "!==(null===(d=e.data.edges)||void 0===d?void 0:d[f^2])&&this.banNeighbor(a,e,f)}banNeighbor(a,b,c){this.bannedNeighbors[c&1].add((c&2?a:b).uid<<16|(c&2?b:a).uid)}};class Z extends Xc{constructor(a,b,c,d={}){super(a.rom,b);this.type=c;this.data=d;a[b]=this}}
class hh extends Yc{constructor(a){super();this.rom=a;this.straightShotOptionalBounce=new Z(this,16,"projectile");this.straightShotNoBounce=new Z(this,17,"projectile");this.madoShuriken=new Z(this,22,"projectile");this.demonWallFire=new Z(this,23,"projectile");this.popcorn=new Z(this,27,"projectile");this.harpoonSource=new Z(this,29,"source");this.lasers=new Z(this,30,"projectile");this.paralysisPowder=new Z(this,31,"projectile");this.randomMovement=new Z(this,32,"monster",{movement:1});this.randomLargeStoner=
new Z(this,33,"monster",{hasChild:!0,large:!0,movement:2});this.slowHoming=new Z(this,34,"monster",{hasChild:!0,movement:3});this.smallHoming1=new Z(this,36,"monster",{movement:3});this.smallHoming2=new Z(this,37,"monster",{movement:3});this.homingShooter1=new Z(this,38,"monster",{hasChild:!0,projectile:1,movement:3});this.homingShooter2=new Z(this,39,"monster",{hasChild:!0,projectile:1,movement:3});this.headShooter=new Z(this,40,"monster",{hasChild:!0,projectile:2,movement:3,metasprites:()=>[101,
145]});this.puddle=new Z(this,41,"monster",{hasChild:!0,movement:5,metasprites:()=>[107,104]});this.soldier=new Z(this,42,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});this.mimic=new Z(this,43,"monster",{movement:4});this.mothResidueSource=new Z(this,44,"source",{hasChild:!0});this.flailGuy=new Z(this,46,"monster",{hasChild:!0,large:!0,projectile:2,movement:3});this.dynaLaser=new Z(this,47,"projectile");this.guardianStatue=new Z(this,52,"source",{hasChild:!0});
this.movingPlatform=new Z(this,56,"other");this.crumblingMovingPlatform=new Z(this,60,"other");this.erraticFlyer=new Z(this,64,"monster",{hasChild:!0,moth:!0,movement:4,placement:"moth"});this.skeleton=new Z(this,65,"monster",{hasChild:!0,movement:3});this.swampTomato=new Z(this,68,"monster",{movement:3});this.shootingFlyer=new Z(this,69,"monster",{hasChild:!0,bird:!0,projectile:2,movement:5,placement:"bird"});this.swampPlant=new Z(this,76,"monster",{hasChild:!0,stationary:!0,projectile:3,placement:"plant"});
this.kraken=new Z(this,77,"monster",{hasChild:!0,stationary:!0,projectile:3});this.burt=new Z(this,78,"monster",{hasChild:!0,stationary:!0});this.dynaShot=new Z(this,87,"projectile",{});this.popcorn2=new Z(this,88,"projectile");this.towerSentinel=new Z(this,92,"monster",{hasChild:!0,projectile:3,movement:1});this.helicopter=new Z(this,93,"monster",{bird:!0,movement:6,placement:"bird"});this.whiteRobot=new Z(this,94,"monster",{hasChild:!0,projectile:1,movement:4,metasprites:a=>[0,1,2,3].map(b=>b+a.data[31])});
this.vampire=new Z(this,96,"boss");this.vampireBat=new Z(this,97,"monster");this.kelbesque=new Z(this,99,"boss");this.kelbesqueRock=new Z(this,100,"projectile");this.sabera=new Z(this,102,"boss");this.mado=new Z(this,103,"boss");this.karmine=new Z(this,104,"boss");this.draygon1=new Z(this,106,"boss");this.draygon2=new Z(this,107,"boss");this.dyna=new Z(this,112,"boss");this.giantBug=new Z(this,127,"boss")}};class ih extends Yc{constructor(a){super(256);this.rom=a;this.mesiaSabera=new td(this,42,"Mesia");this.sorcerorShot=new F(this,{id:63,scaling:37,type:"projectile"});this.wraith1=new F(this,{id:75,scaling:24,class:"wraith",displayName:"Wraith"});this.paralysisPowderSource=new F(this,{id:77,scaling:23,type:"projectile"});this.wraith2=new F(this,{id:79,scaling:28,class:"wraith",displayName:"Wraith"});this.blueSlime=new F(this,{id:80,scaling:1,class:"slime",displayName:"Slime"});this.weretiger=new F(this,
{id:81,scaling:1,displayName:"Weretiger"});this.greenJelly=new F(this,{id:82,scaling:4,class:"jelly",displayName:"Slug"});this.redSlime=new F(this,{id:83,scaling:4,class:"slime",displayName:"Poison Slime"});this.rockGolem=new F(this,{id:84,scaling:4,class:"golem",displayName:"Mud Golem"});this.blueBat=new F(this,{id:85,scaling:4,displayName:"Bat"});this.greenWyvern=new F(this,{id:86,scaling:4,class:"wyvern",displayName:"Wyvern"});this.vampire1=new F(this,{id:87,scaling:5,type:"boss",displayName:"Vampire"});
this.orc=new F(this,{id:88,scaling:6,displayName:"Axe Wereboar"});this.redMosquito=new F(this,{id:89,scaling:10,class:"mosquito",displayName:"Mosquito"});this.blueMushroom=new F(this,{id:90,scaling:10,class:"mushroom",displayName:"Mushroom"});this.swampTomato=new F(this,{id:91,scaling:10,displayName:"Pillbug"});this.blueMosquito=new F(this,{id:92,scaling:23,class:"mosquito",displayName:"Mosquito"});this.swampPlant=new F(this,{id:93,scaling:10,displayName:"Swamp Dandelion"});this.giantInsect=new F(this,
{id:94,scaling:11,type:"boss",displayName:"Giant Insect"});this.largeBlueSlime=new F(this,{id:95,scaling:11,class:"slime",displayName:"Large Slime"});this.iceZombie=new F(this,{id:96,scaling:12,class:"zombie",displayName:"Ice Zombie"});this.greenBrain=new F(this,{id:97,scaling:12,class:"brain",displayName:"Brain"});this.greenSpider=new F(this,{id:98,scaling:12,class:"spider",displayName:"Spider"});this.redWyvern=new F(this,{id:99,scaling:12,class:"wyvern",displayName:"Wyvern"});this.soldier=new F(this,
{id:100,scaling:14,class:"soldier",displayName:"Draygonia Soldier"});this.iceEntity=new F(this,{id:101,scaling:14,class:"entity",displayName:"Ice Plant"});this.redBrain=new F(this,{id:102,scaling:14,class:"brain",displayName:"Poison Brain"});this.iceGolem=new F(this,{id:103,scaling:14,class:"golem",displayName:"Ice Golem"});this.kelbesque1=new F(this,{id:104,scaling:15,type:"boss",displayName:"General Kelbesque"});this.largeRedSlime=new F(this,{id:105,scaling:18,class:"slime",displayName:"Large Poison Slime"});
this.troll=new F(this,{id:106,scaling:18,displayName:"Troll"});this.redJelly=new F(this,{id:107,scaling:18,class:"jelly",displayName:"Poison Jelly"});this.medusa=new F(this,{id:108,scaling:19,displayName:"Medusa"});this.crab=new F(this,{id:109,scaling:19,displayName:"Crab"});this.medusaHead=new F(this,{id:110,scaling:20,displayName:"Flying Plant"});this.bird=new F(this,{id:111,scaling:20,class:"bird",displayName:"Bird"});this.redMushroom=new F(this,{id:113,scaling:21,class:"mushroom",displayName:"Poison Mushroom"});
this.earthEntity=new F(this,{id:114,scaling:22,class:"entity",displayName:"Poison Plant"});this.mimic=new F(this,{id:115,scaling:22,displayName:"Mimic"});this.redSpider=new F(this,{id:116,scaling:22,class:"spider",displayName:"Paralyzing Spider"});this.fishman=new F(this,{id:117,scaling:25,displayName:"Mutant Fish"});this.jellyfish=new F(this,{id:118,scaling:25,displayName:"Jellyfish"});this.kraken=new F(this,{id:119,scaling:25,displayName:"Kraken"});this.darkGreenWyvern=new F(this,{id:120,scaling:27,
class:"wyvern",displayName:"Wyvern Mage"});this.sandZombie=new F(this,{id:121,scaling:38,class:"zombie",displayName:"Sand Zombie"});this.wraithShadow1=new F(this,{id:123,scaling:28,class:"wraith",displayName:"Shadow"});this.moth=new F(this,{id:124,scaling:28,difficulty:3,displayName:"Butterfly"});this.sabera1=new F(this,{id:125,scaling:29,type:"boss",displayName:"General Sabera"});this.verticalPlatform=new td(this,126);this.horizotalPlatform=new td(this,127);this.archer=new F(this,{id:128,scaling:33,
class:"soldier",displayName:"Draygonia Archer"});this.bomberBird=new F(this,{id:129,scaling:33,class:"bird",displayName:"Bomber Bird"});this.lavaBlob=new F(this,{id:130,scaling:37,class:"puddle",displayName:"Lava Blob"});this.flailGuy=new F(this,{id:132,scaling:37,displayName:"Flail Guy"});this.blueEye=new F(this,{id:133,scaling:37,class:"eye",displayName:"Beholder"});this.salamander=new F(this,{id:134,scaling:37,displayName:"Salamander"});this.sorceror=new F(this,{id:135,scaling:37,displayName:"Burt"});
this.mado1=new F(this,{id:136,scaling:37,displayName:"General Mado"});this.knight=new F(this,{id:137,scaling:41,difficulty:1,displayName:"Ninja"});this.devil=new F(this,{id:138,scaling:41,displayName:"Devil Bat"});this.kelbesque2=new F(this,{id:139,scaling:41,type:"boss",displayName:"General Kelbesque"});this.wraithShadow2=new F(this,{id:140,scaling:41,class:"wraith",displayName:"Shadow"});this.glitch1=new td(this,141);this.glitch2=new td(this,142);this.guardianStatue=new td(this,143);this.sabera2=
new F(this,{id:144,scaling:41,type:"boss",displayName:"General Sabera"});this.tarantula=new F(this,{id:145,scaling:41,displayName:"Tarantula"});this.skeleton=new F(this,{id:146,scaling:41,displayName:"Skeleton"});this.mado2=new F(this,{id:147,scaling:41,type:"boss",displayName:"General Mado"});this.purpleEye=new F(this,{id:148,scaling:41,class:"eye",displayName:"Beholder"});this.flailKnight=new F(this,{id:149,scaling:41,displayName:"Flail Knight"});this.scorpion=new F(this,{id:150,scaling:41,displayName:"Scorpion"});
this.karmine=new F(this,{id:151,scaling:41,type:"boss",displayName:"General Karmine"});this.sandBlob=new F(this,{id:152,scaling:44,class:"puddle",displayName:"Sand Blob"});this.mummy=new F(this,{id:153,scaling:44,displayName:"Mummy"});this.warlock=new F(this,{id:154,scaling:46,displayName:"Warlock"});this.draygon1=new F(this,{id:155,scaling:45,type:"boss",displayName:"Emperor Draygon"});this.statueOfSun=new td(this,156);this.statueOfMoon=new td(this,157);this.draygon2=new F(this,{id:158,scaling:47,
type:"boss",displayName:"Emperor Draygon"});this.crumblingVerticalPlatform=new td(this,159);this.brownRobot=new F(this,{id:160,scaling:47,difficulty:1,displayName:"Robot Sentry"});this.whiteRobot=new F(this,{id:161,scaling:47,displayName:"Robot Enforcer"});this.towerSentinel=new F(this,{id:162,scaling:47,displayName:"Tower Sentinel"});this.helicopter=new F(this,{id:163,scaling:47,displayName:"Robocopter"});this.dyna=new F(this,{id:164,scaling:47,type:"boss",displayName:"DYNA"});this.vampire2=new F(this,
{id:165,scaling:28,type:"boss",displayName:"Vampire"});this.glitch3=new td(this,166);this.dynaPod=new F(this,{id:180,scaling:47,type:"boss",displayName:"DYNA Defense Pod"});this.dynaCounter=new F(this,{id:184,scaling:47,type:"projectile"});this.dynaLaser=new F(this,{id:185,scaling:47,type:"projectile"});this.dynaBubble=new F(this,{id:186,scaling:47,type:"projectile"});this.vampire2Bat=new F(this,{id:188,scaling:28});this.brownRobotLaserSource=new F(this,{id:190,scaling:47,type:"projectile"});this.draygon2Fireball=
new F(this,{id:191,scaling:47,type:"projectile"});this.vampire1Bat=new F(this,{id:193,scaling:5});this.giantInsectFireball=new F(this,{id:195,scaling:11,type:"projectile"});this.greenMosquito=new F(this,{id:196,scaling:11,displayName:"Mosquito"});this.kelbesque1Rock=new F(this,{id:197,scaling:15,type:"projectile"});this.sabera1Balls=new F(this,{id:198,scaling:29,type:"projectile"});this.kelbesque2Fire=new F(this,{id:199,scaling:41,type:"projectile"});this.sabera2Fire=new F(this,{id:200,scaling:41,
type:"projectile"});this.sabera2Balls=new F(this,{id:201,scaling:41,type:"projectile"});this.karmineBalls=new F(this,{id:202,scaling:41,type:"projectile"});this.statueBalls=new F(this,{id:203,scaling:47,type:"projectile"});this.draygon1Lightning=new F(this,{id:204,scaling:45,type:"projectile"});this.draygon2Laser=new F(this,{id:205,scaling:47,type:"projectile"});this.draygon2Breath=new F(this,{id:206,scaling:47,type:"projectile"});this.birdBomb=new F(this,{id:224,scaling:33,type:"projectile"});this.greenMosquitoShot=
new F(this,{id:226,scaling:11,type:"projectile"});this.paralysisBeam=new F(this,{id:227,scaling:25,type:"projectile"});this.stoneGaze=new F(this,{id:228,scaling:19,type:"projectile"});this.rockGolemRock=new F(this,{id:229,scaling:4,type:"projectile"});this.curseBeam=new F(this,{id:230,scaling:41,type:"projectile"});this.mpDrainWeb=new F(this,{id:231,scaling:41,type:"projectile"});this.fishmanTrident=new F(this,{id:232,scaling:25,type:"projectile"});this.orcAxe=new F(this,{id:233,scaling:6,type:"projectile"});
this.swampPollen=new F(this,{id:234,scaling:10,type:"projectile"});this.paralysisPowder=new F(this,{id:235,scaling:23,type:"projectile"});this.soldierSword=new F(this,{id:236,scaling:14,type:"projectile"});this.iceGolemRock=new F(this,{id:237,scaling:14,type:"projectile"});this.trollAxe=new F(this,{id:238,scaling:18,type:"projectile"});this.krakenInk=new F(this,{id:239,scaling:25,type:"projectile"});this.archerArrow=new F(this,{id:240,scaling:33,type:"projectile"});this.knightSword=new F(this,{id:242,
scaling:41,type:"projectile"});this.mothResidue=new F(this,{id:243,scaling:28,type:"projectile"});this.brownRobotLaser=new F(this,{id:244,scaling:47,type:"projectile"});this.whiteRobotLaser=new F(this,{id:245,scaling:47,type:"projectile"});this.towerSentinelLaser=new F(this,{id:246,scaling:47,type:"projectile"});this.skeletonShot=new F(this,{id:247,scaling:41,type:"projectile"});this.blobShot=new F(this,{id:248,scaling:37,type:"projectile"});this.flailKnightFlail=new F(this,{id:249,scaling:41,type:"projectile"});
this.flailGuyFlail=new F(this,{id:250,scaling:37,type:"projectile"});this.madoShuriken=new F(this,{id:252,scaling:37,type:"projectile"});this.guardianStatueMissile=new F(this,{id:253,scaling:36,type:"projectile"});this.demonWallFire=new F(this,{id:254,scaling:37,type:"projectile"});for(var b in this)a=this[b],a instanceof td&&(a.name=Db(b));for(b=0;b<this.length;b++)this[b]||(this[b]=new td(this,b))}write(){const a=[];for(var b of this)a.push(...b.write());if(this.rom.writeMonsterNames){b=this.rom.assembler();
var c=Math.max(...this.map(a=>a.displayName.length));if(27<c)throw Error(`Longest displayName length is greater than ${27}. (${c} > ${27})\nCrystalis HUD can't comfortably fit that many characters.`);b.assign("ENEMY_NAME_LENGTH",c);b.export("ENEMY_NAME_LENGTH");b.segment("1a");b.reloc("EnemyNameBlocklist");b.label("EnemyNameBlocklist");b.export("EnemyNameBlocklist");c=[this.dynaCounter,this.dynaLaser,this.dynaBubble];c=this.filter(a=>0<a.hp&&""==a.displayName).concat(c);b.byte(...c.map(a=>a.id));
b.assign("ENEMY_NAME_BLOCKLIST_LEN",c.length);b.export("ENEMY_NAME_BLOCKLIST_LEN");a.push(b.module())}return a}};var jh;(function(a){a.bit=(a,c)=>new kh(a,c);a.byte=a=>new lh(a);a.address=a=>new mh(a)})(jh||(jh={}));class kh{constructor(a,b){this.address=a;this.bit=b}get(a){return!!(a[this.address]&1<<this.bit)}set(a,b){const c=1<<this.bit;a[this.address]=b?a[this.address]|c:a[this.address]&~c}}class lh{constructor(a){this.address=a}get(a){return a[this.address]}set(a,b){a[this.address]=b&255}}
class mh{constructor(a){this.address=a}get(a){return a[this.address]<<16|a[this.address+1]<<8|a[this.address+2]}set(a,b){a[this.address]=b>>>16&255;a[this.address+1]=b>>>8&255;a[this.address+2]=b&255}};class nh extends Xc{constructor(a,b){super(a,b);this.base=(b&3)<<2|(b&252)<<6|16624;this.colors=Eb(a.prg,this.base,4)}color(a){return this.colors[a]&63}};class oh{constructor(a){this.rom=a;this.values=Eb(a.prg,ph.offset,64)}write(){const a=this.rom.assembler();ph.loc(a);a.byte(...this.values);return[a.module()]}}const ph=B.of(y.$1a,38884);const {$0d:qh,$fe:rh,$ff:sh}=y;
class th{constructor(a){this.rom=a;this.patk=Array(48).fill(0);this.pdef=Array(48).fill(0);this.php=Array(48).fill(0);this.exp=Array(48).fill(0);this.setPAtkFormula(a=>5+15*a/32);this.setPDefFormula(a=>a);this.setPhpFormula(a=>48+5.5*a);this.setExpScalingFactor(1)}setExpScalingFactor(a){this.setExpFormula(b=>Math.floor(4*Math.pow(2,(16+9*b)/32)*a))}setPAtkFormula(a){this.patk=this.patk.map((b,c)=>Math.round(8*a(c)))}setPDefFormula(a){this.pdef=this.pdef.map((b,c)=>Math.round(4*a(c)))}setPhpFormula(a){this.php=
this.php.map((b,c)=>Math.min(255,Math.max(5,Math.round(a(c)))))}setExpFormula(a){this.exp=this.exp.map((b,c)=>{b=a(c);return 128>b?b:Math.min(255,128+(b>>4))})}write(){const a=this.rom.assembler();gc(a,[qh,rh,sh],"DiffAtk");a.byte(...this.patk);gc(a,[qh,rh,sh],"DiffDef");a.byte(...this.pdef);gc(a,[qh,rh,sh],"DiffHP");a.byte(...this.php);gc(a,[qh,rh,sh],"DiffExp");a.byte(...this.exp);return[a.module()]}};class uh extends Xc{constructor(a,b){super(a,b);this.used=!0;this.tiles=Eb(a.prg,(255<b?64+b:b)<<8,240)}clone(a){a=new uh(this.rom,a);a.used=this.used;a.tiles=[...this.tiles];return a}allTilesSet(){return new Set(this.tiles)}set2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){const f=e[b];null!=f&&(this.tiles[a+d<<4|c+b]=f)}}}get2d(a,b){const c=a&15;var d=a>>>4;a=(b&15)+1;b=d+(b>>>4);const e=[];for(;d<=b;d++){const b=d<<4|c;e.push(this.tiles.slice(b,
b+a))}return e}assemble(a){const b=this.id.toString(16).padStart(2,"0");let c=this.tiles;if(this.rom.compressedMapData||256>this.id){const b=(this.id>>5).toString(16).padStart(2,"0");a.segment(b);"0a"===b&&(c=c.slice(192))}else a.segment("0a"),c=c.slice(0,192);a.org(32768|(this.id&63)<<8,`Screen_${b}`);a.byte(...c)}}
class vh extends Array{constructor(a){super(259);this.rom=a;this.unallocated=[];for(let b=0;259>b;b++)this[b]=new uh(a,b)}getScreen(a){const b=0>a?this.unallocated:this,c=0>a?~a:a;return b[c]||(b[c]=new uh(this.rom,a))}setScreen(a,b){(0>a?this.unallocated:this)[0>a?~a:a]=b}deleteScreen(a){delete (0>a?this.unallocated:this)[0>a?~a:a]}write(){const a=this.rom.assembler();for(const b of this)(null===b||void 0===b?0:b.used)&&b.assemble(a);return[a.module()]}};const {$0e:wh}=y;
class xh extends Array{constructor(a){super(128);this.rom=a;this.checkCount=112;this.mimicCount=16;for(a=0;128>a;a++)this[a]=a}setCheckCount(a){this.checkCount=a}setMimicCount(a){this.mimicCount=a}swap(a,b){if(a!==b){var c=this[a];this[a]=this[b];this[b]=c}}exportDigits(a,b,c){c=c.toString().padStart(3,"0");a.assign(`${b}_HUN`,Number(c[0]));a.export(`${b}_HUN`);a.assign(`${b}_TEN`,Number(c[1]));a.export(`${b}_TEN`);a.assign(`${b}_ONE`,Number(c[2]));a.export(`${b}_ONE`)}write(){const a=this.rom.assembler();
gc(a,[wh],"CheckToItemGetMap");this.exportDigits(a,"CHECK_COUNT",this.checkCount);this.exportDigits(a,"MIMIC_COUNT",this.mimicCount);a.byte(...this);return[a.module()]}};const {$0e:yh,$fe:zh,$ff:Ah}=y;var Bh,Ch=Bh||(Bh={});Ch[Ch.TORNEL=0]="TORNEL";Ch[Ch.ZEBU=1]="ZEBU";Ch[Ch.ASINA=2]="ASINA";Ch[Ch.KENSU=3]="KENSU";var Dh,Eh=Dh||(Dh={});Eh[Eh.INSUFFICIENT_MAGIC=0]="INSUFFICIENT_MAGIC";Eh[Eh.FREE_MAGIC=1]="FREE_MAGIC";Eh[Eh.IGNORED=2]="IGNORED";Eh[Eh.DEFAULT=3]="DEFAULT";
class Fh{constructor(a){this.rom=a;this.sages=w(4,a=>new Gh(this,a));this.resultTable=Eb(a.prg,115247,64);a.telepathyTablesAddress?(this.groupsByLocation=[],this.minimumLevels=[]):(this.groupsByLocation=Eb(a.prg,121076,256),this.minimumLevels=Eb(a.prg,115219,7))}write(){var a=this.rom.telepathyTablesAddress;const b=this.rom.assembler();b.segment(yh.name,zh.name,Ah.name);if(a)for(fc(b,yh,39156,39680),a=this.sages.map((a,c)=>{b.reloc(`Telepathy_Sage_${c}`);c=b.pc();b.byte(...a.messageGroups[0].bytes());
return c}),b.org(33327,"Telepathy_ResultTable"),b.byte(...this.resultTable.map(a=>4>a?a:a>>>1)),b.reloc("TelepathyTable"),b.export("TelepathyTable"),b.label("TelepathyTable"),b.word(...a),a=1;4>a;a++)for(var c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);else{fc(b,yh,39500,39680);b.org(33327,"Telepathy_ResultTable");b.byte(...this.resultTable);b.org(33299,"Telepathy_LevelsTable");b.byte(...this.minimumLevels);b.org(39156,"Telepathy_LocationTable");b.byte(...this.groupsByLocation);b.org(39468,
"Telepathy_VanillaDefaultsTable");for(a=0;4>a;a++)for(c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);a=[];for(c=0;4>c;c++){const d=this.sages[c];for(let e=0,f=d.messageGroups.length;e<f;e++)b.reloc(`Telepathy_Sage_${c}_Group_${e}`),a[4*e+c]=b.pc(),b.byte(...d.messageGroups[e].bytes())}b.org(39412,"Telepathy_VanillaMainTable");b.word(...a)}return[b.module()]}}
class Gh{constructor(a,b){this.telepathy=a;this.sage=b;const c=a.rom;let d,e;c.telepathyTablesAddress?(e=d=c.telepathyTablesAddress+2*b,a=1):(d=121388+2*b,e=121332+2*b,a=7);this.defaultMessages=w(4,a=>Fe.from(c.prg,d+8*a));this.messageGroups=w(a,a=>Hh.from(c.prg,e+8*a))}}
class Hh{constructor(a){this.messages=a}bytes(){const a=[];for(let b=0,c=this.messages.length;b<c;b++){const [d,e,f]=this.messages[b];let g=0<=d?d:8192|~d;b===c-1&&(g|=32768);f&&(g|=16384);a.push(g>>=8,g&255,...e.data,...f?f.data:[])}return a}static from(a,b){const c=new Hh([]);b=Pb(a,b)+81920;let d=0;for(;!(d&32768);){d=Ob(a,b);b+=2;var e=d&8191;d&8192&&(e=~e);e=[e,Fe.from(a,b)];b+=2;d&16384&&(e.push(Fe.from(a,b)),b+=2);c.messages.push(e)}return c}};class Ih extends Xc{constructor(a,b){super(a,b);this.base=255865+(b<<3);this.pages=Eb(a.prg,this.base,8)}};class Jh extends Xc{constructor(a,b){super(a,b);this.effects=Eb(a.prg,this.base,256)}get base(){return this.id<<8&8191|73728}get org(){return this.id<<8&8191|40960}write(){const a=this.rom.assembler();a.segment("09","fe","ff");a.org(this.org,`TileEffects_${this.id.toString(16)}_Tiles`);a.byte(...this.effects);return[a.module()]}}Jh.PIT=1;Jh.NO_WALK=2;Jh.IMPASSIBLE=4;Jh.ALTERNATIVE=8;Jh.BEHIND=16;Jh.SLOPE=32;Jh.SLOW=64;Jh.PAIN=128;class Kh{constructor(a,b){this.tileset=a;this.id=b;this.copiedFrom=-1}get tiles(){return[0,1,2,3].map(a=>this.tileset.tiles[a][this.id])}setTiles(a){for(let b=0;4>b;b++){const c=a[b];null!=c&&(this.tileset.tiles[b][this.id]=c)}return this}get alternative(){const a=32>this.id?this.tileset.alternates[this.id]:this.id;return a!==this.id?a:null}setAlternative(a){if(32<=this.id)return this;this.tileset.alternates[this.id]=null!=a?a:this.id;this.tileset.effects().effects[this.id]|=8;return this}get attrs(){return this.tileset.attrs[this.id]}setAttrs(a){this.tileset.attrs[this.id]=
a;return this}get effects(){return this.tileset.effects().effects[this.id]}setEffects(a){this.tileset.effects().effects[this.id]=a;return this}copyFrom(a){const b=new Kh(this.tileset,a);this.copiedFrom=a;this.setTiles(b.tiles);32>(this.id|b.id)&&this.setAlternative(b.alternative);this.setAttrs(b.attrs);this.setEffects(b.effects);return this}replaceIn(...a){if(0>this.copiedFrom)throw Error("Must copyFrom first.");for(const b of a)b.replace(this.copiedFrom,this.id);return this}};class Lh{constructor(a){this.rom=a;this.tilesets=[];for(let b=128;176>b;b+=4)this.tilesets.push(this[b]=new Mh(a,b))}[Symbol.iterator](){return this.tilesets[Symbol.iterator]()}}
class Mh extends Xc{constructor(a,b){super(a,b);this.tiles=w(4,b=>Eb(a.prg,this.tileBase|b<<8,256));this.attrs=w(256,b=>a.prg[this.attrBase|b>>2]>>((b&3)<<1)&3);this.alternates=Eb(a.prg,this.alternatesBase,32)}get map(){return this.id&63}get tileBase(){return 65536|this.map<<8}get attrBase(){return 77824|this.map<<4}get alternatesBase(){return 81408|this.map<<3}getTile(a){return new Kh(this,a)}write(){const a=w(64,a=>{a<<=2;return this.attrs[a]&3|(this.attrs[a+1]&3)<<2|(this.attrs[a+2]&3)<<4|(this.attrs[a+
3]&3)<<6}),b=this.rom.assembler(),c=`Tileset_${this.id.toString(16).padStart(2,"0")}`;b.segment("08","09");b.org(32768|this.map<<8,`${c}_Tiles`);b.byte(...[].concat(...this.tiles));b.org(45056|this.map<<4,`${c}_Attrs`);b.byte(...a);b.org(48640|this.map<<3,`${c}_Alternates`);b.byte(...this.alternates);return[b.module()]}effects(){let a=this.id>>>2&15;168===this.id&&(a=2);172===this.id&&a--;return this.rom.tileEffects[a]}};class Nh{constructor(a){this.rom=a;this.locations=Eb(a.prg,Oh.offset,12);this.thunderSwordWarp=[a.prg[251338],a.prg[251342]]}write(){const a=this.rom.assembler();Oh.loc(a);a.label("TownWarpTable");a.byte(...this.locations);a.org(56460);a.instruction("lda","TownWarpTable,y");a.org(54729);a.instruction("lda","#"+this.thunderSwordWarp[0]);a.org(54733);a.instruction("lda","#"+this.thunderSwordWarp[1]);return[a.module()]}}const Oh=B.of(y.$fe,56408);const Ph=new Set([131,135,136,137,143,147,150,152,155,156,157,158,159,170,179,181,185,190,192]);
class Qh extends Xc{constructor(a,b){super(a,b);this.used=!Ph.has(b);this.pointer=123258+((b&127)<<1);this.base=Hb(a.prg,this.pointer,81920);this.conditions=[];this.message=Fe.of({});this.flags=[];let c=this.base;do{b=Ob(a.prg,c);var d=b&4095;this.conditions.push(b&8192?~d:d);c+=2}while(!(b&32768));this.message=Fe.from(a.prg,c);do c+=2,b=Ob(a.prg,c),d=b&4095,this.flags.push(b&32768?~d:d);while(!(b&16384))}bytes(){const a=[];this.conditions.length||this.conditions.push(-1);for(var b=0;b<this.conditions.length;b++){var c=
this.conditions[b];0>c&&(c=~c|8192);b===this.conditions.length-1&&(c|=32768);a.push(c>>>8,c&255)}a.push(...this.message.data);this.flags.length||this.flags.push(-1);for(b=0;b<this.flags.length;b++)c=this.flags[b],0>c&&(c=~c|32768),b===this.flags.length-1&&(c|=16384),a.push(c>>>8,c&255);return a}write(){if(!this.used)return[];const a=this.rom.assembler(),b=`Trigger_${x(this.id)}`;a.segment("0f");a.reloc(b);const c=a.pc();a.byte(...this.bytes());a.org(41338+2*(this.id&127),b+"_Ptr");a.word(c);return[a.module()]}}
;class Rh{constructor(a){this.rom=a;this.locations=Eb(a.prg,Sh.offset,16)}write(){const a=this.rom.assembler();Sh.loc(a);a.label("WildWarpLocations");a.byte(...this.locations);a.org(52185);a.instruction("lda","WildWarpLocations,y");return[a.module()]}}const Sh=B.of(y.$fe,52204);const {$0e:Th,$0f:Uh,$10:Vh}=y;
class Wh{constructor(a){this.modules=new Map;this.allocatedTriggers=new Map;const b=16+(a[6]&4?512:0),c=b+16384*a[4];this.prg=a.subarray(b,c);this.chr=a.subarray(c);this.shopCount=Wh.SHOP_COUNT.get(a);this.scalingLevels=Wh.SCALING_LEVELS.get(a);this.uniqueItemTableAddress=Wh.UNIQUE_ITEM_TABLE.get(a);this.shopDataTablesAddress=Wh.SHOP_DATA_TABLES.get(a);this.telepathyTablesAddress=Wh.TELEPATHY_TABLES.get(a);this.omitItemGetDataSuffix=Wh.OMIT_ITEM_GET_DATA_SUFFIX.get(a);this.omitLocalDialogSuffix=Wh.OMIT_LOCAL_DIALOG_SUFFIX.get(a);
this.compressedMapData=Wh.COMPRESSED_MAPDATA.get(a);this.writeMonsterNames=Wh.WRITE_MONSTER_NAMES.get(a);for(const a of Xh){const [b,c,d]=a;this.prg[b]===c&&(this.prg[b]=d)}this.tilesets=new Lh(this);this.tileEffects=w(11,a=>new Jh(this,a+179));this.screens=new vh(this);this.metatilesets=new ch(this);this.metascreens=new $g(this);this.triggers=w(67,a=>new Qh(this,128|a));this.patterns=new af(this);this.palettes=w(256,a=>new nh(this,a));this.locations=new Ce(this);this.tileAnimations=w(4,a=>new Ih(this,
a));this.hitboxes=w(24,a=>new dg(this,a));this.objectActions=new hh(this);this.objects=new ih(this);this.adHocSpawns=w(96,a=>new If(this,a));this.metasprites=w(256,a=>new bh(this,a));this.messages=new ug(this);this.telepathy=new Fh(this);this.itemGets=new lg(this);this.items=new Bf(this);this.shops=new Zc(this);this.slots=new xh(this);this.npcs=new Le(this);this.bossKills=w(14,a=>new Jf(this,a));this.wildWarp=new Rh(this);this.townWarp=new Nh(this);this.coinDrops=new Pf(this);this.flags=new bg(this);
this.bosses=new Mf(this);this.scaling=new th(this);this.randomNumbers=new oh(this);for(const a of this.locations)a.used&&a.lazyInitialization()}trigger(a){if(128>a||255<a)throw Error(`Bad trigger id $${x(a)}`);return this.triggers[a&127]}get projectiles(){const a=new Set;for(const b of this.objects.filter(a=>a instanceof F))b.child&&a.add(this.objects[this.adHocSpawns[b.child].objectId]);return[...a].sort((a,c)=>a.id-c.id)}get monsterGraphics(){const a={};for(const b of this.locations)if(b.used&&
b.hasSpawns)for(const c of b.spawns)if(!(c.data[2]&7)){const d=c.data[2]&128?1:0,e=x(c.data[3]+80);(a[e]=a[e]||{})[`${d}:${b.spritePatterns[d].toString(16)}:${b.spritePalettes[d].toString(16)}`]={pal:b.spritePalettes[d],pat:b.spritePatterns[d],slot:d}}return a}get locationMonsters(){const a={};for(const b of this.locations){if(!b.used||!b.hasSpawns)continue;const c=a["$"+x(b.id)]={};for(const a of b.spawns)if(!(a.data[2]&7)){const b=a.data[2]&128?1:0,d=a.data[3]+80;c[`${b}:${d.toString(16)}`]=(c[`${b}:${d.toString(16)}`]||
0)+1}}return a}assembler(){return new Ja}writeData(a){a=void 0===a?this.prg:a;var b,c=this.assembler();fc(c,Th,34682,35165);fc(c,Th,35557,39156);fc(c,Th,40422,40960);fc(c,Uh,40960,41222);fc(c,Uh,41472,41920);fc(c,Vh,37146,37992);const d=[...this.modules.values(),c.module()];c=a=>{for(const b of a)d.push(...b.write())};d.push(...this.locations.write());d.push(...this.objects.write());c(this.hitboxes);c(this.triggers);d.push(...this.npcs.write());c(this.tilesets);c(this.tileEffects);c(this.adHocSpawns);
d.push(...this.itemGets.write());d.push(...this.slots.write());d.push(...this.items.write());d.push(...this.shops.write());c(this.bossKills);c(this.patterns);d.push(...this.wildWarp.write());d.push(...this.townWarp.write());d.push(...this.coinDrops.write());d.push(...this.scaling.write());d.push(...this.bosses.write());d.push(...this.randomNumbers.write());d.push(...this.telepathy.write());d.push(...this.messages.write());d.push(...this.screens.write());c=new Sa;c.base(this.prg,0);for(const a of d)c.read(a);
c.link().apply(a);a===this.prg&&(a=c.exports(),this.uniqueItemTableAddress=a.get("KeyItemData").offset,this.shopCount=11,this.shopDataTablesAddress=(null===(b=a.get("ShopData"))||void 0===b?void 0:b.offset)||0,Wh.SHOP_COUNT.set(this.prg,this.shopCount),Wh.SCALING_LEVELS.set(this.prg,this.scalingLevels),Wh.UNIQUE_ITEM_TABLE.set(this.prg,this.uniqueItemTableAddress),Wh.SHOP_DATA_TABLES.set(this.prg,this.shopDataTablesAddress||0),Wh.OMIT_ITEM_GET_DATA_SUFFIX.set(this.prg,this.omitItemGetDataSuffix),
Wh.OMIT_LOCAL_DIALOG_SUFFIX.set(this.prg,this.omitLocalDialogSuffix),Wh.COMPRESSED_MAPDATA.set(this.prg,this.compressedMapData),Wh.WRITE_MONSTER_NAMES.set(this.prg,this.writeMonsterNames))}analyzeTiles(){}disjointTilesets(){var a=[];for(var b of this.locations)if(b.used){var c=b.tileset;for(const d of b.screens)for(const b of d)(a[b]||(a[b]=new Set)).add(c)}b=w(256,()=>new hd);for(c=0;c<a.length;c++)if(a[c])for(var d of this.screens[c].allTilesSet())b[d].union([...a[c]]);for(a=0;a<b.length;a++)d=
b[a].sets().map(a=>[...a].map(x).join(" ")).join(" | "),console.log(`Tile ${x(a)}: ${d}`)}swapMetatiles(a,...b){var c=new Map,d=w(256);const e=new Map,f=a=>Array.isArray(a)?a[0]:0>a?~a:a;for(var g of b){for(var h=0;h<g.length-1;h++)if(Array.isArray(g[h])){var k=g[h];e.set(k[0],k[1]);g[h]=k[0]}for(h=0;h<g.length-1;h++){k=g[h];const a=g[h+1];0>k||0>a||(c.set(a,k),d[a]=k)}}g=new Set;c=new Set;a=new Set(a);for(var p of this.locations)if(p.used&&a.has(p.tileset)){c.add(p.tileEffects);for(var q of p.allScreens())g.add(q)}for(var t of g)for(let a=
0,b=t.tiles.length;a<b;a++)t.tiles[a]=d[t.tiles[a]];for(var A of a){d=this.tilesets[A];for(var D of b)for(p=0;p<D.length-1;p++){q=f(D[p]);t=f(D[p+1]);for(a=0;4>a;a++)d.tiles[a][q]=d.tiles[a][t];d.attrs[q]=d.attrs[t];if(32>t&&d.alternates[t]!==t){if(32<=q)throw Error(`Cannot unflag: ${A} ${q} ${t} ${d.alternates[t]}`);d.alternates[q]=d.alternates[t]}}for(var z of e){const [a,b]=z;d.alternates[a]=b}}for(const a of c){A=this.tileEffects[a-179];for(const a of b)for(D=0;D<a.length-1;D++)z=f(a[D]),d=f(a[D+
1]),A.effects[z]=A.effects[d];for(const a of e.keys())A.effects[a]|=8}}moveFlag(a,b){function c(c){for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b),c[d]===~a&&(c[d]=~b)}for(const a of this.triggers)c(a.conditions),c(a.flags);for(const d of this.npcs){for(const a of d.spawnConditions.values())c(a);for(const c of[d.globalDialogs,...d.localDialogs.values()])for(const d of c)d.condition===a&&(d.condition=b),d.condition===~a&&(d.condition=~b)}if(512===(a&-256)&&512===(b&-256))for(const c of this.locations)for(const d of c.flags)d.flag===
a&&(d.flag=b)}nextFreeTrigger(a){for(const b of this.triggers)if(!b.used)return a&&this.allocatedTriggers.set(a,b.id),b;throw Error("Could not find an unused trigger.");}moveScreens(a,b){if(!this.compressedMapData)throw Error("Must compress maps first.");const c=new Map;for(var d=b<<8;this.screens[d];)d++;a=new Set(a);for(var e of a)for(var f of e)if(256<=f.sid)c.set(f.sid,f.sid);else{var g=f.sid;if(!c.has(g)){const b=d++;c.set(g,b);c.set(b,b);this.metascreens.renumber(g,b,a)}}if(d>>>8!==b)throw Error(`Out of space on page ${b}`);
d=new Set;for(const h of this.locations)if(a.has(h.meta.tileset)){e=!1;for(const a of h.screens)for(f=0;f<a.length;f++)g=c.get(a[f]),null!=g?(a[f]=g,e=!0):d.add(h.name);if(e&&d.size)throw Error(`Inconsistent move [${[...a].map(a=>a.name).join(", ")}] to plane ${b}: missed ${[...d].join(", ")}`);}}static load(a,b){return l.asyncExecutePromiseGeneratorFunction(function*(){const c=yield Yh(b);a&&(yield a(c));return new Wh(c)})}static loadBytes(){return l.asyncExecutePromiseGeneratorFunction(function*(){return yield Yh()})}}
Wh.OMIT_ITEM_GET_DATA_SUFFIX=jh.bit(82624,0);Wh.OMIT_LOCAL_DIALOG_SUFFIX=jh.bit(82624,1);Wh.COMPRESSED_MAPDATA=jh.bit(82624,2);Wh.WRITE_MONSTER_NAMES=jh.bit(82624,3);Wh.SHOP_COUNT=jh.byte(82625);Wh.SCALING_LEVELS=jh.byte(82626);Wh.UNIQUE_ITEM_TABLE=jh.address(82640);Wh.SHOP_DATA_TABLES=jh.address(82643);Wh.TELEPATHY_TABLES=jh.address(82646);
function Yh(a){a||(a=a=>document.body.appendChild(a));return new Promise(a=>{if("#reset"!==window.location.hash){const b=localStorage.getItem("rom");if(b)return a(Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))))}const b=document.createElement("input");document.body.appendChild(b);b.type="file";b.addEventListener("change",()=>{const c=b.files[0],e=new FileReader;e.addEventListener("loadend",()=>{const c=new Uint8Array(e.result),d=Array.from(c,x).join("");
localStorage.setItem("rom",d);b.remove();a(c)});e.readAsArrayBuffer(c)})})}
const Xh=[[83272,86,80],[83306,0,255],[83343,56,48],[83480,96,112],[83494,168,160],[83507,21,22],[83511,21,22],[84305,168,160],[84307,152,144],[84505,120,112],[84715,9,255],[84809,128,136],[84871,32,48],[84890,1,2],[84894,1,2],[85433,8,128],[85750,104,96],[87133,255,0],[87145,120,112],[88070,152,160],[88074,152,160],[88078,88,80],[88093,0,255],[88142,219,255],[88181,120,112],[88911,120,128],[89007,240,128],[89014,223,128],[89015,150,128],[89315,223,207],[89326,110,109],[89330,110,109],[89486,223,
207],[89489,46,45],[89493,46,45],[89658,216,223],[89913,120,112],[89920,2,255],[89953,141,255],[89957,141,255],[91133,72,64],[91139,85,80],[91227,216,223],[91340,4,32],[91391,11,10],[91661,32,48],[91684,1,2],[91688,1,2],[93616,154,128],[93620,158,128],[93624,145,128],[93628,158,128],[93632,145,128],[93672,0,255],[93677,223,208],[93688,12,92],[93689,176,185],[93690,0,2],[93692,12,92],[93693,176,185],[93694,0,2],[93695,7,255],[93789,2,255],[93802,173,255],[93806,173,255],[94209,2,255],[94254,183,255],
[94258,183,255],[94379,3,255],[94383,2,255],[94387,5,255],[94391,6,255],[94395,0,255],[94404,178,255],[94408,178,255],[94412,177,255],[94416,177,255],[94420,179,255],[94424,179,255],[94428,181,255],[94432,181,255],[94436,181,255],[94440,181,255],[95470,128,136],[96193,136,128],[96197,152,160],[96199,88,80],[96298,16,1],[96343,16,1],[96596,128,120],[96674,128,120],[97162,0,64],[97168,0,64],[97230,0,64],[97236,0,64],[97294,0,64],[97300,0,64],[97358,0,64],[97364,0,64],[106242,64,128],[106243,51,50],
[106976,64,192],[106977,61,52],[118533,71,72],[119569,32,160],[119570,48,0],[118777,96,224],[182928,2,0],[193907,2,0],[195300,95,0]];Symbol("asm");Array.prototype.flatMap||Object.defineProperties(Array.prototype,{flatMap:{value(a){const b=[];let c=0;for(const d of this){let e=a(d,c++);"function"!==typeof e[Symbol.iterator]&&(e=[e]);e=[...e];e.length&&b.push(...e)}return b}}});const Zh=[[/\b(sort)\b/,"sword"],[/\b(sorta)\b/,"sword of"],[/\b(win)\b/,"wind"],[/\bketostix\b/,"key 2 styx"],[/\bketo\b/,"key 2"],[/\b(sticks|stick c|stix e|stick sea|dixie|sticks e|stick see|sexy|60|sixty)\b/,"styx"],[/\b(arraylist|gorilla[sz]|aurelius|h?airless|a realist|arl[eiy]ss?)\b/,"aryllis"],[/\b(amazon us|amazon[ae]?ss?|amazon)\b/,"amazones"],[/\bamazones basement\b/,"aryllis basement"],[/\b(deal|dil|diehl)\b/,"deo"],[/\b(ds|deals|diaz|delos|drose|theos)\b/,"deos"],[/\bone\b/,"1"],[/\b(two|ii|to|too)\b/,
"2"],[/\bthree\b/,"3"],[/\bfour\b/,"4"],[/\bar[ck]s tom\b/,"ark stom"],[/\borbit\b/,"orb of"],[/\borb\n/,"ball"],[/^(contract|amtrack|ontra(c|k|ck))\b/,"untrack"],[/^((ch|tr)[eu](c|k|ck))\b/,"track"],[/^track ?suit\b/,"track flute"],[/\b(floote|food)\b/,"flute"],[/\b(lyme|lion)\b/,"lime"],[/mark(s|ed)\b/,"mark"],[/^(marc|mach|smart|[bp]ark)\b/,"mark"],[/\blee felder\b/,"leaf elder"],[/^markley f/,"mark leaf "],[/^(mark of|market)\b/,"mark"],[/\bleif\b/,"leaf"],[/\beldar\b/,"elder"],[/\blight\b/,"flight"],
[/\bmann\b/,"moon"],[/^trackball\b/,"track bow"],[/\bbosemann?\b/,"bow of moon"],[/\b(bo(we)?)\b/,"bow"],[/\b(certifier|start a fire)\b/,"sword of fire"],[/\bwhen milky\b/,"windmill key"],[/^(4 clear|faux clear|folklore|so ?clear|pho clear)\b/,"full clear"],[/\b(mayo|meto|nato|mader|meadow|matter|ma[dt]er|motto|model)\b/,"mado"],[/\bcalvey\b/,"kelby"],[/\b(kelbyone|lv ?1)\b/,"kelby 1"],[/\blv ?2\b/,"kelby 2"],[/\b(carmine|carmen|combine)\b/,"karmine"],[/\b(dra[gk][ao]n)\b/,"draygon"],[/\b([cs][ae][bdgv][aeiu]*r[ae]|xavier)\b/,
"sabera"],[/\b(wright|rite|write)\b/,"right"],[/\b([ck]or[bd]el[le]?|quadrel)\b/,"cordel"],[/\b(hotel desk|(bel)?l desk|kill basque|kehl basc|caleb ask(ed)?)\b/,"kelby"],[/\b(porter|port[eo]la|porto a)\b/,"portoa"],[/\b(athena|cena|tina|isina|esquina)\b/,"asina"],[/\b((at the|ec[hk]o) h[ao]nn?ah?|alcohol(ic)?)\b/,"akahana"],[/\b((roca|broke[nr]|brokaw|barr?oca) hann?ah?|bro k[ao]h[ao]na|pokehana)\b/,"brokahana"],[/\b(stoned)\b/,"stone"],[/\b(roc[ck]a? ?(honda|ohana|h[oa]nn?ah?|auto))\b/,"stone akahana"],
[/\b(guards)\b/,"guard"],[/\b(window)\b/,"windmill"],[/\b(sa[bv][eo]r)\b/,"sabre"],[/\bsabre south\b/,"sabre west"],[/\b(hebrew|cebu|sebba|zabel)\b/,"zebu"],[/\b([bct]([aou]r|r[aou])nn?ell?)\b/,"tornel"],[/\b(clarke)\b/,"clark"],[/\bsabera 1 left\b/,"sabera fortress left"],[/\bsabera 1 right\b/,"sabera fortress right"],[/\b(cantu|cancel|can sue|kincer|kenzo|cancer)\b/,"kensu"],[/\b(light house)\b/,"lighthouse"],[/\bkensu(?: in)? (lighthouse|swan)\b/,"$1"],[/\b(kensu slime|slime kensu)\b/,"slime"],
[/\bunderground channel\b/,"channel"],[/\b(?:mount|mt) (sabre|hydra)\b/,"$1"],[/\b([ck]h?[au]r[iu]ss?[aou])\b/,"kirisa"],[/\bmado (lower|upper)\b/,"mado 2 $1"],[/\bsabera( 2)? (level|chest|sewer)\b/,"sabera 2 level"],[/\b(script|richt)\b/,"crypt"],[/\bdraygon 1\b/,"draygon"],[/\besi\b/,"evil spirit island"],[/\bsabre north summit\b/,"sabre summit"],[/\bkirisa plant cave\b/,"kirisa cave"],[/\b(windmill|vampire) cave\b/,"sealed cave"],[/^((?:un)?)ma[urxkcs ]*t[io]me?(?: fight)?/,"$1mark stom"],[/\b(bow|flute)\b/,
"$1 of"],[/\bof( of)+\b/,"of"],[/ of$/,""]],$h=new Map([["sealed cave",["sealed cave front","sealed cave back","vampire 1"]],["styx",["styx left","styx right"]],["oak",["oak elder","oak mother"]],["sabre west",["sabre west slope","sabre west","tornel"]],["sabre north",["sabre north","kelby 1","sabre summit"]],["waterfall cave",["waterfall cave","stone akahana"]],["fog lamp",["fog lamp front","fog lamp back"]],["kirisa plant",["kirisa cave","kirisa meadow"]],["karmine",["karmine basement","karmine",
"behind karmine","slime"]],["amazones",["aryllis","aryllis basement"]],["mado 2",["mado 2","mado 2 upper","mado 2 lower"]],["pyramid",["pyramid","draygon"]],["hydra",["hydra front","hydra back","hydra summit"]],["sabera 1",["sabera fortress left","sabera fortress right","vampire 2","sabera 1","clark"]],["oasis cave",["oasis cave","oasis cave flight","oasis cave center"]],["sabera 2",["sabera 2","sabera 2 level"]]]),ai=[[0,121,192,"leaf elder","sword of wind"],[1,274,176,"oak elder","sword of fire"],
[2,335,123,"waterfall cave","sword of water"],[3,77,10,"styx left","sword of thunder"],[5,89,107,"sealed cave front","ball of wind"],[6,115,224,"sabre west slope","tornado bracelet"],[7,282,187,"insect","ball of fire"],[8,47,182,"kelby 1","flame bracelet"],[9,251,232,"rage","ball of water"],[10,206,249,"aryllis basement","blizzard bracelet"],[11,83,63,"mado 1","ball of thunder"],[12,23,9,"behind karmine","storm bracelet"],[18,49,48,"mado 2","sacred shield"],[20,77,2,"styx right","psycho shield"],
[118,70,3,"styx right"],[119,84,3,"styx right"],[27,168,96,"oasis cave flight","battle armor"],[28,199,110,"draygon","psycho armor"],[29,82,95,"sealed cave back"],[30,82,101,"sealed cave back"],[31,346,147,"fog lamp front"],[112,346,153,"fog lamp front"],[113,346,159,"fog lamp front"],[32,126,52,"hydra front"],[33,227,97,"sabera fortress left"],[34,256,73,"evil spirit island"],[35,58,115,"sabera 2"],[36,82,113,"sealed cave front"],[37,189,180,"cordel grass","statue of onyx"],[38,18,172,"kelby 2"],
[39,267,185,"oak mother","insect flute"],[40,275,147,"portoa queen","flute of lime"],[41,147,206,"akahana","gas mask"],[42,172,104,"oasis cave center","power ring"],[43,203,5,"brokahana","warrior ring"],[44,249,69,"evil spirit island","iron necklace"],[45,191,110,"deo","deos pendant"],[46,89,99,"vampire 1","rabbit boots"],[47,164,104,"oasis cave","leather boots"],[48,319,123,"stone akahana","shield ring"],[114,320,130,"waterfall cave"],[50,105,94,"windmill guard","windmill key"],[51,64,198,"sabre north",
"key 2 prison"],[52,83,71,"zebu","key 2 styx"],[53,345,140,"fog lamp back","fog lamp"],[54,301,119,"dolphin","shell flute"],[55,233,118,"clark","eye glasses"],[56,234,88,"sabera 1","broken statue"],[57,295,92,"lighthouse","glowing lamp"],[58,234,49,"altar","statue of gold"],[59,274,117,"channel","love pendant"],[60,338,226,"kirisa meadow","kirisa plant"],[61,23,17,"karmine","ivory statue"],[62,206,241,"aryllis","bow of moon"],[63,101,6,"hydra summit","bow of sun"],[64,207,110,"draygon","bow of truth"],
[65,92,117,"windmill","refresh"],[66,279,126,"sabre summit","paralysis"],[67,202,138,"stom","telepathy"],[68,124,202,"tornel","teleport"],[69,304,128,"asina","recover"],[70,248,35,"whirlpool","barrier"],[71,277,3,"swan","change"],[72,15,25,"slime","flight"],[80,82,107,"sealed cave front"],[82,134,219,"sabre west"],[83,59,219,"sabre north"],[84,52,55,"mado 2 upper"],[85,241,97,"sabera fortress right"],[86,123,23,"hydra front"],[116,115,3,"hydra back"],[87,70,9,"styx left"],[117,84,9,"styx left"],[88,
32,38,"karmine basement"],[121,32,16,"karmine basement"],[122,40,16,"karmine basement"],[123,40,38,"karmine basement"],[90,161,97,"fortress exit"],[16,327,123,"waterfall cave"],[92,256,79,"evil spirit island"],[93,36,139,"sabera 2 level"],[94,14,229,"sabre north"],[95,345,225,"kirisa cave"],[96,18,94,"mado 2 upper"],[97,234,96,"vampire 2"],[98,18,118,"sabera 2 level"],[99,36,54,"mado 2 upper"],[100,175,97,"oasis cave"],[101,139,40,"hydra back"],[102,66,160,"sabera 2 level"],[105,131,201,"sabre west"],
[106,76,226,"sabre west"],[107,18,100,"mado 2 upper"],[108,193,103,"pyramid"],[120,199,103,"crypt"],[109,205,103,"crypt"],[115,256,67,"evil spirit island"],[110,24,38,"karmine basement"],[111,44,97,"mado 2 lower"]],bi=new Set([16,18,35,38,97]),ci=new Set([41,62,68,71,72]);
class di{constructor(a,b,c){this.rom=a;this.world=b;this.flags=c;this.slots=new Map;this.items=new Map;this.slotElts=new Map;this.has=new Set;this.tracks=new Map;this.marks=new Map;this.voice=!1;window.GRAPH=this;this.graph=b.getLocationList();this.grid=document.getElementsByClassName("grid")[0];this.map=document.getElementsByClassName("map")[0];a=new ba(()=>new Set);for(const b of this.graph.requirements){const [c,d]=b;for(const b of d)for(const d of b)a.get(d).add(c)}this.unlocks=new Map([...a].map(a=>
{var [b,c]=a;return[b,[...c]]}));this.grid.addEventListener("click",a=>{let b=a.target;for(;b&&!b.dataset.slot;)b=b.parentElement;b&&(this.toggle(b),a.preventDefault())})}toggle(a,b){const c=Number(a.dataset.slot);b=a.classList.toggle("got",b);a.dataset.item&&(b?this.has.add(c):this.has.delete(c));this.update()}addSlot(a,b,c,...d){const e=document.createElement("div");var f=this.rom.itemGets[a];if((f=f&&this.rom.items[f.itemId])&&f.unique||bi.has(a))e.classList.add("key"),b--,c--;b--;c--;e.dataset.slot=
String(a);e.style.left=b+"px";e.style.top=c+"px";b=document.createElement("div");e.appendChild(b);b.textContent=d[0];this.flags.randomizeTrades()&&ci.has(a)&&e.classList.add("boss");this.slotElts.set(a,e);for(const b of d)a=this.marks.get(b),null==a&&this.marks.set(b,a=[]),a.push(e);this.map.appendChild(e)}addItem(a,b,...c){b=Number.parseInt(b.substring(1),16);const d=document.getElementsByClassName(a)[0],e=document.createElement("div");d.appendChild(e);d.dataset.slot=String(b);d.dataset.item=String(b);
this.tracks.set(a.replace(/-/g," "),d);for(const a of c)this.tracks.set(a.replace(/-/g," "),d)}addExtraFlags(){}update(){for(var a of this.slotElts.values())a.dataset.state=a.classList.contains("got")?"":"blocked";a=this.traverse();for(const b of a)256===(b&-128)&&(a=this.slotElts.get(b&255))&&!a.classList.contains("got")&&(a.dataset.state="available")}traverse(){const a=new Set([...this.has].map(a=>a|512)),b=new Set,c=new Set,d=new Set(this.graph.requirements.keys());for(const f of d)if(d.delete(f),
!b.has(f)){var e=this.graph.requirements.get(f);for(const g of e)if(ei(a,g)){b.add(f);e=[];256===(f&-128)?c.add(f&255):(512===(f&-128)&&e.push(f&255),a.add(f));for(const b of a)for(const a of this.unlocks.get(b)||[]){if(!this.graph.requirements.has(a))throw console.dir(this),Error(`Adding bad node ${a} from unlock ${b}`);d.add(a)}break}}return b}addVoiceRecognition(a){try{const b=this.recognition=new SpeechRecognition,c=new SpeechGrammarList;c.addFromString(`
          #JSGF V1.0;
          grammar command;
          public <item> = ${[...this.tracks.keys()].join(" | ")};
          public <check> = ${[...this.marks.keys()].join(" | ")};
          public <clear> = <check> | ${[...$h.keys()].join(" | ")};
          public <command> = track <item> | untrack <item> | mark <check> | unmark <check> | clear <clear> | stop listening;
      `,1);b.lang="en-US";b.grammars=c;b.interimResults=!1;b.maxAlternatives=10;b.onstart=()=>{this.voice=!0};b.onresult=c=>{const d=new Set;var f=c.results[c.results.length-1];if(f.isFinal){c=!1;for(var g of f){let b=g.transcript.toLowerCase().replace(/[^a-z ]/g,"");d.add(b);"stop listening"===b&&(c=!0,this.voice=!1,a());for(const a of Zh){const [c,e]=a;b=b.replace(c,e);d.add(b)}if(f=/^(track|untrack|clear|unclear|full clear) (.*)/.exec(b)){if(f[1].endsWith("track")){var h=this.tracks.get(f[2]);
if(!h)continue;this.toggle(h,!f[1].startsWith("un"))}else if(f[1].endsWith("clear")){h=$h.get(f[2]);if(!h){if(!this.marks.has(f[2]))continue;h=[f[2]]}for(const a of h)for(const b of this.marks.get(a))b.classList.toggle("got",!f[1].startsWith("un"))}c=!0;break}if(f=/^(?:un)?mark(?: (\d+)(?: che(?:st|ck)s?)?(?: in))? (.*)/.exec(b))if(h=this.marks.get(f[2]),f=Number(f[1]||"1"),h&&f){g=!b.startsWith("un");for(const a of h)if(a.classList.contains("got")!==g&&(a.classList.toggle("got",g),0===--f))break;
c=!0;break}}c||console.log(`No match: ${[...d].join(", ")}`);b.stop()}};b.onend=()=>{this.voice&&b.start()};return!0}catch(b){return console.error(b),!1}}startVoice(a){if(!this.recognition&&!this.addVoiceRecognition(a))return!1;this.voice=!0;this.recognition.start();return!0}stopVoice(){this.voice=!1;this.recognition&&this.recognition.stop()}}function fi(...a){const b=window;for(let c of a)if("function"===typeof b[c]){b[a[0]]=b[c];return}console.error(`Could not polyfill ${a[0]}`)}
fi("SpeechRecognition","webkitSpeechRecognition");fi("SpeechGrammarList","webkitSpeechGrammarList");function ei(a,b){for(const c of b)if(!a.has(c))return!1;return!0}let gi="@Casual";for(const a of location.hash.substring(1).split("&")){const [b,c]=a.split("=");"flags"===b&&(gi=decodeURIComponent(c))}
l.asyncExecutePromiseGeneratorFunction(function*(){const a=yield Wh.load(ef);a.flags.defrag();a.itemGets.actionGrants=new Map([[37,41],[57,58],[59,71],[60,62],[132,70],[178,66],[180,65]]);const b=new qb(gi);ff(a,b);const c=new Sd(a,b,!0),d=new di(a,c,b);for(let a of";sword-of-wind $00;sword-of-fire $01;sword-of-water $02;sword-of-thunder $03;windmill-key $32;statue-of-onyx $25 onyx-statue;insect-flute $27;key-to-prison $33 prison-key key-2-prison;flute-of-lime $28;;ball-of-wind $05 ball-of-wind;ball-of-fire $07 ball-of-fire;ball-of-water $09 ball-of-water;ball-of-thunder $0b ball-of-thunder;kirisa-plant $3c;alarm-flute $31;fog-lamp $35;shell-flute $36;broken-statue $38;eye-glasses $37 eyeglasses;glowing-lamp $39;;tornado-bracelet $06;flame-bracelet $08;blizzard-bracelet $0a;storm-bracelet $0c;love-pendant $3b;key-to-styx $34 key-2-styx;statue-of-gold $3a gold-statue;sacred-shield $12;ivory-statue $3d;;rabbit-boots $2e;gas-mask $29 hazard-suit hazmat-suit;shield-ring $30;iron-necklace $2c;leather-boots $2f speed-boots;power-ring $2a;warrior-ring $2b;deos-pendant $2d deo;bow-of-moon $3e moon;bow-of-sun $3f sun;;refresh $41;paralysis $42;telepathy $43;teleport $44;recover $45;barrier $46;change $47;flight $48;psycho-armor $1c;bow-of-truth $40 truth;".split(";"))(a=
a.replace(/#.*/,"").trim())&&d.addItem(...a.split(/ +/g));for(const a of ai)d.addSlot(...a);d.addExtraFlags();d.update();document.getElementById("toggle-map").addEventListener("click",()=>{d.map.classList.toggle("hidden")});document.getElementById("clear-all").addEventListener("click",()=>{for(const a of d.grid.querySelectorAll(".got"))a.classList.remove("got");d.has=new Set;d.update()});const e=document.getElementById("voice");e.addEventListener("click",()=>{d.voice?(d.stopVoice(),e.textContent=
"enable voice"):d.startVoice(()=>e.textContent="enable voice")?e.textContent="disable voice":e.textContent="voice recognition failed"});window.graph=d});}).call(this);
