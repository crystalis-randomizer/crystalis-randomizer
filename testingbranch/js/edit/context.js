import { Graphics } from './graphics.js';
export class Context {
    constructor(rom) {
        this.rom = rom;
        this.data = {
            location: undefined,
            tileset: 0x80,
            patterns: [0, 0, 0, 0, 0, 0],
            palettes: [0, 0, 0, 0x7f, 0, 0, 0, 0],
            flag: false,
        };
        this.listeners = new Set();
        this.graphics = new Graphics(rom);
    }
    set location(x) {
        const update = { graphics: true, location: true };
        this.data.location = x;
        const l = x && this.rom.locations[x];
        if (l && l.used) {
            Object.assign(update, { tileset: true, patterns: true, palettes: true,
                tilePattern: true, tilePalette: true,
                spritePattern: true, spritePalette: true });
            this.data.tileset = l.tileset;
            this.data.patterns.splice(0, 2, ...l.tilePatterns);
            this.data.palettes.splice(0, 3, ...l.tilePalettes);
            this.data.patterns.splice(4, 2, ...l.spritePatterns);
            this.data.palettes.splice(6, 2, ...l.spritePalettes);
        }
        this.update(update);
    }
    get location() { return this.data.location; }
    set tileset(x) {
        if ((x & 3) !== 0 || x < 0x80 || x >= 0xaf)
            return;
        this.data.tileset = x;
        this.update({ graphics: true, tileset: true });
    }
    get tileset() { return this.data.tileset; }
    set tilePatterns(x) {
        if (x.length !== 2)
            throw new Error(`invalid tilePatterns: ${x.join(',')}`);
        this.data.patterns.splice(0, 2, ...x);
        this.update({ graphics: true, patterns: true, tilePattern: true });
    }
    get tilePatterns() { return this.data.patterns.slice(0, 2); }
    set tilePalettes(x) {
        if (x.length !== 3)
            throw new Error(`invalid tilePalettes: ${x.join(',')}`);
        this.data.palettes.splice(0, 3, ...x);
        this.update({ graphics: true, palettes: true, tilePalette: true });
    }
    get tilePalettes() { return this.data.palettes.slice(0, 3); }
    set flag(x) {
        this.data.flag = x;
        this.update({ graphics: true, flag: true });
    }
    get flag() {
        return this.data.flag;
    }
    setPattern(id, value) {
        this.data.patterns[id] = value;
        const update = { graphics: true, patterns: true };
        if (id < 2)
            update.tilePattern = true;
        else
            update.spritePattern = true;
        this.update(update);
    }
    setPalette(id, value) {
        this.data.palettes[id] = value;
        const update = { graphics: true, palettes: true };
        if (id < 4)
            update.tilePalette = true;
        else
            update.spritePalette = true;
        this.update(update);
    }
    update(update) {
        for (const listener of this.listeners) {
            listener(update);
        }
    }
    updates() {
        const updates = [];
        const resolvers = [];
        const listener = (update) => {
            if (resolvers.length) {
                resolvers.shift()({ value: update, done: false });
            }
            else {
                updates.push(update);
            }
        };
        this.listeners.add(listener);
        const next = () => {
            if (updates.length) {
                return Promise.resolve({ value: updates.shift(), done: false });
            }
            return new Promise(resolve => resolvers.push(resolve));
        };
        const cleanup = (result) => {
            this.listeners.delete(listener);
            return result;
        };
        const iter = {
            next,
            return: (result) => cleanup(Promise.resolve({ done: true, value: result })),
            throw: (ex) => cleanup(Promise.reject(ex)),
            [Symbol.asyncIterator]: () => iter,
        };
        return iter;
    }
    static pattern(id) {
        return {
            get(context) { return context.data.patterns[id]; },
            set(context, value) { context.setPattern(id, value); },
        };
    }
    static palette(id) {
        return {
            get(context) { return context.data.palettes[id]; },
            set(context, value) { context.setPalette(id, value); },
        };
    }
}
Context.LOCATION = {
    get(context) { return context.location; },
    set(context, value) { context.location = value; },
};
Context.TILESET = {
    get(context) { return context.tileset; },
    set(context, value) { context.tileset = value; },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9lZGl0L2NvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQTBCdkMsTUFBTSxPQUFPLE9BQU87SUFpQmxCLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBVlosU0FBSSxHQUFTO1lBQzVCLFFBQVEsRUFBRSxTQUFTO1lBQ25CLE9BQU8sRUFBRSxJQUFJO1lBQ2IsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFNUIsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNyQyxJQUFJLEVBQUUsS0FBSztTQUNaLENBQUM7UUFDZSxjQUFTLEdBQWtDLElBQUksR0FBRyxFQUFFLENBQUM7UUFHcEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsSUFBSSxRQUFRLENBQUMsQ0FBbUI7UUFDOUIsTUFBTSxNQUFNLEdBQVcsRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDdkIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDZixNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFDLE9BQU8s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LE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3pDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxJQUFJLE9BQU8sQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztDQUNsRCxDQUFBO0FBQ2UsZUFBTyxHQUFtQjtJQUN4QyxHQUFHLENBQUMsT0FBTyxJQUFJLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDeEMsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLElBQUksT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO0NBQ2pELENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7R3JhcGhpY3N9IGZyb20gJy4vZ3JhcGhpY3MuanMnO1xuXG5pbnRlcmZhY2UgRGF0YSB7XG4gIGxvY2F0aW9uPzogbnVtYmVyO1xuICB0aWxlc2V0OiBudW1iZXI7XG4gIHBhdHRlcm5zOiBudW1iZXJbXTtcbiAgcGFsZXR0ZXM6IG51bWJlcltdO1xuICBmbGFnOiBib29sZWFuO1xuICAvLyBUT0RPIC0gY3VycmVudCBvYmplY3Q/ICBvdGhlciBzdHVmZj9cbn1cblxuaW50ZXJmYWNlIFVwZGF0ZSB7XG4gIGdyYXBoaWNzPzogYm9vbGVhbjtcbiAgbG9jYXRpb24/OiBib29sZWFuO1xuICB0aWxlc2V0PzogYm9vbGVhbjtcbiAgcGF0dGVybnM/OiBib29sZWFuO1xuICBwYWxldHRlcz86IGJvb2xlYW47XG4gIHRpbGVQYXR0ZXJuPzogYm9vbGVhbjtcbiAgdGlsZVBhbGV0dGU/OiBib29sZWFuO1xuICBzcHJpdGVQYXR0ZXJuPzogYm9vbGVhbjtcbiAgc3ByaXRlUGFsZXR0ZT86IGJvb2xlYW47XG4gIGZsYWc/OiBib29sZWFuO1xuICAvLyBUT0RPIC0gZHJhZy9kcm9wPyAgbWFwIHVwZGF0ZXM/ICBldGNcbn1cblxuLyoqIEdsb2JhbCBjb250ZXh0IGZvciB0aGUgZWRpdG9yIHN0YXRlLiAqL1xuZXhwb3J0IGNsYXNzIENvbnRleHQge1xuXG4gIHJlYWRvbmx5IGdyYXBoaWNzOiBHcmFwaGljcztcblxuICAvLyBUT0RPIC0gdXBkYXRlIGFib3V0IHRoaXM/XG4gIHNlbGVjdGlvbjogYW55O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZGF0YTogRGF0YSA9IHtcbiAgICBsb2NhdGlvbjogdW5kZWZpbmVkLFxuICAgIHRpbGVzZXQ6IDB4ODAsXG4gICAgcGF0dGVybnM6IFswLCAwLCAwLCAwLCAwLCAwXSxcbiAgICAvLyBUT0RPIC0gcGVybWFuZW50IHB1cnBsZSBwYWxldHRlLCBzd29yZCBwYWxldHRlXG4gICAgcGFsZXR0ZXM6IFswLCAwLCAwLCAweDdmLCAwLCAwLCAwLCAwXSxcbiAgICBmbGFnOiBmYWxzZSxcbiAgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBsaXN0ZW5lcnM6IFNldDwodXBkYXRlOiBVcGRhdGUpID0+IHZvaWQ+ID0gbmV3IFNldCgpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgdGhpcy5ncmFwaGljcyA9IG5ldyBHcmFwaGljcyhyb20pO1xuICB9XG5cbiAgc2V0IGxvY2F0aW9uKHg6IG51bWJlcnx1bmRlZmluZWQpIHtcbiAgICBjb25zdCB1cGRhdGU6IFVwZGF0ZSA9IHtncmFwaGljczogdHJ1ZSwgbG9jYXRpb246IHRydWV9O1xuICAgIHRoaXMuZGF0YS5sb2NhdGlvbiA9IHg7XG4gICAgY29uc3QgbCA9IHggJiYgdGhpcy5yb20ubG9jYXRpb25zW3hdO1xuICAgIGlmIChsICYmIGwudXNlZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbih1cGRhdGUsIHt0aWxlc2V0OiB0cnVlLCBwYXR0ZXJuczogdHJ1ZSwgcGFsZXR0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVQYXR0ZXJuOiB0cnVlLCB0aWxlUGFsZXR0ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlUGF0dGVybjogdHJ1ZSwgc3ByaXRlUGFsZXR0ZTogdHJ1ZX0pO1xuICAgICAgdGhpcy5kYXRhLnRpbGVzZXQgPSBsLnRpbGVzZXQ7XG4gICAgICB0aGlzLmRhdGEucGF0dGVybnMuc3BsaWNlKDAsIDIsIC4uLmwudGlsZVBhdHRlcm5zKTtcbiAgICAgIHRoaXMuZGF0YS5wYWxldHRlcy5zcGxpY2UoMCwgMywgLi4ubC50aWxlUGFsZXR0ZXMpO1xuICAgICAgdGhpcy5kYXRhLnBhdHRlcm5zLnNwbGljZSg0LCAyLCAuLi5sLnNwcml0ZVBhdHRlcm5zKTtcbiAgICAgIHRoaXMuZGF0YS5wYWxldHRlcy5zcGxpY2UoNiwgMiwgLi4ubC5zcHJpdGVQYWxldHRlcyk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlKHVwZGF0ZSk7XG4gIH1cblxuICBnZXQgbG9jYXRpb24oKTogbnVtYmVyfHVuZGVmaW5lZCB7IHJldHVybiB0aGlzLmRhdGEubG9jYXRpb247IH1cblxuICBzZXQgdGlsZXNldCh4OiBudW1iZXIpIHtcbiAgICBpZiAoKHggJiAzKSAhPT0gMCB8fCB4IDwgMHg4MCB8fCB4ID49IDB4YWYpIHJldHVybjtcbiAgICB0aGlzLmRhdGEudGlsZXNldCA9IHg7XG4gICAgdGhpcy51cGRhdGUoe2dyYXBoaWNzOiB0cnVlLCB0aWxlc2V0OiB0cnVlfSk7XG4gIH1cbiAgZ2V0IHRpbGVzZXQoKTogbnVtYmVyIHsgcmV0dXJuIHRoaXMuZGF0YS50aWxlc2V0OyB9XG5cbiAgc2V0IHRpbGVQYXR0ZXJucyh4OiBbbnVtYmVyLCBudW1iZXJdKSB7XG4gICAgaWYgKHgubGVuZ3RoICE9PSAyKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgdGlsZVBhdHRlcm5zOiAke3guam9pbignLCcpfWApO1xuICAgIHRoaXMuZGF0YS5wYXR0ZXJucy5zcGxpY2UoMCwgMiwgLi4ueCk7XG4gICAgdGhpcy51cGRhdGUoe2dyYXBoaWNzOiB0cnVlLCBwYXR0ZXJuczogdHJ1ZSwgdGlsZVBhdHRlcm46IHRydWV9KTtcbiAgfVxuICBnZXQgdGlsZVBhdHRlcm5zKCk6IFtudW1iZXIsIG51bWJlcl0geyByZXR1cm4gdGhpcy5kYXRhLnBhdHRlcm5zLnNsaWNlKDAsIDIpIGFzIGFueTsgfVxuXG4gIHNldCB0aWxlUGFsZXR0ZXMoeDogW251bWJlciwgbnVtYmVyLCBudW1iZXJdKSB7XG4gICAgaWYgKHgubGVuZ3RoICE9PSAzKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgdGlsZVBhbGV0dGVzOiAke3guam9pbignLCcpfWApO1xuICAgIHRoaXMuZGF0YS5wYWxldHRlcy5zcGxpY2UoMCwgMywgLi4ueCk7XG4gICAgdGhpcy51cGRhdGUoe2dyYXBoaWNzOiB0cnVlLCBwYWxldHRlczogdHJ1ZSwgdGlsZVBhbGV0dGU6IHRydWV9KTtcbiAgfVxuICBnZXQgdGlsZVBhbGV0dGVzKCk6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSB7IHJldHVybiB0aGlzLmRhdGEucGFsZXR0ZXMuc2xpY2UoMCwgMykgYXMgYW55OyB9XG5cbiAgc2V0IGZsYWcoeDogYm9vbGVhbikge1xuICAgIHRoaXMuZGF0YS5mbGFnID0geDtcbiAgICB0aGlzLnVwZGF0ZSh7Z3JhcGhpY3M6IHRydWUsIGZsYWc6IHRydWV9KTtcbiAgfVxuICBnZXQgZmxhZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmZsYWc7XG4gIH1cblxuICAvLyBUT0RPIC0gc3ByaXRlIHNldHRlcnMvZ2V0dGVyc1xuXG4gIHNldFBhdHRlcm4oaWQ6IG51bWJlciwgdmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuZGF0YS5wYXR0ZXJuc1tpZF0gPSB2YWx1ZTtcbiAgICBjb25zdCB1cGRhdGU6IFVwZGF0ZSA9IHtncmFwaGljczogdHJ1ZSwgcGF0dGVybnM6IHRydWV9O1xuICAgIGlmIChpZCA8IDIpIHVwZGF0ZS50aWxlUGF0dGVybiA9IHRydWU7XG4gICAgZWxzZSB1cGRhdGUuc3ByaXRlUGF0dGVybiA9IHRydWU7XG4gICAgdGhpcy51cGRhdGUodXBkYXRlKTtcbiAgfVxuXG4gIHNldFBhbGV0dGUoaWQ6IG51bWJlciwgdmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuZGF0YS5wYWxldHRlc1tpZF0gPSB2YWx1ZTtcbiAgICBjb25zdCB1cGRhdGU6IFVwZGF0ZSA9IHtncmFwaGljczogdHJ1ZSwgcGFsZXR0ZXM6IHRydWV9O1xuICAgIGlmIChpZCA8IDQpIHVwZGF0ZS50aWxlUGFsZXR0ZSA9IHRydWU7XG4gICAgZWxzZSB1cGRhdGUuc3ByaXRlUGFsZXR0ZSA9IHRydWU7XG4gICAgdGhpcy51cGRhdGUodXBkYXRlKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKHVwZGF0ZTogVXBkYXRlKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLmxpc3RlbmVycykge1xuICAgICAgbGlzdGVuZXIodXBkYXRlKTtcbiAgICB9XG4gIH1cblxuICAvKiogQXN5bmMgZ2VuZXJhdG9yIGZvciB1cGRhdGVzLiAqL1xuICB1cGRhdGVzKCk6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxVcGRhdGU+IHtcbiAgICBjb25zdCB1cGRhdGVzOiBVcGRhdGVbXSA9IFtdO1xuICAgIGNvbnN0IHJlc29sdmVyczogQXJyYXk8KHJlc3VsdDogSXRlcmF0b3JSZXN1bHQ8VXBkYXRlPikgPT4gdm9pZD4gPSBbXTtcbiAgICBjb25zdCBsaXN0ZW5lciA9ICh1cGRhdGU6IFVwZGF0ZSkgPT4ge1xuICAgICAgaWYgKHJlc29sdmVycy5sZW5ndGgpIHtcbiAgICAgICAgcmVzb2x2ZXJzLnNoaWZ0KCkhKHt2YWx1ZTogdXBkYXRlLCBkb25lOiBmYWxzZX0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdXBkYXRlcy5wdXNoKHVwZGF0ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMubGlzdGVuZXJzLmFkZChsaXN0ZW5lcik7XG4gICAgY29uc3QgbmV4dCA9ICgpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFVwZGF0ZT4+ID0+IHtcbiAgICAgIGlmICh1cGRhdGVzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt2YWx1ZTogdXBkYXRlcy5zaGlmdCgpISwgZG9uZTogZmFsc2V9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlc29sdmVycy5wdXNoKHJlc29sdmUpKTtcbiAgICB9O1xuICAgIGNvbnN0IGNsZWFudXAgPSA8Uj4ocmVzdWx0OiBSKSA9PiB7XG4gICAgICB0aGlzLmxpc3RlbmVycy5kZWxldGUobGlzdGVuZXIpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgY29uc3QgaXRlciA9IHtcbiAgICAgIG5leHQsXG4gICAgICByZXR1cm46IChyZXN1bHQ6IGFueSkgPT4gY2xlYW51cChQcm9taXNlLnJlc29sdmUoe2RvbmU6IHRydWUsIHZhbHVlOiByZXN1bHR9KSksXG4gICAgICB0aHJvdzogKGV4OiBhbnkpID0+IGNsZWFudXAoUHJvbWlzZS5yZWplY3QoZXgpKSxcbiAgICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl06ICgpID0+IGl0ZXIsXG4gICAgfVxuICAgIHJldHVybiBpdGVyO1xuICB9XG5cbiAgc3RhdGljIHJlYWRvbmx5IExPQ0FUSU9OOiBHZXRTZXQ8bnVtYmVyfHVuZGVmaW5lZD4gPSB7XG4gICAgZ2V0KGNvbnRleHQpIHsgcmV0dXJuIGNvbnRleHQubG9jYXRpb247IH0sXG4gICAgc2V0KGNvbnRleHQsIHZhbHVlKSB7IGNvbnRleHQubG9jYXRpb24gPSB2YWx1ZTsgfSxcbiAgfVxuICBzdGF0aWMgcmVhZG9ubHkgVElMRVNFVDogR2V0U2V0PG51bWJlcj4gPSB7XG4gICAgZ2V0KGNvbnRleHQpIHsgcmV0dXJuIGNvbnRleHQudGlsZXNldDsgfSxcbiAgICBzZXQoY29udGV4dCwgdmFsdWUpIHsgY29udGV4dC50aWxlc2V0ID0gdmFsdWU7IH0sXG4gIH1cbiAgc3RhdGljIHBhdHRlcm4oaWQ6IG51bWJlcik6IEdldFNldDxudW1iZXI+IHtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0KGNvbnRleHQpIHsgcmV0dXJuIGNvbnRleHQuZGF0YS5wYXR0ZXJuc1tpZF07IH0sXG4gICAgICBzZXQoY29udGV4dCwgdmFsdWUpIHsgY29udGV4dC5zZXRQYXR0ZXJuKGlkLCB2YWx1ZSk7IH0sXG4gICAgfTtcbiAgfVxuICBzdGF0aWMgcGFsZXR0ZShpZDogbnVtYmVyKTogR2V0U2V0PG51bWJlcj4ge1xuICAgIHJldHVybiB7XG4gICAgICBnZXQoY29udGV4dCkgeyByZXR1cm4gY29udGV4dC5kYXRhLnBhbGV0dGVzW2lkXTsgfSxcbiAgICAgIHNldChjb250ZXh0LCB2YWx1ZSkgeyBjb250ZXh0LnNldFBhbGV0dGUoaWQsIHZhbHVlKTsgfSxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2V0U2V0PFQ+IHtcbiAgZ2V0KGNvbnRleHQ6IENvbnRleHQpOiBUO1xuICBzZXQoY29udGV4dDogQ29udGV4dCwgdmFsdWU6IFQpOiB2b2lkO1xufVxuIl19