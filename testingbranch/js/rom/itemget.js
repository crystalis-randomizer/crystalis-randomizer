import { Entity, EntityArray } from './entity.js';
import { MessageId } from './messageid.js';
import { ITEM_GET_FLAGS, Address, Segment, hex, readLittleEndian, relocExportLabel } from './util.js';
const { $0e, $0f, $14, $fe, $ff } = Segment;
const ITEMGET_TABLE = Address.of($0e, 0x9b00);
const GET_TO_ITEM_BASE = Address.of($0e, 0x9d66);
const GET_TO_ITEM_THRESHOLD = 0x49;
export class ItemGets extends EntityArray {
    constructor(rom) {
        super(0x71);
        this.rom = rom;
        this.actionGrants = new Map();
        for (let i = 0; i < 0x71; i++) {
            this[i] = new ItemGet(rom, i);
        }
        this.actionGrants.set(0x25, 0x29);
        this.actionGrants.set(0x39, 0x3a);
        this.actionGrants.set(0x3b, 0x47);
        this.actionGrants.set(0x3c, 0x3e);
        this.actionGrants.set(0x84, 0x46);
        this.actionGrants.set(0xb2, 0x42);
        this.actionGrants.set(0xb4, 0x41);
    }
    write() {
        const a = this.rom.assembler();
        for (const itemget of this) {
            itemget.assemble(a);
        }
        relocExportLabel(a, [$14, $fe, $ff], 'GrantItemTable');
        for (const [key, value] of this.actionGrants) {
            a.byte(key, value);
        }
        return [a.module()];
    }
}
export class ItemGet extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this._itemId = this.itemPointer.read(rom.prg);
        const tableBase = this.tablePointer.readAddress(rom.prg, $0e, $0f);
        let a = tableBase.offset;
        this.inventoryRowStart = rom.prg[a++];
        this.inventoryRowLength = rom.prg[a++];
        this.acquisitionAction = MessageId.from(rom.prg, a);
        this.flags = ITEM_GET_FLAGS.read(rom.prg, a + 2);
        this.key = rom.prg[a + 2 + 2 * this.flags.length + 1] === 0xfe;
        if (id !== 0 && tableBase.org === readLittleEndian(rom.prg, 0x1dd66)) {
            this.key = false;
            this.flags = [];
        }
    }
    get itemPointer() {
        return GET_TO_ITEM_BASE.plus(this.id);
    }
    get tablePointer() {
        return ITEMGET_TABLE.plus(this.id << 1);
    }
    get itemId() { return this._itemId; }
    set itemId(itemId) {
        if (this.id < GET_TO_ITEM_THRESHOLD)
            throw new Error(`${this.id}`);
        this._itemId = itemId;
    }
    isLosable() {
        return LOSABLE_ROWS.has(this.inventoryRowStart);
    }
    copyFrom(that) {
        this.inventoryRowStart = that.inventoryRowStart;
        this.inventoryRowLength = that.inventoryRowLength;
        this.acquisitionAction = that.acquisitionAction;
        this.flags = [...that.flags];
        this.key = that.key;
    }
    assemble(a) {
        this.itemPointer.loc(a);
        a.byte(this.itemId);
        const table = [
            this.inventoryRowStart, this.inventoryRowLength,
            ...this.acquisitionAction.data,
            ...ITEM_GET_FLAGS.bytes(this.flags),
            this.key ? 0xfe : 0xff,
        ];
        a.segment($0e.name, $0f.name);
        a.reloc(`ItemGetData ${hex(this.id)}`);
        const tableAddr = a.pc();
        a.byte(...table);
        this.tablePointer.loc(a);
        a.word(tableAddr);
    }
}
const LOSABLE_ROWS = new Set([4, 8, 16]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbWdldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vaXRlbWdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUN0QyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFNUQsTUFBTSxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7QUFHMUMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRCxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQztBQWFuQyxNQUFNLE9BQU8sUUFBUyxTQUFRLFdBQW9CO0lBSWhELFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRE8sUUFBRyxHQUFILEdBQUcsQ0FBSztRQUY3QixpQkFBWSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBSXZDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMvQjtRQU9ELElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMs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QUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJO1lBQzlCLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtTQUN2QixDQUFDO1FBQ0YsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7Q0FDRjtBQUVELE1BQU0sWUFBWSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBc3NlbWJsZXJ9IGZyb20gJy4uL2FzbS9hc3NlbWJsZXIuanMnO1xuaW1wb3J0IHtNb2R1bGV9IGZyb20gJy4uL2FzbS9tb2R1bGUuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0VudGl0eSwgRW50aXR5QXJyYXl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7TWVzc2FnZUlkfSBmcm9tICcuL21lc3NhZ2VpZC5qcyc7XG5pbXBvcnQge0lURU1fR0VUX0ZMQUdTLCBBZGRyZXNzLCBTZWdtZW50LFxuICBoZXgsIHJlYWRMaXR0bGVFbmRpYW4sIHJlbG9jRXhwb3J0TGFiZWx9IGZyb20gJy4vdXRpbC5qcyc7XG5cbmNvbnN0IHskMGUsICQwZiwgJDE0LCAkZmUsICRmZn0gPSBTZWdtZW50O1xuXG4vLyBUT0RPIC0gdGhpcyBkZXBlbmRzIG9uIGEgcHJlcGFyc2UgY2hhbmdlLCB3ZSBzaG91bGQgcmVjb25zaWRlciB0aGF0LlxuY29uc3QgSVRFTUdFVF9UQUJMRSA9IEFkZHJlc3Mub2YoJDBlLCAweDliMDApO1xuLy9jb25zdCBHUkFOVF9JVEVNX1RBQkxFID0gQWRkcmVzcy5vZigkZmUsIDB4ZDZkNSk7XG5jb25zdCBHRVRfVE9fSVRFTV9CQVNFID0gQWRkcmVzcy5vZigkMGUsIDB4OWQ2Nik7XG5jb25zdCBHRVRfVE9fSVRFTV9USFJFU0hPTEQgPSAweDQ5O1xuXG4vKipcbiAqIEFycmF5IG9mIEl0ZW1HZXREYXRhIHRhYmxlIGVudHJpZXMsIHRvZ2V0aGVyIHdpdGggdGhlIG1hcCBvZlxuICogdHJpZ2dlci9pdGVtdXNlIGdyYW50cyAoYWRkZWQgZm9yIHN0YXR1ZSBvZiBnb2xkIHNodWZmbGUpLFxuICogZm9yIHByb2dyYW1tYXRpYyBhY2Nlc3MuXG4gKlxuICogSXRlbUdldCBob2xkcyBvbnRvIGEgdGFibGUgbWFwcGluZyBcImdldCBJRHNcIiBhYm92ZSA1MCB0b1xuICogYWN0dWFsIGl0ZW1zLCBidXQgdGhlIG1hcHBpbmcgYmVsb3cgNDggaXMgMToxLCBzbyB0aGVyZSBpc1xuICogbm8gc2h1ZmZsaW5nIGhhcHBlbmluZyBoZXJlLiAgVGhlIHNsb3QgbWFwcGluZyBoYXBwZW5zXG4gKiBCRUZPUkUgdGhlbSBJdGVtR2V0IHRyYW5zbGF0aW9uLiAgVGh1cywgdGhlIElEIG9mIHRoaXNcbiAqIGVudGl0eSBpcyBub3QgcmVsYXRlZCB0byB0aGUgXCIxeHhcIiBmbGFnIHRoYXQgaXMgc2V0LlxuICovXG5leHBvcnQgY2xhc3MgSXRlbUdldHMgZXh0ZW5kcyBFbnRpdHlBcnJheTxJdGVtR2V0PiB7XG5cbiAgYWN0aW9uR3JhbnRzID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuICAgIHN1cGVyKDB4NzEpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMHg3MTsgaSsrKSB7XG4gICAgICB0aGlzW2ldID0gbmV3IEl0ZW1HZXQocm9tLCBpKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPIC0gZW5jb2RlIEdSQU5UX0lURU1fVEFCTEUgb2Zmc2V0IGludG8gcm9tXG4gICAgLy8gc2luY2UgaXQncyByZWFsbHkgaGFyZCB0byByZWFkIG90aGVyd2lzZS5cblxuICAgIC8vIFByb2JhYmx5IHRoZSB0aGluZyB0byBkbyBpZiB0aGUgdGFibGUgZG9lc24ndCBleGlzdCBpcyB0b1xuICAgIC8vIHJlYWQgdGhlc2UgdmFsdWVzIGZyb20gdGhlaXIgdmFuaWxsYSBsb2NpP1xuICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldCgweDI1LCAweDI5KTtcbiAgICB0aGlzLmFjdGlvbkdyYW50cy5zZXQoMHgzOSwgMHgzYSk7XG4gICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KDB4M2IsIDB4NDcpO1xuICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldCgweDNjLCAweDNlKTtcbiAgICB0aGlzLmFjdGlvbkdyYW50cy5zZXQoMHg4NCwgMHg0Nik7XG4gICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KDB4YjIsIDB4NDIpO1xuICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldCgweGI0LCAweDQxKTtcblxuICAgIC8vIGxldCBhZGRyID0gR1JBTlRfSVRFTV9UQUJMRS5vZmZzZXQ7XG4gICAgLy8gd2hpbGUgKHJvbS5wcmdbYWRkcl0gIT09IDB4ZmYpIHtcbiAgICAvLyAgIGNvbnN0IGtleSA9IHJvbS5wcmdbYWRkcisrXTtcbiAgICAvLyAgIGNvbnN0IHZhbHVlID0gcm9tLnByZ1thZGRyKytdO1xuICAgIC8vICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KGtleSwgdmFsdWUpO1xuICAgIC8vIH1cbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBjb25zdCBhID0gdGhpcy5yb20uYXNzZW1ibGVyKCk7XG4gICAgZm9yIChjb25zdCBpdGVtZ2V0IG9mIHRoaXMpIHtcbiAgICAgIGl0ZW1nZXQuYXNzZW1ibGUoYSk7XG4gICAgfVxuICAgIHJlbG9jRXhwb3J0TGFiZWwoYSwgWyQxNCwgJGZlLCAkZmZdLCAnR3JhbnRJdGVtVGFibGUnKTtcbiAgICAvL0dSQU5UX0lURU1fVEFCTEUubG9jKGEpO1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRoaXMuYWN0aW9uR3JhbnRzKSB7XG4gICAgICBhLmJ5dGUoa2V5LCB2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiBbYS5tb2R1bGUoKV07XG4gIH1cbn1cblxuLy8gQSBnZXR0YWJsZSBpdGVtIHNsb3QvY2hlY2suICBFYWNoIEl0ZW1HZXQgbWFwcyB0byBhIHNpbmdsZSBpdGVtLFxuLy8gYnV0IG5vbi11bmlxdWUgaXRlbXMgbWF5IG1hcCB0byBtdWx0aXBsZSBJdGVtR2V0cy5cbmV4cG9ydCBjbGFzcyBJdGVtR2V0IGV4dGVuZHMgRW50aXR5IHtcblxuICBwcml2YXRlIF9pdGVtSWQ6IG51bWJlcjtcblxuICAvLyBXaGF0IHBhcnQgb2YgaW52ZW50b3J5IHRvIHNlYXJjaCB3aGVuIGFjcXVpcmluZy5cbiAgaW52ZW50b3J5Um93U3RhcnQ6IG51bWJlcjtcbiAgaW52ZW50b3J5Um93TGVuZ3RoOiBudW1iZXI7XG4gIC8vIE9ubHkgdXNlZCBmb3IgdGhlICdhY3Rpb24nLlxuICBhY3F1aXNpdGlvbkFjdGlvbjogTWVzc2FnZUlkO1xuICAvLyBGbGFncyB0byBzZXQvY2xlYXIgb24gZ2V0dGluZyB0aGUgaXRlbS4gIH5mbGFnIGluZGljYXRlcyB0byBjbGVhci5cbiAgLy8gTm90ZTogd2UgY2FuIGVsaW1pbmF0ZSBtb3N0IG9mIHRoZXNlIHNpbmNlIHdlIGhhbmRsZSB0aGUgMnh4IGZsYWdcbiAgLy8gYXV0b21hdGljYWxseSBhbmQgdXNlIGl0IGZvciBjaGVzdCBzcGF3bmluZy5cbiAgZmxhZ3M6IG51bWJlcltdO1xuXG4gIC8vIFdoZXRoZXIgdGhlIGl0ZW0gaXMgXCJrZXlcIiBvciBub3QgZm9yIHNjYWxpbmcgcHVycG9zZXMuXG4gIC8vIFRPRE8gLSBmaW5kIGEgYmV0dGVyIHNvdXJjZSBmb3IgdGhpcyBzbyB3ZSBjYW4gcmVtb3ZlIGl0IGZyb20gdGhpcyB0YWJsZS5cbiAgLy8gICAgICAgIFdlIGNvdWxkIHBvc3NpYmx5IHN0b3JlIGl0IGluIGEgMTQtYnl0ZSBiaXRmaWVsZC4uLlxuICBrZXk6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcblxuICAgIHRoaXMuX2l0ZW1JZCA9IHRoaXMuaXRlbVBvaW50ZXIucmVhZChyb20ucHJnKTtcbiAgICAvLyBJIGRvbid0IGZ1bGx5IHVuZGVyc3RhbmQgdGhpcyB0YWJsZS4uLlxuICAgIGNvbnN0IHRhYmxlQmFzZSA9IHRoaXMudGFibGVQb2ludGVyLnJlYWRBZGRyZXNzKHJvbS5wcmcsICQwZSwgJDBmKTtcbiAgICBsZXQgYSA9IHRhYmxlQmFzZS5vZmZzZXQ7XG5cbiAgICB0aGlzLmludmVudG9yeVJvd1N0YXJ0ID0gcm9tLnByZ1thKytdO1xuICAgIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoID0gcm9tLnByZ1thKytdO1xuICAgIHRoaXMuYWNxdWlzaXRpb25BY3Rpb24gPSBNZXNzYWdlSWQuZnJvbShyb20ucHJnLCBhKTtcbiAgICB0aGlzLmZsYWdzID0gSVRFTV9HRVRfRkxBR1MucmVhZChyb20ucHJnLCBhICsgMik7XG5cbiAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyBjaGVja1xuICAgIHRoaXMua2V5ID0gcm9tLnByZ1thICsgMiArIDIgKiB0aGlzLmZsYWdzLmxlbmd0aCArIDFdID09PSAweGZlO1xuXG4gICAgaWYgKGlkICE9PSAwICYmIHRhYmxlQmFzZS5vcmcgPT09IHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZywgMHgxZGQ2NikpIHtcbiAgICAgIC8vIFRoaXMgaXMgb25lIG9mIHRoZSB1bnVzZWQgaXRlbXMgdGhhdCBwb2ludCB0byBzd29yZCBvZiB3aW5kLlxuICAgICAgdGhpcy5rZXkgPSBmYWxzZTtcbiAgICAgIHRoaXMuZmxhZ3MgPSBbXTtcbiAgICB9XG4gIH1cblxuICBnZXQgaXRlbVBvaW50ZXIoKTogQWRkcmVzcyB7XG4gICAgcmV0dXJuIEdFVF9UT19JVEVNX0JBU0UucGx1cyh0aGlzLmlkKTtcbiAgfVxuXG4gIGdldCB0YWJsZVBvaW50ZXIoKTogQWRkcmVzcyB7XG4gICAgcmV0dXJuIElURU1HRVRfVEFCTEUucGx1cyh0aGlzLmlkIDw8IDEpXG4gIH1cblxuICBnZXQgaXRlbUlkKCkgeyByZXR1cm4gdGhpcy5faXRlbUlkOyB9XG4gIHNldCBpdGVtSWQoaXRlbUlkOiBudW1iZXIpIHtcbiAgICBpZiAodGhpcy5pZCA8IEdFVF9UT19JVEVNX1RIUkVTSE9MRCkgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMuaWR9YCk7XG4gICAgdGhpcy5faXRlbUlkID0gaXRlbUlkO1xuICB9XG5cbiAgaXNMb3NhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBMT1NBQkxFX1JPV1MuaGFzKHRoaXMuaW52ZW50b3J5Um93U3RhcnQpO1xuICB9XG5cbiAgY29weUZyb20odGhhdDogSXRlbUdldCkge1xuICAgIHRoaXMuaW52ZW50b3J5Um93U3RhcnQgPSB0aGF0LmludmVudG9yeVJvd1N0YXJ0O1xuICAgIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoID0gdGhhdC5pbnZlbnRvcnlSb3dMZW5ndGg7XG4gICAgdGhpcy5hY3F1aXNpdGlvbkFjdGlvbiA9IHRoYXQuYWNxdWlzaXRpb25BY3Rpb247XG4gICAgdGhpcy5mbGFncyA9IFsuLi50aGF0LmZsYWdzXTtcbiAgICB0aGlzLmtleSA9IHRoYXQua2V5O1xuICB9XG5cbiAgYXNzZW1ibGUoYTogQXNzZW1ibGVyKSB7XG4gICAgLy8gRmlyc3Qgd3JpdGUgKGl0ZW1nZXQgLT4gaXRlbSkgbWFwcGluZ1xuICAgIHRoaXMuaXRlbVBvaW50ZXIubG9jKGEpO1xuICAgIGEuYnl0ZSh0aGlzLml0ZW1JZCk7XG5cbiAgICBjb25zdCB0YWJsZSA9IFtcbiAgICAgIHRoaXMuaW52ZW50b3J5Um93U3RhcnQsIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoLFxuICAgICAgLi4udGhpcy5hY3F1aXNpdGlvbkFjdGlvbi5kYXRhLFxuICAgICAgLi4uSVRFTV9HRVRfRkxBR1MuYnl0ZXModGhpcy5mbGFncyksXG4gICAgICB0aGlzLmtleSA/IDB4ZmUgOiAweGZmLCAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgYnl0ZSB3aGVuIG5vIGxvbmdlciBuZWVkZWRcbiAgICBdO1xuICAgIGEuc2VnbWVudCgkMGUubmFtZSwgJDBmLm5hbWUpO1xuICAgIGEucmVsb2MoYEl0ZW1HZXREYXRhICR7aGV4KHRoaXMuaWQpfWApO1xuICAgIGNvbnN0IHRhYmxlQWRkciA9IGEucGMoKTtcbiAgICBhLmJ5dGUoLi4udGFibGUpO1xuICAgIHRoaXMudGFibGVQb2ludGVyLmxvYyhhKTtcbiAgICBhLndvcmQodGFibGVBZGRyKTtcbiAgfVxufVxuXG5jb25zdCBMT1NBQkxFX1JPV1MgPSBuZXcgU2V0KFs0LCA4LCAxNl0pO1xuIl19